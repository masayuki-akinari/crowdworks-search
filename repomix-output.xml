This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.eslintrc.js
.github/workflows/ci.yml
.gitignore
.prettierrc
app.ts
docker-compose.yml
Dockerfile
Dockerfile.lambda
docs/README.md
env.example
jest.config.js
package.json
readme.md
scripts/analyze-details.ts
scripts/analyze-lancers-jobs.ts
scripts/calculate-recommendation-score.ts
scripts/create-small-unified-report.ts
scripts/create-unified-report.ts
scripts/deploy-lambda.ts
scripts/extract-high-hourly-jobs.ts
scripts/filter-active-jobs.ts
scripts/full-pipeline.ts
scripts/integrated-job-search.ts
scripts/scrape-crowdworks-50jobs.ts
scripts/scrape-crowdworks.ts
scripts/scrape-lancers.ts
scripts/setup-github-oidc.sh
scripts/test-lancers-5jobs.ts
scripts/test-scraping-5jobs.ts
src/analysis/unified-analysis.ts
src/index.ts
src/infrastructure/crowdworks-searcher-stack.ts
src/lambda/handler.ts
src/services/AppliedJobsService.ts
src/services/index.ts
src/services/LancersService.ts
src/types/index.ts
src/utils/index.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="scripts/deploy-lambda.ts">
#!/usr/bin/env node

/**
 * AWS Lambdaé–¢æ•°ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * CrowdWorks & Lancersçµ±åˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
 */

import { LambdaClient, CreateFunctionCommand, UpdateFunctionCodeCommand, GetFunctionCommand } from '@aws-sdk/client-lambda';
import * as fs from 'fs';
import * as path from 'path';

// Lambdaè¨­å®šã®èª­ã¿è¾¼ã¿
const configPath = path.join(__dirname, '../lambda-config.json');
const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));

// Lambda ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–
const lambda = new LambdaClient({ region: 'ap-northeast-1' });

/**
 * Lambdaé–¢æ•°ã®å­˜åœ¨ç¢ºèª
 */
async function checkFunctionExists(functionName: string): Promise<boolean> {
  try {
    await lambda.send(new GetFunctionCommand({ FunctionName: functionName }));
    return true;
  } catch (error) {
    return false;
  }
}

/**
 * Lambdaé–¢æ•°ã®ä½œæˆ
 */
async function createFunction(config: any, zipBuffer: Buffer): Promise<void> {
  const params = {
    ...config,
    Code: {
      ZipFile: zipBuffer
    }
  };

  try {
    const result = await lambda.send(new CreateFunctionCommand(params));
    console.log('âœ… Lambdaé–¢æ•°ã‚’ä½œæˆã—ã¾ã—ãŸ:', result.FunctionArn);
  } catch (error) {
    console.error('âŒ Lambdaé–¢æ•°ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    throw error;
  }
}

/**
 * Lambdaé–¢æ•°ã®æ›´æ–°
 */
async function updateFunction(functionName: string, zipBuffer: Buffer): Promise<void> {
  const params = {
    FunctionName: functionName,
    ZipFile: zipBuffer
  };

  try {
    const result = await lambda.send(new UpdateFunctionCodeCommand(params));
    console.log('âœ… Lambdaé–¢æ•°ã‚’æ›´æ–°ã—ã¾ã—ãŸ:', result.FunctionArn);
  } catch (error) {
    console.error('âŒ Lambdaé–¢æ•°ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
    throw error;
  }
}

/**
 * ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
 */
async function main(): Promise<void> {
  try {
    console.log('ğŸš€ Lambda ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹');
    
    // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
    const zipPath = path.join(__dirname, '../lambda-function.zip');
    
    if (!fs.existsSync(zipPath)) {
      console.error('âŒ lambda-function.zip ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      console.log('ğŸ’¡ ã¾ãš `npm run lambda:build` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
      process.exit(1);
    }
    
    const zipBuffer = fs.readFileSync(zipPath);
    console.log(`ğŸ“¦ ZIPãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${(zipBuffer.length / 1024 / 1024).toFixed(2)}MB`);
    
    // é–¢æ•°ã®å­˜åœ¨ç¢ºèª
    const functionExists = await checkFunctionExists(config.FunctionName);
    
    if (functionExists) {
      console.log('ğŸ”„ æ—¢å­˜ã®é–¢æ•°ã‚’æ›´æ–°ã—ã¾ã™...');
      await updateFunction(config.FunctionName, zipBuffer);
    } else {
      console.log('ğŸ†• æ–°ã—ã„é–¢æ•°ã‚’ä½œæˆã—ã¾ã™...');
      await createFunction(config, zipBuffer);
    }
    
    console.log('ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    console.log('');
    console.log('ğŸ“‹ Lambdaé–¢æ•°æƒ…å ±:');
    console.log(`   é–¢æ•°å: ${config.FunctionName}`);
    console.log(`   ãƒãƒ³ãƒ‰ãƒ©ãƒ¼: ${config.Handler}`);
    console.log(`   ãƒ©ãƒ³ã‚¿ã‚¤ãƒ : ${config.Runtime}`);
    console.log(`   ãƒ¡ãƒ¢ãƒª: ${config.MemorySize}MB`);
    console.log(`   ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ${config.Timeout}ç§’`);
    console.log('');
    console.log('ğŸ”¥ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰:');
    console.log('   aws lambda invoke --function-name crowdworks-scraper --payload \'{"action":"full-pipeline","minHourlyRate":2000,"count":10}\' response.json');
    
  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    process.exit(1);
  }
}

// CLIå®Ÿè¡Œæ™‚ã®å‡¦ç†
if (require.main === module) {
  main().catch(error => {
    console.error('âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼:', error);
    process.exit(1);
  });
}

export { main as deployLambda };
</file>

<file path=".prettierrc">
{
    "semi": true,
    "trailingComma": "es5",
    "singleQuote": true,
    "printWidth": 100,
    "tabWidth": 2,
    "useTabs": false,
    "bracketSpacing": true,
    "arrowParens": "avoid",
    "endOfLine": "lf",
    "quoteProps": "as-needed",
    "bracketSameLine": false,
    "embeddedLanguageFormatting": "auto"
}
</file>

<file path="docker-compose.yml">
version: '3.8'

services:
  # ãƒ¡ã‚¤ãƒ³é–‹ç™ºç’°å¢ƒ
  crowdworks-search:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # é–‹ç™ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    container_name: crowdworks-search-dev
    volumes:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚¦ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é–‹ç™ºç”¨ï¼‰
      - .:/workspace
      - /workspace/node_modules  # node_modulesã¯é™¤å¤–
      - /workspace/dist          # distã¯é™¤å¤–
      # AWSèªè¨¼æƒ…å ±ã®ãƒã‚¦ãƒ³ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      - ~/.aws:/root/.aws:ro
    environment:
      # é–‹ç™ºç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°
      - NODE_ENV=development
      - AWS_REGION=ap-northeast-1
      - LOG_LEVEL=debug
      # Playwrightè¨­å®š
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    ports:
      - "3000:3000"  # å°†æ¥çš„ãªAPI Gateway Localç”¨
      - "9229:9229"  # Node.js ãƒ‡ãƒãƒƒã‚°ãƒãƒ¼ãƒˆ
    working_dir: /workspace
    # é–‹ç™ºç”¨ã®ã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    command: tail -f /dev/null  # ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•çŠ¶æ…‹ã§ç¶­æŒ
    stdin_open: true
    tty: true

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: crowdworks-search-test
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/dist
    environment:
      - NODE_ENV=test
      - AWS_REGION=ap-northeast-1
    working_dir: /workspace
    command: npm run test:coverage
    profiles:
      - test  # docker-compose --profile test up ã§å®Ÿè¡Œ

  # AWS CDKå°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
  cdk:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: crowdworks-search-cdk
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/cdk.out
      - ~/.aws:/root/.aws:ro
    environment:
      - AWS_REGION=ap-northeast-1
      - CDK_DEFAULT_REGION=ap-northeast-1
    working_dir: /workspace
    command: tail -f /dev/null
    profiles:
      - cdk  # docker-compose --profile cdk up ã§å®Ÿè¡Œ

  # æœ¬ç•ªç’°å¢ƒãƒ†ã‚¹ãƒˆç”¨ï¼ˆLambdaç’°å¢ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  lambda-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: crowdworks-search-lambda
    environment:
      - AWS_LAMBDA_RUNTIME_API=localhost:9000
      - _HANDLER=dist/lambda/handler.lambdaHandler
    ports:
      - "9000:8080"  # Lambda Runtime Interface Emulator
    profiles:
      - lambda  # docker-compose --profile lambda up ã§å®Ÿè¡Œ

networks:
  default:
    name: crowdworks-search-network
</file>

<file path="Dockerfile.lambda">
# ================================================
# Lambda Containerç”¨Dockerfile
# Playwright + Chromiumç’°å¢ƒã®æœ€é©åŒ–ç‰ˆ
# ================================================

# AWS Lambda Node.jsåŸºç›¤ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM public.ecr.aws/lambda/nodejs:18

# ãƒ“ãƒ«ãƒ‰å¼•æ•°
ARG STAGE=development
ARG NODE_ENV=production

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV NODE_ENV=${NODE_ENV}
ENV STAGE=${STAGE}
ENV PLAYWRIGHT_BROWSERS_PATH=/usr/bin
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR ${LAMBDA_TASK_ROOT}

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆChromium + é–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
RUN dnf update -y && \
    dnf install -y \
    chromium \
    nss \
    atk \
    at-spi2-atk \
    gtk3 \
    cups-libs \
    drm \
    libXt \
    libXext \
    libXdamage \
    libXrandr \
    libXcomposite \
    libXcursor \
    libXss \
    libXi \
    GConf2 \
    alsa-lib \
    && dnf clean all \
    && rm -rf /var/cache/dnf

# Chromiumã®å‹•ä½œç¢ºèªã¨ãƒã‚¤ãƒŠãƒªãƒ‘ã‚¹è¨­å®š
RUN ln -sf /usr/bin/chromium-browser /usr/bin/chromium \
    && chromium --version \
    && echo "Chromium installed successfully"

# Node.jsä¾å­˜é–¢ä¿‚ã®ã‚³ãƒ”ãƒ¼ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json ./
RUN npm ci --omit=dev --ignore-scripts && \
    npm cache clean --force

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼
COPY dist/ ./dist/
COPY src/types/ ./src/types/

# ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š
RUN chmod +x dist/lambda/handler.js

# Playwrightè¨­å®šç¢ºèª
RUN node -e "console.log('Node.js version:', process.version)" && \
    node -e "const { chromium } = require('playwright'); console.log('Playwright loaded successfully')"

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ç¢ºèªï¼‰
RUN node -e "console.log('Lambda Container build completed successfully')"

# Lambdaé–¢æ•°ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
CMD ["dist/lambda/handler.lambdaHandler"]
</file>

<file path="docs/README.md">
# è¨­è¨ˆæ›¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶è‡ªå‹•æ¤œç´¢ãƒ»è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ã®è¨­è¨ˆæ›¸ã§ã™ã€‚

## ğŸ“š è¨­è¨ˆæ›¸ä¸€è¦§

### 1. [è¦ä»¶å®šç¾©æ›¸](./01_requirements.md)
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®çš„ã€æ©Ÿèƒ½è¦ä»¶ã€éæ©Ÿèƒ½è¦ä»¶ã‚’å®šç¾©

### 2. [ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸](./02_system_design.md)  
ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 3. [ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸](./03_data_design.md)
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

### 4. [APIè¨­è¨ˆæ›¸](./04_api_design.md)
å†…éƒ¨APIãƒ»å¤–éƒ¨APIé€£æºã®ä»•æ§˜å®šç¾©

### 5. [å®Ÿè£…è¨ˆç”»æ›¸](./05_implementation_plan.md)
é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã¨ã‚¿ã‚¹ã‚¯åˆ†è§£ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

## ğŸ”„ è¨­è¨ˆæ›¸ä½œæˆã®é€²ã‚æ–¹

1. **è¦ä»¶å®šç¾©æ›¸** ã‹ã‚‰é–‹å§‹
2. **ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸** ã§å…¨ä½“åƒã‚’æ•´ç†
3. **ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸** ã§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ±ºå®š
4. **APIè¨­è¨ˆæ›¸** ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©
5. **å®Ÿè£…è¨ˆç”»æ›¸** ã§é–‹ç™ºã‚’è¨ˆç”»

## ğŸ“ æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | æ›´æ–°è€… | æ›´æ–°å†…å®¹ |
|------|--------|----------|
|      |        |          |
</file>

<file path="scripts/analyze-lancers-jobs.ts">
import { readFileSync, writeFileSync } from 'fs';
import OpenAI from 'openai';

require('dotenv').config();

const openai = new OpenAI({
    apiKey: process.env['OPENAI_API_KEY'],
});

/**
 * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã‹ã‚‰CrowdWorksäº’æ›ã®AIåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
 */
interface LancersJob {
    id: string;
    title: string;
    description: string;
    url: string;
    budget: {
        type: 'fixed' | 'hourly' | 'unknown';
        amount: number;
        currency: string;
    };
    category: string;
    tags: string[];
    client: {
        name: string;
        rating: number;
        reviewCount: number;
    };
    postedAt: string;
    deadline?: string;
    applicants: number;
    scrapedAt: string;
}

interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    é›£æ˜“åº¦: string;
    gpt_summary: string;
    category?: string;
}

/**
 * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã‚’AIåˆ†æã™ã‚‹é–¢æ•°
 */
async function analyzeLancersJob(job: LancersJob): Promise<AnalysisResult | null> {
    const prompt = `ä»¥ä¸‹ã®ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã‚’åˆ†æã—ã¦ã€ä¸‹è¨˜ã®é …ç›®ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã€æ¡ˆä»¶æƒ…å ±ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}
è©³ç´°èª¬æ˜: ${job.description}
äºˆç®—: ${job.budget.amount}å†† (${job.budget.type === 'fixed' ? 'å›ºå®š' : job.budget.type === 'hourly' ? 'æ™‚çµ¦' : 'ä¸æ˜'})
ã‚«ãƒ†ã‚´ãƒª: ${job.category}
ã‚¿ã‚°: ${job.tags.join(', ')}
å¿œå‹Ÿè€…æ•°: ${job.applicants}äºº

ã€å‡ºåŠ›é …ç›®ã€‘
1. å·¥æ•°è¦‹ç©ã‚‚ã‚Šï¼ˆä¾‹ï¼š10æ™‚é–“ã€30æ™‚é–“ã€100æ™‚é–“ãªã©ï¼‰
2. æƒ³å®šæ™‚çµ¦ï¼ˆä¾‹ï¼š3000å††ã€4500å††ãªã© - äºˆç®—ã¨å·¥æ•°ã‹ã‚‰é€†ç®—ï¼‰
3. é›£æ˜“åº¦ï¼ˆåˆç´šã€ä¸­ç´šã€ä¸Šç´šã€ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆï¼‰
4. æ¡ˆä»¶æ¦‚è¦ï¼ˆ50æ–‡å­—ç¨‹åº¦ã®ç°¡æ½”ãªè¦ç´„ï¼‰

ã€è©•ä¾¡ã®è¦³ç‚¹ã€‘
- æŠ€è¡“çš„ãªè¤‡é›‘ã•
- ä½œæ¥­è¦æ¨¡
- æ±‚ã‚ã‚‰ã‚Œã‚‹ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«
- ç´æœŸã®ä½™è£•åº¦

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
å·¥æ•°è¦‹ç©ã‚‚ã‚Š: <æ™‚é–“æ•°>
æƒ³å®šæ™‚çµ¦: <é‡‘é¡>
é›£æ˜“åº¦: <ãƒ¬ãƒ™ãƒ«>
æ¦‚è¦: <50æ–‡å­—ç¨‹åº¦ã®è¦ç´„>`;

    try {
        const res = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'ã‚ãªãŸã¯ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹æ¡ˆä»¶ã®åˆ†æå°‚é–€å®¶ã§ã™ã€‚æŠ€è¡“æ¡ˆä»¶ã®å·¥æ•°è¦‹ç©ã‚‚ã‚Šã¨é›£æ˜“åº¦è©•ä¾¡ã«é•·ã‘ã¦ã„ã¾ã™ã€‚' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 500,
            temperature: 0.3,
        });

        const text = res.choices[0]?.message?.content || '';

        // çµæœã‚’ãƒ‘ãƒ¼ã‚¹
        const workloadMatch = text.match(/å·¥æ•°è¦‹ç©ã‚‚ã‚Š[:ï¼š]\s*([^\n]+)/);
        const hourlyRateMatch = text.match(/æƒ³å®šæ™‚çµ¦[:ï¼š]\s*([^\n]+)/);
        const difficultyMatch = text.match(/é›£æ˜“åº¦[:ï¼š]\s*([^\n]+)/);
        const summaryMatch = text.match(/æ¦‚è¦[:ï¼š]\s*([^\n]+)/);

        const workload = workloadMatch?.[1]?.trim() || 'ä¸æ˜';
        const hourlyRate = hourlyRateMatch?.[1]?.trim() || 'ä¸æ˜';
        const difficulty = difficultyMatch?.[1]?.trim() || 'ä¸æ˜';
        const summary = summaryMatch?.[1]?.trim() || '';

        return {
            jobId: job.id,
            title: job.title,
            å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: workload,
            æƒ³å®šæ™‚çµ¦: hourlyRate,
            é›£æ˜“åº¦: difficulty,
            gpt_summary: summary,
            category: job.category
        };

    } catch (error) {
        console.error(`âŒ æ¡ˆä»¶åˆ†æã‚¨ãƒ©ãƒ¼ (${job.id}):`, error);
        return null;
    }
}

/**
 * ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
async function main(): Promise<void> {
    console.log('ğŸš€ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã®AIåˆ†æã‚’é–‹å§‹ã—ã¾ã™...');

    // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    let lancersJobs: LancersJob[] = [];
    try {
        const lancersData = JSON.parse(readFileSync('output/lancers-all-jobs.json', 'utf8'));
        lancersJobs = lancersData.jobs || [];
        console.log(`ğŸ“‚ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${lancersJobs.length}ä»¶`);
    } catch (error) {
        console.error('âŒ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', error);
        return;
    }

    if (lancersJobs.length === 0) {
        console.log('âš ï¸ åˆ†æå¯¾è±¡ã®æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }

    // ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºé–¢é€£ã®æ¡ˆä»¶ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const targetJobs = lancersJobs.filter(job => {
        const title = job.title.toLowerCase();
        const description = job.description.toLowerCase();
        const category = job.category.toLowerCase();

        // ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒ»Webé–¢é€£ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
        const keywords = [
            'ã‚·ã‚¹ãƒ†ãƒ ', 'web', 'api', 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹', 'javascript', 'typescript', 'react', 'node',
            'php', 'python', 'java', 'sql', 'database', 'ã‚µã‚¤ãƒˆ', 'ã‚¢ãƒ—ãƒª', 'cms', 'wordpress',
            'ec', 'ecommerce', 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'é–‹ç™º', 'ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰', 'ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰'
        ];

        return keywords.some(keyword =>
            title.includes(keyword) ||
            description.includes(keyword) ||
            category.includes(keyword)
        );
    });

    console.log(`ğŸ¯ æŠ€è¡“æ¡ˆä»¶ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: ${targetJobs.length}ä»¶ (å…¨${lancersJobs.length}ä»¶ä¸­)`);

    if (targetJobs.length === 0) {
        console.log('âš ï¸ æŠ€è¡“é–¢é€£ã®æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
    }

    // æ¡ˆä»¶ã‚’é †æ¬¡åˆ†æ
    const analyzedJobs: AnalysisResult[] = [];
    const batchSize = 5; // 5ä»¶ãšã¤å‡¦ç†

    for (let i = 0; i < targetJobs.length; i += batchSize) {
        const batch = targetJobs.slice(i, i + batchSize);
        console.log(`\nğŸ“‹ ãƒãƒƒãƒ ${Math.floor(i / batchSize) + 1}: ${i + 1}~${Math.min(i + batchSize, targetJobs.length)}ä»¶ç›®ã‚’åˆ†æä¸­...`);

        // ãƒãƒƒãƒå†…ã®æ¡ˆä»¶ã‚’ä¸¦åˆ—ã§åˆ†æ
        const batchPromises = batch.map(async (job, index) => {
            const globalIndex = i + index + 1;
            try {
                console.log(`ğŸ” [${globalIndex}/${targetJobs.length}] åˆ†æä¸­: ${job.title.substring(0, 40)}...`);
                const result = await analyzeLancersJob(job);

                if (result) {
                    console.log(`âœ… [${globalIndex}/${targetJobs.length}] åˆ†æå®Œäº†: ${result.æƒ³å®šæ™‚çµ¦}, ${result.é›£æ˜“åº¦}`);
                    return result;
                } else {
                    console.log(`âŒ [${globalIndex}/${targetJobs.length}] åˆ†æå¤±æ•—`);
                    return null;
                }
            } catch (error) {
                console.error(`âŒ [${globalIndex}/${targetJobs.length}] ã‚¨ãƒ©ãƒ¼:`, error);
                return null;
            }
        });

        const batchResults = await Promise.allSettled(batchPromises);

        // æˆåŠŸã—ãŸçµæœã®ã¿ã‚’è¿½åŠ 
        batchResults.forEach((result) => {
            if (result.status === 'fulfilled' && result.value) {
                analyzedJobs.push(result.value);
            }
        });

        // ãƒãƒƒãƒé–“ã®å¾…æ©Ÿæ™‚é–“ï¼ˆAPIåˆ¶é™å¯¾ç­–ï¼‰
        if (i + batchSize < targetJobs.length) {
            console.log('â±ï¸ æ¬¡ã®ãƒãƒƒãƒã¾ã§3ç§’å¾…æ©Ÿ...');
            await new Promise(resolve => setTimeout(resolve, 3000));
        }
    }

    console.log(`\nğŸ‰ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶AIåˆ†æå®Œäº†!`);
    console.log(`ğŸ“Š çµæœ: ${analyzedJobs.length}ä»¶æˆåŠŸ / ${targetJobs.length}ä»¶å‡¦ç†`);

    // çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    if (analyzedJobs.length > 0) {
        const outputFile = 'output/analyzed-lancers.json';
        writeFileSync(outputFile, JSON.stringify(analyzedJobs, null, 2), 'utf8');
        console.log(`ğŸ’¾ åˆ†æçµæœã‚’ä¿å­˜: ${outputFile}`);

        // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
        console.log(`\nğŸ“ˆ åˆ†æçµæœçµ±è¨ˆ:`);

        // é›£æ˜“åº¦åˆ†å¸ƒ
        const difficultyDist = analyzedJobs.reduce((acc, job) => {
            acc[job.é›£æ˜“åº¦] = (acc[job.é›£æ˜“åº¦] || 0) + 1;
            return acc;
        }, {} as Record<string, number>);

        console.log(`é›£æ˜“åº¦åˆ†å¸ƒ:`);
        Object.entries(difficultyDist).forEach(([level, count]) => {
            console.log(`  ${level}: ${count}ä»¶`);
        });

        // æƒ³å®šæ™‚çµ¦åˆ†å¸ƒ
        const hourlyRates = analyzedJobs
            .map(job => {
                const match = job.æƒ³å®šæ™‚çµ¦.match(/(\d+)/);
                return match && match[1] ? parseInt(match[1]) : 0;
            })
            .filter(rate => rate > 0);

        if (hourlyRates.length > 0) {
            const avgRate = Math.round(hourlyRates.reduce((sum, rate) => sum + rate, 0) / hourlyRates.length);
            const maxRate = Math.max(...hourlyRates);
            const minRate = Math.min(...hourlyRates);

            console.log(`æƒ³å®šæ™‚çµ¦çµ±è¨ˆ:`);
            console.log(`  å¹³å‡: ${avgRate}å††`);
            console.log(`  æœ€é«˜: ${maxRate}å††`);
            console.log(`  æœ€ä½: ${minRate}å††`);
        }
    }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if (require.main === module) {
    main().catch(error => {
        console.error('ğŸ’¥ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
        process.exit(1);
    });
}

export default main;
</file>

<file path="scripts/create-small-unified-report.ts">
import fs from 'fs';

interface Job {
    title: string;
    budget: string;
    url: string;
    description: string;
    hourlyRate: number;
    platform: string;
}

interface LancersJob {
    jobId: string;
    title: string;
    budget: string;
    url: string;
    detailedDescription: string;
}

interface CrowdWorksJob {
    jobId: string;
    title: string;
    budget: string;
    url: string;
    description: string;
}

class SmallUnifiedReportGenerator {

    constructor() { }

    /**
     * æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
     */
    async generateReport(): Promise<void> {
        console.log('ğŸš€ å°è¦æ¨¡çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹...');

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        const data = this.loadJobData();

        console.log(`ğŸ“Š èª­ã¿è¾¼ã¿çµæœ:`);
        console.log(`   ãƒ©ãƒ³ã‚µãƒ¼ã‚º: ${data.lancers.length}ä»¶`);
        console.log(`   CrowdWorks: ${data.crowdworks.length}ä»¶`);

        // é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºï¼ˆ1000å††ä»¥ä¸Šï¼‰
        const minHourlyRate = 1000;
        const highPayingJobs = this.filterHighPayingJobs(data.lancers, data.crowdworks, minHourlyRate);

        console.log(`\nğŸ”¥ é«˜æ™‚çµ¦æ¡ˆä»¶ (${minHourlyRate}å††ä»¥ä¸Š):`);
        console.log(`   ãƒ©ãƒ³ã‚µãƒ¼ã‚º: ${highPayingJobs.lancers.length}ä»¶`);
        console.log(`   CrowdWorks: ${highPayingJobs.crowdworks.length}ä»¶`);

        if (highPayingJobs.lancers.length === 0 && highPayingJobs.crowdworks.length === 0) {
            console.log(`âš ï¸ æ™‚çµ¦${minHourlyRate}å††ä»¥ä¸Šã®æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
            return;
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        const report = this.createMarkdownReport(highPayingJobs.lancers, highPayingJobs.crowdworks, minHourlyRate);

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        const timestamp = new Date().toISOString().split('T')[0];
        const filename = `output/unified-small-report-${timestamp}.md`;
        fs.writeFileSync(filename, report, 'utf8');

        console.log(`\nğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†ï¼`);
        console.log(`ğŸ’¾ ä¿å­˜å…ˆ: ${filename}`);
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
     */
    private loadJobData(): { lancers: LancersJob[], crowdworks: CrowdWorksJob[] } {
        console.log('ğŸ“š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        const lancersData: LancersJob[] = [];
        const lancersFile = 'output/lancers-details-2025-06-09T17-38-02-401Z.json';
        if (fs.existsSync(lancersFile)) {
            const data = JSON.parse(fs.readFileSync(lancersFile, 'utf8'));
            lancersData.push(...data);
            console.log(`ğŸ“ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${data.length}ä»¶`);
        }

        // CrowdWorksãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ–°ã—ã„50ä»¶ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆä½¿ç”¨ï¼‰
        const crowdworksData: CrowdWorksJob[] = [];

        // æ–°ã—ã„50ä»¶ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«
        const newCrowdWorksFile = 'output/crowdworks-web-jobs-2025-06-09T18-47-49-913Z.json';
        if (fs.existsSync(newCrowdWorksFile)) {
            const data = JSON.parse(fs.readFileSync(newCrowdWorksFile, 'utf8'));
            crowdworksData.push(...data);
            console.log(`ğŸ“ CrowdWorksä¿®æ­£ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${data.length}ä»¶`);
        } else {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå‰ã®ãƒ‡ãƒ¼ã‚¿
            const oldCrowdWorksFile = 'output/crowdworks-web-jobs-2025-06-09T18-39-50-670Z.json';
            if (fs.existsSync(oldCrowdWorksFile)) {
                const data = JSON.parse(fs.readFileSync(oldCrowdWorksFile, 'utf8'));
                crowdworksData.push(...data);
                console.log(`ğŸ“ CrowdWorksæ—§ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${data.length}ä»¶`);
            }
        }

        return { lancers: lancersData, crowdworks: crowdworksData };
    }

    /**
     * äºˆç®—æ–‡å­—åˆ—ã‹ã‚‰æ™‚çµ¦ã‚’æ¨å®š
     */
    private estimateHourlyRate(budgetText: string): number {
        if (!budgetText || budgetText === 'æœªå–å¾—' || budgetText === 'ã‚¨ãƒ©ãƒ¼') return 0;

        // ã‚¿ã‚¤ãƒˆãƒ«ãŒæ··å…¥ã—ã¦ã„ã‚‹å ´åˆã¯é™¤å¤–
        if (budgetText.length > 100 || budgetText.includes('å‹Ÿé›†') || budgetText.includes('é–‹ç™º')) {
            return 0;
        }

        // é‡‘é¡ã‚’æŠ½å‡º
        const amounts = budgetText.match(/(\d{1,3}(?:,\d{3})*)/g);
        if (!amounts || amounts.length === 0) return 0;

        let amount = parseInt(amounts[0].replace(/,/g, ''));

        // æ™‚çµ¦è¡¨è¨˜ã®å ´åˆ
        if (budgetText.includes('æ™‚é–“') || budgetText.includes('/æ™‚') || budgetText.includes('æ™‚çµ¦')) {
            return amount;
        }

        // ç¯„å›²ãŒã‚ã‚‹å ´åˆã¯æœ€å¤§å€¤ã‚’ä½¿ç”¨
        if (amounts.length > 1) {
            const lastAmount = amounts[amounts.length - 1];
            if (lastAmount) {
                amount = parseInt(lastAmount.replace(/,/g, ''));
            }
        }

        // å›ºå®šå ±é…¬ã®å ´åˆ
        // ç•°å¸¸ã«é«˜ã„é‡‘é¡ï¼ˆæœˆ100ä¸‡å††ä»¥ä¸Šï¼‰ã®å ´åˆã¯å¹´é¡ã¨ä»®å®šã—ã¦æœˆé¡ã«å¤‰æ›
        if (amount > 1000000) {
            // å¹´é¡ã®å ´åˆã¯12ã§å‰²ã£ã¦æœˆé¡ã«å¤‰æ›
            const monthlyAmount = amount / 12;
            // æœˆé¡ã‚’160æ™‚é–“ï¼ˆæœˆ20æ—¥Ã—8æ™‚é–“ï¼‰ã§å‰²ã£ã¦æ™‚çµ¦ã‚’æ¨å®š
            return Math.round(monthlyAmount / 160);
        }

        // é€šå¸¸ã®æœˆé¡å ±é…¬ã®å ´åˆã¯160æ™‚é–“ã§å‰²ã‚‹
        if (amount > 50000) {
            return Math.round(amount / 160);
        }

        // å°é¡ã®å ´åˆã¯æ™‚çµ¦ã¨ã—ã¦æ‰±ã†
        return amount;
    }

    /**
     * é«˜æ™‚çµ¦æ¡ˆä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
     */
    private filterHighPayingJobs(
        lancersJobs: LancersJob[],
        crowdworksJobs: CrowdWorksJob[],
        minHourlyRate: number
    ): { lancers: Job[], crowdworks: Job[] } {

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶å‡¦ç†
        const processedLancers: Job[] = lancersJobs
            .filter(job => job.budget && job.budget.trim() !== '')
            .map(job => ({
                title: job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜',
                budget: job.budget,
                url: job.url,
                description: job.detailedDescription || '',
                hourlyRate: this.estimateHourlyRate(job.budget),
                platform: 'ãƒ©ãƒ³ã‚µãƒ¼ã‚º'
            }))
            .filter(job => job.hourlyRate >= minHourlyRate);

        // CrowdWorksæ¡ˆä»¶å‡¦ç†
        const processedCrowdworks: Job[] = crowdworksJobs
            .filter(job => job.budget && job.budget.trim() !== '')
            .map(job => ({
                title: job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜',
                budget: job.budget,
                url: job.url,
                description: job.description || '',
                hourlyRate: this.estimateHourlyRate(job.budget),
                platform: 'CrowdWorks'
            }))
            .filter(job => job.hourlyRate >= minHourlyRate);

        return { lancers: processedLancers, crowdworks: processedCrowdworks };
    }

    /**
     * Markdownãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
     */
    private createMarkdownReport(lancersJobs: Job[], crowdworksJobs: Job[], minHourlyRate: number): string {
        const allJobs = [...lancersJobs, ...crowdworksJobs]
            .sort((a, b) => b.hourlyRate - a.hourlyRate);

        const timestamp = new Date().toLocaleString('ja-JP');

        let report = `# çµ±åˆé«˜æ™‚çµ¦æ¡ˆä»¶ãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ™‚çµ¦${minHourlyRate}å††ä»¥ä¸Šï¼‰\n\n`;
        report += `> **ç”Ÿæˆæ—¥æ™‚**: ${timestamp}\n`;
        report += `> **ãƒ‡ãƒ¼ã‚¿**: ãƒ©ãƒ³ã‚µãƒ¼ã‚º${lancersJobs.length}ä»¶ + CrowdWorks${crowdworksJobs.length}ä»¶ = åˆè¨ˆ${allJobs.length}ä»¶\n\n`;

        // çµ±è¨ˆæƒ…å ±
        if (allJobs.length > 0) {
            const maxRate = Math.max(...allJobs.map(job => job.hourlyRate));
            const avgRate = Math.round(allJobs.reduce((sum, job) => sum + job.hourlyRate, 0) / allJobs.length);

            report += `## ğŸ“Š çµ±è¨ˆæƒ…å ±\n\n`;
            report += `| é …ç›® | ãƒ©ãƒ³ã‚µãƒ¼ã‚º | CrowdWorks | åˆè¨ˆ |\n`;
            report += `|------|------------|------------|------|\n`;
            report += `| æ¡ˆä»¶æ•° | ${lancersJobs.length}ä»¶ | ${crowdworksJobs.length}ä»¶ | ${allJobs.length}ä»¶ |\n`;
            report += `| æœ€é«˜æ™‚çµ¦ | ${lancersJobs.length > 0 ? Math.max(...lancersJobs.map(j => j.hourlyRate)).toLocaleString() : '0'}å†† | ${crowdworksJobs.length > 0 ? Math.max(...crowdworksJobs.map(j => j.hourlyRate)).toLocaleString() : '0'}å†† | ${maxRate.toLocaleString()}å†† |\n`;
            report += `| å¹³å‡æ™‚çµ¦ | ${lancersJobs.length > 0 ? Math.round(lancersJobs.reduce((sum, j) => sum + j.hourlyRate, 0) / lancersJobs.length).toLocaleString() : '0'}å†† | ${crowdworksJobs.length > 0 ? Math.round(crowdworksJobs.reduce((sum, j) => sum + j.hourlyRate, 0) / crowdworksJobs.length).toLocaleString() : '0'}å†† | ${avgRate.toLocaleString()}å†† |\n\n`;
        }

        // æ¡ˆä»¶ä¸€è¦§
        report += `## ğŸ† é«˜æ™‚çµ¦æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°\n\n`;

        allJobs.forEach((job, index) => {
            report += `### ${index + 1}ä½: ${job.platform} - ${job.title}\n\n`;
            report += `**ğŸ’° æ¨å®šæ™‚çµ¦:** ${job.hourlyRate.toLocaleString()}å††\n`;
            report += `**ğŸ’µ äºˆç®—:** ${job.budget}\n`;
            report += `**ğŸ”— URL:** ${job.url}\n\n`;
            report += `**ğŸ“ æ¦‚è¦:**\n`;
            report += `${job.description.substring(0, 300)}...\n\n`;
            report += `---\n\n`;
        });

        return report;
    }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
async function main() {
    const generator = new SmallUnifiedReportGenerator();
    await generator.generateReport();
}

if (require.main === module) {
    main().catch(error => {
        console.error('ğŸ’¥ ã‚¨ãƒ©ãƒ¼:', error);
        process.exit(1);
    });
}
</file>

<file path="scripts/filter-active-jobs.ts">
import * as fs from 'fs';
import * as path from 'path';

// Jobå‹å®šç¾©
interface Job {
    id: string;
    title: string;
    platform: 'ãƒ©ãƒ³ã‚µãƒ¼ã‚º' | 'ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹';
    url: string;
    budget: string;
    hourlyRate: number;
    category: string;
    subcategory: string;
    description: string;
    client: string;
    clientRating: number;
    clientOrderCount: number;
    postedAt: Date | string;
    deadline: string;
    tags: string[];
    workType: string;
    isUrgent: boolean;
    isPremium: boolean;
    industry: string;
    workRank: string;
    appliedCount: number;
    recruitCount: number;
}

class JobFilter {
    private outputDir: string;

    constructor() {
        this.outputDir = path.join(process.cwd(), 'output');
    }

    // çµ‚äº†æ¸ˆã¿æ¡ˆä»¶ã‚’åˆ¤å®š
    private isJobClosed(job: Job): boolean {
        const closedKeywords = [
            'å‹Ÿé›†çµ‚äº†',
            'ç· åˆ‡æ¸ˆã¿',
            'çµ‚äº†æ¸ˆã¿',
            'å‹Ÿé›†åœæ­¢',
            'å‹Ÿé›†ä¸­æ­¢',
            'å—ä»˜çµ‚äº†'
        ];

        const textToCheck = [
            job.title,
            job.description,
            job.budget
        ].join(' ');

        return closedKeywords.some(keyword => textToCheck.includes(keyword));
    }

    // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    async filterLancersJobs(): Promise<void> {
        console.log('ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ä¸­...');

        const files = fs.readdirSync(this.outputDir)
            .filter(file => file.includes('lancers-jobs') && file.endsWith('.json'))
            .sort();

        for (const filename of files) {
            const filePath = path.join(this.outputDir, filename);

            try {
                console.log(`ğŸ“„ å‡¦ç†ä¸­: ${filename}`);

                const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));

                if (!Array.isArray(data)) {
                    console.log(`âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: ${filename} (é…åˆ—å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“)`);
                    continue;
                }

                const originalCount = data.length;
                const activeJobs = data.filter((job: Job) => !this.isJobClosed(job));
                const removedCount = originalCount - activeJobs.length;

                if (removedCount > 0) {
                    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
                    const newFilename = filename.replace('.json', '-active.json');
                    const newFilePath = path.join(this.outputDir, newFilename);

                    fs.writeFileSync(newFilePath, JSON.stringify(activeJobs, null, 2));

                    console.log(`âœ… ${filename}:`);
                    console.log(`   å…ƒã®æ¡ˆä»¶æ•°: ${originalCount}`);
                    console.log(`   æœ‰åŠ¹æ¡ˆä»¶æ•°: ${activeJobs.length}`);
                    console.log(`   é™¤å¤–æ¡ˆä»¶æ•°: ${removedCount}`);
                    console.log(`   ä¿å­˜å…ˆ: ${newFilename}`);
                } else {
                    console.log(`âœ¨ ${filename}: çµ‚äº†æ¸ˆã¿æ¡ˆä»¶ãªã— (${originalCount}ä»¶ã™ã¹ã¦æœ‰åŠ¹)`);
                }

            } catch (error) {
                console.error(`âŒ ã‚¨ãƒ©ãƒ¼å‡¦ç† ${filename}:`, error);
            }
        }
    }

    // çµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
    async showFilterStatistics(): Promise<void> {
        console.log('\nğŸ“Š ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµ±è¨ˆ:');

        const files = fs.readdirSync(this.outputDir)
            .filter(file => file.includes('lancers-jobs') && file.endsWith('.json'));

        const originalFiles = files.filter(f => !f.includes('-active'));
        const activeFiles = files.filter(f => f.includes('-active'));

        let totalOriginal = 0;
        let totalActive = 0;

        for (const filename of originalFiles) {
            try {
                const data = JSON.parse(fs.readFileSync(path.join(this.outputDir, filename), 'utf8'));
                if (Array.isArray(data)) totalOriginal += data.length;
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        }

        for (const filename of activeFiles) {
            try {
                const data = JSON.parse(fs.readFileSync(path.join(this.outputDir, filename), 'utf8'));
                if (Array.isArray(data)) totalActive += data.length;
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        }

        console.log(`ğŸ”¢ å…ƒã®ç·æ¡ˆä»¶æ•°: ${totalOriginal}`);
        console.log(`âœ… æœ‰åŠ¹æ¡ˆä»¶æ•°: ${totalActive}`);
        console.log(`â¹ï¸ é™¤å¤–æ¡ˆä»¶æ•°: ${totalOriginal - totalActive}`);
        console.log(`ğŸ“ˆ æœ‰åŠ¹æ¡ˆä»¶ç‡: ${totalOriginal > 0 ? ((totalActive / totalOriginal) * 100).toFixed(1) : 0}%`);
    }

    async run(): Promise<void> {
        console.log('ğŸš€ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™...');

        await this.filterLancersJobs();
        await this.showFilterStatistics();

        console.log('ğŸ‰ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Œäº†ï¼');
    }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œéƒ¨åˆ†
async function main(): Promise<void> {
    const filter = new JobFilter();
    await filter.run();
}

if (require.main === module) {
    main().catch(console.error);
}

export { JobFilter };
</file>

<file path="scripts/full-pipeline.ts">
#!/usr/bin/env npx ts-node

import { spawn } from 'child_process';
import * as fs from 'fs';
import * as path from 'path';

interface PipelineConfig {
  minHourlyRate: number;
  crowdWorksCategories: string[];
  lancersCategories: string[];
  scrapeCount: number;
}

class FullPipeline {
  private config: PipelineConfig;
  private outputDir: string;

  constructor(config: PipelineConfig) {
    this.config = config;
    this.outputDir = 'output';
  }

  /**
   * ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦Promiseã§çµæœã‚’è¿”ã™
   */
  private executeCommand(command: string, args: string[] = []): Promise<number> {
    return new Promise((resolve, reject) => {
      console.log(`ğŸš€ å®Ÿè¡Œä¸­: ${command} ${args.join(' ')}`);
      
      const childProcess = spawn(command, args, {
        stdio: 'inherit',
        shell: true,
        cwd: process.cwd()
      });

      childProcess.on('close', (code) => {
        if (code === 0) {
          console.log(`âœ… å®Œäº†: ${command}`);
          resolve(code);
        } else {
          console.error(`âŒ ã‚¨ãƒ©ãƒ¼: ${command} (exit code: ${code})`);
          reject(new Error(`Command failed: ${command}`));
        }
      });

      childProcess.on('error', (error) => {
        console.error(`âŒ ãƒ—ãƒ­ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        reject(error);
      });
    });
  }

  /**
   * 1. CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
   */
  private async scrapeCrowdWorks(): Promise<void> {
    console.log('\nğŸ“Š === STEP 1: CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° ===');
    
    for (const category of this.config.crowdWorksCategories) {
      try {
        await this.executeCommand('npm', ['run', 'handler', `scrape-${category}`, this.config.scrapeCount.toString()]);
        console.log(`âœ… CrowdWorks ${category}ã‚«ãƒ†ã‚´ãƒªå®Œäº†`);
      } catch (error) {
        console.warn(`âš ï¸ CrowdWorks ${category}ã‚¹ã‚­ãƒƒãƒ—: ${error}`);
      }
    }
  }

  /**
   * 2. Lancersã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
   */
  private async scrapeLancers(): Promise<void> {
    console.log('\nğŸ¯ === STEP 2: Lancersã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° ===');
    
    for (const category of this.config.lancersCategories) {
      try {
        await this.executeCommand('npm', ['run', 'handler', `lancers-${category}`, this.config.scrapeCount.toString()]);
        console.log(`âœ… Lancers ${category}ã‚«ãƒ†ã‚´ãƒªå®Œäº†`);
      } catch (error) {
        console.warn(`âš ï¸ Lancers ${category}ã‚¹ã‚­ãƒƒãƒ—: ${error}`);
      }
    }
  }

  /**
   * 3. çµ±åˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
   */
  private async generateAnalysisReport(): Promise<void> {
    console.log('\nğŸ“ˆ === STEP 3: çµ±åˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ ===');
    
    try {
      await this.executeCommand('npx', ['ts-node', 'scripts/create-unified-report.ts', this.config.minHourlyRate.toString()]);
      console.log('âœ… çµ±åˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†');
    } catch (error) {
      console.error('âŒ åˆ†æãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå¤±æ•—:', error);
      throw error;
    }
  }

  /**
   * 4. çµæœã‚µãƒãƒªãƒ¼è¡¨ç¤º
   */
  private displaySummary(): void {
    console.log('\nğŸ‰ === ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œå®Œäº†ï¼ ===');
    
    // outputãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª
    if (fs.existsSync(this.outputDir)) {
      const files = fs.readdirSync(this.outputDir)
        .filter(file => file.endsWith('.json') || file.endsWith('.md'))
        .map(file => ({
          name: file,
          path: path.join(this.outputDir, file),
          stats: fs.statSync(path.join(this.outputDir, file))
        }))
        .sort((a, b) => b.stats.mtime.getTime() - a.stats.mtime.getTime())
        .slice(0, 5);

      console.log('\nğŸ“ ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ€æ–°5ä»¶ï¼‰:');
      files.forEach((file, index) => {
        const sizeKB = Math.round(file.stats.size / 1024);
        const timestamp = file.stats.mtime.toLocaleString('ja-JP');
        console.log(`  ${index + 1}. ${file.name} (${sizeKB}KB) - ${timestamp}`);
      });

      // æœ€æ–°ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç‰¹å®š
      const latestReport = files.find(f => f.name.includes('unified-high-paying-jobs') && f.name.endsWith('.md'));
      if (latestReport) {
        console.log(`\nğŸ¯ æœ€æ–°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ: ${latestReport.name}`);
        console.log(`   ãƒ‘ã‚¹: ${latestReport.path}`);
      }
    }

    console.log(`\nğŸ’° è¨­å®šæƒ…å ±:`);
    console.log(`   æœ€ä½æ™‚çµ¦: ${this.config.minHourlyRate.toLocaleString()}å††`);
    console.log(`   CrowdWorksã‚«ãƒ†ã‚´ãƒª: ${this.config.crowdWorksCategories.join(', ')}`);
    console.log(`   Lancersã‚«ãƒ†ã‚´ãƒª: ${this.config.lancersCategories.join(', ')}`);
    console.log(`   ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä»¶æ•°: ${this.config.scrapeCount}ä»¶/ã‚«ãƒ†ã‚´ãƒª`);
  }

  /**
   * ãƒ•ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
   */
  async execute(): Promise<void> {
    const startTime = Date.now();
    
    console.log('ğŸš€ === ãƒ•ãƒ«è‡ªå‹•åŒ–ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³é–‹å§‹ ===');
    console.log(`é–‹å§‹æ™‚åˆ»: ${new Date().toLocaleString('ja-JP')}`);
    
    try {
      // STEP 1: CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
      await this.scrapeCrowdWorks();
      
      // STEP 2: Lancersã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°  
      await this.scrapeLancers();
      
      // STEP 3: çµ±åˆåˆ†æ
      await this.generateAnalysisReport();
      
      // STEP 4: çµæœè¡¨ç¤º
      this.displaySummary();
      
      const executionTime = Math.round((Date.now() - startTime) / 1000);
      console.log(`\nğŸ‰ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œå®Œäº†ï¼ (å®Ÿè¡Œæ™‚é–“: ${executionTime}ç§’)`);
      
    } catch (error) {
      console.error('\nâŒ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      process.exit(1);
    }
  }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
async function main() {
  // ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã®è§£æ
  const args = process.argv.slice(2);
  const minHourlyRate = args[0] ? parseInt(args[0]) : 3000;
  const scrapeCount = args[1] ? parseInt(args[1]) : 10;

  const config: PipelineConfig = {
    minHourlyRate,
    scrapeCount,
    crowdWorksCategories: ['ec', 'web', 'app', 'dev'], // CrowdWorksã‚«ãƒ†ã‚´ãƒª
    lancersCategories: ['system', 'web', 'app', 'design'] // Lancersã‚«ãƒ†ã‚´ãƒª
  };

  console.log('âš™ï¸ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®š:');
  console.log(`   æœ€ä½æ™‚çµ¦: ${config.minHourlyRate.toLocaleString()}å††`);
  console.log(`   ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä»¶æ•°: ${config.scrapeCount}ä»¶/ã‚«ãƒ†ã‚´ãƒª`);
  console.log(`   CrowdWorksã‚«ãƒ†ã‚´ãƒª: ${config.crowdWorksCategories.join(', ')}`);
  console.log(`   Lancersã‚«ãƒ†ã‚´ãƒª: ${config.lancersCategories.join(', ')}`);

  const pipeline = new FullPipeline(config);
  await pipeline.execute();
}

if (require.main === module) {
  main().catch(console.error);
}

export { FullPipeline };
</file>

<file path="scripts/integrated-job-search.ts">
require('dotenv').config();

import {
    IntegratedJobSearchService,
    CurrencyService
} from '../src/services/index';
import {
    UpworkCredentials,
    IntegratedSearchConfig,
    IntegratedJobReport
} from '../src/types/index';
import { writeFileSync, existsSync, mkdirSync } from 'fs';
import * as path from 'path';

/**
 * çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒã‚¹ã‚¯ãƒªãƒ—ãƒˆ
 * CrowdWorksã¨Upworkã‹ã‚‰é«˜æ™‚çµ¦æ¡ˆä»¶ã‚’æ¤œç´¢ã—ã¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */

// å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºä¿
const outputDir = 'output';
if (!existsSync(outputDir)) {
    mkdirSync(outputDir, { recursive: true });
}

// ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—
function getUpworkCredentials(): UpworkCredentials {
    const consumerKey = process.env['UPWORK_CONSUMER_KEY'];
    const consumerSecret = process.env['UPWORK_CONSUMER_SECRET'];
    const accessToken = process.env['UPWORK_ACCESS_TOKEN'];
    const accessTokenSecret = process.env['UPWORK_ACCESS_TOKEN_SECRET'];

    if (!consumerKey || !consumerSecret) {
        throw new Error('Upworkèªè¨¼æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚UPWORK_CONSUMER_KEY, UPWORK_CONSUMER_SECRETã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    }

    const credentials: UpworkCredentials = {
        consumerKey,
        consumerSecret
    };

    if (accessToken) {
        credentials.accessToken = accessToken;
    }

    if (accessTokenSecret) {
        credentials.accessTokenSecret = accessTokenSecret;
    }

    return credentials;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçµ±åˆæ¤œç´¢è¨­å®š
function createDefaultSearchConfig(): IntegratedSearchConfig {
    return {
        enabled: {
            crowdworks: true,
            upwork: true
        },
        limits: {
            maxJobsPerSource: 50,
            maxExecutionTime: 300 // 5åˆ†
        },
        filtering: {
            minHourlyRateJPY: 3000, // æœ€ä½æ™‚çµ¦3000å††
            minBudgetJPY: 50000, // æœ€ä½äºˆç®—5ä¸‡å††
            excludeKeywords: ['ãƒ†ã‚¹ãƒˆ', 'ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ', 'å˜ç´”ä½œæ¥­'],
            requiredSkills: []
        },
        currency: {
            exchangeRateUSDToJPY: 150, // USDâ†’JPYæ›ç®—ãƒ¬ãƒ¼ãƒˆ
            lastUpdated: new Date()
        }
    };
}

/**
 * ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
 */
async function executeIntegratedJobSearch(options: {
    minHourlyRate?: number;
    maxJobsPerSource?: number;
    categories?: string[];
    keywords?: string[];
    outputFormat?: 'json' | 'markdown' | 'both';
}): Promise<void> {
    console.log('ğŸš€ çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒã‚’é–‹å§‹ã—ã¾ã™...');
    console.log(`ğŸ“Š è¨­å®š: æœ€ä½æ™‚çµ¦${options.minHourlyRate || 3000}å††, æœ€å¤§å–å¾—ä»¶æ•°${options.maxJobsPerSource || 50}ä»¶/ã‚µã‚¤ãƒˆ`);

    const startTime = Date.now();

    try {
        // èªè¨¼æƒ…å ±ã¨ã‚µãƒ¼ãƒ“ã‚¹åˆæœŸåŒ–
        console.log('ğŸ” Upworkèªè¨¼æƒ…å ±ã‚’å–å¾—ä¸­...');
        const upworkCredentials = getUpworkCredentials();

        console.log('âš™ï¸ æ¤œç´¢è¨­å®šã‚’åˆæœŸåŒ–ä¸­...');
        const searchConfig = createDefaultSearchConfig();

        // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã®é©ç”¨
        if (options.minHourlyRate) {
            searchConfig.filtering.minHourlyRateJPY = options.minHourlyRate;
        }
        if (options.maxJobsPerSource) {
            searchConfig.limits.maxJobsPerSource = options.maxJobsPerSource;
        }

        // çµ±åˆã‚µãƒ¼ãƒ“ã‚¹ã®åˆæœŸåŒ–
        const integratedService = new IntegratedJobSearchService(
            upworkCredentials,
            searchConfig
        );

        console.log('ğŸ” çµ±åˆæ¡ˆä»¶æ¤œç´¢ã‚’å®Ÿè¡Œä¸­...');

        console.log('ğŸ“ æ¤œç´¢çµæœãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...');

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        const reportParams = {
            minHourlyRate: options.minHourlyRate || 3000,
            categories: options.categories || [],
            maxJobsPerSource: options.maxJobsPerSource || 50
        };

        const report = await integratedService.generateReport(reportParams);

        // çµæœã®å‡ºåŠ›
        await saveResults(report, options.outputFormat || 'both');

        // å®Ÿè¡Œã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
        displaySummary(report, Date.now() - startTime);

    } catch (error) {
        console.error('âŒ çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error instanceof Error ? error.message : String(error));
        process.exit(1);
    }
}

/**
 * çµæœã®ä¿å­˜
 */
async function saveResults(
    report: IntegratedJobReport,
    format: 'json' | 'markdown' | 'both'
): Promise<void> {
    const timestamp = new Date().toISOString().split('T')[0];
    const baseFilename = `integrated-job-report-${timestamp}`;

    if (format === 'json' || format === 'both') {
        const jsonPath = path.join(outputDir, `${baseFilename}.json`);
        writeFileSync(jsonPath, JSON.stringify(report, null, 2), 'utf8');
        console.log(`ğŸ’¾ JSON ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜: ${jsonPath}`);
    }

    if (format === 'markdown' || format === 'both') {
        const markdownPath = path.join(outputDir, `${baseFilename}.md`);
        const markdownContent = generateMarkdownReport(report);
        writeFileSync(markdownPath, markdownContent, 'utf8');
        console.log(`ğŸ“„ Markdown ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜: ${markdownPath}`);
    }

    // é«˜æ™‚çµ¦æ¡ˆä»¶ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
    if (report.highValueJobs.upwork.length > 0 || report.highValueJobs.crowdworks.length > 0) {
        const highValuePath = path.join(outputDir, `high-value-jobs-${timestamp}.md`);
        const highValueContent = generateHighValueJobsReport(report);
        writeFileSync(highValuePath, highValueContent, 'utf8');
        console.log(`ğŸ’° é«˜æ™‚çµ¦æ¡ˆä»¶è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜: ${highValuePath}`);
    }
}

/**
 * Markdownãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
function generateMarkdownReport(report: IntegratedJobReport): string {
    const date = report.generatedAt.toLocaleDateString('ja-JP');
    const time = report.generatedAt.toLocaleTimeString('ja-JP');

    return `# çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒãƒ¬ãƒãƒ¼ãƒˆ

> **ç”Ÿæˆæ—¥æ™‚**: ${date} ${time}  
> **ãƒ¬ãƒãƒ¼ãƒˆID**: ${report.id}  

## ğŸ“Š æ¤œç´¢ã‚µãƒãƒªãƒ¼

| é …ç›® | CrowdWorks | Upwork | åˆè¨ˆ |
|------|------------|--------|------|
| å–å¾—æ¡ˆä»¶æ•° | ${report.results.crowdworks.total} | ${report.results.upwork.total} | ${report.results.summary.totalJobs} |
| é«˜æ™‚çµ¦æ¡ˆä»¶æ•° | - | ${report.highValueJobs.upwork.length} | ${report.results.summary.highHourlyJobs} |
| æ¤œç´¢æˆåŠŸ | ${report.results.crowdworks.success ? 'âœ…' : 'âŒ'} | ${report.results.upwork.success ? 'âœ…' : 'âŒ'} | - |
| å®Ÿè¡Œæ™‚é–“ | ${report.results.crowdworks.executionTime}ms | ${report.results.upwork.executionTime}ms | ${report.results.summary.executionTime}ms |

## ğŸ¯ æ¤œç´¢æ¡ä»¶

- **æœ€ä½æ™‚çµ¦**: ${report.criteria.minHourlyRate.toLocaleString()}å††
- **æœ€å¤§å–å¾—ä»¶æ•°**: ${report.criteria.maxJobsPerSource}ä»¶/ã‚µã‚¤ãƒˆ
- **å¯¾è±¡ã‚«ãƒ†ã‚´ãƒª**: ${report.criteria.categories.length > 0 ? report.criteria.categories.join(', ') : 'å…¨ã‚«ãƒ†ã‚´ãƒª'}

## ğŸ“ˆ å¸‚å ´åˆ†æ

${report.analysis.marketTrends}

## ğŸ¯ ãŠã™ã™ã‚

${report.analysis.recommendations.map(rec => `- ${rec}`).join('\n')}

## âš ï¸ æ³¨æ„äº‹é …

${report.analysis.alerts.length > 0
            ? report.analysis.alerts.map(alert => `- ${alert}`).join('\n')
            : 'ç‰¹ã«ãªã—'}

## ğŸ’° é«˜æ™‚çµ¦æ¡ˆä»¶ (Upwork)

${report.highValueJobs.upwork.length > 0
            ? report.highValueJobs.upwork.map(job => {
                const hourlyRate = CurrencyService.calculateUpworkHourlyRateJPY(job, 150);
                return `### ${job.title}
- **æ™‚çµ¦**: ${hourlyRate ? `${hourlyRate.toLocaleString()}å††` : 'å›ºå®šä¾¡æ ¼'}
- **ã‚¹ã‚­ãƒ«**: ${job.skills.slice(0, 5).join(', ')}
- **ææ¡ˆæ•°**: ${job.proposals}ä»¶
- **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ**: ${job.client.country || 'ä¸æ˜'} (è©•ä¾¡ç‡: ${job.client.hireRate || 'N/A'}%)
- **URL**: [æ¡ˆä»¶è©³ç´°](${job.url})

`;
            }).join('\n')
            : 'æ¡ä»¶ã«åˆã†é«˜æ™‚çµ¦æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'}

---

*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ (${new Date().toISOString()})*
`;
}

/**
 * é«˜æ™‚çµ¦æ¡ˆä»¶è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
function generateHighValueJobsReport(report: IntegratedJobReport): string {
    return `# é«˜æ™‚çµ¦æ¡ˆä»¶è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ

> **æœ€ä½æ™‚çµ¦æ¡ä»¶**: ${report.criteria.minHourlyRate.toLocaleString()}å††ä»¥ä¸Š  
> **ç”Ÿæˆæ—¥æ™‚**: ${report.generatedAt.toLocaleString('ja-JP')}  

## ğŸ“Š ã‚µãƒãƒªãƒ¼

- **CrowdWorksé«˜æ™‚çµ¦æ¡ˆä»¶**: ${report.highValueJobs.crowdworks.length}ä»¶
- **Upworké«˜æ™‚çµ¦æ¡ˆä»¶**: ${report.highValueJobs.upwork.length}ä»¶
- **ç·åˆè¨ˆ**: ${report.highValueJobs.crowdworks.length + report.highValueJobs.upwork.length}ä»¶

## ğŸ’° Upwork é«˜æ™‚çµ¦æ¡ˆä»¶è©³ç´°

${report.highValueJobs.upwork.map((job, index) => {
        const hourlyRate = CurrencyService.calculateUpworkHourlyRateJPY(job, 150);

        return `### ${index + 1}. ${job.title}

**åŸºæœ¬æƒ…å ±**
- **æ™‚çµ¦**: ${hourlyRate ? `${hourlyRate.toLocaleString()}å†† (USD $${job.budget.min || 'N/A'}-$${job.budget.max || 'N/A'})` : `å›ºå®šä¾¡æ ¼ $${job.budget.amount}`}
- **æ¡ˆä»¶ã‚¿ã‚¤ãƒ—**: ${job.jobType === 'hourly' ? 'æ™‚é–“å˜ä¾¡' : 'å›ºå®šä¾¡æ ¼'}
- **æœŸé–“**: ${job.duration}
- **çµŒé¨“ãƒ¬ãƒ™ãƒ«**: ${job.experienceLevel}
- **ææ¡ˆæ•°**: ${job.proposals}ä»¶

**ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±**
- **å›½**: ${job.client.country || 'ä¸æ˜'}
- **ç™»éŒ²æ—¥**: ${job.client.memberSince || 'ä¸æ˜'}
- **ç·æ”¯å‡º**: $${job.client.totalSpent?.toLocaleString() || 'N/A'}
- **æ¡ç”¨ç‡**: ${job.client.hireRate || 'N/A'}%
- **æ”¯æ‰•ã„èªè¨¼**: ${job.client.paymentVerified ? 'âœ…' : 'âŒ'}

**å¿…è¦ã‚¹ã‚­ãƒ«**
${job.skills.map(skill => `- ${skill}`).join('\n')}

**æ¡ˆä»¶èª¬æ˜**
${job.description.substring(0, 200)}...

**è©³ç´°URL**: [${job.url}](${job.url})

---

`;
    }).join('')}

## ğŸ¯ CrowdWorks é«˜æ™‚çµ¦æ¡ˆä»¶è©³ç´°

${report.highValueJobs.crowdworks.length > 0
            ? 'CrowdWorksæ¡ˆä»¶ã®è©³ç´°ã¯ã“ã¡ã‚‰ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆå®Ÿè£…äºˆå®šï¼‰'
            : 'æ¡ä»¶ã«åˆã†CrowdWorksæ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚'}

---

*è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†*
`;
}

/**
 * å®Ÿè¡Œã‚µãƒãƒªãƒ¼ã®è¡¨ç¤º
 */
function displaySummary(report: IntegratedJobReport, executionTime: number): void {
    console.log('\nğŸ‰ çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒå®Œäº†ï¼');
    console.log('='.repeat(50));
    console.log(`ğŸ“Š ç·æ¡ˆä»¶æ•°: ${report.results.summary.totalJobs}ä»¶`);
    console.log(`ğŸ’° é«˜æ™‚çµ¦æ¡ˆä»¶: ${report.results.summary.highHourlyJobs}ä»¶`);
    console.log(`ğŸ“ˆ å¹³å‡æ™‚çµ¦: ${report.results.summary.averageHourlyRate.toLocaleString()}å††`);
    console.log(`â±ï¸ å®Ÿè¡Œæ™‚é–“: ${Math.round(executionTime / 1000)}ç§’`);
    console.log('='.repeat(50));

    if (report.analysis.alerts.length > 0) {
        console.log('\nâš ï¸ æ³¨æ„äº‹é …:');
        report.analysis.alerts.forEach(alert => console.log(`  - ${alert}`));
    }

    if (report.analysis.recommendations.length > 0) {
        console.log('\nğŸ¯ ãŠã™ã™ã‚:');
        report.analysis.recommendations.forEach(rec => console.log(`  - ${rec}`));
    }
}

/**
 * CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 */
async function main(): Promise<void> {
    const args = process.argv.slice(2);

    // ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
    if (args.includes('--help') || args.includes('-h')) {
        console.log(`
ğŸ” çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒãƒ„ãƒ¼ãƒ« - CrowdWorks & Upwork

ä½¿ç”¨æ–¹æ³•:
  npm run integrated-search [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]

ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  --min-rate <æ•°å€¤>     æœ€ä½æ™‚çµ¦ï¼ˆå††ï¼‰[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 3000]
  --max-jobs <æ•°å€¤>     æœ€å¤§å–å¾—ä»¶æ•°/ã‚µã‚¤ãƒˆ [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50]
  --categories <æ–‡å­—åˆ—> å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
  --keywords <æ–‡å­—åˆ—>   æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
  --format <å½¢å¼>       å‡ºåŠ›å½¢å¼ [json|markdown|both] [ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: both]
  --help, -h           ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

ç’°å¢ƒå¤‰æ•°:
  UPWORK_CONSUMER_KEY     Upwork Consumer Keyï¼ˆå¿…é ˆï¼‰
  UPWORK_CONSUMER_SECRET  Upwork Consumer Secretï¼ˆå¿…é ˆï¼‰
  UPWORK_ACCESS_TOKEN     Upwork Access Tokenï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  UPWORK_ACCESS_TOKEN_SECRET Upwork Access Token Secretï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ä¾‹:
  npm run integrated-search
  npm run integrated-search -- --min-rate 4000 --max-jobs 30
  npm run integrated-search -- --categories "web,mobile" --keywords "react,typescript"
    `);
        return;
    }

    // å¼•æ•°ã®è§£æ
    const options: Parameters<typeof executeIntegratedJobSearch>[0] = {};

    for (let i = 0; i < args.length; i++) {
        const arg = args[i];
        const nextArg = args[i + 1];

        switch (arg) {
            case '--min-rate':
                if (nextArg !== undefined) {
                    options.minHourlyRate = parseInt(nextArg);
                    i++; // æ¬¡ã®å¼•æ•°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                }
                break;
            case '--max-jobs':
                if (nextArg !== undefined) {
                    options.maxJobsPerSource = parseInt(nextArg);
                    i++; // æ¬¡ã®å¼•æ•°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                }
                break;
            case '--categories':
                if (nextArg !== undefined) {
                    options.categories = nextArg.split(',').map(s => s.trim());
                    i++; // æ¬¡ã®å¼•æ•°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                }
                break;
            case '--keywords':
                if (nextArg !== undefined) {
                    options.keywords = nextArg.split(',').map(s => s.trim());
                    i++; // æ¬¡ã®å¼•æ•°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                }
                break;
            case '--format':
                if (nextArg !== undefined) {
                    options.outputFormat = nextArg as 'json' | 'markdown' | 'both';
                    i++; // æ¬¡ã®å¼•æ•°ã‚’ã‚¹ã‚­ãƒƒãƒ—
                }
                break;
        }
    }

    await executeIntegratedJobSearch(options);
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if (require.main === module) {
    main().catch(error => {
        console.error('âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : String(error));
        process.exit(1);
    });
}

export { executeIntegratedJobSearch };
</file>

<file path="scripts/scrape-crowdworks-50jobs.ts">
import puppeteer from 'puppeteer';
import * as fs from 'fs';

interface CrowdWorksJob {
    jobId: string;
    title: string;
    category: string;
    url: string;
    budget: string;
    description: string;
    client: string;
    tags: string[];
    postedAt: string;
    scrapedAt: string;
}

async function scrapeCrowdWorksWebJobs(): Promise<void> {
    console.log('ğŸš€ CrowdWorks Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹ï¼ˆ30ä»¶å–å¾—ï¼‰');

    const browser = await puppeteer.launch({
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();
    page.setDefaultTimeout(60000); // 60ç§’ã«å»¶é•·
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36');

    const allJobs: CrowdWorksJob[] = [];

    // Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰30ä»¶å–å¾—
    const categoryUrl = 'https://crowdworks.jp/public/jobs/category/241';
    console.log(`ğŸ“„ ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹: ${categoryUrl}`);

    try {
        await page.goto(categoryUrl, { waitUntil: 'domcontentloaded', timeout: 60000 });
        await new Promise(resolve => setTimeout(resolve, 3000)); // 3ç§’å¾…æ©Ÿ

        // æ¡ˆä»¶ãƒªãƒ³ã‚¯ã‚’30ä»¶å–å¾—
        const jobLinks = await page.evaluate(() => {
            const links: string[] = [];
            const linkElements = document.querySelectorAll('a[href*="/public/jobs/"]');

            for (let i = 0; i < linkElements.length; i++) {
                const link = linkElements[i] as HTMLAnchorElement;
                if (link) {
                    const href = link.getAttribute('href');
                    if (href && href.match(/\/public\/jobs\/\d+$/)) { // æ•°å­—ã®IDã§çµ‚ã‚ã‚‹ã‚‚ã®ã®ã¿
                        const fullUrl = href.startsWith('http') ? href : `https://crowdworks.jp${href}`;
                        if (!links.includes(fullUrl)) {
                            links.push(fullUrl);
                        }
                    }
                }
            }

            return links.slice(0, 30); // 30ä»¶ã«åˆ¶é™
        });

        console.log(`ğŸ“‹ å–å¾—ã—ãŸæ¡ˆä»¶URLæ•°: ${jobLinks.length}ä»¶`);

        // å„æ¡ˆä»¶ã®è©³ç´°ã‚’å–å¾—
        for (let i = 0; i < jobLinks.length; i++) {
            const jobUrl = jobLinks[i];
            if (!jobUrl) continue;

            console.log(`ğŸ” æ¡ˆä»¶ ${i + 1}/${jobLinks.length} ã‚’å‡¦ç†ä¸­: ${jobUrl}`);

            try {
                const jobId = jobUrl.split('/').pop() || '';

                await page.goto(jobUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });
                await new Promise(resolve => setTimeout(resolve, 2000)); // 2ç§’å¾…æ©Ÿ

                const jobDetails = await page.evaluate((currentUrl, currentJobId) => {
                    // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—ï¼ˆæˆåŠŸã—ãŸãƒ­ã‚¸ãƒƒã‚¯ï¼‰
                    let title = '';
                    const h1Elements = document.querySelectorAll('h1');
                    if (h1Elements.length >= 2) {
                        const secondH1 = h1Elements[1];
                        if (secondH1) {
                            const text = secondH1.textContent?.trim() || '';
                            const cleanText = text.replace(/\\n/g, ' ').replace(/\\s+/g, ' ');
                            const match = cleanText.match(/^(.+?)\\s+.*ã®ä»•äº‹ã®ä¾é ¼$/);
                            if (match && match[1]) {
                                title = match[1].trim();
                            } else {
                                const splitResult = cleanText.split('ã®ä»•äº‹ã®ä¾é ¼');
                                if (splitResult && splitResult[0]) {
                                    title = splitResult[0].trim();
                                }
                            }
                        }
                    }

                    // äºˆç®—ã®å–å¾—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
                    let budget = '';
                    const table = document.querySelector('table');
                    if (table) {
                        const rows = Array.from(table.querySelectorAll('tr'));
                        for (const row of rows) {
                            const cells = Array.from(row.querySelectorAll('td'));
                            if (cells.length >= 2) {
                                const secondCell = cells[1];
                                const text = secondCell?.textContent?.trim() || '';
                                if (text.includes('å††') && (text.includes('ã€œ') || text.includes('-') || text.includes('ä»¥ä¸Š'))) {
                                    budget = text;
                                    break;
                                }
                            }
                        }
                    }

                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯äºˆç®—å–å¾—
                    if (!budget) {
                        const walker = document.createTreeWalker(
                            document.body,
                            NodeFilter.SHOW_TEXT
                        );
                        let node;
                        while (node = walker.nextNode()) {
                            const text = node.textContent?.trim() || '';
                            if (text.includes('å††') && text.match(/[\\d,]+å††/)) {
                                budget = text;
                                break;
                            }
                        }
                    }

                    // èª¬æ˜æ–‡ã®å–å¾—ï¼ˆæ”¹å–„ç‰ˆï¼‰
                    let description = '';
                    const headings = Array.from(document.querySelectorAll('h2'));
                    const detailHeading = headings.find(h => h.textContent?.includes('ä»•äº‹ã®è©³ç´°'));

                    if (detailHeading) {
                        let nextElement = detailHeading.nextElementSibling;
                        while (nextElement) {
                            if (nextElement.tagName === 'TABLE') {
                                const rows = Array.from(nextElement.querySelectorAll('tr'));
                                for (const row of rows) {
                                    const cells = Array.from(row.querySelectorAll('td'));
                                    if (cells.length >= 1) {
                                        const cellText = cells[0]?.textContent?.trim() || '';
                                        if (cellText.length > 50) {
                                            description = cellText.substring(0, 500);
                                            break;
                                        }
                                    }
                                }
                                break;
                            }
                            nextElement = nextElement.nextElementSibling;
                        }
                    }

                    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã®å–å¾—
                    let client = '';
                    const clientElement = document.querySelector('a[href*="/public/employees/"] span, .client-name');
                    if (clientElement) {
                        client = clientElement.textContent?.trim() || '';
                    }

                    return {
                        jobId: currentJobId,
                        title: title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜',
                        category: 'webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
                        url: currentUrl || '',
                        budget: budget || 'æœªå–å¾—',
                        description: description || 'ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼',
                        client: client || 'æœªå–å¾—',
                        tags: [],
                        postedAt: '',
                        scrapedAt: new Date().toISOString()
                    };
                }, jobUrl, jobId);

                allJobs.push(jobDetails);

                if (jobDetails.title !== 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜' && jobDetails.budget !== 'æœªå–å¾—') {
                    console.log(`âœ… æˆåŠŸ: ${jobDetails.title}`);
                } else {
                    console.log(`âš ï¸ éƒ¨åˆ†å–å¾—: ${jobDetails.title} (${jobDetails.budget})`);
                }

            } catch (error) {
                console.error(`âŒ æ¡ˆä»¶è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ${error}`);
                allJobs.push({
                    jobId: jobUrl.split('/').pop() || '',
                    title: 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼',
                    category: 'webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢',
                    url: jobUrl,
                    budget: 'ã‚¨ãƒ©ãƒ¼',
                    description: 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                    client: 'ã‚¨ãƒ©ãƒ¼',
                    tags: [],
                    postedAt: '',
                    scrapedAt: new Date().toISOString()
                });
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const filename = `output/crowdworks-web-jobs-${timestamp}.json`;

        fs.writeFileSync(filename, JSON.stringify(allJobs, null, 2), 'utf8');

        console.log(`\\nğŸ‰ CrowdWorks Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†ï¼`);
        console.log(`ğŸ“Š ç·å–å¾—ä»¶æ•°: ${allJobs.length}ä»¶ (ç›®æ¨™: 30ä»¶)`);
        console.log(`âœ… ã‚¿ã‚¤ãƒˆãƒ«å–å¾—æˆåŠŸ: ${allJobs.filter(j => j.title !== 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜').length}ä»¶`);
        console.log(`ğŸ’° äºˆç®—å–å¾—æˆåŠŸ: ${allJobs.filter(j => j.budget !== 'æœªå–å¾—' && j.budget !== 'ã‚¨ãƒ©ãƒ¼').length}ä»¶`);
        console.log(`ğŸ’¾ ä¿å­˜å…ˆ: ${filename}`);

    } catch (error) {
        console.error('ğŸ’¥ ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼:', error);
        process.exit(1);
    }

    await browser.close();
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
if (require.main === module) {
    scrapeCrowdWorksWebJobs().catch(error => {
        console.error('ğŸ’¥ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        process.exit(1);
    });
}

export default scrapeCrowdWorksWebJobs;
</file>

<file path="scripts/scrape-crowdworks.ts">
import puppeteer from 'puppeteer';
import { writeFileSync } from 'fs';

interface CrowdWorksJob {
    jobId: string;
    title: string;
    category: string;
    url: string;
    budget: string;
    description: string;
    client: string;
    tags: string[];
    postedAt: string;
    scrapedAt: string;
}

async function scrapeCrowdWorksJobs(): Promise<void> {
    console.log('ğŸš€ CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹ï¼ˆå„ã‚«ãƒ†ã‚´ãƒª10ä»¶ãšã¤ï¼‰');

    const browser = await puppeteer.launch({
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    const page = await browser.newPage();
    await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36');

    // ã‚«ãƒ†ã‚´ãƒªè¨­å®šï¼ˆ10ä»¶ãšã¤ï¼‰
    const categories = [
        { name: 'development', url: 'https://crowdworks.jp/public/jobs/category/1', maxJobs: 10 },
        { name: 'web_products', url: 'https://crowdworks.jp/public/jobs/category/9', maxJobs: 10 },
        { name: 'ec', url: 'https://crowdworks.jp/public/jobs/category/10', maxJobs: 10 },
        { name: 'software_development', url: 'https://crowdworks.jp/public/jobs/category/236', maxJobs: 10 }
    ];

    const allJobs: CrowdWorksJob[] = [];

    for (const category of categories) {
        console.log(`\nğŸ“ ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­...`);

        try {
            await page.goto(category.url, { waitUntil: 'networkidle2' });
            await new Promise(resolve => setTimeout(resolve, 2000));

            // æ¡ˆä»¶ãƒªãƒ³ã‚¯ã‚’å–å¾—
            const jobLinks = await page.$$eval('a[href*="/public/jobs/"]', links =>
                links.map(link => (link as HTMLAnchorElement).href)
                    .filter(href => href.match(/\/public\/jobs\/\d+$/))
                    .slice(0, 10) // 10ä»¶ã«åˆ¶é™
            );

            console.log(`ğŸ” ${category.name}ã‚«ãƒ†ã‚´ãƒª: ${jobLinks.length}ä»¶ã®æ¡ˆä»¶ã‚’ç™ºè¦‹`);

            // å„æ¡ˆä»¶ã®è©³ç´°ã‚’å–å¾—
            for (const [index, jobUrl] of jobLinks.entries()) {
                try {
                    console.log(`ğŸ“‹ ${index + 1}/${jobLinks.length}: ${jobUrl.split('/').pop()}`);

                    await page.goto(jobUrl, { waitUntil: 'networkidle2' });
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    const jobData = await page.evaluate((url, categoryName) => {
                        const title = document.querySelector('h1')?.textContent?.trim() || '';
                        const jobId = url.split('/').pop() || '';

                        // äºˆç®—ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ã‚’è©¦è¡Œï¼‰
                        let budget = '';
                        const budgetSelectors = [
                            'table tr:has(th:contains("äºˆç®—")) td',
                            'table tr:has(th:contains("å›ºå®šå ±é…¬")) td',
                            'table tr:has(th:contains("æ™‚é–“å˜ä¾¡")) td',
                            '.job-detail-table tr:has(th:contains("äºˆç®—")) td'
                        ];

                        for (const selector of budgetSelectors) {
                            const element = document.querySelector(selector);
                            if (element && element.textContent?.trim()) {
                                budget = element.textContent.trim();
                                break;
                            }
                        }

                        // è©³ç´°èª¬æ˜ã‚’å–å¾—
                        let description = '';
                        const descSelectors = [
                            '.job_description',
                            '.job-detail-description',
                            'div:has(h2:contains("ä¾é ¼è©³ç´°")) + div',
                            '.description'
                        ];

                        for (const selector of descSelectors) {
                            const element = document.querySelector(selector);
                            if (element && element.textContent?.trim()) {
                                description = element.textContent.trim().substring(0, 500);
                                break;
                            }
                        }

                        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
                        let client = '';
                        const clientElement = document.querySelector('a[href*="/public/employees/"] span, .client-name');
                        if (clientElement) {
                            client = clientElement.textContent?.trim() || '';
                        }

                        return {
                            jobId,
                            title,
                            category: categoryName,
                            url,
                            budget,
                            description,
                            client,
                            tags: [],
                            postedAt: '',
                            scrapedAt: new Date().toISOString()
                        };
                    }, jobUrl, category.name);

                    allJobs.push(jobData);
                    console.log(`âœ… ${jobData.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜'}`);

                } catch (error) {
                    console.log(`âŒ æ¡ˆä»¶å–å¾—ã‚¨ãƒ©ãƒ¼: ${jobUrl}`);
                }
            }

        } catch (error) {
            console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã§ã‚¨ãƒ©ãƒ¼:`, error);
        }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `output/crowdworks-jobs-${timestamp}.json`;

    writeFileSync(filename, JSON.stringify(allJobs, null, 2), 'utf8');

    console.log(`\nğŸ‰ CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†ï¼`);
    console.log(`ğŸ“Š ç·å–å¾—ä»¶æ•°: ${allJobs.length}ä»¶`);
    console.log(`ğŸ’¾ ä¿å­˜å…ˆ: ${filename}`);

    await browser.close();
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
if (require.main === module) {
    scrapeCrowdWorksJobs().catch(error => {
        console.error('ğŸ’¥ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
        process.exit(1);
    });
}

export default scrapeCrowdWorksJobs;
</file>

<file path="scripts/setup-github-oidc.sh">
#!/bin/bash

# GitHub Actions OIDCç”¨ã®IAMãƒ­ãƒ¼ãƒ«ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨æ–¹æ³•: ./scripts/setup-github-oidc.sh <YOUR_GITHUB_USERNAME> <REPOSITORY_NAME>

set -e

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
if [ $# -ne 2 ]; then
    echo "ä½¿ç”¨æ–¹æ³•: $0 <GITHUB_USERNAME> <REPOSITORY_NAME>"
    echo "ä¾‹: $0 myusername crowdworks-search"
    exit 1
fi

GITHUB_USERNAME=$1
REPOSITORY_NAME=$2
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
AWS_REGION=$(aws configure get region || echo "ap-northeast-1")

echo "ğŸš€ GitHub Actions OIDCèªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
echo "GitHub: ${GITHUB_USERNAME}/${REPOSITORY_NAME}"
echo "AWS Account: ${AWS_ACCOUNT_ID}"
echo "AWS Region: ${AWS_REGION}"

# OIDC Identity Providerã®ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
echo "ğŸ“‹ OIDC Identity Providerã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
if ! aws iam get-open-id-connect-provider --open-id-connect-provider-arn "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com" 2>/dev/null; then
    echo "ğŸ“ OIDC Identity Providerã‚’ä½œæˆä¸­..."
    aws iam create-open-id-connect-provider \
        --url "https://token.actions.githubusercontent.com" \
        --thumbprint-list "6938fd4d98bab03faadb97b34396831e3780aea1" \
        --client-id-list "sts.amazonaws.com"
    echo "âœ… OIDC Identity Providerã‚’ä½œæˆã—ã¾ã—ãŸ"
else
    echo "âœ… OIDC Identity Providerã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
fi

# Stagingç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ä½œæˆ
echo "ğŸ“ Stagingç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆä¸­..."
STAGING_ROLE_NAME="GitHubActions-CrowdWorksSearch-Staging"

# ä¿¡é ¼ãƒãƒªã‚·ãƒ¼
cat > /tmp/staging-trust-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": [
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:ref:refs/heads/develop",
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:environment:staging"
                    ]
                }
            }
        }
    ]
}
EOF

# Productionç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ä½œæˆ
echo "ğŸ“ Productionç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆä¸­..."
PRODUCTION_ROLE_NAME="GitHubActions-CrowdWorksSearch-Production"

# ä¿¡é ¼ãƒãƒªã‚·ãƒ¼
cat > /tmp/production-trust-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": [
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:ref:refs/heads/main",
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:environment:production"
                    ]
                }
            }
        }
    ]
}
EOF

# æ¨©é™ãƒãƒªã‚·ãƒ¼
cat > /tmp/deploy-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "cloudformation:*",
                "s3:*",
                "lambda:*",
                "iam:*",
                "logs:*",
                "events:*",
                "ecr:*",
                "ssm:GetParameter",
                "ssm:GetParameters",
                "sts:AssumeRole"
            ],
            "Resource": "*"
        }
    ]
}
EOF

# Stagingãƒ­ãƒ¼ãƒ«ä½œæˆ
if aws iam get-role --role-name "${STAGING_ROLE_NAME}" 2>/dev/null; then
    echo "âš ï¸  Stagingãƒ­ãƒ¼ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/N)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        aws iam delete-role --role-name "${STAGING_ROLE_NAME}" || true
    else
        echo "Stagingãƒ­ãƒ¼ãƒ«ã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
    fi
fi

if ! aws iam get-role --role-name "${STAGING_ROLE_NAME}" 2>/dev/null; then
    aws iam create-role \
        --role-name "${STAGING_ROLE_NAME}" \
        --assume-role-policy-document file:///tmp/staging-trust-policy.json \
        --description "GitHub Actions deployment role for staging environment"
    
    aws iam put-role-policy \
        --role-name "${STAGING_ROLE_NAME}" \
        --policy-name "DeploymentPolicy" \
        --policy-document file:///tmp/deploy-policy.json
    
    echo "âœ… Stagingãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

# Productionãƒ­ãƒ¼ãƒ«ä½œæˆ
if aws iam get-role --role-name "${PRODUCTION_ROLE_NAME}" 2>/dev/null; then
    echo "âš ï¸  Productionãƒ­ãƒ¼ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/N)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        aws iam delete-role --role-name "${PRODUCTION_ROLE_NAME}" || true
    else
        echo "Productionãƒ­ãƒ¼ãƒ«ã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
    fi
fi

if ! aws iam get-role --role-name "${PRODUCTION_ROLE_NAME}" 2>/dev/null; then
    aws iam create-role \
        --role-name "${PRODUCTION_ROLE_NAME}" \
        --assume-role-policy-document file:///tmp/production-trust-policy.json \
        --description "GitHub Actions deployment role for production environment"
    
    aws iam put-role-policy \
        --role-name "${PRODUCTION_ROLE_NAME}" \
        --policy-name "DeploymentPolicy" \
        --policy-document file:///tmp/deploy-policy.json
    
    echo "âœ… Productionãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
rm -f /tmp/staging-trust-policy.json /tmp/production-trust-policy.json /tmp/deploy-policy.json

echo ""
echo "ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "æ¬¡ã®æ‰‹é †:"
echo "1. GitHubãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š"
echo ""
echo "   STAGING_AWS_ROLE_ARN=arn:aws:iam::${AWS_ACCOUNT_ID}:role/${STAGING_ROLE_NAME}"
echo "   PRODUCTION_AWS_ROLE_ARN=arn:aws:iam::${AWS_ACCOUNT_ID}:role/${PRODUCTION_ROLE_NAME}"
echo ""
echo "2. (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) Slacké€šçŸ¥ç”¨ï¼š"
echo "   SLACK_WEBHOOK_URL=<your-slack-webhook-url>"
echo ""
echo "3. GitHubã§Environmentsã‚’è¨­å®šï¼š"
echo "   - Settings > Environments"
echo "   - 'staging' ç’°å¢ƒã‚’ä½œæˆ"
echo "   - 'production' ç’°å¢ƒã‚’ä½œæˆï¼ˆä¿è­·ãƒ«ãƒ¼ãƒ«è¨­å®šæ¨å¥¨ï¼‰"
echo ""
echo "ã“ã‚Œã§CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§AWSãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼"
</file>

<file path="scripts/test-lancers-5jobs.ts">
import puppeteer, { Browser, Page } from 'puppeteer';

interface LancersJob {
    id: string;
    title: string;
    description: string;
    budget: {
        type: 'fixed' | 'hourly' | 'unknown';
        amount: number;
        currency: string;
    };
    hourlyRate?: number;
    category: string;
    client: {
        name: string;
        rating: number;
        reviewCount: number;
        completionRate: string;
        orders: number;
    };
    skills: string[];
    applicationCount: number;
    isUrgent: boolean;
    postDate: string;
    deadline: string;
    url: string;
}

async function testLancersJobDetail(browser: Browser, jobId: string): Promise<LancersJob | null> {
    const page: Page = await browser.newPage();

    try {
        const url = `https://www.lancers.jp/work/detail/${jobId}`;
        console.log(`ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ãƒšãƒ¼ã‚¸: ${url}`);

        await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
        await new Promise(resolve => setTimeout(resolve, 2000));

        // å‰Šé™¤ã‚„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã‹ãƒã‚§ãƒƒã‚¯
        const errorCheck = await page.evaluate(() => {
            const banner = document.querySelector('banner h1[level="1"]');
            if (banner) {
                const text = banner.textContent || '';
                if (text.includes('é–²è¦§åˆ¶é™') || text.includes('å‰Šé™¤')) {
                    return { error: true, message: text };
                }
            }
            return { error: false };
        });

        if (errorCheck.error) {
            console.log(`âš ï¸ ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${jobId}`);
            return null;
        }

        const job: LancersJob = {
            id: jobId,
            title: '',
            description: '',
            budget: {
                type: 'unknown',
                amount: 0,
                currency: 'å††'
            },
            category: 'test',
            client: {
                name: '',
                rating: 0,
                reviewCount: 0,
                completionRate: '',
                orders: 0
            },
            skills: [],
            applicationCount: 0,
            isUrgent: false,
            postDate: '',
            deadline: '',
            url
        };

        // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—ï¼ˆå®Ÿéš›ã®ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ§‹é€ ã«åŸºã¥ãï¼‰
        try {
            const title = await page.evaluate(() => {
                const h1 = document.querySelector('h1');
                if (!h1) return '';

                // "ã€æ€¥å‹Ÿã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­ä¾›å‘ã‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¬ãƒƒã‚¹ãƒ³è¬›å¸«ã‚’å‹Ÿé›†ï¼ã®ä»•äº‹ [ITãƒ»é€šä¿¡ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ]"
                // ã‹ã‚‰ "ã€æ€¥å‹Ÿã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­ä¾›å‘ã‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¬ãƒƒã‚¹ãƒ³è¬›å¸«ã‚’å‹Ÿé›†ï¼" ã‚’æŠ½å‡º
                const fullText = h1.textContent || '';
                const match = fullText.match(/^(.+?)ã®ä»•äº‹/);
                return match ? match[1]!.trim() : fullText.replace(/\s*\[.*?\]\s*$/, '').trim();
            });

            if (title && title.length > 5) {
                job.title = title;
                console.log(`âœ… ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}`);
            } else {
                console.log('âš ï¸ ã‚¿ã‚¤ãƒˆãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        } catch (error) {
            console.error('ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }

        // äºˆç®—ã®å–å¾—ï¼ˆå®šç¾©ãƒªã‚¹ãƒˆã‹ã‚‰ã®æŠ½å‡ºï¼‰
        try {
            const budget = await page.evaluate(() => {
                const terms = Array.from(document.querySelectorAll('dt'));
                for (const term of terms) {
                    if (term.textContent?.includes('æç¤ºã—ãŸäºˆç®—') || term.textContent?.includes('äºˆç®—')) {
                        const dd = term.nextElementSibling;
                        if (dd && dd.tagName === 'DD') {
                            return dd.textContent?.trim() || '';
                        }
                    }
                }
                return '';
            });

            if (budget) {
                const amountMatch = budget.match(/(\d{1,3}(?:,\d{3})*)/);
                if (amountMatch && amountMatch[1]) {
                    job.budget.amount = parseInt(amountMatch[1].replace(/,/g, ''));
                    job.budget.type = budget.includes('æ™‚é–“') ? 'hourly' : 'fixed';
                    console.log(`âœ… äºˆç®—: ${budget} (${job.budget.amount}å††)`);
                }
            } else {
                console.log('âš ï¸ äºˆç®—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        } catch (error) {
            console.error('äºˆç®—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }

        // è©³ç´°èª¬æ˜ã®å–å¾—ï¼ˆå®šç¾©ãƒªã‚¹ãƒˆã‹ã‚‰ã®æŠ½å‡ºï¼‰
        try {
            const description = await page.evaluate(() => {
                const terms = Array.from(document.querySelectorAll('dt'));
                for (const term of terms) {
                    if (term.textContent?.includes('ä¾é ¼æ¦‚è¦')) {
                        const dd = term.nextElementSibling;
                        if (dd && dd.tagName === 'DD') {
                            const text = dd.textContent?.trim() || '';
                            // æœ€åˆã®200æ–‡å­—ã«åˆ¶é™
                            return text.length > 200 ? text.substring(0, 200) + '...' : text;
                        }
                    }
                }
                return '';
            });

            if (description && description.length > 20) {
                job.description = description;
                console.log(`âœ… è©³ç´°èª¬æ˜: ${job.description.substring(0, 100)}...`);
            } else {
                console.log('âš ï¸ è©³ç´°èª¬æ˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        } catch (error) {
            console.error('è©³ç´°èª¬æ˜å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }

        return job;

    } catch (error) {
        console.error(`âŒ ã‚¨ãƒ©ãƒ¼ (jobId: ${jobId}):`, error);
        return null;
    } finally {
        await page.close();
    }
}

async function main() {
    console.log('ğŸš€ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆ5ä»¶ï¼‰ã‚’é–‹å§‹ã—ã¾ã™...');

    // æ–°ã—ã„æœ‰åŠ¹ãªã‚¸ãƒ§ãƒ–IDï¼ˆå®Ÿéš›ã®ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚µã‚¤ãƒˆã‹ã‚‰ç¢ºèªæ¸ˆã¿ï¼‰
    const testJobIds: string[] = [
        '5323878', // æ–°ã—ãå–å¾—ã•ã‚ŒãŸID
        '5323864', // æ–°ã—ãå–å¾—ã•ã‚ŒãŸID
        '5323784', // æ–°ã—ãå–å¾—ã•ã‚ŒãŸID
        '5323287', // æ–°ã—ãå–å¾—ã•ã‚ŒãŸID
        '5323680'  // æ–°ã—ãå–å¾—ã•ã‚ŒãŸID
    ];

    const browser = await puppeteer.launch({
        headless: true,    // é«˜é€Ÿå®Ÿè¡Œã®ãŸã‚headlessãƒ¢ãƒ¼ãƒ‰
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-web-security',
            '--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        ]
    });

    const results: LancersJob[] = [];

    for (let i = 0; i < testJobIds.length; i++) {
        const jobId = testJobIds[i]!;
        console.log(`\nğŸ“‹ ${i + 1}/${testJobIds.length}: ${jobId} ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­...`);

        const job = await testLancersJobDetail(browser, jobId);
        if (job) {
            results.push(job);
            console.log(`âœ… æˆåŠŸ: ${job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜'}`);
        } else {
            console.log(`âŒ å¤±æ•—: ${jobId}`);
        }

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’ç©ºã‘ã‚‹
        if (i < testJobIds.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 3000));
        }
    }

    await browser.close();

    // çµæœã®é›†è¨ˆ
    console.log('\nğŸ“Š çµæœã‚µãƒãƒªãƒ¼:');
    console.log(`æˆåŠŸ: ${results.length}/${testJobIds.length} (${Math.round(results.length / testJobIds.length * 100)}%)`);

    let titlesFound = 0;
    let budgetsFound = 0;
    let descriptionsFound = 0;

    results.forEach(job => {
        if (job.title) titlesFound++;
        if (job.budget.amount > 0) budgetsFound++;
        if (job.description) descriptionsFound++;
    });

    console.log(`ã‚¿ã‚¤ãƒˆãƒ«å–å¾—: ${titlesFound}/${results.length}`);
    console.log(`äºˆç®—å–å¾—: ${budgetsFound}/${results.length}`);
    console.log(`è©³ç´°èª¬æ˜å–å¾—: ${descriptionsFound}/${results.length}`);

    // å–å¾—ã§ããŸãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤º
    if (results.length > 0) {
        console.log('\nğŸ“ å–å¾—ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:');
        for (let i = 0; i < Math.min(3, results.length); i++) {
            const job = results[i]!;
            console.log(`\n[${job.id}]`);
            console.log(`ã‚¿ã‚¤ãƒˆãƒ«: ${job.title || 'å–å¾—å¤±æ•—'}`);
            console.log(`äºˆç®—: ${job.budget.amount > 0 ? job.budget.amount + 'å††' : 'å–å¾—å¤±æ•—'}`);
            console.log(`èª¬æ˜: ${job.description ? job.description.substring(0, 50) + '...' : 'å–å¾—å¤±æ•—'}`);
        }
    }
}

main().catch(console.error);
</file>

<file path="scripts/test-scraping-5jobs.ts">
import puppeteer, { Browser, Page } from 'puppeteer';
import * as fs from 'fs';
import * as path from 'path';

interface JobDetail {
    jobId: string;
    category: string;
    url: string;
    title: string;
    paymentType: string;
    budget: string;
    deliveryDate: string;
    postDate: string;
    applicationDeadline: string;
    applicantCount: number;
    contractCount: number;
    recruitmentCount: number;
    favoriteCount: number;
    detailedDescription: string;
    client: {
        name: string;
        url: string;
        overallRating: string;
        orderHistory: string;
        completionRate: string;
        thankCount: string;
        identityVerified: boolean;
        orderRuleCheck: boolean;
        description: string;
    };
    desiredImages: string[];
    recentApplicants: any[];
    scrapedAt: string;
}

async function scrapeJobDetails(browser: Browser, jobId: string, category: string): Promise<JobDetail | null> {
    const page: Page = await browser.newPage();

    try {
        const url = `https://crowdworks.jp/public/jobs/${jobId}`;
        console.log(`ğŸ” ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­: ${url}`);

        await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
        await new Promise(resolve => setTimeout(resolve, 2000));

        const jobDetail: JobDetail = {
            jobId,
            category,
            url,
            title: '',
            paymentType: '',
            budget: '',
            deliveryDate: '',
            postDate: '',
            applicationDeadline: '',
            applicantCount: 0,
            contractCount: 0,
            recruitmentCount: 0,
            favoriteCount: 0,
            detailedDescription: '',
            client: {
                name: '',
                url: '',
                overallRating: '',
                orderHistory: '',
                completionRate: '',
                thankCount: '',
                identityVerified: false,
                orderRuleCheck: false,
                description: ''
            },
            desiredImages: [],
            recentApplicants: [],
            scrapedAt: new Date().toISOString()
        };

        // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—
        try {
            // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ã‹ã‚‰æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
            let titleFound = false;

            // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã§ç¢ºèªã—ãŸ2ç•ªç›®ã®h1è¦ç´ ã‹ã‚‰æ¡ˆä»¶åã‚’æŠ½å‡º
            const mainH1 = await page.$$eval('h1', (elements) => {
                if (elements.length >= 2) {
                    const secondH1 = elements[1];
                    if (secondH1) {
                        const text = secondH1.textContent?.trim() || '';
                        // æ”¹è¡Œã¨ä½™åˆ†ãªç©ºç™½ã‚’é™¤å»ã—ã€"ã®ä»•äº‹ã®ä¾é ¼"ã®å‰ã®éƒ¨åˆ†ã‚’æŠ½å‡º
                        const cleanText = text.replace(/\n/g, ' ').replace(/\s+/g, ' ');
                        const match = cleanText.match(/^(.+?)\s+.*ã®ä»•äº‹ã®ä¾é ¼$/);
                        if (match && match[1]) {
                            return match[1].trim();
                        }
                        const splitResult = cleanText.split('ã®ä»•äº‹ã®ä¾é ¼');
                        if (splitResult && splitResult[0]) {
                            return splitResult[0].trim();
                        }
                    }
                }
                return '';
            }).catch(() => '');

            if (mainH1 && mainH1.length > 5 && !mainH1.includes('ã‚¯ãƒ©ã‚¦ãƒ‰ã‚½ãƒ¼ã‚·ãƒ³ã‚°')) {
                jobDetail.title = mainH1;
                console.log(`âœ… ã‚¿ã‚¤ãƒˆãƒ«: ${jobDetail.title}`);
                titleFound = true;
            }

            if (!titleFound) {
                // ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆã®æœ€å¾Œã®è¦ç´ ã‹ã‚‰å–å¾—ã‚’è©¦è¡Œ
                const breadcrumbTitle = await page.$eval('li:last-child generic', (el: Element) => {
                    return el.textContent?.trim() || '';
                }).catch(() => '');

                if (breadcrumbTitle && breadcrumbTitle.length > 10 && !breadcrumbTitle.includes('ã‚¯ãƒ©ã‚¦ãƒ‰ã‚½ãƒ¼ã‚·ãƒ³ã‚°')) {
                    jobDetail.title = breadcrumbTitle;
                    console.log(`âœ… ã‚¿ã‚¤ãƒˆãƒ« (ãƒ‘ãƒ³ããš): ${jobDetail.title}`);
                    titleFound = true;
                }
            }

            if (!titleFound) {
                console.log('âš ï¸ ã‚¿ã‚¤ãƒˆãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                // ãƒ‡ãƒãƒƒã‚°ç”¨
                const allHeadings = await page.$$eval('h1, h2', (elements) =>
                    elements.map(el => el.textContent?.trim()).filter(t => t && t.length > 10)
                );
                console.log('è¦‹ã¤ã‹ã£ãŸheadingè¦ç´ :', allHeadings.slice(0, 3));
            }
        } catch (error) {
            console.error('ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }

        // äºˆç®—ã®å–å¾—
        try {
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰äºˆç®—æƒ…å ±ã‚’æŠ½å‡º
            const budgetFromTable = await page.$eval('table', (table: Element) => {
                const rows = Array.from(table.querySelectorAll('tr'));
                for (const row of rows) {
                    const cells = Array.from(row.querySelectorAll('td'));
                    if (cells.length >= 2) {
                        const secondCell = cells[1];
                        const text = secondCell?.textContent?.trim() || '';
                        if (text.includes('å††') && (text.includes('ã€œ') || text.includes('-') || text.includes('ä»¥ä¸Š'))) {
                            return text;
                        }
                    }
                }
                return '';
            });

            if (budgetFromTable) {
                jobDetail.budget = budgetFromTable;
                console.log(`âœ… äºˆç®—: ${jobDetail.budget}`);
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å††ã‚’å«ã‚€ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¢ã™
                const budgetText = await page.evaluate(() => {
                    const walker = document.createTreeWalker(
                        document.body,
                        NodeFilter.SHOW_TEXT
                    );

                    let node;
                    while (node = walker.nextNode()) {
                        const text = node.textContent?.trim() || '';
                        if (text.includes('å††') && text.match(/[\d,]+å††/)) {
                            return text;
                        }
                    }
                    return '';
                });

                if (budgetText) {
                    jobDetail.budget = budgetText;
                    console.log(`âœ… äºˆç®— (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯): ${jobDetail.budget}`);
                } else {
                    console.log('âš ï¸ äºˆç®—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }
        } catch (error) {
            console.error('äºˆç®—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }

        // è©³ç´°èª¬æ˜ã®å–å¾—
        try {
            // "ä»•äº‹ã®è©³ç´°"ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è©³ç´°èª¬æ˜ã‚’æŠ½å‡º
            const detailFromTable = await page.evaluate(() => {
                // "ä»•äº‹ã®è©³ç´°"ã¨ã„ã†ãƒ˜ãƒƒãƒ€ãƒ¼ã®å¾Œã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¢ã™
                const headings = Array.from(document.querySelectorAll('h2'));
                const detailHeading = headings.find(h => h.textContent?.includes('ä»•äº‹ã®è©³ç´°'));

                if (detailHeading) {
                    // æ¬¡ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ã‚’æ¢ã™
                    let nextElement = detailHeading.nextElementSibling;
                    while (nextElement) {
                        if (nextElement.tagName === 'TABLE') {
                            const rows = Array.from(nextElement.querySelectorAll('tr'));
                            for (const row of rows) {
                                const cells = Array.from(row.querySelectorAll('td'));
                                if (cells.length >= 1) {
                                    const cellText = cells[0]?.textContent?.trim() || '';
                                    if (cellText.length > 100 && (cellText.includes('æ¦‚è¦') || cellText.includes('æ¥­å‹™') || cellText.includes('å¿…è¦'))) {
                                        return cellText;
                                    }
                                }
                            }
                        }
                        nextElement = nextElement.nextElementSibling;
                    }
                }
                return '';
            });

            if (detailFromTable) {
                jobDetail.detailedDescription = detailFromTable;
                console.log(`âœ… è©³ç´°èª¬æ˜: ${jobDetail.detailedDescription.substring(0, 100)}...`);
            } else {
                console.log('âš ï¸ è©³ç´°èª¬æ˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        } catch (error) {
            console.error('è©³ç´°èª¬æ˜å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        }

        return jobDetail;

    } catch (error) {
        console.error(`âŒ ã‚¨ãƒ©ãƒ¼ (jobId: ${jobId}):`, error);
        return null;
    } finally {
        await page.close();
    }
}

async function main() {
    console.log('ğŸš€ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹è©³ç´°ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆ5ä»¶ï¼‰ã‚’é–‹å§‹ã—ã¾ã™...');

    // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¸ãƒ§ãƒ–IDï¼ˆæœ€è¿‘ã®ã‚‚ã®ã‹ã‚‰5ä»¶ï¼‰
    const testJobIds: string[] = [
        '12130347',
        '12132217',
        '12135465',
        '12041204',
        '12056088'
    ];

    const browser = await puppeteer.launch({
        headless: false, // ãƒ‡ãƒãƒƒã‚°ã®ãŸã‚è¡¨ç¤º
        slowMo: 1000,    // å‹•ä½œã‚’é…ãã—ã¦ãƒ‡ãƒãƒƒã‚°
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-web-security',
            '--user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        ]
    });

    const results: JobDetail[] = [];

    for (let i = 0; i < testJobIds.length; i++) {
        const jobId = testJobIds[i]!;
        console.log(`\nğŸ“‹ ${i + 1}/${testJobIds.length}: ${jobId} ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­...`);

        const jobDetail = await scrapeJobDetails(browser, jobId, 'development');
        if (jobDetail) {
            results.push(jobDetail);
            console.log(`âœ… æˆåŠŸ: ${jobDetail.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜'}`);
        } else {
            console.log(`âŒ å¤±æ•—: ${jobId}`);
        }

        // é–“éš”ã‚’é–‹ã‘ã‚‹
        await new Promise(resolve => setTimeout(resolve, 3000));
    }

    await browser.close();

    // çµæœã‚’ä¿å­˜
    const outputDir = path.join(process.cwd(), 'output');
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `test-scraping-results-${timestamp}.json`;
    const filepath = path.join(outputDir, filename);

    fs.writeFileSync(filepath, JSON.stringify(results, null, 2), 'utf8');

    console.log(`\nğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†ï¼`);
    console.log(`ğŸ“ çµæœä¿å­˜å…ˆ: ${filepath}`);
    console.log(`ğŸ“ˆ æˆåŠŸ: ${results.length}/${testJobIds.length}ä»¶`);

    // çµæœã®ã‚µãƒãƒªãƒ¼è¡¨ç¤º
    results.forEach((job, i) => {
        console.log(`\n[${i + 1}] ID: ${job.jobId}`);
        console.log(`    ã‚¿ã‚¤ãƒˆãƒ«: ${job.title || 'æœªå–å¾—'}`);
        console.log(`    äºˆç®—: ${job.budget || 'æœªå–å¾—'}`);
        console.log(`    èª¬æ˜: ${job.detailedDescription ? job.detailedDescription.substring(0, 50) + '...' : 'æœªå–å¾—'}`);
    });
}

if (require.main === module) {
    main().catch(console.error);
}
</file>

<file path="src/analysis/unified-analysis.ts">
import * as fs from 'fs';
import * as path from 'path';

// çµ±åˆåˆ†æå®Ÿè¡Œ
async function main() {
  console.log('ğŸš€ ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ï¼†ãƒ©ãƒ³ã‚µãƒ¼ã‚ºçµ±åˆåˆ†æé–‹å§‹');
  
  const outputDir = path.join(process.cwd(), 'output');
  const analysis: any = {
    timestamp: new Date().toISOString(),
    summary: {},
    platformComparison: {},
    insights: []
  };
  
  // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  const cwFiles = ['details-ec.json', 'details-web_products.json', 'details-software_development.json'];
  let cwJobs = 0;
  
  for (const file of cwFiles) {
    const filepath = path.join(outputDir, file);
    if (fs.existsSync(filepath)) {
      const data = JSON.parse(fs.readFileSync(filepath, 'utf-8'));
      if (Array.isArray(data)) {
        cwJobs += data.length;
        console.log(`ğŸ“Š ${file}: ${data.length}ä»¶`);
      }
    }
  }
  
  // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  const lancersFile = path.join(outputDir, 'lancers-all-jobs.json');
  let lancersJobs = 0;
  if (fs.existsSync(lancersFile)) {
    const data = JSON.parse(fs.readFileSync(lancersFile, 'utf-8'));
    if (Array.isArray(data)) {
      lancersJobs = data.length;
      console.log(`ğŸ“Š ãƒ©ãƒ³ã‚µãƒ¼ã‚º: ${data.length}ä»¶`);
    }
  }
  
  // åˆ†æçµæœ
  analysis.summary = {
    crowdworksJobs: cwJobs,
    lancersJobs: lancersJobs,
    totalJobs: cwJobs + lancersJobs,
    analyzedAt: new Date().toLocaleString('ja-JP')
  };
  
  analysis.insights = [
    `ç·æ¡ˆä»¶æ•°: ${cwJobs + lancersJobs}ä»¶`,
    `ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹: ${cwJobs}ä»¶`,
    `ãƒ©ãƒ³ã‚µãƒ¼ã‚º: ${lancersJobs}ä»¶`,
    'ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã®ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œ',
    'ä¸¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®æ¡ˆä»¶å–å¾—ã«æˆåŠŸ'
  ];
  
  // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  const report = `# çµ±åˆæ¡ˆä»¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“Š æ¦‚è¦
- **ç·æ¡ˆä»¶æ•°**: ${cwJobs + lancersJobs}ä»¶
- **ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹**: ${cwJobs}ä»¶
- **ãƒ©ãƒ³ã‚µãƒ¼ã‚º**: ${lancersJobs}ä»¶
- **åˆ†ææ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}

## âœ… å®Ÿè£…å®Œäº†äº‹é …
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¿®æ­£å®Œäº†
- ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£…å®Œäº†
- ä¸¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã®çµ±åˆãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ

## ğŸ”§ æŠ€è¡“çš„æˆæœ
- MCPçµŒç”±ã§ã®DOMè¦ç´ ç¢ºèªã¨ä¿®æ­£
- å‹å®‰å…¨ãªTypeScriptå®Ÿè£…
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
- æ–°ã—ã„DOMæ§‹é€ ã¸ã®å¯¾å¿œ

---
*${new Date().toLocaleString('ja-JP')} ç”Ÿæˆ*`;
  
  // ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
  const reportPath = path.join(outputDir, `unified-analysis-${new Date().toISOString().split('T')[0]}.md`);
  fs.writeFileSync(reportPath, report, 'utf-8');
  
  console.log(`âœ… çµ±åˆåˆ†æå®Œäº†! ãƒ¬ãƒãƒ¼ãƒˆ: ${reportPath}`);
  console.log('ğŸ“Š åˆ†æçµæœ:', analysis.summary);
}

if (require.main === module) {
  main();
}
</file>

<file path="src/services/AppliedJobsService.ts">
import { Page } from 'playwright';
import { CrowdWorksCredentials, CrowdWorksLoginResult } from '../types';

/**
 * å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶æƒ…å ±
 */
export interface AppliedJob {
    jobId: string;
    title: string;
    url: string;
    applicationDate: string;
    status: string;
}

/**
 * å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶å–å¾—ã‚µãƒ¼ãƒ“ã‚¹
 */
export class AppliedJobsService {
    private page: Page;
    private credentials: CrowdWorksCredentials;

    constructor(page: Page, credentials: CrowdWorksCredentials) {
        this.page = page;
        this.credentials = credentials;
    }

    /**
     * CrowdWorksã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹
     */
    async login(): Promise<CrowdWorksLoginResult> {
        const startTime = Date.now();

        try {
            console.log('ğŸ”‘ CrowdWorksã«ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            await this.page.goto('https://crowdworks.jp/login', {
                waitUntil: 'networkidle',
                timeout: 30000
            });

            // ã™ã§ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
            const isAlreadyLoggedIn = await this.page.evaluate(() => {
                return !document.querySelector('textbox[name="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹"]') &&
                    !document.querySelector('input[type="email"]') &&
                    !document.title.includes('ãƒ­ã‚°ã‚¤ãƒ³');
            });

            if (isAlreadyLoggedIn) {
                console.log('âœ… æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™');
                return {
                    success: true,
                    isLoggedIn: true,
                    executionTime: Date.now() - startTime
                };
            }

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ãŸã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ï¼‰
            await this.page.getByRole('textbox', { name: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹' }).fill(this.credentials.email);
            await this.page.getByRole('textbox', { name: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰' }).fill(this.credentials.password);

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            await this.page.getByRole('button', { name: 'ãƒ­ã‚°ã‚¤ãƒ³', exact: true }).click();

            // ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’å¾…æ©Ÿ
            await this.page.waitForURL(url => !url.toString().includes('/login'), { timeout: 15000 });

            console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ã«æˆåŠŸã—ã¾ã—ãŸ');

            return {
                success: true,
                isLoggedIn: true,
                executionTime: Date.now() - startTime
            };

        } catch (error) {
            console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            return {
                success: false,
                isLoggedIn: false,
                error: error instanceof Error ? error.message : 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ',
                executionTime: Date.now() - startTime
            };
        }
    }

    /**
     * å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—ã™ã‚‹
     */
    async getAppliedJobs(): Promise<AppliedJob[]> {
        try {
            console.log('ğŸ“‹ å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã‚’å–å¾—ä¸­...');

            // å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            await this.page.goto('https://crowdworks.jp/e/proposals?ref=mypage_joboffers_all', {
                waitUntil: 'networkidle',
                timeout: 30000
            });

            // å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã‚’å–å¾—
            const appliedJobs = await this.page.evaluate(() => {
                const jobs: AppliedJob[] = [];

                // å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã®ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ç‰¹å®šã™ã‚‹ï¼ˆå®Ÿéš›ã®HTMLã«åŸºã¥ã„ã¦èª¿æ•´ï¼‰
                const jobElements = document.querySelectorAll('.proposal-item, .job-item, [data-job-id]');

                jobElements.forEach(element => {
                    try {
                        // jobIdã‚’URLã‹ã‚‰æŠ½å‡º
                        const linkElement = element.querySelector('a[href*="/public/jobs/"]') as HTMLAnchorElement;
                        if (!linkElement) return;

                        const url = linkElement.href;
                        const jobIdMatch = url.match(/\/jobs\/(\d+)/);
                        if (!jobIdMatch) return;

                        const jobId = jobIdMatch[1];

                        // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
                        const titleElement = element.querySelector('.job-title, .proposal-title, h3, h4');
                        const title = titleElement?.textContent?.trim() || '';

                        // å¿œå‹Ÿæ—¥ã‚’å–å¾—ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
                        const dateElement = element.querySelector('.application-date, .proposal-date, .date');
                        const applicationDate = dateElement?.textContent?.trim() || '';

                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—ï¼ˆå¯èƒ½ã§ã‚ã‚Œã°ï¼‰
                        const statusElement = element.querySelector('.status, .proposal-status');
                        const status = statusElement?.textContent?.trim() || '';

                        if (jobId && title) {
                            jobs.push({
                                jobId,
                                title,
                                url,
                                applicationDate,
                                status
                            });
                        }
                    } catch (error) {
                        console.warn('æ¡ˆä»¶ã®è§£æã§ã‚¨ãƒ©ãƒ¼:', error);
                    }
                });

                return jobs;
            });

            console.log(`âœ… å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã‚’${appliedJobs.length}ä»¶å–å¾—ã—ã¾ã—ãŸ`);

            // ãƒ­ã‚°å‡ºåŠ›
            if (appliedJobs.length > 0) {
                console.log('ğŸ“‹ å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ä¸€è¦§:');
                appliedJobs.slice(0, 5).forEach((job, index) => {
                    console.log(`  ${index + 1}. ${job.title} (ID: ${job.jobId})`);
                });
                if (appliedJobs.length > 5) {
                    console.log(`  ... ä»–${appliedJobs.length - 5}ä»¶`);
                }
            }

            return appliedJobs;

        } catch (error) {
            console.error('âŒ å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            return [];
        }
    }

    /**
     * å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã®JobIDã‚»ãƒƒãƒˆã‚’å–å¾—ã™ã‚‹
     */
    async getAppliedJobIds(): Promise<Set<string>> {
        const appliedJobs = await this.getAppliedJobs();
        return new Set(appliedJobs.map(job => job.jobId));
    }
}
</file>

<file path="app.ts">
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { CrowdWorksSearcherStack } from './src/infrastructure/crowdworks-searcher-stack';

const app = new cdk.App();

// ç’°å¢ƒè¨­å®š
const account = process.env['CDK_DEFAULT_ACCOUNT'];
const region = process.env['CDK_DEFAULT_REGION'] || process.env['AWS_REGION'] || 'ap-northeast-1';
const stage = app.node.tryGetContext('stage') || process.env['STAGE'] || 'dev';

const env: cdk.Environment = account ? { account, region } : { region };

// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã®ã‚¹ã‚¿ãƒƒã‚¯è¨­å®š
const getStackConfig = (stage: string) => {
    const baseConfig = {
        env,
        description: `CrowdWorks Auto Job Searcher System - ${stage.toUpperCase()}`,
        stage,
    };

    switch (stage) {
        case 'production':
            return {
                ...baseConfig,
                terminationProtection: true, // æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ä¿è­·ã‚’æœ‰åŠ¹
            };
        case 'staging':
            return {
                ...baseConfig,
                terminationProtection: false,
            };
        default: // dev, test, etc.
            return {
                ...baseConfig,
                terminationProtection: false,
            };
    }
};

// ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆ
const stackConfig = getStackConfig(stage);
new CrowdWorksSearcherStack(app, `CrowdWorksSearcherStack-${stage}`, stackConfig);

// ã‚¿ã‚°ã‚’å…¨ãƒªã‚½ãƒ¼ã‚¹ã«é©ç”¨
cdk.Tags.of(app).add('Application', 'CrowdWorksSearcher');
cdk.Tags.of(app).add('Stage', stage);
cdk.Tags.of(app).add('ManagedBy', 'CDK');

console.log(`ğŸš€ Deploying CrowdWorks Searcher to ${stage.toUpperCase()} environment`);
console.log(`   Region: ${region}`);
console.log(`   Account: ${account || 'default'}`);
</file>

<file path="scripts/analyze-details.ts">
require('dotenv').config();

import { readFileSync, writeFileSync, existsSync } from 'fs';
import { OpenAI } from 'openai';
import * as path from 'path';

// å‹å®šç¾©
interface CrowdWorksJobDetail {
    jobId: string;
    title: string;
    detailedDescription: string;
    [key: string]: any;
}

interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    é›£æ˜“åº¦: string;
    ç°¡æ˜“è¨­è¨ˆ: string;
    gpt_summary: string;
}

// .envã‹ã‚‰APIã‚­ãƒ¼å–å¾—
const apiKey = process.env['OPENAI_API_KEY'];
if (!apiKey) {
    console.error('âŒ OPENAI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    process.exit(1);
}

const openai = new OpenAI({ apiKey });

// å¼•æ•°: å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«, å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
const [, , inputFile, outputFile] = process.argv;
if (!inputFile || !outputFile) {
    console.error('Usage: ts-node scripts/analyze-details.ts <input.json> <output.json>');
    process.exit(1);
}

const inputPath = path.resolve(inputFile);
const outputPath = path.resolve(outputFile);

const details: CrowdWorksJobDetail[] = JSON.parse(readFileSync(inputPath, 'utf8'));

// æ—¢å­˜ã®åˆ†ææ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦èª­ã¿è¾¼ã¿
let existingAnalysis: AnalysisResult[] = [];
if (existsSync(outputPath)) {
    try {
        existingAnalysis = JSON.parse(readFileSync(outputPath, 'utf8'));
        console.log(`ğŸ“‹ æ—¢å­˜ã®åˆ†ææ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿: ${existingAnalysis.length}ä»¶`);
    } catch (error) {
        console.log(`âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        existingAnalysis = [];
    }
} else {
    console.log(`ğŸ“ æ–°è¦åˆ†æãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ: ${outputPath}`);
}

// æ—¢å­˜ã®åˆ†ææ¸ˆã¿jobIdã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
const existingJobIds = new Set(existingAnalysis.map(analysis => analysis.jobId));

// æ–°è¦åˆ†æãŒå¿…è¦ãªæ¡ˆä»¶ã®ã¿ã‚’æŠ½å‡º
const newDetails = details.filter(detail => !existingJobIds.has(detail.jobId));
const cacheHitCount = details.length - newDetails.length;

console.log(`ğŸ“Š ã‚­ãƒ£ãƒƒã‚·ãƒ¥çŠ¶æ³:`);
console.log(`   å…¨æ¡ˆä»¶æ•°: ${details.length}ä»¶`);
console.log(`   ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ: ${cacheHitCount}ä»¶`);
console.log(`   æ–°è¦åˆ†æå¯¾è±¡: ${newDetails.length}ä»¶`);

if (newDetails.length === 0) {
    console.log(`ğŸ‰ å…¨æ¡ˆä»¶ãŒæ—¢ã«åˆ†ææ¸ˆã¿ã§ã™ã€‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚`);
    process.exit(0);
}

// ä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡ã‚¯ãƒ©ã‚¹
class ConcurrencyLimiter {
    private runningCount = 0;
    private queue: (() => Promise<void>)[] = [];

    constructor(private maxConcurrency: number) { }

    async execute<T>(task: () => Promise<T>): Promise<T> {
        return new Promise<T>((resolve, reject) => {
            const wrappedTask = async () => {
                try {
                    this.runningCount++;
                    const result = await task();
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    this.runningCount--;
                    this.processQueue();
                }
            };

            if (this.runningCount < this.maxConcurrency) {
                wrappedTask();
            } else {
                this.queue.push(wrappedTask);
            }
        });
    }

    private processQueue() {
        if (this.queue.length > 0 && this.runningCount < this.maxConcurrency) {
            const nextTask = this.queue.shift();
            if (nextTask) {
                nextTask();
            }
        }
    }
}

const limiter = new ConcurrencyLimiter(5); // æœ€å¤§5ä»¶ä¸¦åˆ—

async function analyzeDetail(detail: CrowdWorksJobDetail): Promise<AnalysisResult> {
    const prompt = `ä»¥ä¸‹ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®æ¡ˆä»¶è©³ç´°ã§ã™ã€‚å†…å®¹ã‚’èª­ã‚“ã§ã€
1. ã“ã®ä»•äº‹ã«ã‹ã‹ã‚‹ãŠãŠã‚ˆãã®å·¥æ•°ï¼ˆä½•æ™‚é–“ãã‚‰ã„ã‹ï¼‰
2. æƒ³å®šã•ã‚Œã‚‹æ™‚çµ¦ï¼ˆæ—¥æœ¬å††ãƒ»å›ºå®šå€¤ã§1ã¤ã®æ•°å€¤ã®ã¿ï¼‰
3. æ¡ˆä»¶ã®é›£æ˜“åº¦ï¼ˆç°¡å˜/æ™®é€š/é›£ã—ã„ ã®ã„ãšã‚Œã‹ï¼‰
4. ç°¡æ˜“çš„ãªè¨­è¨ˆãƒ»ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆã©ã®ã‚ˆã†ãªæ‰‹é †ãƒ»æŠ€è¡“ã§é€²ã‚ã‚‹ã‹ï¼‰
5. ãã®æ ¹æ‹ ã‚„æ³¨æ„ç‚¹
ã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªå·¥æ•°è¦‹ç©ã‚‚ã‚Šã®ãƒã‚¤ãƒ³ãƒˆã€‘
- è¨˜è¼‰ã•ã‚ŒãŸä½œæ¥­å†…å®¹ã ã‘ã§ãªãã€ä»¥ä¸‹ã®å‰ä½œæ¥­ãƒ»ä»˜å¸¯ä½œæ¥­ã‚‚å¿…ãšå«ã‚ã¦è¨ˆç®—ã—ã¦ãã ã•ã„ï¼š
  * è¦ä»¶å®šç¾©ãƒ»è¦ä»¶æ•´ç†ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®èªè­˜åˆã‚ã›ï¼‰
  * åˆå›æ‰“ã¡åˆã‚ã›ãƒ»ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆ1-3å›ç¨‹åº¦ï¼‰
  * ææ¡ˆæ›¸ãƒ»ä¼ç”»æ›¸ãƒ»ä»•æ§˜æ›¸ã®ä½œæˆ
  * ä½œæ¥­ä¸­ã®é€²æ—å ±å‘Šãƒ»ä¸­é–“ç¢ºèª
  * ä¿®æ­£ãƒ»èª¿æ•´ä½œæ¥­ï¼ˆé€šå¸¸2-3å›ã¯ç™ºç”Ÿï¼‰
  * ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
  * ç´å“ä½œæ¥­ãƒ»èª¬æ˜ãƒ»å¼•ãç¶™ã
  * ç´å“å¾Œã®è»½å¾®ãªã‚µãƒãƒ¼ãƒˆãƒ»è³ªå•å¯¾å¿œ

ã€é‡è¦ãªé›£æ˜“åº¦åˆ¤å®šã®ãƒã‚¤ãƒ³ãƒˆã€‘
- **ç°¡å˜**: åˆå¿ƒè€…ãƒ»æœªçµŒé¨“è€…ã§ã‚‚å¯¾å¿œå¯èƒ½ã€åŸºæœ¬çš„ãªã‚¹ã‚­ãƒ«ã§ååˆ†ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæ¥­ä¸­å¿ƒ
- **æ™®é€š**: ä¸€èˆ¬çš„ãªã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦ã€å¤šå°‘ã®å­¦ç¿’ã‚„èª¿æŸ»ãŒå¿…è¦ã€æ¨™æº–çš„ãªæ¥­å‹™
- **é›£ã—ã„**: é«˜åº¦ãªå°‚é–€çŸ¥è­˜ãƒ»æŠ€è¡“ãŒå¿…è¦ã€è±Šå¯ŒãªçµŒé¨“ãŒå‰æã€è¤‡é›‘ãªè¦ä»¶ã‚„æ–°æŠ€è¡“

ã€é‡è¦ãªæ³¨æ„ç‚¹ã€‘
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®æ¡ˆä»¶ã¯ç‰çŸ³æ··äº¤ã§ã€ã‚¿ã‚¤ãƒˆãƒ«ã§æŒ‡å®šã—ãŸä¾¡æ ¼ãŒæ¡ˆä»¶è©³ç´°ã§ã¯å˜˜ã ã¨æ›¸ã‹ã‚Œã¦ã„ãŸã‚Šã—ã¾ã™
- è©³ç´°èª¬æ˜ã‚’æ³¨æ„æ·±ãèª­ã¿ã€å®Ÿéš›ã®ä½œæ¥­å†…å®¹ã¨å ±é…¬ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã¦ãã ã•ã„
- ã‚¿ã‚¤ãƒˆãƒ«ã®é‡‘é¡ã«æƒ‘ã‚ã•ã‚Œãšã€è©³ç´°ã«æ›¸ã‹ã‚ŒãŸå®Ÿéš›ã®æ¡ä»¶ã‹ã‚‰ç¢ºã‹ã‚‰ã—ã„æƒ³å®šæ™‚çµ¦ã‚’ç®—å‡ºã—ã¦ãã ã•ã„
- "ã€‡ã€‡å††ã‚¹ã‚¿ãƒ¼ãƒˆ"ã€Œèƒ½åŠ›ã«å¿œã˜ã¦ã€ãªã©ã®æ›–æ˜§ãªè¡¨ç¾ã«ã‚‚æ³¨æ„ã—ã¦ãã ã•ã„
- åˆå›ã¯ä½ä¾¡æ ¼ã§ã€Œç¶™ç¶šã§å˜ä¾¡ã‚¢ãƒƒãƒ—ã€ã¨ã„ã†æ¡ˆä»¶ã¯ã€åˆå›ä¾¡æ ¼ã‚’åŸºæº–ã«è¨ˆç®—ã—ã¦ãã ã•ã„
- **æ™‚çµ¦ã¯å¿…ãš1ã¤ã®å…·ä½“çš„ãªæ•°å€¤ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š2500å††ï¼‰ã€‚ç¯„å›²ã‚„æ›–æ˜§ãªè¡¨ç¾ã¯ç¦æ­¢ã§ã™**
- **é›£æ˜“åº¦ã¯å¿…ãšã€Œç°¡å˜ã€ã€Œæ™®é€šã€ã€Œé›£ã—ã„ã€ã®ã„ãšã‚Œã‹1ã¤ã§å›ç­”ã—ã¦ãã ã•ã„**
- **å®Ÿéš›ã®ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ä½œæ¥­ã®ç¾å®Ÿã‚’åæ˜ ã—ãŸã€ååˆ†ãªå·¥æ•°ã‚’è¦‹ç©ã‚‚ã£ã¦ãã ã•ã„**

---
ã‚¿ã‚¤ãƒˆãƒ«: ${detail.title}

è©³ç´°èª¬æ˜: ${detail.detailedDescription}
---

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
å·¥æ•°: <ä¾‹: 8æ™‚é–“>
æ™‚çµ¦: <ä¾‹: 2500å††>
é›£æ˜“åº¦: <ä¾‹: æ™®é€š>
è¨­è¨ˆ: <ä¾‹: React+TypeScriptã§SPAæ§‹ç¯‰ã€APIé€£æºã€ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ>
è¦ç´„: <æ ¹æ‹ ã‚„æ³¨æ„ç‚¹ã‚’1-2æ–‡ã§>`;

    return limiter.execute(async () => {
        const res = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'ã‚ãªãŸã¯æ—¥æœ¬ã®ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹å¸‚å ´ã®å°‚é–€å®¶ã§ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã®ç¾å®Ÿçš„ãªå·¥æ•°è¦‹ç©ã‚‚ã‚Šã¨æ™‚çµ¦æ¨å®šã®å°‚é–€å®¶ã§ã™ã€‚å®Ÿéš›ã®ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ä½œæ¥­ã§ã¯è¦ä»¶å®šç¾©ã‚„æ‰“ã¡åˆã‚ã›ã€ä¿®æ­£ä½œæ¥­ãªã©ã‚‚å¿…è¦ã§ã€è¨˜è¼‰ã•ã‚ŒãŸä½œæ¥­ä»¥å¤–ã«ã‚‚å¤šãã®ä»˜å¸¯ä½œæ¥­ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’ç†è§£ã—ã¦ã„ã¾ã™ã€‚' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 512,
            temperature: 0.2,
        });

        const text = res.choices[0]?.message?.content || '';
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ãƒ¼ã‚¹
        const å·¥æ•° = text.match(/å·¥æ•°[:ï¼š]\s*(.+)/)?.[1]?.trim() || '';
        const æ™‚çµ¦ = text.match(/æ™‚çµ¦[:ï¼š]\s*(.+)/)?.[1]?.trim() || '';
        const é›£æ˜“åº¦ = text.match(/é›£æ˜“åº¦[:ï¼š]\s*(.+)/)?.[1]?.trim() || '';
        const è¨­è¨ˆ = text.match(/è¨­è¨ˆ[:ï¼š]\s*(.+)/)?.[1]?.trim() || '';
        const è¦ç´„ = text.match(/è¦ç´„[:ï¼š]\s*([\s\S]*)/)?.[1]?.trim() || text;

        return {
            jobId: detail.jobId,
            title: detail.title,
            å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: å·¥æ•°,
            æƒ³å®šæ™‚çµ¦: æ™‚çµ¦,
            é›£æ˜“åº¦: é›£æ˜“åº¦,
            ç°¡æ˜“è¨­è¨ˆ: è¨­è¨ˆ,
            gpt_summary: è¦ç´„,
        };
    });
}

(async () => {
    console.log(`ğŸš€ ä¸¦åˆ—åˆ†æé–‹å§‹: ${newDetails.length}ä»¶ï¼ˆæœ€å¤§5ä»¶ä¸¦åˆ—ï¼‰`);
    const results: AnalysisResult[] = [];
    let completed = 0;

    // å…¨ã¦ã®æ¡ˆä»¶ã‚’ä¸¦åˆ—ã§å‡¦ç†é–‹å§‹
    const promises = newDetails.map(async (detail, index) => {
        try {
            const result = await analyzeDetail(detail);
            results.push(result);
            completed++;
            console.log(`âœ… [${completed}/${newDetails.length}] ${detail.title.substring(0, 50)}...`);

            // å®šæœŸçš„ã«ä¸­é–“çµæœã‚’ä¿å­˜
            if (completed % 5 === 0 || completed === newDetails.length) {
                // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
                const allResults = [...existingAnalysis, ...results];
                const sortedResults = allResults.sort((a, b) => a.jobId.localeCompare(b.jobId));
                writeFileSync(outputPath, JSON.stringify(sortedResults, null, 2), 'utf8');
                console.log(`ğŸ’¾ ä¸­é–“ä¿å­˜: æ–°è¦${completed}ä»¶ + æ—¢å­˜${existingAnalysis.length}ä»¶ = è¨ˆ${sortedResults.length}ä»¶`);
            }

            return { success: true, result, index };
        } catch (e) {
            console.error(`âŒ [${index + 1}/${newDetails.length}] ${detail.title.substring(0, 50)}... - ã‚¨ãƒ©ãƒ¼:`, e);
            return { success: false, error: e, index };
        }
    });

    // å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
    const settledResults = await Promise.allSettled(promises);

    // æœ€çµ‚çµæœã®çµ±è¨ˆ
    const successful = settledResults.filter(r => r.status === 'fulfilled' && r.value.success).length;
    const failed = settledResults.length - successful;

    console.log(`\nğŸ¯ ä¸¦åˆ—åˆ†æå®Œäº†:`)
    console.log(`âœ… æ–°è¦åˆ†ææˆåŠŸ: ${successful}ä»¶`);
    console.log(`âŒ æ–°è¦åˆ†æå¤±æ•—: ${failed}ä»¶`);
    console.log(`ğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å†åˆ©ç”¨: ${cacheHitCount}ä»¶`);
    console.log(`ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: ${outputPath}`);

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨æ–°è¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ã—ã¦æœ€çµ‚ä¿å­˜
    const allResults = [...existingAnalysis, ...results];
    const finalResults = allResults.sort((a, b) => a.jobId.localeCompare(b.jobId));
    writeFileSync(outputPath, JSON.stringify(finalResults, null, 2), 'utf8');
    console.log(`ğŸ’¾ æœ€çµ‚ä¿å­˜å®Œäº†: æ–°è¦${results.length}ä»¶ + æ—¢å­˜${existingAnalysis.length}ä»¶ = è¨ˆ${finalResults.length}ä»¶`);
})();
</file>

<file path="src/utils/index.ts">
// Utility functions exports
// TODO: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’å®Ÿè£…å¾Œã€ã“ã“ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

export {};
</file>

<file path=".gitignore">
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
yarn.lock

# Build outputs
dist/
build/
*.tsbuildinfo

# TypeScript
*.d.ts
*.d.ts.map
*.js.map

# AWS CDK
cdk.out/
cdk.context.json

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
logs/
*.log

# Coverage
coverage/
.nyc_output/

# Jest
jest_0/

# Temporary files
tmp/
temp/

# Docker
.dockerignore

# Husky
.husky/_/

# Output files (scraped data, analysis results, reports)
output/
*.json
*.md
!README.md
!package.json
!tsconfig.json
</file>

<file path="env.example">
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ç’°å¢ƒå¤‰æ•°
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .env ã«ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿéš›ã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„

# CrowdWorksèªè¨¼æƒ…å ±ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
CROWDWORKS_EMAIL=your-crowdworks-email@example.com
CROWDWORKS_PASSWORD=your-crowdworks-password

# Upwork APIèªè¨¼æƒ…å ±ï¼ˆçµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒç”¨ï¼‰
UPWORK_CONSUMER_KEY=your-upwork-consumer-key
UPWORK_CONSUMER_SECRET=your-upwork-consumer-secret
UPWORK_ACCESS_TOKEN=your-upwork-access-token
UPWORK_ACCESS_TOKEN_SECRET=your-upwork-access-token-secret

# OpenAI APIè¨­å®š
OPENAI_API_KEY=your-openai-api-key

# AWSè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
AWS_REGION=ap-northeast-1
AWS_PROFILE=default

# ãƒ‡ãƒãƒƒã‚°è¨­å®š
NODE_ENV=development
LOG_LEVEL=debug
DEBUG=1

# Playwrightè¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯é€šå¸¸ã¯ç©ºã¾ãŸã¯æœªè¨­å®šã§OKï¼ˆPlaywrightãŒè‡ªå‹•ã§è¦‹ã¤ã‘ã‚‹ï¼‰
# ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¹ã‚’ä½¿ã„ãŸã„å ´åˆã®ã¿è¨­å®š
PLAYWRIGHT_BROWSERS_PATH=
# ä¾‹ï¼šã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
# PLAYWRIGHT_BROWSERS_PATH=C:\Users\n\AppData\Local\ms-playwright

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„ï¼ˆ0 = ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼‰
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0
</file>

<file path="jest.config.js">
module.exports = {
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒ
    preset: 'ts-jest',
    testEnvironment: 'node',

    // TypeScriptè¨­å®š
    transform: {
        '^.+\\.tsx?$': ['ts-jest', {
            tsconfig: './tsconfig.json'
        }]
    },

    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®è¨­å®š
    moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json'],

    // ãƒ‘ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆtsconfig.jsonã¨åŒæœŸï¼‰
    moduleNameMapper: {
        '^@/(.*)$': '<rootDir>/src/$1',
        '^@/types/(.*)$': '<rootDir>/src/types/$1',
        '^@/services/(.*)$': '<rootDir>/src/services/$1',
        '^@/utils/(.*)$': '<rootDir>/src/utils/$1',
        '^@/infrastructure/(.*)$': '<rootDir>/src/infrastructure/$1'
    },

    // ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
    testMatch: [
        '<rootDir>/src/**/*.test.(ts|tsx)',
        '<rootDir>/src/**/*.spec.(ts|tsx)',
        '<rootDir>/test/**/*.test.(ts|tsx)',
        '<rootDir>/test/**/*.spec.(ts|tsx)'
    ],

    // ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®š
    collectCoverage: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡åŠ¹ï¼ˆnpm run test:coverageã§æœ‰åŠ¹ï¼‰
    collectCoverageFrom: [
        'src/**/*.{ts,tsx}',
        '!src/**/*.d.ts',
        '!src/**/*.test.{ts,tsx}',
        '!src/**/*.spec.{ts,tsx}',
        '!src/test/**/*',
        '!src/types/**/*', // å‹å®šç¾©ã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ã‹ã‚‰é™¤å¤–
    ],
    coverageDirectory: 'coverage',
    coverageReporters: ['text', 'lcov', 'html'],
    // TODO: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…å¾Œã«ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶ã‚’å¾©æ´»
    // coverageThreshold: {
    //     global: {
    //         branches: 20,   // 75% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         functions: 20,  // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         lines: 20,      // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         statements: 20  // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //     }
    // },

    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
    setupFilesAfterEnv: ['<rootDir>/test/setup.ts'],

    // ãƒ¢ãƒƒã‚¯è¨­å®š
    clearMocks: true,
    resetMocks: true,
    restoreMocks: true,

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    testTimeout: 30000, // 30ç§’ï¼ˆAWS SDKå‘¼ã³å‡ºã—ãªã©æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆã«å¯¾å¿œï¼‰

    // ä¸¦åˆ—å®Ÿè¡Œè¨­å®š
    maxWorkers: '50%', // CPUã‚³ã‚¢æ•°ã®50%ã§ä¸¦åˆ—å®Ÿè¡Œ

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºè¨­å®š
    verbose: true,
    errorOnDeprecated: true,

    // ä¸è¦ãªãƒ­ã‚°ã‚’æŠ‘åˆ¶
    silent: false,

    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰å¾Œã®ãƒ•ãƒƒã‚¯
    globalSetup: undefined,
    globalTeardown: undefined
};
</file>

<file path="scripts/create-unified-report.ts">
import * as fs from 'fs';
import * as path from 'path';

// Jobå‹å®šç¾©
interface Job {
    id: string;
    title: string;
    platform: string;
    url: string;
    budget: {
        amount: number;
        currency: string;
        type: string;
    };
    hourlyRate: number;
    category: string;
    subcategory?: string;
    description: string;
    client?: string;
    clientRating?: number;
    clientOrderCount?: number;
    postedAt?: Date | string;
    deadline?: string;
    tags?: string[];
    workType?: string;
    isUrgent?: boolean;
    isPremium?: boolean;
    industry?: string;
    workRank?: string;
    appliedCount?: number;
    recruitCount?: number;
    scrapedAt: string;
}

// interface AnalyzedJob {
//     jobId: string;
//     title: string;
//     å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
//     æƒ³å®šæ™‚çµ¦: string;
//     é›£æ˜“åº¦: string;
//     gpt_summary: string;
// }

interface ProcessedAnalyzedJob {
    hourlyRate: number;
    workHours: number;
    title: string;
    description: string;
    url: string;
    category: string;
    difficulty: string;
    analysis: string;
}

class UnifiedReportGenerator {
    private outputDir: string;

    constructor() {
        this.outputDir = path.join(process.cwd(), 'output');
        if (!fs.existsSync(this.outputDir)) {
            fs.mkdirSync(this.outputDir, { recursive: true });
        }
    }

    // æœ€æ–°ã®ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—


    // æœ€æ–°ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹åˆ†æãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    // private getLatestCrowdWorksFiles(): string[] {
    //     const files = fs.readdirSync(this.outputDir)
    //         .filter(file => file.startsWith('analyzed-') && file.endsWith('.json'))
    //         .map(file => path.join(this.outputDir, file));

    //     return files;
    // }

    /**
     * ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
     */
    private loadJobData(): { lancers: any[], crowdworks: any[] } {
        console.log('ğŸ“š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæœ€æ–°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
        const lancersData: any[] = [];

        // æ—¢å­˜ã®ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ•ã‚¡ã‚¤ãƒ«
        const existingLancersFile = 'output/lancers-details-2025-06-09T17-38-02-401Z.json';
        if (fs.existsSync(existingLancersFile)) {
            const data = JSON.parse(fs.readFileSync(existingLancersFile, 'utf8'));
            lancersData.push(...data);
            console.log(`ğŸ“ æ—¢å­˜ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ${data.length}ä»¶`);
        }

        // GPTåˆ†æçµæœèª­ã¿è¾¼ã¿
        const gptAnalysisData: any[] = [];
        const analysisFiles = [
            'output/analysis-ec.json',
            'output/analysis-web_products.json',
            'output/analysis-software_development.json',
            'output/analysis-development.json'  // æ–°ã—ã„åˆ†æçµæœã®ã¿
        ];

        // GPTåˆ†æçµæœã®ãƒãƒƒãƒ—ã‚’ä½œæˆ
        const gptAnalysisMap = new Map();
        for (const file of analysisFiles) {
            if (fs.existsSync(file)) {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                gptAnalysisData.push(...data);
                data.forEach((analysis: any) => {
                    // jobIdã¾ãŸã¯urlã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
                    if (analysis.jobId) {
                        gptAnalysisMap.set(analysis.jobId, analysis);
                    }
                    if (analysis.url) {
                        gptAnalysisMap.set(analysis.url, analysis);
                    }
                });
                console.log(`ğŸ¤– GPTåˆ†æçµæœèª­ã¿è¾¼ã¿ (${file}): ${data.length}ä»¶`);
            }
        }

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã«GPTåˆ†æçµæœã‚’çµ±åˆ
        const processedLancersData = lancersData.map((job: any) => {
            const gptAnalysis = gptAnalysisMap.get(job.jobId) || gptAnalysisMap.get(job.url);
            return {
                ...job,
                æƒ³å®šæ™‚çµ¦: this.extractHourlyRateFromGptAnalysis(gptAnalysis),
                å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: gptAnalysis?.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š || 'æœªç®—å‡º',
                é›£æ˜“åº¦: gptAnalysis?.é›£æ˜“åº¦ || 'unknown',
                ç°¡æ˜“è¨­è¨ˆ: gptAnalysis?.ç°¡æ˜“è¨­è¨ˆ || 'è¨­è¨ˆæƒ…å ±ãªã—',
                gpt_summary: gptAnalysis?.gpt_summary || ''
            };
        });

        // CrowdWorksãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆæ–°ã—ã„è©³ç´°ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ï¼‰
        const crowdworksData: any[] = [];
        const detailsFiles = [
            'output/details-ec.json',
            'output/details-web_products.json',
            'output/details-software_development.json',
            'output/details-development.json'
        ];

        for (const file of detailsFiles) {
            if (fs.existsSync(file)) {
                const data = JSON.parse(fs.readFileSync(file, 'utf8'));
                // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆè©³ç´°èª¬æ˜ãŒã‚ã‚Šã€GPTåˆ†æçµæœãŒã‚ã‚‹ã‚‚ã®ï¼‰
                const validData = data.filter((job: any) => {
                    const hasDetailedDescription = job.detailedDescription && job.detailedDescription.trim() !== '';
                    const hasGptAnalysis = gptAnalysisMap.has(job.jobId) || gptAnalysisMap.has(job.url);
                    return hasDetailedDescription && hasGptAnalysis;
                });
                
                // æ–°ã—ã„è©³ç´°ãƒ‡ãƒ¼ã‚¿ã«GPTåˆ†æçµæœã‚’çµ±åˆ
                const processedData = validData.map((job: any) => {
                    const gptAnalysis = gptAnalysisMap.get(job.jobId) || gptAnalysisMap.get(job.url);
                    return {
                        ...job,
                        æƒ³å®šæ™‚çµ¦: this.extractHourlyRateFromGptAnalysis(gptAnalysis),
                        å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: gptAnalysis?.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š || 'æœªç®—å‡º',
                        é›£æ˜“åº¦: gptAnalysis?.é›£æ˜“åº¦ || 'unknown',
                        ç°¡æ˜“è¨­è¨ˆ: gptAnalysis?.ç°¡æ˜“è¨­è¨ˆ || 'è¨­è¨ˆæƒ…å ±ãªã—',
                        gpt_summary: gptAnalysis?.gpt_summary || ''
                    };
                });
                crowdworksData.push(...processedData);
                console.log(`ğŸ“ CrowdWorksè©³ç´°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (${file}): ${processedData.length}ä»¶ï¼ˆæœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰`);
            }
        }

        // å¤ã„ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¯èª­ã¿è¾¼ã¾ãªã„ï¼ˆæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨ï¼‰

        console.log(`ğŸ¤– GPTåˆ†ææ¸ˆã¿æ¡ˆä»¶: ${gptAnalysisData.length}ä»¶`);
        console.log(`ğŸ“Š ç·ãƒ‡ãƒ¼ã‚¿: ãƒ©ãƒ³ã‚µãƒ¼ã‚º${processedLancersData.length}ä»¶, ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹${crowdworksData.length}ä»¶`);
        return { lancers: processedLancersData, crowdworks: crowdworksData };
    }

    /**
     * GPTåˆ†æçµæœã®ã¿ã‹ã‚‰æ™‚çµ¦ã‚’å–å¾—ï¼ˆæ¨å®šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯å‰Šé™¤ï¼‰
     */
    private extractHourlyRateFromGptAnalysis(gptAnalysis?: any): number {
        if (!gptAnalysis) {
            console.log(`âŒ GPTåˆ†æçµæœãªã— - æ™‚çµ¦æƒ…å ±å–å¾—ä¸å¯`);
            return 0;
        }

        // GPTåˆ†æçµæœã‹ã‚‰æ™‚çµ¦ã‚’æŠ½å‡º
        if (gptAnalysis.æƒ³å®šæ™‚çµ¦) {
            const gptRate = this.extractRateFromGptAnalysis(gptAnalysis.æƒ³å®šæ™‚çµ¦);
            if (gptRate > 0) {
                console.log(`ğŸ¤– GPTåˆ†æã‹ã‚‰æ™‚çµ¦å–å¾—: ${gptRate}å††/æ™‚`);
                return gptRate;
            }
        }

        // GPTåˆ†æçµæœãŒã‚ã£ã¦ã‚‚æ™‚çµ¦ãŒæŠ½å‡ºã§ããªã„å ´åˆ
        console.log(`âŒ GPTåˆ†æçµæœã‹ã‚‰æ™‚çµ¦æŠ½å‡ºå¤±æ•—`);
        return 0;
    }

    /**
     * GPTåˆ†æçµæœã‹ã‚‰æ™‚çµ¦ã‚’æŠ½å‡º
     */
    private extractRateFromGptAnalysis(gptRate: string): number {
        if (!gptRate) return 0;
        
        // ã€Œ2500å††ã€ã€Œ1500å††/æ™‚ã€ãªã©ã®å½¢å¼ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡º
        const rateMatch = gptRate.match(/([0-9,]+)\s*å††/);
        if (rateMatch && rateMatch[1]) {
            const rate = parseInt(rateMatch[1].replace(/,/g, ''));
            // å¦¥å½“ãªæ™‚çµ¦ç¯„å›²ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (rate >= 500 && rate <= 50000) {
                return rate;
            }
        }
        
        return 0;
    }









    /**
     * äºˆç®—é¡ã‚’æ•°å€¤ã§æŠ½å‡º
     */
    private extractBudgetAmount(budget: string): number {
        if (!budget) return 0;
        
        // ã€Œï½ã€ã‚„ã€Œ-ã€ã§åŒºåˆ‡ã‚‰ã‚ŒãŸç¯„å›²ã®å ´åˆã¯ä¸Šé™å€¤ã‚’å–å¾—
        const rangeMatch = budget.match(/([0-9,]+)\s*å††\s*[~ï½-]\s*([0-9,]+)\s*å††/);
        if (rangeMatch && rangeMatch[1] && rangeMatch[2]) {
            const min = parseInt(rangeMatch[1].replace(/,/g, '')) || 0;
            const max = parseInt(rangeMatch[2].replace(/,/g, '')) || 0;
            return Math.max(min, max); // ä¸Šé™å€¤ã‚’è¿”ã™
        }
        
        // å˜ä¸€ã®é‡‘é¡
        const singleMatch = budget.match(/([0-9,]+)\s*å††/);
        if (singleMatch && singleMatch[1]) {
            return parseInt(singleMatch[1].replace(/,/g, '')) || 0;
        }
        
        return 0;
    }

    // åˆ†ææ¸ˆã¿ã‚¸ãƒ§ãƒ–ã®å‡¦ç†
    // private processAnalyzedJob(job: AnalyzedJob): ProcessedAnalyzedJob {
    //     // æ™‚çµ¦ã®æŠ½å‡ºï¼ˆä¾‹ï¼š"2500å††" â†’ 2500ï¼‰
    //     let hourlyRate = 0;
    //     if (job.æƒ³å®šæ™‚çµ¦) {
    //         const rateMatch = job.æƒ³å®šæ™‚çµ¦.match(/(\d+)/);
    //         if (rateMatch && rateMatch[1]) {
    //             hourlyRate = parseInt(rateMatch[1]);
    //         }
    //     }

    //     // å·¥æ•°ã®æŠ½å‡ºï¼ˆä¾‹ï¼š"20æ™‚é–“" â†’ 20ï¼‰
    //     let workHours = 0;
    //     if (job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š) {
    //         const hoursMatch = job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š.match(/(\d+)/);
    //         if (hoursMatch && hoursMatch[1]) {
    //             workHours = parseInt(hoursMatch[1]);
    //         }
    //     }

    //     return {
    //         hourlyRate,
    //         workHours,
    //         title: job.title || '',
    //         description: job.gpt_summary || '',
    //         url: `https://crowdworks.jp/public/jobs/${job.jobId}`,
    //         category: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°',
    //         difficulty: job.é›£æ˜“åº¦ || '',
    //         analysis: job.gpt_summary || ''
    //     };
    // }

    /**
     * ãŠã™ã™ã‚ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
     */
    private calculateRecommendationScore(job: any): number {
        let score = 0;
        
        // åŸºæœ¬ã‚¹ã‚³ã‚¢ï¼ˆæ™‚çµ¦ï¼‰
        const hourlyRate = job.hourlyRate || 0;
        score += hourlyRate;
        
        // æŠ€è¡“ã‚¹ã‚­ãƒ«é‡ã¿ä»˜ã‘
        const techKeywords = ['React', 'Vue', 'Angular', 'TypeScript', 'Node.js', 'Python', 'AI', 'Machine Learning', 'Bubble', 'Figma'];
        let techScore = 0;
        const description = (job.description || '').toLowerCase();
        techKeywords.forEach(keyword => {
            if (description.includes(keyword.toLowerCase())) {
                techScore += 1000; // æŠ€è¡“ã‚¹ã‚­ãƒ«ãƒœãƒ¼ãƒŠã‚¹
            }
        });
        score += techScore;
        
        // ç¶™ç¶šæ€§ãƒœãƒ¼ãƒŠã‚¹
        if (description.includes('ç¶™ç¶š') || description.includes('é•·æœŸ') || description.includes('ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼')) {
            score += 2000;
        }
        
        // æ€¥å‹Ÿãƒœãƒ¼ãƒŠã‚¹
        if (description.includes('æ€¥å‹Ÿ') || description.includes('å³æˆ¦åŠ›')) {
            score += 1500;
        }
        
        // çµŒé¨“è€…å„ªé‡ãƒœãƒ¼ãƒŠã‚¹
        if (description.includes('çµŒé¨“è€…') || description.includes('ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ') || description.includes('ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆ')) {
            score += 1000;
        }
        
        // ãƒ•ãƒ«ãƒªãƒ¢ãƒ¼ãƒˆãƒœãƒ¼ãƒŠã‚¹
        if (description.includes('ãƒ•ãƒ«ãƒªãƒ¢ãƒ¼ãƒˆ') || description.includes('å®Œå…¨åœ¨å®…') || description.includes('åœ¨å®…')) {
            score += 500;
        }
        
        // é«˜é¡æ¡ˆä»¶ãƒœãƒ¼ãƒŠã‚¹ï¼ˆæ™‚çµ¦10000å††ä»¥ä¸Šï¼‰
        if (hourlyRate >= 10000) {
            score += 3000;
        }
        
        return score;
    }

    /**
     * é‡è¤‡é™¤å»
     */
    private removeDuplicates(jobs: any[]): any[] {
        const uniqueJobs = new Map<string, any>();
        
        jobs.forEach(job => {
            const key = `${job.title}-${job.platform}-${job.url}`;
            if (!uniqueJobs.has(key)) {
                uniqueJobs.set(key, job);
            }
        });
        
        return Array.from(uniqueJobs.values());
    }

    /**
     * æŠ€è¡“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ
     */
    private getTechKeywords(jobs: any[]): Array<{keyword: string, count: number}> {
        const techKeywords = ['React', 'Vue', 'Angular', 'TypeScript', 'Node.js', 'Python', 'AI', 'Machine Learning', 'Bubble', 'Figma', 'WordPress', 'Laravel', 'Next.js', 'Flutter', 'Swift', 'Kotlin'];
        const keywordCounts = new Map<string, number>();
        
        techKeywords.forEach(keyword => {
            const count = jobs.filter(job => {
                const description = (job.description || '').toLowerCase();
                return description.includes(keyword.toLowerCase());
            }).length;
            if (count > 0) {
                keywordCounts.set(keyword, count);
            }
        });
        
        return Array.from(keywordCounts.entries())
            .map(([keyword, count]) => ({keyword, count}))
            .sort((a, b) => b.count - a.count);
    }

    /**
     * é«˜æ™‚çµ¦æ¡ˆä»¶ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
     */
    private filterHighPayingJobs(
        lancersJobs: any[],
        crowdWorksJobs: ProcessedAnalyzedJob[],
        minHourlyRate: number
    ): { lancers: Job[], crowdworks: ProcessedAnalyzedJob[] } {

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ï¼ˆGPTåˆ†æçµæœã‚’æ´»ç”¨ï¼‰
        const processedLancers: Job[] = lancersJobs
            .map(job => {
                // GPTåˆ†æçµæœã‹ã‚‰æ™‚çµ¦ã‚’å–å¾—
                const gptHourlyRate = job.æƒ³å®šæ™‚çµ¦ || 0;
                const budgetAmount = this.extractBudgetAmount(job.budget || '');

                console.log(`ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶: ${job.title}`);
                console.log(`ğŸ¤– GPTæƒ³å®šæ™‚çµ¦: ${gptHourlyRate}å††/æ™‚`);

                return {
                    id: job.jobId || '',
                    title: job.title || '',
                    description: job.detailedDescription || job.gpt_summary || '',
                    url: job.url || '',
                    budget: {
                        amount: budgetAmount,
                        currency: 'JPY',
                        type: 'fixed' as const
                    },
                    hourlyRate: gptHourlyRate,
                    platform: 'lancers' as const,
                    category: job.category || 'unknown',
                    tags: [],
                    postedAt: job.scrapedAt || new Date().toISOString(),
                    scrapedAt: job.scrapedAt || new Date().toISOString()
                };
            })
            .filter(job => job.hourlyRate >= minHourlyRate);

        // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚‚GPTåˆ†æçµæœã‚’æ´»ç”¨
        const filteredCrowdWorks = crowdWorksJobs.filter(job => {
            const hourlyRate = (job as any).æƒ³å®šæ™‚çµ¦ || 0;
            console.log(`ğŸ” CrowdWorksæ¡ˆä»¶: ${(job as any).title}`);
            console.log(`ğŸ¤– GPTæƒ³å®šæ™‚çµ¦: ${hourlyRate}å††/æ™‚`);
            return hourlyRate >= minHourlyRate;
        });

        return {
            lancers: processedLancers,
            crowdworks: filteredCrowdWorks
        };
    }

    // çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
    private generateUnifiedReport(
        highPayingJobs: { lancers: any[], crowdworks: ProcessedAnalyzedJob[] },
        minHourlyRate: number
    ): string {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ja-JP');
        const timeStr = now.toLocaleTimeString('ja-JP');

        const allJobs = [
            ...highPayingJobs.lancers.map(job => ({
                ...job,
                platform: 'ãƒ©ãƒ³ã‚µãƒ¼ã‚º',
                hourlyRate: job.hourlyRate || 0
            })),
            ...highPayingJobs.crowdworks.map(job => ({
                ...job,
                platform: 'ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹',
                hourlyRate: (job as any).æƒ³å®šæ™‚çµ¦ || 0,
                å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: (job as any).å·¥æ•°_è¦‹ç©ã‚‚ã‚Š || 'æœªç®—å‡º',
                ç°¡æ˜“è¨­è¨ˆ: (job as any).ç°¡æ˜“è¨­è¨ˆ || 'è¨­è¨ˆæƒ…å ±ãªã—'
            }))
        ];

        // é‡è¤‡ã‚’é™¤å»
        const uniqueJobs = this.removeDuplicates(allJobs);

        // ãŠã™ã™ã‚ã‚¹ã‚³ã‚¢ã§ä¸¦ã³æ›¿ãˆ
        const sortedJobs = uniqueJobs
            .map(job => ({
                ...job,
                recommendationScore: this.calculateRecommendationScore(job)
            }))
            .sort((a, b) => b.recommendationScore - a.recommendationScore);

        const totalJobs = sortedJobs.length;
        const hourlyRates = sortedJobs.map(job => job.hourlyRate || 0).filter(rate => rate > 0);
        const maxHourlyRate = hourlyRates.length > 0 ? Math.max(...hourlyRates) : 0;
        const minHourlyRateActual = hourlyRates.length > 0 ? Math.min(...hourlyRates) : 0;
        const avgHourlyRate = hourlyRates.length > 0 ? Math.round(hourlyRates.reduce((sum, rate) => sum + rate, 0) / hourlyRates.length) : 0;

        let report = `# çµ±åˆãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹æ¡ˆä»¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ™‚çµ¦${minHourlyRate}å††ä»¥ä¸Šï¼‰

> **ç”Ÿæˆæ—¥æ™‚**: ${dateStr} ${timeStr}  
> **å¯¾è±¡**: Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘é«˜æ™‚çµ¦æ¡ˆä»¶  
> **æœ€ä½æ™‚çµ¦**: ${minHourlyRate.toLocaleString()}å††ä»¥ä¸Š  
> **ãŠã™ã™ã‚é †**: æ™‚çµ¦ + æŠ€è¡“è¦ä»¶ + ç¶™ç¶šæ€§ + æ€¥å‹Ÿåº¦ãªã©ã‚’ç·åˆè©•ä¾¡

## ğŸ“Š çµ±åˆã‚µãƒãƒªãƒ¼

| é …ç›® | ãƒ©ãƒ³ã‚µãƒ¼ã‚º | ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ | åˆè¨ˆ |
|------|------------|------------------|------|
| é«˜æ™‚çµ¦æ¡ˆä»¶æ•° | ${highPayingJobs.lancers.length}ä»¶ | ${highPayingJobs.crowdworks.length}ä»¶ | ${totalJobs}ä»¶ï¼ˆé‡è¤‡é™¤å»å¾Œï¼‰ |
| æœ€é«˜æ™‚çµ¦ | ${highPayingJobs.lancers.length > 0 ? Math.max(...highPayingJobs.lancers.map(j => j.hourlyRate || 0)).toLocaleString() : '0'}å†† | ${highPayingJobs.crowdworks.length > 0 ? Math.max(...highPayingJobs.crowdworks.map(j => (j as any).æƒ³å®šæ™‚çµ¦ || 0)).toLocaleString() : '0'}å†† | ${maxHourlyRate.toLocaleString()}å†† |
| å¹³å‡æ™‚çµ¦ | ${highPayingJobs.lancers.length > 0 ? Math.round(highPayingJobs.lancers.reduce((sum, j) => sum + (j.hourlyRate || 0), 0) / highPayingJobs.lancers.length).toLocaleString() : '0'}å†† | ${highPayingJobs.crowdworks.length > 0 ? Math.round(highPayingJobs.crowdworks.reduce((sum, j) => sum + ((j as any).æƒ³å®šæ™‚çµ¦ || 0), 0) / highPayingJobs.crowdworks.length).toLocaleString() : '0'}å†† | ${avgHourlyRate.toLocaleString()}å†† |

## ğŸ¯ å¸‚å ´åˆ†æ

### ğŸ’¡ **ä¸»è¦ãªç™ºè¦‹**

- **é«˜æ™‚çµ¦æ¡ˆä»¶ã®ç·æ•°**: ${totalJobs}ä»¶ï¼ˆé‡è¤‡é™¤å»å¾Œï¼‰
- **æœ€é«˜æ™‚çµ¦**: ${maxHourlyRate.toLocaleString()}å††
- **æ™‚çµ¦åˆ†å¸ƒ**: ${minHourlyRateActual.toLocaleString()}å†† ã€œ ${maxHourlyRate.toLocaleString()}å††
- **å¹³å‡æ™‚çµ¦**: ${avgHourlyRate.toLocaleString()}å††

### ğŸ“ˆ **ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ¯”è¼ƒ**

${highPayingJobs.lancers.length > 0 ? '- **ãƒ©ãƒ³ã‚µãƒ¼ã‚º**: ' + highPayingJobs.lancers.length + 'ä»¶ã®é«˜æ™‚çµ¦æ¡ˆä»¶ï¼ˆç«¶äº‰ãŒå°‘ãªãç©´å ´ã®å¯èƒ½æ€§ï¼‰' : '- **ãƒ©ãƒ³ã‚µãƒ¼ã‚º**: é«˜æ™‚çµ¦æ¡ˆä»¶ãªã—'}
${highPayingJobs.crowdworks.length > 0 ? '- **ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹**: ' + highPayingJobs.crowdworks.length + 'ä»¶ã®é«˜æ™‚çµ¦æ¡ˆä»¶ï¼ˆæ¡ˆä»¶æ•°è±Šå¯Œï¼‰' : '- **ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹**: é«˜æ™‚çµ¦æ¡ˆä»¶ãªã—'}

## ğŸ’¼ ãŠã™ã™ã‚æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆç·åˆè©•ä¾¡é †ï¼‰

`;

        // ãŠã™ã™ã‚é †ã§ã‚½ãƒ¼ãƒˆè¡¨ç¤º
        sortedJobs.forEach((job, index) => {
            const platform = job.platform === 'ãƒ©ãƒ³ã‚µãƒ¼ã‚º' ? 'ğŸŸ¦' : 'ğŸŸ¨';
            const urgent = job.isUrgent ? 'ğŸ”¥ **æ€¥å‹Ÿ** ' : '';



            report += `### ${index + 1}ä½: ${platform} ${urgent}${job.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜'}

**ğŸ’° æƒ³å®šæ™‚çµ¦:** ${(job.hourlyRate || 0).toLocaleString()}å††  
**â±ï¸ è¦‹è¾¼ã¿æ™‚é–“:** ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š || 'æœªç®—å‡º'}  
**ğŸ—ï¸ ç°¡æ˜“è¨­è¨ˆ:** ${job.ç°¡æ˜“è¨­è¨ˆ || 'è¨­è¨ˆæƒ…å ±ãªã—'}  
**ğŸ“Š ãŠã™ã™ã‚ã‚¹ã‚³ã‚¢:** ${job.recommendationScore.toLocaleString()}pt  
**ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª:** ${job.category || 'ã‚«ãƒ†ã‚´ãƒªä¸æ˜'}  
**ğŸ“± ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :** ${job.platform}  
**ğŸ”— æ¡ˆä»¶URL:** ${job.url || '#'}

**ğŸ“ æ¦‚è¦:**  
${job.detailedDescription ? job.detailedDescription.substring(0, 300) + '...' : job.gpt_summary || 'è©³ç´°æƒ…å ±ãªã—'}

---

`;
        });

        // æŠ€è¡“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ
        const techKeywords = this.getTechKeywords(sortedJobs);

        report += `
## ğŸ¯ æˆ¦ç•¥çš„ææ¡ˆ

### ğŸ“‹ **ãŠã™ã™ã‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**

1. **å³åº§ã«å¿œå‹Ÿã™ã¹ãæ¡ˆä»¶**: ä¸Šä½5ä»¶ï¼ˆãŠã™ã™ã‚ã‚¹ã‚³ã‚¢${sortedJobs.length > 4 ? sortedJobs[4].recommendationScore.toLocaleString() : '10,000'}ptä»¥ä¸Šï¼‰
2. **ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå¼·åŒ–**: ${highPayingJobs.lancers.length > 0 && highPayingJobs.crowdworks.length > 0 ? 'ä¸¡ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã®å®Ÿç¸¾ä½œã‚Š' : 'ä¸»è¦ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã®å®Ÿç¸¾ä½œã‚Š'}
3. **ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—é ˜åŸŸ**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã€APIé€£æºã€é«˜åº¦ãªãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æŠ€è¡“

### ğŸ’¡ **å¸‚å ´æˆ¦ç•¥**

- **ãƒ©ãƒ³ã‚µãƒ¼ã‚º**: ${highPayingJobs.lancers.length > 0 ? 'ç«¶äº‰ãŒå°‘ãªãé«˜æ™‚çµ¦ã‚’ç‹™ã„ã‚„ã™ã„' : 'é«˜æ™‚çµ¦æ¡ˆä»¶ãŒå°‘ãªã„ãŸã‚è¦æ³¨æ„'}
- **ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹**: ${highPayingJobs.crowdworks.length > 0 ? 'æ¡ˆä»¶æ•°ãŒè±Šå¯Œã§å®‰å®šåå…¥ã‚’æœŸå¾…ã§ãã‚‹' : 'é«˜æ™‚çµ¦æ¡ˆä»¶ç²å¾—ã«å‘ã‘ãŸæˆ¦ç•¥çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¿…è¦'}

### ğŸ”¥ **æ³¨ç›®æŠ€è¡“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰**

${techKeywords.map(tech => `- **${tech.keyword}**: ${tech.count}ä»¶`).join('\n')}

---

*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯${now.toLocaleString('ja-JP')}ã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
`;

        return report;
    }

    // ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
    async execute(minHourlyRate: number): Promise<void> {
        console.log('ğŸš€ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™...');
        console.log(`ğŸ’° æœ€ä½æ™‚çµ¦: ${minHourlyRate}å††`);

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        console.log('\nğŸ“š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
        const { lancers, crowdworks } = this.loadJobData();

        if (lancers.length === 0 && crowdworks.length === 0) {
            console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        // é«˜æ™‚çµ¦æ¡ˆä»¶ã®æŠ½å‡º
        console.log('\nğŸ” é«˜æ™‚çµ¦æ¡ˆä»¶ã‚’æŠ½å‡ºä¸­...');
        const highPayingJobs = this.filterHighPayingJobs(lancers, crowdworks, minHourlyRate);

        console.log(`ğŸ”¥ é«˜æ™‚çµ¦æ¡ˆä»¶ (${minHourlyRate}å††ä»¥ä¸Š):`);
        console.log(`   ãƒ©ãƒ³ã‚µãƒ¼ã‚º: ${highPayingJobs.lancers.length}ä»¶`);
        console.log(`   ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹: ${highPayingJobs.crowdworks.length}ä»¶`);

        if (highPayingJobs.lancers.length === 0 && highPayingJobs.crowdworks.length === 0) {
            console.log(`âš ï¸ æ™‚çµ¦${minHourlyRate}å††ä»¥ä¸Šã®æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`);
            return;
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        console.log('\nğŸ“„ çµ±åˆãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­...');
        const report = this.generateUnifiedReport(highPayingJobs, minHourlyRate);

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
        const filename = `unified-high-paying-jobs-${timestamp}.md`;
        const filepath = path.join(this.outputDir, filename);

        fs.writeFileSync(filepath, report, 'utf8');

        console.log('\nâœ… çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†ï¼');
        console.log(`ğŸ“ ä¿å­˜å…ˆ: ${filepath}`);
        console.log(`ğŸ“Š ç·æ¡ˆä»¶æ•°: ${highPayingJobs.lancers.length + highPayingJobs.crowdworks.length}ä»¶`);
    }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
async function main() {
    try {
        const args = process.argv.slice(2);
        const minHourlyRate = args.length > 0 && args[0] ? parseInt(args[0]) : 2000; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’2000å††ã«å¤‰æ›´
        
        const generator = new UnifiedReportGenerator();
        await generator.execute(minHourlyRate);
    } catch (error) {
        console.error('âŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        process.exit(1);
    }
}

if (require.main === module) {
    main().catch(console.error);
}

export { UnifiedReportGenerator };
</file>

<file path="scripts/extract-high-hourly-jobs.ts">
require('dotenv').config();

import { readFileSync, writeFileSync } from 'fs';

// å‹å®šç¾©
interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    gpt_summary: string;
    category?: string;
}

interface HighHourlyJob extends AnalysisResult {
    hourly_rate_numeric: number;
    link: string;
    original_title?: string;
}

// æ™‚çµ¦æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function parseHourlyRate(hourlyRateString: string): number {
    if (!hourlyRateString || hourlyRateString.trim() === '' || hourlyRateString === '0å††') {
        return 0;
    }

    const match = hourlyRateString.match(/([0-9,]+)/);
    if (match && match[1]) {
        const numericString = match[1].replace(/,/g, '');
        return parseInt(numericString, 10);
    }

    return 0;
}

// è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getOriginalJobData(jobId: string, detailsData: any[]): any {
    return detailsData.find(job => job.jobId === jobId);
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
function extractHighHourlyJobs(): void {
    console.log('ğŸ”„ æ™‚çµ¦3000å††ä»¥ä¸Šã®æ¡ˆä»¶æŠ½å‡ºã‚’é–‹å§‹...');

    const highHourlyJobs: HighHourlyJob[] = [];
    const minHourlyRate = 3000;

    // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã‚€ï¼ˆå…ƒã®ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ç”¨ï¼‰
    let ecDetailsData: any[] = [];
    let webDetailsData: any[] = [];

    // ECè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    try {
        ecDetailsData = JSON.parse(readFileSync('output/details-ec.json', 'utf8'));
        console.log(`ğŸ“‚ ECè©³ç´°ãƒ‡ãƒ¼ã‚¿: ${ecDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ ECè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
    }

    // Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    try {
        webDetailsData = JSON.parse(readFileSync('output/details-web_products.json', 'utf8'));
        console.log(`ğŸ“‚ Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${webDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
    }

    // AIåˆ†ææ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    let ecAnalyzedData: any[] = [];
    let webAnalyzedData: any[] = [];

    try {
        ecAnalyzedData = JSON.parse(readFileSync('output/analyzed-ec.json', 'utf8'));
        console.log(`ğŸ§  EC AIåˆ†æãƒ‡ãƒ¼ã‚¿: ${ecAnalyzedData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ ECã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-ec.json`);
    }

    try {
        webAnalyzedData = JSON.parse(readFileSync('output/analyzed-web_products.json', 'utf8'));
        console.log(`ğŸ§  Webè£½å“ AIåˆ†æãƒ‡ãƒ¼ã‚¿: ${webAnalyzedData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ Webè£½å“ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-web_products.json`);
    }

    // ECã‚«ãƒ†ã‚´ãƒªã®åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        ecAnalyzedData.forEach(item => {
            const hourlyRate = parseHourlyRate(item.æƒ³å®šæ™‚çµ¦);
            if (hourlyRate >= minHourlyRate) {
                const originalJob = getOriginalJobData(item.jobId, ecDetailsData);
                highHourlyJobs.push({
                    ...item,
                    category: 'EC',
                    hourly_rate_numeric: hourlyRate,
                    link: `https://crowdworks.jp/public/jobs/${item.jobId}`,
                    original_title: originalJob?.title || item.title
                });
            }
        });
        console.log(`âœ… ECã‚«ãƒ†ã‚´ãƒª: ${ecAnalyzedData.length}ä»¶ä¸­ ${ecAnalyzedData.filter(item => parseHourlyRate(item.æƒ³å®šæ™‚çµ¦) >= minHourlyRate).length}ä»¶ãŒå¯¾è±¡`);
    } catch (e) {
        console.log('âš ï¸ ECã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-ec.json');
    }

    // Webè£½å“ã‚«ãƒ†ã‚´ãƒªã®åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        webAnalyzedData.forEach(item => {
            const hourlyRate = parseHourlyRate(item.æƒ³å®šæ™‚çµ¦);
            if (hourlyRate >= minHourlyRate) {
                const originalJob = getOriginalJobData(item.jobId, webDetailsData);
                highHourlyJobs.push({
                    ...item,
                    category: 'Webè£½å“',
                    hourly_rate_numeric: hourlyRate,
                    link: `https://crowdworks.jp/public/jobs/${item.jobId}`,
                    original_title: originalJob?.title || item.title
                });
            }
        });
        console.log(`âœ… Webè£½å“ã‚«ãƒ†ã‚´ãƒª: ${webAnalyzedData.length}ä»¶ä¸­ ${webAnalyzedData.filter(item => parseHourlyRate(item.æƒ³å®šæ™‚çµ¦) >= minHourlyRate).length}ä»¶ãŒå¯¾è±¡`);
    } catch (e) {
        console.log('âš ï¸ Webè£½å“ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-web_products.json');
    }

    if (highHourlyJobs.length === 0) {
        console.error('âŒ å¯¾è±¡æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
    }

    // æ™‚çµ¦é †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜é¡é †ï¼‰
    const sortedJobs = highHourlyJobs.sort((a, b) => b.hourly_rate_numeric - a.hourly_rate_numeric);

    // Markdownãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
    const markdown = generateMarkdown(sortedJobs, minHourlyRate);
    const outputFileName = `output/high-hourly-jobs-3000+.md`;

    writeFileSync(outputFileName, markdown, 'utf8');
    console.log(`ğŸ’¾ Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜: ${outputFileName}`);
    console.log(`ğŸ“Š æŠ½å‡ºä»¶æ•°: ${sortedJobs.length}ä»¶`);
    console.log(`ğŸ’° æœ€é«˜æ™‚çµ¦: ${Math.max(...sortedJobs.map(j => j.hourly_rate_numeric)).toLocaleString()}å††`);
}

// Markdownç”Ÿæˆé–¢æ•°
function generateMarkdown(jobs: HighHourlyJob[], minRate: number): string {
    const currentDate = new Date().toISOString().split('T')[0];

    let markdown = `# é«˜æ™‚çµ¦æ¡ˆä»¶ä¸€è¦§ï¼ˆ${minRate}å††ä»¥ä¸Šï¼‰\n\n`;
    markdown += `> ç”Ÿæˆæ—¥: ${currentDate}  \n`;
    markdown += `> å¯¾è±¡: æ™‚çµ¦${minRate.toLocaleString()}å††ä»¥ä¸Šã®æ¡ˆä»¶  \n`;
    markdown += `> ç·ä»¶æ•°: ${jobs.length}ä»¶  \n`;
    markdown += `> æ³¨æ„: å·¥æ•°è¦‹ç©ã‚‚ã‚Šã«ã¯è¦ä»¶å®šç¾©ã€æ‰“ã¡åˆã‚ã›ã€ä¿®æ­£ä½œæ¥­ãªã©ã®å‰ä½œæ¥­ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™\n\n`;

    markdown += `## ğŸ“Š æ¦‚è¦\n\n`;
    markdown += `| çµ±è¨ˆé …ç›® | å€¤ |\n`;
    markdown += `|----------|----|\n`;
    markdown += `| æœ€é«˜æ™‚çµ¦ | ${Math.max(...jobs.map(j => j.hourly_rate_numeric)).toLocaleString()}å†† |\n`;
    markdown += `| æœ€ä½æ™‚çµ¦ | ${Math.min(...jobs.map(j => j.hourly_rate_numeric)).toLocaleString()}å†† |\n`;
    markdown += `| å¹³å‡æ™‚çµ¦ | ${Math.round(jobs.reduce((sum, j) => sum + j.hourly_rate_numeric, 0) / jobs.length).toLocaleString()}å†† |\n`;
    markdown += `| ECæ¡ˆä»¶æ•° | ${jobs.filter(j => j.category === 'EC').length}ä»¶ |\n`;
    markdown += `| Webè£½å“æ¡ˆä»¶æ•° | ${jobs.filter(j => j.category === 'Webè£½å“').length}ä»¶ |\n\n`;

    markdown += `## ğŸ’¼ æ¡ˆä»¶ä¸€è¦§\n\n`;

    jobs.forEach((job, index) => {
        markdown += `### ${index + 1}. [${job.original_title}](${job.link})\n\n`;
        markdown += `**ğŸ’° æƒ³å®šæ™‚çµ¦:** ${job.hourly_rate_numeric.toLocaleString()}å††  \n`;
        markdown += `**â° è¦‹ç©å·¥æ•°:** ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š}  \n`;
        markdown += `**ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª:** ${job.category}  \n`;
        markdown += `**ğŸ”— æ¡ˆä»¶URL:** ${job.link}\n\n`;
        markdown += `**ğŸ“ åˆ†ææ¦‚è¦:**  \n`;
        markdown += `${job.gpt_summary}\n\n`;
        markdown += `---\n\n`;
    });

    markdown += `## ğŸ“‹ æ³¨è¨˜\n\n`;
    markdown += `- æ™‚çµ¦ã¯ã€Œè¦ä»¶å®šç¾©ã€ã€Œæ‰“ã¡åˆã‚ã›ã€ã€Œä¿®æ­£ä½œæ¥­ã€ã€Œãƒ†ã‚¹ãƒˆã€ã€Œç´å“å¾Œã‚µãƒãƒ¼ãƒˆã€ãªã©ã®ä»˜å¸¯ä½œæ¥­ã‚‚å«ã‚ãŸç¾å®Ÿçš„ãªå·¥æ•°è¦‹ç©ã‚‚ã‚Šã«åŸºã¥ã„ã¦ã„ã¾ã™\n`;
    markdown += `- æ¡ˆä»¶ã®è©³ç´°ã¯å„ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®ãƒšãƒ¼ã‚¸ã§ã”ç¢ºèªãã ã•ã„\n`;
    markdown += `- æ™‚çµ¦è¨ˆç®—ã¯GPT-4oã«ã‚ˆã‚‹åˆ†æçµæœã§ã‚ã‚Šã€å®Ÿéš›ã®ä½œæ¥­æ™‚é–“ã‚„å ±é…¬ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™\n`;
    markdown += `- æ¡ˆä»¶ã®å‹Ÿé›†çŠ¶æ³ã¯å¤‰å‹•ã™ã‚‹ãŸã‚ã€ãƒªãƒ³ã‚¯å…ˆã§æœ€æ–°æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„\n`;

    return markdown;
}

// å®Ÿè¡Œ
extractHighHourlyJobs();
</file>

<file path="scripts/scrape-lancers.ts">
import { chromium } from 'playwright';
import { writeFileSync } from 'fs';
import { LancersJob, LancersJobDetail } from '../src/services/LancersService';
import * as dotenv from 'dotenv';

// ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã¿
dotenv.config();

/**
 * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ¡ã‚¤ãƒ³å‡¦ç†
 */
async function main(): Promise<void> {
    console.log('ğŸš€ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚’é–‹å§‹ã—ã¾ã™...');
    console.log('âš ï¸ æ³¨æ„: å…¬é–‹æ¡ˆä»¶ã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¾ã™');

    const browser = await chromium.launch({
        headless: false,
        slowMo: 1000,
        args: ['--no-sandbox', '--disable-setuid-sandbox']
    });

    try {
        const page = await browser.newPage();

        // User-Agentã‚’è¨­å®š
        await page.setExtraHTTPHeaders({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
        });

        // const lancersService = new LancersService(page);

        // å–å¾—ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã¨ãã‚Œãã‚Œã®æœ€å¤§ä»¶æ•°ï¼ˆ10ä»¶ãšã¤ã«å¤‰æ›´ï¼‰
        const categories = [
            { name: 'system', url: 'https://www.lancers.jp/work/search/system' },
            { name: 'web', url: 'https://www.lancers.jp/work/search/web' },
            { name: 'app', url: 'https://www.lancers.jp/work/search/app' },
            { name: 'design', url: 'https://www.lancers.jp/work/search/design' },
            { name: 'writing', url: 'https://www.lancers.jp/work/search/writing' },
            { name: 'translation', url: 'https://www.lancers.jp/work/search/translation' }
        ];

        const itemsPerCategory = 5; // å„ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰5ä»¶å–å¾—ï¼ˆåˆè¨ˆ30ä»¶ï¼‰
        const detailsLimit = 5; // è©³ç´°å–å¾—ã‚‚5ä»¶ã«åˆ¶é™

        const allJobs: LancersJob[] = [];
        const allDetails: LancersJobDetail[] = [];
        const startTime = Date.now();

        console.log('ğŸ” å„ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰æ¡ˆä»¶ã‚’å–å¾—ã—ã¾ã™...');

        for (const category of categories) {
            console.log(`\nğŸ“ ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã®å‡¦ç†ã‚’é–‹å§‹ï¼ˆæœ€å¤§${itemsPerCategory}ä»¶ï¼‰`);

            try {
                // ã‚«ãƒ†ã‚´ãƒªURLãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæ–°ç€é †ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãï¼‰
                const categoryUrls: { [key: string]: string } = {
                    'system': 'https://www.lancers.jp/work/search/system?open=1&show_description=1&sort=started&work_rank%5B%5D=0&work_rank%5B%5D=2&work_rank%5B%5D=3',
                    'web': 'https://www.lancers.jp/work/search/web?open=1&show_description=1&sort=started&work_rank%5B%5D=0&work_rank%5B%5D=2&work_rank%5B%5D=3',
                    'app': 'https://www.lancers.jp/work/search/system/smartphoneapp?open=1&show_description=1&sort=started&work_rank%5B%5D=0&work_rank%5B%5D=2&work_rank%5B%5D=3',
                    'design': 'https://www.lancers.jp/work/search/design?open=1&show_description=1&sort=started&work_rank%5B%5D=0&work_rank%5B%5D=2&work_rank%5B%5D=3',
                    'writing': 'https://www.lancers.jp/work/search/writing?open=1&show_description=1&sort=started&work_rank%5B%5D=0&work_rank%5B%5D=2&work_rank%5B%5D=3',
                    'translation': 'https://www.lancers.jp/work/search/writing/translation?open=1&show_description=1&sort=started&work_rank%5B%5D=0&work_rank%5B%5D=2&work_rank%5B%5D=3'
                };

                const categoryUrl = categoryUrls[category.name];
                if (!categoryUrl) {
                    console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã®URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    continue;
                }

                console.log(`ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹: ${categoryUrl}`);
                await page.goto(categoryUrl, { waitUntil: 'networkidle', timeout: 30000 });
                await page.waitForTimeout(3000);

                // æ–°ç€é †ãŒæ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                const sortSelect = await page.$('select[name="sort"], combobox[aria-label="ä¸¦ã³é †"]');
                if (sortSelect) {
                    const selectedValue = await sortSelect.evaluate(el => (el as HTMLSelectElement).value);
                    console.log(`ğŸ“Š ç¾åœ¨ã®ã‚½ãƒ¼ãƒˆ: ${selectedValue}`);

                    if (selectedValue !== 'started') {
                        await page.selectOption('select[name="sort"]', 'started');
                        console.log('âœ… æ–°ç€é †ã«å¤‰æ›´ã—ã¾ã—ãŸ');
                        await page.waitForTimeout(2000);
                    } else {
                        console.log('âœ… æ—¢ã«æ–°ç€é †ã§ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™');
                    }
                }

                // æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—
                const jobs = await getJobsFromPage(page, itemsPerCategory, category.name);
                console.log(`ğŸ“Š ${category.name}ã‚«ãƒ†ã‚´ãƒª: ${jobs.length}ä»¶ã®æ¡ˆä»¶ã‚’å–å¾—`);

                allJobs.push(...jobs);

                // è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆæœ€å¤§10ä»¶ã¾ã§ï¼‰
                const detailsToFetch = jobs.slice(0, detailsLimit);
                for (const job of detailsToFetch) {
                    try {
                        console.log(`ğŸ” è©³ç´°å–å¾—: ${job.title}`);
                        const detail = await getJobDetail(page, job.url);
                        if (detail) {
                            allDetails.push(detail);
                        }
                        await page.waitForTimeout(1000); // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
                    } catch (detailError) {
                        console.log(`âš ï¸ è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ${job.title}`);
                    }
                }

            } catch (categoryError) {
                console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category.name}ã€ã§ã‚¨ãƒ©ãƒ¼:`, categoryError);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        const jobsFilename = `output/lancers-jobs-${timestamp}.json`;
        const detailsFilename = `output/lancers-details-${timestamp}.json`;

        writeFileSync(jobsFilename, JSON.stringify(allJobs, null, 2), 'utf8');
        writeFileSync(detailsFilename, JSON.stringify(allDetails, null, 2), 'utf8');

        const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);

        console.log('\nğŸ‰ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†ï¼');
        console.log(`ğŸ“Š åˆè¨ˆå–å¾—ä»¶æ•°: ${allJobs.length}ä»¶`);
        console.log(`ğŸ“ è©³ç´°å–å¾—ä»¶æ•°: ${allDetails.length}ä»¶`);
        console.log(`â±ï¸ å®Ÿè¡Œæ™‚é–“: ${elapsedTime}ç§’`);
        console.log(`ğŸ’¾ ä¿å­˜å…ˆ: ${jobsFilename}`);
        console.log(`ğŸ’¾ è©³ç´°ä¿å­˜å…ˆ: ${detailsFilename}`);

    } catch (error) {
        console.error('âŒ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
    } finally {
        await browser.close();
    }
}

/**
 * ãƒšãƒ¼ã‚¸ã‹ã‚‰æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—
 */
async function getJobsFromPage(page: any, maxJobs: number, category: string): Promise<LancersJob[]> {
    const jobs: LancersJob[] = [];
    let pageNum = 1;

    while (jobs.length < maxJobs) {
        console.log(`ğŸ“„ ãƒšãƒ¼ã‚¸ ${pageNum} ã‚’å‡¦ç†ä¸­...`);

        // æ¡ˆä»¶ä¸€è¦§è¦ç´ ã‚’å–å¾—ï¼ˆæ›´æ–°ã•ã‚ŒãŸã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‰
        const jobElements = await page.$$('article[data-testid="job-card"], .job-item, div[data-job-id]');

        if (jobElements.length === 0) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
            const fallbackElements = await page.$$('div:has(> a[href*="/work/detail/"])');
            console.log(`ğŸ” ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ${fallbackElements.length}ä»¶ã®è¦ç´ ã‚’ç™ºè¦‹`);

            if (fallbackElements.length === 0) {
                console.log('âŒ æ¡ˆä»¶è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                break;
            }
        }

        const currentPageJobs = jobElements.length > 0 ? jobElements : await page.$$('div:has(> a[href*="/work/detail/"])');

        for (let i = 0; i < currentPageJobs.length && jobs.length < maxJobs; i++) {
            try {
                const job = await extractJobFromElement(currentPageJobs[i], category);
                if (job) {
                    jobs.push(job);
                }
            } catch (jobError) {
                console.log(`âš ï¸ æ¡ˆä»¶æŠ½å‡ºã‚¨ãƒ©ãƒ¼: ${jobError}`);
            }
        }

        // æ¬¡ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const nextButton = await page.$('a:has-text("æ¬¡ã¸"), a[aria-label="æ¬¡ã®ãƒšãƒ¼ã‚¸"]');
        if (!nextButton || jobs.length >= maxJobs) {
            break;
        }

        await nextButton.click();
        await page.waitForTimeout(3000);
        pageNum++;
    }

    return jobs;
}

/**
 * æ¡ˆä»¶è¦ç´ ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
 */
async function extractJobFromElement(element: any, category: string): Promise<LancersJob | null> {
    try {
        // ã‚¿ã‚¤ãƒˆãƒ«ã¨URLï¼ˆæ›´æ–°ã•ã‚ŒãŸã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‰
        const titleLink = await element.$('a[href*="/work/detail/"]');
        if (!titleLink) return null;

        const title = await titleLink.textContent();
        const url = await titleLink.getAttribute('href');

        if (!title || !url) return null;

        const fullUrl = url.startsWith('http') ? url : `https://www.lancers.jp${url}`;
        const jobId = url.match(/\/work\/detail\/(\d+)/)?.[1] || '';

        // ä¾¡æ ¼æƒ…å ±
        // const priceElement = await element.$('span:has-text("å††"), .price, .budget');
        // const budgetText = priceElement ? await priceElement.textContent() : '';

        // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±
        // const categoryElement = await element.$('a[href*="/work/search/"], .category');
        // const subcategory = categoryElement ? await categoryElement.textContent() : '';

        // èª¬æ˜æ–‡
        const descriptionElement = await element.$('.description, .job-summary, p');
        const description = descriptionElement ? await descriptionElement.textContent() : '';

        // æŠ•ç¨¿æ—¥
        const dateElement = await element.$('.date, .posted-date, time');
        const postedDate = dateElement ? await dateElement.textContent() : '';

        // NEW ãƒ•ãƒ©ã‚°
        // const newElement = await element.$(':has-text("NEW"), .new-badge');
        // const isNew = !!newElement;

        // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
        const clientElement = await element.$('a[href*="/client/"], .client-name');
        const client = clientElement ? await clientElement.textContent() : '';

        const job: LancersJob = {
            id: jobId,
            title: title.trim(),
            description: description?.trim() || '',
            url: fullUrl,
            budget: {
                type: 'unknown' as const,
                amount: 0,
                currency: 'JPY'
            },
            category: category,
            tags: [],
            client: {
                name: client?.trim() || '',
                rating: 0,
                reviewCount: 0
            },
            postedAt: postedDate?.trim() || '',
            applicants: 0,
            scrapedAt: new Date().toISOString()
        };

        return job;

    } catch (error) {
        console.log(`âš ï¸ æ¡ˆä»¶æŠ½å‡ºã‚¨ãƒ©ãƒ¼:`, error);
        return null;
    }
}

/**
 * æ¡ˆä»¶è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆä¿®æ­£ã•ã‚ŒãŸã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ä½¿ç”¨ï¼‰
 */
async function getJobDetail(page: any, jobUrl: string): Promise<LancersJobDetail | null> {
    try {
        await page.goto(jobUrl, { waitUntil: 'networkidle', timeout: 30000 });
        await page.waitForTimeout(2000);

        const jobId = jobUrl.match(/\/work\/detail\/(\d+)/)?.[1] || '';

        // ãƒšãƒ¼ã‚¸ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const errorCheck = await page.evaluate(() => {
            const banner = document.querySelector('banner h1[level="1"]');
            if (banner) {
                const text = banner.textContent || '';
                if (text.includes('é–²è¦§åˆ¶é™') || text.includes('å‰Šé™¤')) {
                    return { error: true, message: text };
                }
            }
            return { error: false };
        });

        if (errorCheck.error) {
            console.log(`âš ï¸ ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${jobId}`);
            return null;
        }

        // ä¿®æ­£ã•ã‚ŒãŸã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦è©³ç´°æƒ…å ±ã‚’æŠ½å‡º
        const detailInfo = await page.evaluate(() => {
            // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—ï¼ˆãƒ†ã‚¹ãƒˆã§æˆåŠŸã—ãŸæ‰‹æ³•ã‚’ä½¿ç”¨ï¼‰
            const title = (() => {
                const h1 = document.querySelector('h1');
                if (!h1) return '';

                // "ã€æ€¥å‹Ÿã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­ä¾›å‘ã‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¬ãƒƒã‚¹ãƒ³è¬›å¸«ã‚’å‹Ÿé›†ï¼ã®ä»•äº‹ [ITãƒ»é€šä¿¡ãƒ»ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ]"
                // ã‹ã‚‰ "ã€æ€¥å‹Ÿã€‘ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­ä¾›å‘ã‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ¬ãƒƒã‚¹ãƒ³è¬›å¸«ã‚’å‹Ÿé›†ï¼" ã‚’æŠ½å‡º
                const fullText = h1.textContent || '';
                const match = fullText.match(/^(.+?)ã®ä»•äº‹/);
                return match ? match[1]!.trim() : fullText.replace(/\s*\[.*?\]\s*$/, '').trim();
            })();

            // äºˆç®—ã®å–å¾—ï¼ˆå®šç¾©ãƒªã‚¹ãƒˆã‹ã‚‰ã®æŠ½å‡ºï¼‰
            const budget = (() => {
                const terms = Array.from(document.querySelectorAll('dt'));
                for (const term of terms) {
                    if (term.textContent?.includes('æç¤ºã—ãŸäºˆç®—') || term.textContent?.includes('äºˆç®—')) {
                        const dd = term.nextElementSibling;
                        if (dd && dd.tagName === 'DD') {
                            return dd.textContent?.trim() || '';
                        }
                    }
                }
                return '';
            })();

            // è©³ç´°èª¬æ˜ã®å–å¾—ï¼ˆå®šç¾©ãƒªã‚¹ãƒˆã‹ã‚‰ã®æŠ½å‡ºï¼‰
            const detailedDescription = (() => {
                const terms = Array.from(document.querySelectorAll('dt'));
                for (const term of terms) {
                    if (term.textContent?.includes('ä¾é ¼æ¦‚è¦')) {
                        const dd = term.nextElementSibling;
                        if (dd && dd.tagName === 'DD') {
                            const text = dd.textContent?.trim() || '';
                            // æœ€åˆã®500æ–‡å­—ã«åˆ¶é™ï¼ˆè©³ç´°ç‰ˆãªã®ã§å°‘ã—é•·ã‚ã«ï¼‰
                            return text.length > 500 ? text.substring(0, 500) + '...' : text;
                        }
                    }
                }
                return '';
            })();

            return { title, budget, detailedDescription };
        });

        // è©³ç´°æƒ…å ±ã‚’æ§‹ç¯‰
        const detail: LancersJobDetail = {
            jobId: jobId,
            title: detailInfo.title,
            category: '',
            url: jobUrl,
            paymentType: '',
            budget: detailInfo.budget,
            deliveryDate: '',
            postDate: '',
            applicationDeadline: '',
            applicantCount: 0,
            contractCount: 0,
            recruitmentCount: 0,
            favoriteCount: 0,
            detailedDescription: detailInfo.detailedDescription,
            client: {
                name: '',
                url: '',
                overallRating: '',
                orderHistory: '',
                completionRate: '',
                identityVerified: false,
                description: ''
            },
            recentApplicants: [],
            scrapedAt: new Date().toISOString()
        };

        return detail;

    } catch (error) {
        console.log(`âš ï¸ è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
        return null;
    }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
if (require.main === module) {
    main().catch(error => {
        console.error('ğŸ’¥ ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
        process.exit(1);
    });
}

export default main;
</file>

<file path="src/index.ts">
/**
 * CrowdWorks Search System - Main Entry Point
 * Dockerç’°å¢ƒã§ã®é–‹ç™ºç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */

import { ExecutionLog } from '@/types';

// ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼
function validateEnvironment(): void {
  const required = ['NODE_ENV', 'AWS_REGION'];
  const missing = required.filter(key => !process.env[key]);

  if (missing.length > 0) {
    throw new Error(`Missing required environment variables: ${missing.join(', ')}`);
  }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
async function main(): Promise<void> {
  try {
    validateEnvironment();

    const log: ExecutionLog = {
      executionId: Date.now().toString(),
      timestamp: new Date().toISOString(),
      status: 'success',
      duration: 0,
      jobsScraped: 0,
      newJobs: 0,
      aiEvaluated: 0,
      highScoreJobs: 0,
      costEstimate: 0,
    };

    console.log('ğŸš€ CrowdWorks Search System - Development Mode');
    console.log(`Environment: ${process.env['NODE_ENV']}`);
    console.log(`AWS Region: ${process.env['AWS_REGION']}`);
    console.log(`Execution ID: ${log.executionId}`);

    // TODO: å®Ÿéš›ã®å‡¦ç†ã‚’å®Ÿè£…
    console.log('âœ… Development setup completed');
  } catch (error) {
    console.error('âŒ Failed to start application:', error);
    process.exit(1);
  }
}

// é–‹ç™ºç’°å¢ƒã§ã®ã¿å®Ÿè¡Œ
if (require.main === module) {
  main().catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
  });
}

export { main };
</file>

<file path="src/infrastructure/crowdworks-searcher-stack.ts">
import * as cdk from 'aws-cdk-lib';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as events from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as logs from 'aws-cdk-lib/aws-logs';
import { Construct } from 'constructs';

export interface CrowdWorksSearcherStackProps extends cdk.StackProps {
  readonly stage?: string;
  readonly useContainerImage?: boolean; // Container Imageä½¿ç”¨ãƒ•ãƒ©ã‚°
}

export class CrowdWorksSearcherStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: CrowdWorksSearcherStackProps) {
    super(scope, id, props);

    const stage = props?.stage || this.node.tryGetContext('stage') || 'dev';
    const isProd = stage === 'production';
    const useContainerImage = props?.useContainerImage ?? true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Containerä½¿ç”¨

    // ãƒªã‚½ãƒ¼ã‚¹åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
    const resourcePrefix = `crowdworks-searcher-${stage}`;

    // S3ãƒã‚±ãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ï¼‰
    const dataBucket = new s3.Bucket(this, 'CrowdWorksDataBucket', {
      bucketName: `${resourcePrefix}-data-${this.account}`,
      encryption: s3.BucketEncryption.S3_MANAGED,
      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
      versioned: isProd, // æœ¬ç•ªç’°å¢ƒã®ã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹
      lifecycleRules: [
        {
          id: 'DeleteOldData',
          enabled: true,
          expiration: isProd ? cdk.Duration.days(30) : cdk.Duration.days(7),
          // æœ¬ç•ªç’°å¢ƒã§ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ç®¡ç†
          ...(isProd && {
            noncurrentVersionExpiration: cdk.Duration.days(7),
          }),
        },
      ],
      removalPolicy: isProd ? cdk.RemovalPolicy.RETAIN : cdk.RemovalPolicy.DESTROY,
      autoDeleteObjects: !isProd, // æœ¬ç•ªç’°å¢ƒã§ã¯æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦
    });

    // CloudWatch Logs ã‚°ãƒ«ãƒ¼ãƒ—
    const logGroup = new logs.LogGroup(this, 'LambdaLogGroup', {
      logGroupName: `/aws/lambda/${resourcePrefix}-main`,
      retention: isProd ? logs.RetentionDays.ONE_MONTH : logs.RetentionDays.ONE_WEEK,
      removalPolicy: isProd ? cdk.RemovalPolicy.RETAIN : cdk.RemovalPolicy.DESTROY,
    });

    // Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ï¼ˆContainer Imageç”¨æ¨©é™è¿½åŠ ï¼‰
    const lambdaRole = new iam.Role(this, 'LambdaExecutionRole', {
      roleName: `${resourcePrefix}-lambda-role`,
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com'),
      managedPolicies: [
        iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole'),
      ],
      inlinePolicies: {
        S3Access: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['s3:GetObject', 's3:PutObject', 's3:ListBucket', 's3:DeleteObject'],
              resources: [dataBucket.bucketArn, `${dataBucket.bucketArn}/*`],
            }),
          ],
        }),
        LogsAccess: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['logs:CreateLogStream', 'logs:PutLogEvents'],
              resources: [logGroup.logGroupArn],
            }),
          ],
        }),
        // Parameter Store (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ç”¨)
        ParameterStoreAccess: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['ssm:GetParameter', 'ssm:GetParameters'],
              resources: [`arn:aws:ssm:${this.region}:${this.account}:parameter/crowdworks-search/*`],
            }),
          ],
        }),
      },
    });

    // Lambdaé–¢æ•°ï¼ˆContainer Imageå¯¾å¿œï¼‰
    const mainFunction = useContainerImage
      ? new lambda.DockerImageFunction(this, 'CrowdWorksMainFunction', {
        functionName: `${resourcePrefix}-main`,
        code: lambda.DockerImageCode.fromImageAsset('./', {
          // Lambda Containerç”¨ã®Dockerfileã‚’æŒ‡å®š
          file: 'Dockerfile.lambda',
          // ãƒ“ãƒ«ãƒ‰å¼•æ•°ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æ¸¡ã™
          buildArgs: {
            STAGE: stage,
            NODE_ENV: isProd ? 'production' : 'development',
          },
        }),
        timeout: cdk.Duration.minutes(15), // Playwrightç”¨ã«15åˆ†
        memorySize: isProd ? 3008 : 2048,  // Playwrightç”¨ãƒ¡ãƒ¢ãƒª
        role: lambdaRole,
        logGroup: logGroup,
        architecture: lambda.Architecture.X86_64, // Playwrightã¯x86_64ã®ã¿ã‚µãƒãƒ¼ãƒˆ
        environment: {
          NODE_ENV: stage,
          STAGE: stage,
          DATA_BUCKET_NAME: dataBucket.bucketName,
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
          // Playwrightç’°å¢ƒå¤‰æ•°
          PLAYWRIGHT_BROWSERS_PATH: '/usr/bin',
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1',
          LOG_LEVEL: isProd ? 'info' : 'debug',
        },
        // æœ¬ç•ªç’°å¢ƒã§ã¯äºˆç´„æ¸ˆã¿åŒæ™‚å®Ÿè¡Œæ•°ã‚’è¨­å®š
        ...(isProd && {
          reservedConcurrentExecutions: 5,
        }),
      })
      : new lambda.Function(this, 'CrowdWorksMainFunction', {
        functionName: `${resourcePrefix}-main`,
        runtime: lambda.Runtime.NODEJS_18_X,
        handler: 'lambda/handler.lambdaHandler',
        code: lambda.Code.fromAsset('./dist'),
        timeout: cdk.Duration.minutes(isProd ? 15 : 10),
        memorySize: isProd ? 1536 : 1024,
        role: lambdaRole,
        logGroup: logGroup,
        environment: {
          NODE_ENV: stage,
          STAGE: stage,
          DATA_BUCKET_NAME: dataBucket.bucketName,
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
        },
        // æœ¬ç•ªç’°å¢ƒã§ã¯äºˆç´„æ¸ˆã¿åŒæ™‚å®Ÿè¡Œæ•°ã‚’è¨­å®š
        ...(isProd && {
          reservedConcurrentExecutions: 5,
        }),
      });

    // EventBridgeï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ï¼‰
    const scheduleRule = new events.Rule(this, 'ScheduleRule', {
      ruleName: `${resourcePrefix}-schedule`,
      // æœ¬ç•ªç’°å¢ƒã§ã¯15åˆ†é–“éš”ã€ãã®ä»–ã¯30åˆ†é–“éš”
      schedule: events.Schedule.rate(isProd ? cdk.Duration.minutes(15) : cdk.Duration.minutes(30)),
      description: `CrowdWorksæ¡ˆä»¶æ¤œç´¢ã®å®šæœŸå®Ÿè¡Œ (${stage}ç’°å¢ƒ)`,
      enabled: stage !== 'test', // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ç„¡åŠ¹
    });

    scheduleRule.addTarget(new targets.LambdaFunction(mainFunction));

    // ã‚¿ã‚°ä»˜ã‘
    cdk.Tags.of(this).add('Project', 'CrowdWorksSearcher');
    cdk.Tags.of(this).add('Stage', stage);
    cdk.Tags.of(this).add('Environment', isProd ? 'production' : 'development');

    // å‡ºåŠ›
    new cdk.CfnOutput(this, 'DataBucketName', {
      value: dataBucket.bucketName,
      description: 'S3ãƒ‡ãƒ¼ã‚¿ãƒã‚±ãƒƒãƒˆå',
      exportName: `${resourcePrefix}-data-bucket-name`,
    });

    new cdk.CfnOutput(this, 'LambdaFunctionName', {
      value: mainFunction.functionName,
      description: 'Lambdaé–¢æ•°å',
      exportName: `${resourcePrefix}-lambda-function-name`,
    });

    new cdk.CfnOutput(this, 'LambdaFunctionArn', {
      value: mainFunction.functionArn,
      description: 'Lambdaé–¢æ•°ARN',
      exportName: `${resourcePrefix}-lambda-function-arn`,
    });

    new cdk.CfnOutput(this, 'Stage', {
      value: stage,
      description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸',
      exportName: `${resourcePrefix}-stage`,
    });

    // å‡ºåŠ›ï¼ˆContainer Imageæƒ…å ±è¿½åŠ ï¼‰
    new cdk.CfnOutput(this, 'DeploymentMethod', {
      value: useContainerImage ? 'Container Image' : 'ZIP Package',
      description: 'Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼',
      exportName: `${resourcePrefix}-deployment-method`,
    });
  }
}
</file>

<file path="src/services/index.ts">
// Services module exports
// TODO: å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…å¾Œã€ã“ã“ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

import {
    UpworkJobData,
    UpworkCredentials,
    UpworkLoginResult,
    IntegratedJobSearchResult,
    IntegratedJobReport,
    IntegratedSearchConfig,
    JobData
} from '../types/index';

/**
 * Upwork API ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹
 */
class UpworkService {
    private credentials: UpworkCredentials;
    private isAuthenticated = false;
    private accessToken?: string;

    constructor(credentials: UpworkCredentials) {
        this.credentials = credentials;
    }

    /**
     * OAuthèªè¨¼ã‚’å®Ÿè¡Œ
     */
    async authenticate(): Promise<UpworkLoginResult> {
        const startTime = Date.now();

        try {
            // ç°¡æ˜“å®Ÿè£…: èªè¨¼æƒ…å ±ã®æ¤œè¨¼
            if (!this.credentials.consumerKey || !this.credentials.consumerSecret) {
                return {
                    success: false,
                    isAuthenticated: false,
                    error: 'Consumer key and secret are required',
                    executionTime: Date.now() - startTime
                };
            }

            // TODO: å®Ÿéš›ã®OAuthèªè¨¼ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…
            // ç¾åœ¨ã¯åŸºæœ¬çš„ãªèªè¨¼æƒ…å ±ãƒã‚§ãƒƒã‚¯ã®ã¿
            this.isAuthenticated = true;
            this.accessToken = this.credentials.accessToken || 'mock-token';

            return {
                success: true,
                isAuthenticated: true,
                accessToken: this.accessToken,
                executionTime: Date.now() - startTime
            };

        } catch (error) {
            return {
                success: false,
                isAuthenticated: false,
                error: error instanceof Error ? error.message : 'Authentication failed',
                executionTime: Date.now() - startTime
            };
        }
    }

    /**
     * æ¡ˆä»¶ã‚’æ¤œç´¢
     */
    async searchJobs(params: {
        query?: string;
        category?: string;
        minBudget?: number;
        maxBudget?: number;
        jobType?: 'hourly' | 'fixed-price';
        experienceLevel?: 'entry' | 'intermediate' | 'expert';
        limit?: number;
    }): Promise<UpworkJobData[]> {
        if (!this.isAuthenticated) {
            throw new Error('Not authenticated. Call authenticate() first.');
        }

        // TODO: å®Ÿéš›ã®Upwork APIå‘¼ã³å‡ºã—å®Ÿè£…
        // ç¾åœ¨ã¯ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã™
        const mockJobs: UpworkJobData[] = [
            {
                id: 'upwork-job-1',
                title: 'Full Stack Web Developer for E-commerce Platform',
                description: 'We need an experienced full stack developer to build a modern e-commerce platform using React and Node.js...',
                url: 'https://www.upwork.com/jobs/~01234567890123456789',
                budget: {
                    type: 'hourly',
                    min: 30,
                    max: 60
                },
                duration: 'More than 6 months',
                experienceLevel: 'expert',
                jobType: 'hourly',
                category: {
                    name: 'Web Development',
                    subcategory: 'Full Stack Development'
                },
                client: {
                    country: 'United States',
                    memberSince: '2020-01-15',
                    totalSpent: 50000,
                    hireRate: 85,
                    totalJobs: 25,
                    avgHourlyPaid: 45,
                    paymentVerified: true
                },
                skills: ['React', 'Node.js', 'MongoDB', 'AWS', 'TypeScript'],
                proposals: 5,
                postedTime: '2024-01-15T10:30:00Z',
                scrapedAt: new Date()
            },
            {
                id: 'upwork-job-2',
                title: 'Mobile App Development - React Native',
                description: 'Looking for a React Native developer to create a cross-platform mobile application...',
                url: 'https://www.upwork.com/jobs/~01234567890123456790',
                budget: {
                    type: 'fixed',
                    amount: 8000
                },
                duration: '3 to 6 months',
                experienceLevel: 'intermediate',
                jobType: 'fixed-price',
                category: {
                    name: 'Mobile Development',
                    subcategory: 'React Native'
                },
                client: {
                    country: 'Canada',
                    memberSince: '2019-05-20',
                    totalSpent: 25000,
                    hireRate: 92,
                    totalJobs: 12,
                    paymentVerified: true
                },
                skills: ['React Native', 'JavaScript', 'iOS', 'Android', 'Redux'],
                proposals: 12,
                postedTime: '2024-01-14T14:20:00Z',
                scrapedAt: new Date()
            }
        ];

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°é©ç”¨
        let filteredJobs = mockJobs;

        if (params.query) {
            const query = params.query.toLowerCase();
            filteredJobs = filteredJobs.filter(job =>
                job.title.toLowerCase().includes(query) ||
                job.description.toLowerCase().includes(query)
            );
        }

        if (params.jobType) {
            filteredJobs = filteredJobs.filter(job => job.jobType === params.jobType);
        }

        if (params.experienceLevel) {
            filteredJobs = filteredJobs.filter(job => job.experienceLevel === params.experienceLevel);
        }

        if (params.limit) {
            filteredJobs = filteredJobs.slice(0, params.limit);
        }

        return filteredJobs;
    }

    /**
     * æ¡ˆä»¶è©³ç´°ã‚’å–å¾—
     */
    async getJobDetails(jobId: string): Promise<UpworkJobData | null> {
        if (!this.isAuthenticated) {
            throw new Error('Not authenticated. Call authenticate() first.');
        }

        // TODO: å®Ÿéš›ã®APIå®Ÿè£…
        // ç¾åœ¨ã¯searchJobsã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢
        const jobs = await this.searchJobs({ limit: 100 });
        return jobs.find(job => job.id === jobId) || null;
    }
}

/**
 * é€šè²¨å¤‰æ›ã‚µãƒ¼ãƒ“ã‚¹
 */
class CurrencyService {
    private static readonly DEFAULT_USD_TO_JPY = 150; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ›ç®—ãƒ¬ãƒ¼ãƒˆ

    /**
     * USD ã‹ã‚‰ JPY ã¸ã®å¤‰æ›
     */
    static convertUSDToJPY(usdAmount: number, exchangeRate?: number): number {
        const rate = exchangeRate || this.DEFAULT_USD_TO_JPY;
        return Math.round(usdAmount * rate);
    }

    /**
     * JPY ã‹ã‚‰ USD ã¸ã®å¤‰æ›
     */
    static convertJPYToUSD(jpyAmount: number, exchangeRate?: number): number {
        const rate = exchangeRate || this.DEFAULT_USD_TO_JPY;
        return Math.round((jpyAmount / rate) * 100) / 100; // å°æ•°ç‚¹2æ¡ã¾ã§
    }

    /**
     * Upworkæ¡ˆä»¶ã®æ™‚çµ¦ã‚’JPYæ›ç®—
     */
    static calculateUpworkHourlyRateJPY(upworkJob: UpworkJobData, exchangeRate?: number): number | null {
        if (upworkJob.budget.type === 'hourly') {
            if (upworkJob.budget.min && upworkJob.budget.max) {
                const avgUSD = (upworkJob.budget.min + upworkJob.budget.max) / 2;
                return this.convertUSDToJPY(avgUSD, exchangeRate);
            } else if (upworkJob.budget.min) {
                return this.convertUSDToJPY(upworkJob.budget.min, exchangeRate);
            }
        }
        return null;
    }
}

/**
 * çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒã‚µãƒ¼ãƒ“ã‚¹
 */
class IntegratedJobSearchService {
    private crowdworksService?: any; // TODO: CrowdWorksServiceã®å‹å®šç¾©å¾Œã«æ›´æ–°
    private upworkService: UpworkService;
    private config: IntegratedSearchConfig;

    constructor(
        upworkCredentials: UpworkCredentials,
        config: IntegratedSearchConfig,
        crowdworksService?: any
    ) {
        this.upworkService = new UpworkService(upworkCredentials);
        this.config = config;
        this.crowdworksService = crowdworksService;
    }

    /**
     * çµ±åˆæ¡ˆä»¶æ¤œç´¢ã‚’å®Ÿè¡Œ
     */
    async searchJobs(params: {
        categories?: string[];
        minHourlyRateJPY?: number;
        maxJobsPerSource?: number;
        keywords?: string[];
    }): Promise<IntegratedJobSearchResult> {
        const startTime = Date.now();

        const result: IntegratedJobSearchResult = {
            crowdworks: {
                jobs: [],
                total: 0,
                success: false,
                executionTime: 0
            },
            upwork: {
                jobs: [],
                total: 0,
                success: false,
                executionTime: 0
            },
            summary: {
                totalJobs: 0,
                highHourlyJobs: 0,
                averageHourlyRate: 0,
                executionTime: 0,
                timestamp: new Date()
            }
        };

        // Upworkæ¤œç´¢å®Ÿè¡Œ
        if (this.config.enabled.upwork) {
            const upworkStartTime = Date.now();
            try {
                await this.upworkService.authenticate();

                const searchParams: Parameters<typeof this.upworkService.searchJobs>[0] = {
                    limit: params.maxJobsPerSource || this.config.limits.maxJobsPerSource
                };

                if (params.keywords && params.keywords.length > 0) {
                    searchParams.query = params.keywords.join(' ');
                }

                const upworkJobs = await this.upworkService.searchJobs(searchParams);

                result.upwork = {
                    jobs: upworkJobs,
                    total: upworkJobs.length,
                    success: true,
                    executionTime: Date.now() - upworkStartTime
                };

            } catch (error) {
                result.upwork = {
                    jobs: [],
                    total: 0,
                    success: false,
                    error: error instanceof Error ? error.message : 'Upwork search failed',
                    executionTime: Date.now() - upworkStartTime
                };
            }
        }

        // CrowdWorksæ¤œç´¢å®Ÿè¡Œï¼ˆå°†æ¥å®Ÿè£…ï¼‰
        if (this.config.enabled.crowdworks && this.crowdworksService) {
            const crowdworksStartTime = Date.now();
            try {
                // TODO: CrowdWorksServiceã¨ã®çµ±åˆ
                result.crowdworks = {
                    jobs: [],
                    total: 0,
                    success: true,
                    executionTime: Date.now() - crowdworksStartTime
                };
            } catch (error) {
                result.crowdworks = {
                    jobs: [],
                    total: 0,
                    success: false,
                    error: error instanceof Error ? error.message : 'CrowdWorks search failed',
                    executionTime: Date.now() - crowdworksStartTime
                };
            }
        }

        // ã‚µãƒãƒªãƒ¼è¨ˆç®—
        const allUpworkJobs = result.upwork.jobs;
        const minHourlyRate = params.minHourlyRateJPY || this.config.filtering.minHourlyRateJPY;

        let highHourlyCount = 0;
        let totalHourlyRates: number[] = [];

        // Upworkæ¡ˆä»¶ã®é«˜æ™‚çµ¦åˆ¤å®š
        allUpworkJobs.forEach(job => {
            const hourlyRateJPY = CurrencyService.calculateUpworkHourlyRateJPY(
                job,
                this.config.currency.exchangeRateUSDToJPY
            );

            if (hourlyRateJPY) {
                totalHourlyRates.push(hourlyRateJPY);
                if (hourlyRateJPY >= minHourlyRate) {
                    highHourlyCount++;
                }
            }
        });

        result.summary = {
            totalJobs: result.crowdworks.total + result.upwork.total,
            highHourlyJobs: highHourlyCount,
            averageHourlyRate: totalHourlyRates.length > 0
                ? Math.round(totalHourlyRates.reduce((a, b) => a + b, 0) / totalHourlyRates.length)
                : 0,
            executionTime: Date.now() - startTime,
            timestamp: new Date()
        };

        return result;
    }

    /**
     * é«˜æ™‚çµ¦æ¡ˆä»¶ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
     */
    filterHighValueJobs(
        result: IntegratedJobSearchResult,
        minHourlyRateJPY: number
    ): { crowdworks: JobData[]; upwork: UpworkJobData[] } {

        const highValueUpworkJobs = result.upwork.jobs.filter(job => {
            const hourlyRateJPY = CurrencyService.calculateUpworkHourlyRateJPY(
                job,
                this.config.currency.exchangeRateUSDToJPY
            );
            return hourlyRateJPY && hourlyRateJPY >= minHourlyRateJPY;
        });

        // TODO: CrowdWorksæ¡ˆä»¶ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…

        return {
            crowdworks: [], // TODO: å®Ÿè£…å¾Œã«æ›´æ–°
            upwork: highValueUpworkJobs
        };
    }

    /**
     * çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
     */
    async generateReport(params: {
        minHourlyRate: number;
        categories: string[];
        maxJobsPerSource: number;
    }): Promise<IntegratedJobReport> {

        const searchResult = await this.searchJobs({
            categories: params.categories,
            minHourlyRateJPY: params.minHourlyRate,
            maxJobsPerSource: params.maxJobsPerSource
        });

        const highValueJobs = this.filterHighValueJobs(searchResult, params.minHourlyRate);

        return {
            id: `report-${Date.now()}`,
            generatedAt: new Date(),
            criteria: {
                minHourlyRate: params.minHourlyRate,
                categories: params.categories,
                maxJobsPerSource: params.maxJobsPerSource
            },
            results: searchResult,
            highValueJobs,
            analysis: {
                marketTrends: this.generateMarketAnalysis(searchResult),
                recommendations: this.generateRecommendations(highValueJobs),
                alerts: this.generateAlerts(searchResult)
            }
        };
    }

    private generateMarketAnalysis(result: IntegratedJobSearchResult): string {
        const { summary } = result;

        if (summary.totalJobs === 0) {
            return 'æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
        }

        const highValueRatio = (summary.highHourlyJobs / summary.totalJobs * 100).toFixed(1);

        return `ç·æ¡ˆä»¶æ•°: ${summary.totalJobs}ä»¶ã€é«˜æ™‚çµ¦æ¡ˆä»¶ç‡: ${highValueRatio}%ã€å¹³å‡æ™‚çµ¦: ${summary.averageHourlyRate.toLocaleString()}å††`;
    }

    private generateRecommendations(highValueJobs: { crowdworks: JobData[]; upwork: UpworkJobData[] }): string[] {
        const recommendations: string[] = [];

        if (highValueJobs.upwork.length > 0) {
            recommendations.push(`Upworkã§${highValueJobs.upwork.length}ä»¶ã®é«˜æ™‚çµ¦æ¡ˆä»¶ã‚’ç™ºè¦‹`);

            // ã‚¹ã‚­ãƒ«åˆ†æ
            const skillCounts: { [skill: string]: number } = {};
            highValueJobs.upwork.forEach(job => {
                job.skills.forEach(skill => {
                    skillCounts[skill] = (skillCounts[skill] || 0) + 1;
                });
            });

            const topSkills = Object.entries(skillCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 3)
                .map(([skill]) => skill);

            if (topSkills.length > 0) {
                recommendations.push(`éœ€è¦ã®é«˜ã„ã‚¹ã‚­ãƒ«: ${topSkills.join(', ')}`);
            }
        }

        if (recommendations.length === 0) {
            recommendations.push('ç¾åœ¨ã€æ¡ä»¶ã«åˆã†é«˜æ™‚çµ¦æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }

        return recommendations;
    }

    private generateAlerts(result: IntegratedJobSearchResult): string[] {
        const alerts: string[] = [];

        if (!result.upwork.success) {
            alerts.push(`Upworkæ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${result.upwork.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
        }

        if (!result.crowdworks.success) {
            alerts.push(`CrowdWorksæ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${result.crowdworks.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
        }

        if (result.summary.totalJobs === 0) {
            alerts.push('æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ¤œç´¢æ¡ä»¶ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }

        return alerts;
    }
}

// Services module exports
export { UpworkService, CurrencyService, IntegratedJobSearchService };
export { AppliedJobsService } from './AppliedJobsService';
export { LancersService } from './LancersService';
</file>

<file path="src/services/LancersService.ts">
import { Page } from 'playwright';

export interface LancersJob {
    title: string;
    url: string;
    category: string;
    budget: string;
    description: string;
    applicantCount: string;
    clientName: string;
    contractCount: string;
    postedDate: string;
}

export interface LancersJobDetail extends LancersJob {
    detailedDescription: string;
    paymentType: string;
    deliveryDate: string;
    applicationDeadline: string;
    client: {
        name: string;
        overallRating: string;
        orderHistory: string;
        completionRate: string;
    };
}

export interface LancersScrapingResult {
    jobs: LancersJob[];
    jobDetails: LancersJobDetail[];
}

/**
 * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶å–å¾—ã‚µãƒ¼ãƒ“ã‚¹
 */
export class LancersService {
    private page: Page;
    private _isLoggedIn: boolean = false;

    constructor(page: Page) {
        this.page = page;
    }

    get isLoggedIn(): boolean {
        return this._isLoggedIn;
    }

    /**
     * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã«ãƒ­ã‚°ã‚¤ãƒ³
     */
    async login(email: string, password: string): Promise<boolean> {
        try {
            console.log('ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã«ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•
            await this.page.goto('https://www.lancers.jp/user/login', { 
                waitUntil: 'networkidle', 
                timeout: 30000 
            });

            // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
            const emailSelector = 'input[name="login_name"], input[type="email"], #loginUserName';
            await this.page.waitForSelector(emailSelector, { timeout: 10000 });
            await this.page.fill(emailSelector, email);

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
            const passwordSelector = 'input[name="password"], input[type="password"], #loginPassword';
            await this.page.fill(passwordSelector, password);

            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            const loginButtonSelector = 'button[type="submit"], input[type="submit"], .login-button';
            await this.page.click(loginButtonSelector);

            // ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã‚’å¾…æ©Ÿ
            await this.page.waitForURL(url => !url.toString().includes('/user/login'), { timeout: 15000 });
            
            this._isLoggedIn = true;
            console.log('âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
            return true;
            
        } catch (error) {
            console.error('âŒ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
            this._isLoggedIn = false;
            return false;
        }
    }

    /**
     * æ¡ˆä»¶ãƒªã‚¹ãƒˆã‚’å–å¾—
     */
    async scrapeJobs(category: string, maxJobs: number): Promise<LancersJob[]> {
        try {
            console.log(`ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã€Œ${category}ã€ã‚«ãƒ†ã‚´ãƒªã§æ¡ˆä»¶å–å¾—ä¸­...`);
            
            // ã‚«ãƒ†ã‚´ãƒªURLã®æ§‹ç¯‰
            const categoryUrls: { [key: string]: string } = {
                'system': 'https://www.lancers.jp/work/search/system?open=1',
                'web': 'https://www.lancers.jp/work/search/web?open=1', 
                'app': 'https://www.lancers.jp/work/search/system/mobile?open=1',
                'design': 'https://www.lancers.jp/work/search/design?open=1'
            };
            
            const url = categoryUrls[category] || categoryUrls['system'];
            if (!url) {
                throw new Error(`æœªå¯¾å¿œã®ã‚«ãƒ†ã‚´ãƒª: ${category}`);
            }
            
            await this.page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });
            
            // æ¡ˆä»¶ãƒªã‚¹ãƒˆã‚’å–å¾—
            const jobs = await this.page.evaluate(({ maxJobs, category }) => {
                const jobs: any[] = [];
                
                // æ¡ˆä»¶è©³ç´°ãƒªãƒ³ã‚¯ã‚’æŒã¤è¦ç´ ã‚’å–å¾—
                const jobLinks = document.querySelectorAll('a[href*="/work/detail/"]');
                console.log(`æ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°: ${jobLinks.length}`);
                
                let count = 0;
                jobLinks.forEach((link: Element, index: number) => {
                    if (count >= maxJobs) return;
                    
                    try {
                        const href = link.getAttribute('href');
                        if (!href || !href.includes('/work/detail/')) return;
                        
                        // ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
                        let title = link.textContent?.trim() || '';
                        
                        // NEW, åˆå›, 2å›ç›®ãªã©ã®ãƒ©ãƒ™ãƒ«ã‚’é™¤å»
                        title = title.replace(/^(NEW|åˆå›|\d+å›ç›®)\s*/, '').trim();
                        
                        if (!title || title.length < 5) return;
                        
                        // å®Œå…¨ãªURLã‚’æ§‹ç¯‰
                        const fullUrl = href.startsWith('http') ? href : `https://www.lancers.jp${href}`;
                        
                        // è¦ªè¦ç´ ã‹ã‚‰ä¾¡æ ¼æƒ…å ±ã‚’å–å¾—
                        let budget = '';
                        let parentElement = link.parentElement;
                        while (parentElement && !budget) {
                            const text = parentElement.textContent || '';
                            const priceMatch = text.match(/([\d,]+)\s*å††/);
                            if (priceMatch) {
                                budget = priceMatch[0];
                                break;
                            }
                            parentElement = parentElement.parentElement;
                            if (!parentElement || parentElement === document.body) break;
                        }
                        
                        // èª¬æ˜æ–‡ã‚’å–å¾—
                        let description = '';
                        parentElement = link.parentElement;
                        while (parentElement && !description) {
                            const textNodes = Array.from(parentElement.childNodes)
                                .filter(node => node.nodeType === Node.TEXT_NODE)
                                .map(node => node.textContent?.trim())
                                .filter(text => text && text.length > 30);
                            
                            if (textNodes.length > 0 && textNodes[0]) {
                                const firstText = textNodes[0];
                                description = firstText.length > 200 
                                    ? firstText.substring(0, 200) + '...' 
                                    : firstText;
                                break;
                            }
                            parentElement = parentElement.parentElement;
                            if (!parentElement || parentElement === document.body) break;
                        }
                        
                        const job = {
                            title: title,
                            url: fullUrl,
                            category: category,
                            budget: budget,
                            description: description,
                            applicantCount: '0',
                            clientName: '',
                            contractCount: '0',
                            postedDate: ''
                        };
                        
                        console.log(`æ¡ˆä»¶${count + 1}: ${title}`);
                        jobs.push(job);
                        count++;
                        
                    } catch (error) {
                        console.log(`æ¡ˆä»¶è§£æã‚¨ãƒ©ãƒ¼ (${index}):`, error);
                    }
                });
                
                console.log(`æœ€çµ‚çš„ã«å–å¾—ã•ã‚ŒãŸæ¡ˆä»¶æ•°: ${jobs.length}`);
                return jobs;
                
            }, { maxJobs, category });
            
            console.log(`âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‹ã‚‰${jobs.length}ä»¶ã®æ¡ˆä»¶ã‚’å–å¾—ã—ã¾ã—ãŸ`);
            return jobs;
            
        } catch (error) {
            console.error('æ¡ˆä»¶å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            throw error;
        }
    }

    /**
     * æ¡ˆä»¶è©³ç´°ã‚’å–å¾—
     */
    async scrapeJobDetail(url: string): Promise<LancersJobDetail | null> {
        try {
            console.log(`ğŸ“‹ è©³ç´°å–å¾—ä¸­: ${url}`);
            
            await this.page.goto(url, { waitUntil: 'networkidle', timeout: 30000 });
            
            const detail = await this.page.evaluate(() => {
                const getTextContent = (selector: string): string => {
                    const element = document.querySelector(selector);
                    return element?.textContent?.trim() || '';
                };
                
                // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
                const title = getTextContent('h1') || document.title;
                
                // è©³ç´°èª¬æ˜å–å¾—
                const detailedDescription = getTextContent('.work-detail-description, .description, .content') ||
                                          document.body.textContent?.substring(0, 1000) || '';
                
                return {
                    title: title,
                    url: window.location.href,
                    category: '',
                    budget: '',
                    description: '',
                    applicantCount: '0',
                    clientName: '',
                    contractCount: '0',
                    postedDate: '',
                    detailedDescription: detailedDescription,
                    paymentType: '',
                    deliveryDate: '',
                    applicationDeadline: '',
                    client: {
                        name: '',
                        overallRating: '',
                        orderHistory: '',
                        completionRate: ''
                    }
                };
            });
            
            return detail;
            
        } catch (error) {
            console.error(`è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ${url}`, error);
            return null;
        }
    }

      /**
   * äºˆç®—é¡ã‚’æ•°å€¤ã§æŠ½å‡º
   */
  // private extractBudgetAmount(budget: string): number {
  //   if (!budget) return 0;
  //   
  //   // ã€Œï½ã€ã‚„ã€Œ-ã€ã§åŒºåˆ‡ã‚‰ã‚ŒãŸç¯„å›²ã®å ´åˆã¯ä¸Šé™å€¤ã‚’å–å¾—
  //   const rangeMatch = budget.match(/([0-9,]+)\s*å††\s*[~ï½-]\s*([0-9,]+)\s*å††/);
  //   if (rangeMatch && rangeMatch[1] && rangeMatch[2]) {
  //     const min = parseInt(rangeMatch[1].replace(/,/g, '')) || 0;
  //     const max = parseInt(rangeMatch[2].replace(/,/g, '')) || 0;
  //     return Math.max(min, max); // ä¸Šé™å€¤ã‚’è¿”ã™
  //   }
  //   
  //   // å˜ä¸€ã®é‡‘é¡
  //   const singleMatch = budget.match(/([0-9,]+)\s*å††/);
  //   if (singleMatch && singleMatch[1]) {
  //     return parseInt(singleMatch[1].replace(/,/g, '')) || 0;
  //   }
  //   
  //   return 0;
  // }
}
</file>

<file path=".eslintrc.js">
module.exports = {
    parser: '@typescript-eslint/parser',
    parserOptions: {
        ecmaVersion: 2022,
        sourceType: 'module',
    },
    env: {
        node: true,
        es2022: true
    },
    plugins: [
        '@typescript-eslint'
    ],
    extends: [
        'eslint:recommended'
    ],
    rules: {
        // anyå‹ã‚’å³æ ¼ã«ç¦æ­¢
        '@typescript-eslint/no-explicit-any': 'error',
        '@typescript-eslint/no-unused-vars': ['error', {
            argsIgnorePattern: '^_',
            varsIgnorePattern: '^_'
        }],

        // General rules
        'no-console': 'off', // é–‹ç™ºä¸­ã¯è¨±å¯
        'no-debugger': 'error',
        'prefer-const': 'error',
        'no-var': 'error'
    },
    ignorePatterns: [
        'dist/',
        'node_modules/',
        'cdk.out/',
        '*.js',
        '*.d.ts'
    ]
};
</file>

<file path="Dockerfile">
# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM node:18-alpine as base

# å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    chromium \
    && rm -rf /var/cache/apk/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# package.jsonã¨package-lock.jsonã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
COPY package*.json ./

# === ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM base as dependencies

# å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm ci

# === ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as build

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# TypeScriptã®ãƒ“ãƒ«ãƒ‰
RUN npm run build

# ä¸è¦ãªdevDependenciesã‚’å‰Šé™¤
RUN npm prune --production

# === ãƒ†ã‚¹ãƒˆç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as test

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# TypeScriptã®ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
RUN npm run build

# Playwrightã®è¨­å®š
ENV PLAYWRIGHT_BROWSERS_PATH=/usr/bin/chromium-browser
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
CMD ["npm", "run", "test:coverage"]

# === é–‹ç™ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as development

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# é–‹ç™ºç”¨ã®ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 3000 9229

# é–‹ç™ºç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰
CMD ["npm", "run", "dev"]

# === æœ¬ç•ªç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM node:18-alpine as production

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# æœ¬ç•ªç”¨ã®æœ€å°é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache dumb-init

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¨æœ¬ç•ªç”¨ä¾å­˜é–¢ä¿‚ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=build --chown=nextjs:nodejs /app/dist ./dist
COPY --from=build --chown=nextjs:nodejs /app/node_modules ./node_modules
COPY --from=build --chown=nextjs:nodejs /app/package.json ./package.json

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER nextjs

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¿½åŠ 
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node --version || exit 1

# æœ¬ç•ªç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰
CMD ["dumb-init", "node", "dist/index.js"]
</file>

<file path="src/types/index.ts">
// æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹ï¼ˆè»½é‡ç‰ˆï¼‰
export interface JobData {
  id: string; // æ¡ˆä»¶IDï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  title: string; // æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«
  description: string; // æ¡ˆä»¶è©³ç´°ï¼ˆæœ€å¤§500æ–‡å­—ï¼‰
  url: string; // æ¡ˆä»¶URL
  budget: number; // äºˆç®—ï¼ˆå††ï¼‰
  deadline: Date; // ç´æœŸ
  workType: 'fixed' | 'hourly'; // å›ºå®šå ±é…¬ or æ™‚é–“å˜ä¾¡
  category: string; // ã‚«ãƒ†ã‚´ãƒª
  clientName: string; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
  clientRating: number; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡ï¼ˆ1-5ï¼‰
  clientReviews: number; // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°
  skills: string[]; // å¿…è¦ã‚¹ã‚­ãƒ«ï¼ˆæœ€å¤§5å€‹ï¼‰
  experience: 'beginner' | 'intermediate' | 'expert'; // çµŒé¨“ãƒ¬ãƒ™ãƒ«
  scrapedAt: Date; // å–å¾—æ—¥æ™‚
  source: 'crowdworks' | 'upwork'; // å–å¾—å…ƒï¼ˆæ‹¡å¼µæ¸ˆã¿ï¼‰
}

// è©•ä¾¡çµæœå‹ï¼ˆè»½é‡ç‰ˆï¼‰
export interface JobEvaluation {
  jobId: string; // å¯¾è±¡æ¡ˆä»¶ID
  evaluatedAt: Date; // è©•ä¾¡æ—¥æ™‚
  score: number; // ãŠã™ã™ã‚åº¦ï¼ˆ1-10ï¼‰
  reason: string; // è©•ä¾¡ç†ç”±ï¼ˆæœ€å¤§50æ–‡å­—ï¼‰
  aiModel: 'gpt-3.5-turbo'; // ä½¿ç”¨AIãƒ¢ãƒ‡ãƒ«
  tokenUsed: number; // ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  costEstimate: number; // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  strengths: string[]; // å¼·ã¿ï¼ˆæœ€å¤§3å€‹ï¼‰
  concerns: string[]; // æ‡¸å¿µç‚¹ï¼ˆæœ€å¤§3å€‹ï¼‰
}

// å®Ÿè¡Œãƒ­ã‚°å‹
export interface ExecutionLog {
  executionId: string; // å®Ÿè¡ŒIDï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ï¼‰
  timestamp: string; // å®Ÿè¡Œé–‹å§‹æ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰
  status: 'success' | 'error' | 'partial'; // å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  duration: number; // å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  jobsScraped: number; // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä»¶æ•°
  newJobs: number; // æ–°è¦æ¡ˆä»¶æ•°
  aiEvaluated: number; // AIè©•ä¾¡ä»¶æ•°
  highScoreJobs: number; // é«˜è©•ä¾¡æ¡ˆä»¶æ•°ï¼ˆé–¾å€¤ä»¥ä¸Šï¼‰
  costEstimate: number; // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  error?: {
    type: string; // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—
    message: string; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    stack?: string; // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
  };
}

// ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå‹
export interface SystemConfig {
  scraping: {
    maxJobsPerExecution: number;
    preFilterEnabled: boolean;
    minBudget: number;
    minClientRating: number;
    maxDescriptionLength: number;
  };
  ai: {
    enabled: boolean;
    model: 'gpt-3.5-turbo';
    maxJobsForEvaluation: number;
    monthlyBudgetLimit: number;
    maxTokensPerRequest: number;
    temperature: number;
  };
  notification: {
    enabled: boolean;
    scoreThreshold: number;
    errorNotificationEnabled: boolean;
    dailySummaryEnabled: boolean;
  };
  storage: {
    retentionDays: number;
    compressionEnabled: boolean;
    backupEnabled: boolean;
  };
  performance: {
    timeoutSeconds: number;
    retryCount: number;
    concurrentLimit: number;
  };
}

// æ¤œç´¢æ¡ä»¶å‹
export interface SearchCondition {
  id: string;
  name: string;
  enabled: boolean;
  keywords: string[];
  budgetMin: number;
  budgetMax: number;
  category: string;
  workType: 'fixed' | 'hourly' | 'both';
  clientRatingMin: number;
  experienceLevel: 'beginner' | 'intermediate' | 'expert' | 'any';
  excludeKeywords: string[];
  excludeClients: string[];
}

// æ¤œç´¢æ¡ä»¶è¨­å®šå‹
export interface SearchConditions {
  version: string;
  lastUpdated: Date;
  conditions: SearchCondition[];
}

// ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼æƒ…å ±å‹
export interface LoginCredentials {
  email: string;
  password: string;
}

// Lambda ã‚¤ãƒ™ãƒ³ãƒˆå‹
export interface ScheduledExecutionEvent {
  source: string;
  'detail-type': string;
  detail: Record<string, any>;
  time?: string; // ISOå½¢å¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
}

// Lambda ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ï¼ˆæ–°å½¢å¼ï¼‰
export interface ScheduledExecutionResponse {
  statusCode: number; // HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰
  body: string; // JSONæ–‡å­—åˆ—ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  executionTime: number; // å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  timestamp: string; // ISOå½¢å¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
}

// Playwrightå‹•ä½œç¢ºèªçµæœå‹
export interface PlaywrightTestResult {
  success: boolean;
  chromiumVersion?: string;
  title?: string;
  screenshot?: boolean;
  error?: string;
  executionTime: number;
}

// Lambdaå®Ÿè¡Œçµæœå‹ï¼ˆæ–°å½¢å¼ï¼‰
export interface LambdaExecutionResult {
  phases: {
    playwright: PlaywrightTestResult;
    crowdworksLogin: {
      success: boolean;
      loginResult?: CrowdWorksLoginResult;
      error?: string;
      executionTime: number;
    };
    crowdworksScraping: {
      success: boolean;
      scrapingResult?: any; // å®Ÿè£…æ™‚ã«è©³ç´°å‹ã‚’è¿½åŠ 
      error?: string;
      executionTime: number;
    };
  };
  executionTime: number;
  timestamp: string;
}

// Lambda ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
export interface LambdaErrorResponse {
  message: string;
  error: string;
  requestId: string;
  timestamp: string;
}

// æ—§å½¢å¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼‰
export interface LegacyScheduledExecutionResponse {
  status: 'success' | 'error' | 'partial';
  executionId: string;
  timestamp: string;
  results: {
    jobsScraped: number;
    newJobs: number;
    aiEvaluated: number;
    highScoreJobs: number;
    duration: number;
    costEstimate: number;
  };
  error?: {
    type: string;
    message: string;
  };
}

// ã‚¨ãƒ©ãƒ¼å‹
export enum ErrorType {
  AUTHENTICATION_ERROR = 'AUTH_ERROR',
  LAMBDA_TIMEOUT = 'LAMBDA_TIMEOUT',
  S3_ACCESS_ERROR = 'S3_ACCESS_ERROR',
  SCRAPING_ERROR = 'SCRAPING_ERROR',
  AI_API_ERROR = 'AI_API_ERROR',
  NETWORK_ERROR = 'NETWORK_ERROR',
}

export class AppError extends Error {
  constructor(
    public type: ErrorType,
    message: string,
    public retryable: boolean = false
  ) {
    super(message);
    this.name = 'AppError';
  }
}

// CrowdWorksèªè¨¼æƒ…å ±
export interface CrowdWorksCredentials {
  email: string;
  password: string;
}

// CrowdWorksãƒ­ã‚°ã‚¤ãƒ³çµæœ
export interface CrowdWorksLoginResult {
  success: boolean;
  isLoggedIn: boolean;
  error?: string;
  executionTime: number;
}

// ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã‚«ãƒ†ã‚´ãƒªå‹
export type CrowdWorksCategory =
  | 'ec'
  | 'web_products'
  | 'software_development'
  | 'development'
  | 'writing'
  | 'translation'
  | 'marketing'
  | 'system_development'
  | 'app_development'
  | 'data_entry'
  | 'others';

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå®šæ•°
export const DEFAULT_CONFIG = {
  MAX_JOBS_PER_CATEGORY: 50,
  MAX_DETAILS_PER_CATEGORY: 50,
  ALL_CATEGORIES: [
    'ec',
    'web_products',
    'software_development',
    'development',
    'writing',
    'translation',
    'marketing',
    'system_development',
    'app_development'
  ] as const satisfies readonly CrowdWorksCategory[]
} as const;

// Upworkå°‚ç”¨æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹
export interface UpworkJobData {
  id: string; // Upworkæ¡ˆä»¶ID
  title: string; // æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«
  description: string; // æ¡ˆä»¶è©³ç´°
  url: string; // Upworkæ¡ˆä»¶URL
  budget: {
    type: 'fixed' | 'hourly'; // å›ºå®šä¾¡æ ¼ or æ™‚é–“å˜ä¾¡
    amount?: number; // å›ºå®šä¾¡æ ¼ã®å ´åˆã®é‡‘é¡ï¼ˆUSDï¼‰
    min?: number; // æ™‚é–“å˜ä¾¡ã®å ´åˆã®æœ€å°é‡‘é¡ï¼ˆUSDï¼‰
    max?: number; // æ™‚é–“å˜ä¾¡ã®å ´åˆã®æœ€å¤§é‡‘é¡ï¼ˆUSDï¼‰
  };
  duration: string; // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœŸé–“ï¼ˆ"Less than 1 month"ç­‰ï¼‰
  experienceLevel: 'entry' | 'intermediate' | 'expert'; // çµŒé¨“ãƒ¬ãƒ™ãƒ«
  jobType: 'fixed-price' | 'hourly'; // æ¡ˆä»¶ã‚¿ã‚¤ãƒ—
  category: {
    name: string; // ã‚«ãƒ†ã‚´ãƒªå
    subcategory?: string; // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒª
  };
  client: {
    country?: string; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å›½
    memberSince?: string; // ç™»éŒ²æ—¥
    totalSpent?: number; // ç·æ”¯æ‰•é¡ï¼ˆUSDï¼‰
    hireRate?: number; // æ¡ç”¨ç‡ï¼ˆ%ï¼‰
    totalJobs?: number; // ç·æ¡ˆä»¶æŠ•ç¨¿æ•°
    avgHourlyPaid?: number; // å¹³å‡æ™‚çµ¦æ”¯æ‰•é¡ï¼ˆUSDï¼‰
    paymentVerified: boolean; // æ”¯æ‰•ã„èªè¨¼æ¸ˆã¿
  };
  skills: string[]; // å¿…è¦ã‚¹ã‚­ãƒ«
  proposals: number; // ææ¡ˆæ•°
  postedTime: string; // æŠ•ç¨¿æ™‚é–“
  scrapedAt: Date; // å–å¾—æ—¥æ™‚
}

// Upwork APIèªè¨¼æƒ…å ±å‹
export interface UpworkCredentials {
  consumerKey: string;
  consumerSecret: string;
  accessToken?: string;
  accessTokenSecret?: string;
  // OAuth2ç”¨ï¼ˆå°†æ¥å¯¾å¿œï¼‰
  clientId?: string;
  clientSecret?: string;
  refreshToken?: string;
}

// Upworkãƒ­ã‚°ã‚¤ãƒ³çµæœå‹
export interface UpworkLoginResult {
  success: boolean;
  isAuthenticated: boolean;
  accessToken?: string;
  error?: string;
  executionTime: number;
}

// çµ±åˆæ¡ˆä»¶æ¤œç´¢çµæœå‹
export interface IntegratedJobSearchResult {
  crowdworks: {
    jobs: JobData[];
    total: number;
    success: boolean;
    error?: string;
    executionTime: number;
  };
  upwork: {
    jobs: UpworkJobData[];
    total: number;
    success: boolean;
    error?: string;
    executionTime: number;
  };
  summary: {
    totalJobs: number;
    highHourlyJobs: number; // æ™‚çµ¦ä¸€å®šä»¥ä¸Šã®æ¡ˆä»¶æ•°
    averageHourlyRate: number; // å¹³å‡æ™‚çµ¦ï¼ˆå††æ›ç®—ï¼‰
    executionTime: number;
    timestamp: Date;
  };
}

// çµ±åˆæ¡ˆä»¶ãƒ¬ãƒãƒ¼ãƒˆå‹
export interface IntegratedJobReport {
  id: string; // ãƒ¬ãƒãƒ¼ãƒˆID
  generatedAt: Date; // ç”Ÿæˆæ—¥æ™‚
  criteria: {
    minHourlyRate: number; // æœ€ä½æ™‚çµ¦æ¡ä»¶ï¼ˆå††ï¼‰
    categories: string[]; // å¯¾è±¡ã‚«ãƒ†ã‚´ãƒª
    maxJobsPerSource: number; // ã‚½ãƒ¼ã‚¹æ¯ã®æœ€å¤§å–å¾—ä»¶æ•°
  };
  results: IntegratedJobSearchResult;
  highValueJobs: {
    crowdworks: JobData[];
    upwork: UpworkJobData[];
  };
  analysis: {
    marketTrends: string; // å¸‚å ´å‹•å‘åˆ†æ
    recommendations: string[]; // ãŠã™ã™ã‚æ¡ˆä»¶ã®ç†ç”±
    alerts: string[]; // æ³¨æ„äº‹é …
  };
}

// çµ±åˆæ¤œç´¢è¨­å®šå‹
export interface IntegratedSearchConfig {
  enabled: {
    crowdworks: boolean;
    upwork: boolean;
  };
  limits: {
    maxJobsPerSource: number;
    maxExecutionTime: number; // ç§’
  };
  filtering: {
    minHourlyRateJPY: number; // æœ€ä½æ™‚çµ¦ï¼ˆå††ï¼‰
    minBudgetJPY: number; // æœ€ä½äºˆç®—ï¼ˆå††ï¼‰
    excludeKeywords: string[]; // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    requiredSkills: string[]; // å¿…é ˆã‚¹ã‚­ãƒ«
  };
  currency: {
    exchangeRateUSDToJPY: number; // USDâ†’JPYæ›ç®—ãƒ¬ãƒ¼ãƒˆ
    lastUpdated: Date; // ãƒ¬ãƒ¼ãƒˆæ›´æ–°æ—¥
  };
}
</file>

<file path="tsconfig.json">
{
    "compilerOptions": {
        "target": "ES2022",
        "module": "commonjs",
        "lib": [
            "ES2022",
            "DOM"
        ],
        "types": [
            "node"
        ],
        "rootDir": "./src",
        "outDir": "./dist",
        "removeComments": true,
        "declaration": true,
        "declarationMap": true,
        "sourceMap": true,
        "strict": true,
        "noImplicitAny": true,
        "strictNullChecks": true,
        "strictFunctionTypes": true,
        "strictBindCallApply": true,
        "strictPropertyInitialization": true,
        "noImplicitReturns": true,
        "noFallthroughCasesInSwitch": true,
        "noUncheckedIndexedAccess": true,
        "noImplicitOverride": true,
        "exactOptionalPropertyTypes": true,
        "noPropertyAccessFromIndexSignature": true,
        "noUnusedLocals": true,
        "noUnusedParameters": true,
        "allowUnreachableCode": false,
        "allowUnusedLabels": false,
        "esModuleInterop": true,
        "allowSyntheticDefaultImports": true,
        "forceConsistentCasingInFileNames": true,
        "moduleResolution": "node",
        "resolveJsonModule": true,
        "isolatedModules": true,
        "skipLibCheck": true,
        "experimentalDecorators": true,
        "emitDecoratorMetadata": true,
        "baseUrl": "./",
        "paths": {
            "@/*": [
                "src/*"
            ],
            "@/types/*": [
                "src/types/*"
            ],
            "@/services/*": [
                "src/services/*"
            ],
            "@/utils/*": [
                "src/utils/*"
            ],
            "@/infrastructure/*": [
                "src/infrastructure/*"
            ]
        }
    },
    "include": [
        "src/**/*"
    ],
    "exclude": [
        "node_modules",
        "dist",
        "cdk.out",
        "test",
        "**/*.test.ts",
        "**/*.spec.ts",
        "*.js"
    ],
    "ts-node": {
        "require": [
            "tsconfig-paths/register"
        ],
        "compilerOptions": {
            "module": "commonjs"
        }
    }
}
</file>

<file path=".github/workflows/ci.yml">
name: CI/CD Pipeline

# GitHub Actionsã®æ¨©é™è¨­å®š
permissions:
  contents: read
  security-events: write
  id-token: write # OIDCèªè¨¼ç”¨

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  AWS_REGION: 'ap-northeast-1'

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæœ€é€Ÿå®Ÿè¡Œï¼‰
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint check
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: TypeScript type check
        run: npm run type-check

  # å˜ä½“ãƒ†ã‚¹ãƒˆ
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          token: ${{ secrets.CODECOV_TOKEN }}

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Verify build output
        run: |
          echo "=== Checking build output ==="
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist directory not found"
            exit 1
          fi
          
          # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          main_files=("dist/index.js" "dist/lambda/handler.js")
          for file in "${main_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            else
              echo "âš ï¸  Not found: $file"
            fi
          done
          
          echo "Contents of dist directory:"
          find dist -name "*.js" -type f | head -10
          echo "âœ… Build verification completed"

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # CDKæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  cdk-synth:
    name: CDK Synth Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: CDK Synth (dry-run)
        run: npm run cdk:synth
        env:
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-test
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t crowdworks-searcher:test .
          echo "âœ… Docker build completed successfully"

      - name: Test Docker container
        run: |
          docker run --rm crowdworks-searcher:test node --version
          echo "âœ… Docker container test passed"

  # Staging ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆdevelopãƒ–ãƒ©ãƒ³ãƒï¼‰
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, build-test, cdk-synth, docker-build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Staging)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.STAGING_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Staging

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to Staging with CDK
        run: |
          npm run cdk:deploy:staging
        env:
          STAGE: staging
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}

      - name: Post-deployment verification
        run: |
          echo "Verifying staging deployment..."
          # Lambdaé–¢æ•°ã®å­˜åœ¨ç¢ºèª
          aws lambda get-function --function-name crowdworks-searcher-staging-main
          echo "âœ… Staging deployment verified"

      - name: Slack notification (Staging)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Production ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒï¼‰
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [unit-tests, build-test, cdk-synth, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://production.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Production)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PRODUCTION_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Production

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to Production with CDK
        run: |
          npm run cdk:deploy:production
        env:
          STAGE: production
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}

      - name: Post-deployment verification
        run: |
          echo "Verifying production deployment..."
          # Lambdaé–¢æ•°ã®å­˜åœ¨ç¢ºèª
          aws lambda get-function --function-name crowdworks-searcher-production-main
          # CloudWatch Logsç¢ºèª
          aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/crowdworks-searcher-production"
          echo "âœ… Production deployment verified"

      - name: Create deployment tag
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git tag -a "v$(date +%Y%m%d_%H%M%S)" -m "Production deployment $(date)"
          git push origin --tags

      - name: Slack notification (Production)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆworkflow_dispatchï¼‰
  deploy-manual:
    name: Manual Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_AWS_ROLE_ARN || secrets.STAGING_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Manual

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy with CDK
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            npm run cdk:deploy:production
          else
            npm run cdk:deploy:staging
          fi
        env:
          STAGE: ${{ github.event.inputs.environment }}
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}

  # é€šçŸ¥ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, build-test, cdk-synth, security-scan]
    if: failure()
    
    steps:
      - name: Notify failure
        run: |
          echo "âŒ CI/CD Pipeline failed"
          echo "Workflow: ${{ github.workflow }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          # TODO: Slack/Discordé€šçŸ¥ã‚’å®Ÿè£…
</file>

<file path="scripts/calculate-recommendation-score.ts">
require('dotenv').config();

import { readFileSync, writeFileSync, existsSync, unlinkSync } from 'fs';
import OpenAI from 'openai';
// import { chromium } from 'playwright';
// import { AppliedJobsService } from '../src/services/AppliedJobsService';
// import { CrowdWorksCredentials } from '../src/types';

// å‹å®šç¾©
interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    é›£æ˜“åº¦: string;
    gpt_summary: string;
    category?: string;
}

interface ScoredJob extends AnalysisResult {
    hourly_rate_numeric: number;
    workload_hours: number;
    difficulty_score: number;
    skill_fit_score: number;
    recommendation_score: number;
    link: string;
    original_title?: string;
    proposal_greeting?: string;
    specification_questions?: string;
    skill_analysis?: string;
    proposal_amount?: number; // ææ¡ˆé‡‘é¡
    estimated_finish_date?: string; // å®Œäº†äºˆå®šæ—¥ï¼ˆISOæ–‡å­—åˆ—ï¼‰
    delivery_estimate?: string; // ç´æœŸè¦‹è¾¼ã¿
}

// å‡¦ç†æ¸ˆã¿æ¡ˆä»¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ³ã‚¿ãƒ¼face
interface ProcessedJobCache {
    jobId: string;
    skill_fit_score: number;
    skill_analysis: string;
    proposal_greeting: string;
    delivery_estimate: string;
    specification_questions: string;
    processed_at: string;
}

// .envã‹ã‚‰APIã‚­ãƒ¼å–å¾—
const apiKey = process.env['OPENAI_API_KEY'];
if (!apiKey) {
    console.error('âŒ OPENAI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    process.exit(1);
}

const openai = new OpenAI({ apiKey });

// æ™‚çµ¦æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function parseHourlyRate(hourlyRateString: string): number {
    if (!hourlyRateString || hourlyRateString.trim() === '' || hourlyRateString === '0å††') {
        return 0;
    }

    const match = hourlyRateString.match(/([0-9,]+)/);
    if (match && match[1]) {
        const numericString = match[1].replace(/,/g, '');
        return parseInt(numericString, 10);
    }

    return 0;
}

// å·¥æ•°æ–‡å­—åˆ—ã‚’æ•°å€¤ï¼ˆæ™‚é–“ï¼‰ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function parseWorkloadHours(workloadString: string): number {
    if (!workloadString || workloadString.trim() === '') {
        return 40; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    }

    // ã€Œ120æ™‚é–“ã€ã€Œ2é€±é–“ã€ã€Œ1ãƒ¶æœˆã€ãªã©ã‚’è§£æ
    const hourMatch = workloadString.match(/([0-9,]+)\s*æ™‚é–“/);
    if (hourMatch && hourMatch[1]) {
        return parseInt(hourMatch[1].replace(/,/g, ''), 10);
    }

    const dayMatch = workloadString.match(/([0-9,]+)\s*æ—¥/);
    if (dayMatch && dayMatch[1]) {
        return parseInt(dayMatch[1].replace(/,/g, ''), 10) * 8; // 1æ—¥8æ™‚é–“æƒ³å®š
    }

    const weekMatch = workloadString.match(/([0-9,]+)\s*é€±é–“/);
    if (weekMatch && weekMatch[1]) {
        return parseInt(weekMatch[1].replace(/,/g, ''), 10) * 40; // 1é€±é–“40æ™‚é–“æƒ³å®š
    }

    const monthMatch = workloadString.match(/([0-9,]+)\s*ãƒ¶?æœˆ/);
    if (monthMatch && monthMatch[1]) {
        return parseInt(monthMatch[1].replace(/,/g, ''), 10) * 160; // 1ãƒ¶æœˆ160æ™‚é–“æƒ³å®š
    }

    return 40; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
}

// é›£æ˜“åº¦ã‚’ç‚¹æ•°ã«å¤‰æ›ã™ã‚‹é–¢æ•°ï¼ˆç°¡å˜ã»ã©é«˜å¾—ç‚¹ï¼‰
function parseDifficultyScore(difficultyString: string): number {
    const difficulty = difficultyString.trim().toLowerCase();

    if (difficulty.includes('ç°¡å˜') || difficulty.includes('ã‹ã‚“ãŸã‚“')) {
        return 10; // ç°¡å˜ = é«˜å¾—ç‚¹
    } else if (difficulty.includes('æ™®é€š') || difficulty.includes('ãµã¤ã†') || difficulty.includes('æ¨™æº–')) {
        return 6; // æ™®é€š = ä¸­å¾—ç‚¹
    } else if (difficulty.includes('é›£ã—ã„') || difficulty.includes('ã‚€ãšã‹ã—ã„') || difficulty.includes('å›°é›£')) {
        return 3; // é›£ã—ã„ = ä½å¾—ç‚¹
    }

    return 5; // ä¸æ˜ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}

// è©•ä¾¡ä¿‚æ•°ã®å®šæ•°
const EVALUATION_COEFFICIENTS = {
    HOURLY: 1.0,
    WORKLOAD: 0.5,
    SKILL_FIT: 2.0
};

// ææ¡ˆæ–‡ç”Ÿæˆå¯¾è±¡ã®æœ€ä½æ™‚çµ¦åŸºæº–
const PROPOSAL_GENERATION_MIN_HOURLY_RATE = 3000; // å††

// ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
const PROCESSED_JOBS_CACHE_FILE = 'output/processed-jobs.json';

// å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆç¾åœ¨ã¯ç„¡åŠ¹åŒ–ï¼‰
// async function getAppliedJobIds(): Promise<Set<string>> {
//     // å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã®å–å¾—å‡¦ç†ã¯ç¾åœ¨ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™
//     return new Set<string>();
// }

// å‡¦ç†æ¸ˆã¿æ¡ˆä»¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã‚€
function loadProcessedJobsCache(): Map<string, ProcessedJobCache> {
    const cacheMap = new Map<string, ProcessedJobCache>();

    if (existsSync(PROCESSED_JOBS_CACHE_FILE)) {
        try {
            const cacheData: ProcessedJobCache[] = JSON.parse(readFileSync(PROCESSED_JOBS_CACHE_FILE, 'utf8'));
            cacheData.forEach(item => {
                cacheMap.set(item.jobId, item);
            });
            console.log(`ğŸ“‹ å‡¦ç†æ¸ˆã¿æ¡ˆä»¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã¿: ${cacheData.length}ä»¶`);
        } catch (error) {
            console.log(`âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        }
    } else {
        console.log(`ğŸ“‹ æ–°è¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™`);
    }

    return cacheMap;
}

// å‡¦ç†æ¸ˆã¿æ¡ˆä»¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã™ã‚‹
function saveProcessedJobsCache(cacheMap: Map<string, ProcessedJobCache>): void {
    try {
        const cacheArray = Array.from(cacheMap.values());
        writeFileSync(PROCESSED_JOBS_CACHE_FILE, JSON.stringify(cacheArray, null, 2), 'utf8');
        console.log(`ğŸ’¾ å‡¦ç†æ¸ˆã¿æ¡ˆä»¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜: ${cacheArray.length}ä»¶`);
    } catch (error) {
        console.error(`âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—: ${error}`);
    }
}

// ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸæ¡ˆä»¶ã‚’å¤ã„é †ã‹ã‚‰å‰Šé™¤ã™ã‚‹
function cleanupClosedJobs(): void {
    console.log(`\nğŸ§¹ ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸæ¡ˆä»¶ã®å‰Šé™¤é–‹å§‹...`);

    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // å„ã‚«ãƒ†ã‚´ãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†
    const categories = ['ec', 'web_products', 'software_development', 'development'];
    let totalRemovedDetails = 0;
    let totalRemovedAnalyzed = 0;
    let totalRemovedCache = 0;

    categories.forEach(category => {
        // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        const detailsFile = `output/details-${category}.json`;
        if (existsSync(detailsFile)) {
            try {
                const detailsData = JSON.parse(readFileSync(detailsFile, 'utf8'));
                const originalCount = detailsData.length;

                // å¿œå‹Ÿç· åˆ‡ãŒéããŸæ¡ˆä»¶ã‚’ç‰¹å®š
                const closedJobs: any[] = [];
                const activeJobs = detailsData.filter((detail: any) => {
                    if (!detail.applicationDeadline) {
                        return true; // ç· åˆ‡ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æ®‹ã™
                    }

                    try {
                        // æ—¥æœ¬èªã®æ—¥ä»˜å½¢å¼ï¼ˆYYYYå¹´MMæœˆDDæ—¥ï¼‰ã‚’ãƒ‘ãƒ¼ã‚¹
                        const deadlineStr = detail.applicationDeadline;
                        const match = deadlineStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                        if (!match) {
                            return true; // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯æ®‹ã™
                        }

                        const year = parseInt(match[1]);
                        const month = parseInt(match[2]) - 1; // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯0ãƒ™ãƒ¼ã‚¹
                        const day = parseInt(match[3]);
                        const deadline = new Date(year, month, day);

                        if (deadline < today) {
                            closedJobs.push({
                                jobId: detail.jobId,
                                title: detail.title,
                                deadline: deadline,
                                applicationDeadline: deadlineStr
                            });
                            return false; // å‰Šé™¤å¯¾è±¡
                        }
                        return true; // æœ‰åŠ¹æ¡ˆä»¶ã¨ã—ã¦æ®‹ã™
                    } catch (error) {
                        return true; // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ®‹ã™
                    }
                });

                if (closedJobs.length > 0) {
                    // å¤ã„é †ï¼ˆç· åˆ‡æ—¥ãŒæ—©ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
                    closedJobs.sort((a, b) => a.deadline.getTime() - b.deadline.getTime());

                    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°
                    writeFileSync(detailsFile, JSON.stringify(activeJobs, null, 2), 'utf8');
                    totalRemovedDetails += closedJobs.length;

                    console.log(`ğŸ—‘ï¸ ${category} è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${closedJobs.length}ä»¶å‰Šé™¤ (${originalCount}ä»¶ â†’ ${activeJobs.length}ä»¶)`);
                    console.log(`   æœ€å¤ã®å‰Šé™¤æ¡ˆä»¶: ${closedJobs[0].applicationDeadline} - ${closedJobs[0].title.substring(0, 30)}...`);
                }
            } catch (error) {
                console.log(`âš ï¸ ${category} è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—: ${error}`);
            }
        }

        // åˆ†æãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        const analyzedFile = `output/analyzed-${category}.json`;
        if (existsSync(analyzedFile)) {
            try {
                const analyzedData = JSON.parse(readFileSync(analyzedFile, 'utf8'));
                const originalCount = analyzedData.length;

                // å¯¾å¿œã™ã‚‹è©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹åˆ†æãƒ‡ãƒ¼ã‚¿ã®ã¿æ®‹ã™
                const activeDetailsJobIds = new Set();
                const detailsFile = `output/details-${category}.json`;
                if (existsSync(detailsFile)) {
                    const detailsData = JSON.parse(readFileSync(detailsFile, 'utf8'));
                    detailsData.forEach((detail: any) => activeDetailsJobIds.add(detail.jobId));
                }

                const activeAnalyzedData = analyzedData.filter((analyzed: any) =>
                    activeDetailsJobIds.has(analyzed.jobId)
                );

                const removedCount = originalCount - activeAnalyzedData.length;
                if (removedCount > 0) {
                    writeFileSync(analyzedFile, JSON.stringify(activeAnalyzedData, null, 2), 'utf8');
                    totalRemovedAnalyzed += removedCount;
                    console.log(`ğŸ—‘ï¸ ${category} åˆ†æãƒ‡ãƒ¼ã‚¿: ${removedCount}ä»¶å‰Šé™¤ (${originalCount}ä»¶ â†’ ${activeAnalyzedData.length}ä»¶)`);
                }
            } catch (error) {
                console.log(`âš ï¸ ${category} åˆ†æãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—: ${error}`);
            }
        }
    });

    // å‡¦ç†æ¸ˆã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    if (existsSync(PROCESSED_JOBS_CACHE_FILE)) {
        try {
            const cacheData = JSON.parse(readFileSync(PROCESSED_JOBS_CACHE_FILE, 'utf8'));
            const originalCount = cacheData.length;

            // æœ‰åŠ¹ãªè©³ç´°ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã¿æ®‹ã™
            const allActiveJobIds = new Set();
            categories.forEach(category => {
                const detailsFile = `output/details-${category}.json`;
                if (existsSync(detailsFile)) {
                    const detailsData = JSON.parse(readFileSync(detailsFile, 'utf8'));
                    detailsData.forEach((detail: any) => allActiveJobIds.add(detail.jobId));
                }
            });

            const activeCacheData = cacheData.filter((cache: any) =>
                allActiveJobIds.has(cache.jobId)
            );

            const removedCount = originalCount - activeCacheData.length;
            if (removedCount > 0) {
                writeFileSync(PROCESSED_JOBS_CACHE_FILE, JSON.stringify(activeCacheData, null, 2), 'utf8');
                totalRemovedCache += removedCount;
                console.log(`ğŸ—‘ï¸ å‡¦ç†æ¸ˆã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${removedCount}ä»¶å‰Šé™¤ (${originalCount}ä»¶ â†’ ${activeCacheData.length}ä»¶)`);
            }
        } catch (error) {
            console.log(`âš ï¸ å‡¦ç†æ¸ˆã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã«å¤±æ•—: ${error}`);
        }
    }

    const totalRemoved = totalRemovedDetails + totalRemovedAnalyzed + totalRemovedCache;
    if (totalRemoved > 0) {
        console.log(`\nğŸ¯ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†:`);
        console.log(`   è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${totalRemovedDetails}ä»¶å‰Šé™¤`);
        console.log(`   åˆ†æãƒ‡ãƒ¼ã‚¿: ${totalRemovedAnalyzed}ä»¶å‰Šé™¤`);
        console.log(`   ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${totalRemovedCache}ä»¶å‰Šé™¤`);
        console.log(`   åˆè¨ˆ: ${totalRemoved}ä»¶å‰Šé™¤`);
    } else {
        console.log(`ğŸ‰ å‰Šé™¤å¯¾è±¡ã®ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸæ¡ˆä»¶ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
    }
}

// ãŠã™ã™ã‚ç‚¹æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆã‚¹ã‚­ãƒ«é©æ€§è€ƒæ…®ç‰ˆï¼‰
function calculateRecommendationScore(
    hourlyRate: number,
    workloadHours: number,
    skillFitScore: number
): number {
    // æ™‚çµ¦ã‚¹ã‚³ã‚¢ï¼ˆ0-10ç‚¹ï¼‰: æ™‚çµ¦ãŒé«˜ã„ã»ã©é«˜å¾—ç‚¹
    let hourlyScore = 0;
    if (hourlyRate >= 4000) hourlyScore = 10;
    else if (hourlyRate >= 3500) hourlyScore = 9;
    else if (hourlyRate >= 3000) hourlyScore = 8;
    else if (hourlyRate >= 2500) hourlyScore = 7;
    else if (hourlyRate >= 2000) hourlyScore = 6;
    else if (hourlyRate >= 1500) hourlyScore = 5;
    else if (hourlyRate >= 1000) hourlyScore = 4;
    else if (hourlyRate >= 500) hourlyScore = 3;
    else if (hourlyRate > 0) hourlyScore = 2;
    else hourlyScore = 0;

    // å·¥æ•°ã‚¹ã‚³ã‚¢ï¼ˆ0-10ç‚¹ï¼‰: é©åº¦ãªå·¥æ•°ï¼ˆ20-80æ™‚é–“ï¼‰ãŒé«˜å¾—ç‚¹
    let workloadScore = 0;
    if (workloadHours >= 20 && workloadHours <= 80) {
        workloadScore = 10; // æœ€é©ç¯„å›²
    } else if (workloadHours >= 10 && workloadHours <= 120) {
        workloadScore = 8; // è‰¯ã„ç¯„å›²
    } else if (workloadHours >= 5 && workloadHours <= 160) {
        workloadScore = 6; // è¨±å®¹ç¯„å›²
    } else if (workloadHours > 0 && workloadHours <= 200) {
        workloadScore = 4; // å¾®å¦™ãªç¯„å›²
    } else {
        workloadScore = 2; // æ¥µç«¯ãªå·¥æ•°
    }

    // ä¿‚æ•°ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆã‚¹ã‚­ãƒ«é©æ€§é‡è¦–ï¼‰
    const totalScore = (hourlyScore * EVALUATION_COEFFICIENTS.HOURLY) +
        (workloadScore * EVALUATION_COEFFICIENTS.WORKLOAD) +
        (skillFitScore * EVALUATION_COEFFICIENTS.SKILL_FIT);

    return Math.round(totalScore * 10) / 10; // å°æ•°ç‚¹1ä½ã¾ã§
}

// è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getOriginalJobData(jobId: string, detailsData: any[], lancersJobs?: any[]): any {
    // ã¾ãšCrowdWorksã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢
    const crowdWorksJob = detailsData.find(job => job.jobId === jobId);
    if (crowdWorksJob) {
        return crowdWorksJob;
    }

    // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã®æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢
    if (lancersJobs) {
        const lancersJob = lancersJobs.find(item => item.id === jobId);
        if (lancersJob) {
            return {
                jobId: lancersJob.id,
                title: lancersJob.title,
                detailedDescription: lancersJob.description,
                url: lancersJob.url,
                source: 'lancers'
            };
        }
    }

    return null;
}

// ä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡ã‚¯ãƒ©ã‚¹
class ConcurrencyLimiter {
    private runningCount = 0;
    private queue: (() => Promise<void>)[] = [];

    constructor(private maxConcurrency: number) { }

    async execute<T>(task: () => Promise<T>): Promise<T> {
        return new Promise<T>((resolve, reject) => {
            const wrappedTask = async () => {
                try {
                    this.runningCount++;
                    const result = await task();
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    this.runningCount--;
                    this.processQueue();
                }
            };

            if (this.runningCount < this.maxConcurrency) {
                wrappedTask();
            } else {
                this.queue.push(wrappedTask);
            }
        });
    }

    private processQueue() {
        if (this.queue.length > 0 && this.runningCount < this.maxConcurrency) {
            const nextTask = this.queue.shift();
            if (nextTask) {
                nextTask();
            }
        }
    }
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆéåŒæœŸç‰ˆï¼‰
async function main(): Promise<void> {
    console.log('ğŸš€ ãŠã™ã™ã‚æ¡ˆä»¶ã®è¨ˆç®—ã‚’é–‹å§‹ã—ã¾ã™...');

    // å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶IDã‚’å–å¾—ï¼ˆç¾åœ¨ã¯ç„¡åŠ¹åŒ–ï¼‰
    console.log('\nğŸ“‹ å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã®å–å¾—ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼ˆAPIã‚­ãƒ¼æœªè¨­å®šã®ãŸã‚ï¼‰');

    // ã‚¯ãƒ­ãƒ¼ã‚ºã—ãŸæ¡ˆä»¶ã‚’å‰Šé™¤
    cleanupClosedJobs();

    const startTime = Date.now();

    try {
        // å‡¦ç†æ¸ˆã¿æ¡ˆä»¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’èª­ã¿è¾¼ã¿
        const processedCache = loadProcessedJobsCache();
        console.log(`ğŸ“‹ å‡¦ç†æ¸ˆã¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿: ${processedCache.size}ä»¶`);

        const scoredJobs: ScoredJob[] = [];

        // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã‚€ï¼ˆå…ƒã®ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ç”¨ï¼‰
        let ecDetailsData: any[] = [];
        let webDetailsData: any[] = [];
        let softwareDetailsData: any[] = [];
        let developmentDetailsData: any[] = [];
        let lancersDetailsData: any[] = [];

        // CrowdWorksè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        try {
            ecDetailsData = JSON.parse(readFileSync('output/details-ec.json', 'utf8'));
            console.log(`ğŸ“‚ CrowdWorks ECè©³ç´°ãƒ‡ãƒ¼ã‚¿: ${ecDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ CrowdWorks ECè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        }

        try {
            webDetailsData = JSON.parse(readFileSync('output/details-web_products.json', 'utf8'));
            console.log(`ğŸ“‚ CrowdWorks Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${webDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ CrowdWorks Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        }

        try {
            softwareDetailsData = JSON.parse(readFileSync('output/details-software_development.json', 'utf8'));
            console.log(`ğŸ“‚ CrowdWorks ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºè©³ç´°ãƒ‡ãƒ¼ã‚¿: ${softwareDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ CrowdWorks ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        }

        try {
            developmentDetailsData = JSON.parse(readFileSync('output/details-development.json', 'utf8'));
            console.log(`ğŸ“‚ CrowdWorks é–‹ç™ºè©³ç´°ãƒ‡ãƒ¼ã‚¿: ${developmentDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ CrowdWorks é–‹ç™ºè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        }

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        console.log(`ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...`);
        try {
            const lancersAllDetails = JSON.parse(readFileSync('output/lancers-all-details.json', 'utf8'));
            lancersDetailsData = lancersAllDetails.details || [];
            console.log(`ğŸ“‚ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ãƒ‡ãƒ¼ã‚¿: ${lancersDetailsData.length}ä»¶èª­ã¿è¾¼ã¿ SUCCESS`);
        } catch (error) {
            console.log(`âš ï¸ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        }

        // AIåˆ†ææ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        let ecAnalyzedData: any[] = [];
        let webAnalyzedData: any[] = [];
        let softwareAnalyzedData: any[] = [];
        let developmentAnalyzedData: any[] = [];
        let lancersAnalyzedData: any[] = [];

        try {
            ecAnalyzedData = JSON.parse(readFileSync('output/analyzed-ec.json', 'utf8'));
            console.log(`ğŸ§  EC AIåˆ†æãƒ‡ãƒ¼ã‚¿: ${ecAnalyzedData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ ECã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-ec.json`);
        }

        try {
            webAnalyzedData = JSON.parse(readFileSync('output/analyzed-web_products.json', 'utf8'));
            console.log(`ğŸ§  Webè£½å“ AIåˆ†æãƒ‡ãƒ¼ã‚¿: ${webAnalyzedData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ Webè£½å“ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-web_products.json`);
        }

        try {
            softwareAnalyzedData = JSON.parse(readFileSync('output/analyzed-software_development.json', 'utf8'));
            console.log(`ğŸ§  ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™º AIåˆ†æãƒ‡ãƒ¼ã‚¿: ${softwareAnalyzedData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-software_development.json`);
        }

        try {
            developmentAnalyzedData = JSON.parse(readFileSync('output/analyzed-development.json', 'utf8'));
            console.log(`ğŸ§  é–‹ç™º AIåˆ†æãƒ‡ãƒ¼ã‚¿: ${developmentAnalyzedData.length}ä»¶èª­ã¿è¾¼ã¿`);
        } catch (error) {
            console.log(`âš ï¸ é–‹ç™ºã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-development.json`);
        }

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºåˆ†æãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        console.log(`ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºåˆ†æãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...`);
        try {
            lancersAnalyzedData = JSON.parse(readFileSync('output/analyzed-lancers.json', 'utf8'));
            console.log(`ğŸ§  ãƒ©ãƒ³ã‚µãƒ¼ã‚º AIåˆ†æãƒ‡ãƒ¼ã‚¿: ${lancersAnalyzedData.length}ä»¶èª­ã¿è¾¼ã¿ SUCCESS`);
        } catch (error) {
            console.log(`âš ï¸ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-lancers.json - ${error}`);
        }

        // å…¨ã‚«ãƒ†ã‚´ãƒªã®åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ã—ã¦çµ‚äº†æ¡ˆä»¶ã‚’é™¤å¤–
        const allAnalyzedJobs = [
            ...ecAnalyzedData,
            ...webAnalyzedData,
            ...softwareAnalyzedData,
            ...developmentAnalyzedData,
            ...lancersAnalyzedData
        ];

        console.log(`ğŸ“Š çµ±åˆå¾Œã®å…¨æ¡ˆä»¶æ•°: ${allAnalyzedJobs.length}ä»¶`);
        console.log(`ğŸ“Š EC: ${ecAnalyzedData.length}ä»¶, Web: ${webAnalyzedData.length}ä»¶, Software: ${softwareAnalyzedData.length}ä»¶, Development: ${developmentAnalyzedData.length}ä»¶, Lancers: ${lancersAnalyzedData.length}ä»¶`);

        // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        // ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã®æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã¿
        console.log(`ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚’é–‹å§‹...`);
        let lancersJobsData: any[] = [];
        try {
            const lancersAllJobs = JSON.parse(readFileSync('output/lancers-all-jobs.json', 'utf8'));
            lancersJobsData = lancersAllJobs.jobs || [];
            console.log(`ğŸ“‚ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿: ${lancersJobsData.length}ä»¶èª­ã¿è¾¼ã¿ SUCCESS`);
        } catch (error) {
            console.log(`âš ï¸ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
        }

        // å…¨è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸
        const allDetailsData = [
            ...ecDetailsData,
            ...webDetailsData,
            ...softwareDetailsData,
            ...developmentDetailsData,
            ...lancersDetailsData
        ];

        // ğŸš€ çµ±åˆå‰ã®Lancersæ¡ˆä»¶ç¢ºèª
        const lancersInAll = allAnalyzedJobs.filter(job => job.jobId.includes('lancers_test'));
        console.log(`ğŸš€ ãƒ‡ãƒãƒƒã‚° - allAnalyzedJobsã«Lancersæ¡ˆä»¶: ${lancersInAll.length}ä»¶`);
        lancersInAll.forEach(job => {
            console.log(`   - ${job.jobId}: ${job.title}`);
        });

        // çµ‚äº†ã—ã¦ã„ã‚‹æ¡ˆä»¶ã‚’é™¤å¤–ï¼ˆå¿œå‹Ÿç· åˆ‡ãŒéããŸæ¡ˆä»¶ï¼‰
        const activeJobs = allAnalyzedJobs.filter(job => {
            // å¯¾å¿œã™ã‚‹è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
            const detailData = allDetailsData.find(detail => detail.jobId === job.jobId);



            if (!detailData || !detailData.applicationDeadline) {
                return true; // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯ç· åˆ‡ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯æœ‰åŠ¹ã¨ã™ã‚‹
            }

            try {
                // æ—¥æœ¬èªã®æ—¥ä»˜å½¢å¼ï¼ˆYYYYå¹´MMæœˆDDæ—¥ï¼‰ã‚’ãƒ‘ãƒ¼ã‚¹
                const deadlineStr = detailData.applicationDeadline;
                const match = deadlineStr.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                if (!match) {
                    return true; // ãƒ‘ãƒ¼ã‚¹ã§ããªã„å ´åˆã¯æœ‰åŠ¹ã¨ã™ã‚‹
                }

                const deadlineDate = new Date(
                    parseInt(match[1]),
                    parseInt(match[2]) - 1, // æœˆã¯0ãƒ™ãƒ¼ã‚¹
                    parseInt(match[3])
                );

                return deadlineDate >= today; // ä»Šæ—¥ä»¥é™ãªã‚‰æœ‰åŠ¹
            } catch (error) {
                console.log(`âš ï¸ ç· åˆ‡æ—¥ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ (jobId: ${job.jobId}): ${detailData.applicationDeadline}`);
                return true; // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æœ‰åŠ¹ã¨ã™ã‚‹
            }
        });

        const excludedCount = allAnalyzedJobs.length - activeJobs.length;
        console.log(`ğŸ“… å¿œå‹Ÿç· åˆ‡ãƒã‚§ãƒƒã‚¯: ç·${allAnalyzedJobs.length}ä»¶ä¸­ã€${excludedCount}ä»¶ã®çµ‚äº†æ¡ˆä»¶ã‚’é™¤å¤–`);
        console.log(`âœ… æœ‰åŠ¹æ¡ˆä»¶: ${activeJobs.length}ä»¶ã§å‡¦ç†ã‚’ç¶™ç¶š`);

        // å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ã‚’é™¤å¤–ï¼ˆç¾åœ¨ã¯ç„¡åŠ¹åŒ–ï¼‰
        const notAppliedJobs = activeJobs; // é™¤å¤–å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        console.log(`ğŸ“ å¿œå‹Ÿæ¸ˆã¿æ¡ˆä»¶ãƒã‚§ãƒƒã‚¯: ã‚¹ã‚­ãƒƒãƒ—ï¼ˆAPIã‚­ãƒ¼æœªè¨­å®šï¼‰`);
        console.log(`âœ… æœ€çµ‚å¯¾è±¡æ¡ˆä»¶: ${notAppliedJobs.length}ä»¶ã§å‡¦ç†ã‚’ç¶™ç¶š`);

        console.log(`\nğŸ“Š æœ‰åŠ¹æ¡ˆä»¶ã®åˆ†å¸ƒ:`);

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ã®æœ‰åŠ¹æ¡ˆä»¶ã®ã¿ã‚’å‡¦ç†
        notAppliedJobs.forEach(item => {
            const hourlyRate = parseHourlyRate(item.æƒ³å®šæ™‚çµ¦);
            const workloadHours = parseWorkloadHours(item.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š);
            const difficultyScore = parseDifficultyScore(item.é›£æ˜“åº¦);
            const skillFitScore = 5; // ä»®ã®ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ï¼ˆå¾Œã§æ›´æ–°ï¼‰
            const recommendationScore = calculateRecommendationScore(hourlyRate, workloadHours, skillFitScore);

            // ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ã¦è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let originalJob;
            let categoryName = '';

            if (ecAnalyzedData.some(job => job.jobId === item.jobId)) {
                originalJob = getOriginalJobData(item.jobId, ecDetailsData, lancersJobsData);
                categoryName = 'EC';
            } else if (webAnalyzedData.some(job => job.jobId === item.jobId)) {
                originalJob = getOriginalJobData(item.jobId, webDetailsData, lancersJobsData);
                categoryName = 'Webè£½å“';
            } else if (softwareAnalyzedData.some(job => job.jobId === item.jobId)) {
                originalJob = getOriginalJobData(item.jobId, softwareDetailsData, lancersJobsData);
                categoryName = 'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™º';
            } else if (developmentAnalyzedData.some(job => job.jobId === item.jobId)) {
                originalJob = getOriginalJobData(item.jobId, developmentDetailsData, lancersJobsData);
                categoryName = 'é–‹ç™º';
            } else if (lancersAnalyzedData.some(job => job.jobId === item.jobId)) {
                originalJob = getOriginalJobData(item.jobId, lancersDetailsData, lancersJobsData);
                categoryName = 'ãƒ©ãƒ³ã‚µãƒ¼ã‚º';
                console.log(`ğŸš€ Lancersæ¡ˆä»¶å‡¦ç†: ${item.jobId} - ${item.title}`);
            }

            const proposalAmount = Math.round(workloadHours * PROPOSAL_GENERATION_MIN_HOURLY_RATE);
            const finishDays = Math.ceil((workloadHours / 6) * 2);
            const finishDate = new Date();
            finishDate.setDate(finishDate.getDate() + finishDays);
            const estimatedFinishDate = finishDate.toISOString().split('T')[0];

            // ãƒªãƒ³ã‚¯ã®ç”Ÿæˆï¼ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«å¿œã˜ã¦ï¼‰
            let jobLink = `https://crowdworks.jp/public/jobs/${item.jobId}`;
            if (categoryName === 'ãƒ©ãƒ³ã‚µãƒ¼ã‚º') {
                jobLink = originalJob?.url || `https://www.lancers.jp/work/detail/${item.jobId}`;
            }

            scoredJobs.push({
                ...item,
                category: categoryName,
                hourly_rate_numeric: hourlyRate,
                workload_hours: workloadHours,
                difficulty_score: difficultyScore,
                skill_fit_score: skillFitScore,
                recommendation_score: recommendationScore,
                link: jobLink,
                original_title: originalJob?.title || item.title,
                proposal_amount: proposalAmount,
                estimated_finish_date: estimatedFinishDate
            });
        });

        console.log(`âœ… æœ‰åŠ¹æ¡ˆä»¶å‡¦ç†å®Œäº†: ${notAppliedJobs.length}ä»¶`);

        if (scoredJobs.length === 0) {
            console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ');
            return;
        }

        // å…¨æ¡ˆä»¶ã®ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡ã‚’å®Ÿè¡Œ
        console.log(`\nğŸ§  å…¨æ¡ˆä»¶ã®ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡ä¸­ï¼ˆæœ€å¤§10ä»¶ä¸¦åˆ—ï¼‰...`);

        const limiter = new ConcurrencyLimiter(10);
        let skillAnalysisCount = 0;
        let cacheHitCount = 0;
        let newProcessingCount = 0;

        const skillAnalysisPromises = scoredJobs.map(async (job, index) => {
            try {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æ—¢å­˜ã®çµæœã‚’ç¢ºèª
                const cachedResult = processedCache.get(job.jobId);

                if (cachedResult) {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼šæ—¢å­˜ã®çµæœã‚’ä½¿ç”¨
                    job.skill_fit_score = cachedResult.skill_fit_score;
                    job.skill_analysis = cachedResult.skill_analysis;

                    // ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ã§ãŠã™ã™ã‚ç‚¹æ•°ã‚’å†è¨ˆç®—
                    job.recommendation_score = calculateRecommendationScore(
                        job.hourly_rate_numeric,
                        job.workload_hours,
                        cachedResult.skill_fit_score
                    );

                    cacheHitCount++;
                    console.log(`ğŸ’¾ [${skillAnalysisCount + cacheHitCount}/${scoredJobs.length}] ${job.original_title?.substring(0, 40)}... ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—`);

                    return { success: true, index, fromCache: true };
                } else {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ï¼šæ–°è¦ã§GPTå‡¦ç†
                    const allDetailsData = [...ecDetailsData, ...webDetailsData, ...softwareDetailsData, ...developmentDetailsData, ...lancersDetailsData];
                    const originalJob = getOriginalJobData(job.jobId, allDetailsData, lancersJobsData);

                    const { score, analysis } = await limiter.execute(() =>
                        analyzeSkillFit(job, originalJob)
                    );

                    job.skill_fit_score = score;
                    job.skill_analysis = analysis;

                    // ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ã§ãŠã™ã™ã‚ç‚¹æ•°ã‚’å†è¨ˆç®—
                    job.recommendation_score = calculateRecommendationScore(
                        job.hourly_rate_numeric,
                        job.workload_hours,
                        score
                    );

                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ ï¼ˆææ¡ˆæ–‡ã¯å¾Œã§è¿½åŠ ï¼‰
                    processedCache.set(job.jobId, {
                        jobId: job.jobId,
                        skill_fit_score: score,
                        skill_analysis: analysis,
                        proposal_greeting: '', // å¾Œã§æ›´æ–°
                        delivery_estimate: '', // å¾Œã§æ›´æ–°
                        specification_questions: '', // å¾Œã§æ›´æ–°
                        processed_at: new Date().toISOString()
                    });

                    newProcessingCount++;
                    console.log(`âœ… [${newProcessingCount}/${scoredJobs.length - cacheHitCount}] ${job.original_title?.substring(0, 40)}... ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡å®Œäº†ï¼ˆæ–°è¦å‡¦ç†ï¼‰`);

                    return { success: true, index, fromCache: false };
                }
            } catch (error) {
                console.error(`âŒ [${index + 1}/${scoredJobs.length}] ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡ã‚¨ãƒ©ãƒ¼:`, error);
                return { success: false, index, fromCache: false };
            }
        });

        await Promise.allSettled(skillAnalysisPromises);
        skillAnalysisCount = cacheHitCount + newProcessingCount;
        console.log(`ğŸ¯ ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡å®Œäº†: ${skillAnalysisCount}/${scoredJobs.length}ä»¶æˆåŠŸï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${cacheHitCount}ä»¶ã€æ–°è¦: ${newProcessingCount}ä»¶ï¼‰`);

        // ãŠã™ã™ã‚ç‚¹æ•°é †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜å¾—ç‚¹é †ï¼‰
        const sortedJobs = scoredJobs.sort((a, b) => b.recommendation_score - a.recommendation_score);

        // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
        const validJobs = sortedJobs.filter(j => j.hourly_rate_numeric > 0);
        if (validJobs.length > 0) {
            const maxScore = Math.max(...validJobs.map(j => j.recommendation_score));
            const minScore = Math.min(...validJobs.map(j => j.recommendation_score));
            const avgScore = Math.round((validJobs.reduce((sum, j) => sum + j.recommendation_score, 0) / validJobs.length) * 10) / 10;
            const avgSkillFit = Math.round((validJobs.reduce((sum, j) => sum + j.skill_fit_score, 0) / validJobs.length) * 10) / 10;

            console.log(`\nğŸ“ˆ çµ±è¨ˆæƒ…å ±:`);
            console.log(`æœ€é«˜ãŠã™ã™ã‚ç‚¹æ•°: ${maxScore}ç‚¹`);
            console.log(`æœ€ä½ãŠã™ã™ã‚ç‚¹æ•°: ${minScore}ç‚¹`);
            console.log(`å¹³å‡ãŠã™ã™ã‚ç‚¹æ•°: ${avgScore}ç‚¹`);
            console.log(`å¹³å‡ã‚¹ã‚­ãƒ«é©æ€§: ${avgSkillFit}ç‚¹`);
            console.log(`æœ‰åŠ¹æ¡ˆä»¶: ${validJobs.length}ä»¶ / å…¨${sortedJobs.length}ä»¶`);
        }

        // å…¨æ¡ˆä»¶ã«ææ¡ˆæ–‡ç”Ÿæˆã‚’è¿½åŠ 
        console.log(`\nğŸ¤– å…¨æ¡ˆä»¶ã®ææ¡ˆæ–‡ç”Ÿæˆä¸­ï¼ˆæœ€å¤§8ä»¶ä¸¦åˆ—ï¼‰...`);
        console.log(`å¯¾è±¡æ¡ˆä»¶: ${sortedJobs.length}ä»¶`);

        const proposalLimiter = new ConcurrencyLimiter(8); // ææ¡ˆæ–‡ç”Ÿæˆã¯8ä»¶ä¸¦åˆ—
        let proposalCount = 0;
        let proposalCacheHitCount = 0;
        let newProposalProcessingCount = 0;

        const proposalPromises = sortedJobs.map(async (job, index) => {
            try {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æ—¢å­˜ã®ææ¡ˆæ–‡ã‚’ç¢ºèª
                const cachedResult = processedCache.get(job.jobId);

                if (cachedResult && cachedResult.proposal_greeting && cachedResult.proposal_greeting.trim() !== '') {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼šæ—¢å­˜ã®ææ¡ˆæ–‡ã‚’ä½¿ç”¨
                    job.proposal_greeting = cachedResult.proposal_greeting;
                    job.delivery_estimate = cachedResult.delivery_estimate;
                    job.specification_questions = cachedResult.specification_questions;

                    proposalCacheHitCount++;
                    console.log(`ğŸ’¾ [${proposalCount + proposalCacheHitCount}/${sortedJobs.length}] ${job.original_title?.substring(0, 40)}... ææ¡ˆæ–‡ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—`);

                    return { success: true, index, fromCache: true };
                } else {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ï¼šæ–°è¦ã§GPTå‡¦ç†
                    const allDetailsData = [...ecDetailsData, ...webDetailsData, ...softwareDetailsData, ...developmentDetailsData, ...lancersDetailsData];
                    const originalJob = getOriginalJobData(job.jobId, allDetailsData, lancersJobsData);

                    const { greeting, delivery_estimate, questions } = await proposalLimiter.execute(() =>
                        generateProposalContent(job, originalJob)
                    );

                    job.proposal_greeting = greeting;
                    job.delivery_estimate = delivery_estimate;
                    job.specification_questions = questions;

                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°
                    if (processedCache.has(job.jobId)) {
                        const existingCache = processedCache.get(job.jobId)!;
                        existingCache.proposal_greeting = greeting;
                        existingCache.delivery_estimate = delivery_estimate;
                        existingCache.specification_questions = questions;
                    } else {
                        // ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—ã•ã‚ŒãŸå ´åˆã§ã‚‚ã€ææ¡ˆæ–‡ã¯æ–°è¦ä½œæˆ
                        processedCache.set(job.jobId, {
                            jobId: job.jobId,
                            skill_fit_score: job.skill_fit_score,
                            skill_analysis: job.skill_analysis || '',
                            proposal_greeting: greeting,
                            delivery_estimate: delivery_estimate,
                            specification_questions: questions,
                            processed_at: new Date().toISOString()
                        });
                    }

                    newProposalProcessingCount++;
                    console.log(`âœ… [${newProposalProcessingCount}/${sortedJobs.length - proposalCacheHitCount}] ${job.original_title?.substring(0, 40)}... ææ¡ˆæ–‡ç”Ÿæˆå®Œäº†ï¼ˆæ–°è¦å‡¦ç†ï¼‰`);

                    return { success: true, index, fromCache: false };
                }
            } catch (error) {
                console.error(`âŒ [${index + 1}/${sortedJobs.length}] ææ¡ˆæ–‡ç”Ÿæˆã‚¨ãƒ©ãƒ¼:`, error);
                return { success: false, index, fromCache: false };
            }
        });

        await Promise.allSettled(proposalPromises);
        proposalCount = proposalCacheHitCount + newProposalProcessingCount;
        console.log(`ğŸ¯ ææ¡ˆæ–‡ç”Ÿæˆå®Œäº†: ${proposalCount}/${sortedJobs.length}ä»¶æˆåŠŸï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${proposalCacheHitCount}ä»¶ã€æ–°è¦: ${newProposalProcessingCount}ä»¶ï¼‰`);

        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜
        saveProcessedJobsCache(processedCache);

        // çµæœè¡¨ç¤ºï¼ˆä¸Šä½20ä»¶ï¼‰
        console.log(`\nğŸ† Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘ãŠã™ã™ã‚æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20:\n`);

        sortedJobs.slice(0, 20).forEach((job, index) => {
            const rank = index + 1;
            const score = job.recommendation_score;
            const hourlyRate = job.hourly_rate_numeric.toLocaleString() + 'å††';
            const category = job.category || 'N/A';
            const difficulty = job.é›£æ˜“åº¦ || 'N/A';
            const workload = job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š || 'N/A';
            const skillFit = job.skill_fit_score?.toFixed(1) || 'N/A';
            const summary = (job.gpt_summary || '').substring(0, 60) + '...';

            console.log(`${rank}ä½: ${score}ç‚¹ | ${hourlyRate} (${category}) | é›£æ˜“åº¦: ${difficulty} | ã‚¹ã‚­ãƒ«é©æ€§: ${skillFit}ç‚¹`);
            console.log(`   å·¥æ•°: ${workload}`);
            console.log(`   æ¦‚è¦: ${summary}`);

            if (job.skill_analysis) {
                console.log(`   ğŸ§  é©æ€§: ${job.skill_analysis.substring(0, 80)}...`);
            }

            // ææ¡ˆæ–‡ãŒã‚ã‚Œã°è¡¨ç¤º
            if (job.proposal_greeting) {
                console.log(`   ğŸ’¬ ææ¡ˆæ–‡: ${job.proposal_greeting.substring(0, 60)}...`);
            }
            console.log('');
        });

        // æ™‚çµ¦3000å††ä»¥ä¸Šã®æ¡ˆä»¶ã®ã¿ã‚’Markdownã«å‡ºåŠ›
        const highValueJobs = sortedJobs.filter(job => job.hourly_rate_numeric >= PROPOSAL_GENERATION_MIN_HOURLY_RATE);

        // æ™‚çµ¦åˆ†å¸ƒã®è©³ç´°ã‚’è¡¨ç¤º
        console.log(`\nğŸ“Š æ™‚çµ¦åˆ†å¸ƒã®è©³ç´°:`);
        const hourlyRateDistribution = sortedJobs.reduce((acc, job) => {
            const rate = job.hourly_rate_numeric;
            if (rate >= 4000) acc['4000å††ä»¥ä¸Š']++;
            else if (rate >= 3500) acc['3500å††ä»¥ä¸Š']++;
            else if (rate >= 3000) acc['3000å††ä»¥ä¸Š']++;
            else if (rate >= 2500) acc['2500å††ä»¥ä¸Š']++;
            else if (rate >= 2000) acc['2000å††ä»¥ä¸Š']++;
            else if (rate >= 1500) acc['1500å††ä»¥ä¸Š']++;
            else if (rate >= 1000) acc['1000å††ä»¥ä¸Š']++;
            else acc['1000å††æœªæº€']++;
            return acc;
        }, {
            '4000å††ä»¥ä¸Š': 0,
            '3500å††ä»¥ä¸Š': 0,
            '3000å††ä»¥ä¸Š': 0,
            '2500å††ä»¥ä¸Š': 0,
            '2000å††ä»¥ä¸Š': 0,
            '1500å††ä»¥ä¸Š': 0,
            '1000å††ä»¥ä¸Š': 0,
            '1000å††æœªæº€': 0
        });

        Object.entries(hourlyRateDistribution).forEach(([range, count]) => {
            if (count > 0) {
                console.log(`   ${range}: ${count}ä»¶`);
            }
        });

        console.log(`\nğŸ“ æ™‚çµ¦${PROPOSAL_GENERATION_MIN_HOURLY_RATE}å††ä»¥ä¸Šã®æ¡ˆä»¶: ${highValueJobs.length}ä»¶ã‚’Markdownã«å‡ºåŠ›`);

        // å…¨æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ç”¨ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        const allJobsMarkdown = generateAllJobsMarkdown(sortedJobs);
        writeFileSync('output/all-jobs-ranked.md', allJobsMarkdown, 'utf8');
        console.log(`ğŸ“„ å…¨æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä¿å­˜: output/all-jobs-ranked.md (${sortedJobs.length}ä»¶)`);

        // é«˜æ™‚çµ¦æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ç”¨ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆæ—¢å­˜ï¼‰
        const highValueMarkdown = generateRecommendationMarkdown(highValueJobs, sortedJobs.length); // æ™‚çµ¦3000å††ä»¥ä¸Šã®ã¿è¡¨ç¤º
        writeFileSync('output/recommended-jobs.md', highValueMarkdown, 'utf8');
        console.log(`ğŸ“„ é«˜æ™‚çµ¦æ¡ˆä»¶ãŠã™ã™ã‚ã‚’ä¿å­˜: output/recommended-jobs.md (${highValueJobs.length}ä»¶)`);

        // ä¸€æ™‚çš„ã«ç”Ÿæˆã•ã‚ŒãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        try {
            const tempFiles = [
                'output/jobs-with-recommendation-scores.json',
                'output/high-hourly-jobs-3000+.md'
            ];
            tempFiles.forEach(file => {
                if (existsSync(file)) {
                    unlinkSync(file);
                    console.log(`ï¿½ï¿½ï¸ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤: ${file}`);
                }
            });
        } catch (error) {
            console.warn('âš ï¸ ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼:', error);
        }

        const endTime = Date.now();
        const duration = ((endTime - startTime) / 1000).toFixed(2);
        console.log(`ğŸ‰ ãŠã™ã™ã‚æ¡ˆä»¶ã®è¨ˆç®—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å‡¦ç†æ™‚é–“: ${duration}ç§’`);
    } catch (error) {
        console.error(`âŒ ãŠã™ã™ã‚æ¡ˆä»¶ã®è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`, error);
    }
}

// Markdownç”Ÿæˆé–¢æ•°
function generateRecommendationMarkdown(jobs: ScoredJob[], totalJobs?: number): string {
    // æ—¥æœ¬æ™‚é–“ã§ç§’ã¾ã§å«ã‚€è©³ç´°ãªæ™‚åˆ»ã‚’å–å¾—
    const now = new Date();
    const jstOffset = 9 * 60; // JST = UTC+9
    const jstTime = new Date(now.getTime() + jstOffset * 60 * 1000);
    const currentDateTime = jstTime.toISOString().replace('T', ' ').replace('Z', '').substring(0, 19) + ' JST';

    let markdown = `# Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘ãŠã™ã™ã‚æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæ™‚çµ¦${PROPOSAL_GENERATION_MIN_HOURLY_RATE}å††ä»¥ä¸Šï¼‰\n\n`;
    markdown += `> **ç”Ÿæˆæ—¥æ™‚**: ${currentDateTime}  \n`;
    markdown += `> è©•ä¾¡åŸºæº–: ä¿‚æ•°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ™‚çµ¦Ã—${EVALUATION_COEFFICIENTS.HOURLY} + å·¥æ•°Ã—${EVALUATION_COEFFICIENTS.WORKLOAD} + ã‚¹ã‚­ãƒ«é©æ€§Ã—${EVALUATION_COEFFICIENTS.SKILL_FIT}ï¼‰  \n`;
    markdown += `> å¯¾è±¡è€…: é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚­ãƒ«ä½ã‚ï¼‰  \n`;
    markdown += `> æœ€é«˜å¾—ç‚¹: ${Math.max(...jobs.map(j => j.recommendation_score))}ç‚¹  \n`;
    markdown += `> è¡¨ç¤ºä»¶æ•°: ${jobs.length}ä»¶ï¼ˆå…¨${totalJobs || jobs.length}ä»¶ã‹ã‚‰æ™‚çµ¦${PROPOSAL_GENERATION_MIN_HOURLY_RATE}å††ä»¥ä¸Šã‚’æŠ½å‡ºï¼‰\n\n`;

    markdown += `## ğŸ‘¨â€ğŸ’» å¯¾è±¡ã‚¹ã‚­ãƒ«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«\n\n`;
    markdown += `- **é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢**ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¸¡æ–¹ï¼‰\n`;
    markdown += `- **å¾—æ„åˆ†é‡**: ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒ»APIé€£æºãƒ»DBè¨­è¨ˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–\n`;
    markdown += `- **è‹¦æ‰‹åˆ†é‡**: ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆCSSã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç¨‹åº¦ãªã‚‰å¯¾å¿œå¯èƒ½ï¼‰\n\n`;

    markdown += `## ğŸ“Š è©•ä¾¡åŸºæº–ã®è©³ç´°\n\n`;
    markdown += `### ğŸ’° æ™‚çµ¦ã‚¹ã‚³ã‚¢ï¼ˆä¿‚æ•°ï¼š${EVALUATION_COEFFICIENTS.HOURLY}ï¼‰\n`;
    markdown += `- 4000å††ä»¥ä¸Š: 10ç‚¹ â†’ ${10 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 3500å††ä»¥ä¸Š: 9ç‚¹ â†’ ${9 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 3000å††ä»¥ä¸Š: 8ç‚¹ â†’ ${8 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 2500å††ä»¥ä¸Š: 7ç‚¹ â†’ ${7 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 2000å††ä»¥ä¸Š: 6ç‚¹ â†’ ${6 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n\n`;

    markdown += `### â° å·¥æ•°ã‚¹ã‚³ã‚¢ï¼ˆä¿‚æ•°ï¼š${EVALUATION_COEFFICIENTS.WORKLOAD}ï¼‰\n`;
    markdown += `- 20-80æ™‚é–“: 10ç‚¹ â†’ ${10 * EVALUATION_COEFFICIENTS.WORKLOAD}ç‚¹ï¼ˆæœ€é©ãªå·¥æ•°ï¼‰\n`;
    markdown += `- 10-120æ™‚é–“: 8ç‚¹ â†’ ${8 * EVALUATION_COEFFICIENTS.WORKLOAD}ç‚¹ï¼ˆè‰¯ã„ç¯„å›²ï¼‰\n`;
    markdown += `- 5-160æ™‚é–“: 6ç‚¹ â†’ ${6 * EVALUATION_COEFFICIENTS.WORKLOAD}ç‚¹ï¼ˆè¨±å®¹ç¯„å›²ï¼‰\n\n`;

    markdown += `### ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ï¼ˆä¿‚æ•°ï¼š${EVALUATION_COEFFICIENTS.SKILL_FIT}ï¼‰\n`;
    markdown += `- 10ç‚¹: æŠ€è¡“åŠ›ã‚’æœ€å¤§é™æ´»ã‹ã›ã‚‹æ¡ˆä»¶ï¼ˆã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã€APIé€£æºã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç­‰ï¼‰\n`;
    markdown += `- 8-9ç‚¹: æŠ€è¡“ã‚¹ã‚­ãƒ«ãŒé‡è¦ãªæ¡ˆä»¶ï¼ˆWordPressã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã€ECæ©Ÿèƒ½é–‹ç™ºç­‰ï¼‰\n`;
    markdown += `- 6-7ç‚¹: æŠ€è¡“ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãŒåŠã€…ï¼ˆæ—¢å­˜ã‚µã‚¤ãƒˆä¿®æ­£ã€ç°¡å˜ãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç­‰ï¼‰\n`;
    markdown += `- 4-5ç‚¹: ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ãŒå¤šã„ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é‡è¦–ç­‰ï¼‰\n`;
    markdown += `- 1-3ç‚¹: ç´”ç²‹ãªãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶ï¼ˆã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ¶ä½œã€UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ç­‰ï¼‰\n`;
    markdown += `- 0ç‚¹: å®Œå…¨ã«ã‚¹ã‚­ãƒ«å¤–ï¼ˆã‚¤ãƒ©ã‚¹ãƒˆåˆ¶ä½œã€å‹•ç”»ç·¨é›†ç­‰ï¼‰\n\n`;

    markdown += `## ğŸ”§ ä¿‚æ•°ã®æ„å‘³\n\n`;
    markdown += `- **æ™‚çµ¦ä¿‚æ•° ${EVALUATION_COEFFICIENTS.HOURLY}**: åç›Šæ€§é‡è¦–\n`;
    markdown += `- **å·¥æ•°ä¿‚æ•° ${EVALUATION_COEFFICIENTS.WORKLOAD}**: é©åº¦ãªä½œæ¥­é‡ã‚’ãƒãƒ©ãƒ³ã‚¹è©•ä¾¡\n`;
    markdown += `- **ã‚¹ã‚­ãƒ«é©æ€§ä¿‚æ•° ${EVALUATION_COEFFICIENTS.SKILL_FIT}**: ã‚¹ã‚­ãƒ«é©æ€§ã‚’æœ€é‡è¦–ï¼ˆæŠ€è¡“æ¡ˆä»¶ã‚’å„ªé‡ï¼‰\n`;
    markdown += `- **é›£æ˜“åº¦**: å‚è€ƒæƒ…å ±ã¨ã—ã¦è¡¨ç¤ºï¼ˆç‚¹æ•°è¨ˆç®—ã«ã¯å«ã‚ãªã„ï¼‰\n\n`;

    const maxScore = (10 * EVALUATION_COEFFICIENTS.HOURLY) + (10 * EVALUATION_COEFFICIENTS.WORKLOAD) + (10 * EVALUATION_COEFFICIENTS.SKILL_FIT);
    markdown += `**æœ€é«˜ç†è«–å€¤**: ${10 * EVALUATION_COEFFICIENTS.HOURLY} + ${10 * EVALUATION_COEFFICIENTS.WORKLOAD} + ${10 * EVALUATION_COEFFICIENTS.SKILL_FIT} = ${maxScore}ç‚¹\n\n`;

    markdown += `## ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°\n\n`;

    jobs.forEach((job, index) => {
        const rank = index + 1;
        markdown += `### ${rank}ä½: ${job.recommendation_score}ç‚¹ - ${job.original_title || job.title}\n\n`;
        markdown += `**ğŸ’° æƒ³å®šæ™‚çµ¦:** ${job.hourly_rate_numeric.toLocaleString()}å††  \n`;
        markdown += `**ğŸ¯ é›£æ˜“åº¦:** ${job.é›£æ˜“åº¦}  \n`;
        markdown += `**â° è¦‹ç©å·¥æ•°:** ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š}  \n`;
        markdown += `**ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§:** ${job.skill_fit_score?.toFixed(1)}ç‚¹/10ç‚¹  \n`;
        markdown += `**ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª:** ${job.category}  \n`;
        markdown += `**ğŸ”— æ¡ˆä»¶URL:** ${job.link}\n\n`;

        // ææ¡ˆé‡‘é¡ã¨ç´æœŸã‚’è¿½åŠ 
        if (job.proposal_amount && job.delivery_estimate) {
            markdown += `**ğŸ’´ ææ¡ˆé‡‘é¡:** ${job.proposal_amount.toLocaleString()}å††  \n`;
            markdown += `**ğŸ“… ç´æœŸææ¡ˆ:** ${job.delivery_estimate}  \n\n`;
        }

        markdown += `**ğŸ“ åˆ†ææ¦‚è¦:**  \n`;
        markdown += `${job.gpt_summary}\n\n`;

        if (job.skill_analysis) {
            markdown += `**ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§åˆ†æ:**  \n`;
            markdown += `${job.skill_analysis}\n\n`;
        }

        // ææ¡ˆæ–‡ã¨è³ªå•ã‚’è¿½åŠ 
        if (job.proposal_greeting && job.specification_questions) {
            markdown += `**ğŸ’¬ æˆ¦ç•¥çš„ææ¡ˆæ–‡:**  \n`;
            markdown += `${job.proposal_greeting}\n\n`;

            markdown += `**â“ ä»•æ§˜ç¢ºèªè³ªå•:**  \n`;
            markdown += `${job.specification_questions}\n\n`;
        }

        markdown += `---\n\n`;
    });

    // æ¡ˆä»¶ä¸€è¦§ã‚’è¡¨å½¢å¼ã§å‡ºåŠ›
    if (jobs.length > 0) {
        markdown += `\n## ğŸ’´ æ¡ˆä»¶ä¸€è¦§ï¼ˆæ™‚çµ¦${PROPOSAL_GENERATION_MIN_HOURLY_RATE}å††ä»¥ä¸Šï¼‰\n\n`;
        markdown += `| æ¡ˆä»¶å | ææ¡ˆé‡‘é¡ | ç´æœŸææ¡ˆ | ææ¡ˆæ–‡ï¼ˆæŠœç²‹ï¼‰ |\n`;
        markdown += `|---|---|---|---|\n`;
        jobs.forEach(job => {
            const title = job.original_title || job.title || 'æ¡ˆä»¶åä¸æ˜';
            const amount = job.proposal_amount?.toLocaleString() || 'è¦ç›¸è«‡';
            const delivery = job.delivery_estimate || 'è¦ç›¸è«‡';
            const greeting = (job.proposal_greeting || '').replace(/\n/g, ' ').substring(0, 80);
            markdown += `| [${title}](${job.link}) | ${amount}å†† | ${delivery} | ${greeting}... |\n`;
        });
        markdown += `\n`;
    }

    return markdown;
}

// å…¨æ¡ˆä»¶ç”¨ã®Markdownç”Ÿæˆé–¢æ•°
function generateAllJobsMarkdown(jobs: ScoredJob[]): string {
    // æ—¥æœ¬æ™‚é–“ã§ç§’ã¾ã§å«ã‚€è©³ç´°ãªæ™‚åˆ»ã‚’å–å¾—
    const now = new Date();
    const jstOffset = 9 * 60; // JST = UTC+9
    const jstTime = new Date(now.getTime() + jstOffset * 60 * 1000);
    const currentDateTime = jstTime.toISOString().replace('T', ' ').replace('Z', '').substring(0, 19) + ' JST';

    let markdown = `# å…¨æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆãŠã™ã™ã‚åº¦é †ï¼‰\n\n`;
    markdown += `> **ç”Ÿæˆæ—¥æ™‚**: ${currentDateTime}  \n`;
    markdown += `> è©•ä¾¡åŸºæº–: ä¿‚æ•°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ™‚çµ¦Ã—${EVALUATION_COEFFICIENTS.HOURLY} + å·¥æ•°Ã—${EVALUATION_COEFFICIENTS.WORKLOAD} + ã‚¹ã‚­ãƒ«é©æ€§Ã—${EVALUATION_COEFFICIENTS.SKILL_FIT}ï¼‰  \n`;
    markdown += `> å¯¾è±¡è€…: é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚­ãƒ«ä½ã‚ï¼‰  \n`;
    markdown += `> æœ€é«˜å¾—ç‚¹: ${Math.max(...jobs.map(j => j.recommendation_score))}ç‚¹  \n`;
    markdown += `> ç·æ¡ˆä»¶æ•°: ${jobs.length}ä»¶ï¼ˆææ¡ˆæ–‡ç”Ÿæˆå¯¾è±¡å¤–ã®æ¡ˆä»¶ã‚‚å«ã‚€ï¼‰\n\n`;

    // æ™‚çµ¦åˆ†å¸ƒã‚’è¡¨ç¤º
    const hourlyRateDistribution = jobs.reduce((acc, job) => {
        const rate = job.hourly_rate_numeric;
        if (rate >= 4000) acc['4000å††ä»¥ä¸Š']++;
        else if (rate >= 3500) acc['3500å††ä»¥ä¸Š']++;
        else if (rate >= 3000) acc['3000å††ä»¥ä¸Š']++;
        else if (rate >= 2500) acc['2500å††ä»¥ä¸Š']++;
        else if (rate >= 2000) acc['2000å††ä»¥ä¸Š']++;
        else if (rate >= 1500) acc['1500å††ä»¥ä¸Š']++;
        else if (rate >= 1000) acc['1000å††ä»¥ä¸Š']++;
        else acc['1000å††æœªæº€']++;
        return acc;
    }, {
        '4000å††ä»¥ä¸Š': 0,
        '3500å††ä»¥ä¸Š': 0,
        '3000å††ä»¥ä¸Š': 0,
        '2500å††ä»¥ä¸Š': 0,
        '2000å††ä»¥ä¸Š': 0,
        '1500å††ä»¥ä¸Š': 0,
        '1000å††ä»¥ä¸Š': 0,
        '1000å††æœªæº€': 0
    });

    markdown += `## ğŸ“Š æ™‚çµ¦åˆ†å¸ƒ\n\n`;
    Object.entries(hourlyRateDistribution).forEach(([range, count]) => {
        if (count > 0) {
            markdown += `- ${range}: ${count}ä»¶\n`;
        }
    });
    markdown += `\n`;

    markdown += `## ğŸ† å…¨æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚°\n\n`;

    jobs.forEach((job, index) => {
        const rank = index + 1;
        markdown += `### ${rank}ä½: ${job.recommendation_score}ç‚¹ - ${job.original_title || job.title}\n\n`;
        markdown += `**ğŸ’° æƒ³å®šæ™‚çµ¦:** ${job.hourly_rate_numeric.toLocaleString()}å††  \n`;
        markdown += `**ğŸ¯ é›£æ˜“åº¦:** ${job.é›£æ˜“åº¦}  \n`;
        markdown += `**â° è¦‹ç©å·¥æ•°:** ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š}  \n`;
        markdown += `**ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§:** ${job.skill_fit_score?.toFixed(1)}ç‚¹/10ç‚¹  \n`;
        markdown += `**ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª:** ${job.category}  \n`;
        markdown += `**ğŸ”— æ¡ˆä»¶URL:** ${job.link}\n\n`;

        markdown += `**ğŸ“ åˆ†ææ¦‚è¦:**  \n`;
        markdown += `${job.gpt_summary}\n\n`;

        if (job.skill_analysis) {
            markdown += `**ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§åˆ†æ:**  \n`;
            markdown += `${job.skill_analysis}\n\n`;
        }

        // ææ¡ˆæ–‡ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼ˆæ™‚çµ¦3000å††ä»¥ä¸Šã®æ¡ˆä»¶ï¼‰
        if (job.proposal_greeting && job.specification_questions) {
            markdown += `**ğŸ’¬ æˆ¦ç•¥çš„ææ¡ˆæ–‡:**  \n`;
            markdown += `${job.proposal_greeting}\n\n`;

            markdown += `**â“ ä»•æ§˜ç¢ºèªè³ªå•:**  \n`;
            markdown += `${job.specification_questions}\n\n`;

            if (job.proposal_amount && job.delivery_estimate) {
                markdown += `**ğŸ’´ ææ¡ˆé‡‘é¡:** ${job.proposal_amount.toLocaleString()}å††  \n`;
                markdown += `**ğŸ“… ç´æœŸææ¡ˆ:** ${job.delivery_estimate}  \n\n`;
            }
        } else {
            markdown += `**ğŸ’¡ æ³¨æ„:** ã“ã®æ¡ˆä»¶ã¯æ™‚çµ¦${PROPOSAL_GENERATION_MIN_HOURLY_RATE}å††æœªæº€ã®ãŸã‚ã€ææ¡ˆæ–‡ã¯ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n`;
        }

        markdown += `---\n\n`;
    });

    // æ¡ˆä»¶ä¸€è¦§ã‚’è¡¨å½¢å¼ã§å‡ºåŠ›
    if (jobs.length > 0) {
        markdown += `\n## ğŸ“‹ æ¡ˆä»¶ä¸€è¦§ï¼ˆå…¨${jobs.length}ä»¶ï¼‰\n\n`;
        markdown += `| é †ä½ | æ¡ˆä»¶å | æ™‚çµ¦ | ãŠã™ã™ã‚åº¦ | ã‚«ãƒ†ã‚´ãƒª |\n`;
        markdown += `|---|---|---|---|---|\n`;
        jobs.forEach((job, index) => {
            const rank = index + 1;
            const title = job.original_title || job.title || 'æ¡ˆä»¶åä¸æ˜';
            const hourlyRate = job.hourly_rate_numeric.toLocaleString() + 'å††';
            const score = job.recommendation_score;
            const category = job.category || 'N/A';
            markdown += `| ${rank} | [${title.substring(0, 40)}...](${job.link}) | ${hourlyRate} | ${score}ç‚¹ | ${category} |\n`;
        });
        markdown += `\n`;
    }

    return markdown;
}

// GPTã§ææ¡ˆç”¨æŒ¨æ‹¶æ–‡ã¨ä»•æ§˜è³ªå•ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
async function generateProposalContent(job: AnalysisResult, originalJob: any): Promise<{ greeting: string; delivery_estimate: string; questions: string }> {
    const prompt = `ä»¥ä¸‹ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã«ã¤ã„ã¦ã€ä¸‹è¨˜3ç‚¹ã‚’æ—¥æœ¬èªã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã€æ¡ˆä»¶æƒ…å ±ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}
è©³ç´°èª¬æ˜: ${originalJob?.detailedDescription || 'è©³ç´°ä¸æ˜'}
æƒ³å®šæ™‚çµ¦: ${job.æƒ³å®šæ™‚çµ¦}
è¦‹ç©å·¥æ•°: ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š}
é›£æ˜“åº¦: ${job.é›£æ˜“åº¦}

ã€å‡ºåŠ›å†…å®¹ã€‘
1. æˆ¦ç•¥çš„ææ¡ˆæ–‡ï¼ˆãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§è¦ªã—ã¿ã‚„ã™ã„ã€ç°¡æ½”ãªè‡ªå·±ç´¹ä»‹ãƒ»æ¡ˆä»¶ã¸ã®å–ã‚Šçµ„ã¿å§¿å‹¢ 2-3è¡Œï¼‰
2. ç´æœŸè¦‹è¾¼ã¿ï¼ˆä½•æ—¥ã§ç´å“ã§ããã†ã‹ã€‚æ ¹æ‹ ã‚‚1æ–‡ã§ï¼‰
3. ä»•æ§˜ç¢ºèªè³ªå•ï¼ˆæ¡ˆä»¶ã‚’ç¢ºå®Ÿã«æˆåŠŸã•ã›ã‚‹ãŸã‚ã®å…·ä½“çš„ãªè³ªå•ã‚’3-5å€‹ï¼‰

ã€ææ¡ˆæ–‡ã®ãƒã‚¤ãƒ³ãƒˆã€‘
- çµŒé¨“ã¨å°‚é–€æ€§ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«
- æ¡ˆä»¶ã¸ã®çœŸå‰£ãªå–ã‚Šçµ„ã¿å§¿å‹¢ã‚’ç¤ºã™
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èª²é¡Œè§£æ±ºã«ç„¦ç‚¹

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
ææ¡ˆæ–‡:
<ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ç°¡æ½”ãªææ¡ˆæ–‡>

ç´æœŸè¦‹è¾¼ã¿:
<ä¾‹: 10æ—¥ï¼ˆè¦ä»¶å®šç¾©ãƒ»ä¿®æ­£å¯¾å¿œå«ã‚€ï¼‰>

è³ªå•:
1. <è³ªå•1>
2. <è³ªå•2>
3. <è³ªå•3>
4. <è³ªå•4>
5. <è³ªå•5>`;

    try {
        const res = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚µãƒ¼ã§ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã¸ã®åŠ¹æœçš„ãªææ¡ˆæ–‡ä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¿¡é ¼ã‚’å¾—ã¦ã€æ¡ˆä»¶ã‚’å—æ³¨ã™ã‚‹ãŸã‚ã®æˆ¦ç•¥çš„ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é•·ã‘ã¦ã„ã¾ã™ã€‚' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 800,
            temperature: 0.3,
        });

        const text = res.choices[0]?.message?.content || '';

        // ææ¡ˆæ–‡ã€ç´æœŸè¦‹è¾¼ã¿ã€è³ªå•ã‚’åˆ†é›¢
        const greetingMatch = text.match(/ææ¡ˆæ–‡[:ï¼š]\s*([\s\S]*?)(?=ç´æœŸè¦‹è¾¼ã¿[:ï¼š]|$)/);
        const deliveryMatch = text.match(/ç´æœŸè¦‹è¾¼ã¿[:ï¼š]\s*([\s\S]*?)(?=è³ªå•[:ï¼š]|$)/);
        const questionsMatch = text.match(/è³ªå•[:ï¼š]\s*([\s\S]*)/);

        const greeting = greetingMatch?.[1]?.trim() || '';
        const delivery_estimate = deliveryMatch?.[1]?.trim() || '';
        const questions = questionsMatch?.[1]?.trim() || '';

        return { greeting, delivery_estimate, questions };
    } catch (e) {
        console.error(`âŒ ææ¡ˆæ–‡ãƒ»ç´æœŸãƒ»è³ªå•ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${job.jobId}):`, e);
        return { greeting: '', delivery_estimate: '', questions: '' };
    }
}

// GPTã§ã‚¹ã‚­ãƒ«é©æ€§ã‚’è©•ä¾¡ã™ã‚‹é–¢æ•°
async function analyzeSkillFit(job: AnalysisResult, originalJob: any): Promise<{ score: number; analysis: string }> {
    const prompt = `ä»¥ä¸‹ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã‚’ã€é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®è¦–ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€ä¾é ¼è€…ã®ã‚¹ã‚­ãƒ«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€‘
- é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¸¡æ–¹ï¼‰
- ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒ»APIé€£æºãŒå¾—æ„
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãªã©ã®æŠ€è¡“åŠ›é«˜ã„
- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚­ãƒ«ã¯ä½ã„ï¼ˆã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ã¯è‹¦æ‰‹ï¼‰
- CSSã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç¨‹åº¦ãªã‚‰å¯¾å¿œå¯èƒ½

ã€æ¡ˆä»¶æƒ…å ±ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}
è©³ç´°èª¬æ˜: ${originalJob?.detailedDescription || 'è©³ç´°ä¸æ˜'}
ã‚«ãƒ†ã‚´ãƒª: ${job.category}
é›£æ˜“åº¦: ${job.é›£æ˜“åº¦}

ã€è©•ä¾¡åŸºæº–ã€‘
ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ï¼ˆ0-10ç‚¹ï¼‰:
- 10ç‚¹: æŠ€è¡“åŠ›ã‚’æœ€å¤§é™æ´»ã‹ã›ã‚‹æ¡ˆä»¶ï¼ˆã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã€APIé€£æºã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç­‰ï¼‰
- 8-9ç‚¹: æŠ€è¡“ã‚¹ã‚­ãƒ«ãŒé‡è¦ãªæ¡ˆä»¶ï¼ˆWordPressã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã€ECæ©Ÿèƒ½é–‹ç™ºç­‰ï¼‰
- 6-7ç‚¹: æŠ€è¡“ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãŒåŠã€…ï¼ˆæ—¢å­˜ã‚µã‚¤ãƒˆä¿®æ­£ã€ç°¡å˜ãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç­‰ï¼‰
- 4-5ç‚¹: ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ãŒå¤šã„ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é‡è¦–ç­‰ï¼‰
- 1-3ç‚¹: ç´”ç²‹ãªãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶ï¼ˆã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ¶ä½œã€UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ç­‰ï¼‰
- 0ç‚¹: å®Œå…¨ã«ã‚¹ã‚­ãƒ«å¤–ï¼ˆã‚¤ãƒ©ã‚¹ãƒˆåˆ¶ä½œã€å‹•ç”»ç·¨é›†ç­‰ï¼‰

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
ã‚¹ã‚³ã‚¢: <0-10ã®æ•°å€¤>
åˆ†æ: <ãªãœãã®ã‚¹ã‚³ã‚¢ãªã®ã‹ã€æŠ€è¡“çš„ãªè¦³ç‚¹ã§ã®è©•ä¾¡ç†ç”±ã‚’2-3è¡Œã§>`;

    try {
        const res = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'ã‚ãªãŸã¯æŠ€è¡“äººæã®ã‚¹ã‚­ãƒ«ãƒãƒƒãƒãƒ³ã‚°å°‚é–€å®¶ã§ã€Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æŠ€è¡“åŠ›ã¨æ¡ˆä»¶è¦ä»¶ã‚’æ­£ç¢ºã«è©•ä¾¡ã§ãã¾ã™ã€‚ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚­ãƒ«ã®æœ‰ç„¡ã‚’è€ƒæ…®ã—ãŸå®Ÿç”¨çš„ãªè©•ä¾¡ã‚’è¡Œã„ã¾ã™ã€‚' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 300,
            temperature: 0.2,
        });

        const text = res.choices[0]?.message?.content || '';

        // ã‚¹ã‚³ã‚¢ã¨åˆ†æã‚’åˆ†é›¢
        const scoreMatch = text.match(/ã‚¹ã‚³ã‚¢[:ï¼š]\s*([0-9.]+)/);
        const analysisMatch = text.match(/åˆ†æ[:ï¼š]\s*([\s\S]*)/);

        const score = scoreMatch?.[1] ? parseFloat(scoreMatch[1]) : 5;
        const analysis = analysisMatch?.[1]?.trim() || '';

        return { score: Math.max(0, Math.min(10, score)), analysis };
    } catch (e) {
        console.error(`âŒ ã‚¹ã‚­ãƒ«é©æ€§åˆ†æã‚¨ãƒ©ãƒ¼ (${job.jobId}):`, e);
        return { score: 5, analysis: 'åˆ†æã‚¨ãƒ©ãƒ¼' };
    }
}

// å®Ÿè¡Œ
(async () => {
    await main();
})();
</file>

<file path="readme.md">
# CrowdWorks è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ 

## ãƒ¡ãƒ¢
ã¨ã‚Šã‚ãˆãšã€æŒ‡å®šä»¶æ•°ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ã€ã–ã£ãã‚Šã®æ™‚çµ¦ã¨ã€å·¥æ•°ã¨ã€ææ¡ˆæ–‡ã‚’è‡ªå‹•ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ
ã‹ã‹ã£ãŸæ—¥æ•°ã¯ä¸€æ—¥
ã¨ã‚Šã‚ãˆãšå›ã›ã‚‹ã‚ˆã†ã«ã¯ãªã£ãŸã®ã§ã€èª¿æ•´ã—ãªãŒã‚‰é€²ã‚ã‚‹

[![CI/CD Pipeline](https://github.com/masayuki-akinari/crowdworks-search/actions/workflows/ci.yml/badge.svg)](https://github.com/masayuki-akinari/crowdworks-search/actions/workflows/ci.yml)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.6.3-blue.svg)](https://www.typescriptlang.org/)
[![AWS CDK](https://img.shields.io/badge/AWS%20CDK-2.170.0-orange.svg)](https://aws.amazon.com/cdk/)

## ğŸ“‹ æ¦‚è¦

CrowdWorksã¨Upworkã®æ¡ˆä»¶æƒ…å ±ã‚’è‡ªå‹•åé›†ãƒ»AIè©•ä¾¡ã—ã€é«˜æ™‚çµ¦æ¡ˆä»¶ã‚’ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### ğŸš€ ä¸»è¦æ©Ÿèƒ½
- **çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒ**: CrowdWorks + Upworkã®çµ±åˆæ¡ˆä»¶æ¤œç´¢
- **è‡ªå‹•ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°**: Playwright + Chromiumã«ã‚ˆã‚‹15åˆ†é–“éš”å®Ÿè¡Œ
- **AIè©•ä¾¡**: OpenAI GPT-4ã«ã‚ˆã‚‹æ¡ˆä»¶å“è³ªè©•ä¾¡
- **é«˜æ™‚çµ¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: æ™‚çµ¦ä¸€å®šä»¥ä¸Šã®æ¡ˆä»¶è‡ªå‹•æŠ½å‡º
- **è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ**: Markdown/JSONå½¢å¼ã§ã®è‡ªå‹•ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
- **ã‚¹ãƒãƒ¼ãƒˆé€šçŸ¥**: é«˜è©•ä¾¡æ¡ˆä»¶ã®å³åº§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: æœˆé¡$5ä»¥ä¸‹ã§ã®é‹ç”¨

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TB
    A[EventBridge] -->|15åˆ†é–“éš”| B[Lambda Function]
    B -->|ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°| C[CrowdWorks]
    B -->|AIè©•ä¾¡| D[OpenAI API]
    B -->|ãƒ‡ãƒ¼ã‚¿ä¿å­˜| E[S3 Bucket]
    B -->|é«˜è©•ä¾¡é€šçŸ¥| F[SNS/SES]
    G[CloudWatch] -->|ç›£è¦–| B
```

**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯:**
- **å®Ÿè¡Œç’°å¢ƒ**: AWS Lambda (ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸)
- **ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–**: Playwright + Chromium
- **AIè©•ä¾¡**: OpenAI GPT-4 API
- **ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Amazon S3
- **é€šçŸ¥**: Amazon SNS/SES
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°**: Amazon EventBridge
- **ã‚¤ãƒ³ãƒ•ãƒ©**: AWS CDK (TypeScript)

## âš ï¸ **é‡è¦: Playwright Lambdaåˆ¶ç´„ã¨å¯¾å¿œ**

### æŠ€è¡“çš„èª²é¡Œ
- **Lambda ZIPåˆ¶é™**: 250MBï¼ˆPlaywright: ~300MBï¼‰
- **ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒŠãƒª**: Chromiumå˜ä½“ã§200MB+

### âœ… **æ¡ç”¨æ–¹é‡: Lambdaã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸**

**é¸æŠç†ç”±:**
- âœ… **å®¹é‡åˆ¶é™**: 10GBã¾ã§å¯¾å¿œï¼ˆZIP: 250MB â†’ Container: 10GBï¼‰
- âœ… **å®Œå…¨æ©Ÿèƒ½**: ãƒ•ãƒ«Playwright + Chromiumç’°å¢ƒ
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ZIPç‰ˆã¨åŒç­‰ã®èµ·å‹•æ™‚é–“
- âœ… **é–‹ç™ºåŠ¹ç‡**: æ—¢å­˜Dockerfileã‚’æ´»ç”¨å¯èƒ½
- âœ… **é‹ç”¨ã‚³ã‚¹ãƒˆ**: æœˆ$5-10ã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿

```dockerfile
# ç¾åœ¨ã®Dockerfileæ§‹æˆ
FROM mcr.microsoft.com/playwright/python:v1.45.0-jammy
# â†’ Lambda Container Imageã¨ã—ã¦æ´»ç”¨
```

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. å‰ææ¡ä»¶
```bash
# å¿…è¦ãªãƒ„ãƒ¼ãƒ«
- Node.js 18+
- AWS CLI v2
- Docker Desktop
- AWS CDK CLI
```

### 2. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/masayuki-akinari/crowdworks-search.git
cd crowdworks-search

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# ç’°å¢ƒå¤‰æ•°è¨­å®š
cp env.example .env
# .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦APIèªè¨¼æƒ…å ±ã‚’è¨­å®š

# ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã‚’è¿½åŠ ï¼š
# LANCERS_EMAIL=your-lancers-email@example.com
# LANCERS_PASSWORD=your-lancers-password

# AWSèªè¨¼æƒ…å ±è¨­å®š
aws configure

# CDKåˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
npx cdk bootstrap
```

### 3. æ–°æ©Ÿèƒ½: çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒ
```bash
# åŸºæœ¬çš„ãªçµ±åˆæ¤œç´¢å®Ÿè¡Œï¼ˆæœ€ä½æ™‚çµ¦3000å††ï¼‰
npm run integrated-search

# é«˜æ™‚çµ¦æ¡ˆä»¶æ¤œç´¢ï¼ˆæœ€ä½æ™‚çµ¦4000å††ï¼‰
npm run search:high-rate

# é–‹ç™ºè€…å‘ã‘æ¡ˆä»¶æ¤œç´¢ï¼ˆReact, TypeScriptç­‰ï¼‰
npm run search:dev

# ã‚«ã‚¹ã‚¿ãƒ æ¤œç´¢
npm run integrated-search -- --min-rate 5000 --max-jobs 30 --keywords "nodejs,aws"
```

### 3. **ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰**
```bash
# ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
npm run cdk:deploy

# ã¾ãŸã¯æ‰‹å‹•ã§ã®æ®µéšå®Ÿè¡Œ
docker build -t crowdworks-searcher .
npx cdk deploy --context deployMethod=container
```

### 4. è¨­å®š
```bash
# AWS Parameter Storeã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
aws ssm put-parameter \
  --name "/crowdworks-search/openai-api-key" \
  --value "your-openai-api-key" \
  --type "SecureString"

aws ssm put-parameter \
  --name "/crowdworks-search/crowdworks-email" \
  --value "your-crowdworks-email" \
  --type "SecureString"
```

## ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜

### å®Ÿè¡Œã‚¹ãƒšãƒƒã‚¯
```yaml
Lambdaä»•æ§˜:
  ãƒ‡ãƒ—ãƒ­ã‚¤å½¢å¼: Container Image (ECR)
  ãƒ¡ãƒ¢ãƒª: 3,008 MB
  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 15åˆ†
  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: x86_64
  
Playwrightè¨­å®š:
  ãƒ–ãƒ©ã‚¦ã‚¶: Chromium (ãƒ•ãƒ«ç‰ˆ)
  ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰: true
  å®Ÿè¡Œé–“éš”: 15åˆ†
```

### ã‚³ã‚¹ãƒˆæ§‹é€ ï¼ˆæœˆé¡ï¼‰
```yaml
Lambdaå®Ÿè¡Œ:
  1,000å›/æœˆ Ã— 10ç§’: $2-5
ECRã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 
  1GB Docker Image: $0.10
CloudWatch:
  ãƒ­ã‚° & ç›£è¦–: $2-3
OpenAI API:
  GPT-4å‘¼ã³å‡ºã—: $1-2
åˆè¨ˆ: $5-10/æœˆ
```

## ğŸ”§ é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
```bash
# TypeScripté–‹ç™ºãƒ¢ãƒ¼ãƒ‰
npm run dev

# Dockerã§ã®ãƒ†ã‚¹ãƒˆ
npm run docker:build
npm run docker:run

# ãƒ­ãƒ¼ã‚«ãƒ«Playwrightå®Ÿè¡Œ
npx playwright install chromium
npm run test:e2e
```

## ğŸ“š çµ±åˆã‚¸ãƒ§ãƒ–ã‚µãƒ¼ãƒã®ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰
```bash
# å…¨ã¦ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¡¨ç¤º
npm run integrated-search -- --help

# åŸºæœ¬æ¤œç´¢ï¼ˆæœ€ä½æ™‚çµ¦3000å††ã€æœ€å¤§50ä»¶/ã‚µã‚¤ãƒˆï¼‰
npm run integrated-search

# æ¡ä»¶æŒ‡å®šæ¤œç´¢
npm run integrated-search -- --min-rate 4000 --max-jobs 30

# ã‚«ãƒ†ã‚´ãƒªæŒ‡å®šæ¤œç´¢
npm run integrated-search -- --categories "web,mobile"

# ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
npm run integrated-search -- --keywords "react,typescript,nodejs"

# å‡ºåŠ›å½¢å¼æŒ‡å®š
npm run integrated-search -- --format markdown
```

### ç’°å¢ƒå¤‰æ•°è¨­å®š
```bash
# Upwork APIèªè¨¼ï¼ˆå¿…é ˆï¼‰
UPWORK_CONSUMER_KEY=your_consumer_key
UPWORK_CONSUMER_SECRET=your_consumer_secret
UPWORK_ACCESS_TOKEN=your_access_token    # ã‚ªãƒ—ã‚·ãƒ§ãƒ³
UPWORK_ACCESS_TOKEN_SECRET=your_secret   # ã‚ªãƒ—ã‚·ãƒ§ãƒ³

# OpenAI APIï¼ˆAIåˆ†æç”¨ï¼‰
OPENAI_API_KEY=your_openai_api_key
```

### å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
å®Ÿè¡Œå¾Œã€`output/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼š

- `integrated-job-report-YYYY-MM-DD.json` - JSONå½¢å¼ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ
- `integrated-job-report-YYYY-MM-DD.md` - Markdownå½¢å¼ã®ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ  
- `high-value-jobs-YYYY-MM-DD.md` - é«˜æ™‚çµ¦æ¡ˆä»¶ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ

### ãƒ¬ãƒãƒ¼ãƒˆå†…å®¹
- **CrowdWorks**: æ—¢å­˜ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ©Ÿèƒ½ã«ã‚ˆã‚‹æ¡ˆä»¶å–å¾—
- **Upwork**: APIçµŒç”±ã§ã®æ¡ˆä»¶å–å¾—ï¼ˆãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼‰
- **é€šè²¨å¤‰æ›**: USDâ†’JPYè‡ªå‹•å¤‰æ›ï¼ˆç¾åœ¨ãƒ¬ãƒ¼ãƒˆ: 1USD = 150JPYï¼‰
- **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: æ™‚çµ¦ä¸€å®šä»¥ä¸Šã®æ¡ˆä»¶è‡ªå‹•æŠ½å‡º
- **AIåˆ†æ**: å¸‚å ´å‹•å‘ã¨ãŠã™ã™ã‚æ¡ˆä»¶ã®åˆ†æ

### ãƒ­ã‚°ç¢ºèª
```bash
# CloudWatch Logsç¢ºèª
aws logs tail /aws/lambda/crowdworks-searcher-main --follow

# Lambdaå®Ÿè¡ŒçŠ¶æ³ç¢ºèª
aws lambda invoke \
  --function-name crowdworks-searcher-main \
  --payload '{}' \
  response.json
```

## ğŸ› ï¸ ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: è»½é‡ç‰ˆ

**äºˆç®—æœ€å„ªå…ˆã®å ´åˆ:**
```typescript
// @sparticuz/chromiumä½¿ç”¨ï¼ˆè»½é‡ç‰ˆï¼‰
import { chromium } from 'playwright-core';
import chromium_binary from '@sparticuz/chromium';

const browser = await chromium.launch({
  args: [...chromium_binary.args, '--no-sandbox'],
  executablePath: await chromium_binary.executablePath()
});
```

**åˆ¶ç´„:**
- æ©Ÿèƒ½åˆ¶é™ã‚ã‚Šï¼ˆè»½é‡Chromiumï¼‰
- Lambda Layerå¿…è¦
- ãƒ‡ãƒãƒƒã‚°å›°é›£

## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### è¨­è¨ˆæ›¸
- [ğŸ“‹ å®Ÿè£…è¨ˆç”»æ›¸](./docs/05_implementation_plan.md)
- [ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](./docs/01_architecture.md)
- [ğŸ”§ CI/CD ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](./docs/CI_CD_SETUP.md)

### é‹ç”¨ã‚¬ã‚¤ãƒ‰
- [ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰](./docs/02_deployment.md)
- [ğŸ“Š ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ](./docs/03_monitoring.md)
- [ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](./docs/04_security.md)

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰ã§ã¯ã€å‰ææ¡ä»¶ã®ç¢ºèªã‹ã‚‰ `cdk bootstrap`ã€`npm run cdk:deploy` ã®å®Ÿè¡Œã¾ã§ã‚’æ•´ç†ã—ã¦ã„ã¾ã™ã€‚ã•ã‚‰ã«ã€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚‹è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

## ğŸ¯ ç¾åœ¨ã®é–‹ç™ºçŠ¶æ³

### âœ… å®Œäº†æ¸ˆã¿
- [x] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
- [x] TypeScript + CDKåŸºç›¤
- [x] Dockerç’°å¢ƒæ•´å‚™
- [x] Playwright Lambdaå¯¾å¿œç­–ç­–å®š

### ğŸ”„ é€²è¡Œä¸­
- [ ] **ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå‹•ä½œç¢ºèª**ï¼ˆæœ€å„ªå…ˆï¼‰
- [ ] CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè£…
- [ ] OpenAI APIé€£æº

### ğŸ“‹ ä»Šå¾Œã®äºˆå®š
- [ ] S3ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ©Ÿèƒ½
- [ ] ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ã‚¨ãƒ©ãƒ¼ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

## ğŸš¨ æ—¢çŸ¥ã®åˆ¶ç´„ãƒ»æ³¨æ„äº‹é …

### Playwrightåˆ¶ç´„
- âŒ **Lambda ZIPç‰ˆ**: ç¢ºå®Ÿã«å®¹é‡åˆ¶é™è¶…é
- âœ… **Containerç‰ˆ**: å‹•ä½œç¢ºèªæ¸ˆã¿ã€æ¨å¥¨
- âš ï¸ **è»½é‡ç‰ˆ**: æ©Ÿèƒ½åˆ¶é™ã‚ã‚Šã€äºˆç®—é‡è¦–å‘ã‘

### CrowdWorksåˆ¶ç´„
- **åˆ©ç”¨è¦ç´„éµå®ˆ**: éåº¦ãªã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: 15åˆ†é–“éš”ã§ã®ç©å¥ãªå®Ÿè¡Œ
- **ä»•æ§˜å¤‰æ›´ãƒªã‚¹ã‚¯**: ã‚µã‚¤ãƒˆå¤‰æ›´ã¸ã®å¯¾å¿œå¿…è¦

### ã‚³ã‚¹ãƒˆåˆ¶ç´„
- **æœˆé¡ç›®æ¨™**: $5ä»¥ä¸‹
- **å®Ÿæ¸¬å€¤**: ã‚³ãƒ³ãƒ†ãƒŠç‰ˆã§$5-10
- **ç›£è¦–**: AWS Cost Explorerè¨­å®šæ¸ˆã¿

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

### ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–
- TypeScript strict modeå¿…é ˆ
- anyå‹ä½¿ç”¨ç¦æ­¢
- 80%ä»¥ä¸Šã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- ESLint + Prettierãƒ«ãƒ¼ãƒ«éµå®ˆ

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License - è©³ç´°ã¯ [LICENSE](./LICENSE) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

- **Issueå ±å‘Š**: [GitHub Issues](https://github.com/masayuki-akinari/crowdworks-search/issues)
- **è³ªå•ãƒ»ç›¸è«‡**: [GitHub Discussions](https://github.com/masayuki-akinari/crowdworks-search/discussions)

---

**âš¡ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: [å®Ÿè£…è¨ˆç”»æ›¸](./docs/05_implementation_plan.md) ã§è©³ç´°ãªé–‹ç™ºãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

npm run full-analysis:quick
ã¨ã‚Šã‚ãˆãšå®Ÿè¡Œç”¨ã‚³ãƒãƒ³ãƒ‰
</file>

<file path="package.json">
{
    "name": "crowdworks-search",
    "version": "1.0.0",
    "description": "ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶è‡ªå‹•æ¤œç´¢ãƒ»è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ",
    "main": "dist/index.js",
    "scripts": {
        "build": "tsc",
        "start": "node dist/index.js",
        "test": "echo \"Error: no test specified\" && exit 1",
        "lint": "eslint src/**/*.ts",
        "lint:fix": "eslint src/**/*.ts --fix",
        
        "handler": "npx ts-node -r dotenv/config src/lambda/handler.ts",
        "h": "npm run handler",
        
        "auto": "npx ts-node scripts/full-pipeline.ts 3000 10",
        "auto:quick": "npx ts-node scripts/full-pipeline.ts 2000 5",
        "auto:premium": "npx ts-node scripts/full-pipeline.ts 5000 15",
        
        "analysis": "npx ts-node scripts/create-unified-report.ts 3000",
        "analysis:quick": "npx ts-node scripts/create-unified-report.ts 1000", 
        "analysis:premium": "npx ts-node scripts/create-unified-report.ts 5000"
    },
    "keywords": [
        "crowdworks",
        "automation",
        "scraping",
        "aws",
        "serverless",
        "typescript"
    ],
    "author": "Your Name",
    "license": "MIT",
    "private": true,
    "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
    },
    "dependencies": {
        "@aws-sdk/client-lambda": "^3.450.0",
        "@aws-sdk/client-s3": "^3.450.0",
        "@aws-sdk/client-sns": "^3.450.0",
        "@aws-sdk/client-ssm": "^3.540.0",
        "aws-cdk-lib": "^2.156.0",
        "aws-lambda": "^1.0.7",
        "aws-sdk": "^2.1691.0",
        "constructs": "^10.3.0",
        "dotenv": "^16.5.0",
        "openai": "^4.50.0",
        "playwright": "^1.48.2",
        "source-map-support": "^0.5.21",
        "typescript": "^5.6.3",
        "zod": "^3.22.0"
    },
    "devDependencies": {
        "@types/aws-lambda": "^8.10.145",
        "@types/jest": "^29.5.14",
        "@types/node": "^22.9.1",
        "@typescript-eslint/eslint-plugin": "^8.14.0",
        "@typescript-eslint/parser": "^8.14.0",
        "aws-cdk": "^2.170.0",
        "cross-env": "^7.0.3",
        "esbuild": "^0.24.0",
        "eslint": "^9.14.0",
        "eslint-config-prettier": "^9.1.0",
        "eslint-plugin-prettier": "^5.2.1",
        "husky": "^8.0.0",
        "jest": "^29.7.0",
        "lint-staged": "^15.0.0",
        "nock": "^13.3.0",
        "nodemon": "^3.1.7",
        "prettier": "^3.3.3",
        "ts-jest": "^29.2.5",
        "ts-node": "^10.9.2",
        "tsconfig-paths": "^4.2.0"
    },
    "husky": {
        "hooks": {
            "pre-commit": "lint-staged",
            "pre-push": "npm run type-check && npm run test"
        }
    },
    "lint-staged": {
        "src/**/*.{ts,tsx}": [
            "eslint --fix",
            "prettier --write",
            "git add"
        ]
    }
}
</file>

<file path="src/lambda/handler.ts">
/**
 * AWS Lambda Handler for CrowdWorks Search System
 * ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° + AIåˆ†æã®çµ±åˆã‚·ã‚¹ãƒ†ãƒ 
 */

// ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã®ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
if (!process.env['AWS_LAMBDA_FUNCTION_NAME']) {
  try {
    require('dotenv').config();
    console.log('ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  } catch (error) {
    console.log('âš ï¸ dotenvãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆLambdaç’°å¢ƒã§ã¯æ­£å¸¸ï¼‰');
  }
}

import { Context } from 'aws-lambda';
import { chromium, Browser, Page } from 'playwright';
import { LancersService, LancersJob, LancersJobDetail, LancersScrapingResult } from '../services/LancersService';

// Lambda Event Types
interface ScheduledExecutionEvent {
  source: string;
  'detail-type': string;
  detail: Record<string, any>;
  time?: string;
}

interface ScheduledExecutionResponse {
  statusCode: number;
  body: string;
  executionTime: number;
  timestamp: string;
}

// CrowdWorksæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹
interface CrowdWorksJob {
  id: string;
  title: string;
  description: string;
  url: string;
  budget: {
    type: 'fixed' | 'hourly' | 'unknown';
    amount: number;
    currency: string;
  };
  category: string;
  tags: string[];
  client: {
    name: string;
    rating: number;
    reviewCount: number;
  };
  postedAt: string;
  deadline?: string;
  applicants: number;
  scrapedAt: string;
}

// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœå‹
interface ScrapingResult {
  success: boolean;
  jobsFound: number;
  jobs: CrowdWorksJob[];
  error?: string;
  executionTime: number;
}

// æ¡ˆä»¶è©³ç´°æƒ…å ±ã®å‹å®šç¾©
interface CrowdWorksJobDetail {
  jobId: string;
  title: string;
  category: string;
  url: string;
  paymentType: string;
  budget: string;
  deliveryDate: string;
  postDate: string;
  applicationDeadline: string;
  desiredImages: string[];
  applicantCount: number;
  contractCount: number;
  recruitmentCount: number;
  favoriteCount: number;
  detailedDescription: string;
  client: {
    name: string;
    url: string;
    overallRating: string;
    orderHistory: string;
    completionRate: string;
    thankCount: string;
    identityVerified: boolean;
    orderRuleCheck: boolean;
    description: string;
  };
  recentApplicants: Array<{
    name: string;
    url: string;
    applicationDate: string;
  }>;
  scrapedAt: string;
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
async function readFileAsync(filePath: string): Promise<string | null> {
  return new Promise((resolve) => {
    const fs = require('fs');
    fs.readFile(filePath, 'utf8', (err: any, data: string) => {
      if (err) resolve(null);
      else resolve(data);
    });
  });
}

/**
 * ã‚«ãƒ†ã‚´ãƒªåˆ¥CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼‰
 */
async function scrapeCrowdWorksJobsByCategory(
  page: Page,
  category: string,
  maxJobs: number = 20
): Promise<ScrapingResult> {
  const startTime = Date.now();

  try {
    const categoryUrls: { [key: string]: string } = {
      'ec': 'https://crowdworks.jp/public/jobs/group/ec',
      'web_products': 'https://crowdworks.jp/public/jobs/group/web_products',
      'software_development': 'https://crowdworks.jp/public/jobs/group/software_development',
      'development': 'https://crowdworks.jp/public/jobs/group/development',
      'writing': 'https://crowdworks.jp/public/jobs/category/141',
      'translation': 'https://crowdworks.jp/public/jobs/category/406',
      'marketing': 'https://crowdworks.jp/public/jobs/category/539',
      'system_development': 'https://crowdworks.jp/public/jobs/group/development',
      'app_development': 'https://crowdworks.jp/public/jobs/group/software_development'
    };

    const baseUrl = categoryUrls[category];
    if (!baseUrl) {
      throw new Error(`æœªçŸ¥ã®ã‚«ãƒ†ã‚´ãƒª: ${category}`);
    }

    console.log(`ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹ (æœ€å¤§${maxJobs}ä»¶)`);

    const jobs: CrowdWorksJob[] = [];
    let currentPage = 1;
    let consecutiveEmptyPages = 0;
    const maxConsecutiveEmptyPages = 3;
    const maxPages = Math.ceil(maxJobs / 20) + 2; // 1ãƒšãƒ¼ã‚¸ç´„20ä»¶ã¨ã—ã¦è¨ˆç®—ã—ã€ä½™è£•ã‚’ã‚‚ãŸã›ã‚‹

    while (jobs.length < maxJobs && currentPage <= maxPages && consecutiveEmptyPages < maxConsecutiveEmptyPages) {
      const pageUrl = currentPage === 1 ? baseUrl : `${baseUrl}?page=${currentPage}`;
      console.log(`ğŸ“„ ãƒšãƒ¼ã‚¸ ${currentPage} ã‚’å‡¦ç†ä¸­: ${pageUrl}`);

      try {
        await page.goto(pageUrl, { waitUntil: 'networkidle', timeout: 30000 });
        await page.waitForTimeout(2000); // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰å¾Œã®å¾…æ©Ÿ

        // æ¡ˆä»¶ãƒªã‚¹ãƒˆã®å–å¾—
        const pageJobs = await page.evaluate(() => {
          // å®Ÿéš›ã®DOMæ§‹é€ ã«åˆã‚ã›ãŸã‚»ãƒ¬ã‚¯ã‚¿
          const jobListContainer = document.querySelector('main list, [role="list"], ul:has(li h3)');
          if (!jobListContainer) {
            console.log('æ¡ˆä»¶ãƒªã‚¹ãƒˆå®¹å™¨ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return [];
          }

          const jobElements = jobListContainer.querySelectorAll('listitem, [role="listitem"], li:has(h3)');
          console.log(`å–å¾—ã—ãŸæ¡ˆä»¶è¦ç´ æ•°: ${jobElements.length}`);
          
          const pageJobs: any[] = [];

          jobElements.forEach((element: Element, index: number) => {
            try {
              // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—
              let titleElement = element.querySelector('h3 a, [level="3"] a, heading a');
              let titleText = '';
              let jobUrl = '';
              
              if (titleElement) {
                titleText = titleElement.textContent?.trim() || '';
                jobUrl = (titleElement as HTMLAnchorElement).href || '';
              }

              // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å–å¾—ï¼ˆæ¡ˆä»¶å†…ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒªãƒ³ã‚¯ã‹ã‚‰ï¼‰
              let categoryElement = element.querySelector('a[href*="/category/"]');
              let categoryText = categoryElement?.textContent?.trim() || '';

              // èª¬æ˜æ–‡ã®å–å¾—
              let descriptionElement = element.querySelector('paragraph, p');
              let descriptionText = descriptionElement?.textContent?.trim() || '';

              // å ±é…¬æƒ…å ±ã®å–å¾—
              let priceText = '';
              const priceElements = element.querySelectorAll('generic');
              for (const generic of Array.from(priceElements)) {
                const text = generic.textContent?.trim() || '';
                if (text.includes('å††') && (text.includes('ã€œ') || text.includes('å›ºå®š') || text.includes('æ™‚é–“'))) {
                  priceText = text;
                  break;
                }
              }

              // å¥‘ç´„æ•°ãƒ»å¿œå‹ŸæœŸé™ã®å–å¾—
              let contractsText = '';
              let deadlineText = '';
              for (const generic of Array.from(priceElements)) {
                const text = generic.textContent?.trim() || '';
                if (text.includes('å¥‘ç´„æ•°')) {
                  contractsText = text;
                } else if (text.includes('ã‚ã¨') && (text.includes('æ—¥') || text.includes('æ™‚é–“'))) {
                  deadlineText = text;
                }
              }

              // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã®å–å¾—
              let clientElement = element.querySelector('a[href*="/employers/"]');
              let clientName = clientElement?.textContent?.trim() || '';

              // URLãŒç›¸å¯¾ãƒ‘ã‚¹ã®å ´åˆã¯çµ¶å¯¾ãƒ‘ã‚¹ã«å¤‰æ›
              if (jobUrl && jobUrl.startsWith('/')) {
                jobUrl = 'https://crowdworks.jp' + jobUrl;
              }

              // å¿…è¦ãªæƒ…å ±ãŒå–å¾—ã§ããŸå ´åˆã®ã¿è¿½åŠ 
              if (titleText && jobUrl) {
                console.log(`æ¡ˆä»¶${index + 1}: ${titleText}`);
                pageJobs.push({
                  title: titleText,
                  url: jobUrl,
                  description: descriptionText.substring(0, 200), // 200æ–‡å­—ã§åˆ‡ã‚Šè©°ã‚
                  price: priceText,
                  client: clientName,
                  category: categoryText,
                  contracts: contractsText,
                  deadline: deadlineText,
                  scraped_at: new Date().toISOString()
                });
              } else {
                console.log(`æ¡ˆä»¶${index + 1}: å¿…è¦ãªæƒ…å ±ãŒä¸è¶³ - title: ${titleText}, url: ${jobUrl}`);
              }
            } catch (error) {
              console.log(`æ¡ˆä»¶${index + 1}ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:`, error);
            }
          });

          console.log(`ãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã•ã‚ŒãŸæ¡ˆä»¶æ•°: ${pageJobs.length}`);
          return pageJobs;
        });

        if (pageJobs.length === 0) {
          consecutiveEmptyPages++;
          console.log(`âš ï¸ ãƒšãƒ¼ã‚¸ ${currentPage}: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (é€£ç¶š${consecutiveEmptyPages}å›ç›®)`);
        } else {
          consecutiveEmptyPages = 0;
          jobs.push(...pageJobs);
          console.log(`âœ… ãƒšãƒ¼ã‚¸ ${currentPage}: ${pageJobs.length}ä»¶å–å¾— (ç´¯è¨ˆ: ${jobs.length}ä»¶)`);
        }

      } catch (error) {
        console.log(`âŒ ãƒšãƒ¼ã‚¸ ${currentPage} å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, error instanceof Error ? error.message : String(error));
        consecutiveEmptyPages++;
      }

      currentPage++;
    }

    // æœ€å¤§ä»¶æ•°ã«åˆ¶é™
    const limitedJobs = jobs.slice(0, maxJobs);
    const executionTime = Date.now() - startTime;

    console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å®Œäº†: ${limitedJobs.length}ä»¶å–å¾— (${executionTime}ms)`);

    return {
      success: true,
      jobsFound: limitedJobs.length,
      jobs: limitedJobs,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:`, errorMessage);

    return {
      success: false,
      jobsFound: 0,
      jobs: [],
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * æ¡ˆä»¶è©³ç´°ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
 */
export async function scrapeCrowdWorksJobDetail(page: Page, jobUrl: string): Promise<CrowdWorksJobDetail> {
  console.log(`ğŸ” è©³ç´°å–å¾—: ${jobUrl}`);

  try {
    await page.goto(jobUrl, { waitUntil: 'networkidle', timeout: 30000 });

    const detail = await page.evaluate(() => {
      const getNumbers = (text: string): number => {
        const match = text.match(/(\d+)/);
        return match?.[1] ? parseInt(match[1]) : 0;
      };

      // ã‚¿ã‚¤ãƒˆãƒ«ã®å–å¾—ï¼ˆå®Ÿéš›ã®DOMæ§‹é€ ã«åŸºã¥ãï¼‰
      const title = (() => {
        // ãƒ¡ã‚¤ãƒ³ã®h1è¦ç´ ã‹ã‚‰æŠ½å‡º
        const h1 = document.querySelector('heading[level="1"]');
        if (h1) {
          const fullText = h1.textContent?.trim() || '';
          // "â˜…â˜…ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹ãƒ™ãƒ«ãƒˆã®æ¨è–¦ã‚’ã—ã¦ãã ã•ã‚‹æ–¹ã‚’å‹Ÿé›†ã—ã¾ã™â˜…â˜… å•†å“ç´¹ä»‹æ–‡ä½œæˆã®ä»•äº‹ã®ä¾é ¼"ã‹ã‚‰æ¡ˆä»¶åã‚’æŠ½å‡º
          const jobMatch = fullText.split('ã®ä»•äº‹ã®ä¾é ¼')[0];
          if (jobMatch) {
            // ã•ã‚‰ã«æœ€å¾Œã®ã‚«ãƒ†ã‚´ãƒªåã‚’é™¤å»
            const titleParts = jobMatch.split(' ');
            if (titleParts.length > 1) {
              // æœ€å¾Œã®è¦ç´ ãŒã‚«ãƒ†ã‚´ãƒªåã®å ´åˆã¯é™¤å»
              const lastPart = titleParts[titleParts.length - 1];
              if (lastPart && (lastPart.includes('ä½œæˆ') || lastPart.includes('é–‹ç™º') || lastPart.includes('é‹å–¶'))) {
                titleParts.pop();
              }
            }
            return titleParts.join(' ').trim();
          }
        }
        return '';
      })();

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰åŸºæœ¬æƒ…å ±ã‚’å–å¾—ï¼ˆrole="table"ã§æ¤œç´¢ï¼‰
      const tables = document.querySelectorAll('table, [role="table"]');
      let paymentType = '';
      let budget = '';
      let deliveryDate = '';
      let postDate = '';
      let applicationDeadline = '';
      let applicantCount = 0;
      let contractCount = 0;
      let recruitmentCount = 0;
      let favoriteCount = 0;
      
      // ä»•äº‹ã®æ¦‚è¦ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ1ç•ªç›®ï¼‰ã‹ã‚‰å–å¾—
      if (tables.length > 0) {
        const conceptTable = tables[0];
        if (conceptTable) {
          // rowã§æ¤œç´¢ã—ã¦ã‚»ãƒ«æƒ…å ±ã‚’å–å¾—
          const rows = conceptTable.querySelectorAll('row, tr, [role="row"]');
          rows.forEach(row => {
            const cells = row.querySelectorAll('cell, td, [role="cell"]');
            if (cells.length >= 2) {
              const label = cells[0]?.textContent?.trim() || '';
              const value = cells[1]?.textContent?.trim() || '';
              
              if (label.includes('å›ºå®šå ±é…¬åˆ¶') || label.includes('æ™‚é–“å˜ä¾¡')) {
                paymentType = label;
                budget = value;
              } else if (label.includes('ç´å“å¸Œæœ›æ—¥')) {
                deliveryDate = value;
              } else if (label.includes('æ²è¼‰æ—¥')) {
                postDate = value;
              } else if (label.includes('å¿œå‹ŸæœŸé™')) {
                applicationDeadline = value;
              }
            }
          });
        }
      }

      // å¿œå‹ŸçŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ2ç•ªç›®ï¼‰ã‹ã‚‰å–å¾—
      if (tables.length > 1) {
        const statusTable = tables[1];
        if (statusTable) {
          const rows = statusTable.querySelectorAll('row, tr, [role="row"]');
          rows.forEach(row => {
            const cells = row.querySelectorAll('cell, td, [role="cell"]');
            if (cells.length >= 2) {
              const label = cells[0]?.textContent?.trim() || '';
              const value = cells[1]?.textContent?.trim() || '';
              
              if (label.includes('å¿œå‹Ÿã—ãŸäºº')) {
                applicantCount = getNumbers(value);
              } else if (label.includes('å¥‘ç´„ã—ãŸäºº')) {
                contractCount = getNumbers(value);
              } else if (label.includes('å‹Ÿé›†äººæ•°')) {
                recruitmentCount = getNumbers(value);
              } else if (label.includes('æ°—ã«ãªã‚‹')) {
                favoriteCount = getNumbers(value);
              }
            }
          });
        }
      }

      // è©³ç´°èª¬æ˜ã®å–å¾—ï¼ˆä»•äº‹ã®è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
      let detailedDescription = '';
      if (tables.length > 2) {
        const detailTable = tables[2];
        if (detailTable) {
          const rows = detailTable.querySelectorAll('row, tr, [role="row"]');
          if (rows.length > 0) {
            const firstRow = rows[0];
            if (firstRow) {
              const cell = firstRow.querySelector('cell, td, [role="cell"]');
              if (cell) {
                detailedDescription = cell.textContent?.trim() || '';
              }
            }
          }
        }
      }

      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã®å–å¾—ï¼ˆæ­£ç¢ºãªã‚»ãƒ¬ã‚¯ã‚¿ã§ï¼‰
      let clientName = '';
      let clientUrl = '';
      let overallRating = '';
      let orderHistory = '';
      let completionRate = '';
      let thankCount = '';
      let identityVerified = false;
      let orderRuleCheck = false;
      let clientDescription = '';

      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã¨URLã®å–å¾—
      const clientLink = document.querySelector('link[href*="employers"]:not([href*="user_occupations"])');
      if (clientLink) {
        clientName = clientLink.textContent?.trim() || '';
        const href = (clientLink as any).getAttribute('href');
        if (href) {
          clientUrl = href.startsWith('http') ? href : `https://crowdworks.jp${href}`;
        }
      }

      // è©•ä¾¡ãƒ»å®Ÿç¸¾æƒ…å ±ï¼ˆdefinitionè¦ç´ ã‹ã‚‰ï¼‰
      const definitions = document.querySelectorAll('definition, [role="definition"]');
      definitions.forEach((def) => {
        const text = def.textContent?.trim() || '';
        if (text.match(/^\d+(\.\d+)?$/)) { // æ•°å€¤ã®ã¿ï¼ˆè©•ä¾¡ï¼‰
          overallRating = text;
        } else if (text.includes('ä»¶') && text.match(/^\d+/)) { // â—‹â—‹ä»¶ï¼ˆå‹Ÿé›†å®Ÿç¸¾ï¼‰
          orderHistory = text;
        } else if (text.includes('%')) { // â—‹â—‹%ï¼ˆå®Œäº†ç‡ï¼‰
          completionRate = text;
        }
      });

      // ã‚ã‚ŠãŒã¨ã†ä»¶æ•°
      const thankElements = document.querySelectorAll('text');
      thankElements.forEach(textEl => {
        const text = textEl.textContent?.trim() || '';
        if (text.includes('ã‚ã‚ŠãŒã¨ã†') && text.includes('ä»¶')) {
          thankCount = text;
        } else if (text.includes('æœ¬äººç¢ºèª')) {
          identityVerified = !text.includes('æœªæå‡º');
        } else if (text.includes('ç™ºæ³¨ãƒ«ãƒ¼ãƒ«')) {
          orderRuleCheck = text.includes('æ¸ˆã¿');
        }
      });

      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª¬æ˜ï¼ˆäº‹æ¥­å†…å®¹ï¼‰
      const businessElements = document.querySelectorAll('generic');
      businessElements.forEach(el => {
        const text = el.textContent?.trim() || '';
        if (text && text.includes('äº‹æ¥­') && text.length > 5 && text.length < 50) {
          clientDescription = text;
        }
      });

      return {
        title,
        paymentType,
        budget,
        deliveryDate,
        postDate,
        applicationDeadline,
        applicantCount,
        contractCount,
        recruitmentCount,
        favoriteCount,
        detailedDescription,
        client: {
          name: clientName,
          url: clientUrl,
          overallRating,
          orderHistory,
          completionRate,
          thankCount,
          identityVerified,
          orderRuleCheck,
          description: clientDescription
        },
        recentApplicants: []
      };
    });

    // URLã‹ã‚‰jobIdã‚’æŠ½å‡º
    const jobId = jobUrl.match(/\/jobs\/(\d+)/)?.[1] || '';

    return {
      jobId,
      category: '',
      url: jobUrl,
      desiredImages: [],
      scrapedAt: new Date().toISOString(),
      ...detail
    };

  } catch (error) {
    console.error(`âŒ è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼ (${jobUrl}):`, error);
    throw error;
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¡ˆä»¶å–å¾—ï¼ˆè©³ç´°ä»˜ãï¼‰- ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½
 */
export async function scrapeCrowdWorksJobsByCategoryWithDetails(params: {
  category: string;
  maxJobs: number;
  maxDetails?: number;
}): Promise<{
  jobs: CrowdWorksJob[];
  jobDetails: CrowdWorksJobDetail[];
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log(`ğŸš€ ã‚«ãƒ†ã‚´ãƒªã€Œ${params.category}ã€è©³ç´°å–å¾—é–‹å§‹`);

    // ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    });
    const page = await context.newPage();

    // æ—¢å­˜è©³ç´°ã®èª­ã¿è¾¼ã¿
    let existingDetails: CrowdWorksJobDetail[] = [];
    const detailsFile = `output/details-${params.category}.json`;

    try {
      const existingData = await readFileAsync(detailsFile);
      if (existingData) {
        existingDetails = JSON.parse(existingData);
        console.log(`ğŸ“‚ æ—¢å­˜è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${existingDetails.length}ä»¶`);
      }
    } catch (e) {
      console.log('ğŸ“ è©³ç´°ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ï¼ˆæ–°è¦ä½œæˆï¼‰');
    }

    // æ¡ˆä»¶ä¸€è¦§ã®å–å¾—
    const scrapingResult = await scrapeCrowdWorksJobsByCategory(page, params.category, params.maxJobs);

    if (!scrapingResult.success) {
      throw new Error(scrapingResult.error || 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¤±æ•—');
    }

    const jobs = scrapingResult.jobs;
    const maxDetails = params.maxDetails ?? params.maxJobs;

    // è©³ç´°å–å¾—ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
    const existingJobIds = new Set(existingDetails.map(d => d.jobId));
    const newJobs = jobs.filter(job => !existingJobIds.has(job.id));
    const jobsToDetail = newJobs.slice(0, maxDetails);

    console.log(`ğŸ“Š è©³ç´°å–å¾—å¯¾è±¡: ${jobsToDetail.length}ä»¶ (æ—¢å­˜é™¤å¤–: ${jobs.length - newJobs.length}ä»¶)`);

    const newDetails: CrowdWorksJobDetail[] = [];
    for (let i = 0; i < jobsToDetail.length; i++) {
      const job = jobsToDetail[i];
      if (!job) continue; // null/undefined ãƒã‚§ãƒƒã‚¯

      try {
        const detail = await scrapeCrowdWorksJobDetail(page, job.url);
        detail.category = params.category;
        newDetails.push(detail);
        console.log(`âœ… [${i + 1}/${jobsToDetail.length}] ${job.title.substring(0, 50)}...`);

        // APIåˆ¶é™å¯¾å¿œ
        await page.waitForTimeout(1000);
      } catch (error) {
        console.error(`âŒ è©³ç´°å–å¾—å¤±æ•—: ${job.title}`);
      }
    }

    // å…¨è©³ç´°ã‚’ãƒãƒ¼ã‚¸ã—ã¦ä¿å­˜
    const allDetails = [...existingDetails, ...newDetails];
    const fs = require('fs');
    fs.writeFileSync(detailsFile, JSON.stringify(allDetails, null, 2), 'utf8');
    console.log(`ğŸ’¾ è©³ç´°ä¿å­˜å®Œäº†: ${detailsFile} (${allDetails.length}ä»¶)`);

    const executionTime = Date.now() - startTime;
    console.log(`ğŸ¯ ã‚«ãƒ†ã‚´ãƒªã€Œ${params.category}ã€å®Œäº†: ${jobs.length}ä»¶ä¸€è¦§, ${newDetails.length}ä»¶æ–°è¦è©³ç´° (${Math.round(executionTime / 1000)}ç§’)`);

    return {
      jobs,
      jobDetails: allDetails
    };

  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${params.category}ã€ã‚¨ãƒ©ãƒ¼:`, errorMessage);
    return { jobs: [], jobDetails: [] };
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * Lambdaé–¢æ•°ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */
export const lambdaHandler = async (
  event: ScheduledExecutionEvent,
  _context: Context
): Promise<ScheduledExecutionResponse> => {
  const startTime = Date.now();

  try {
    console.log('âš¡ Lambdaå®Ÿè¡Œé–‹å§‹:', JSON.stringify(event, null, 2));

    const result = await executeFullAnalysisWorkflow({
      maxJobsPerCategory: 20,
      maxDetailsPerCategory: 20
    });

    const executionTime = Date.now() - startTime;

    return {
      statusCode: 200,
      body: JSON.stringify({
        success: result.success,
        summary: result.summary,
        reportFile: result.reportFile,
        executionTime
      }),
      executionTime,
      timestamp: new Date().toISOString()
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);

    console.error('âŒ Lambdaå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      statusCode: 500,
      body: JSON.stringify({
        success: false,
        error: errorMessage,
        executionTime
      }),
      executionTime,
      timestamp: new Date().toISOString()
    };
  }
};

/**
 * å…¨ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°â†’AIåˆ†æâ†’ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’çµ±åˆå®Ÿè¡Œ
 */
export async function executeFullAnalysisWorkflow(params?: {
  maxJobsPerCategory?: number;
  maxDetailsPerCategory?: number;
}): Promise<{
  success: boolean;
  summary: {
    totalCategories: number;
    successfulCategories: number;
    totalJobs: number;
    totalDetails: number;
    analysisResults?: { [key: string]: number };
    reportGenerated: boolean;
  };
  reportFile?: string;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  const maxJobs = params?.maxJobsPerCategory ?? 50;
  const maxDetails = params?.maxDetailsPerCategory ?? 50;

  try {
    console.log('ğŸš€ çµ±åˆåˆ†æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹...');
    console.log(`ğŸ“Š è¨­å®š: å„ã‚«ãƒ†ã‚´ãƒª ${maxJobs}ä»¶å–å¾—, è©³ç´° ${maxDetails}ä»¶`);

    // ã‚¹ãƒ†ãƒƒãƒ—1: å…¨ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
    console.log('\nğŸ“‚ ã‚¹ãƒ†ãƒƒãƒ—1: å…¨ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œä¸­...');
    const categories = ['ec', 'web_products', 'software_development', 'development'];
    let totalJobs = 0;
    let totalDetails = 0;
    let successfulCategories = 0;

    for (const category of categories) {
      try {
        console.log(`\nğŸ“ˆ ${category} ã‚«ãƒ†ã‚´ãƒªå‡¦ç†ä¸­...`);
        const result = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category,
          maxJobs,
          maxDetails
        });

        if (result.jobs.length > 0) {
          console.log(`âœ… ${category}: ${result.jobs.length}ä»¶ä¸€è¦§, ${result.jobDetails.length}ä»¶è©³ç´°`);
          totalJobs += result.jobs.length;
          totalDetails += result.jobDetails.length;
          successfulCategories++;
        }

        // ã‚«ãƒ†ã‚´ãƒªé–“ã§å¾…æ©Ÿ
        if (categories.indexOf(category) < categories.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      } catch (e) {
        console.log(`âŒ ${category}: ã‚¨ãƒ©ãƒ¼ -`, e instanceof Error ? e.message : String(e));
      }
    }

    console.log(`\nğŸ“Š ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†: ${successfulCategories}/${categories.length}ã‚«ãƒ†ã‚´ãƒªæˆåŠŸ`);

    // ã‚¹ãƒ†ãƒƒãƒ—2: AIåˆ†æå®Ÿè¡Œ
    console.log('\nğŸ§  ã‚¹ãƒ†ãƒƒãƒ—2: AIåˆ†æå®Ÿè¡Œä¸­...');
    const analysisResults: { [key: string]: number } = {};

    for (const category of categories) {
      try {
        const detailsFile = `output/details-${category}.json`;
        const fs = require('fs');

        if (!fs.existsSync(detailsFile)) {
          console.log(`âš ï¸ ${category}: è©³ç´°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
          continue;
        }

        await new Promise<void>((resolve, reject) => {
          const { exec } = require('child_process');
          const analysisCmd = `npx ts-node scripts/analyze-details.ts ${detailsFile} output/analyzed-${category}.json`;
          exec(analysisCmd, (error: any) => {
            if (error) {
              console.log(`âŒ ${category} AIåˆ†æã‚¨ãƒ©ãƒ¼:`, error.message);
              reject(error);
            } else {
              console.log(`âœ… ${category} AIåˆ†æå®Œäº†`);
              try {
                const analyzedData = JSON.parse(fs.readFileSync(`output/analyzed-${category}.json`, 'utf8'));
                analysisResults[category] = analyzedData.length;
                console.log(`ğŸ“Š ${category}: ${analyzedData.length}ä»¶åˆ†æå®Œäº†`);
              } catch (parseError) {
                console.log(`âš ï¸ ${category}: åˆ†æçµæœãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼`);
              }
              resolve();
            }
          });
        });

        await new Promise(resolve => setTimeout(resolve, 3000));
      } catch (e) {
        console.log(`âŒ ${category} AIåˆ†æå¤±æ•—:`, e instanceof Error ? e.message : String(e));
      }
    }

    // ã‚¹ãƒ†ãƒƒãƒ—3: ãŠã™ã™ã‚åº¦è¨ˆç®—
    console.log('\nâ­ ã‚¹ãƒ†ãƒƒãƒ—3: ãŠã™ã™ã‚åº¦è¨ˆç®—å®Ÿè¡Œä¸­...');
    try {
      await new Promise<void>((resolve, reject) => {
        const { exec } = require('child_process');
        const recommendCmd = 'npx ts-node scripts/calculate-recommendation-score.ts';
        exec(recommendCmd, (error: any) => {
          if (error) {
            console.log('âŒ ãŠã™ã™ã‚åº¦è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error.message);
            reject(error);
          } else {
            console.log('âœ… ãŠã™ã™ã‚åº¦è¨ˆç®—å®Œäº†');
            resolve();
          }
        });
      });
    } catch (e) {
      console.log('âŒ ãŠã™ã™ã‚åº¦è¨ˆç®—å¤±æ•—:', e instanceof Error ? e.message : String(e));
    }

    // ã‚¹ãƒ†ãƒƒãƒ—4: é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡º
    console.log('\nğŸ’° ã‚¹ãƒ†ãƒƒãƒ—4: é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºä¸­...');
    try {
      await new Promise<void>((resolve, reject) => {
        const { exec } = require('child_process');
        const extractCmd = 'npx ts-node scripts/extract-high-hourly-jobs.ts';
        exec(extractCmd, (error: any) => {
          if (error) {
            console.log('âŒ é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error.message);
            reject(error);
          } else {
            console.log('âœ… é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºå®Œäº†');
            resolve();
          }
        });
      });
    } catch (e) {
      console.log('âŒ é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºå¤±æ•—:', e instanceof Error ? e.message : String(e));
    }

    // ã‚¹ãƒ†ãƒƒãƒ—5: çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    console.log('\nğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—5: çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­...');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const reportFile = `output/crowdworks-analysis-report-${timestamp}.md`;

    try {
      const reportContent = await generateComprehensiveReport({
        totalCategories: categories.length,
        successfulCategories,
        totalJobs,
        totalDetails,
        analysisResults,
        timestamp: new Date().toISOString()
      });

      const fs = require('fs');
      fs.writeFileSync(reportFile, reportContent, 'utf8');
      console.log(`âœ… çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: ${reportFile}`);

    } catch (e) {
      console.log('âŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå¤±æ•—:', e instanceof Error ? e.message : String(e));
    }

    const executionTime = Date.now() - startTime;

    console.log('\nğŸ‰ çµ±åˆåˆ†æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ï¼');
    console.log(`â±ï¸ ç·å®Ÿè¡Œæ™‚é–“: ${Math.round(executionTime / 1000)}ç§’`);

    return {
      success: true,
      summary: {
        totalCategories: categories.length,
        successfulCategories,
        totalJobs,
        totalDetails,
        analysisResults,
        reportGenerated: true
      },
      reportFile,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ çµ±åˆåˆ†æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      summary: {
        totalCategories: 0,
        successfulCategories: 0,
        totalJobs: 0,
        totalDetails: 0,
        reportGenerated: false
      },
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
async function generateComprehensiveReport(data: {
  totalCategories: number;
  successfulCategories: number;
  totalJobs: number;
  totalDetails: number;
  analysisResults?: { [key: string]: number };
  timestamp: string;
}): Promise<string> {
  const date = new Date().toLocaleDateString('ja-JP');

  let report = `# CrowdWorksæ¡ˆä»¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

> ç”Ÿæˆæ—¥: ${date}  
> å®Ÿè¡Œæ™‚åˆ»: ${data.timestamp}  
> å¯¾è±¡: å…¨ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•åˆ†æ  

## ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼

| é …ç›® | çµæœ |
|------|------|
| å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªæ•° | ${data.totalCategories} |
| æˆåŠŸã‚«ãƒ†ã‚´ãƒªæ•° | ${data.successfulCategories} |
| ç·æ¡ˆä»¶å–å¾—æ•° | ${data.totalJobs} |
| ç·è©³ç´°å–å¾—æ•° | ${data.totalDetails} |
| AIåˆ†æå®Œäº† | ${data.analysisResults ? Object.keys(data.analysisResults).length : 0}ã‚«ãƒ†ã‚´ãƒª |

## ğŸ¯ ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ

`;

  if (data.analysisResults) {
    for (const [category, count] of Object.entries(data.analysisResults)) {
      const categoryName = category === 'ec' ? 'ECãƒ»ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—' :
        category === 'web_products' ? 'Webåˆ¶ä½œãƒ»Webãƒ‡ã‚¶ã‚¤ãƒ³' :
          category === 'software_development' ? 'ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™º' :
            category === 'development' ? 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º' :
              category;
      report += `### ${categoryName}\n- AIåˆ†æä»¶æ•°: ${count}ä»¶\n\n`;
    }
  }

  // é«˜æ™‚çµ¦æ¡ˆä»¶ãŒã‚ã‚Œã°è¿½åŠ 
  try {
    const fs = require('fs');
    if (fs.existsSync('output/high-hourly-jobs-3000+.md')) {
      const highHourlyContent = fs.readFileSync('output/high-hourly-jobs-3000+.md', 'utf8');
      report += `\n## ğŸ’° é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºçµæœ\n\n`;
      report += highHourlyContent.split('\n').slice(10).join('\n');
    }
  } catch (e) {
    report += `\n## ğŸ’° é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºçµæœ\n\né«˜æ™‚çµ¦æ¡ˆä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n`;
  }

  // ãŠã™ã™ã‚æ¡ˆä»¶ãŒã‚ã‚Œã°è¿½åŠ 
  try {
    const fs = require('fs');
    if (fs.existsSync('output/recommended-jobs-top30.md')) {
      const recommendedContent = fs.readFileSync('output/recommended-jobs-top30.md', 'utf8');
      report += `\n## â­ ãŠã™ã™ã‚æ¡ˆä»¶TOP30\n\n`;
      report += recommendedContent.split('\n').slice(5).join('\n');
    }
  } catch (e) {
    report += `\n## â­ ãŠã™ã™ã‚æ¡ˆä»¶TOP30\n\nãŠã™ã™ã‚æ¡ˆä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n`;
  }

  report += `\n---\n\n*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*\n`;

  return report;
}

/**
 * CLIã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 */
export async function runHandlerCLI(): Promise<void> {
  const args = process.argv.slice(2);

  if (args.length === 0) {
    console.log('ğŸ¯ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:');
    console.log('  full-analysis [ä»¶æ•°] - ğŸš€ å…¨å‡¦ç†çµ±åˆå®Ÿè¡Œ (ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°â†’AIåˆ†æâ†’ãƒ¬ãƒãƒ¼ãƒˆ)');
    console.log('  scrape-ec [ä»¶æ•°]     - ECæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  scrape-web [ä»¶æ•°]    - Webè£½å“æ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  scrape-dev [ä»¶æ•°]    - ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  scrape-app [ä»¶æ•°]    - ã‚¢ãƒ—ãƒªé–‹ç™ºæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  lancers-system [ä»¶æ•°] - ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ä»¶)');
    console.log('  lancers-web [ä»¶æ•°]    - ãƒ©ãƒ³ã‚µãƒ¼ã‚ºWebæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ä»¶)');
    console.log('  lancers-app [ä»¶æ•°]    - ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚¢ãƒ—ãƒªæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ä»¶)');
    console.log('  lancers-design [ä»¶æ•°] - ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ä»¶)');
    console.log('');
    console.log('ğŸ“ ç’°å¢ƒå¤‰æ•° LANCERS_EMAIL, LANCERS_PASSWORD ã‚’è¨­å®šã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦å–å¾—ã—ã¾ã™');
    console.log('ä¾‹: npm run handler full-analysis 20');
    console.log('ä¾‹: npm run handler scrape-ec 30');
    console.log('ä¾‹: npm run handler lancers-system 15');
    return;
  }

  const command = args[0];
  const maxJobs = args[1] ? parseInt(args[1]) : 50;

  try {
    switch (command) {
      case 'full-analysis':
        console.log('ğŸš€ å…¨å‡¦ç†çµ±åˆå®Ÿè¡Œä¸­...');
        const fullAnalysisResult = await executeFullAnalysisWorkflow({
          maxJobsPerCategory: maxJobs,
          maxDetailsPerCategory: maxJobs
        });
        console.log(JSON.stringify(fullAnalysisResult, null, 2));
        break;

      case 'scrape-ec':
        console.log(`ğŸ“ˆ ECæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const ecResult = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category: 'ec',
          maxJobs,
          maxDetails: maxJobs
        });
        console.log(`âœ… ECå–å¾—å®Œäº†: ${ecResult.jobs.length}ä»¶ä¸€è¦§, ${ecResult.jobDetails.length}ä»¶è©³ç´°`);
        break;

      case 'scrape-web':
        console.log(`ğŸŒ Webè£½å“æ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const webResult = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category: 'web_products',
          maxJobs,
          maxDetails: maxJobs
        });
        console.log(`âœ… Webè£½å“å–å¾—å®Œäº†: ${webResult.jobs.length}ä»¶ä¸€è¦§, ${webResult.jobDetails.length}ä»¶è©³ç´°`);
        break;

      case 'scrape-dev':
        console.log(`ğŸ’» ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const devResult = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category: 'development',
          maxJobs,
          maxDetails: maxJobs
        });
        console.log(`âœ… ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºå–å¾—å®Œäº†: ${devResult.jobs.length}ä»¶ä¸€è¦§, ${devResult.jobDetails.length}ä»¶è©³ç´°`);
        break;

      case 'scrape-app':
        console.log(`ğŸ“± ã‚¢ãƒ—ãƒªé–‹ç™ºæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const appResult = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category: 'software_development',
          maxJobs,
          maxDetails: maxJobs
        });
        console.log(`âœ… ã‚¢ãƒ—ãƒªé–‹ç™ºå–å¾—å®Œäº†: ${appResult.jobs.length}ä»¶ä¸€è¦§, ${appResult.jobDetails.length}ä»¶è©³ç´°`);
        break;

      case 'lancers-system':
        console.log(`ğŸ’» ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const lancersSystemResult = await scrapeLancersJobsByCategory({
          category: 'system',
          maxJobs,
          ...(process.env['LANCERS_EMAIL'] && process.env['LANCERS_PASSWORD'] && { 
            email: process.env['LANCERS_EMAIL'], 
            password: process.env['LANCERS_PASSWORD'] 
          })
        });
        console.log(`âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºå–å¾—å®Œäº†: ${lancersSystemResult.jobs.length}ä»¶å–å¾—`);
        break;

      case 'lancers-web':
        console.log(`ğŸŒ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºWebæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const lancersWebResult = await scrapeLancersJobsByCategory({
          category: 'web',
          maxJobs,
          ...(process.env['LANCERS_EMAIL'] && process.env['LANCERS_PASSWORD'] && { 
            email: process.env['LANCERS_EMAIL'], 
            password: process.env['LANCERS_PASSWORD'] 
          })
        });
        console.log(`âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºWebå–å¾—å®Œäº†: ${lancersWebResult.jobs.length}ä»¶å–å¾—`);
        break;

      case 'lancers-app':
        console.log(`ğŸ“± ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚¢ãƒ—ãƒªæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const lancersAppResult = await scrapeLancersJobsByCategory({
          category: 'app',
          maxJobs,
          ...(process.env['LANCERS_EMAIL'] && process.env['LANCERS_PASSWORD'] && { 
            email: process.env['LANCERS_EMAIL'], 
            password: process.env['LANCERS_PASSWORD'] 
          })
        });
        console.log(`âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚¢ãƒ—ãƒªå–å¾—å®Œäº†: ${lancersAppResult.jobs.length}ä»¶å–å¾—`);
        break;

      case 'lancers-design':
        console.log(`ğŸ¨ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const lancersDesignResult = await scrapeLancersJobsByCategory({
          category: 'design',
          maxJobs,
          ...(process.env['LANCERS_EMAIL'] && process.env['LANCERS_PASSWORD'] && { 
            email: process.env['LANCERS_EMAIL'], 
            password: process.env['LANCERS_PASSWORD'] 
          })
        });
        console.log(`âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ‡ã‚¶ã‚¤ãƒ³å–å¾—å®Œäº†: ${lancersDesignResult.jobs.length}ä»¶å–å¾—`);
        break;

      default:
        console.log(`âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}`);
        console.log('åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã«ã¯å¼•æ•°ãªã—ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
        process.exit(1);
    }
  } catch (error) {
    console.error('âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : String(error));
    process.exit(1);
  }
}

// CLIå®Ÿè¡Œæ™‚ã®å‡¦ç†
if (require.main === module) {
  runHandlerCLI().catch(error => {
    console.error('âŒ CLIå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
    process.exit(1);
  });
}

/**
 * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ä»˜ãï¼‰
 */
export async function scrapeLancersJobsByCategory(params: {
  category: string;
  maxJobs: number;
  email?: string;
  password?: string;
}): Promise<LancersScrapingResult> {
  const { category, maxJobs, email, password } = params;
  
  let browser: Browser | null = null;
  
  try {
    console.log(`ğŸš€ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã€Œ${category}ã€ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹`);
    
    browser = await chromium.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
    });
    
    const page = await browser.newPage();
    
    // User-Agentã‚’è¨­å®š
    await page.setExtraHTTPHeaders({
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    });
    
    const lancersService = new LancersService(page);
    
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆèªè¨¼æƒ…å ±ãŒã‚ã‚‹å ´åˆï¼‰
    if (email && password) {
      console.log('ğŸ” ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œä¸­...');
      const loginSuccess = await lancersService.login(email, password);
      if (loginSuccess) {
        console.log('âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');
      } else {
        console.log('âš ï¸ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— - å…¬é–‹æ¡ˆä»¶ã®ã¿å–å¾—ã—ã¾ã™');
      }
    } else {
      console.log('â„¹ï¸ èªè¨¼æƒ…å ±ãªã— - å…¬é–‹æ¡ˆä»¶ã®ã¿å–å¾—ã—ã¾ã™');
    }
    
    // æ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
    const jobsResult = await lancersService.scrapeJobs(category, maxJobs);
    
    console.log(`âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†: ${jobsResult.length}ä»¶å–å¾—`);
    
    return {
      jobs: jobsResult,
      jobDetails: []
    };
    
  } catch (error) {
    console.error('âŒ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶è©³ç´°å–å¾—
 */
export async function scrapeLancersJobDetail(jobUrl: string, email?: string, password?: string): Promise<LancersJobDetail | null> {
  let browser: Browser | null = null;
  
  try {
    browser = await chromium.launch({
      headless: true,
      args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
    });
    
    const page = await browser.newPage();
    await page.setExtraHTTPHeaders({
      'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
    });
    
    const lancersService = new LancersService(page);
    
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆèªè¨¼æƒ…å ±ãŒã‚ã‚‹å ´åˆï¼‰
    if (email && password) {
      const loginSuccess = await lancersService.login(email, password);
      if (!loginSuccess) {
        console.log('âš ï¸ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— - è©³ç´°å–å¾—ã«å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
      }
    }
    
    // è©³ç´°å–å¾—
    const detail = await lancersService.scrapeJobDetail(jobUrl);
    
    return detail;
    
  } catch (error) {
    console.error('âŒ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    return null;
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * ãƒ©ãƒ³ã‚µãƒ¼ã‚ºæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆè©³ç´°ä»˜ããƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ä»˜ãï¼‰
 */
export async function scrapeLancersJobsByCategoryWithDetails(params: {
  category: string;
  maxJobs: number;
  maxDetails?: number;
  email?: string;
  password?: string;
}): Promise<{
  jobs: LancersJob[];
  jobDetails: LancersJobDetail[];
}> {
  const { category, maxJobs, maxDetails = 10, email, password } = params;
  
  try {
    console.log(`ğŸš€ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºã€Œ${category}ã€ã‚«ãƒ†ã‚´ãƒªè©³ç´°ä»˜ãã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹`);
    
    // æ¡ˆä»¶ãƒªã‚¹ãƒˆå–å¾—
    const scrapingResult = await scrapeLancersJobsByCategory({
      category,
      maxJobs,
      ...(email && password && { email, password })
    });
    
    if (scrapingResult.jobs.length === 0) {
      console.log('âš ï¸ æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      return { jobs: [], jobDetails: [] };
    }
    
    console.log(`ğŸ“‹ ${scrapingResult.jobs.length}ä»¶ã®æ¡ˆä»¶ã‹ã‚‰è©³ç´°ã‚’å–å¾—ä¸­...`);
    
    // è©³ç´°å–å¾—å¯¾è±¡ã‚’åˆ¶é™
    const jobsForDetails = scrapingResult.jobs.slice(0, maxDetails);
    const jobDetails: LancersJobDetail[] = [];
    
    for (let i = 0; i < jobsForDetails.length; i++) {
      const job = jobsForDetails[i];
      if (!job) continue; // undefined ãƒã‚§ãƒƒã‚¯
      
      console.log(`ğŸ“‹ è©³ç´°å–å¾—ä¸­ ${i + 1}/${jobsForDetails.length}: ${job.title}`);

      try {
        const detail = await scrapeLancersJobDetail(job.url, email, password);
        if (detail) {
          jobDetails.push(detail);
        }
        
        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼ˆè©³ç´°å–å¾—é–“éš”ï¼‰
        if (i < jobsForDetails.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 3000));
        }
        
      } catch (error) {
        console.error(`âŒ è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼ (${job.url}):`, error);
      }
    }
    
    console.log(`âœ… ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ä»˜ãã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†: æ¡ˆä»¶${scrapingResult.jobs.length}ä»¶, è©³ç´°${jobDetails.length}ä»¶`);
    
    return {
      jobs: scrapingResult.jobs,
      jobDetails
    };
    
  } catch (error) {
    console.error('âŒ ãƒ©ãƒ³ã‚µãƒ¼ã‚ºè©³ç´°ä»˜ãã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
    return { jobs: [], jobDetails: [] };
  }
}
</file>

</files>
