This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.eslintrc.js
.github/workflows/ci.yml
.gitignore
.prettierrc
app.ts
cdk.json
docker-compose.yml
Dockerfile
Dockerfile.lambda
docs/01_requirements.md
docs/02_system_design.md
docs/03_data_design.md
docs/04_api_design.md
docs/05_implementation_plan.md
docs/CI_CD_SETUP.md
docs/README.md
env.example
jest.config.js
package.json
README-setup.md
readme.md
src/index.ts
src/infrastructure/crowdworks-searcher-stack.ts
src/lambda/handler.ts
src/services/index.ts
src/test/crowdworks-scraping-test.ts
src/types/index.ts
src/utils/index.ts
test/sample.test.js
test/sample.test.ts
test/setup.js
test/setup.ts
tsconfig.cdk.json
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".prettierrc">
{
    "semi": true,
    "trailingComma": "es5",
    "singleQuote": true,
    "printWidth": 100,
    "tabWidth": 2,
    "useTabs": false,
    "bracketSpacing": true,
    "arrowParens": "avoid",
    "endOfLine": "lf",
    "quoteProps": "as-needed",
    "bracketSameLine": false,
    "embeddedLanguageFormatting": "auto"
}
</file>

<file path="cdk.json">
{
    "app": "npx ts-node --prefer-ts-exts app.ts",
    "watch": {
        "include": [
            "**"
        ],
        "exclude": [
            "README.md",
            "cdk*.json",
            "**/*.d.ts",
            "**/*.js",
            "tsconfig.json",
            "package*.json",
            "yarn.lock",
            "node_modules",
            "test"
        ]
    },
    "context": {
        "@aws-cdk/aws-lambda:recognizeLayerVersion": true,
        "@aws-cdk/core:checkSecretUsage": true,
        "@aws-cdk/core:target-partitions": [
            "aws",
            "aws-cn"
        ],
        "@aws-cdk-containers/ecs-service-extensions:enableDefaultLogDriver": true,
        "@aws-cdk/aws-ec2:uniqueImdsv2TemplateName": true,
        "@aws-cdk/aws-ecs:arnFormatIncludesClusterName": true,
        "@aws-cdk/aws-iam:minimizePolicies": true,
        "@aws-cdk/core:validateSnapshotRemovalPolicy": true,
        "@aws-cdk/aws-codepipeline:crossAccountKeyAliasStackSafeResourceName": true,
        "@aws-cdk/aws-s3:createDefaultLoggingPolicy": true,
        "@aws-cdk/aws-sns-subscriptions:restrictSqsDescryption": true,
        "@aws-cdk/aws-apigateway:disableCloudWatchRole": true,
        "@aws-cdk/core:enablePartitionLiterals": true,
        "@aws-cdk/aws-events:eventsTargetQueueSameAccount": true,
        "@aws-cdk/aws-iam:standardizedServicePrincipals": true,
        "@aws-cdk/aws-ecs:disableExplicitDeploymentControllerForCircuitBreaker": true,
        "@aws-cdk/aws-iam:importedRoleStackSafeDefaultPolicyName": true,
        "@aws-cdk/aws-s3:serverAccessLogsUseBucketPolicy": true,
        "@aws-cdk/aws-route53-patters:useCertificate": true,
        "@aws-cdk/customresources:installLatestAwsSdkDefault": false,
        "@aws-cdk/aws-rds:databaseProxyUniqueResourceName": true,
        "@aws-cdk/aws-codedeploy:removeAlarmsFromDeploymentGroup": true,
        "@aws-cdk/aws-apigateway:authorizerChangeDeploymentLogicalId": true,
        "@aws-cdk/aws-ec2:launchTemplateDefaultUserData": true,
        "@aws-cdk/aws-secretsmanager:useAttachedSecretResourcePolicyForSecretTargetAttachments": true,
        "@aws-cdk/aws-redshift:columnId": true,
        "@aws-cdk/aws-stepfunctions-tasks:enableLoggingForLambdaTask": true,
        "@aws-cdk/aws-ec2:restrictDefaultSecurityGroup": true,
        "@aws-cdk/aws-apigateway:requestValidatorUniqueId": true,
        "@aws-cdk/aws-kms:aliasNameRef": true,
        "@aws-cdk/aws-autoscaling:generateLaunchTemplateInsteadOfLaunchConfig": true,
        "@aws-cdk/core:includePrefixInUniqueNameGeneration": true,
        "@aws-cdk/aws-efs:denyAnonymousAccess": true,
        "@aws-cdk/aws-opensearchservice:enableOpensearchMultiAzWithStandby": true,
        "@aws-cdk/aws-lambda-nodejs:useLatestRuntimeVersion": true,
        "@aws-cdk/aws-efs:mountTargetOrderInsensitiveLogicalId": true,
        "@aws-cdk/aws-rds:auroraClusterChangeScopeOfInstanceParameterGroupWithEachParameters": true,
        "@aws-cdk/aws-appsync:useArnForSourceApiAssociationIdentifier": true,
        "@aws-cdk/aws-rds:preventRenderingDeprecatedCredentials": true,
        "@aws-cdk/aws-codepipeline-actions:useNewDefaultBranchForSourceAction": true
    }
}
</file>

<file path="docker-compose.yml">
version: '3.8'

services:
  # ãƒ¡ã‚¤ãƒ³é–‹ç™ºç’°å¢ƒ
  crowdworks-search:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # é–‹ç™ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    container_name: crowdworks-search-dev
    volumes:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚¦ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é–‹ç™ºç”¨ï¼‰
      - .:/workspace
      - /workspace/node_modules  # node_modulesã¯é™¤å¤–
      - /workspace/dist          # distã¯é™¤å¤–
      # AWSèªè¨¼æƒ…å ±ã®ãƒã‚¦ãƒ³ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      - ~/.aws:/root/.aws:ro
    environment:
      # é–‹ç™ºç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°
      - NODE_ENV=development
      - AWS_REGION=ap-northeast-1
      - LOG_LEVEL=debug
      # Playwrightè¨­å®š
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    ports:
      - "3000:3000"  # å°†æ¥çš„ãªAPI Gateway Localç”¨
      - "9229:9229"  # Node.js ãƒ‡ãƒãƒƒã‚°ãƒãƒ¼ãƒˆ
    working_dir: /workspace
    # é–‹ç™ºç”¨ã®ã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    command: tail -f /dev/null  # ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•çŠ¶æ…‹ã§ç¶­æŒ
    stdin_open: true
    tty: true

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: crowdworks-search-test
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/dist
    environment:
      - NODE_ENV=test
      - AWS_REGION=ap-northeast-1
    working_dir: /workspace
    command: npm run test:coverage
    profiles:
      - test  # docker-compose --profile test up ã§å®Ÿè¡Œ

  # AWS CDKå°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
  cdk:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: crowdworks-search-cdk
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/cdk.out
      - ~/.aws:/root/.aws:ro
    environment:
      - AWS_REGION=ap-northeast-1
      - CDK_DEFAULT_REGION=ap-northeast-1
    working_dir: /workspace
    command: tail -f /dev/null
    profiles:
      - cdk  # docker-compose --profile cdk up ã§å®Ÿè¡Œ

  # æœ¬ç•ªç’°å¢ƒãƒ†ã‚¹ãƒˆç”¨ï¼ˆLambdaç’°å¢ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  lambda-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: crowdworks-search-lambda
    environment:
      - AWS_LAMBDA_RUNTIME_API=localhost:9000
      - _HANDLER=dist/lambda/handler.lambdaHandler
    ports:
      - "9000:8080"  # Lambda Runtime Interface Emulator
    profiles:
      - lambda  # docker-compose --profile lambda up ã§å®Ÿè¡Œ

networks:
  default:
    name: crowdworks-search-network
</file>

<file path="Dockerfile.lambda">
# ================================================
# Lambda Containerç”¨Dockerfile
# Playwright + Chromiumç’°å¢ƒã®æœ€é©åŒ–ç‰ˆ
# ================================================

# AWS Lambda Node.jsåŸºç›¤ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM public.ecr.aws/lambda/nodejs:18

# ãƒ“ãƒ«ãƒ‰å¼•æ•°
ARG STAGE=development
ARG NODE_ENV=production

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV NODE_ENV=${NODE_ENV}
ENV STAGE=${STAGE}
ENV PLAYWRIGHT_BROWSERS_PATH=/usr/bin
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR ${LAMBDA_TASK_ROOT}

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆChromium + é–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
RUN dnf update -y && \
    dnf install -y \
    chromium \
    nss \
    atk \
    at-spi2-atk \
    gtk3 \
    cups-libs \
    drm \
    libXt \
    libXext \
    libXdamage \
    libXrandr \
    libXcomposite \
    libXcursor \
    libXss \
    libXi \
    GConf2 \
    alsa-lib \
    && dnf clean all \
    && rm -rf /var/cache/dnf

# Chromiumã®å‹•ä½œç¢ºèªã¨ãƒã‚¤ãƒŠãƒªãƒ‘ã‚¹è¨­å®š
RUN ln -sf /usr/bin/chromium-browser /usr/bin/chromium \
    && chromium --version \
    && echo "Chromium installed successfully"

# Node.jsä¾å­˜é–¢ä¿‚ã®ã‚³ãƒ”ãƒ¼ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json ./
RUN npm ci --omit=dev --ignore-scripts && \
    npm cache clean --force

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼
COPY dist/ ./dist/
COPY src/types/ ./src/types/

# ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š
RUN chmod +x dist/lambda/handler.js

# Playwrightè¨­å®šç¢ºèª
RUN node -e "console.log('Node.js version:', process.version)" && \
    node -e "const { chromium } = require('playwright'); console.log('Playwright loaded successfully')"

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ç¢ºèªï¼‰
RUN node -e "console.log('Lambda Container build completed successfully')"

# Lambdaé–¢æ•°ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
CMD ["dist/lambda/handler.lambdaHandler"]
</file>

<file path="docs/README.md">
# è¨­è¨ˆæ›¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶è‡ªå‹•æ¤œç´¢ãƒ»è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ã®è¨­è¨ˆæ›¸ã§ã™ã€‚

## ğŸ“š è¨­è¨ˆæ›¸ä¸€è¦§

### 1. [è¦ä»¶å®šç¾©æ›¸](./01_requirements.md)
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®çš„ã€æ©Ÿèƒ½è¦ä»¶ã€éæ©Ÿèƒ½è¦ä»¶ã‚’å®šç¾©

### 2. [ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸](./02_system_design.md)  
ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 3. [ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸](./03_data_design.md)
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

### 4. [APIè¨­è¨ˆæ›¸](./04_api_design.md)
å†…éƒ¨APIãƒ»å¤–éƒ¨APIé€£æºã®ä»•æ§˜å®šç¾©

### 5. [å®Ÿè£…è¨ˆç”»æ›¸](./05_implementation_plan.md)
é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã¨ã‚¿ã‚¹ã‚¯åˆ†è§£ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

## ğŸ”„ è¨­è¨ˆæ›¸ä½œæˆã®é€²ã‚æ–¹

1. **è¦ä»¶å®šç¾©æ›¸** ã‹ã‚‰é–‹å§‹
2. **ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸** ã§å…¨ä½“åƒã‚’æ•´ç†
3. **ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸** ã§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ±ºå®š
4. **APIè¨­è¨ˆæ›¸** ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©
5. **å®Ÿè£…è¨ˆç”»æ›¸** ã§é–‹ç™ºã‚’è¨ˆç”»

## ğŸ“ æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | æ›´æ–°è€… | æ›´æ–°å†…å®¹ |
|------|--------|----------|
|      |        |          |
</file>

<file path="test/sample.test.js">
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const types_1 = require("@/types");
describe('Sample Tests', () => {
    describe('Basic functionality', () => {
        it('should pass basic test', () => {
            expect(true).toBe(true);
        });
        it('should handle numbers correctly', () => {
            const result = 2 + 2;
            expect(result).toBe(4);
        });
        it('should work with async functions', async () => {
            const promise = Promise.resolve('test');
            await expect(promise).resolves.toBe('test');
        });
    });
    describe('Type definitions', () => {
        it('should create valid JobData object', () => {
            const jobData = {
                id: 'test-job-001',
                title: 'ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–',
                description: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆç”¨ã®æ¡ˆä»¶ã§ã™',
                url: 'https://crowdworks.jp/public/jobs/test-001',
                budget: 100000,
                deadline: new Date('2024-12-31'),
                workType: 'fixed',
                category: 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º',
                clientName: 'ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ',
                clientRating: 4.5,
                clientReviews: 10,
                skills: ['TypeScript', 'React', 'AWS'],
                experience: 'intermediate',
                scrapedAt: new Date(),
                source: 'crowdworks',
            };
            expect(jobData).toBeValidJobData();
            expect(jobData.budget).toBe(100000);
            expect(jobData.skills).toHaveLength(3);
            expect(jobData.workType).toBe('fixed');
        });
        it('should create valid AppError', () => {
            const error = new types_1.AppError(types_1.ErrorType.SCRAPING_ERROR, 'Test error message', true);
            expect(error).toBeInstanceOf(Error);
            expect(error).toBeInstanceOf(types_1.AppError);
            expect(error.type).toBe(types_1.ErrorType.SCRAPING_ERROR);
            expect(error.message).toBe('Test error message');
            expect(error.retryable).toBe(true);
            expect(error.name).toBe('AppError');
        });
    });
    describe('Environment variables', () => {
        it('should have test environment variables set', () => {
            expect(process.env.NODE_ENV).toBe('test');
            expect(process.env.AWS_REGION).toBe('ap-northeast-1');
            expect(process.env.TZ).toBe('Asia/Tokyo');
        });
    });
    describe('Date handling', () => {
        it('should handle dates correctly', () => {
            const now = new Date();
            const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000);
            expect(now).toBeValidDate();
            expect(tomorrow).toBeValidDate();
            expect(tomorrow.getTime()).toBeGreaterThan(now.getTime());
        });
        it('should handle invalid dates', () => {
            const invalidDate = new Date('invalid');
            expect(invalidDate).not.toBeValidDate();
        });
    });
    describe('Custom matchers', () => {
        it('should use custom toBeValidDate matcher', () => {
            const validDate = new Date();
            const invalidDate = new Date('invalid');
            expect(validDate).toBeValidDate();
            expect(invalidDate).not.toBeValidDate();
        });
        it('should use custom toBeValidJobData matcher', () => {
            const validJob = {
                id: 'test-001',
                title: 'Test Job',
                budget: 50000,
            };
            const invalidJob = {
                title: 'Missing ID',
                budget: '50000',
            };
            expect(validJob).toBeValidJobData();
            expect(invalidJob).not.toBeValidJobData();
        });
    });
});
//# sourceMappingURL=sample.test.js.map
</file>

<file path="test/sample.test.ts">
/**
 * Sample test file to verify Jest configuration
 */

import { AppError, ErrorType, JobData } from '@/types';

describe('Sample Tests', () => {
    describe('Basic functionality', () => {
        it('should pass basic test', () => {
            expect(true).toBe(true);
        });

        it('should handle numbers correctly', () => {
            const result = 2 + 2;
            expect(result).toBe(4);
        });

        it('should work with async functions', async () => {
            const promise = Promise.resolve('test');
            await expect(promise).resolves.toBe('test');
        });
    });

    describe('Type definitions', () => {
        it('should create valid JobData object', () => {
            const jobData: JobData = {
                id: 'test-job-001',
                title: 'ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–',
                description: 'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆç”¨ã®æ¡ˆä»¶ã§ã™',
                url: 'https://crowdworks.jp/public/jobs/test-001',
                budget: 100000,
                deadline: new Date('2024-12-31'),
                workType: 'fixed',
                category: 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º',
                clientName: 'ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ',
                clientRating: 4.5,
                clientReviews: 10,
                skills: ['TypeScript', 'React', 'AWS'],
                experience: 'intermediate',
                scrapedAt: new Date(),
                source: 'crowdworks',
            };

            expect(jobData).toBeValidJobData();
            expect(jobData.budget).toBe(100000);
            expect(jobData.skills).toHaveLength(3);
            expect(jobData.workType).toBe('fixed');
        });

        it('should create valid AppError', () => {
            const error = new AppError(
                ErrorType.SCRAPING_ERROR,
                'Test error message',
                true
            );

            expect(error).toBeInstanceOf(Error);
            expect(error).toBeInstanceOf(AppError);
            expect(error.type).toBe(ErrorType.SCRAPING_ERROR);
            expect(error.message).toBe('Test error message');
            expect(error.retryable).toBe(true);
            expect(error.name).toBe('AppError');
        });
    });

    describe('Environment variables', () => {
        it('should have test environment variables set', () => {
            expect(process.env.NODE_ENV).toBe('test');
            expect(process.env.AWS_REGION).toBe('ap-northeast-1');
            expect(process.env.TZ).toBe('Asia/Tokyo');
        });
    });

    describe('Date handling', () => {
        it('should handle dates correctly', () => {
            const now = new Date();
            const tomorrow = new Date(Date.now() + 24 * 60 * 60 * 1000);

            expect(now).toBeValidDate();
            expect(tomorrow).toBeValidDate();
            expect(tomorrow.getTime()).toBeGreaterThan(now.getTime());
        });

        it('should handle invalid dates', () => {
            const invalidDate = new Date('invalid');
            expect(invalidDate).not.toBeValidDate();
        });
    });

    describe('Custom matchers', () => {
        it('should use custom toBeValidDate matcher', () => {
            const validDate = new Date();
            const invalidDate = new Date('invalid');

            expect(validDate).toBeValidDate();
            expect(invalidDate).not.toBeValidDate();
        });

        it('should use custom toBeValidJobData matcher', () => {
            const validJob = {
                id: 'test-001',
                title: 'Test Job',
                budget: 50000,
            };

            const invalidJob = {
                title: 'Missing ID',
                budget: '50000', // wrong type
            };

            expect(validJob).toBeValidJobData();
            expect(invalidJob).not.toBeValidJobData();
        });
    });
});
</file>

<file path="test/setup.js">
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("jest");
jest.mock('@aws-sdk/client-s3');
jest.mock('@aws-sdk/client-lambda');
jest.mock('@aws-sdk/client-ssm');
jest.mock('@aws-sdk/client-sns');
jest.mock('openai');
jest.mock('playwright');
process.env.NODE_ENV = 'test';
process.env.AWS_REGION = 'ap-northeast-1';
process.env.LOG_LEVEL = 'error';
process.env.TZ = 'Asia/Tokyo';
const originalConsoleLog = console.log;
const originalConsoleWarn = console.warn;
const originalConsoleError = console.error;
beforeEach(() => {
    jest.clearAllMocks();
});
afterEach(() => {
    jest.clearAllTimers();
});
afterAll(() => {
    console.log = originalConsoleLog;
    console.warn = originalConsoleWarn;
    console.error = originalConsoleError;
});
expect.extend({
    toBeValidDate(received) {
        const pass = received instanceof Date && !isNaN(received.getTime());
        return {
            message: () => `expected ${received} to be a valid Date object`,
            pass,
        };
    },
    toBeValidJobData(received) {
        const pass = typeof received === 'object' &&
            received !== null &&
            'id' in received &&
            'title' in received &&
            'budget' in received &&
            typeof received.id === 'string' &&
            typeof received.title === 'string' &&
            typeof received.budget === 'number';
        return {
            message: () => `expected ${JSON.stringify(received)} to be valid job data`,
            pass,
        };
    },
});
//# sourceMappingURL=setup.js.map
</file>

<file path="test/setup.ts">
import 'jest';

// AWS SDKã®ãƒ¢ãƒƒã‚¯è¨­å®š
jest.mock('@aws-sdk/client-s3');
jest.mock('@aws-sdk/client-lambda');
jest.mock('@aws-sdk/client-ssm');
jest.mock('@aws-sdk/client-sns');

// OpenAI SDKã®ãƒ¢ãƒƒã‚¯è¨­å®š
jest.mock('openai');

// Playwrightã®ãƒ¢ãƒƒã‚¯è¨­å®š
jest.mock('playwright');

// ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
process.env.NODE_ENV = 'test';
process.env.AWS_REGION = 'ap-northeast-1';
process.env.LOG_LEVEL = 'error'; // ãƒ†ã‚¹ãƒˆä¸­ã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®ã¿

// ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®å›ºå®šï¼ˆãƒ†ã‚¹ãƒˆã®ä¸€è²«æ€§ã®ãŸã‚ï¼‰
process.env.TZ = 'Asia/Tokyo';

// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®åˆ¶å¾¡ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
const originalConsoleLog = console.log;
const originalConsoleWarn = console.warn;
const originalConsoleError = console.error;

beforeEach(() => {
    // å„ãƒ†ã‚¹ãƒˆå‰ã«ãƒ¢ãƒƒã‚¯ã‚’ã‚¯ãƒªã‚¢
    jest.clearAllMocks();

    // æ™‚é–“ã‚’å›ºå®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    // jest.useFakeTimers();
});

afterEach(() => {
    // ãƒ†ã‚¹ãƒˆå¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    jest.clearAllTimers();
    // jest.useRealTimers();
});

// å…¨ãƒ†ã‚¹ãƒˆå¾Œã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
afterAll(() => {
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’å¾©å…ƒ
    console.log = originalConsoleLog;
    console.warn = originalConsoleWarn;
    console.error = originalConsoleError;
});

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ†ã‚¹ãƒˆãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
declare global {
    namespace jest {
        interface Matchers<R> {
            toBeValidDate(): R;
            toBeValidJobData(): R;
        }
    }
}

// ã‚«ã‚¹ã‚¿ãƒ ãƒãƒƒãƒãƒ£ãƒ¼ã®è¿½åŠ 
expect.extend({
    toBeValidDate(received: unknown) {
        const pass = received instanceof Date && !isNaN(received.getTime());
        return {
            message: () => `expected ${received} to be a valid Date object`,
            pass,
        };
    },

    toBeValidJobData(received: unknown) {
        const pass =
            typeof received === 'object' &&
            received !== null &&
            'id' in received &&
            'title' in received &&
            'budget' in received &&
            typeof (received as { id: unknown }).id === 'string' &&
            typeof (received as { title: unknown }).title === 'string' &&
            typeof (received as { budget: unknown }).budget === 'number';

        return {
            message: () => `expected ${JSON.stringify(received)} to be valid job data`,
            pass,
        };
    },
});
</file>

<file path="tsconfig.cdk.json">
{
    "extends": "./tsconfig.json",
    "compilerOptions": {
        "rootDir": "./",
        "outDir": "./cdk.out/build"
    },
    "include": [
        "app.ts",
        "src/infrastructure/**/*"
    ],
    "exclude": [
        "node_modules",
        "dist",
        "test",
        "**/*.test.ts",
        "**/*.spec.ts"
    ]
}
</file>

<file path=".gitignore">
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
yarn.lock

# Build outputs
dist/
build/
*.tsbuildinfo

# TypeScript
*.d.ts
*.d.ts.map
*.js.map

# AWS CDK
cdk.out/
cdk.context.json

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
logs/
*.log

# Coverage
coverage/
.nyc_output/

# Jest
jest_0/

# Temporary files
tmp/
temp/

# Docker
.dockerignore

# Husky
.husky/_/
</file>

<file path="app.ts">
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { CrowdWorksSearcherStack } from './src/infrastructure/crowdworks-searcher-stack';

const app = new cdk.App();

// ç’°å¢ƒè¨­å®š
const account = process.env['CDK_DEFAULT_ACCOUNT'];
const region = process.env['CDK_DEFAULT_REGION'] || process.env['AWS_REGION'] || 'ap-northeast-1';
const stage = app.node.tryGetContext('stage') || process.env['STAGE'] || 'dev';

const env: cdk.Environment = account ? { account, region } : { region };

// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã®ã‚¹ã‚¿ãƒƒã‚¯è¨­å®š
const getStackConfig = (stage: string) => {
    const baseConfig = {
        env,
        description: `CrowdWorks Auto Job Searcher System - ${stage.toUpperCase()}`,
        stage,
    };

    switch (stage) {
        case 'production':
            return {
                ...baseConfig,
                terminationProtection: true, // æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ä¿è­·ã‚’æœ‰åŠ¹
            };
        case 'staging':
            return {
                ...baseConfig,
                terminationProtection: false,
            };
        default: // dev, test, etc.
            return {
                ...baseConfig,
                terminationProtection: false,
            };
    }
};

// ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆ
const stackConfig = getStackConfig(stage);
new CrowdWorksSearcherStack(app, `CrowdWorksSearcherStack-${stage}`, stackConfig);

// ã‚¿ã‚°ã‚’å…¨ãƒªã‚½ãƒ¼ã‚¹ã«é©ç”¨
cdk.Tags.of(app).add('Application', 'CrowdWorksSearcher');
cdk.Tags.of(app).add('Stage', stage);
cdk.Tags.of(app).add('ManagedBy', 'CDK');

console.log(`ğŸš€ Deploying CrowdWorks Searcher to ${stage.toUpperCase()} environment`);
console.log(`   Region: ${region}`);
console.log(`   Account: ${account || 'default'}`);
</file>

<file path="docs/03_data_design.md">
# ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸

## 1. ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸è¨­è¨ˆ

### 1.1 S3ãƒã‚±ãƒƒãƒˆæ§‹é€ 

```
crowdworks-searcher-bucket/
â”œâ”€â”€ jobs/                           # æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ 2024-01-15T14-30.json     # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å½¢å¼
â”‚   â”œâ”€â”€ 2024-01-15T14-45.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ evaluations/                    # AIè©•ä¾¡çµæœ
â”‚   â”œâ”€â”€ 2024-01-15T14-30.json
â”‚   â”œâ”€â”€ 2024-01-15T14-45.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ logs/                           # å®Ÿè¡Œãƒ»ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
â”‚   â”œâ”€â”€ execution/
â”‚   â”‚   â”œâ”€â”€ 2024-01-15T14-30-execution.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ error/
â”‚   â”‚   â”œâ”€â”€ 2024-01-15T14-30-error.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ daily-summary/
â”‚       â”œâ”€â”€ 2024-01-15.json
â”‚       â””â”€â”€ ...
â””â”€â”€ config/                         # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
    â”œâ”€â”€ search-conditions.json     # æ¤œç´¢æ¡ä»¶
    â””â”€â”€ system-config.json         # ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
```

### 1.2 ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

```typescript
interface FileNamingConvention {
  jobs: 'YYYY-MM-DDTHH-mm.json';           // 2024-01-15T14-30.json
  evaluations: 'YYYY-MM-DDTHH-mm.json';   // 2024-01-15T14-30.json
  executionLogs: 'YYYY-MM-DDTHH-mm-execution.json';
  errorLogs: 'YYYY-MM-DDTHH-mm-error.json';
  dailySummary: 'YYYY-MM-DD.json';         // 2024-01-15.json
  searchConditions: 'search-conditions.json';
  systemConfig: 'system-config.json';
}
```

### 1.3 ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

```typescript
interface S3LifecyclePolicy {
  rules: [
    {
      id: 'DeleteOldData';
      status: 'Enabled';
      transitions: [];
      expiration: {
        days: 7; // 7æ—¥å¾Œè‡ªå‹•å‰Šé™¤
      };
      filter: {
        prefix: 'jobs/'; // jobs/, evaluations/, logs/ å¯¾è±¡
      };
    },
    {
      id: 'KeepConfig';
      status: 'Enabled';
      expiration: null; // config/ ã¯å‰Šé™¤ã—ãªã„
      filter: {
        prefix: 'config/';
      };
    }
  ];
}
```

## 2. ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

### 2.1 TypeScriptå‹å®šç¾©

#### 2.1.1 æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹ï¼ˆè»½é‡ç‰ˆï¼‰

```typescript
interface JobData {
  // åŸºæœ¬æƒ…å ±
  id: string;                    // æ¡ˆä»¶IDï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  title: string;                 // æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«
  description: string;           // æ¡ˆä»¶è©³ç´°ï¼ˆæœ€å¤§500æ–‡å­—ï¼‰
  url: string;                   // æ¡ˆä»¶URL
  
  // æ¡ä»¶æƒ…å ±
  budget: number;                // äºˆç®—ï¼ˆå††ï¼‰
  deadline: Date;                // ç´æœŸ
  workType: 'fixed' | 'hourly'; // å›ºå®šå ±é…¬ or æ™‚é–“å˜ä¾¡
  category: string;              // ã‚«ãƒ†ã‚´ãƒª
  
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
  clientName: string;            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
  clientRating: number;          // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡ï¼ˆ1-5ï¼‰
  clientReviews: number;         // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°
  
  // ã‚¹ã‚­ãƒ«ãƒ»è¦ä»¶
  skills: string[];              // å¿…è¦ã‚¹ã‚­ãƒ«ï¼ˆæœ€å¤§5å€‹ï¼‰
  experience: 'beginner' | 'intermediate' | 'expert'; // çµŒé¨“ãƒ¬ãƒ™ãƒ«
  
  // ãƒ¡ã‚¿æƒ…å ±
  scrapedAt: Date;              // å–å¾—æ—¥æ™‚
  source: 'crowdworks';         // å–å¾—å…ƒï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
}

// ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
const validateJobData = (job: JobData): boolean => {
  return (
    job.id.length > 0 &&
    job.title.length > 0 &&
    job.description.length <= 500 &&
    job.budget > 0 &&
    job.skills.length <= 5 &&
    job.clientRating >= 1 && job.clientRating <= 5
  );
};
```

#### 2.1.2 è©•ä¾¡çµæœå‹ï¼ˆè»½é‡ç‰ˆï¼‰

```typescript
interface JobEvaluation {
  // é–¢é€£æƒ…å ±
  jobId: string;                // å¯¾è±¡æ¡ˆä»¶ID
  evaluatedAt: Date;           // è©•ä¾¡æ—¥æ™‚
  
  // è©•ä¾¡çµæœ
  score: number;               // ãŠã™ã™ã‚åº¦ï¼ˆ1-10ï¼‰
  reason: string;              // è©•ä¾¡ç†ç”±ï¼ˆæœ€å¤§50æ–‡å­—ï¼‰
  
  // ãƒ¡ã‚¿æƒ…å ±
  aiModel: 'gpt-3.5-turbo';    // ä½¿ç”¨AIãƒ¢ãƒ‡ãƒ«
  tokenUsed: number;           // ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  costEstimate: number;        // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  
  // è©•ä¾¡è©³ç´°ï¼ˆç°¡ç´ åŒ–ï¼‰
  strengths: string[];         // å¼·ã¿ï¼ˆæœ€å¤§3å€‹ï¼‰
  concerns: string[];          // æ‡¸å¿µç‚¹ï¼ˆæœ€å¤§3å€‹ï¼‰
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè©•ä¾¡ï¼ˆAIå¤±æ•—æ™‚ï¼‰
const createDefaultEvaluation = (jobId: string): JobEvaluation => ({
  jobId,
  evaluatedAt: new Date(),
  score: 5, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ã‚¢
  reason: 'AIè©•ä¾¡å¤±æ•—ã®ãŸã‚æš«å®šã‚¹ã‚³ã‚¢',
  aiModel: 'gpt-3.5-turbo',
  tokenUsed: 0,
  costEstimate: 0,
  strengths: [],
  concerns: ['AIè©•ä¾¡æœªå®Ÿæ–½']
});
```

#### 2.1.3 å®Ÿè¡Œãƒ­ã‚°å‹

```typescript
interface ExecutionLog {
  // å®Ÿè¡Œæƒ…å ±
  executionId: string;         // å®Ÿè¡ŒIDï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ï¼‰
  timestamp: string;           // å®Ÿè¡Œé–‹å§‹æ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰
  status: 'success' | 'error' | 'partial'; // å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  duration: number;            // å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  
  // å‡¦ç†çµæœ
  jobsScraped: number;         // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä»¶æ•°
  newJobs: number;             // æ–°è¦æ¡ˆä»¶æ•°
  aiEvaluated: number;         // AIè©•ä¾¡ä»¶æ•°
  highScoreJobs: number;       // é«˜è©•ä¾¡æ¡ˆä»¶æ•°ï¼ˆé–¾å€¤ä»¥ä¸Šï¼‰
  
  // ã‚³ã‚¹ãƒˆæƒ…å ±
  costEstimate: number;        // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  
  // ã‚¨ãƒ©ãƒ¼æƒ…å ±ï¼ˆè©²å½“æ™‚ã®ã¿ï¼‰
  error?: {
    type: string;              // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—
    message: string;           // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    stack?: string;            // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
  };
}
```

#### 2.1.4 è¨­å®šå‹

```typescript
// ã‚·ã‚¹ãƒ†ãƒ è¨­å®šï¼ˆconfig/system-config.jsonï¼‰
interface SystemConfig {
  scraping: {
    maxJobsPerExecution: 50;          // æœ€å¤§å‡¦ç†ä»¶æ•°
    preFilterEnabled: true;           // äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿æœ‰åŠ¹
    minBudget: 50000;                 // æœ€ä½äºˆç®—ï¼ˆå††ï¼‰
    minClientRating: 4.0;             // æœ€ä½ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡
    maxDescriptionLength: 500;        // èª¬æ˜æ–‡æœ€å¤§é•·
  };
  
  ai: {
    enabled: true;                    // AIè©•ä¾¡æœ‰åŠ¹
    model: 'gpt-3.5-turbo';          // ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«
    maxJobsForEvaluation: 10;        // æœ€å¤§AIè©•ä¾¡ä»¶æ•°
    monthlyBudgetLimit: 3.0;         // æœˆé–“äºˆç®—åˆ¶é™ï¼ˆUSDï¼‰
    maxTokensPerRequest: 200;        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆæœ€å¤§ãƒˆãƒ¼ã‚¯ãƒ³
    temperature: 0.3;                // å¿œç­”ã®ä¸€è²«æ€§
  };
  
  notification: {
    enabled: true;                   // é€šçŸ¥æœ‰åŠ¹
    scoreThreshold: 7;               // é«˜è©•ä¾¡é–¾å€¤
    errorNotificationEnabled: true;   // ã‚¨ãƒ©ãƒ¼é€šçŸ¥æœ‰åŠ¹
    dailySummaryEnabled: true;       // æ—¥æ¬¡ã‚µãƒãƒªãƒ¼æœ‰åŠ¹
  };
  
  storage: {
    retentionDays: 7;                // ãƒ‡ãƒ¼ã‚¿ä¿æŒæ—¥æ•°
    compressionEnabled: false;        // åœ§ç¸®ç„¡åŠ¹ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
    backupEnabled: false;            // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç„¡åŠ¹ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
  };
  
  performance: {
    timeoutSeconds: 600;             // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ10åˆ†ï¼‰
    retryCount: 2;                   // ãƒªãƒˆãƒ©ã‚¤å›æ•°
    concurrentLimit: 1;              // åŒæ™‚å®Ÿè¡Œæ•°åˆ¶é™
  };
}

// æ¤œç´¢æ¡ä»¶è¨­å®šï¼ˆconfig/search-conditions.jsonï¼‰
interface SearchConditions {
  version: string;                   // è¨­å®šãƒãƒ¼ã‚¸ãƒ§ãƒ³
  lastUpdated: Date;                 // æœ€çµ‚æ›´æ–°æ—¥æ™‚
  
  conditions: Array<{
    id: string;                      // æ¡ä»¶ID
    name: string;                    // æ¡ä»¶å
    enabled: boolean;                // æœ‰åŠ¹ãƒ•ãƒ©ã‚°
    
    // åŸºæœ¬æ¡ä»¶
    keywords: string[];              // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆæœ€å¤§10å€‹ï¼‰
    budgetMin: number;               // æœ€ä½äºˆç®—
    budgetMax: number;               // æœ€é«˜äºˆç®—
    category: string;                // ã‚«ãƒ†ã‚´ãƒª
    workType: 'fixed' | 'hourly' | 'both'; // ä½œæ¥­å½¢å¼
    
    // ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶
    clientRatingMin: number;         // æœ€ä½ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡
    experienceLevel: 'beginner' | 'intermediate' | 'expert' | 'any';
    
    // é™¤å¤–æ¡ä»¶
    excludeKeywords: string[];       // é™¤å¤–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    excludeClients: string[];        // é™¤å¤–ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
  }>;
}
```

## 3. ãƒ‡ãƒ¼ã‚¿æ“ä½œè¨­è¨ˆ

### 3.1 S3ãƒ‡ãƒ¼ã‚¿ã‚µãƒ¼ãƒ“ã‚¹

```typescript
class S3DataService {
  private s3: S3Client;
  private bucketName: string;

  // æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æ“ä½œ
  async saveJobs(jobs: JobData[], timestamp: string): Promise<void> {
    const key = `jobs/${timestamp}.json`;
    const body = JSON.stringify(jobs.map(this.sanitizeJobData), null, 2);
    
    await this.s3.putObject({
      Bucket: this.bucketName,
      Key: key,
      Body: body,
      ContentType: 'application/json',
      ServerSideEncryption: 'AES256',
      Metadata: {
        'job-count': jobs.length.toString(),
        'created-at': new Date().toISOString()
      }
    });
  }

  async getRecentJobs(hours: number = 24): Promise<JobData[]> {
    const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
    const objects = await this.listObjectsSince('jobs/', cutoff);
    
    const allJobs: JobData[] = [];
    for (const obj of objects.slice(0, 10)) { // æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«
      const data = await this.getObject(obj.Key!);
      const jobs: JobData[] = JSON.parse(data);
      allJobs.push(...jobs);
    }
    
    return allJobs;
  }

  async getExistingJobIds(hours: number = 48): Promise<Set<string>> {
    const recentJobs = await this.getRecentJobs(hours);
    return new Set(recentJobs.map(job => job.id));
  }

  // è¨­å®šæ“ä½œ
  async getSystemConfig(): Promise<SystemConfig> {
    try {
      const data = await this.getObject('config/system-config.json');
      return JSON.parse(data);
    } catch (error) {
      return this.getDefaultSystemConfig();
    }
  }

  async getSearchConditions(): Promise<SearchConditions> {
    try {
      const data = await this.getObject('config/search-conditions.json');
      return JSON.parse(data);
    } catch (error) {
      return this.getDefaultSearchConditions();
    }
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ¡ã‚½ãƒƒãƒ‰
  private async listObjectsSince(prefix: string, since: Date): Promise<_Object[]> {
    const response = await this.s3.listObjectsV2({
      Bucket: this.bucketName,
      Prefix: prefix,
      MaxKeys: 50 // ã‚³ã‚¹ãƒˆå‰Šæ¸›
    });

    return (response.Contents || [])
      .filter(obj => obj.LastModified && obj.LastModified >= since)
      .sort((a, b) => (b.LastModified?.getTime() || 0) - (a.LastModified?.getTime() || 0));
  }

  private async getObject(key: string): Promise<string> {
    const response = await this.s3.getObject({
      Bucket: this.bucketName,
      Key: key
    });

    return response.Body?.transformToString() || '';
  }

  private sanitizeJobData(job: JobData): JobData {
    return {
      ...job,
      description: job.description.slice(0, 500), // é•·ã•åˆ¶é™
      skills: job.skills.slice(0, 5), // é…åˆ—é•·åˆ¶é™
      clientName: job.clientName.replace(/[^\w\s-]/g, '') // ç‰¹æ®Šæ–‡å­—é™¤å»
    };
  }
}
```

### 3.2 é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½

```typescript
class DuplicateChecker {
  constructor(private dataService: S3DataService) {}

  async filterNewJobs(jobs: JobData[]): Promise<JobData[]> {
    // éå»48æ™‚é–“ã®ã‚¸ãƒ§ãƒ–IDã‚’å–å¾—
    const existingJobIds = await this.dataService.getExistingJobIds(48);
    
    // é‡è¤‡é™¤å¤–
    const newJobs = jobs.filter(job => !existingJobIds.has(job.id));
    
    // ã•ã‚‰ã«åŒä¸€å®Ÿè¡Œå†…ã§ã®é‡è¤‡ã‚‚ãƒã‚§ãƒƒã‚¯
    const uniqueJobs = this.removeDuplicatesInBatch(newJobs);
    
    return uniqueJobs;
  }

  private removeDuplicatesInBatch(jobs: JobData[]): JobData[] {
    const seen = new Set<string>();
    return jobs.filter(job => {
      if (seen.has(job.id)) {
        return false;
      }
      seen.add(job.id);
      return true;
    });
  }
}
```

## 4. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ»åˆæœŸåŒ–

### 4.1 åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š

```typescript
class DataInitializer {
  constructor(private dataService: S3DataService) {}

  async initializeSystem(): Promise<void> {
    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®åˆæœŸåŒ–
    await this.initializeSystemConfig();
    
    // æ¤œç´¢æ¡ä»¶ã®åˆæœŸåŒ–
    await this.initializeSearchConditions();
    
    // S3ãƒã‚±ãƒƒãƒˆã®è¨­å®šç¢ºèª
    await this.setupS3Bucket();
  }

  private async initializeSystemConfig(): Promise<void> {
    const defaultConfig: SystemConfig = {
      scraping: {
        maxJobsPerExecution: 50,
        preFilterEnabled: true,
        minBudget: 50000,
        minClientRating: 4.0,
        maxDescriptionLength: 500
      },
      ai: {
        enabled: true,
        model: 'gpt-3.5-turbo',
        maxJobsForEvaluation: 10,
        monthlyBudgetLimit: 3.0,
        maxTokensPerRequest: 200,
        temperature: 0.3
      },
      notification: {
        enabled: true,
        scoreThreshold: 7,
        errorNotificationEnabled: true,
        dailySummaryEnabled: true
      },
      storage: {
        retentionDays: 7,
        compressionEnabled: false,
        backupEnabled: false
      },
      performance: {
        timeoutSeconds: 600,
        retryCount: 2,
        concurrentLimit: 1
      }
    };

    await this.dataService.saveConfig('config/system-config.json', defaultConfig);
  }

  private async initializeSearchConditions(): Promise<void> {
    const defaultConditions: SearchConditions = {
      version: '1.0.0',
      lastUpdated: new Date(),
      conditions: [
        {
          id: 'web-development',
          name: 'Webã‚¢ãƒ—ãƒªé–‹ç™º',
          enabled: true,
          keywords: ['React', 'TypeScript', 'Next.js', 'Node.js'],
          budgetMin: 100000,
          budgetMax: 1000000,
          category: 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º',
          workType: 'fixed',
          clientRatingMin: 4.0,
          experienceLevel: 'intermediate',
          excludeKeywords: ['WordPress', 'PHP'],
          excludeClients: []
        },
        {
          id: 'ai-development',
          name: 'AIãƒ»æ©Ÿæ¢°å­¦ç¿’',
          enabled: true,
          keywords: ['Python', 'AI', 'æ©Ÿæ¢°å­¦ç¿’', 'ãƒ‡ãƒ¼ã‚¿åˆ†æ'],
          budgetMin: 150000,
          budgetMax: 2000000,
          category: 'ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º',
          workType: 'fixed',
          clientRatingMin: 4.5,
          experienceLevel: 'expert',
          excludeKeywords: ['Excel', 'å˜ç´”ä½œæ¥­'],
          excludeClients: []
        }
      ]
    };

    await this.dataService.saveConfig('config/search-conditions.json', defaultConditions);
  }
}
```

## 5. ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

### 5.1 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ–¹é‡ï¼ˆã‚³ã‚¹ãƒˆé‡è¦–ï¼‰

```typescript
interface BackupStrategy {
  // åŸºæœ¬æ–¹é‡ï¼šã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚æœ€å°é™ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
  configBackup: {
    enabled: true;
    frequency: 'on-change';  // è¨­å®šå¤‰æ›´æ™‚ã®ã¿
    retention: '30 days';
    location: 'same-bucket/backups/config/';
  };
  
  dataBackup: {
    enabled: false;          // ãƒ‡ãƒ¼ã‚¿ã¯7æ—¥ã§å‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—
    reason: 'Cost optimization - data has short lifecycle';
  };
  
  logBackup: {
    enabled: false;          // ãƒ­ã‚°ã‚‚7æ—¥ã§å‰Šé™¤
    reason: 'Cost optimization - short retention period';
  };
}

class BackupService {
  constructor(private dataService: S3DataService) {}

  // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆå¤‰æ›´æ™‚ã®ã¿ï¼‰
  async backupConfigOnChange(configType: 'system' | 'search-conditions'): Promise<void> {
    const timestamp = new Date().toISOString().split('T')[0];
    const sourceKey = `config/${configType === 'system' ? 'system-config.json' : 'search-conditions.json'}`;
    const backupKey = `backups/config/${configType}-${timestamp}.json`;

    try {
      const data = await this.dataService.getObject(sourceKey);
      await this.dataService.putObject(backupKey, data);
    } catch (error) {
      console.warn(`Config backup failed: ${error}`);
    }
  }
}
```

## 6. ãƒ‡ãƒ¼ã‚¿å“è³ªç®¡ç†

### 6.1 ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

```typescript
class DataValidator {
  // æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
  static validateJobData(job: JobData): { isValid: boolean; errors: string[] } {
    const errors: string[] = [];

    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
    if (!job.id || job.id.trim().length === 0) {
      errors.push('Job ID is required');
    }
    if (!job.title || job.title.trim().length === 0) {
      errors.push('Job title is required');
    }
    if (!job.url || !this.isValidUrl(job.url)) {
      errors.push('Valid job URL is required');
    }

    // æ•°å€¤æ¤œè¨¼
    if (job.budget <= 0) {
      errors.push('Budget must be positive');
    }
    if (job.clientRating < 1 || job.clientRating > 5) {
      errors.push('Client rating must be between 1 and 5');
    }

    // é…åˆ—é•·åˆ¶é™
    if (job.skills.length > 5) {
      errors.push('Skills array cannot exceed 5 items');
    }
    if (job.description.length > 500) {
      errors.push('Description cannot exceed 500 characters');
    }

    // æ—¥ä»˜æ¤œè¨¼
    if (!(job.scrapedAt instanceof Date) || isNaN(job.scrapedAt.getTime())) {
      errors.push('Invalid scraped date');
    }
    if (!(job.deadline instanceof Date) || isNaN(job.deadline.getTime())) {
      errors.push('Invalid deadline');
    }

    return {
      isValid: errors.length === 0,
      errors
    };
  }

  // è©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
  static validateEvaluation(evaluation: JobEvaluation): { isValid: boolean; errors: string[] } {
    const errors: string[] = [];

    if (!evaluation.jobId || evaluation.jobId.trim().length === 0) {
      errors.push('Job ID is required');
    }
    if (evaluation.score < 1 || evaluation.score > 10) {
      errors.push('Score must be between 1 and 10');
    }
    if (!evaluation.reason || evaluation.reason.length > 50) {
      errors.push('Reason must be 1-50 characters');
    }
    if (evaluation.tokenUsed < 0) {
      errors.push('Token usage cannot be negative');
    }
    if (evaluation.costEstimate < 0) {
      errors.push('Cost estimate cannot be negative');
    }

    return {
      isValid: errors.length === 0,
      errors
    };
  }

  private static isValidUrl(url: string): boolean {
    try {
      new URL(url);
      return url.includes('crowdworks.jp');
    } catch {
      return false;
    }
  }
}

// ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
class DataCleaner {
  static cleanJobData(job: JobData): JobData {
    return {
      ...job,
      title: job.title.trim().slice(0, 200),
      description: job.description.trim().slice(0, 500),
      skills: job.skills.slice(0, 5).map(skill => skill.trim()),
      clientName: job.clientName.trim().replace(/[^\w\s-]/g, ''),
      budget: Math.max(0, Math.round(job.budget)),
      clientRating: Math.max(1, Math.min(5, job.clientRating))
    };
  }

  static cleanEvaluation(evaluation: JobEvaluation): JobEvaluation {
    return {
      ...evaluation,
      score: Math.max(1, Math.min(10, Math.round(evaluation.score))),
      reason: evaluation.reason.trim().slice(0, 50),
      strengths: evaluation.strengths.slice(0, 3),
      concerns: evaluation.concerns.slice(0, 3),
      tokenUsed: Math.max(0, evaluation.tokenUsed),
      costEstimate: Math.max(0, evaluation.costEstimate)
    };
  }
}
```

**ã“ã‚Œã§S3ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸ãŒå®Œæˆã—ã¾ã—ãŸï¼**

ã‚³ã‚¹ãƒˆåˆ¶ç´„ï¼ˆæœˆ$5ä»¥ä¸‹ï¼‰ã‚’æº€ãŸã—ãªãŒã‚‰ã€å¿…è¦ãªæ©Ÿèƒ½ã‚’æä¾›ã§ãã‚‹è»½é‡ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«ãªã£ã¦ã„ã¾ã™ã€‚
</file>

<file path="docs/04_api_design.md">
# APIè¨­è¨ˆæ›¸

## 1. APIæ¦‚è¦

### 1.1 APIæ–¹é‡

**åŸºæœ¬æ–¹é‡**
- **ã‚³ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: æœˆ$5ä»¥ä¸‹ã®äºˆç®—åˆ¶ç´„ã‚’æœ€å„ªå…ˆ
- **ã‚µãƒ¼ãƒãƒ¬ã‚¹ä¸­å¿ƒ**: Lambdaé–¢æ•°é–“ã®è»½é‡ãªå†…éƒ¨API
- **å¤–éƒ¨APIæœ€å°é™**: ChatGPT APIï¼ˆè»½é‡åˆ©ç”¨ï¼‰ã¨ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®ã¿
- **RESTfulè¨­è¨ˆ**: æ¨™æº–çš„ãªHTTPãƒ¡ã‚½ãƒƒãƒ‰ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
- **JSONå½¢å¼**: å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯JSON
- **å‹å®‰å…¨æ€§**: TypeScriptã§ã®å®Œå…¨ãªå‹å®šç¾©

**APIæ§‹æˆ**
- **å†…éƒ¨API**: Lambdaé–¢æ•°é–“ã®é€£æºï¼ˆEventBridge + ç›´æ¥å‘¼ã³å‡ºã—ï¼‰
- **ç®¡ç†ç”¨API**: è¨­å®šç¢ºèªãƒ»æ‰‹å‹•å®Ÿè¡Œç”¨ã®æœ€å°é™APIï¼ˆAPI Gatewayï¼‰
- **å¤–éƒ¨API**: ChatGPT APIã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
- **é€šçŸ¥API**: SNS/SESã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒ»é«˜è©•ä¾¡æ¡ˆä»¶é€šçŸ¥

### 1.2 èªè¨¼æ–¹å¼

**å†…éƒ¨APIèªè¨¼**
```typescript
// Lambdaé–¢æ•°é–“: IAMãƒ­ãƒ¼ãƒ«ã«ã‚ˆã‚‹èªè¨¼
interface LambdaInvocationAuth {
  type: 'IAM_ROLE';
  role: 'arn:aws:iam::account:role/CrowdWorksSearcherRole';
  permissions: ['lambda:InvokeFunction', 's3:GetObject', 's3:PutObject'];
}

// EventBridge: ã‚µãƒ¼ãƒ“ã‚¹é–“èªè¨¼
interface EventBridgeAuth {
  type: 'SERVICE_PRINCIPAL';
  principal: 'events.amazonaws.com';
  targetFunction: 'CrowdWorksSearcherMainFunction';
}
```

**å¤–éƒ¨APIèªè¨¼**
```typescript
// Parameter Store ã§ã®å®‰å…¨ãªç®¡ç†
interface ExternalAPIAuth {
  chatgpt: {
    type: 'Bearer Token';
    storage: 'AWS Systems Manager Parameter Store';
    path: '/crowdworks-searcher/secrets/openai-api-key';
    encryption: 'SecureString';
  };
  
  crowdworks: {
    type: 'Session Cookie';
    storage: 'AWS Systems Manager Parameter Store';
    credentials: {
      email: '/crowdworks-searcher/secrets/crowdworks-email';
      password: '/crowdworks-searcher/secrets/crowdworks-password';
    };
    encryption: 'SecureString';
  };
}
```

### 1.3 ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å…±é€šä»•æ§˜

```typescript
// æ¨™æº–ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
interface APIErrorResponse {
  error: {
    code: string;           // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
    message: string;        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    timestamp: string;      // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰
    requestId: string;      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ç”¨ï¼‰
    retryable: boolean;     // ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã‹ã©ã†ã‹
    details?: Record<string, any>; // è©³ç´°æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  };
}

// ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰å®šç¾©
enum APIErrorCode {
  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¨ãƒ©ãƒ¼ (4xx)
  INVALID_REQUEST = 'INVALID_REQUEST',
  AUTHENTICATION_FAILED = 'AUTHENTICATION_FAILED',
  AUTHORIZATION_FAILED = 'AUTHORIZATION_FAILED',
  RESOURCE_NOT_FOUND = 'RESOURCE_NOT_FOUND',
  RATE_LIMIT_EXCEEDED = 'RATE_LIMIT_EXCEEDED',
  
  // ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (5xx)
  INTERNAL_SERVER_ERROR = 'INTERNAL_SERVER_ERROR',
  SERVICE_UNAVAILABLE = 'SERVICE_UNAVAILABLE',
  EXTERNAL_API_ERROR = 'EXTERNAL_API_ERROR',
  TIMEOUT_ERROR = 'TIMEOUT_ERROR',
  
  // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼
  BUDGET_EXCEEDED = 'BUDGET_EXCEEDED',
  SCRAPING_FAILED = 'SCRAPING_FAILED',
  AI_EVALUATION_FAILED = 'AI_EVALUATION_FAILED',
  S3_OPERATION_FAILED = 'S3_OPERATION_FAILED'
}
```

## 2. å†…éƒ¨APIè¨­è¨ˆ

### 2.1 ãƒ¡ã‚¤ãƒ³å‡¦ç†APIï¼ˆLambdaé–¢æ•°ï¼‰

#### 2.1.1 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ

```typescript
// EventBridge â†’ Lambdaå®Ÿè¡Œ
interface ScheduledExecutionEvent {
  source: 'aws.events';
  'detail-type': 'Scheduled Event';
  detail: {};
  time: string; // ISOå½¢å¼
}

interface ScheduledExecutionResponse {
  status: 'success' | 'error' | 'partial';
  executionId: string;
  timestamp: string;
  results: {
    jobsScraped: number;
    newJobs: number;
    aiEvaluated: number;
    highScoreJobs: number;
    duration: number;
    costEstimate: number;
  };
  error?: {
    type: string;
    message: string;
  };
}

// Lambda Handlerå®Ÿè£…
export const scheduledExecutionHandler = async (
  event: ScheduledExecutionEvent
): Promise<ScheduledExecutionResponse> => {
  const executionId = Date.now().toString();
  const startTime = Date.now();
  
  try {
    // ãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
    const result = await executeMainFlow(executionId);
    
    return {
      status: 'success',
      executionId,
      timestamp: new Date().toISOString(),
      results: {
        ...result,
        duration: Date.now() - startTime
      }
    };
  } catch (error) {
    return {
      status: 'error',
      executionId,
      timestamp: new Date().toISOString(),
      results: {
        jobsScraped: 0,
        newJobs: 0,
        aiEvaluated: 0,
        highScoreJobs: 0,
        duration: Date.now() - startTime,
        costEstimate: 0
      },
      error: {
        type: error.constructor.name,
        message: error.message
      }
    };
  }
};
```

#### 2.1.2 æ‰‹å‹•å®Ÿè¡ŒAPI

```typescript
// ç·Šæ€¥æ™‚ã®æ‰‹å‹•å®Ÿè¡Œç”¨ï¼ˆAPI GatewayçµŒç”±ï¼‰
interface ManualExecutionRequest {
  trigger: 'manual';
  options?: {
    skipCache?: boolean;     // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ã‚­ãƒƒãƒ—
    forceAIEvaluation?: boolean; // AIè©•ä¾¡å¼·åˆ¶å®Ÿè¡Œ
    testMode?: boolean;      // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰
  };
}

interface ManualExecutionResponse {
  message: string;
  executionId: string;
  estimatedCompletion: string; // å®Œäº†äºˆå®šæ™‚åˆ»
  monitorUrl?: string;         // å®Ÿè¡ŒçŠ¶æ³ç¢ºèªURLï¼ˆS3ãƒ­ã‚°ï¼‰
}

// POST /api/execute
export const manualExecutionHandler = async (
  event: APIGatewayProxyEvent
): Promise<APIGatewayProxyResult> => {
  try {
    const request: ManualExecutionRequest = JSON.parse(event.body || '{}');
    
    // Lambdaé–¢æ•°ã‚’éåŒæœŸå®Ÿè¡Œ
    const executionId = await invokeLambdaAsync('main-function', {
      source: 'manual',
      options: request.options
    });
    
    const response: ManualExecutionResponse = {
      message: 'Execution started successfully',
      executionId,
      estimatedCompletion: new Date(Date.now() + 60000).toISOString(),
      monitorUrl: `s3://bucket/logs/execution/${executionId}.json`
    };
    
    return {
      statusCode: 202,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(response)
    };
  } catch (error) {
    return createErrorResponse(APIErrorCode.INTERNAL_SERVER_ERROR, error.message);
  }
};
```

### 2.2 è¨­å®šç®¡ç†API

#### 2.2.1 ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå–å¾—

```typescript
// GET /api/config/system
interface SystemConfigResponse {
  config: SystemConfig;
  lastModified: string;
  version: string;
}

export const getSystemConfigHandler = async (): Promise<APIGatewayProxyResult> => {
  try {
    const s3DataService = new S3DataService();
    const config = await s3DataService.getSystemConfig();
    
    const response: SystemConfigResponse = {
      config,
      lastModified: new Date().toISOString(),
      version: '1.0.0'
    };
    
    return {
      statusCode: 200,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(response)
    };
  } catch (error) {
    return createErrorResponse(APIErrorCode.S3_OPERATION_FAILED, error.message);
  }
};
```

#### 2.2.2 æ¤œç´¢æ¡ä»¶ç®¡ç†

```typescript
// GET /api/config/search-conditions
interface SearchConditionsResponse {
  conditions: SearchConditions;
  activeCount: number;
  lastModified: string;
}

// PUT /api/config/search-conditions
interface UpdateSearchConditionsRequest {
  conditions: SearchConditions;
  backupCurrent?: boolean; // ç¾åœ¨ã®è¨­å®šã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
}

export const getSearchConditionsHandler = async (): Promise<APIGatewayProxyResult> => {
  try {
    const s3DataService = new S3DataService();
    const conditions = await s3DataService.getSearchConditions();
    
    const activeCount = conditions.conditions.filter(c => c.enabled).length;
    
    const response: SearchConditionsResponse = {
      conditions,
      activeCount,
      lastModified: conditions.lastUpdated.toISOString()
    };
    
    return {
      statusCode: 200,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(response)
    };
  } catch (error) {
    return createErrorResponse(APIErrorCode.S3_OPERATION_FAILED, error.message);
  }
};
```

### 2.3 ãƒ‡ãƒ¼ã‚¿å–å¾—API

#### 2.3.1 æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å–å¾—

```typescript
// GET /api/jobs?hours=24&limit=50
interface JobsQuery {
  hours?: number;    // éå»ä½•æ™‚é–“ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 24ï¼‰
  limit?: number;    // æœ€å¤§å–å¾—ä»¶æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ï¼‰
  minScore?: number; // æœ€ä½ã‚¹ã‚³ã‚¢
}

interface JobsResponse {
  jobs: JobData[];
  totalCount: number;
  timeRange: {
    from: string;
    to: string;
  };
  hasMore: boolean;
}

export const getJobsHandler = async (
  event: APIGatewayProxyEvent
): Promise<APIGatewayProxyResult> => {
  try {
    const query: JobsQuery = event.queryStringParameters || {};
    const hours = parseInt(query.hours || '24');
    const limit = parseInt(query.limit || '50');
    const minScore = query.minScore ? parseFloat(query.minScore) : undefined;
    
    const s3DataService = new S3DataService();
    let jobs = await s3DataService.getRecentJobs(hours);
    
    // ã‚¹ã‚³ã‚¢ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ï¼ˆè©•ä¾¡ãƒ‡ãƒ¼ã‚¿ã¨çµåˆï¼‰
    if (minScore !== undefined) {
      const evaluations = await s3DataService.getRecentEvaluations(hours);
      const highScoreJobIds = new Set(
        evaluations.filter(e => e.score >= minScore).map(e => e.jobId)
      );
      jobs = jobs.filter(job => highScoreJobIds.has(job.id));
    }
    
    // ãƒšãƒ¼ã‚¸ãƒ³ã‚°
    const paginatedJobs = jobs.slice(0, limit);
    const hasMore = jobs.length > limit;
    
    const response: JobsResponse = {
      jobs: paginatedJobs,
      totalCount: jobs.length,
      timeRange: {
        from: new Date(Date.now() - hours * 60 * 60 * 1000).toISOString(),
        to: new Date().toISOString()
      },
      hasMore
    };
    
    return {
      statusCode: 200,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(response)
    };
  } catch (error) {
    return createErrorResponse(APIErrorCode.S3_OPERATION_FAILED, error.message);
  }
};
```

#### 2.3.2 å®Ÿè¡ŒçŠ¶æ³å–å¾—

```typescript
// GET /api/status
interface SystemStatusResponse {
  status: 'healthy' | 'degraded' | 'unhealthy';
  lastExecution: {
    id: string;
    timestamp: string;
    status: string;
    duration: number;
    results: {
      jobsScraped: number;
      newJobs: number;
      highScoreJobs: number;
    };
  } | null;
  nextExecution: string; // æ¬¡å›å®Ÿè¡Œäºˆå®šæ™‚åˆ»
  monthlyStats: {
    executions: number;
    totalJobs: number;
    totalCost: number;
    budgetRemaining: number;
  };
  alerts: string[]; // ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§
}

export const getSystemStatusHandler = async (): Promise<APIGatewayProxyResult> => {
  try {
    const s3DataService = new S3DataService();
    
    // æœ€æ–°ã®å®Ÿè¡Œãƒ­ã‚°ã‚’å–å¾—
    const lastExecution = await s3DataService.getLatestExecutionLog();
    
    // æœˆæ¬¡çµ±è¨ˆã‚’è¨ˆç®—
    const monthlyStats = await calculateMonthlyStats();
    
    // ã‚·ã‚¹ãƒ†ãƒ å¥åº·çŠ¶æ…‹ã‚’åˆ¤å®š
    const status = determineSystemHealth(lastExecution, monthlyStats);
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
    const alerts = await checkSystemAlerts(monthlyStats);
    
    const response: SystemStatusResponse = {
      status,
      lastExecution: lastExecution ? {
        id: lastExecution.executionId,
        timestamp: lastExecution.timestamp,
        status: lastExecution.status,
        duration: lastExecution.duration,
        results: {
          jobsScraped: lastExecution.jobsScraped,
          newJobs: lastExecution.newJobs,
          highScoreJobs: lastExecution.highScoreJobs
        }
      } : null,
      nextExecution: getNextExecutionTime(),
      monthlyStats,
      alerts
    };
    
    return {
      statusCode: 200,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(response)
    };
  } catch (error) {
    return createErrorResponse(APIErrorCode.INTERNAL_SERVER_ERROR, error.message);
  }
};
```

## 3. å¤–éƒ¨APIé€£æº

### 3.1 ChatGPT APIé€£æº

```typescript
// OpenAI APIæ¥ç¶šè¨­å®š
interface ChatGPTAPIConfig {
  baseURL: 'https://api.openai.com/v1';
  model: 'gpt-3.5-turbo';
  maxTokens: 200;
  temperature: 0.3;
  timeout: 30000; // 30ç§’
}

// APIå‘¼ã³å‡ºã—ã‚µãƒ¼ãƒ“ã‚¹
class ChatGPTAPIService {
  private client: OpenAI;
  private rateLimiter: RateLimiter;
  private costTracker: CostTracker;

  constructor(apiKey: string) {
    this.client = new OpenAI({ apiKey });
    this.rateLimiter = new RateLimiter({
      requestsPerMinute: 50,  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œ
      requestsPerHour: 1000
    });
    this.costTracker = new CostTracker({
      monthlyLimit: 3.0 // $3/æœˆåˆ¶é™
    });
  }

  async evaluateJob(job: JobData): Promise<JobEvaluation> {
    // ã‚³ã‚¹ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (this.costTracker.isOverLimit()) {
      throw new Error('Monthly AI budget exceeded');
    }

    // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    await this.rateLimiter.waitIfNeeded();

    try {
      const prompt = this.createEvaluationPrompt(job);
      
      const response = await this.client.chat.completions.create({
        model: 'gpt-3.5-turbo',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 200,
        temperature: 0.3,
        response_format: { type: 'json_object' }
      });

      const content = response.choices[0]?.message?.content;
      if (!content) {
        throw new Error('Empty response from ChatGPT API');
      }

      const evaluation = this.parseEvaluationResponse(content, job.id);
      
      // ã‚³ã‚¹ãƒˆè¿½è·¡
      const cost = this.calculateCost(response.usage);
      this.costTracker.addUsage(cost);
      
      return {
        ...evaluation,
        tokenUsed: response.usage?.total_tokens || 0,
        costEstimate: cost
      };

    } catch (error) {
      if (error.status === 429) {
        throw new APIError(APIErrorCode.RATE_LIMIT_EXCEEDED, 'ChatGPT API rate limit exceeded');
      }
      if (error.status >= 500) {
        throw new APIError(APIErrorCode.EXTERNAL_API_ERROR, 'ChatGPT API server error');
      }
      throw new APIError(APIErrorCode.AI_EVALUATION_FAILED, error.message);
    }
  }

  private createEvaluationPrompt(job: JobData): string {
    return `
æ¡ˆä»¶ã‚’è©•ä¾¡ã—ã¦JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

æ¡ˆä»¶æƒ…å ±:
- ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}
- äºˆç®—: ${job.budget.toLocaleString()}å††
- ç´æœŸ: ${job.deadline.toLocaleDateString()}
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡: ${job.clientRating}/5.0
- å¿…è¦ã‚¹ã‚­ãƒ«: ${job.skills.join(', ')}
- æ¦‚è¦: ${job.description.slice(0, 200)}

è©•ä¾¡åŸºæº–:
1. äºˆç®—ã®å¦¥å½“æ€§ï¼ˆç›¸å ´ã¨ã®æ¯”è¼ƒï¼‰
2. ã‚¹ã‚­ãƒ«ãƒãƒƒãƒãƒ³ã‚°åº¦
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¿¡é ¼æ€§
4. æ¡ˆä»¶èª¬æ˜ã®æ˜ç¢ºæ€§
5. ç´æœŸã®ç¾å®Ÿæ€§

å›ç­”å½¢å¼:
{
  "score": 1-10ã®æ•´æ•°,
  "reason": "è©•ä¾¡ç†ç”±ï¼ˆ50æ–‡å­—ä»¥å†…ï¼‰",
  "strengths": ["å¼·ã¿1", "å¼·ã¿2"],
  "concerns": ["æ‡¸å¿µ1", "æ‡¸å¿µ2"]
}
`;
  }

  private parseEvaluationResponse(content: string, jobId: string): JobEvaluation {
    try {
      const parsed = JSON.parse(content);
      
      return {
        jobId,
        evaluatedAt: new Date(),
        score: Math.max(1, Math.min(10, parseInt(parsed.score))),
        reason: (parsed.reason || '').slice(0, 50),
        aiModel: 'gpt-3.5-turbo',
        tokenUsed: 0, // å¾Œã§è¨­å®š
        costEstimate: 0, // å¾Œã§è¨­å®š
        strengths: (parsed.strengths || []).slice(0, 3),
        concerns: (parsed.concerns || []).slice(0, 3)
      };
    } catch (error) {
      // ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè©•ä¾¡
      return createDefaultEvaluation(jobId);
    }
  }

  private calculateCost(usage: any): number {
    const inputTokens = usage?.prompt_tokens || 0;
    const outputTokens = usage?.completion_tokens || 0;
    
    // GPT-3.5-turbo pricing: $0.0015/1K input, $0.002/1K output
    return (inputTokens * 0.0015 + outputTokens * 0.002) / 1000;
  }
}
```

### 3.2 ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°

```typescript
// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹è¨­å®š
interface ScrapingConfig {
  baseURL: 'https://crowdworks.jp';
  userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36';
  timeout: 30000;
  retryCount: 3;
  retryDelay: 2000;
}

// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°API
class CrowdWorksScrapingService {
  private browser: Browser | null = null;
  private page: Page | null = null;
  private isAuthenticated: boolean = false;

  async initialize(): Promise<void> {
    try {
      this.browser = await playwright.chromium.launch({
        headless: true,
        args: ['--no-sandbox', '--disable-setuid-sandbox'] // Lambdaç”¨è¨­å®š
      });

      this.page = await this.browser.newPage({
        userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
      });

      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
      this.page.setDefaultTimeout(30000);
      
    } catch (error) {
      throw new APIError(APIErrorCode.SCRAPING_FAILED, `Browser initialization failed: ${error.message}`);
    }
  }

  async authenticate(credentials: { email: string; password: string }): Promise<void> {
    if (!this.page) {
      throw new APIError(APIErrorCode.SCRAPING_FAILED, 'Browser not initialized');
    }

    try {
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ç§»å‹•
      await this.page.goto('https://crowdworks.jp/login');
      
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›
      await this.page.fill('input[name="email"]', credentials.email);
      await this.page.fill('input[name="password"]', credentials.password);
      
      // ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
      await this.page.click('button[type="submit"]');
      
      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç¢ºèª
      await this.page.waitForURL('**/dashboard', { timeout: 10000 });
      
      this.isAuthenticated = true;
      
    } catch (error) {
      throw new APIError(APIErrorCode.AUTHENTICATION_FAILED, `CrowdWorks login failed: ${error.message}`);
    }
  }

  async searchJobs(conditions: SearchCondition[]): Promise<JobData[]> {
    if (!this.isAuthenticated || !this.page) {
      throw new APIError(APIErrorCode.AUTHENTICATION_FAILED, 'Not authenticated');
    }

    const allJobs: JobData[] = [];

    for (const condition of conditions) {
      if (!condition.enabled) continue;

      try {
        const jobs = await this.searchWithCondition(condition);
        allJobs.push(...jobs);
        
        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾å¿œï¼ˆæ¤œç´¢é–“éš”ï¼‰
        await this.delay(2000);
        
      } catch (error) {
        console.warn(`Search failed for condition ${condition.id}:`, error.message);
        // å€‹åˆ¥ã®æ¤œç´¢å¤±æ•—ã¯å…¨ä½“ã‚’æ­¢ã‚ãªã„
      }
    }

    return allJobs;
  }

  private async searchWithCondition(condition: SearchCondition): Promise<JobData[]> {
    if (!this.page) throw new Error('Page not available');

    const jobs: JobData[] = [];

    try {
      // æ¤œç´¢ãƒšãƒ¼ã‚¸ã«ç§»å‹•
      await this.page.goto('https://crowdworks.jp/projects/search');
      
      // æ¤œç´¢æ¡ä»¶è¨­å®š
      await this.setSearchFilters(condition);
      
      // æ¤œç´¢å®Ÿè¡Œ
      await this.page.click('button[type="submit"]');
      await this.page.waitForSelector('.project-item', { timeout: 10000 });
      
      // æ¡ˆä»¶ãƒªã‚¹ãƒˆå–å¾—
      const jobElements = await this.page.$$('.project-item');
      
      for (const element of jobElements.slice(0, 20)) { // æœ€å¤§20ä»¶
        try {
          const jobData = await this.extractJobData(element);
          if (jobData && this.validateJobData(jobData)) {
            jobs.push(jobData);
          }
        } catch (error) {
          console.warn('Failed to extract job data:', error.message);
        }
      }
      
    } catch (error) {
      throw new APIError(APIErrorCode.SCRAPING_FAILED, `Search failed: ${error.message}`);
    }

    return jobs;
  }

  async cleanup(): Promise<void> {
    if (this.page) {
      await this.page.close();
      this.page = null;
    }
    if (this.browser) {
      await this.browser.close();
      this.browser = null;
    }
    this.isAuthenticated = false;
  }
}
```

## 4. é€šçŸ¥APIè¨­è¨ˆ

### 4.1 SNSé€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹

```typescript
// SNSé€šçŸ¥è¨­å®š
interface NotificationConfig {
  errorTopic: string;          // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ç”¨SNSãƒˆãƒ”ãƒƒã‚¯
  highScoreTopic: string;      // é«˜è©•ä¾¡æ¡ˆä»¶é€šçŸ¥ç”¨
  email: string;               // é€šçŸ¥å…ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  enabled: boolean;            // é€šçŸ¥æœ‰åŠ¹ãƒ•ãƒ©ã‚°
}

// é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹
class NotificationService {
  private sns: SNSClient;
  private ses: SESClient;
  private config: NotificationConfig;

  constructor(config: NotificationConfig) {
    this.sns = new SNSClient({});
    this.ses = new SESClient({});
    this.config = config;
  }

  // ã‚¨ãƒ©ãƒ¼é€šçŸ¥
  async sendErrorAlert(error: Error, executionId: string): Promise<void> {
    if (!this.config.enabled) return;

    const message = {
      timestamp: new Date().toISOString(),
      executionId,
      errorType: error.constructor.name,
      errorMessage: error.message,
      severity: this.determineSeverity(error)
    };

    try {
      await this.sns.publish({
        TopicArn: this.config.errorTopic,
        Subject: `[CrowdWorks Searcher] ${message.severity} Error`,
        Message: JSON.stringify(message, null, 2)
      });
    } catch (snsError) {
      console.error('Failed to send error notification:', snsError);
    }
  }

  // é«˜è©•ä¾¡æ¡ˆä»¶é€šçŸ¥
  async sendHighScoreAlert(jobs: JobEvaluation[]): Promise<void> {
    if (!this.config.enabled || jobs.length === 0) return;

    const message = {
      timestamp: new Date().toISOString(),
      jobCount: jobs.length,
      jobs: jobs.map(job => ({
        jobId: job.jobId,
        score: job.score,
        reason: job.reason
      }))
    };

    try {
      await this.sns.publish({
        TopicArn: this.config.highScoreTopic,
        Subject: `[CrowdWorks Searcher] ${jobs.length} High Score Job(s) Found`,
        Message: JSON.stringify(message, null, 2)
      });
    } catch (snsError) {
      console.error('Failed to send high score notification:', snsError);
    }
  }
}
```

## 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å…±é€šå®Ÿè£…

```typescript
// ã‚¨ãƒ©ãƒ¼å‡¦ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼
export const createErrorResponse = (
  errorCode: APIErrorCode,
  message: string,
  details?: Record<string, any>
): APIGatewayProxyResult => {
  const error: APIErrorResponse = {
    error: {
      code: errorCode,
      message,
      timestamp: new Date().toISOString(),
      requestId: uuidv4(),
      retryable: isRetryableError(errorCode),
      details
    }
  };

  return {
    statusCode: ERROR_STATUS_MAP[errorCode] || 500,
    headers: {
      'Content-Type': 'application/json',
      'X-Request-ID': error.error.requestId
    },
    body: JSON.stringify(error)
  };
};

// ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹
export class APIError extends Error {
  constructor(
    public code: APIErrorCode,
    message: string,
    public retryable: boolean = false,
    public details?: Record<string, any>
  ) {
    super(message);
    this.name = 'APIError';
  }
}

// ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ã‚¨ãƒ©ãƒ¼ã®åˆ¤å®š
const isRetryableError = (errorCode: APIErrorCode): boolean => {
  return [
    APIErrorCode.SERVICE_UNAVAILABLE,
    APIErrorCode.TIMEOUT_ERROR,
    APIErrorCode.EXTERNAL_API_ERROR,
    APIErrorCode.RATE_LIMIT_EXCEEDED
  ].includes(errorCode);
};
```
</file>

<file path="env.example">
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ç’°å¢ƒå¤‰æ•°
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .env ã«ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿéš›ã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„

# CrowdWorksèªè¨¼æƒ…å ±ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
CROWDWORKS_EMAIL=your-crowdworks-email@example.com
CROWDWORKS_PASSWORD=your-crowdworks-password

# AWSè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
AWS_REGION=ap-northeast-1
AWS_PROFILE=default

# ãƒ‡ãƒãƒƒã‚°è¨­å®š
NODE_ENV=development
LOG_LEVEL=debug
DEBUG=1

# Playwrightè¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯é€šå¸¸ã¯ç©ºã¾ãŸã¯æœªè¨­å®šã§OKï¼ˆPlaywrightãŒè‡ªå‹•ã§è¦‹ã¤ã‘ã‚‹ï¼‰
# ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¹ã‚’ä½¿ã„ãŸã„å ´åˆã®ã¿è¨­å®š
PLAYWRIGHT_BROWSERS_PATH=
# ä¾‹ï¼šã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
# PLAYWRIGHT_BROWSERS_PATH=C:\Users\n\AppData\Local\ms-playwright

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„ï¼ˆ0 = ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼‰
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0
</file>

<file path="README-setup.md">
# CrowdWorks Search - ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

## ğŸ” èªè¨¼æƒ…å ±è¨­å®š

### æ–¹æ³•1: ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆæ¨å¥¨ï¼šãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰

1. **ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**:
```bash
# env.example ã‚’ .env ã«ã‚³ãƒ”ãƒ¼
cp env.example .env

# .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦å®Ÿéš›ã®èªè¨¼æƒ…å ±ã‚’è¨­å®š
# Windows PowerShell ã®å ´åˆ:
notepad .env

# ä»¥ä¸‹ã®å€¤ã‚’è¨­å®š:
CROWDWORKS_EMAIL=your-crowdworks-email@example.com
CROWDWORKS_PASSWORD=your-crowdworks-password
```

2. **ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚“ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ**:
```bash
# PowerShell ã§ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
Get-Content .env | ForEach-Object {
    $name, $value = $_.split('=', 2)
    Set-Item -Path "env:$name" -Value $value
}

# ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
npm run test:login:local
```

### æ–¹æ³•2: AWS Parameter Storeè¨­å®šï¼ˆæœ¬ç•ªç”¨ï¼‰

1. **Parameter Store ã«èªè¨¼æƒ…å ±ã‚’è¨­å®š**:
```bash
# CrowdWorks ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
aws ssm put-parameter \
  --name "/crowdworks-search/crowdworks/email" \
  --value "your-crowdworks-email@example.com" \
  --type "SecureString" \
  --region ap-northeast-1

# CrowdWorks ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
aws ssm put-parameter \
  --name "/crowdworks-search/crowdworks/password" \
  --value "your-crowdworks-password" \
  --type "SecureString" \
  --region ap-northeast-1
```

2. **Parameter Store ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèª**:
```bash
# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§è¡¨ç¤º
aws ssm describe-parameters --region ap-northeast-1

# ç‰¹å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å€¤ç¢ºèªï¼ˆå¾©å·åŒ–ã—ã¦è¡¨ç¤ºï¼‰
aws ssm get-parameter \
  --name "/crowdworks-search/crowdworks/email" \
  --with-decryption \
  --region ap-northeast-1
```

## ğŸ­ Playwrightè¨­å®š

### ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®Playwrightè¨­å®š

**é‡è¦**: ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯é€šå¸¸ `PLAYWRIGHT_BROWSERS_PATH` ã‚’è¨­å®šã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

1. **Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**:
```bash
# Chromiumãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npx playwright install chromium

# å…¨ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
npx playwright install

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npx playwright install-deps
```

2. **ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆé€šå¸¸ã¯ä¸è¦ï¼‰**:
```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®è¨­å®šä¾‹
PLAYWRIGHT_BROWSERS_PATH=
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0
```

### ç’°å¢ƒåˆ¥ã®Playwrightè¨­å®š

| ç’°å¢ƒ | PLAYWRIGHT_BROWSERS_PATH | PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD | èª¬æ˜ |
|------|-------------------------|-----------------------------------|------|
| **ãƒ­ãƒ¼ã‚«ãƒ«** | `ç©º` ã¾ãŸã¯æœªè¨­å®š | `0` (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹) | PlaywrightãŒè‡ªå‹•ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ç®¡ç† |
| **Lambda Container** | `/usr/bin` | `1` (ã‚¹ã‚­ãƒƒãƒ—) | ã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿Chromiumã‚’ä½¿ç”¨ |
| **CI/CD** | `ç©º` ã¾ãŸã¯æœªè¨­å®š | `0` (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹) | ãƒ†ã‚¹ãƒˆç”¨ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« |

### Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã®å ´æ‰€ç¢ºèª

```bash
# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€ç¢ºèª
npx playwright --version

# Windowsã®é€šå¸¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€:
# C:\Users\{ãƒ¦ãƒ¼ã‚¶ãƒ¼å}\AppData\Local\ms-playwright\chromium-{ãƒãƒ¼ã‚¸ãƒ§ãƒ³}

# ãƒ–ãƒ©ã‚¦ã‚¶ãŒæ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
npx playwright list-files chromium
```

## ğŸ§ª ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

### 1. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
npm install
```

### 2. Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
npx playwright install chromium
```

### 3. TypeScriptãƒ“ãƒ«ãƒ‰
```bash
npm run build
```

### 4. CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ
```bash
# ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—
npm run test:login:local

# ã¾ãŸã¯ç›´æ¥å®Ÿè¡Œ
npx ts-node src/test/crowdworks-scraping-test.ts
```

### 5. ãƒ†ã‚¹ãƒˆçµæœç¢ºèª
```
ğŸš€ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹...
ğŸ” CrowdWorksèªè¨¼æƒ…å ±ã‚’å–å¾—ä¸­...
âœ… ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—å®Œäº†
ğŸ“„ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ä¸­...
âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†
ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ä¸­...
ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ä¸­...
ğŸ“¸ ãƒ­ã‚°ã‚¤ãƒ³å‰ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜: login-before.png
ğŸ–±ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ä¸­...
â³ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†å®Œäº†å¾…æ©Ÿä¸­...
ğŸ“¸ ãƒ­ã‚°ã‚¤ãƒ³å¾Œã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜: login-after.png
ğŸ” ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèªä¸­...
âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼
â¸ï¸ 5ç§’é–“å¾…æ©Ÿï¼ˆãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèªï¼‰...
ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºå®Œäº†
ğŸ‰ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº†
```

## ğŸš€ Lambda Container ãƒ‡ãƒ—ãƒ­ã‚¤

### 1. CDK ã‚¹ã‚¿ãƒƒã‚¯ç¢ºèª
```bash
npm run cdk:synth
```

### 2. Lambda Container ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
npm run cdk:deploy:container
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
```bash
# AWS CLIè¨­å®šç¢ºèª
aws configure list

# Parameter Store ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç¢ºèª
aws ssm describe-parameters --region ap-northeast-1

# IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ç¢ºèª
aws sts get-caller-identity
```

### Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
```bash
# Playwright ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npx playwright install chromium

# ä¾å­˜é–¢ä¿‚ç¢ºèª
npx playwright install-deps

# ãƒ–ãƒ©ã‚¦ã‚¶å ´æ‰€ç¢ºèª
where chromium  # Windows
which chromium  # Linux/Mac

# PlaywrightãŒãƒ–ãƒ©ã‚¦ã‚¶ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œãªã„å ´åˆã®è©³ç´°ç¢ºèª
npx playwright --help
```

### ã‚ˆãã‚ã‚‹Playwrightã‚¨ãƒ©ãƒ¼

1. **"Browser not found"ã‚¨ãƒ©ãƒ¼**:
```bash
# è§£æ±ºæ–¹æ³•
npx playwright install chromium
```

2. **"PLAYWRIGHT_BROWSERS_PATH"ãŒç„¡åŠ¹**:
```bash
# .env ãƒ•ã‚¡ã‚¤ãƒ«ã§ç©ºã«è¨­å®šã¾ãŸã¯å‰Šé™¤
PLAYWRIGHT_BROWSERS_PATH=
```

3. **æ¨©é™ã‚¨ãƒ©ãƒ¼ï¼ˆLinux/WSLï¼‰**:
```bash
# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
sudo npx playwright install-deps
```

## ğŸ“ ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«

ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™:
- `login-before.png`: ãƒ­ã‚°ã‚¤ãƒ³å‰ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
- `login-after.png`: ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„äº‹é …

1. **`.env` ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚³ãƒŸãƒƒãƒˆã—ãªã„**ï¼ˆ`.gitignore` ã§é™¤å¤–æ¸ˆã¿ï¼‰
2. **èªè¨¼æƒ…å ±ã‚’ã‚³ãƒ¼ãƒ‰ã«ç›´æ¥æ›¸ã‹ãªã„**
3. **Parameter Store ã¯ `SecureString` ã‚¿ã‚¤ãƒ—ã‚’ä½¿ç”¨**
4. **æœ¬ç•ªç’°å¢ƒã§ã¯ Parameter Store ã‚’ä½¿ç”¨**
5. **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã®ã¿ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨**
</file>

<file path="src/services/index.ts">
// Services module exports
// TODO: å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…å¾Œã€ã“ã“ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

export {};
</file>

<file path="src/utils/index.ts">
// Utility functions exports
// TODO: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’å®Ÿè£…å¾Œã€ã“ã“ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

export {};
</file>

<file path="docs/01_requirements.md">
# è¦ä»¶å®šç¾©æ›¸

## 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### 1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶è‡ªå‹•æ¤œç´¢ãƒ»è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ï¼ˆCrowdWorks Auto Job Searcherï¼‰

### 1.2 ç›®çš„ãƒ»èƒŒæ™¯
ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ä¸Šã§é©åˆ‡ãªæ¡ˆä»¶ã‚’åŠ¹ç‡çš„ã«ç™ºè¦‹ã—ã€æ¡ˆä»¶ã®å“è³ªã‚„ãƒãƒƒãƒãƒ³ã‚°åº¦ã‚’è‡ªå‹•è©•ä¾¡ã™ã‚‹ã“ã¨ã§ã€ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚µãƒ¼ã®æ¡ˆä»¶é¸å®šæ¥­å‹™ã‚’è‡ªå‹•åŒ–ãƒ»åŠ¹ç‡åŒ–ã™ã‚‹ã€‚

**èƒŒæ™¯**
- æ‰‹å‹•ã§ã®æ¡ˆä»¶ãƒã‚§ãƒƒã‚¯ã¯æ™‚é–“ãŒã‹ã‹ã‚‹
- è‰¯ã„æ¡ˆä»¶ã‚’è¦‹é€ƒã™ãƒªã‚¹ã‚¯ãŒã‚ã‚‹
- æ¡ˆä»¶ã®è©•ä¾¡ã«ä¸»è¦³ãŒå…¥ã‚Šã‚„ã™ã„
- å®šæœŸçš„ãªãƒã‚§ãƒƒã‚¯ãŒå›°é›£
- å€‹äººåˆ©ç”¨ã§ã®ã‚³ã‚¹ãƒˆåŠ¹ç‡æ€§ã‚’é‡è¦–

### 1.3 ã‚¹ã‚³ãƒ¼ãƒ—
**å¯¾è±¡ç¯„å›²**
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ä¸Šã®æ¡ˆä»¶æƒ…å ±ã®è‡ªå‹•å–å¾—
- AIï¼ˆChatGPTï¼‰ã«ã‚ˆã‚‹æ¡ˆä»¶è©•ä¾¡
- æ¤œç´¢æ¡ä»¶ã®ç®¡ç†ãƒ»ä¿å­˜
- å®šæœŸå®Ÿè¡Œã«ã‚ˆã‚‹ç¶™ç¶šç›£è¦–
- AWSã‚µãƒ¼ãƒãƒ¬ã‚¹ç’°å¢ƒã§ã®é‹ç”¨
- ç›´è¿‘1é€±é–“ã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆæ¡ˆä»¶ã®closeãŒæ—©ã„ãŸã‚ï¼‰

**å¯¾è±¡å¤–**
- ä»–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚½ãƒ¼ã‚·ãƒ³ã‚°ã‚µã‚¤ãƒˆ
- æ¡ˆä»¶ã¸ã®è‡ªå‹•å¿œå‹Ÿæ©Ÿèƒ½
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®ã‚„ã‚Šå–ã‚Šè‡ªå‹•åŒ–
- ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒã§ã®é‹ç”¨
- é•·æœŸé–“ã®ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ»ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ

## 2. æ©Ÿèƒ½è¦ä»¶

### 2.1 Mustï¼ˆå¿…é ˆæ©Ÿèƒ½ï¼‰
- **æ¤œç´¢æ¡ä»¶ç®¡ç†æ©Ÿèƒ½**
  - æ¤œç´¢æ¡ä»¶ã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ï¼ˆS3 JSONå½¢å¼ï¼‰
  - è¤‡æ•°ã®æ¤œç´¢æ¡ä»¶ã‚»ãƒƒãƒˆã®ç®¡ç†
- **è‡ªå‹•å–å¾—æ©Ÿèƒ½**
  - 15åˆ†é–“éš”ã§ã®è‡ªå‹•å®Ÿè¡Œï¼ˆEventBridgeï¼‰
  - AWSã‚µãƒ¼ãƒãƒ¬ã‚¹ç’°å¢ƒã§ã®å®‰å®šå‹•ä½œ
  - ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•æ“ä½œã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆPlaywright on Lambdaï¼‰
- **AIè©•ä¾¡æ©Ÿèƒ½ï¼ˆè»½é‡ç‰ˆï¼‰**
  - ChatGPT APIã‚’ä½¿ç”¨ã—ãŸæ¡ˆä»¶è©•ä¾¡ï¼ˆäº‹å‰ãƒ•ã‚£ãƒ«ã‚¿å¾Œï¼‰
  - ãŠã™ã™ã‚åº¦ã®ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆ1-10ç‚¹ï¼‰
  - è©•ä¾¡ç†ç”±ã®æ–‡ç« ç”Ÿæˆ
- **ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ©Ÿèƒ½**
  - å–å¾—ã—ãŸæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ï¼ˆS3 JSONå½¢å¼ï¼‰
  - è©•ä¾¡çµæœã®å±¥æ­´ä¿å­˜ï¼ˆ1é€±é–“ï¼‰
  - é‡è¤‡æ¡ˆä»¶ã®æ¤œå‡ºãƒ»é™¤å¤–ï¼ˆéå»24-48æ™‚é–“åˆ†ï¼‰

### 2.2 Shouldï¼ˆé‡è¦æ©Ÿèƒ½ï¼‰
- **é€šçŸ¥æ©Ÿèƒ½**
  - é«˜è©•ä¾¡æ¡ˆä»¶ã®å³åº§é€šçŸ¥ï¼ˆSNS/SESï¼‰
  - å®Ÿè¡Œã‚¨ãƒ©ãƒ¼æ™‚ã®é€šçŸ¥
- **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½**
  - äºˆç®—ç¯„å›²ã§ã®çµã‚Šè¾¼ã¿
  - ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆãƒãƒƒãƒãƒ³ã‚°
  - ç´æœŸæ¡ä»¶ã§ã®ãƒ•ã‚£ãƒ«ã‚¿
- **ãƒ­ã‚°ãƒ»ç›£è¦–æ©Ÿèƒ½**
  - å®Ÿè¡Œãƒ­ã‚°ã®è¨˜éŒ²ï¼ˆS3 JSONå½¢å¼ï¼‰
  - ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®é€šçŸ¥
  - æ—¥æ¬¡ã‚µãƒãƒªãƒ¼ç”Ÿæˆ

### 2.3 Couldï¼ˆã‚ã‚Œã°è‰¯ã„æ©Ÿèƒ½ï¼‰
- **ç°¡æ˜“ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½**
  - é€±æ¬¡ã®æ¡ˆä»¶å‹•å‘ã‚µãƒãƒªãƒ¼
  - é«˜è©•ä¾¡æ¡ˆä»¶ã®å‚¾å‘åˆ†æ
- **Webãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**
  - S3ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é™çš„ã‚µã‚¤ãƒˆï¼ˆVercelç­‰ï¼‰
  - è¨­å®šå¤‰æ›´ç”¨ã®ç°¡æ˜“UI

## 3. éæ©Ÿèƒ½è¦ä»¶

### 3.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶
- 15åˆ†é–“éš”ã§ã®å®Ÿè¡Œã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
- Lambdaé–¢æ•°ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: æœ€å¤§10åˆ†
- 1å›ã®å®Ÿè¡Œã§æœ€å¤§50ä»¶ã®æ¡ˆä»¶ã‚’å‡¦ç†
- å®Ÿè¡Œæ™‚é–“1åˆ†ä»¥å†…ã‚’ç›®æ¨™ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ã®ãŸã‚ï¼‰
- AIè©•ä¾¡ã¯é«˜ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«æ¡ˆä»¶ã®ã¿ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰

### 3.2 å¯ç”¨æ€§è¦ä»¶
- AWSã‚µãƒ¼ãƒãƒ¬ã‚¹ç’°å¢ƒã§ã®24æ™‚é–“365æ—¥ç¨¼åƒ
- ã‚·ã‚¹ãƒ†ãƒ éšœå®³æ™‚ã®è‡ªå‹•å¾©æ—§æ©Ÿèƒ½
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšœå®³æ™‚ã®ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ï¼ˆæœ€å¤§3å›ï¼‰
- ç¨¼åƒç‡: 95%ä»¥ä¸Šï¼ˆå€‹äººåˆ©ç”¨ãƒ¬ãƒ™ãƒ«ï¼‰

### 3.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶
- AWS Systems Manager Parameter Store ã§ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†
- IAMãƒ­ãƒ¼ãƒ«ã«ã‚ˆã‚‹æœ€å°æ¨©é™ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- S3ãƒã‚±ãƒƒãƒˆã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®š
- å–å¾—ãƒ‡ãƒ¼ã‚¿ã®ä¿è­·ï¼ˆS3æš—å·åŒ–ï¼‰
- ãƒ­ã‚°ã®æ©Ÿå¯†æƒ…å ±ãƒã‚¹ã‚­ãƒ³ã‚°

### 3.4 é‹ç”¨ãƒ»ä¿å®ˆæ€§è¦ä»¶
- S3ã§ã®æ§‹é€ åŒ–ãƒ­ã‚°ç®¡ç†
- AWS CDK ã§ã® Infrastructure as Code
- Lambdaé–¢æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
- ã‚¨ãƒ©ãƒ¼æ™‚ã®SNSé€šçŸ¥
- 7æ—¥é–“ã®è‡ªå‹•ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ï¼ˆS3 Lifecycle Policyï¼‰

### 3.5 ã‚³ã‚¹ãƒˆè¦ä»¶
- **æœˆé¡é‹ç”¨ã‚³ã‚¹ãƒˆ: $5ä»¥ä¸‹ã‚’å³å®ˆ**
- Lambdaå®Ÿè¡Œæ™‚é–“ã®æœ€é©åŒ–ï¼ˆ1åˆ†ä»¥å†…ï¼‰
- S3ä½¿ç”¨é‡ã®æœ€å°åŒ–
- CloudWatchä½¿ç”¨ã®å®Œå…¨å»ƒæ­¢
- ChatGPT APIä½¿ç”¨é‡ã®åˆ¶é™ï¼ˆäº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰

## 4. åˆ¶ç´„äº‹é …

### 4.1 æŠ€è¡“çš„åˆ¶ç´„
- AWS ã‚µãƒ¼ãƒãƒ¬ã‚¹ç’°å¢ƒã§ã®é–‹ç™ºãƒ»é‹ç”¨
- TypeScript ã§ã®å‹å®‰å…¨æ€§ç¢ºä¿ï¼ˆanyå‹ã®ä½¿ç”¨ç¦æ­¢ï¼‰
- Lambdaé–¢æ•°ã®å®Ÿè¡Œæ™‚é–“åˆ¶é™ï¼ˆæœ€å¤§10åˆ†ï¼‰
- Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¡ãƒ¢ãƒªåˆ¶é™
- S3ã§ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆNoSQLæ©Ÿèƒ½ãªã—ï¼‰
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®åˆ©ç”¨è¦ç´„éµå®ˆ

### 4.2 é‹ç”¨åˆ¶ç´„
- ChatGPT API ã®åˆ©ç”¨æ–™é‡‘åˆ¶é™ï¼ˆæœˆ$3ä»¥ä¸‹ï¼‰
- AWS ã‚µãƒ¼ãƒ“ã‚¹åˆ©ç”¨æ–™é‡‘åˆ¶é™ï¼ˆæœˆ$2ä»¥ä¸‹ï¼‰
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹é »åº¦åˆ¶é™
- 1æ—¥ã‚ãŸã‚Šã®æœ€å¤§å®Ÿè¡Œå›æ•°: 96å›ï¼ˆ15åˆ†Ã—4Ã—24æ™‚é–“ï¼‰
- LambdaåŒæ™‚å®Ÿè¡Œæ•°åˆ¶é™
- ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“: æœ€å¤§7æ—¥é–“

### 4.3 ãã®ä»–åˆ¶ç´„
- å€‹äººåˆ©ç”¨ç›®çš„ã«é™å®š
- å•†ç”¨åˆ©ç”¨ã¯åˆ¥é€”æ¤œè¨ãŒå¿…è¦
- ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¯¾è±¡ã‚µã‚¤ãƒˆã®ä»•æ§˜å¤‰æ›´ãƒªã‚¹ã‚¯
- AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åˆ©ç”¨å¯èƒ½ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†ææ©Ÿèƒ½ãªã—

## 5. å‰ææ¡ä»¶
- AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆæ¸ˆã¿
- é©åˆ‡ãªIAMæ¨©é™ãŒè¨­å®šæ¸ˆã¿
- ChatGPT API ã‚­ãƒ¼ãŒå–å¾—æ¸ˆã¿
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆæ¸ˆã¿
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå®‰å®šã—ã¦ã„ã‚‹
- AWS CLI/CDK ã®å®Ÿè¡Œç’°å¢ƒ
- æ¡ˆä»¶ã¯1é€±é–“ç¨‹åº¦ã§closeã™ã‚‹ãŸã‚çŸ­æœŸãƒ‡ãƒ¼ã‚¿ç®¡ç†ã§ååˆ†

## 6. ç”¨èªå®šç¾©
| ç”¨èª | å®šç¾© |
|------|------|
| æ¡ˆä»¶ | ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ä¸Šã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ä»•äº‹ã®ä¾é ¼ |
| æ¤œç´¢æ¡ä»¶ | æ¡ˆä»¶ã‚’çµã‚Šè¾¼ã‚€ãŸã‚ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š |
| è©•ä¾¡ã‚¹ã‚³ã‚¢ | AI ãŒç®—å‡ºã™ã‚‹æ¡ˆä»¶ã®ãŠã™ã™ã‚åº¦ï¼ˆ1-10ç‚¹ï¼‰ |
| å®Ÿè¡Œå±¥æ­´ | ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•å®Ÿè¡Œã—ãŸè¨˜éŒ² |
| ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° | ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•æ“ä½œã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿å–å¾— |
| ã‚µãƒ¼ãƒãƒ¬ã‚¹ | AWS Lambdaç­‰ã®ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ä¸è¦ãªã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚µãƒ¼ãƒ“ã‚¹ |
| EventBridge | AWSã®ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•å‹ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæ—§CloudWatch Eventsï¼‰ |
| äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ | AIè©•ä¾¡å‰ã®äºˆç®—ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç­‰ã«ã‚ˆã‚‹çµã‚Šè¾¼ã¿ |
| TTL | Time To Liveã€S3ã§ã®è‡ªå‹•å‰Šé™¤è¨­å®š |
</file>

<file path="docs/02_system_design.md">
# ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚             AWS Cloud                â”‚
                        â”‚                                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    EventBridge (15åˆ†é–“éš”)                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 Lambda Function (Main)                       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚  â”‚ Scheduler   â”‚  â”‚   Scraper    â”‚  â”‚   AI Evaluator   â”‚    â”‚
    â”‚  â”‚   Logic     â”‚â”€â–¶â”‚ (Playwright) â”‚â”€â–¶â”‚  (ChatGPT API)   â”‚    â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                       â”‚
                           â–¼                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                     S3 Bucket                â”‚               â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚               â”‚
    â”‚  â”‚ jobs/           â”‚  â”‚   logs/         â”‚   â”‚               â”‚
    â”‚  â”‚ (æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿)      â”‚  â”‚ (å®Ÿè¡Œãƒ­ã‚°)       â”‚   â”‚               â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚               â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚               â”‚
    â”‚  â”‚ evaluations/    â”‚  â”‚  config/        â”‚   â”‚               â”‚
    â”‚  â”‚ (è©•ä¾¡çµæœ)        â”‚  â”‚ (è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«)    â”‚   â”‚               â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
                           â”‚                                       â”‚
                           â–¼                                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                 æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆæœ€å°æ§‹æˆï¼‰
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  â”‚ Parameter Store â”‚  â”‚      SNS        â”‚
    â”‚  â”‚  (Secrets)      â”‚  â”‚ (Error Notify)  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ External Servicesâ”‚
                    â”‚ - CrowdWorks     â”‚
                    â”‚ - ChatGPT API    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ–¹é‡

- **ã‚³ã‚¹ãƒˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ**: æœˆ$5ä»¥ä¸‹ã®å³æ ¼ãªã‚³ã‚¹ãƒˆåˆ¶ç´„ã‚’æœ€å„ªå…ˆ
- **S3ä¸­å¿ƒè¨­è¨ˆ**: ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ»ãƒ­ã‚°ãƒ»è¨­å®šã‚’ã™ã¹ã¦S3ã§ç®¡ç†
- **ã‚·ãƒ³ãƒ—ãƒ«ãƒ»è»½é‡**: è¤‡é›‘ãªæ©Ÿèƒ½ã‚’æ’é™¤ã—ã€ã‚³ã‚¢æ©Ÿèƒ½ã«é›†ä¸­
- **äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**: AIè©•ä¾¡å‰ã®çµã‚Šè¾¼ã¿ã§ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **çŸ­æœŸãƒ‡ãƒ¼ã‚¿ç®¡ç†**: 7æ—¥é–“ã®TTLã§è‡ªå‹•å‰Šé™¤
- **å‹å®‰å…¨æ€§**: TypeScript strict ãƒ¢ãƒ¼ãƒ‰ã§å®Œå…¨ãªå‹å®šç¾©

### 1.3 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

**ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°**
- **AWS Lambda** (Node.js 18.x): ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œç’°å¢ƒ
- **EventBridge**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ï¼ˆ15åˆ†é–“éš”ï¼‰
- **AWS CDK** (TypeScript): Infrastructure as Code

**ãƒ‡ãƒ¼ã‚¿ãƒ»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**
- **S3**: å…¨ãƒ‡ãƒ¼ã‚¿ã®ä¸€å…ƒç®¡ç†ï¼ˆæ¡ˆä»¶ãƒ»ãƒ­ã‚°ãƒ»è¨­å®šãƒ»è©•ä¾¡çµæœï¼‰
- **S3 Lifecycle Policy**: 7æ—¥å¾Œè‡ªå‹•å‰Šé™¤
- **Parameter Store**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ã®ã¿

**è¨€èªãƒ»ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**
- **TypeScript** (v5ä»¥ä¸Š): å‹å®‰å…¨æ€§ç¢ºä¿ã€anyå‹ä½¿ç”¨ç¦æ­¢
- **Playwright**: ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–ï¼ˆLambda Layerï¼‰
- **AWS SDK v3**: AWS ã‚µãƒ¼ãƒ“ã‚¹é€£æº
- **OpenAI SDK**: ChatGPTé€£æºï¼ˆè»½é‡åˆ©ç”¨ï¼‰

**ç›£è¦–ãƒ»é‹ç”¨ï¼ˆæœ€å°æ§‹æˆï¼‰**
- **SNS**: ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã®ã¿
- **S3ãƒ™ãƒ¼ã‚¹ãƒ­ã‚°**: æ§‹é€ åŒ–JSONå½¢å¼

## 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 2.1 ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼

**è²¬å‹™**
- EventBridge ã‹ã‚‰ã®ãƒˆãƒªã‚¬ãƒ¼å—ä¿¡
- Lambdaé–¢æ•°ã®å®Ÿè¡Œåˆ¶å¾¡
- å®Ÿè¡Œæ™‚é–“ã®æœ€é©åŒ–ï¼ˆ1åˆ†ä»¥å†…ç›®æ¨™ï¼‰

**å®Ÿè£…æ–¹å¼**
```typescript
// EventBridge Rule
const scheduleRule = new events.Rule(this, 'ScheduleRule', {
  schedule: events.Schedule.rate(Duration.minutes(15)),
  targets: [new targets.LambdaFunction(mainFunction)]
});

interface SchedulerEvent {
  source: 'aws.events';
  'detail-type': 'Scheduled Event';
  detail: {};
}
```

### 2.2 ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼

**è²¬å‹™**
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã¸ã®è»½é‡ã‚¢ã‚¯ã‚»ã‚¹
- åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆæœ€å¤§50ä»¶/å›ï¼‰
- äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ

**è»½é‡åŒ–è¨­è¨ˆ**
```typescript
interface IScrapperService {
  authenticateUser(credentials: LoginCredentials): Promise<void>;
  searchJobsLight(condition: SearchCondition): Promise<JobData[]>;
  applyPreFilter(jobs: JobData[]): JobData[]; // AIè©•ä¾¡å‰ãƒ•ã‚£ãƒ«ã‚¿
  validateJobData(job: JobData): boolean;
}

// äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä¾‹
const applyPreFilter = (jobs: JobData[]): JobData[] => {
  return jobs.filter(job => 
    job.budget >= 50000 &&           // æœ€ä½äºˆç®—
    job.clientRating >= 4.0 &&       // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡
    hasTargetSkills(job.skills) &&   // ã‚¹ã‚­ãƒ«ãƒãƒƒãƒãƒ³ã‚°
    isReasonableDeadline(job.deadline) // ç´æœŸãƒã‚§ãƒƒã‚¯
  );
};
```

### 2.3 ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆS3ãƒ™ãƒ¼ã‚¹ï¼‰

**è²¬å‹™**
- S3ã§ã®æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ç®¡ç†
- JSONå½¢å¼ã§ã®ã‚·ãƒ³ãƒ—ãƒ«ãªèª­ã¿æ›¸ã
- TTLæ©Ÿèƒ½ã«ã‚ˆã‚‹è‡ªå‹•å‰Šé™¤

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ è¨­è¨ˆ**
```typescript
// S3 Bucketæ§‹é€ 
interface S3Structure {
  'jobs/': {
    pattern: 'YYYY-MM-DDTHH-mm.json';
    example: '2024-01-15T14-30.json';
    ttl: '7 days';
  };
  'evaluations/': {
    pattern: 'YYYY-MM-DDTHH-mm.json';
    example: '2024-01-15T14-30.json';
    ttl: '7 days';
  };
  'logs/': {
    execution: 'YYYY-MM-DDTHH-mm-execution.json';
    error: 'YYYY-MM-DDTHH-mm-error.json';
    daily: 'daily-summary/YYYY-MM-DD.json';
    ttl: '7 days';
  };
  'config/': {
    searchConditions: 'search-conditions.json';
    system: 'system-config.json';
    ttl: 'none';
  };
}

// ãƒ‡ãƒ¼ã‚¿æ“ä½œã‚µãƒ¼ãƒ“ã‚¹
class S3DataService {
  async saveJobs(jobs: JobData[]): Promise<void> {
    const timestamp = new Date().toISOString().slice(0, 16);
    await this.s3.putObject({
      Bucket: this.bucketName,
      Key: `jobs/${timestamp}.json`,
      Body: JSON.stringify(jobs, null, 2),
      ServerSideEncryption: 'AES256'
    }).promise();
  }

  async getRecentJobs(hours: number = 24): Promise<JobData[]> {
    const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
    const objects = await this.listObjectsSince('jobs/', cutoff);
    
    const allJobs: JobData[] = [];
    for (const obj of objects) {
      const data = await this.getObject(obj.Key);
      allJobs.push(...JSON.parse(data));
    }
    return allJobs;
  }

  async getExistingJobIds(hours: number = 48): Promise<Set<string>> {
    const recentJobs = await this.getRecentJobs(hours);
    return new Set(recentJobs.map(job => job.id));
  }
}
```

### 2.4 AIè©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆè»½é‡ç‰ˆï¼‰

**è²¬å‹™**
- äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿æ¡ˆä»¶ã®ã¿è©•ä¾¡
- ãƒãƒƒãƒå‡¦ç†ã§ã®åŠ¹ç‡åŒ–
- ã‚³ã‚¹ãƒˆç›£è¦–æ©Ÿèƒ½

**è»½é‡å®Ÿè£…**
```typescript
class LightAIEvaluatorService {
  private monthlyUsage: number = 0;
  private readonly MONTHLY_LIMIT = 3; // $3/æœˆåˆ¶é™

  async evaluateFilteredJobs(jobs: JobData[]): Promise<JobEvaluation[]> {
    // ã‚³ã‚¹ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    if (this.monthlyUsage >= this.MONTHLY_LIMIT) {
      throw new Error('Monthly AI budget exceeded');
    }

    // æœ€é‡è¦æ¡ˆä»¶ã®ã¿è©•ä¾¡ï¼ˆã•ã‚‰ãªã‚‹çµã‚Šè¾¼ã¿ï¼‰
    const priorityJobs = this.selectPriorityJobs(jobs);
    
    const evaluations: JobEvaluation[] = [];
    for (const job of priorityJobs) {
      try {
        const evaluation = await this.evaluateJob(job);
        evaluations.push(evaluation);
        
        // ä½¿ç”¨é‡è¿½è·¡
        this.monthlyUsage += this.estimateTokenCost(job);
        
      } catch (error) {
        // AIè©•ä¾¡å¤±æ•—æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ã‚¢
        evaluations.push(this.createDefaultEvaluation(job));
      }
    }
    
    return evaluations;
  }

  private selectPriorityJobs(jobs: JobData[]): JobData[] {
    return jobs
      .sort((a, b) => b.budget - a.budget) // é«˜äºˆç®—é †
      .slice(0, 10); // ä¸Šä½10ä»¶ã®ã¿
  }

  private estimateTokenCost(job: JobData): number {
    const tokenCount = (job.title.length + job.description.length) / 4;
    return tokenCount * 0.002 / 1000; // GPT-3.5-turboä¾¡æ ¼
  }
}
```

### 2.5 è¨­å®šç®¡ç†ï¼ˆS3ãƒ™ãƒ¼ã‚¹ï¼‰

**è²¬å‹™**
- S3ã§ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
- Parameter Store ã§ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†
- è»½é‡ãªè¨­å®šèª­ã¿è¾¼ã¿

**è¨­å®šæ§‹é€ **
```typescript
// config/system-config.json
interface SystemConfig {
  scraping: {
    maxJobsPerExecution: 50;
    preFilterEnabled: true;
    minBudget: 50000;
    minClientRating: 4.0;
  };
  ai: {
    enabled: true;
    model: 'gpt-3.5-turbo';
    maxJobsForEvaluation: 10;
    monthlyBudgetLimit: 3.0;
  };
  notification: {
    enabled: true;
    scoreThreshold: 7;
    errorNotificationEnabled: true;
  };
  storage: {
    retentionDays: 7;
    compressionEnabled: false;
  };
}

// config/search-conditions.json
interface SearchConditions {
  conditions: Array<{
    id: string;
    name: string;
    keywords: string[];
    budgetMin: number;
    budgetMax: number;
    category: string;
    workType: 'fixed' | 'hourly';
    enabled: boolean;
  }>;
}
```

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 3.1 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
EventBridge â”€â”€15åˆ†â”€â”€â–¶ Lambda Function (Main Handler)
                            â”‚
                            â–¼
                    Parameter Store â”€â”€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå–å¾—â”€â”€â–¶ Scraper Service
                            â”‚                              â”‚
                            â–¼                              â–¼
                    S3 Config â—€â”€â”€è¨­å®šèª­ã¿è¾¼ã¿â”€â”€â”€â”€â”€â”€â”€â”€ CrowdWorks Site
                    (search-conditions.json)           â”‚
                            â”‚                          â–¼
                            â–¼                     æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å–å¾—
                    S3 Jobs â—€â”€â”€é‡è¤‡ãƒã‚§ãƒƒã‚¯â”€â”€â”€â”€â”€â”€ Pre-Filter
                    (éå»48æ™‚é–“åˆ†)                    â”‚
                            â”‚                          â–¼
                            â–¼                     æ–°è¦æ¡ˆä»¶
                    S3 Jobs â—€â”€â”€â”€â”€æ–°è¦æ¡ˆä»¶ä¿å­˜â”€â”€â”€â”€ Light AI Evaluator
                    (timestamp.json)                  â”‚
                            â”‚                          â–¼
                            â–¼                     è©•ä¾¡çµæœ
                    S3 Evaluations â—€â”€â”€è©•ä¾¡ä¿å­˜â”€â”€â”€ High Score Filter
                    (timestamp.json)                  â”‚
                            â”‚                          â–¼
                            â–¼                     é€šçŸ¥åˆ¤å®š
                    S3 Logs â—€â”€â”€â”€â”€å®Ÿè¡Œãƒ­ã‚°â”€â”€â”€â”€â”€â”€ SNS Notification
                    (execution.json)              (ã‚¨ãƒ©ãƒ¼ãƒ»é«˜è©•ä¾¡)
```

### 3.2 å‡¦ç†ãƒ•ãƒ­ãƒ¼

**æœ€é©åŒ–ã•ã‚ŒãŸãƒ¡ã‚¤ãƒ³å‡¦ç†ãƒ•ãƒ­ãƒ¼**
```typescript
export const handler = async (event: SchedulerEvent): Promise<void> => {
  const executionId = Date.now().toString();
  const startTime = Date.now();
  const timestamp = new Date().toISOString().slice(0, 16);
  
  const log: ExecutionLog = {
    executionId,
    timestamp,
    status: 'success',
    duration: 0,
    jobsScraped: 0,
    newJobs: 0,
    aiEvaluated: 0,
    highScoreJobs: 0,
    costEstimate: 0
  };

  try {
    // 1. è¨­å®šã¨ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå–å¾—ï¼ˆä¸¦åˆ—ï¼‰
    const [config, credentials] = await Promise.all([
      s3DataService.getSystemConfig(),
      parameterService.getCredentials()
    ]);

    // 2. é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ãƒ‡ãƒ¼ã‚¿å–å¾—
    const existingJobIds = await s3DataService.getExistingJobIds(48);

    // 3. ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
    const scraper = new ScraperService(credentials);
    const allJobs = await scraper.searchJobsLight(config.searchConditions);
    log.jobsScraped = allJobs.length;

    // 4. é‡è¤‡æ’é™¤
    const newJobs = allJobs.filter(job => !existingJobIds.has(job.id));
    log.newJobs = newJobs.length;

    if (newJobs.length === 0) {
      log.duration = Date.now() - startTime;
      await s3DataService.saveExecutionLog(log, timestamp);
      return; // æ–°è¦æ¡ˆä»¶ãªã—ã§çµ‚äº†
    }

    // 5. æ–°è¦æ¡ˆä»¶ä¿å­˜
    await s3DataService.saveJobs(newJobs, timestamp);

    // 6. äº‹å‰ãƒ•ã‚£ãƒ«ã‚¿å®Ÿè¡Œ
    const filteredJobs = scraper.applyPreFilter(newJobs);

    // 7. AIè©•ä¾¡ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¾Œã®å„ªå…ˆæ¡ˆä»¶ã®ã¿ï¼‰
    let evaluations: JobEvaluation[] = [];
    if (config.ai.enabled && filteredJobs.length > 0) {
      const aiEvaluator = new LightAIEvaluatorService();
      evaluations = await aiEvaluator.evaluateFilteredJobs(filteredJobs);
      log.aiEvaluated = evaluations.length;
      log.costEstimate = aiEvaluator.getSessionCost();

      // 8. è©•ä¾¡çµæœä¿å­˜
      await s3DataService.saveEvaluations(evaluations, timestamp);
    }

    // 9. é«˜è©•ä¾¡æ¡ˆä»¶é€šçŸ¥
    const highScoreJobs = evaluations.filter(e => e.score >= config.notification.scoreThreshold);
    log.highScoreJobs = highScoreJobs.length;

    if (highScoreJobs.length > 0) {
      await notificationService.sendHighScoreAlert(highScoreJobs);
    }

    // 10. å®Ÿè¡Œãƒ­ã‚°ä¿å­˜
    log.duration = Date.now() - startTime;
    await s3DataService.saveExecutionLog(log, timestamp);

  } catch (error) {
    log.status = 'error';
    log.error = {
      type: error.constructor.name,
      message: error.message,
      stack: error.stack
    };
    log.duration = Date.now() - startTime;

    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ä¿å­˜
    await s3DataService.saveErrorLog(log, timestamp);

    // é‡è¦ã‚¨ãƒ©ãƒ¼ã®é€šçŸ¥
    if (shouldNotifyError(error)) {
      await notificationService.sendErrorAlert(error, executionId);
    }

    throw error; // Lambdaå¤±æ•—ã¨ã—ã¦è¨˜éŒ²
  }
};
```

## 4. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¨­è¨ˆ

### 4.1 å¤–éƒ¨APIé€£æº

**ChatGPT APIï¼ˆè»½é‡ç‰ˆï¼‰**
```typescript
interface LightChatGPTRequest {
  model: 'gpt-3.5-turbo'; // GPT-4ã¯ä½¿ç”¨ã—ãªã„ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰
  messages: ChatCompletionMessage[];
  max_tokens: 200; // çŸ­ç¸®
  temperature: 0.3; // ä¸€è²«æ€§é‡è¦–
  response_format: { type: 'json_object' };
}

const LIGHT_EVALUATION_PROMPT = `
æ¡ˆä»¶ã‚’ç°¡æ½”ã«è©•ä¾¡ã—ã¦ãã ã•ã„ï¼ˆäºˆç®—:{budget}å††ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡:{clientRating}ï¼‰ï¼š

{title}

ã‚¹ã‚­ãƒ«: {skills}
è©³ç´°: {description}

JSONå½¢å¼ã§å›ç­”:
{"score": 1-10, "reason": "50æ–‡å­—ä»¥å†…"}
`;
```

### 4.2 å†…éƒ¨ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

**è»½é‡åŒ–ãƒ‡ãƒ¼ã‚¿å‹**
```typescript
interface JobData {
  id: string;
  title: string;
  description: string; // 500æ–‡å­—ã¾ã§
  budget: number;
  deadline: Date;
  clientRating: number;
  skills: string[]; // æœ€å¤§5å€‹
  url: string;
  scrapedAt: Date;
}

interface JobEvaluation {
  jobId: string;
  score: number; // 1-10
  reason: string; // 50æ–‡å­—ä»¥å†…
  evaluatedAt: Date;
  tokenUsed: number; // ã‚³ã‚¹ãƒˆè¿½è·¡
}

interface ExecutionLog {
  executionId: string;
  timestamp: string;
  status: 'success' | 'error' | 'partial';
  duration: number;
  jobsScraped: number;
  newJobs: number;
  aiEvaluated: number;
  highScoreJobs: number;
  costEstimate: number;
  error?: {
    type: string;
    message: string;
    stack?: string;
  };
}
```

## 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 5.1 èªè¨¼ãƒ»èªå¯ï¼ˆæœ€å°æ¨©é™ï¼‰

**IAM ãƒ­ãƒ¼ãƒ«è¨­è¨ˆ**
```typescript
const lambdaRole = new iam.Role(this, 'LambdaExecutionRole', {
  assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com'),
  managedPolicies: [
    iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole')
  ],
  inlinePolicies: {
    S3Access: new iam.PolicyDocument({
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: [
            's3:GetObject',
            's3:PutObject',
            's3:ListBucket'
          ],
          resources: [
            s3Bucket.bucketArn,
            `${s3Bucket.bucketArn}/*`
          ]
        })
      ]
    }),
    ParameterStoreAccess: new iam.PolicyDocument({
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: ['ssm:GetParameter'],
          resources: [`arn:aws:ssm:${region}:${account}:parameter/crowdworks-searcher/secrets`]
        })
      ]
    }),
    SNSAccess: new iam.PolicyDocument({
      statements: [
        new iam.PolicyStatement({
          effect: iam.Effect.ALLOW,
          actions: ['sns:Publish'],
          resources: [errorTopic.topicArn]
        })
      ]
    })
  }
});
```

### 5.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·

**S3ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š**
```typescript
const s3Bucket = new s3.Bucket(this, 'CrowdWorksSearcherBucket', {
  encryption: s3.BucketEncryption.S3_MANAGED,
  blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
  lifecycleRules: [
    {
      id: 'DeleteOldData',
      enabled: true,
      expiration: Duration.days(7), // 7æ—¥å¾Œè‡ªå‹•å‰Šé™¤
      abortIncompleteMultipartUploadAfter: Duration.days(1)
    }
  ],
  versioning: false, // ã‚³ã‚¹ãƒˆå‰Šæ¸›
  removalPolicy: RemovalPolicy.DESTROY
});
```

## 6. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### 6.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡ï¼ˆç°¡ç´ åŒ–ï¼‰

```typescript
export enum ErrorType {
  // é‡è¦ã‚¨ãƒ©ãƒ¼ï¼ˆé€šçŸ¥å¿…è¦ï¼‰
  AUTHENTICATION_ERROR = 'AUTH_ERROR',
  LAMBDA_TIMEOUT = 'LAMBDA_TIMEOUT',
  S3_ACCESS_ERROR = 'S3_ACCESS_ERROR',
  
  // è»½å¾®ã‚¨ãƒ©ãƒ¼ï¼ˆãƒ­ã‚°ã®ã¿ï¼‰
  SCRAPING_ERROR = 'SCRAPING_ERROR',
  AI_API_ERROR = 'AI_API_ERROR',
  NETWORK_ERROR = 'NETWORK_ERROR'
}

export class LightAppError extends Error {
  constructor(
    public type: ErrorType,
    message: string,
    public retryable: boolean = false
  ) {
    super(message);
  }
}
```

### 6.2 ã‚¨ãƒ©ãƒ¼å‡¦ç†æ–¹é‡

**è»½é‡ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
```typescript
class LightRetryHandler {
  async executeWithRetry<T>(
    operation: () => Promise<T>,
    maxRetries: number = 2 // å‰Šæ¸›
  ): Promise<T> {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        return await operation();
      } catch (error) {
        if (attempt === maxRetries) throw error;
        await this.sleep(1000 * attempt); // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒã‚¯ã‚ªãƒ•
      }
    }
    throw new Error('Max retries exceeded');
  }
}

const shouldNotifyError = (error: Error): boolean => {
  const criticalErrors = [
    'AUTHENTICATION_ERROR',
    'LAMBDA_TIMEOUT', 
    'S3_ACCESS_ERROR'
  ];
  return criticalErrors.includes(error.constructor.name);
};
```

## 7. ãƒ­ã‚°è¨­è¨ˆï¼ˆS3ãƒ™ãƒ¼ã‚¹ï¼‰

### 7.1 S3ãƒ­ã‚°æ§‹é€ 

```typescript
interface S3LogStructure {
  'logs/execution/': {
    pattern: 'YYYY-MM-DDTHH-mm-execution.json';
    content: ExecutionLog;
    retention: '7 days';
  };
  'logs/error/': {
    pattern: 'YYYY-MM-DDTHH-mm-error.json';
    content: ExecutionLog; // status = 'error'
    retention: '7 days';
  };
  'logs/daily-summary/': {
    pattern: 'YYYY-MM-DD.json';
    content: DailySummary;
    retention: '7 days';
  };
}

interface DailySummary {
  date: string;
  totalExecutions: number;
  successfulExecutions: number;
  totalJobsFound: number;
  totalNewJobs: number;
  averageScore: number;
  highScoreJobs: number;
  totalAICost: number;
  errors: string[];
}
```

### 7.2 ãƒ­ã‚°å®Ÿè£…

**è»½é‡ãƒ­ã‚°ã‚µãƒ¼ãƒ“ã‚¹**
```typescript
class S3LogService {
  async saveExecutionLog(log: ExecutionLog, timestamp: string): Promise<void> {
    await this.s3.putObject({
      Bucket: this.bucketName,
      Key: `logs/execution/${timestamp}-execution.json`,
      Body: JSON.stringify(log, null, 2),
      ContentType: 'application/json'
    }).promise();
  }

  async saveErrorLog(log: ExecutionLog, timestamp: string): Promise<void> {
    await this.s3.putObject({
      Bucket: this.bucketName,
      Key: `logs/error/${timestamp}-error.json`,
      Body: JSON.stringify(log, null, 2),
      ContentType: 'application/json'
    }).promise();
  }

  async generateDailySummary(date: string): Promise<DailySummary> {
    const dayLogs = await this.getLogsForDate(date);
    
    return {
      date,
      totalExecutions: dayLogs.length,
      successfulExecutions: dayLogs.filter(l => l.status === 'success').length,
      totalJobsFound: dayLogs.reduce((sum, l) => sum + l.jobsScraped, 0),
      totalNewJobs: dayLogs.reduce((sum, l) => sum + l.newJobs, 0),
      averageScore: this.calculateAverageScore(dayLogs),
      highScoreJobs: dayLogs.reduce((sum, l) => sum + l.highScoreJobs, 0),
      totalAICost: dayLogs.reduce((sum, l) => sum + l.costEstimate, 0),
      errors: dayLogs.filter(l => l.error).map(l => l.error!.message)
    };
  }
}
```

## 8. ã‚³ã‚¹ãƒˆæœ€é©åŒ–æˆ¦ç•¥

### 8.1 ã‚³ã‚¹ãƒˆç›£è¦–

```typescript
interface CostMonitor {
  trackLambdaExecution(duration: number, memoryMB: number): void;
  trackS3Operations(operations: S3Operation[]): void;
  trackAIUsage(tokens: number, model: string): void;
  generateMonthlyCostReport(): MonthlyCostReport;
}

interface MonthlyCostReport {
  lambda: { executions: number; cost: number };
  s3: { operations: number; storage: number; cost: number };
  ai: { tokens: number; cost: number };
  other: { sns: number; parameterStore: number };
  total: number;
  budgetRemaining: number;
}
```

### 8.2 è‡ªå‹•ã‚³ã‚¹ãƒˆåˆ¶å¾¡

```typescript
class CostController {
  private monthlyBudget = 5.0; // $5åˆ¶é™

  async checkBudgetBeforeExecution(): Promise<boolean> {
    const currentCost = await this.getCurrentMonthlyCost();
    return currentCost < this.monthlyBudget * 0.9; // 90%ã§åˆ¶é™
  }

  async suspendExpensiveFeatures(): Promise<void> {
    // AIè©•ä¾¡ã‚’ä¸€æ™‚åœæ­¢
    await this.updateConfig({ ai: { enabled: false } });
    
    // é€šçŸ¥é€ä¿¡
    await this.notifyBudgetExceeded();
  }
}
```

**ã“ã‚Œã§æœˆ$5ä»¥ä¸‹ã§ã®é‹ç”¨ãŒå¯èƒ½ãªè¨­è¨ˆã«ãªã‚Šã¾ã—ãŸï¼**
</file>

<file path="docs/CI_CD_SETUP.md">
# CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€GitHub Actionsã‚’ä½¿ç”¨ã—ãŸåŒ…æ‹¬çš„ãªCI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚**Playwright Lambdaåˆ¶ç´„ã«å¯¾å¿œã—ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚µãƒãƒ¼ãƒˆ**ã—ã¦ã„ã¾ã™ã€‚

## **âš ï¸ é‡è¦: Playwright Lambdaå¯¾å¿œ**

### **æŠ€è¡“çš„åˆ¶ç´„ã¨è§£æ±ºç­–**
```yaml
Lambdaåˆ¶é™:
  ZIPå½¢å¼: 250MB (Playwright: ~300MB) âŒ
  Container: 10GB âœ… æ¡ç”¨

å¯¾å¿œæ–¹é‡:
  ãƒ‡ãƒ—ãƒ­ã‚¤å½¢å¼: Docker Container Image
  ãƒ¬ã‚¸ã‚¹ãƒˆãƒª: Amazon ECR
  ãƒ“ãƒ«ãƒ‰ç’°å¢ƒ: GitHub Actions + Docker
```

## ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æˆ

### ã‚¸ãƒ§ãƒ–ãƒ•ãƒ­ãƒ¼
```
ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
â”œâ”€â”€ å˜ä½“ãƒ†ã‚¹ãƒˆ (ä¸¦è¡Œ)
â”œâ”€â”€ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ (ä¸¦è¡Œ)  
â””â”€â”€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ (ä¸¦è¡Œ)
    â””â”€â”€ CDKæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        â””â”€â”€ Dockerãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
            â”œâ”€â”€ Staging ãƒ‡ãƒ—ãƒ­ã‚¤ (develop)
            â””â”€â”€ Production ãƒ‡ãƒ—ãƒ­ã‚¤ (main)
```

### 1. ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆCode Quality Checkï¼‰
- **å®Ÿè¡Œæ¡ä»¶**: å…¨ãƒ–ãƒ©ãƒ³ãƒãƒ»å…¨PRã§å®Ÿè¡Œ
- **å‡¦ç†å†…å®¹**:
  - ESLintï¼ˆã‚³ãƒ¼ãƒ‰å“è³ªï¼‰
  - Prettierï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
  - TypeScriptå‹ãƒã‚§ãƒƒã‚¯
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10åˆ†

### 2. å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆUnit Testsï¼‰
- **å®Ÿè¡Œæ¡ä»¶**: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å¾Œ
- **å‡¦ç†å†…å®¹**:
  - Jestå˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  - ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  - Codecovã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 15åˆ†

### 3. ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆBuild Testï¼‰
- **å®Ÿè¡Œæ¡ä»¶**: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å¾Œï¼ˆä¸¦è¡Œå®Ÿè¡Œï¼‰
- **å‡¦ç†å†…å®¹**:
  - TypeScriptã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
  - ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®æ¤œè¨¼
  - ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10åˆ†

### 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆSecurity Scanï¼‰
- **å®Ÿè¡Œæ¡ä»¶**: pushã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã®ã¿
- **å‡¦ç†å†…å®¹**:
  - npm auditå®Ÿè¡Œ
  - CodeQLåˆ†æï¼ˆSASTï¼‰
  - ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 15åˆ†

### 5. CDKæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆCDK Synth Checkï¼‰
- **å®Ÿè¡Œæ¡ä»¶**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸå¾Œ
- **å‡¦ç†å†…å®¹**:
  - CDK synthesizeå®Ÿè¡Œ
  - CloudFormationãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”Ÿæˆ
  - æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10åˆ†

### 6. **Dockerãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆContainer Build Testï¼‰**
- **å®Ÿè¡Œæ¡ä»¶**: CDKæ§‹æ–‡ãƒã‚§ãƒƒã‚¯æˆåŠŸå¾Œ
- **å‡¦ç†å†…å®¹**:
  - **Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆLambda Containerç”¨ï¼‰**
  - **Multi-stage buildãƒ†ã‚¹ãƒˆ**
  - **Playwrightç’°å¢ƒç¢ºèª**
  - **ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œãƒ†ã‚¹ãƒˆ**
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 20åˆ†

### 7. **ãƒ‡ãƒ—ãƒ­ã‚¤æ®µéšï¼ˆDeploymentï¼‰**

#### **Staging ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆdevelopãƒ–ãƒ©ãƒ³ãƒï¼‰**
```yaml
ç’°å¢ƒ: staging
ãƒˆãƒªã‚¬ãƒ¼: develop branch push
ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼: Container Image
å‡¦ç†:
  - ECRãƒ­ã‚°ã‚¤ãƒ³
  - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  - ECRãƒ—ãƒƒã‚·ãƒ¥
  - Lambdaé–¢æ•°æ›´æ–°
```

#### **Production ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒï¼‰**
```yaml
ç’°å¢ƒ: production
ãƒˆãƒªã‚¬ãƒ¼: main branch push
ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼: Container Image
æ‰¿èª: æ‰‹å‹•æ‰¿èªå¿…é ˆ
å‡¦ç†:
  - ECRãƒ­ã‚°ã‚¤ãƒ³
  - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ï¼ˆæœ¬ç•ªç”¨ï¼‰
  - ECRãƒ—ãƒƒã‚·ãƒ¥
  - Lambdaé–¢æ•°æ›´æ–°
  - ç›£è¦–ã‚¢ãƒ©ãƒ¼ãƒˆç¢ºèª
```

## GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š

### **å¿…é ˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š**

CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’å‹•ä½œã•ã›ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š

#### **1. AWSèªè¨¼æƒ…å ±**
```bash
# Stagingç’°å¢ƒç”¨
STAGING_AWS_ACCESS_KEY_ID=AKI...
STAGING_AWS_SECRET_ACCESS_KEY=xxx...
STAGING_AWS_REGION=ap-northeast-1

# Productionç’°å¢ƒç”¨  
PRODUCTION_AWS_ACCESS_KEY_ID=AKI...
PRODUCTION_AWS_SECRET_ACCESS_KEY=xxx...
PRODUCTION_AWS_REGION=ap-northeast-1
```

#### **2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š**
```bash
# OpenAI API
STAGING_OPENAI_API_KEY=sk-...
PRODUCTION_OPENAI_API_KEY=sk-...

# CrowdWorksèªè¨¼æƒ…å ±
STAGING_CROWDWORKS_EMAIL=your-email@example.com
STAGING_CROWDWORKS_PASSWORD=your-password
PRODUCTION_CROWDWORKS_EMAIL=your-email@example.com
PRODUCTION_CROWDWORKS_PASSWORD=your-password

# é€šçŸ¥è¨­å®š
STAGING_NOTIFICATION_EMAIL=alerts-staging@example.com
PRODUCTION_NOTIFICATION_EMAIL=alerts@example.com
```

#### **3. ãã®ä»–**
```bash
# Codecov (optional)
CODECOV_TOKEN=xxx...

# Slacké€šçŸ¥ (optional)
SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...
```

### **ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®šæ‰‹é †**

1. **GitHubãƒªãƒã‚¸ãƒˆãƒªã®Settings** â†’ **Secrets and variables** â†’ **Actions**
2. **New repository secret** ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ä¸Šè¨˜ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆåã¨å€¤ã‚’è¨­å®š

## **ğŸ³ Dockerãƒ“ãƒ«ãƒ‰è¨­å®š**

### **Dockerfileæœ€é©åŒ–ï¼ˆLambda Containerç”¨ï¼‰**
```dockerfile
# Multi-stage buildã§ã‚µã‚¤ã‚ºæœ€é©åŒ–
FROM node:18-alpine as base
# Playwrightç’°å¢ƒ
FROM mcr.microsoft.com/playwright/python:v1.45.0-jammy as runtime

# Lambda Runtime Interface Client
COPY --from=base /workspace /function
WORKDIR /function

# ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆè¨­å®šï¼ˆLambdaç”¨ï¼‰
ENTRYPOINT [ "npx", "aws-lambda-ric" ]
CMD [ "dist/lambda/handler.lambdaHandler" ]
```

### **ãƒ“ãƒ«ãƒ‰æˆ¦ç•¥**
```yaml
strategy:
  matrix:
    architecture: [amd64]  # Lambda = x86_64ã®ã¿
  build-args:
    - NODE_ENV=production
    - BUILD_TARGET=lambda
  cache-from:
    - type=gha  # GitHub Actions Cache
  cache-to:
    - type=gha,mode=max
```

## **ğŸ“Š CI/CDãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**

### **ä¸¦è¡Œå®Ÿè¡Œæœ€é©åŒ–**
```yaml
Jobå®Ÿè¡Œæ™‚é–“:
  Code Quality: ~2åˆ†
  Unit Tests: ~3åˆ†  
  Build Test: ~2åˆ†
  Security Scan: ~5åˆ†
  CDK Synth: ~1åˆ†
  Docker Build: ~8åˆ†
  Total: ~12åˆ†ï¼ˆä¸¦è¡Œå®Ÿè¡Œï¼‰
```

### **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**
```yaml
node_modules: 
  key: v1-deps-{{ hashFiles('package-lock.json') }}
Docker layers:
  cache-from: type=gha
  cache-to: type=gha,mode=max
AWS CDK:
  cache: ~/.cdk
```

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæ¡ä»¶

### **è‡ªå‹•å®Ÿè¡Œ**
- **Push to main**: ãƒ•ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ + Production ãƒ‡ãƒ—ãƒ­ã‚¤
- **Push to develop**: ãƒ•ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ + Staging ãƒ‡ãƒ—ãƒ­ã‚¤  
- **Pull Request**: ã‚³ãƒ¼ãƒ‰å“è³ª + ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ãªã—ï¼‰

### **æ‰‹å‹•å®Ÿè¡Œ**
- **workflow_dispatch**: ä»»æ„ãƒ–ãƒ©ãƒ³ãƒã§ã®æ‰‹å‹•å®Ÿè¡Œ
- **å¼•æ•°æŒ‡å®šå¯èƒ½**: ç’°å¢ƒé¸æŠã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚­ãƒƒãƒ—ãªã©

## å“è³ªã‚²ãƒ¼ãƒˆ

### **è‡ªå‹•å“è³ªãƒã‚§ãƒƒã‚¯**
```yaml
å¿…é ˆãƒã‚§ãƒƒã‚¯:
  - ESLint: Error 0ä»¶
  - TypeScript: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ 0ä»¶
  - Unit Tests: 80%ä»¥ä¸Šã®ã‚«ãƒãƒ¬ãƒƒã‚¸
  - Security: é«˜ãƒ»ä¸­è„†å¼±æ€§ 0ä»¶
  - CDK Synth: æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ 0ä»¶
  - Docker Build: ãƒ“ãƒ«ãƒ‰æˆåŠŸ
```

### **ãƒ‡ãƒ—ãƒ­ã‚¤å‰ãƒã‚§ãƒƒã‚¯**
```yaml
Staging ãƒ‡ãƒ—ãƒ­ã‚¤å‰:
  - å…¨å“è³ªã‚²ãƒ¼ãƒˆé€šé
  - develop ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ãƒ—ãƒƒã‚·ãƒ¥

Production ãƒ‡ãƒ—ãƒ­ã‚¤å‰:
  - å…¨å“è³ªã‚²ãƒ¼ãƒˆé€šé  
  - main ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®ãƒ—ãƒƒã‚·ãƒ¥
  - æ‰‹å‹•æ‰¿èªï¼ˆGitHub Environment Protectionï¼‰
```

## **ğŸ” ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ**

### **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç›£è¦–**
```yaml
æˆåŠŸç‡ç›£è¦–:
  target: 95%ä»¥ä¸Š
  alert: Slacké€šçŸ¥

å®Ÿè¡Œæ™‚é–“ç›£è¦–:
  target: 15åˆ†ä»¥å†…
  alert: 20åˆ†è¶…éã§ã‚¢ãƒ©ãƒ¼ãƒˆ

ãƒ‡ãƒ—ãƒ­ã‚¤é »åº¦:
  staging: æ—¥æ¬¡
  production: é€±æ¬¡
```

### **ã‚³ã‚¹ãƒˆç›£è¦–**
```yaml
GitHub Actionsä½¿ç”¨é‡:
  ç„¡æ–™æ : 2,000åˆ†/æœˆ
  ç¾åœ¨ä½¿ç”¨é‡: ~500åˆ†/æœˆ
  ã‚¢ãƒ©ãƒ¼ãƒˆé–¾å€¤: 1,800åˆ†/æœˆ
```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### **ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–**

#### **1. Docker Buildå¤±æ•—**
```bash
# åŸå› : Dockerfileæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã€ä¾å­˜é–¢ä¿‚å•é¡Œ
# è§£æ±º: ãƒ­ãƒ¼ã‚«ãƒ«ã§Dockerãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
docker build -t test-image .
docker run --rm test-image npm test
```

#### **2. CDK Synthå¤±æ•—**
```bash
# åŸå› : CDKæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã€å‹å®šç¾©å•é¡Œ
# è§£æ±º: ãƒ­ãƒ¼ã‚«ãƒ«ã§CDKç¢ºèª
npm run cdk:synth
npm run type-check
```

#### **3. Lambda Containerèµ·å‹•å¤±æ•—**
```bash
# åŸå› : ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆè¨­å®šã€æ¨©é™å•é¡Œ
# è§£æ±º: ãƒ­ãƒ¼ã‚«ãƒ«Lambdaç’°å¢ƒãƒ†ã‚¹ãƒˆ
docker run -p 9000:8080 \
  --entrypoint /usr/local/bin/npx \
  test-image aws-lambda-ric dist/lambda/handler.lambdaHandler
```

#### **4. AWSèªè¨¼å¤±æ•—**
```bash
# åŸå› : ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®šä¸å‚™ã€æ¨©é™ä¸è¶³
# è§£æ±º: GitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç¢ºèªã€IAMãƒãƒªã‚·ãƒ¼ç¢ºèª
aws sts get-caller-identity  # èªè¨¼ç¢ºèª
aws lambda list-functions   # æ¨©é™ç¢ºèª
```

### **ãƒ­ã‚°ç¢ºèªæ–¹æ³•**
```bash
# GitHub Actions ãƒ­ã‚°
# ãƒªãƒã‚¸ãƒˆãƒª â†’ Actions â†’ è©²å½“ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ â†’ ãƒ­ã‚°è©³ç´°

# AWS CloudWatch ãƒ­ã‚°ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œï¼‰
aws logs tail /aws/lambda/crowdworks-searcher-main --follow

# CDK ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°
aws cloudformation describe-stack-events \
  --stack-name CrowdWorksSearcherStack
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

### **OIDCèªè¨¼ï¼ˆæ¨å¥¨ï¼‰**
```yaml
# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®ä»£ã‚ã‚Šã«OIDCä½¿ç”¨
permissions:
  id-token: write
  contents: read

- name: Configure AWS credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsRole
    aws-region: ap-northeast-1
```

### **æ¨©é™æœ€å°åŒ–**
```yaml
IAMãƒãƒªã‚·ãƒ¼ï¼ˆæœ€å°æ¨©é™ï¼‰:
  - lambda:UpdateFunctionCode
  - lambda:UpdateFunctionConfiguration
  - ecr:GetAuthorizationToken
  - ecr:BatchCheckLayerAvailability
  - ecr:GetDownloadUrlForLayer
  - ecr:BatchGetImage
  - ecr:PutImage
```

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### **ãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®**
```yaml
æœ€é©åŒ–æ–½ç­–:
  1. Node.jsä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  2. Dockerãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  3. ä¸¦è¡Œã‚¸ãƒ§ãƒ–å®Ÿè¡Œ
  4. ä¸è¦ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ã‚­ãƒƒãƒ—

çµæœ:
  å¾“æ¥: 25åˆ† â†’ ç¾åœ¨: 12åˆ†ï¼ˆ52%çŸ­ç¸®ï¼‰
```

### **ãƒªã‚½ãƒ¼ã‚¹åŠ¹ç‡åŒ–**
```yaml
GitHub Actions Runner:
  Type: ubuntu-latest
  Concurrent jobs: æœ€å¤§4ã¤
  Matrix strategy: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ¥
```

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### **1. CI/CDæ”¹å–„è¨ˆç”»**
- [ ] **ãƒãƒ«ãƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å¯¾å¿œ**ï¼ˆARM64 Lambdaå¯¾å¿œæ™‚ï¼‰
- [ ] **Blue-Green ãƒ‡ãƒ—ãƒ­ã‚¤**ï¼ˆãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã‚¼ãƒ­ï¼‰
- [ ] **ã‚«ãƒŠãƒªã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤**ï¼ˆæ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆï¼‰
- [ ] **è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**ï¼ˆã‚¨ãƒ©ãƒ¼æ¤œçŸ¥æ™‚ï¼‰

### **2. ç›£è¦–å¼·åŒ–**
- [ ] **SREæŒ‡æ¨™è¿½åŠ **ï¼ˆMTTRã€MTBFç­‰ï¼‰
- [ ] **ã‚³ã‚¹ãƒˆæœ€é©åŒ–è‡ªå‹•åŒ–**
- [ ] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°ãƒ†ã‚¹ãƒˆ**

---

**ğŸ“ ã‚µãƒãƒ¼ãƒˆ**: CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€[GitHub Issues](https://github.com/masayuki-akinari/crowdworks-search/issues) ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
</file>

<file path="jest.config.js">
module.exports = {
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒ
    preset: 'ts-jest',
    testEnvironment: 'node',

    // TypeScriptè¨­å®š
    transform: {
        '^.+\\.tsx?$': ['ts-jest', {
            tsconfig: './tsconfig.json'
        }]
    },

    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®è¨­å®š
    moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json'],

    // ãƒ‘ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆtsconfig.jsonã¨åŒæœŸï¼‰
    moduleNameMapper: {
        '^@/(.*)$': '<rootDir>/src/$1',
        '^@/types/(.*)$': '<rootDir>/src/types/$1',
        '^@/services/(.*)$': '<rootDir>/src/services/$1',
        '^@/utils/(.*)$': '<rootDir>/src/utils/$1',
        '^@/infrastructure/(.*)$': '<rootDir>/src/infrastructure/$1'
    },

    // ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
    testMatch: [
        '<rootDir>/src/**/*.test.(ts|tsx)',
        '<rootDir>/src/**/*.spec.(ts|tsx)',
        '<rootDir>/test/**/*.test.(ts|tsx)',
        '<rootDir>/test/**/*.spec.(ts|tsx)'
    ],

    // ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®š
    collectCoverage: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡åŠ¹ï¼ˆnpm run test:coverageã§æœ‰åŠ¹ï¼‰
    collectCoverageFrom: [
        'src/**/*.{ts,tsx}',
        '!src/**/*.d.ts',
        '!src/**/*.test.{ts,tsx}',
        '!src/**/*.spec.{ts,tsx}',
        '!src/test/**/*',
        '!src/types/**/*', // å‹å®šç¾©ã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ã‹ã‚‰é™¤å¤–
    ],
    coverageDirectory: 'coverage',
    coverageReporters: ['text', 'lcov', 'html'],
    // TODO: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…å¾Œã«ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶ã‚’å¾©æ´»
    // coverageThreshold: {
    //     global: {
    //         branches: 20,   // 75% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         functions: 20,  // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         lines: 20,      // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         statements: 20  // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //     }
    // },

    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
    setupFilesAfterEnv: ['<rootDir>/test/setup.ts'],

    // ãƒ¢ãƒƒã‚¯è¨­å®š
    clearMocks: true,
    resetMocks: true,
    restoreMocks: true,

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    testTimeout: 30000, // 30ç§’ï¼ˆAWS SDKå‘¼ã³å‡ºã—ãªã©æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆã«å¯¾å¿œï¼‰

    // ä¸¦åˆ—å®Ÿè¡Œè¨­å®š
    maxWorkers: '50%', // CPUã‚³ã‚¢æ•°ã®50%ã§ä¸¦åˆ—å®Ÿè¡Œ

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºè¨­å®š
    verbose: true,
    errorOnDeprecated: true,

    // ä¸è¦ãªãƒ­ã‚°ã‚’æŠ‘åˆ¶
    silent: false,

    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰å¾Œã®ãƒ•ãƒƒã‚¯
    globalSetup: undefined,
    globalTeardown: undefined
};
</file>

<file path="src/index.ts">
/**
 * CrowdWorks Search System - Main Entry Point
 * Dockerç’°å¢ƒã§ã®é–‹ç™ºç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */

import { ExecutionLog } from '@/types';

// ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼
function validateEnvironment(): void {
  const required = ['NODE_ENV', 'AWS_REGION'];
  const missing = required.filter(key => !process.env[key]);

  if (missing.length > 0) {
    throw new Error(`Missing required environment variables: ${missing.join(', ')}`);
  }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
async function main(): Promise<void> {
  try {
    validateEnvironment();

    const log: ExecutionLog = {
      executionId: Date.now().toString(),
      timestamp: new Date().toISOString(),
      status: 'success',
      duration: 0,
      jobsScraped: 0,
      newJobs: 0,
      aiEvaluated: 0,
      highScoreJobs: 0,
      costEstimate: 0,
    };

    console.log('ğŸš€ CrowdWorks Search System - Development Mode');
    console.log(`Environment: ${process.env['NODE_ENV']}`);
    console.log(`AWS Region: ${process.env['AWS_REGION']}`);
    console.log(`Execution ID: ${log.executionId}`);

    // TODO: å®Ÿéš›ã®å‡¦ç†ã‚’å®Ÿè£…
    console.log('âœ… Development setup completed');
  } catch (error) {
    console.error('âŒ Failed to start application:', error);
    process.exit(1);
  }
}

// é–‹ç™ºç’°å¢ƒã§ã®ã¿å®Ÿè¡Œ
if (require.main === module) {
  main().catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
  });
}

export { main };
</file>

<file path="src/infrastructure/crowdworks-searcher-stack.ts">
import * as cdk from 'aws-cdk-lib';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as events from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as logs from 'aws-cdk-lib/aws-logs';
import { Construct } from 'constructs';

export interface CrowdWorksSearcherStackProps extends cdk.StackProps {
  readonly stage?: string;
  readonly useContainerImage?: boolean; // Container Imageä½¿ç”¨ãƒ•ãƒ©ã‚°
}

export class CrowdWorksSearcherStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: CrowdWorksSearcherStackProps) {
    super(scope, id, props);

    const stage = props?.stage || this.node.tryGetContext('stage') || 'dev';
    const isProd = stage === 'production';
    const useContainerImage = props?.useContainerImage ?? true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Containerä½¿ç”¨

    // ãƒªã‚½ãƒ¼ã‚¹åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
    const resourcePrefix = `crowdworks-searcher-${stage}`;

    // S3ãƒã‚±ãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ï¼‰
    const dataBucket = new s3.Bucket(this, 'CrowdWorksDataBucket', {
      bucketName: `${resourcePrefix}-data-${this.account}`,
      encryption: s3.BucketEncryption.S3_MANAGED,
      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
      versioned: isProd, // æœ¬ç•ªç’°å¢ƒã®ã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹
      lifecycleRules: [
        {
          id: 'DeleteOldData',
          enabled: true,
          expiration: isProd ? cdk.Duration.days(30) : cdk.Duration.days(7),
          // æœ¬ç•ªç’°å¢ƒã§ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ç®¡ç†
          ...(isProd && {
            noncurrentVersionExpiration: cdk.Duration.days(7),
          }),
        },
      ],
      removalPolicy: isProd ? cdk.RemovalPolicy.RETAIN : cdk.RemovalPolicy.DESTROY,
      autoDeleteObjects: !isProd, // æœ¬ç•ªç’°å¢ƒã§ã¯æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦
    });

    // CloudWatch Logs ã‚°ãƒ«ãƒ¼ãƒ—
    const logGroup = new logs.LogGroup(this, 'LambdaLogGroup', {
      logGroupName: `/aws/lambda/${resourcePrefix}-main`,
      retention: isProd ? logs.RetentionDays.ONE_MONTH : logs.RetentionDays.ONE_WEEK,
      removalPolicy: isProd ? cdk.RemovalPolicy.RETAIN : cdk.RemovalPolicy.DESTROY,
    });

    // Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ï¼ˆContainer Imageç”¨æ¨©é™è¿½åŠ ï¼‰
    const lambdaRole = new iam.Role(this, 'LambdaExecutionRole', {
      roleName: `${resourcePrefix}-lambda-role`,
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com'),
      managedPolicies: [
        iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole'),
      ],
      inlinePolicies: {
        S3Access: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['s3:GetObject', 's3:PutObject', 's3:ListBucket', 's3:DeleteObject'],
              resources: [dataBucket.bucketArn, `${dataBucket.bucketArn}/*`],
            }),
          ],
        }),
        LogsAccess: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['logs:CreateLogStream', 'logs:PutLogEvents'],
              resources: [logGroup.logGroupArn],
            }),
          ],
        }),
        // Parameter Store (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ç”¨)
        ParameterStoreAccess: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['ssm:GetParameter', 'ssm:GetParameters'],
              resources: [`arn:aws:ssm:${this.region}:${this.account}:parameter/crowdworks-search/*`],
            }),
          ],
        }),
      },
    });

    // Lambdaé–¢æ•°ï¼ˆContainer Imageå¯¾å¿œï¼‰
    const mainFunction = useContainerImage
      ? new lambda.DockerImageFunction(this, 'CrowdWorksMainFunction', {
        functionName: `${resourcePrefix}-main`,
        code: lambda.DockerImageCode.fromImageAsset('./', {
          // Lambda Containerç”¨ã®Dockerfileã‚’æŒ‡å®š
          file: 'Dockerfile.lambda',
          // ãƒ“ãƒ«ãƒ‰å¼•æ•°ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æ¸¡ã™
          buildArgs: {
            STAGE: stage,
            NODE_ENV: isProd ? 'production' : 'development',
          },
        }),
        timeout: cdk.Duration.minutes(15), // Playwrightç”¨ã«15åˆ†
        memorySize: isProd ? 3008 : 2048,  // Playwrightç”¨ãƒ¡ãƒ¢ãƒª
        role: lambdaRole,
        logGroup: logGroup,
        architecture: lambda.Architecture.X86_64, // Playwrightã¯x86_64ã®ã¿ã‚µãƒãƒ¼ãƒˆ
        environment: {
          NODE_ENV: stage,
          STAGE: stage,
          DATA_BUCKET_NAME: dataBucket.bucketName,
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
          // Playwrightç’°å¢ƒå¤‰æ•°
          PLAYWRIGHT_BROWSERS_PATH: '/usr/bin',
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1',
          LOG_LEVEL: isProd ? 'info' : 'debug',
        },
        // æœ¬ç•ªç’°å¢ƒã§ã¯äºˆç´„æ¸ˆã¿åŒæ™‚å®Ÿè¡Œæ•°ã‚’è¨­å®š
        ...(isProd && {
          reservedConcurrentExecutions: 5,
        }),
      })
      : new lambda.Function(this, 'CrowdWorksMainFunction', {
        functionName: `${resourcePrefix}-main`,
        runtime: lambda.Runtime.NODEJS_18_X,
        handler: 'lambda/handler.lambdaHandler',
        code: lambda.Code.fromAsset('./dist'),
        timeout: cdk.Duration.minutes(isProd ? 15 : 10),
        memorySize: isProd ? 1536 : 1024,
        role: lambdaRole,
        logGroup: logGroup,
        environment: {
          NODE_ENV: stage,
          STAGE: stage,
          DATA_BUCKET_NAME: dataBucket.bucketName,
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
        },
        // æœ¬ç•ªç’°å¢ƒã§ã¯äºˆç´„æ¸ˆã¿åŒæ™‚å®Ÿè¡Œæ•°ã‚’è¨­å®š
        ...(isProd && {
          reservedConcurrentExecutions: 5,
        }),
      });

    // EventBridgeï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ï¼‰
    const scheduleRule = new events.Rule(this, 'ScheduleRule', {
      ruleName: `${resourcePrefix}-schedule`,
      // æœ¬ç•ªç’°å¢ƒã§ã¯15åˆ†é–“éš”ã€ãã®ä»–ã¯30åˆ†é–“éš”
      schedule: events.Schedule.rate(isProd ? cdk.Duration.minutes(15) : cdk.Duration.minutes(30)),
      description: `CrowdWorksæ¡ˆä»¶æ¤œç´¢ã®å®šæœŸå®Ÿè¡Œ (${stage}ç’°å¢ƒ)`,
      enabled: stage !== 'test', // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ç„¡åŠ¹
    });

    scheduleRule.addTarget(new targets.LambdaFunction(mainFunction));

    // ã‚¿ã‚°ä»˜ã‘
    cdk.Tags.of(this).add('Project', 'CrowdWorksSearcher');
    cdk.Tags.of(this).add('Stage', stage);
    cdk.Tags.of(this).add('Environment', isProd ? 'production' : 'development');

    // å‡ºåŠ›
    new cdk.CfnOutput(this, 'DataBucketName', {
      value: dataBucket.bucketName,
      description: 'S3ãƒ‡ãƒ¼ã‚¿ãƒã‚±ãƒƒãƒˆå',
      exportName: `${resourcePrefix}-data-bucket-name`,
    });

    new cdk.CfnOutput(this, 'LambdaFunctionName', {
      value: mainFunction.functionName,
      description: 'Lambdaé–¢æ•°å',
      exportName: `${resourcePrefix}-lambda-function-name`,
    });

    new cdk.CfnOutput(this, 'LambdaFunctionArn', {
      value: mainFunction.functionArn,
      description: 'Lambdaé–¢æ•°ARN',
      exportName: `${resourcePrefix}-lambda-function-arn`,
    });

    new cdk.CfnOutput(this, 'Stage', {
      value: stage,
      description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸',
      exportName: `${resourcePrefix}-stage`,
    });

    // å‡ºåŠ›ï¼ˆContainer Imageæƒ…å ±è¿½åŠ ï¼‰
    new cdk.CfnOutput(this, 'DeploymentMethod', {
      value: useContainerImage ? 'Container Image' : 'ZIP Package',
      description: 'Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼',
      exportName: `${resourcePrefix}-deployment-method`,
    });
  }
}
</file>

<file path="src/types/index.ts">
// æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹ï¼ˆè»½é‡ç‰ˆï¼‰
export interface JobData {
  id: string; // æ¡ˆä»¶IDï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  title: string; // æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«
  description: string; // æ¡ˆä»¶è©³ç´°ï¼ˆæœ€å¤§500æ–‡å­—ï¼‰
  url: string; // æ¡ˆä»¶URL
  budget: number; // äºˆç®—ï¼ˆå††ï¼‰
  deadline: Date; // ç´æœŸ
  workType: 'fixed' | 'hourly'; // å›ºå®šå ±é…¬ or æ™‚é–“å˜ä¾¡
  category: string; // ã‚«ãƒ†ã‚´ãƒª
  clientName: string; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
  clientRating: number; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡ï¼ˆ1-5ï¼‰
  clientReviews: number; // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°
  skills: string[]; // å¿…è¦ã‚¹ã‚­ãƒ«ï¼ˆæœ€å¤§5å€‹ï¼‰
  experience: 'beginner' | 'intermediate' | 'expert'; // çµŒé¨“ãƒ¬ãƒ™ãƒ«
  scrapedAt: Date; // å–å¾—æ—¥æ™‚
  source: 'crowdworks'; // å–å¾—å…ƒï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
}

// è©•ä¾¡çµæœå‹ï¼ˆè»½é‡ç‰ˆï¼‰
export interface JobEvaluation {
  jobId: string; // å¯¾è±¡æ¡ˆä»¶ID
  evaluatedAt: Date; // è©•ä¾¡æ—¥æ™‚
  score: number; // ãŠã™ã™ã‚åº¦ï¼ˆ1-10ï¼‰
  reason: string; // è©•ä¾¡ç†ç”±ï¼ˆæœ€å¤§50æ–‡å­—ï¼‰
  aiModel: 'gpt-3.5-turbo'; // ä½¿ç”¨AIãƒ¢ãƒ‡ãƒ«
  tokenUsed: number; // ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  costEstimate: number; // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  strengths: string[]; // å¼·ã¿ï¼ˆæœ€å¤§3å€‹ï¼‰
  concerns: string[]; // æ‡¸å¿µç‚¹ï¼ˆæœ€å¤§3å€‹ï¼‰
}

// å®Ÿè¡Œãƒ­ã‚°å‹
export interface ExecutionLog {
  executionId: string; // å®Ÿè¡ŒIDï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ï¼‰
  timestamp: string; // å®Ÿè¡Œé–‹å§‹æ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰
  status: 'success' | 'error' | 'partial'; // å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  duration: number; // å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  jobsScraped: number; // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä»¶æ•°
  newJobs: number; // æ–°è¦æ¡ˆä»¶æ•°
  aiEvaluated: number; // AIè©•ä¾¡ä»¶æ•°
  highScoreJobs: number; // é«˜è©•ä¾¡æ¡ˆä»¶æ•°ï¼ˆé–¾å€¤ä»¥ä¸Šï¼‰
  costEstimate: number; // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  error?: {
    type: string; // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—
    message: string; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    stack?: string; // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
  };
}

// ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå‹
export interface SystemConfig {
  scraping: {
    maxJobsPerExecution: number;
    preFilterEnabled: boolean;
    minBudget: number;
    minClientRating: number;
    maxDescriptionLength: number;
  };
  ai: {
    enabled: boolean;
    model: 'gpt-3.5-turbo';
    maxJobsForEvaluation: number;
    monthlyBudgetLimit: number;
    maxTokensPerRequest: number;
    temperature: number;
  };
  notification: {
    enabled: boolean;
    scoreThreshold: number;
    errorNotificationEnabled: boolean;
    dailySummaryEnabled: boolean;
  };
  storage: {
    retentionDays: number;
    compressionEnabled: boolean;
    backupEnabled: boolean;
  };
  performance: {
    timeoutSeconds: number;
    retryCount: number;
    concurrentLimit: number;
  };
}

// æ¤œç´¢æ¡ä»¶å‹
export interface SearchCondition {
  id: string;
  name: string;
  enabled: boolean;
  keywords: string[];
  budgetMin: number;
  budgetMax: number;
  category: string;
  workType: 'fixed' | 'hourly' | 'both';
  clientRatingMin: number;
  experienceLevel: 'beginner' | 'intermediate' | 'expert' | 'any';
  excludeKeywords: string[];
  excludeClients: string[];
}

// æ¤œç´¢æ¡ä»¶è¨­å®šå‹
export interface SearchConditions {
  version: string;
  lastUpdated: Date;
  conditions: SearchCondition[];
}

// ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼æƒ…å ±å‹
export interface LoginCredentials {
  email: string;
  password: string;
}

// Lambda ã‚¤ãƒ™ãƒ³ãƒˆå‹
export interface ScheduledExecutionEvent {
  source: string;
  'detail-type': string;
  detail: Record<string, any>;
  time?: string; // ISOå½¢å¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
}

// Lambda ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ï¼ˆæ–°å½¢å¼ï¼‰
export interface ScheduledExecutionResponse {
  statusCode: number; // HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰
  body: string; // JSONæ–‡å­—åˆ—ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  executionTime: number; // å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  timestamp: string; // ISOå½¢å¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
}

// Playwrightå‹•ä½œç¢ºèªçµæœå‹
export interface PlaywrightTestResult {
  success: boolean;
  chromiumVersion?: string;
  title?: string;
  screenshot?: boolean;
  error?: string;
  executionTime: number;
}

// Lambdaå®Ÿè¡Œçµæœå‹ï¼ˆæ–°å½¢å¼ï¼‰
export interface LambdaExecutionResult {
  phases: {
    playwright: PlaywrightTestResult;
    crowdworksLogin: {
      success: boolean;
      loginResult?: CrowdWorksLoginResult;
      error?: string;
      executionTime: number;
    };
    crowdworksScraping: {
      success: boolean;
      scrapingResult?: any; // å®Ÿè£…æ™‚ã«è©³ç´°å‹ã‚’è¿½åŠ 
      error?: string;
      executionTime: number;
    };
  };
  executionTime: number;
  timestamp: string;
}

// Lambda ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
export interface LambdaErrorResponse {
  message: string;
  error: string;
  requestId: string;
  timestamp: string;
}

// æ—§å½¢å¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼‰
export interface LegacyScheduledExecutionResponse {
  status: 'success' | 'error' | 'partial';
  executionId: string;
  timestamp: string;
  results: {
    jobsScraped: number;
    newJobs: number;
    aiEvaluated: number;
    highScoreJobs: number;
    duration: number;
    costEstimate: number;
  };
  error?: {
    type: string;
    message: string;
  };
}

// ã‚¨ãƒ©ãƒ¼å‹
export enum ErrorType {
  AUTHENTICATION_ERROR = 'AUTH_ERROR',
  LAMBDA_TIMEOUT = 'LAMBDA_TIMEOUT',
  S3_ACCESS_ERROR = 'S3_ACCESS_ERROR',
  SCRAPING_ERROR = 'SCRAPING_ERROR',
  AI_API_ERROR = 'AI_API_ERROR',
  NETWORK_ERROR = 'NETWORK_ERROR',
}

export class AppError extends Error {
  constructor(
    public type: ErrorType,
    message: string,
    public retryable: boolean = false
  ) {
    super(message);
    this.name = 'AppError';
  }
}

// CrowdWorksèªè¨¼æƒ…å ±
export interface CrowdWorksCredentials {
  email: string;
  password: string;
}

// CrowdWorksãƒ­ã‚°ã‚¤ãƒ³çµæœ
export interface CrowdWorksLoginResult {
  success: boolean;
  isLoggedIn: boolean;
  error?: string;
  executionTime: number;
}
</file>

<file path="tsconfig.json">
{
    "compilerOptions": {
        "target": "ES2022",
        "module": "commonjs",
        "lib": [
            "ES2022"
        ],
        "rootDir": "./src",
        "outDir": "./dist",
        "removeComments": true,
        "declaration": true,
        "declarationMap": true,
        "sourceMap": true,
        "strict": true,
        "noImplicitAny": true,
        "strictNullChecks": true,
        "strictFunctionTypes": true,
        "strictBindCallApply": true,
        "strictPropertyInitialization": true,
        "noImplicitReturns": true,
        "noFallthroughCasesInSwitch": true,
        "noUncheckedIndexedAccess": true,
        "noImplicitOverride": true,
        "exactOptionalPropertyTypes": true,
        "noPropertyAccessFromIndexSignature": true,
        "noUnusedLocals": true,
        "noUnusedParameters": true,
        "allowUnreachableCode": false,
        "allowUnusedLabels": false,
        "esModuleInterop": true,
        "allowSyntheticDefaultImports": true,
        "forceConsistentCasingInFileNames": true,
        "moduleResolution": "node",
        "resolveJsonModule": true,
        "isolatedModules": true,
        "skipLibCheck": true,
        "experimentalDecorators": true,
        "emitDecoratorMetadata": true,
        "baseUrl": "./",
        "paths": {
            "@/*": [
                "src/*"
            ],
            "@/types/*": [
                "src/types/*"
            ],
            "@/services/*": [
                "src/services/*"
            ],
            "@/utils/*": [
                "src/utils/*"
            ],
            "@/infrastructure/*": [
                "src/infrastructure/*"
            ]
        }
    },
    "include": [
        "src/**/*"
    ],
    "exclude": [
        "node_modules",
        "dist",
        "cdk.out",
        "test",
        "**/*.test.ts",
        "**/*.spec.ts",
        "*.js"
    ],
    "ts-node": {
        "require": [
            "tsconfig-paths/register"
        ],
        "compilerOptions": {
            "module": "commonjs"
        }
    }
}
</file>

<file path=".eslintrc.js">
module.exports = {
    parser: '@typescript-eslint/parser',
    parserOptions: {
        ecmaVersion: 2022,
        sourceType: 'module',
    },
    env: {
        node: true,
        es2022: true
    },
    plugins: [
        '@typescript-eslint'
    ],
    extends: [
        'eslint:recommended'
    ],
    rules: {
        // anyå‹ã‚’å³æ ¼ã«ç¦æ­¢
        '@typescript-eslint/no-explicit-any': 'error',
        '@typescript-eslint/no-unused-vars': ['error', {
            argsIgnorePattern: '^_',
            varsIgnorePattern: '^_'
        }],

        // General rules
        'no-console': 'off', // é–‹ç™ºä¸­ã¯è¨±å¯
        'no-debugger': 'error',
        'prefer-const': 'error',
        'no-var': 'error'
    },
    ignorePatterns: [
        'dist/',
        'node_modules/',
        'cdk.out/',
        '*.js',
        '*.d.ts'
    ]
};
</file>

<file path="Dockerfile">
# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM node:18-alpine as base

# å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    chromium \
    && rm -rf /var/cache/apk/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# package.jsonã¨package-lock.jsonã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
COPY package*.json ./

# === ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM base as dependencies

# å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm ci

# === ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as build

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# TypeScriptã®ãƒ“ãƒ«ãƒ‰
RUN npm run build

# ä¸è¦ãªdevDependenciesã‚’å‰Šé™¤
RUN npm prune --production

# === ãƒ†ã‚¹ãƒˆç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as test

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# TypeScriptã®ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
RUN npm run build

# Playwrightã®è¨­å®š
ENV PLAYWRIGHT_BROWSERS_PATH=/usr/bin/chromium-browser
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
CMD ["npm", "run", "test:coverage"]

# === é–‹ç™ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as development

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# é–‹ç™ºç”¨ã®ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 3000 9229

# é–‹ç™ºç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰
CMD ["npm", "run", "dev"]

# === æœ¬ç•ªç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM node:18-alpine as production

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# æœ¬ç•ªç”¨ã®æœ€å°é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache dumb-init

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¨æœ¬ç•ªç”¨ä¾å­˜é–¢ä¿‚ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=build --chown=nextjs:nodejs /app/dist ./dist
COPY --from=build --chown=nextjs:nodejs /app/node_modules ./node_modules
COPY --from=build --chown=nextjs:nodejs /app/package.json ./package.json

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER nextjs

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¿½åŠ 
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node --version || exit 1

# æœ¬ç•ªç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰
CMD ["dumb-init", "node", "dist/index.js"]
</file>

<file path="docs/05_implementation_plan.md">
# CrowdWorksè‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ  å®Ÿè£…è¨ˆç”»æ›¸

## ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### ç›®çš„
CrowdWorksã®æ¡ˆä»¶æƒ…å ±ã‚’è‡ªå‹•çš„ã«åé›†ãƒ»åˆ†æã—ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã—ãŸçµæœã‚’ãƒ¡ãƒ¼ãƒ«ã§é€šçŸ¥ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ 

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **AWS Lambda**: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œï¼ˆ**ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ç‰ˆ**ï¼‰
- **Amazon EventBridge**: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
- **Amazon S3**: ãƒ‡ãƒ¼ã‚¿ä¿å­˜
- **Amazon SES**: ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
- **CDK**: Infrastructure as Code

## âš ï¸ **æœ€é‡è¦: Playwright Lambdaåˆ¶ç´„ã®æœ€çµ‚å¯¾å¿œ**

### **æŠ€è¡“çš„èª²é¡Œã®æœ€çµ‚çµè«–**
```yaml
ç¾çŠ¶åˆ†æ:
  Lambda ZIPåˆ¶é™: 250MB
  Playwright + Chromium: ~300MB
  çµè«–: âŒ ZIPç‰ˆã¯ç‰©ç†çš„ã«ä¸å¯èƒ½

æœ€çµ‚å¯¾å¿œæ–¹é‡:
  âœ… Lambda Container Imageæ¡ç”¨ï¼ˆç¢ºå®šï¼‰
  ã‚µã‚¤ã‚ºåˆ¶é™: 10GBï¼ˆZIP: 250MB â†’ Container: 10GBï¼‰
  ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼: ECR + Docker
  æœˆé¡ã‚³ã‚¹ãƒˆ: $5-10ï¼ˆè¨±å®¹ç¯„å›²å†…ï¼‰
```

### **âš¡ æœ€å„ªå…ˆå®Ÿè£…ã‚¿ã‚¹ã‚¯ï¼ˆPhase 0ï¼‰**

#### **1. Lambdaã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã®å‹•ä½œç¢ºèª**
```bash
# æœ€å„ªå…ˆäº‹é …ï¼ˆä»Šã™ãå®Ÿè¡Œï¼‰
priority: P0 - Critical
æœŸé™: æ¬¡å›ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…
ç›®æ¨™: Playwright + Chromiumã®å‹•ä½œå®Ÿè¨¼
```

**å…·ä½“çš„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:**
1. **ç¾åœ¨ã®Dockerfileä¿®æ­£**ï¼ˆLambda Containerç”¨ï¼‰
2. **CDKã‚¹ã‚¿ãƒƒã‚¯ã®å¤‰æ›´**ï¼ˆDockerImageFunctionï¼‰
3. **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒæ§‹ç¯‰**
4. **AWS ECRãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆ**
5. **Lambdaå®Ÿè¡Œç¢ºèª**

#### **2. CDKã‚¹ã‚¿ãƒƒã‚¯æ”¹ä¿®ï¼ˆPhase 0ï¼‰**

**ç¾åœ¨ã®å•é¡Œ:**
```typescript
// ç¾åœ¨: ZIPå½¢å¼
new lambda.Function(this, 'CrowdWorksFunction', {
  runtime: lambda.Runtime.NODEJS_18_X,
  code: lambda.Code.fromAsset('./dist'),  // âŒ ã‚µã‚¤ã‚ºè¶…é
  // ...
});
```

**ä¿®æ­£æ–¹é‡:**
```typescript
// ä¿®æ­£å¾Œ: Containerå½¢å¼
new lambda.DockerImageFunction(this, 'CrowdWorksFunction', {
  code: lambda.DockerImageCode.fromImageAsset('./'),  // âœ… 10GBã¾ã§å¯¾å¿œ
  memorySize: 3008,  // Playwrightç”¨ãƒ¡ãƒ¢ãƒª
  timeout: Duration.minutes(15),
  architecture: lambda.Architecture.X86_64,
  environment: {
    // ç’°å¢ƒå¤‰æ•°è¨­å®š
  }
});
```

## ğŸ¯ **ãƒ•ã‚§ãƒ¼ã‚ºåˆ¥å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—**

### **Phase 0: åŸºç›¤å‹•ä½œç¢ºèªï¼ˆæœ€å„ªå…ˆï¼‰**
```yaml
æœŸé–“: 1-2æ—¥
ç›®æ¨™: Playwrightã®å‹•ä½œå®Ÿè¨¼
ãƒ–ãƒ­ãƒƒã‚«ãƒ¼è§£é™¤: ãƒ‡ãƒ—ãƒ­ã‚¤åŸºç›¤ç¢ºç«‹
```

**å¿…é ˆã‚¿ã‚¹ã‚¯:**
- [ ] **CDKã‚¹ã‚¿ãƒƒã‚¯ä¿®æ­£**ï¼ˆLambda â†’ DockerImageFunctionï¼‰
- [ ] **Dockerfileæœ€é©åŒ–**ï¼ˆLambda Containerç”¨ï¼‰
- [ ] **ECRãƒªãƒã‚¸ãƒˆãƒªè¨­å®š**
- [ ] **ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒ**ï¼ˆLambda Runtime Interface Emulatorï¼‰
- [ ] **åŸºæœ¬å‹•ä½œç¢ºèª**ï¼ˆChromiumèµ·å‹•ãƒ†ã‚¹ãƒˆï¼‰
- [ ] **AWS ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆ**

### **Phase 1: ã‚³ã‚¢ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè£…**
```yaml
æœŸé–“: 3-5æ—¥  
å‰æ: Phase 0å®Œäº†
ç›®æ¨™: CrowdWorksæ¡ˆä»¶å–å¾—
```

**å®Ÿè£…å†…å®¹:**
- [ ] **CrowdWorksãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½**
- [ ] **æ¡ˆä»¶æ¤œç´¢ãƒ»ãƒªã‚¹ãƒˆå–å¾—**
- [ ] **æ¡ˆä»¶è©³ç´°ãƒ‡ãƒ¼ã‚¿æŠ½å‡º**
- [ ] **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**
- [ ] **ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–å‡¦ç†**

### **Phase 2: AIè©•ä¾¡ãƒ»é€šçŸ¥æ©Ÿèƒ½**
```yaml
æœŸé–“: 2-3æ—¥
å‰æ: Phase 1å®Œäº†
ç›®æ¨™: OpenAIé€£æºãƒ»ãƒ¡ãƒ¼ãƒ«é€šçŸ¥
```

**å®Ÿè£…å†…å®¹:**
- [ ] **OpenAI APIé€£æº**
- [ ] **æ¡ˆä»¶å“è³ªè©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯**
- [ ] **è©•ä¾¡çµæœãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**
- [ ] **SES/SNS ãƒ¡ãƒ¼ãƒ«é€šçŸ¥**
- [ ] **é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ**

### **Phase 3: é‹ç”¨æœ€é©åŒ–**
```yaml
æœŸé–“: 2-3æ—¥
å‰æ: Phase 2å®Œäº†  
ç›®æ¨™: æœ¬ç•ªé‹ç”¨æº–å‚™
```

**å®Ÿè£…å†…å®¹:**
- [ ] **S3ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»å±¥æ­´ç®¡ç†**
- [ ] **ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š**
- [ ] **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**
- [ ] **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°**
- [ ] **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ€çµ‚åŒ–**

## ğŸ”§ **Phase 0è©³ç´°: æŠ€è¡“çš„å®Ÿè£…ã‚¬ã‚¤ãƒ‰**

### **1. Dockerfileä¿®æ­£ï¼ˆLambda Containerç”¨ï¼‰**

**ç¾åœ¨ã®å•é¡Œ:**
```dockerfile
# ç¾åœ¨: ä¸€èˆ¬çš„ãªPlaywrightç’°å¢ƒ
FROM mcr.microsoft.com/playwright/python:v1.45.0-jammy
# â†’ Lambda Containerã¨ã—ã¦ä¸å®Œå…¨
```

**ä¿®æ­£æ–¹é‡:**
```dockerfile
# Lambda Containerå¯¾å¿œç‰ˆ
FROM public.ecr.aws/lambda/nodejs:18

# Playwright + Chromium ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN yum update -y && \
    yum install -y \
    chromium \
    nss \
    freetype \
    freetype-devel \
    harfbuzz \
    ca-certificates \
    ttf-liberation

# Node.js ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
COPY package*.json ./
RUN npm ci --omit=dev

COPY dist/ ./
COPY node_modules/ ./node_modules/

# Lambda ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
CMD ["lambda/handler.lambdaHandler"]
```

### **2. CDKã‚¹ã‚¿ãƒƒã‚¯ä¿®æ­£ï¼ˆinfrastructure/ï¼‰**

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/infrastructure/lambda-stack.ts`

```typescript
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as cdk from 'aws-cdk-lib';

export class CrowdWorksLambdaStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // âŒ å‰Šé™¤: å¾“æ¥ã®ZIPç‰ˆLambda
    // const crowdWorksFunction = new lambda.Function(...)

    // âœ… è¿½åŠ : Containerç‰ˆLambda
    const crowdWorksFunction = new lambda.DockerImageFunction(this, 'CrowdWorksFunction', {
      code: lambda.DockerImageCode.fromImageAsset('./'),
      memorySize: 3008,
      timeout: cdk.Duration.minutes(15),
      architecture: lambda.Architecture.X86_64,
      environment: {
        NODE_ENV: 'production',
        LOG_LEVEL: 'info',
        PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH: '/usr/bin/chromium-browser'
      },
      deadLetterQueue: dlq,  // DLQè¨­å®š
      retryAttempts: 2,
      logRetention: logs.RetentionDays.TWO_WEEKS
    });
  }
}
```

### **3. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆç’°å¢ƒï¼ˆPhase 0æ¤œè¨¼ç”¨ï¼‰**

**Lambda Runtime Interface Emulatorä½¿ç”¨:**
```bash
# 1. Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
docker build -t crowdworks-lambda .

# 2. Lambda Runtime Interface Emulatorèµ·å‹•
docker run -p 9000:8080 \
  -e AWS_LAMBDA_FUNCTION_NAME=crowdworks-searcher \
  crowdworks-lambda

# 3. ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
curl -XPOST "http://localhost:9000/2015-03-31/functions/function/invocations" \
  -d '{"source":"test","detail":{}}'
```

### **4. åŸºæœ¬å‹•ä½œç¢ºèªã‚¹ã‚¯ãƒªãƒ—ãƒˆ**

**ãƒ•ã‚¡ã‚¤ãƒ«:** `src/lambda/test-playwright.ts`
```typescript
import { chromium } from 'playwright';

export async function testPlaywright() {
  let browser;
  
  try {
    console.log('ğŸš€ Playwrightèµ·å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process'
      ]
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
    });
    
    const page = await context.newPage();
    
    // åŸºæœ¬å‹•ä½œç¢ºèª
    console.log('ğŸ“„ Google ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ...');
    await page.goto('https://www.google.com', { waitUntil: 'networkidle' });
    const title = await page.title();
    console.log(`âœ… ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: ${title}`);
    
    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼ˆç¢ºèªç”¨ï¼‰
    await page.screenshot({ path: '/tmp/test-screenshot.png' });
    console.log('ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜å®Œäº†');
    
    return {
      success: true,
      title,
      message: 'Playwrightå‹•ä½œç¢ºèªæˆåŠŸ'
    };
    
  } catch (error) {
    console.error('âŒ Playwright ãƒ†ã‚¹ãƒˆå¤±æ•—:', error);
    return {
      success: false,
      error: error instanceof Error ? error.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'
    };
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}
```

### **5. CI/CDå¯¾å¿œï¼ˆGitHub Actionsä¿®æ­£ï¼‰**

**.github/workflows/ci.yml ä¿®æ­£ç‚¹:**
```yaml
# Docker Buildæ®µéšã‚’ä¿®æ­£
docker-build:
  name: Docker Build Test (Lambda Container)
  runs-on: ubuntu-latest
  steps:
    - name: Build Lambda Container
      run: |
        docker build -t crowdworks-lambda:test .
        
    - name: Test Lambda Container
      run: |
        # Lambda Runtime Interface Emulatorã§ãƒ†ã‚¹ãƒˆ
        docker run --rm -d -p 9000:8080 --name lambda-test crowdworks-lambda:test
        sleep 10
        
        # åŸºæœ¬å‹•ä½œç¢ºèª
        curl -XPOST "http://localhost:9000/2015-03-31/functions/function/invocations" \
          -d '{"source":"test","detail":{}}' || exit 1
        
        docker stop lambda-test
```

## ğŸ“Š **ãƒªã‚¹ã‚¯è©•ä¾¡ã¨å¯¾ç­–**

### **é«˜ãƒªã‚¹ã‚¯è¦ç´ **
1. **Lambda Containeråˆå›ãƒ‡ãƒ—ãƒ­ã‚¤** â†’ ãƒ­ãƒ¼ã‚«ãƒ«ååˆ†æ¤œè¨¼
2. **Chromiumå‹•ä½œä¸å®‰å®šæ€§** â†’ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
3. **ãƒ¡ãƒ¢ãƒªãƒ»ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆèª¿æ•´** â†’ æ®µéšçš„ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### **ãƒªã‚¹ã‚¯è»½æ¸›ç­–**
```yaml
ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥:
  1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ååˆ†ãªæ¤œè¨¼
  2. Stagingç’°å¢ƒã§ã®æ®µéšãƒ†ã‚¹ãƒˆ
  3. Productionç’°å¢ƒã¸ã®æ®µéšãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

ç›£è¦–å¼·åŒ–:
  - CloudWatch Logsè©³ç´°ãƒ­ã‚°
  - Lambdaå®Ÿè¡Œãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
  - ã‚¨ãƒ©ãƒ¼ç‡ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
```

## ğŸ’° **ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šï¼ˆç¢ºå®šç‰ˆï¼‰**

### **Lambda Containerç‰ˆ æœˆé¡ã‚³ã‚¹ãƒˆ**
```yaml
Lambdaå®Ÿè¡Œ:
  å®Ÿè¡Œå›æ•°: 96å›/æ—¥ Ã— 30æ—¥ = 2,880å›/æœˆ
  å®Ÿè¡Œæ™‚é–“: å¹³å‡30ç§’/å›
  ãƒ¡ãƒ¢ãƒª: 3,008MB
  æ–™é‡‘: ~$4-6/æœˆ

ECRã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸:
  Dockerã‚¤ãƒ¡ãƒ¼ã‚¸: ~1GB
  æ–™é‡‘: $0.10/æœˆ

CloudWatch:
  ãƒ­ã‚°ä¿å­˜: ~$1-2/æœˆ
  
OpenAI API:
  GPT-4å‘¼ã³å‡ºã—: ~$2-3/æœˆ

åˆè¨ˆ: $7-11/æœˆï¼ˆç›®æ¨™$5ã‚’è‹¥å¹²ä¸Šå›ã‚‹ãŒè¨±å®¹ç¯„å›²ï¼‰
```

## ğŸ¯ **æˆåŠŸæŒ‡æ¨™ï¼ˆPhase 0ï¼‰**

### **å¿…é”ç›®æ¨™**
1. âœ… **Chromiumèµ·å‹•æˆåŠŸ**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ»AWSä¸¡ç’°å¢ƒ
2. âœ… **åŸºæœ¬ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹**: Googleç­‰ã®ç°¡å˜ãªã‚µã‚¤ãƒˆ
3. âœ… **Lambdaå®Ÿè¡ŒæˆåŠŸ**: 15åˆ†ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå†…
4. âœ… **ãƒ­ã‚°å‡ºåŠ›ç¢ºèª**: CloudWatch Logsã§è©³ç´°ç¢ºèªå¯èƒ½

### **å“è³ªç›®æ¨™**
- **èµ·å‹•æ™‚é–“**: 30ç§’ä»¥å†…
- **æˆåŠŸç‡**: 95%ä»¥ä¸Šï¼ˆ10å›ãƒ†ã‚¹ãƒˆä¸­9å›æˆåŠŸï¼‰
- **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**: 2GBä»¥ä¸‹
- **ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«**: ååˆ†ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±

## ğŸ“ **æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå³æ™‚å®Ÿè¡Œæ¨å¥¨ï¼‰**

### **ä»Šã™ãå®Ÿè¡Œã™ã¹ãã‚¿ã‚¹ã‚¯**
1. **CDKã‚¹ã‚¿ãƒƒã‚¯ä¿®æ­£** â†’ `DockerImageFunction`ã¸ã®å¤‰æ›´
2. **Dockerfileä¿®æ­£** â†’ Lambda Containerç”¨ã«æœ€é©åŒ–
3. **ãƒ­ãƒ¼ã‚«ãƒ«æ¤œè¨¼ç’°å¢ƒæ§‹ç¯‰** â†’ å‹•ä½œç¢ºèªã®å‰ææ¡ä»¶
4. **åŸºæœ¬ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ** â†’ å‹•ä½œç¢ºèªè‡ªå‹•åŒ–

### **æˆåŠŸå¾Œã®æ¬¡ã‚¹ãƒ†ãƒƒãƒ—**
- Phase 1ã¸é€²è¡Œï¼ˆCrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè£…ï¼‰
- é‹ç”¨ç›£è¦–è¨­å®š
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

---

**ğŸ“Œ æœ€é‡è¦**: Phase 0ã®åŸºç›¤ç¢ºç«‹ãªã—ã«ã¯ä»¥é™ã®å®Ÿè£…ãŒä¸å¯èƒ½ã§ã™ã€‚**Playwright Lambda Containerå‹•ä½œç¢ºèªã‚’æœ€å„ªå…ˆã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚**
</file>

<file path="src/test/crowdworks-scraping-test.ts">
import { chromium, Page } from 'playwright';
import dotenv from 'dotenv';
import fs from 'fs';

// ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
dotenv.config();

// screenshotsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
if (!fs.existsSync('screenshots')) {
    fs.mkdirSync('screenshots');
}

// ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
async function getCrowdWorksCredentials() {
    const email = process.env['CROWDWORKS_EMAIL'];
    const password = process.env['CROWDWORKS_PASSWORD'];

    if (!email || !password) {
        throw new Error('CROWDWORKS_EMAIL and CROWDWORKS_PASSWORD environment variables are required');
    }

    return { email, password };
}

// CrowdWorksã«ãƒ­ã‚°ã‚¤ãƒ³
async function loginToCrowdWorks(page: Page, credentials: { email: string; password: string }) {
    const startTime = Date.now();

    try {
        console.log('ğŸ” CrowdWorksãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹...');
        console.log(`ğŸ“§ ä½¿ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${credentials.email}`);

        // CrowdWorksã®ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
        await page.goto('https://crowdworks.jp/login', { waitUntil: 'domcontentloaded' });

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®è¦ç´ ã‚’å¾…æ©Ÿ
        console.log('â³ ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’å¾…æ©Ÿä¸­...');
        await page.waitForSelector('input[name="email"], [role="textbox"][aria-label*="ãƒ¡ãƒ¼ãƒ«"], textbox', {
            timeout: 10000
        });

        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸPlaywrightæ–¹å¼ï¼‰
        console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ä¸­...');
        try {
            // getByRoleæ–¹å¼ï¼ˆMCPã§ç¢ºèªã—ãŸæ–¹æ³•ï¼‰
            await page.getByRole('textbox', { name: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹' }).fill(credentials.email);
            console.log('âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›å®Œäº†ï¼ˆgetByRoleæ–¹å¼ï¼‰');
        } catch (roleError) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼
            console.log('âš ï¸ getByRoleå¤±æ•—ã€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ã§ãƒªãƒˆãƒ©ã‚¤...');
            const emailSelector = 'input[name="email"], input[type="email"], textbox[name*="email"]';
            await page.fill(emailSelector, credentials.email);
            console.log('âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›å®Œäº†ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ï¼‰');
        }

        await page.waitForTimeout(1000);

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ–¹å¼ï¼‰
        console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ä¸­...');
        try {
            // getByRoleæ–¹å¼ï¼ˆMCPã§ç¢ºèªã—ãŸæ–¹æ³•ï¼‰
            await page.getByRole('textbox', { name: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰' }).fill(credentials.password);
            console.log('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å®Œäº†ï¼ˆgetByRoleæ–¹å¼ï¼‰');
        } catch (roleError) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼
            console.log('âš ï¸ getByRoleå¤±æ•—ã€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ã§ãƒªãƒˆãƒ©ã‚¤...');
            const passwordSelector = 'input[name="password"], input[type="password"]';
            await page.fill(passwordSelector, credentials.password);
            console.log('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å®Œäº†ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ï¼‰');
        }

        await page.waitForTimeout(1000);

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ–¹å¼ï¼‰
        console.log('ğŸ–±ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ä¸­...');
        try {
            // getByRoleæ–¹å¼ï¼ˆMCPã§ç¢ºèªã—ãŸæ–¹æ³•ï¼‰
            await page.getByRole('button', { name: 'ãƒ­ã‚°ã‚¤ãƒ³', exact: true }).click();
            console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Œäº†ï¼ˆgetByRoleæ–¹å¼ï¼‰');
        } catch (roleError) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼
            console.log('âš ï¸ getByRoleå¤±æ•—ã€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ã§ãƒªãƒˆãƒ©ã‚¤...');
            const loginButtonSelector = 'input[type="submit"], button[type="submit"], button:has-text("ãƒ­ã‚°ã‚¤ãƒ³")';
            await page.click(loginButtonSelector);
            console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Œäº†ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ï¼‰');
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†ã¾ã§å¾…æ©Ÿ
        await page.waitForTimeout(5000);

        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸç¢ºèªï¼ˆURLãƒã‚§ãƒƒã‚¯ï¼‰
        const currentUrl = page.url();
        const isLoggedIn = !currentUrl.includes('/login');

        const executionTime = Date.now() - startTime;

        if (isLoggedIn) {
            console.log(`âœ… CrowdWorksãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ (${executionTime}ms)`);
            console.log(`ğŸŒ ç¾åœ¨ã®URL: ${currentUrl}`);
        } else {
            console.log(`âŒ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— (${executionTime}ms)`);
            console.log(`ğŸŒ ç¾åœ¨ã®URL: ${currentUrl}`);
        }

        return {
            success: isLoggedIn,
            isLoggedIn,
            executionTime
        };

    } catch (error) {
        const executionTime = Date.now() - startTime;
        console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);

        return {
            success: false,
            isLoggedIn: false,
            error: error instanceof Error ? error.message : String(error),
            executionTime
        };
    }
}

async function main() {
    try {
        console.log('ğŸš€ CrowdWorksæ¡ˆä»¶è©³ç´°å–å¾—ãƒ†ã‚¹ãƒˆé–‹å§‹...');

        // èªè¨¼æƒ…å ±å–å¾—
        const credentials = await getCrowdWorksCredentials();
        console.log(`ğŸ“§ ä½¿ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${credentials.email}`);

        // Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚’èµ·å‹•ã—ã¦ãƒ†ã‚¹ãƒˆ
        const browser = await chromium.launch({
            headless: false,  // è¦–è¦šçš„ã«ãƒ†ã‚¹ãƒˆç¢ºèª
            devtools: false,
            args: ['--start-maximized']
        });

        try {
            const context = await browser.newContext({
                userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                viewport: { width: 1920, height: 1080 },
                locale: 'ja-JP',
                timezoneId: 'Asia/Tokyo',
            });

            const page = await context.newPage();

            // CrowdWorksã«ãƒ­ã‚°ã‚¤ãƒ³
            const loginResult = await loginToCrowdWorks(page, credentials);
            if (!loginResult.success) {
                throw new Error(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${loginResult.error}`);
            }

            // æ–°ç€é †æ¡ˆä»¶ä¸€è¦§ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
            console.log('\nğŸ“‹ æ¡ˆä»¶ä¸€è¦§ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹...');
            await page.goto('https://crowdworks.jp/public/jobs/group/web_products?order=new', {
                waitUntil: 'networkidle'
            });
            await page.waitForTimeout(3000);

            // æ¡ˆä»¶ä¸€è¦§ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            await page.screenshot({
                path: `screenshots/job-list-${timestamp}.png`,
                fullPage: true
            });
            console.log(`ğŸ“¸ æ¡ˆä»¶ä¸€è¦§ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜: screenshots/job-list-${timestamp}.png`);

            // æœ€åˆã®æ¡ˆä»¶ã®ãƒªãƒ³ã‚¯ã‚’å–å¾—
            const firstJobUrl = await page.evaluate(() => {
                const jobLinks = (globalThis as any).document.querySelectorAll('a[href*="/public/jobs/"]');
                for (const link of jobLinks) {
                    const href = link.getAttribute('href');
                    if (href && href.match(/\/public\/jobs\/\d+$/)) {
                        return href.startsWith('http') ? href : `https://crowdworks.jp${href}`;
                    }
                }
                return null;
            });

            if (!firstJobUrl) {
                throw new Error('æ¡ˆä»¶ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
            }

            console.log(`ğŸ“„ æœ€åˆã®æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹: ${firstJobUrl}`);

            // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
            await page.goto(firstJobUrl, { waitUntil: 'networkidle' });
            await page.waitForTimeout(3000);

            // è©³ç´°æƒ…å ±ã‚’æŠ½å‡ºï¼ˆMCPã§ç¢ºèªã—ãŸæ§‹é€ ã«åŸºã¥ãï¼‰
            const jobDetail = await page.evaluate(() => {
                // åŸºæœ¬æƒ…å ±
                const titleElement = (globalThis as any).document.querySelector('h1');
                const fullTitle = titleElement?.textContent?.trim() || '';
                const title = fullTitle.replace(/\s+(ã‚¦ã‚§ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³|ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ|ãã®ä»–).*ã®ä»•äº‹ã®ä¾é ¼.*$/, '').trim();

                // æ¦‚è¦ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±
                const tables = (globalThis as any).document.querySelectorAll('table');
                let paymentInfo = '';
                let postDate = '';
                let deadline = '';
                let applicantCount = 0;
                let contractCount = 0;
                let recruitmentCount = 0;
                let favoriteCount = 0;

                tables.forEach((table: any) => {
                    const rows = table.querySelectorAll('tr');
                    rows.forEach((row: any) => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length >= 2) {
                            const label = cells[0]?.textContent?.trim() || '';
                            const value = cells[1]?.textContent?.trim() || '';

                            if (label.includes('å›ºå®šå ±é…¬åˆ¶') || label.includes('æ™‚é–“å˜ä¾¡åˆ¶')) {
                                paymentInfo = `${label}: ${value}`;
                            } else if (label.includes('æ²è¼‰æ—¥')) {
                                postDate = value;
                            } else if (label.includes('å¿œå‹ŸæœŸé™')) {
                                deadline = value;
                            } else if (label.includes('å¿œå‹Ÿã—ãŸäºº')) {
                                applicantCount = parseInt(value.replace(/[^\d]/g, '')) || 0;
                            } else if (label.includes('å¥‘ç´„ã—ãŸäºº')) {
                                contractCount = parseInt(value.replace(/[^\d]/g, '')) || 0;
                            } else if (label.includes('å‹Ÿé›†äººæ•°')) {
                                recruitmentCount = parseInt(value.replace(/[^\d]/g, '')) || 0;
                            } else if (label.includes('æ°—ã«ãªã‚‹')) {
                                favoriteCount = parseInt(value.replace(/[^\d]/g, '')) || 0;
                            }
                        }
                    });
                });

                // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
                const clientElement = (globalThis as any).document.querySelector('a[href*="/public/employers/"]');
                const clientName = clientElement?.textContent?.trim() || 'åŒ¿å';

                // è©•ä¾¡æƒ…å ±
                let rating = '';
                const ratingElements = (globalThis as any).document.querySelectorAll('dd, definition');
                ratingElements.forEach((el: any) => {
                    const text = el?.textContent?.trim() || '';
                    if (text.includes('.') && text.length < 5 && !rating) {
                        rating = text;
                    }
                });

                // è©³ç´°èª¬æ˜ï¼ˆæœ€ã‚‚é•·ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ«ï¼‰
                let description = '';
                let maxLength = 0;
                const descCells = (globalThis as any).document.querySelectorAll('td');
                descCells.forEach((cell: any) => {
                    const text = cell?.textContent?.trim() || '';
                    if (text.length > maxLength && text.length > 100) {
                        description = text;
                        maxLength = text.length;
                    }
                });

                // å¿œå‹Ÿè€…æƒ…å ±
                const applicantRows = (globalThis as any).document.querySelectorAll('tbody tr');
                const recentApplicants: string[] = [];
                applicantRows.forEach((row: any) => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 2) {
                        const nameElement = cells[0]?.querySelector('a');
                        if (nameElement) {
                            const name = nameElement?.textContent?.trim() || '';
                            const applicationDate = cells[1]?.textContent?.trim() || '';
                            if (name && applicationDate.includes('/')) {
                                recentApplicants.push(`${name} (${applicationDate})`);
                            }
                        }
                    }
                });

                return {
                    title,
                    paymentInfo,
                    postDate,
                    deadline,
                    applicantCount,
                    contractCount,
                    recruitmentCount,
                    favoriteCount,
                    clientName,
                    rating,
                    description: description.length > 500 ? description.substring(0, 500) + '...' : description,
                    recentApplicants: recentApplicants.slice(0, 5)
                };
            });

            // è©³ç´°æƒ…å ±è¡¨ç¤º
            console.log('\nğŸ“Š === æŠ½å‡ºã•ã‚ŒãŸæ¡ˆä»¶è©³ç´°æƒ…å ± ===');
            console.log(`ğŸ·ï¸ ã‚¿ã‚¤ãƒˆãƒ«: ${jobDetail.title}`);
            console.log(`ğŸ’° æ”¯æ‰•ã„æƒ…å ±: ${jobDetail.paymentInfo}`);
            console.log(`ğŸ“… æ²è¼‰æ—¥: ${jobDetail.postDate}`);
            console.log(`â° å¿œå‹ŸæœŸé™: ${jobDetail.deadline}`);
            console.log(`ğŸ‘¥ å¿œå‹Ÿè€…æ•°: ${jobDetail.applicantCount}äºº`);
            console.log(`ğŸ¤ å¥‘ç´„æ¸ˆã¿: ${jobDetail.contractCount}äºº`);
            console.log(`ğŸ“¢ å‹Ÿé›†äººæ•°: ${jobDetail.recruitmentCount}äºº`);
            console.log(`â­ æ°—ã«ãªã‚‹: ${jobDetail.favoriteCount}äºº`);
            console.log(`ğŸ¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ${jobDetail.clientName}`);
            console.log(`â­ è©•ä¾¡: ${jobDetail.rating}`);
            console.log(`ğŸ“ æ¦‚è¦: ${jobDetail.description}`);

            if (jobDetail.recentApplicants.length > 0) {
                console.log('ğŸ‘¥ æœ€è¿‘ã®å¿œå‹Ÿè€…:');
                jobDetail.recentApplicants.forEach((applicant, index) => {
                    console.log(`   ${index + 1}. ${applicant}`);
                });
            }

            // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜
            const detailTimestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const screenshotPath = `screenshots/job-detail-${detailTimestamp}.png`;
            await page.screenshot({ path: screenshotPath, fullPage: true });
            console.log(`ğŸ“¸ æ¡ˆä»¶è©³ç´°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜: ${screenshotPath}`);

            await context.close();

        } finally {
            await browser.close();
        }

        console.log('\nâœ… æ¡ˆä»¶è©³ç´°å–å¾—ãƒ†ã‚¹ãƒˆå®Œäº†ï¼');
        console.log('ğŸ¯ MCPãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªã—ãŸæ§‹é€ ã«åŸºã¥ãæ¡ˆä»¶è©³ç´°æŠ½å‡ºæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã—ãŸ');

    } catch (error) {
        console.error('âŒ ãƒ¡ã‚¤ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        process.exit(1);
    }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
if (require.main === module) {
    main().catch((error) => {
        console.error('âŒ ãƒ¡ã‚¤ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        process.exit(1);
    });
}
</file>

<file path=".github/workflows/ci.yml">
name: CI/CD Pipeline

# GitHub Actionsã®æ¨©é™è¨­å®š
permissions:
  contents: read
  security-events: write
  id-token: write # OIDCèªè¨¼ç”¨

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  NODE_VERSION: '18'
  AWS_REGION: 'ap-northeast-1'

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæœ€é€Ÿå®Ÿè¡Œï¼‰
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint check
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: TypeScript type check
        run: npm run type-check

  # å˜ä½“ãƒ†ã‚¹ãƒˆ
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          token: ${{ secrets.CODECOV_TOKEN }}

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Verify build output
        run: |
          echo "=== Checking build output ==="
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist directory not found"
            exit 1
          fi
          
          # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          main_files=("dist/index.js" "dist/lambda/handler.js")
          for file in "${main_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            else
              echo "âš ï¸  Not found: $file"
            fi
          done
          
          echo "Contents of dist directory:"
          find dist -name "*.js" -type f | head -10
          echo "âœ… Build verification completed"

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # CDKæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  cdk-synth:
    name: CDK Synth Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: CDK Synth (dry-run)
        run: npm run cdk:synth
        env:
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-test
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t crowdworks-searcher:test .
          echo "âœ… Docker build completed successfully"

      - name: Test Docker container
        run: |
          docker run --rm crowdworks-searcher:test node --version
          echo "âœ… Docker container test passed"

  # Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆdevelopãƒ–ãƒ©ãƒ³ãƒï¼‰
  # æ³¨æ„: AWSèªè¨¼æƒ…å ±ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼
  # GitHubãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
  # - STAGING_AWS_ACCESS_KEY_ID
  # - STAGING_AWS_SECRET_ACCESS_KEY
  # - STAGING_OPENAI_API_KEY
  # - STAGING_CROWDWORKS_EMAIL
  # - STAGING_CROWDWORKS_PASSWORD
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, build-test, cdk-synth, docker-build]
    # AWSèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã‚‹ã¾ã§ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    if: false # github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Deploy to staging
        run: |
          npm run cdk:deploy -- --context stage=staging --require-approval never
        env:
          STAGE: staging
          OPENAI_API_KEY: ${{ secrets.STAGING_OPENAI_API_KEY }}
          CROWDWORKS_EMAIL: ${{ secrets.STAGING_CROWDWORKS_EMAIL }}
          CROWDWORKS_PASSWORD: ${{ secrets.STAGING_CROWDWORKS_PASSWORD }}

      - name: Post-deployment smoke test
        run: |
          echo "ğŸ§ª Running staging smoke tests..."
          # åŸºæœ¬çš„ãªAWSãƒªã‚½ãƒ¼ã‚¹å­˜åœ¨ç¢ºèª
          aws lambda list-functions --query 'Functions[?contains(FunctionName, `CrowdWorks`)]' --output table
          echo "âœ… Staging deployment verification completed"

  # Productionç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒ + ã‚¿ã‚°ï¼‰
  # æ³¨æ„: AWSèªè¨¼æƒ…å ±ã®è¨­å®šãŒå¿…è¦ã§ã™ï¼
  # GitHubãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ä»¥ä¸‹ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
  # - PRODUCTION_AWS_ACCESS_KEY_ID
  # - PRODUCTION_AWS_SECRET_ACCESS_KEY
  # - PRODUCTION_OPENAI_API_KEY
  # - PRODUCTION_CROWDWORKS_EMAIL
  # - PRODUCTION_CROWDWORKS_PASSWORD
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, build-test, cdk-synth, security-scan]
    # AWSèªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã‚‹ã¾ã§ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    if: false # github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.PRODUCTION_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.PRODUCTION_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Deploy to production
        run: |
          npm run cdk:deploy -- --context stage=production --require-approval never
        env:
          STAGE: production
          OPENAI_API_KEY: ${{ secrets.PRODUCTION_OPENAI_API_KEY }}
          CROWDWORKS_EMAIL: ${{ secrets.PRODUCTION_CROWDWORKS_EMAIL }}
          CROWDWORKS_PASSWORD: ${{ secrets.PRODUCTION_CROWDWORKS_PASSWORD }}

      - name: Post-deployment verification
        run: |
          echo "ğŸš€ Production deployment completed"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          
          # åŸºæœ¬çš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          aws lambda list-functions --query 'Functions[?contains(FunctionName, `CrowdWorks`)]' --output table
          echo "âœ… Production deployment verification completed"

  # é€šçŸ¥ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, build-test, cdk-synth, security-scan]
    if: failure()
    
    steps:
      - name: Notify failure
        run: |
          echo "âŒ CI/CD Pipeline failed"
          echo "Workflow: ${{ github.workflow }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          # TODO: Slack/Discordé€šçŸ¥ã‚’å®Ÿè£…
</file>

<file path="readme.md">
# CrowdWorks è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ 

[![CI/CD Pipeline](https://github.com/masayuki-akinari/crowdworks-search/actions/workflows/ci.yml/badge.svg)](https://github.com/masayuki-akinari/crowdworks-search/actions/workflows/ci.yml)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.6.3-blue.svg)](https://www.typescriptlang.org/)
[![AWS CDK](https://img.shields.io/badge/AWS%20CDK-2.170.0-orange.svg)](https://aws.amazon.com/cdk/)

## ğŸ“‹ æ¦‚è¦

CrowdWorksã®æ¡ˆä»¶æƒ…å ±ã‚’è‡ªå‹•åé›†ãƒ»AIè©•ä¾¡ã—ã€é«˜è©•ä¾¡æ¡ˆä»¶ã‚’ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### ğŸš€ ä¸»è¦æ©Ÿèƒ½
- **è‡ªå‹•ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°**: Playwright + Chromiumã«ã‚ˆã‚‹15åˆ†é–“éš”å®Ÿè¡Œ
- **AIè©•ä¾¡**: OpenAI GPT-4ã«ã‚ˆã‚‹æ¡ˆä»¶å“è³ªè©•ä¾¡
- **ã‚¹ãƒãƒ¼ãƒˆé€šçŸ¥**: é«˜è©•ä¾¡æ¡ˆä»¶ã®å³åº§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: æœˆé¡$5ä»¥ä¸‹ã§ã®é‹ç”¨

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TB
    A[EventBridge] -->|15åˆ†é–“éš”| B[Lambda Function]
    B -->|ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°| C[CrowdWorks]
    B -->|AIè©•ä¾¡| D[OpenAI API]
    B -->|ãƒ‡ãƒ¼ã‚¿ä¿å­˜| E[S3 Bucket]
    B -->|é«˜è©•ä¾¡é€šçŸ¥| F[SNS/SES]
    G[CloudWatch] -->|ç›£è¦–| B
```

**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯:**
- **å®Ÿè¡Œç’°å¢ƒ**: AWS Lambda (ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸)
- **ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–**: Playwright + Chromium
- **AIè©•ä¾¡**: OpenAI GPT-4 API
- **ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Amazon S3
- **é€šçŸ¥**: Amazon SNS/SES
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°**: Amazon EventBridge
- **ã‚¤ãƒ³ãƒ•ãƒ©**: AWS CDK (TypeScript)

## âš ï¸ **é‡è¦: Playwright Lambdaåˆ¶ç´„ã¨å¯¾å¿œ**

### æŠ€è¡“çš„èª²é¡Œ
- **Lambda ZIPåˆ¶é™**: 250MBï¼ˆPlaywright: ~300MBï¼‰
- **ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒŠãƒª**: Chromiumå˜ä½“ã§200MB+

### âœ… **æ¡ç”¨æ–¹é‡: Lambdaã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸**

**é¸æŠç†ç”±:**
- âœ… **å®¹é‡åˆ¶é™**: 10GBã¾ã§å¯¾å¿œï¼ˆZIP: 250MB â†’ Container: 10GBï¼‰
- âœ… **å®Œå…¨æ©Ÿèƒ½**: ãƒ•ãƒ«Playwright + Chromiumç’°å¢ƒ
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ZIPç‰ˆã¨åŒç­‰ã®èµ·å‹•æ™‚é–“
- âœ… **é–‹ç™ºåŠ¹ç‡**: æ—¢å­˜Dockerfileã‚’æ´»ç”¨å¯èƒ½
- âœ… **é‹ç”¨ã‚³ã‚¹ãƒˆ**: æœˆ$5-10ã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿

```dockerfile
# ç¾åœ¨ã®Dockerfileæ§‹æˆ
FROM mcr.microsoft.com/playwright/python:v1.45.0-jammy
# â†’ Lambda Container Imageã¨ã—ã¦æ´»ç”¨
```

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. å‰ææ¡ä»¶
```bash
# å¿…è¦ãªãƒ„ãƒ¼ãƒ«
- Node.js 18+
- AWS CLI v2
- Docker Desktop
- AWS CDK CLI
```

### 2. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/masayuki-akinari/crowdworks-search.git
cd crowdworks-search

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# AWSèªè¨¼æƒ…å ±è¨­å®š
aws configure

# CDKåˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
npx cdk bootstrap
```

### 3. **ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰**
```bash
# ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
npm run cdk:deploy

# ã¾ãŸã¯æ‰‹å‹•ã§ã®æ®µéšå®Ÿè¡Œ
docker build -t crowdworks-searcher .
npx cdk deploy --context deployMethod=container
```

### 4. è¨­å®š
```bash
# AWS Parameter Storeã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
aws ssm put-parameter \
  --name "/crowdworks-search/openai-api-key" \
  --value "your-openai-api-key" \
  --type "SecureString"

aws ssm put-parameter \
  --name "/crowdworks-search/crowdworks-email" \
  --value "your-crowdworks-email" \
  --type "SecureString"
```

## ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜

### å®Ÿè¡Œã‚¹ãƒšãƒƒã‚¯
```yaml
Lambdaä»•æ§˜:
  ãƒ‡ãƒ—ãƒ­ã‚¤å½¢å¼: Container Image (ECR)
  ãƒ¡ãƒ¢ãƒª: 3,008 MB
  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 15åˆ†
  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: x86_64
  
Playwrightè¨­å®š:
  ãƒ–ãƒ©ã‚¦ã‚¶: Chromium (ãƒ•ãƒ«ç‰ˆ)
  ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰: true
  å®Ÿè¡Œé–“éš”: 15åˆ†
```

### ã‚³ã‚¹ãƒˆæ§‹é€ ï¼ˆæœˆé¡ï¼‰
```yaml
Lambdaå®Ÿè¡Œ:
  1,000å›/æœˆ Ã— 10ç§’: $2-5
ECRã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 
  1GB Docker Image: $0.10
CloudWatch:
  ãƒ­ã‚° & ç›£è¦–: $2-3
OpenAI API:
  GPT-4å‘¼ã³å‡ºã—: $1-2
åˆè¨ˆ: $5-10/æœˆ
```

## ğŸ”§ é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
```bash
# TypeScripté–‹ç™ºãƒ¢ãƒ¼ãƒ‰
npm run dev

# Dockerã§ã®ãƒ†ã‚¹ãƒˆ
npm run docker:build
npm run docker:run

# ãƒ­ãƒ¼ã‚«ãƒ«Playwrightå®Ÿè¡Œ
npx playwright install chromium
npm run test:e2e
```

### ãƒ­ã‚°ç¢ºèª
```bash
# CloudWatch Logsç¢ºèª
aws logs tail /aws/lambda/crowdworks-searcher-main --follow

# Lambdaå®Ÿè¡ŒçŠ¶æ³ç¢ºèª
aws lambda invoke \
  --function-name crowdworks-searcher-main \
  --payload '{}' \
  response.json
```

## ğŸ› ï¸ ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: è»½é‡ç‰ˆ

**äºˆç®—æœ€å„ªå…ˆã®å ´åˆ:**
```typescript
// @sparticuz/chromiumä½¿ç”¨ï¼ˆè»½é‡ç‰ˆï¼‰
import { chromium } from 'playwright-core';
import chromium_binary from '@sparticuz/chromium';

const browser = await chromium.launch({
  args: [...chromium_binary.args, '--no-sandbox'],
  executablePath: await chromium_binary.executablePath()
});
```

**åˆ¶ç´„:**
- æ©Ÿèƒ½åˆ¶é™ã‚ã‚Šï¼ˆè»½é‡Chromiumï¼‰
- Lambda Layerå¿…è¦
- ãƒ‡ãƒãƒƒã‚°å›°é›£

## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### è¨­è¨ˆæ›¸
- [ğŸ“‹ å®Ÿè£…è¨ˆç”»æ›¸](./docs/05_implementation_plan.md)
- [ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](./docs/01_architecture.md)
- [ğŸ”§ CI/CD ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](./docs/CI_CD_SETUP.md)

### é‹ç”¨ã‚¬ã‚¤ãƒ‰
- [ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰](./docs/02_deployment.md)
- [ğŸ“Š ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ](./docs/03_monitoring.md)
- [ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](./docs/04_security.md)

## ğŸ¯ ç¾åœ¨ã®é–‹ç™ºçŠ¶æ³

### âœ… å®Œäº†æ¸ˆã¿
- [x] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
- [x] TypeScript + CDKåŸºç›¤
- [x] Dockerç’°å¢ƒæ•´å‚™
- [x] Playwright Lambdaå¯¾å¿œç­–ç­–å®š

### ğŸ”„ é€²è¡Œä¸­
- [ ] **ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå‹•ä½œç¢ºèª**ï¼ˆæœ€å„ªå…ˆï¼‰
- [ ] CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè£…
- [ ] OpenAI APIé€£æº

### ğŸ“‹ ä»Šå¾Œã®äºˆå®š
- [ ] S3ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ©Ÿèƒ½
- [ ] ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ã‚¨ãƒ©ãƒ¼ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

## ğŸš¨ æ—¢çŸ¥ã®åˆ¶ç´„ãƒ»æ³¨æ„äº‹é …

### Playwrightåˆ¶ç´„
- âŒ **Lambda ZIPç‰ˆ**: ç¢ºå®Ÿã«å®¹é‡åˆ¶é™è¶…é
- âœ… **Containerç‰ˆ**: å‹•ä½œç¢ºèªæ¸ˆã¿ã€æ¨å¥¨
- âš ï¸ **è»½é‡ç‰ˆ**: æ©Ÿèƒ½åˆ¶é™ã‚ã‚Šã€äºˆç®—é‡è¦–å‘ã‘

### CrowdWorksåˆ¶ç´„
- **åˆ©ç”¨è¦ç´„éµå®ˆ**: éåº¦ãªã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: 15åˆ†é–“éš”ã§ã®ç©å¥ãªå®Ÿè¡Œ
- **ä»•æ§˜å¤‰æ›´ãƒªã‚¹ã‚¯**: ã‚µã‚¤ãƒˆå¤‰æ›´ã¸ã®å¯¾å¿œå¿…è¦

### ã‚³ã‚¹ãƒˆåˆ¶ç´„
- **æœˆé¡ç›®æ¨™**: $5ä»¥ä¸‹
- **å®Ÿæ¸¬å€¤**: ã‚³ãƒ³ãƒ†ãƒŠç‰ˆã§$5-10
- **ç›£è¦–**: AWS Cost Explorerè¨­å®šæ¸ˆã¿

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

### ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–
- TypeScript strict modeå¿…é ˆ
- anyå‹ä½¿ç”¨ç¦æ­¢
- 80%ä»¥ä¸Šã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- ESLint + Prettierãƒ«ãƒ¼ãƒ«éµå®ˆ

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License - è©³ç´°ã¯ [LICENSE](./LICENSE) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

- **Issueå ±å‘Š**: [GitHub Issues](https://github.com/masayuki-akinari/crowdworks-search/issues)
- **è³ªå•ãƒ»ç›¸è«‡**: [GitHub Discussions](https://github.com/masayuki-akinari/crowdworks-search/discussions)

---

**âš¡ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: [å®Ÿè£…è¨ˆç”»æ›¸](./docs/05_implementation_plan.md) ã§è©³ç´°ãªé–‹ç™ºãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
</file>

<file path="src/lambda/handler.ts">
/**
 * AWS Lambda Handler for CrowdWorks Search System
 * EventBridge ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œç”¨ã®ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */

// ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã®ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
if (!process.env['AWS_LAMBDA_FUNCTION_NAME']) {
  // Lambdaç’°å¢ƒã§ã¯ãªã„å ´åˆã®ã¿dotenvã‚’ãƒ­ãƒ¼ãƒ‰
  try {
    require('dotenv').config();
    console.log('ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  } catch (error) {
    console.log('âš ï¸ dotenvãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆLambdaç’°å¢ƒã§ã¯æ­£å¸¸ï¼‰');
  }
}

import { Context } from 'aws-lambda';
import { chromium, Browser, Page } from 'playwright';
import { SSMClient, GetParameterCommand } from '@aws-sdk/client-ssm';

// AWS SSM Client for Parameter Store
const ssmClient = new SSMClient({ region: process.env['AWS_REGION'] || 'ap-northeast-1' });

// Lambda Event Types
interface ScheduledExecutionEvent {
  source: string;
  'detail-type': string;
  detail: Record<string, any>;
  time?: string;
}

interface ScheduledExecutionResponse {
  statusCode: number;
  body: string;
  executionTime: number;
  timestamp: string;
}

// CrowdWorksèªè¨¼æƒ…å ±
interface CrowdWorksCredentials {
  email: string;
  password: string;
}

// ãƒ­ã‚°ã‚¤ãƒ³çµæœ
interface LoginResult {
  success: boolean;
  isLoggedIn: boolean;
  error?: string;
  executionTime: number;
}

// CrowdWorksæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹
interface CrowdWorksJob {
  id: string;
  title: string;
  description: string;
  url: string;
  budget: {
    type: 'fixed' | 'hourly' | 'unknown';
    amount: number;
    currency: string;
  };
  category: string;
  tags: string[];
  client: {
    name: string;
    rating: number;
    reviewCount: number;
  };
  postedAt: string;
  deadline?: string;
  applicants: number;
  scrapedAt: string; // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ—¥æ™‚
}

// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœå‹
interface ScrapingResult {
  success: boolean;
  jobsFound: number;
  jobs: CrowdWorksJob[];
  error?: string;
  executionTime: number;
}

// æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒ¡ãƒ¢ãƒªå†…é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
const scrapedJobsCache = new Set<string>();

// æ¡ˆä»¶è©³ç´°æƒ…å ±ã®å‹å®šç¾©
interface CrowdWorksJobDetail {
  // åŸºæœ¬æƒ…å ±
  jobId: string;
  title: string;
  category: string;
  url: string;

  // ä»•äº‹ã®æ¦‚è¦
  paymentType: string;    // å›ºå®šå ±é…¬åˆ¶/æ™‚é–“å˜ä¾¡åˆ¶
  budget: string;         // äºˆç®—ç¯„å›²
  deliveryDate: string;   // ç´å“å¸Œæœ›æ—¥
  postDate: string;       // æ²è¼‰æ—¥
  applicationDeadline: string; // å¿œå‹ŸæœŸé™
  desiredImages: string[];  // å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆå˜è‰²ã€ã‚«ãƒ©ãƒ•ãƒ«ç­‰ï¼‰

  // å¿œå‹ŸçŠ¶æ³
  applicantCount: number;    // å¿œå‹Ÿã—ãŸäººæ•°
  contractCount: number;     // å¥‘ç´„ã—ãŸäººæ•°
  recruitmentCount: number;  // å‹Ÿé›†äººæ•°
  favoriteCount: number;     // æ°—ã«ãªã‚‹ï¼ãƒªã‚¹ãƒˆäººæ•°

  // è©³ç´°ãªä»•äº‹å†…å®¹
  detailedDescription: string; // è©³ç´°ãªä¾é ¼å†…å®¹

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
  client: {
    name: string;
    url: string;
    overallRating: string;     // ç·åˆè©•ä¾¡
    orderHistory: string;      // å‹Ÿé›†å®Ÿç¸¾
    completionRate: string;    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ç‡
    thankCount: string;        // ã‚ã‚ŠãŒã¨ã†ä»¶æ•°
    identityVerified: boolean; // æœ¬äººç¢ºèª
    orderRuleCheck: boolean;   // ç™ºæ³¨ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
    description: string;       // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èª¬æ˜
  };

  // å¿œå‹Ÿè€…æƒ…å ±ï¼ˆæœ€æ–°ã®æ•°ä»¶ï¼‰
  recentApplicants: Array<{
    name: string;
    url: string;
    applicationDate: string;
  }>;

  // å–å¾—æ—¥æ™‚
  scrapedAt: string;
}

/**
 * AWS Parameter Storeã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
 * ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã¯ç’°å¢ƒå¤‰æ•°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œ
 */
async function getCrowdWorksCredentials(): Promise<CrowdWorksCredentials> {
  try {
    console.log('ğŸ” CrowdWorksèªè¨¼æƒ…å ±ã‚’å–å¾—ä¸­...');

    // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’å„ªå…ˆ
    const isLocal = !process.env['AWS_LAMBDA_FUNCTION_NAME'];

    if (isLocal) {
      console.log('ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’æ¤œå‡ºã€ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—...');

      const envEmail = process.env['CROWDWORKS_EMAIL'];
      const envPassword = process.env['CROWDWORKS_PASSWORD'];

      if (envEmail && envPassword) {
        console.log('âœ… ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—å®Œäº†');
        return { email: envEmail, password: envPassword };
      }

      console.log('âš ï¸ ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Parameter Storeã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯...');
    }

    // Parameter Storeã‹ã‚‰å–å¾—ï¼ˆLambdaç’°å¢ƒã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    console.log('â˜ï¸ AWS Parameter Storeã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—ä¸­...');

    const [emailParam, passwordParam] = await Promise.all([
      ssmClient.send(new GetParameterCommand({
        Name: '/crowdworks-search/crowdworks/email',
        WithDecryption: true
      })),
      ssmClient.send(new GetParameterCommand({
        Name: '/crowdworks-search/crowdworks/password',
        WithDecryption: true
      }))
    ]);

    const email = emailParam.Parameter?.Value;
    const password = passwordParam.Parameter?.Value;

    if (!email || !password) {
      throw new Error('CrowdWorksèªè¨¼æƒ…å ±ãŒParameter Storeã§è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    console.log('âœ… Parameter Storeã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—å®Œäº†');
    return { email, password };

  } catch (error) {
    console.error('âŒ èªè¨¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);

    // ã‚¨ãƒ©ãƒ¼è©³ç´°æƒ…å ±ã‚’æä¾›
    if (error instanceof Error) {
      if (error.message.includes('ParameterNotFound')) {
        throw new Error('Parameter Storeã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¦ãã ã•ã„:\n' +
          'aws ssm put-parameter --name "/crowdworks-search/crowdworks/email" --value "your-email" --type "SecureString"\n' +
          'aws ssm put-parameter --name "/crowdworks-search/crowdworks/password" --value "your-password" --type "SecureString"');
      }
      if (error.message.includes('AccessDenied')) {
        throw new Error('Parameter Storeã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚IAMãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
    }

    throw new Error(`èªè¨¼æƒ…å ±å–å¾—å¤±æ•—: ${error instanceof Error ? error.message : String(error)}`);
  }
}

/**
 * CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
 */
async function loginToCrowdWorks(page: Page, credentials: CrowdWorksCredentials): Promise<LoginResult> {
  const startTime = Date.now();

  try {
    console.log('ğŸšª CrowdWorksãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹...');

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    console.log('ğŸ“„ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
    await page.goto('https://crowdworks.jp/login', {
      waitUntil: 'domcontentloaded', // networkidleã‚ˆã‚Šè»½é‡ãªè¨­å®š
      timeout: 30000
    });

    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    const title = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: ${title}`);

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®è¦ç´ ã‚’å¾…æ©Ÿï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ­£ç¢ºãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ï¼‰
    console.log('â³ ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’å¾…æ©Ÿä¸­...');
    await page.waitForSelector('input[name="email"], [role="textbox"][aria-label*="ãƒ¡ãƒ¼ãƒ«"], textbox', {
      timeout: 10000
    });

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸPlaywrightæ–¹å¼ï¼‰
    console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ä¸­...');
    try {
      // getByRoleæ–¹å¼ï¼ˆMCPã§ç¢ºèªã—ãŸæ–¹æ³•ï¼‰
      await page.getByRole('textbox', { name: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹' }).fill(credentials.email);
      console.log('âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›å®Œäº†ï¼ˆgetByRoleæ–¹å¼ï¼‰');
    } catch (roleError) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼
      console.log('âš ï¸ getByRoleå¤±æ•—ã€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ã§ãƒªãƒˆãƒ©ã‚¤...');
      const emailSelector = 'input[name="email"], input[type="email"], textbox[name*="email"]';
      await page.fill(emailSelector, credentials.email);
      console.log('âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›å®Œäº†ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ï¼‰');
    }

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ–¹å¼ï¼‰
    console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ä¸­...');
    try {
      // getByRoleæ–¹å¼ï¼ˆMCPã§ç¢ºèªã—ãŸæ–¹æ³•ï¼‰
      await page.getByRole('textbox', { name: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰' }).fill(credentials.password);
      console.log('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å®Œäº†ï¼ˆgetByRoleæ–¹å¼ï¼‰');
    } catch (roleError) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼
      console.log('âš ï¸ getByRoleå¤±æ•—ã€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ã§ãƒªãƒˆãƒ©ã‚¤...');
      const passwordSelector = 'input[name="password"], input[type="password"]';
      await page.fill(passwordSelector, credentials.password);
      console.log('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å®Œäº†ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ï¼‰');
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ–¹å¼ï¼‰
    console.log('ğŸ–±ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ä¸­...');
    try {
      // getByRoleæ–¹å¼ï¼ˆMCPã§ç¢ºèªã—ãŸæ–¹æ³•ï¼‰
      await page.getByRole('button', { name: 'ãƒ­ã‚°ã‚¤ãƒ³', exact: true }).click();
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Œäº†ï¼ˆgetByRoleæ–¹å¼ï¼‰');
    } catch (roleError) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šå¾“æ¥ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼
      console.log('âš ï¸ getByRoleå¤±æ•—ã€ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ã§ãƒªãƒˆãƒ©ã‚¤...');
      const loginButtonSelector = 'input[type="submit"], button[type="submit"], button:has-text("ãƒ­ã‚°ã‚¤ãƒ³")';
      await page.click(loginButtonSelector);
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Œäº†ï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ–¹å¼ï¼‰');
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†å®Œäº†ã‚’å¾…æ©Ÿ
    console.log('â³ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†å®Œäº†å¾…æ©Ÿä¸­...');
    await page.waitForTimeout(3000); // 3ç§’å¾…æ©Ÿã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª

    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ/å¤±æ•—ã‚’ç¢ºèª
    console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³çµæœç¢ºèªä¸­...');
    const currentUrl = page.url();
    console.log(`ğŸ“‹ ç¾åœ¨ã®URL: ${currentUrl}`);

    // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸã‚¨ãƒ©ãƒ¼è¦ç´ ï¼‰
    const loginStatus = await page.evaluate(() => {
      // æ¨™æº–çš„ãªCSSã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ï¼ˆ:has-text()ã¯ç„¡åŠ¹ãªã®ã§å‰Šé™¤ï¼‰
      const errorGroups = (globalThis as any).document.querySelectorAll('[role="group"]');
      const allElements = (globalThis as any).document.querySelectorAll('*');

      let hasErrorGroup = false;
      let hasErrorMessage = false;
      let errorText = '';

      // ã‚¨ãƒ©ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¢ã™
      for (const group of errorGroups) {
        if (group.textContent?.includes('å…¥åŠ›å†…å®¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™')) {
          hasErrorGroup = true;
          break;
        }
      }

      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™  
      for (const element of allElements) {
        if (element.textContent?.includes('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“')) {
          hasErrorMessage = true;
          errorText = element.textContent.trim();
          break;
        }
      }

      const generalError = (globalThis as any).document.querySelector('.error, .alert, .notice, [class*="error"]');

      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã®åˆ¤å®šè¦ç´ 
      const userMenu = (globalThis as any).document.querySelector('a[href*="logout"], .user-menu, .header-user-menu, [href*="mypage"]');
      const dashboard = (globalThis as any).document.querySelector('.dashboard, [class*="dashboard"], .mypage');

      return {
        hasErrorGroup,
        hasErrorMessage,
        hasGeneralError: !!generalError,
        hasUserMenu: !!userMenu,
        hasDashboard: !!dashboard,
        currentPath: (globalThis as any).window.location.pathname,
        isLoginPage: (globalThis as any).window.location.pathname.includes('/login'),
        errorText: errorText || generalError?.textContent || ''
      };
    });

    const executionTime = Date.now() - startTime;

    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸåˆ¤å®š
    const hasError = loginStatus.hasErrorGroup || loginStatus.hasErrorMessage || loginStatus.hasGeneralError;
    const hasSuccess = loginStatus.hasUserMenu || loginStatus.hasDashboard || !loginStatus.isLoginPage;
    const loginSuccess = !hasError && hasSuccess;

    console.log('ğŸ“Š ãƒ­ã‚°ã‚¤ãƒ³çµæœè©³ç´°:');
    console.log(`   ã‚¨ãƒ©ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—: ${loginStatus.hasErrorGroup ? 'âŒ' : 'âœ…'}`);
    console.log(`   ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${loginStatus.hasErrorMessage ? 'âŒ' : 'âœ…'}`);
    console.log(`   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ${loginStatus.hasUserMenu ? 'âœ…' : 'âŒ'}`);
    console.log(`   ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸: ${loginStatus.isLoginPage ? 'âŒ' : 'âœ…'}`);
    console.log(`   ç¾åœ¨ã®ãƒ‘ã‚¹: ${loginStatus.currentPath}`);

    if (loginSuccess) {
      console.log('âœ… CrowdWorksãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼');
      return {
        success: true,
        isLoggedIn: true,
        executionTime
      };
    } else {
      console.log('âŒ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
      const errorDetail = loginStatus.errorText || 'ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®çŠ¶æ…‹ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º';
      console.log(`ğŸ“‹ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorDetail}`);

      return {
        success: false,
        isLoggedIn: false,
        error: errorDetail,
        executionTime
      };
    }

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      isLoggedIn: false,
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * PlaywrightåŸºæœ¬å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ
 */
async function testPlaywrightBasic(): Promise<{
  success: boolean;
  chromiumVersion?: string;
  title?: string;
  screenshot?: boolean;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ Playwright Chromiumèµ·å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // Chromiumèµ·å‹•ï¼ˆLambda Containeræœ€é©åŒ–è¨­å®šï¼‰
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      // Lambdaç’°å¢ƒã§ã®Chromiumå®Ÿè¡Œãƒ‘ã‚¹
      executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
        ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
        : '/usr/bin/chromium',
    });

    console.log('âœ… Chromiumèµ·å‹•æˆåŠŸ');

    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1280, height: 720 },
    });

    const page: Page = await context.newPage();
    console.log('ğŸ“„ ãƒšãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†');

    // åŸºæœ¬ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
    console.log('ğŸŒ Google ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    await page.goto('https://www.google.com', {
      waitUntil: 'networkidle',
      timeout: 30000
    });

    const title = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«å–å¾—: "${title}"`);

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼ˆLambdaç’°å¢ƒç¢ºèªç”¨ï¼‰
    try {
      await page.screenshot({
        path: '/tmp/test-screenshot.png',
        fullPage: false
      });
      console.log('ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜æˆåŠŸ: /tmp/test-screenshot.png');
    } catch (screenshotError) {
      console.warn('âš ï¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜å¤±æ•—:', screenshotError);
    }

    // Chromiumãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±å–å¾—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå†…ã§å®Ÿè¡Œï¼‰
    const chromiumVersion = await page.evaluate(() => {
      // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå†…ãªã®ã§navigatorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨å¯èƒ½
      return (globalThis as any).navigator.userAgent;
    });

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`âœ… PlaywrightåŸºæœ¬ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: true,
      chromiumVersion,
      title,
      screenshot: true,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ Playwright ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);
    console.error('Stack trace:', error instanceof Error ? error.stack : 'No stack trace');

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
 */
async function scrapeCrowdWorksJobs(page: Page, maxJobs: number = 10): Promise<ScrapingResult> {
  const startTime = Date.now();

  try {
    console.log('ğŸ” CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...');

    // CrowdWorkså…¬é–‹æ¡ˆä»¶ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    console.log('ğŸ“„ CrowdWorksæ¡ˆä»¶ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
    await page.goto('https://crowdworks.jp/public/jobs', {
      waitUntil: 'networkidle',
      timeout: 30000
    });

    console.log('âœ… CrowdWorksãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    const pageTitle = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: "${pageTitle}"`);

    // æ¡ˆä»¶ä¸€è¦§ã®è¦ç´ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    console.log('â³ æ¡ˆä»¶ä¸€è¦§èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
    await page.waitForSelector('.search_result', { timeout: 10000 });

    // æ¡ˆä»¶è¦ç´ ã‚’å–å¾—
    console.log('ğŸ“ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...');
    const jobs: CrowdWorksJob[] = await page.evaluate((params: { maxJobsLimit: number; categoryName: string; scrapedIds: string[] }) => {
      // Playwrightã§ã®HTMLè¦ç´ ã«å¯¾å¿œã—ãŸã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
      const jobSelectors = [
        'main li',             // mainè¦ç´ å†…ã®liè¦ç´ ï¼ˆæœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„ï¼‰
        'ul li',               // ä¸€èˆ¬çš„ãªãƒªã‚¹ãƒˆæ§‹é€ 
        'ol li',               // é †åºä»˜ããƒªã‚¹ãƒˆ
        '.job-list li',        // æ¡ˆä»¶ãƒªã‚¹ãƒˆå†…ã®li
        'li',                  // å…¨ã¦ã®liè¦ç´ 
        '.job-item',           // æ¡ˆä»¶ã‚¢ã‚¤ãƒ†ãƒ ç”¨ã‚¯ãƒ©ã‚¹
        '[data-job-id]'        // job-idå±æ€§ã‚’æŒã¤è¦ç´ 
      ];

      let jobElements: any = null;
      let usedSelector = '';

      for (const selector of jobSelectors) {
        const elements = (globalThis as any).document.querySelectorAll(selector);
        if (elements.length > 0) {
          jobElements = elements;
          usedSelector = selector;
          console.log(`âœ… æ¡ˆä»¶è¦ç´ ç™ºè¦‹: ${selector} (${elements.length}ä»¶)`);
          break;
        }
      }

      if (!jobElements || jobElements.length === 0) {
        console.log('âŒ æ¡ˆä»¶è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        // ãƒ‡ãƒãƒƒã‚°: ãƒšãƒ¼ã‚¸ã®ä¸»è¦ãªè¦ç´ ã‚’ç¢ºèª
        const mainElements = (globalThis as any).document.querySelectorAll('main, .main, #main');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: mainè¦ç´ æ•°:', mainElements.length);

        // å®Ÿéš›ã«ã‚ã‚‹è¦ç´ ã‚’èª¿æŸ»
        const allLists = (globalThis as any).document.querySelectorAll('ul, ol');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒªã‚¹ãƒˆè¦ç´ æ•°:', allLists.length);

        const allListItems = (globalThis as any).document.querySelectorAll('li');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ è¦ç´ æ•°:', allListItems.length);

        // å…¨ã¦ã®è¦‹å‡ºã—è¦ç´ ã‚’ç¢ºèª
        const allHeadings = (globalThis as any).document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: è¦‹å‡ºã—è¦ç´ æ•°:', allHeadings.length);

        // å…¨ã¦ã®ãƒªãƒ³ã‚¯è¦ç´ ã‚’ç¢ºèª
        const allLinks = (globalThis as any).document.querySelectorAll('a');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒªãƒ³ã‚¯è¦ç´ æ•°:', allLinks.length);

        // æ¡ˆä»¶URLã‚’å«ã‚€ãƒªãƒ³ã‚¯ã‚’ç¢ºèª
        const jobLinks = (globalThis as any).document.querySelectorAll('a[href*="/public/jobs/"]');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: æ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°:', jobLinks.length);

        return [];
      }

      const jobs: any[] = [];
      console.log(`ğŸ“Š ${jobElements.length}ä»¶ã®æ¡ˆä»¶è¦ç´ ã‚’å‡¦ç†ä¸­...`);

      for (let i = 0; i < Math.min(jobElements.length, params.maxJobsLimit); i++) {
        try {
          const jobElement = jobElements[i];

          // å®Ÿéš›ã®HTMLè¦ç´ ã§ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã‚’æ¤œç´¢
          const titleElement = jobElement.querySelector('h3 a, h2 a, h4 a, .title a, a[href*="/public/jobs/"], a[href*="/jobs/"]');
          const title = titleElement?.textContent?.trim() || titleElement?.innerText?.trim() || `æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜_${i}`;

          // hrefå±æ€§ã‹ã‚‰æ¡ˆä»¶URLã‚’å–å¾—
          const href = titleElement?.getAttribute('href') || '';
          const url = href ? (href.startsWith('http') ? href : `https://crowdworks.jp${href}`) : '';

          // æ¡ˆä»¶IDã‚’URLã‹ã‚‰æŠ½å‡º
          const jobIdMatch = url.match(/\/public\/jobs\/(\d+)/);
          const jobId = jobIdMatch ? jobIdMatch[1] : `unknown_${i}`;

          // é‡è¤‡ãƒã‚§ãƒƒã‚¯
          if (params.scrapedIds.includes(jobId)) {
            console.log(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: é‡è¤‡æ¡ˆä»¶ ${jobId}`);
            continue;
          }

          // æ¦‚è¦ - å®Ÿéš›ã®HTMLè¦ç´ ã‹ã‚‰å–å¾—
          const descriptionElement = jobElement.querySelector('p, div, span');
          let description = '';
          if (descriptionElement) {
            description = descriptionElement.textContent?.trim() || descriptionElement.innerText?.trim() || '';
          }

          // æ–™é‡‘æƒ…å ± - å…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‹ã‚‰æ¤œç´¢
          const allElements = jobElement.querySelectorAll('*');
          let budgetText = '';

          for (const element of allElements) {
            const text = element?.textContent?.trim() || '';
            if (text.includes('å††') || text.includes('å›ºå®šå ±é…¬åˆ¶') || text.includes('æ™‚é–“å˜ä¾¡åˆ¶') || text.includes('ã‚³ãƒ³ãƒš')) {
              budgetText = text;
              break;
            }
          }

          // ã‚«ãƒ†ã‚´ãƒª - ãƒªãƒ³ã‚¯è¦ç´ ã‹ã‚‰å–å¾—
          const categoryLinks = jobElement.querySelectorAll('a');
          let category = params.categoryName;
          for (const link of categoryLinks) {
            const linkText = link?.textContent?.trim() || '';
            const href = link?.getAttribute('href') || '';
            if (href.includes('/public/jobs/category/') && linkText && linkText.length < 30) {
              category = linkText;
              break;
            }
          }

          // ã‚¹ã‚­ãƒ«/ã‚¿ã‚° - ãƒªãƒ³ã‚¯è¦ç´ ã‹ã‚‰æŠ½å‡º
          const skillLinks = jobElement.querySelectorAll('a');
          const tags: string[] = [];
          skillLinks.forEach((skillItem: any) => {
            const skillText = skillItem?.textContent?.trim();
            const href = skillItem?.getAttribute('href') || '';
            if (skillText && href.includes('/skill/') && skillText.length > 0 && skillText.length < 50) {
              tags.push(skillText);
            }
          });

          // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ± - ãƒªãƒ³ã‚¯è¦ç´ ã‹ã‚‰å–å¾—
          const clientLinks = jobElement.querySelectorAll('a');
          let clientName = 'åŒ¿å';
          for (const link of clientLinks) {
            const linkText = link?.textContent?.trim() || '';
            const href = link?.getAttribute('href') || '';
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‚’æ¢ã™
            if (linkText && href.includes('/public/employers/') && !href.includes('/public/jobs/') && linkText.length < 50) {
              clientName = linkText;
              break;
            }
          }

          // æ²è¼‰æ—¥æ™‚ - timeè¦ç´ ã‹ã‚‰å–å¾—
          const timeElement = jobElement.querySelector('time');
          const postedAt = timeElement?.textContent?.trim() || timeElement?.innerText?.trim() || new Date().toISOString().split('T')[0];

          // å¿œå‹Ÿè€…æ•°ã¨æœŸé™ - ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æŠ½å‡º
          let applicantCount = 0;
          let deadline = '';

          allElements.forEach((element: any) => {
            const text = element?.textContent?.trim() || '';

            // å¥‘ç´„æ•°ã‚’æŠ½å‡º
            const contractMatch = text.match(/å¥‘ç´„æ•°[^\d]*(\d+)/);
            if (contractMatch) {
              applicantCount = parseInt(contractMatch[1]) || 0;
            }

            // æœŸé™ã‚’æŠ½å‡º
            const deadlineMatch = text.match(/ã‚ã¨(\d+)æ—¥|(\d+æœˆ\d+æ—¥)/);
            if (deadlineMatch) {
              deadline = text;
            }
          });

          const job = {
            id: jobId,
            title: title,
            url: url,
            description: description.substring(0, 500), // é•·ã™ãã‚‹å ´åˆã¯åˆ‡ã‚Šè©°ã‚
            budget: budgetText,
            category: category,
            tags: tags.slice(0, 10), // æœ€å¤§10å€‹ã®ã‚¿ã‚°
            clientName: clientName,
            postedAt: postedAt,
            applicantCount: applicantCount,
            deadline: deadline,
            scrapedAt: new Date().toISOString()
          };

          jobs.push(job);
          console.log(`âœ… æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºæˆåŠŸ: ${job.title} (${job.id})`);

        } catch (error) {
          console.log(`âŒ æ¡ˆä»¶ ${i} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
          continue;
        }
      }

      console.log(`ğŸ“Š åˆè¨ˆ ${jobs.length} ä»¶ã®æ¡ˆä»¶ã‚’æŠ½å‡ºã—ã¾ã—ãŸ (ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼: ${usedSelector})`);
      return jobs;
    }, { maxJobsLimit: maxJobs, categoryName: 'all', scrapedIds: Array.from(scrapedJobsCache) });

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
    jobs.forEach((job: CrowdWorksJob) => scrapedJobsCache.add(job.id));

    const executionTime = Date.now() - startTime;

    console.log(`ğŸ‰ CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†:`);
    console.log(`   ğŸ“Š å–å¾—æ¡ˆä»¶æ•°: ${jobs.length}`);
    console.log(`   â±ï¸ å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);

    // ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
    if (jobs.length > 0) {
      console.log(`ğŸ“ ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶æƒ…å ±:`);
      const sample = jobs[0];
      if (sample) {
        console.log(`   ğŸ·ï¸ ã‚¿ã‚¤ãƒˆãƒ«: ${sample.title}`);
        console.log(`   ğŸ’° äºˆç®—: ${sample.budget.type} ${sample.budget.amount}å††`);
        console.log(`   ğŸ¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ${sample.client.name} (è©•ä¾¡: ${sample.client.rating}/5)`);
        console.log(`   ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª: ${sample.category}`);
        console.log(`   ğŸ”— URL: ${sample.url}`);
      }
    }

    return {
      success: true,
      jobsFound: jobs.length,
      jobs,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      jobsFound: 0,
      jobs: [],
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆPlaywrightçµ±åˆç‰ˆï¼‰
 */
async function testCrowdWorksScraping(): Promise<{
  success: boolean;
  scrapingResult?: ScrapingResult;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // Chromiumèµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
        ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
        : '/usr/bin/chromium',
    });

    console.log('âœ… Chromiumèµ·å‹•æˆåŠŸ');

    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1920, height: 1080 },
      // æ—¥æœ¬èªç’°å¢ƒè¨­å®š
      locale: 'ja-JP',
      timezoneId: 'Asia/Tokyo',
    });

    const page = await context.newPage();

    // CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
    const scrapingResult = await scrapeCrowdWorksJobs(page, 5); // ãƒ†ã‚¹ãƒˆç”¨ã«5ä»¶å–å¾—

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`âœ… CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: scrapingResult.success,
      scrapingResult,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
 */
async function testCrowdWorksLogin(): Promise<{
  success: boolean;
  loginResult?: LoginResult;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // èªè¨¼æƒ…å ±ã‚’å–å¾—
    const credentials = await getCrowdWorksCredentials();

    // Chromiumèµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
        ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
        : '/usr/bin/chromium',
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1280, height: 720 },
    });

    const page = await context.newPage();

    // CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    const loginResult = await loginToCrowdWorks(page, credentials);

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`âœ… CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: true,
      loginResult,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªåˆ¥CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
 */
async function scrapeCrowdWorksJobsByCategory(
  page: Page,
  category: string,
  maxJobs: number = 20
): Promise<ScrapingResult> {
  const startTime = Date.now();

  try {
    console.log(`ğŸ” ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã®æ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...`);

    // ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã®URLæ§‹ç¯‰
    const categoryUrl = `https://crowdworks.jp/public/jobs/group/${category}`;
    console.log(`ğŸ“„ ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹: ${categoryUrl}`);

    await page.goto(categoryUrl, {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });

    console.log('âœ… ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    const pageTitle = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: "${pageTitle}"`);

    // æ–°ç€é †ã‚½ãƒ¼ãƒˆã‚’è¨­å®š
    console.log('ğŸ”„ æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šä¸­...');
    try {
      // ç¾åœ¨ã®å®Ÿéš›ã®CrowdWorksãƒšãƒ¼ã‚¸æ§‹é€ ã«åŸºã¥ãã‚½ãƒ¼ãƒˆè¨­å®š

      // ã¾ãšã€ã‚½ãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¦ç´ ã®å¾…æ©Ÿ
      await page.waitForSelector('combobox', { timeout: 5000 });

      // ã‚½ãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ–°ç€é †ã«å¤‰æ›´
      const sortDropdown = await page.$('combobox');
      if (sortDropdown) {
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦é–‹ã
        await sortDropdown.click();
        await page.waitForTimeout(500);

        // ã€Œæ–°ç€ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
        try {
          await page.selectOption('combobox', { label: 'æ–°ç€' });
          console.log('âœ… æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šå®Œäº†ï¼ˆselectOptionä½¿ç”¨ï¼‰');
        } catch (selectError) {
          // selectOption ãŒå¤±æ•—ã—ãŸå ´åˆã¯ã€æ‰‹å‹•ã§ã€Œæ–°ç€ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯
          const newOption = await page.$('option:has-text("æ–°ç€")');
          if (newOption) {
            await newOption.click();
            console.log('âœ… æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šå®Œäº†ï¼ˆoptionã‚¯ãƒªãƒƒã‚¯ä½¿ç”¨ï¼‰');
          } else {
            console.log('âš ï¸ æ–°ç€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        }

        // ã‚½ãƒ¼ãƒˆå¤‰æ›´å¾Œã®ãƒšãƒ¼ã‚¸æ›´æ–°ã‚’å¾…æ©Ÿ
        await page.waitForTimeout(2000);

        // URLã« order=new ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        const currentUrl = page.url();
        if (currentUrl && currentUrl.includes('order=new')) {
          console.log('âœ… æ–°ç€é †URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç¢ºèªæ¸ˆã¿');
        } else {
          console.log('âš ï¸ æ–°ç€é †URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒç¢ºèªã§ãã¾ã›ã‚“ã€‚ç›´æ¥URLã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œã—ã¾ã™ã€‚');

          // ç›´æ¥æ–°ç€é †URLã«ã‚¢ã‚¯ã‚»ã‚¹
          const baseUrl = currentUrl || `https://crowdworks.jp/public/jobs/group/${category}`;
          const newUrl = baseUrl.includes('?')
            ? `${baseUrl}&order=new`
            : `${baseUrl}?order=new`;

          await page.goto(newUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });
          console.log(`âœ… æ–°ç€é †URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹: ${newUrl}`);
        }
      } else {
        console.log('âš ï¸ ã‚½ãƒ¼ãƒˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç›´æ¥URLã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œã—ã¾ã™ã€‚');

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç›´æ¥æ–°ç€é †URLã«ã‚¢ã‚¯ã‚»ã‚¹
        const currentUrl = page.url();
        const baseUrl = currentUrl || `https://crowdworks.jp/public/jobs/group/${category}`;
        const newUrl = baseUrl.includes('?')
          ? `${baseUrl}&order=new`
          : `${baseUrl}?order=new`;

        await page.goto(newUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });
        console.log(`âœ… æ–°ç€é †URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰: ${newUrl}`);
      }

    } catch (sortError) {
      console.log('âš ï¸ ã‚½ãƒ¼ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼ã€‚æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ç›´æ¥URLã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚');

      // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç›´æ¥æ–°ç€é †URLã«ã‚¢ã‚¯ã‚»ã‚¹
      try {
        const currentUrl = page.url();
        const baseUrl = currentUrl || `https://crowdworks.jp/public/jobs/group/${category}`;
        const newUrl = baseUrl.includes('?')
          ? `${baseUrl}&order=new`
          : `${baseUrl}?order=new`;

        await page.goto(newUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });
        console.log(`âœ… æ–°ç€é †URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰: ${newUrl}`);
      } catch (finalError) {
        console.log(`âŒ æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šã«å®Œå…¨ã«å¤±æ•—ã—ã¾ã—ãŸ: ${finalError}`);
        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚½ãƒ¼ãƒˆé †åºã§ç¶šè¡Œã—ã¾ã™ã€‚');
      }
    }

    // æ¡ˆä»¶ä¸€è¦§ã®è¦ç´ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    console.log('â³ æ¡ˆä»¶ä¸€è¦§èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
    const listSelectors = [
      '.search_result',
      '.project-list',
      '.job-list',
      '[class*="project"]',
      '.list-item'
    ];

    let listFound = false;
    for (const selector of listSelectors) {
      try {
        await page.waitForSelector(selector, { timeout: 5000 });
        console.log(`âœ… æ¡ˆä»¶ä¸€è¦§ç™ºè¦‹: ${selector}`);
        listFound = true;
        break;
      } catch (error) {
        // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ¬¡ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è©¦è¡Œ
      }
    }

    if (!listFound) {
      console.log('âš ï¸ æ¡ˆä»¶ä¸€è¦§è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    // æ¡ˆä»¶è¦ç´ ã‚’å–å¾—
    console.log('ğŸ“ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...');
    const jobs: CrowdWorksJob[] = await page.evaluate((params: { maxJobsLimit: number; categoryName: string; scrapedIds: string[] }) => {
      // Playwrightã§ã®HTMLè¦ç´ ã«å¯¾å¿œã—ãŸã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
      const jobSelectors = [
        'main li',             // mainè¦ç´ å†…ã®liè¦ç´ ï¼ˆæœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„ï¼‰
        'ul li',               // ä¸€èˆ¬çš„ãªãƒªã‚¹ãƒˆæ§‹é€ 
        'ol li',               // é †åºä»˜ããƒªã‚¹ãƒˆ
        '.job-list li',        // æ¡ˆä»¶ãƒªã‚¹ãƒˆå†…ã®li
        'li',                  // å…¨ã¦ã®liè¦ç´ 
        '.job-item',           // æ¡ˆä»¶ã‚¢ã‚¤ãƒ†ãƒ ç”¨ã‚¯ãƒ©ã‚¹
        '[data-job-id]'        // job-idå±æ€§ã‚’æŒã¤è¦ç´ 
      ];

      let jobElements: any = null;
      let usedSelector = '';

      for (const selector of jobSelectors) {
        const elements = (globalThis as any).document.querySelectorAll(selector);
        if (elements.length > 0) {
          jobElements = elements;
          usedSelector = selector;
          console.log(`âœ… æ¡ˆä»¶è¦ç´ ç™ºè¦‹: ${selector} (${elements.length}ä»¶)`);
          break;
        }
      }

      if (!jobElements || jobElements.length === 0) {
        console.log('âŒ æ¡ˆä»¶è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        // ãƒ‡ãƒãƒƒã‚°: ãƒšãƒ¼ã‚¸ã®ä¸»è¦ãªè¦ç´ ã‚’ç¢ºèª
        const mainElements = (globalThis as any).document.querySelectorAll('main, .main, #main');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: mainè¦ç´ æ•°:', mainElements.length);

        // å®Ÿéš›ã«ã‚ã‚‹è¦ç´ ã‚’èª¿æŸ»
        const allLists = (globalThis as any).document.querySelectorAll('ul, ol');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒªã‚¹ãƒˆè¦ç´ æ•°:', allLists.length);

        const allListItems = (globalThis as any).document.querySelectorAll('li');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ è¦ç´ æ•°:', allListItems.length);

        // å…¨ã¦ã®è¦‹å‡ºã—è¦ç´ ã‚’ç¢ºèª
        const allHeadings = (globalThis as any).document.querySelectorAll('h1, h2, h3, h4, h5, h6');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: è¦‹å‡ºã—è¦ç´ æ•°:', allHeadings.length);

        // å…¨ã¦ã®ãƒªãƒ³ã‚¯è¦ç´ ã‚’ç¢ºèª
        const allLinks = (globalThis as any).document.querySelectorAll('a');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: ãƒªãƒ³ã‚¯è¦ç´ æ•°:', allLinks.length);

        // æ¡ˆä»¶URLã‚’å«ã‚€ãƒªãƒ³ã‚¯ã‚’ç¢ºèª
        const jobLinks = (globalThis as any).document.querySelectorAll('a[href*="/public/jobs/"]');
        console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°: æ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°:', jobLinks.length);

        return [];
      }

      const jobs: any[] = [];
      console.log(`ğŸ“Š ${jobElements.length}ä»¶ã®æ¡ˆä»¶è¦ç´ ã‚’å‡¦ç†ä¸­...`);

      for (let i = 0; i < Math.min(jobElements.length, params.maxJobsLimit); i++) {
        try {
          const jobElement = jobElements[i];

          // å®Ÿéš›ã®HTMLè¦ç´ ã§ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã‚’æ¤œç´¢
          const titleElement = jobElement.querySelector('h3 a, h2 a, h4 a, .title a, a[href*="/public/jobs/"], a[href*="/jobs/"]');
          const title = titleElement?.textContent?.trim() || titleElement?.innerText?.trim() || `æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜_${i}`;

          // hrefå±æ€§ã‹ã‚‰æ¡ˆä»¶URLã‚’å–å¾—
          const href = titleElement?.getAttribute('href') || '';
          const url = href ? (href.startsWith('http') ? href : `https://crowdworks.jp${href}`) : '';

          // æ¡ˆä»¶IDã‚’URLã‹ã‚‰æŠ½å‡º
          const jobIdMatch = url.match(/\/public\/jobs\/(\d+)/);
          const jobId = jobIdMatch ? jobIdMatch[1] : `unknown_${i}`;

          // é‡è¤‡ãƒã‚§ãƒƒã‚¯
          if (params.scrapedIds.includes(jobId)) {
            console.log(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: é‡è¤‡æ¡ˆä»¶ ${jobId}`);
            continue;
          }

          // æ¦‚è¦ - å®Ÿéš›ã®HTMLè¦ç´ ã‹ã‚‰å–å¾—
          const descriptionElement = jobElement.querySelector('p, div, span');
          let description = '';
          if (descriptionElement) {
            description = descriptionElement.textContent?.trim() || descriptionElement.innerText?.trim() || '';
          }

          // æ–™é‡‘æƒ…å ± - å…¨ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‹ã‚‰æ¤œç´¢
          const allElements = jobElement.querySelectorAll('*');
          let budgetText = '';

          for (const element of allElements) {
            const text = element?.textContent?.trim() || '';
            if (text.includes('å††') || text.includes('å›ºå®šå ±é…¬åˆ¶') || text.includes('æ™‚é–“å˜ä¾¡åˆ¶') || text.includes('ã‚³ãƒ³ãƒš')) {
              budgetText = text;
              break;
            }
          }

          // ã‚«ãƒ†ã‚´ãƒª - ãƒªãƒ³ã‚¯è¦ç´ ã‹ã‚‰å–å¾—
          const categoryLinks = jobElement.querySelectorAll('a');
          let category = params.categoryName;
          for (const link of categoryLinks) {
            const linkText = link?.textContent?.trim() || '';
            const href = link?.getAttribute('href') || '';
            if (href.includes('/public/jobs/category/') && linkText && linkText.length < 30) {
              category = linkText;
              break;
            }
          }

          // ã‚¹ã‚­ãƒ«/ã‚¿ã‚° - ãƒªãƒ³ã‚¯è¦ç´ ã‹ã‚‰æŠ½å‡º
          const skillLinks = jobElement.querySelectorAll('a');
          const tags: string[] = [];
          skillLinks.forEach((skillItem: any) => {
            const skillText = skillItem?.textContent?.trim();
            const href = skillItem?.getAttribute('href') || '';
            if (skillText && href.includes('/skill/') && skillText.length > 0 && skillText.length < 50) {
              tags.push(skillText);
            }
          });

          // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ± - ãƒªãƒ³ã‚¯è¦ç´ ã‹ã‚‰å–å¾—
          const clientLinks = jobElement.querySelectorAll('a');
          let clientName = 'åŒ¿å';
          for (const link of clientLinks) {
            const linkText = link?.textContent?.trim() || '';
            const href = link?.getAttribute('href') || '';
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‚’æ¢ã™
            if (linkText && href.includes('/public/employers/') && !href.includes('/public/jobs/') && linkText.length < 50) {
              clientName = linkText;
              break;
            }
          }

          // æ²è¼‰æ—¥æ™‚ - timeè¦ç´ ã‹ã‚‰å–å¾—
          const timeElement = jobElement.querySelector('time');
          const postedAt = timeElement?.textContent?.trim() || timeElement?.innerText?.trim() || new Date().toISOString().split('T')[0];

          // å¿œå‹Ÿè€…æ•°ã¨æœŸé™ - ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æŠ½å‡º
          let applicantCount = 0;
          let deadline = '';

          allElements.forEach((element: any) => {
            const text = element?.textContent?.trim() || '';

            // å¥‘ç´„æ•°ã‚’æŠ½å‡º
            const contractMatch = text.match(/å¥‘ç´„æ•°[^\d]*(\d+)/);
            if (contractMatch) {
              applicantCount = parseInt(contractMatch[1]) || 0;
            }

            // æœŸé™ã‚’æŠ½å‡º
            const deadlineMatch = text.match(/ã‚ã¨(\d+)æ—¥|(\d+æœˆ\d+æ—¥)/);
            if (deadlineMatch) {
              deadline = text;
            }
          });

          const job = {
            id: jobId,
            title: title,
            url: url,
            description: description.substring(0, 500), // é•·ã™ãã‚‹å ´åˆã¯åˆ‡ã‚Šè©°ã‚
            budget: budgetText,
            category: category,
            tags: tags.slice(0, 10), // æœ€å¤§10å€‹ã®ã‚¿ã‚°
            clientName: clientName,
            postedAt: postedAt,
            applicantCount: applicantCount,
            deadline: deadline,
            scrapedAt: new Date().toISOString()
          };

          jobs.push(job);
          console.log(`âœ… æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºæˆåŠŸ: ${job.title} (${job.id})`);

        } catch (error) {
          console.log(`âŒ æ¡ˆä»¶ ${i} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, error);
          continue;
        }
      }

      console.log(`ğŸ“Š åˆè¨ˆ ${jobs.length} ä»¶ã®æ¡ˆä»¶ã‚’æŠ½å‡ºã—ã¾ã—ãŸ (ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼: ${usedSelector})`);
      return jobs;
    }, { maxJobsLimit: maxJobs, categoryName: category, scrapedIds: Array.from(scrapedJobsCache) });

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
    jobs.forEach((job: CrowdWorksJob) => scrapedJobsCache.add(job.id));

    const executionTime = Date.now() - startTime;

    console.log(`ğŸ‰ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†:`);
    console.log(`   ğŸ“Š å–å¾—æ¡ˆä»¶æ•°: ${jobs.length}`);
    console.log(`   â±ï¸ å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);

    // ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
    if (jobs.length > 0) {
      console.log(`ğŸ“ ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶:`);
      const sample = jobs[0];
      if (sample) {
        console.log(`   ğŸ·ï¸ ã‚¿ã‚¤ãƒˆãƒ«: ${sample.title}`);
        console.log(`   ğŸ’° äºˆç®—: ${sample.budget.type} ${sample.budget.amount}å††`);
        console.log(`   ğŸ¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ${sample.client.name}`);
        console.log(`   ğŸ”— URL: ${sample.url}`);
      }
    }

    return {
      success: true,
      jobsFound: jobs.length,
      jobs,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:`, errorMessage);

    return {
      success: false,
      jobsFound: 0,
      jobs: [],
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * æŒ‡å®šã‚«ãƒ†ã‚´ãƒªã®CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
 */
async function testCrowdWorksCategories(): Promise<{
  success: boolean;
  results?: { [category: string]: ScrapingResult };
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ CrowdWorksã‚«ãƒ†ã‚´ãƒªæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // èªè¨¼æƒ…å ±ã‚’å–å¾—
    const credentials = await getCrowdWorksCredentials();

    // Chromiumèµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
        ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
        : '/usr/bin/chromium',
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1280, height: 720 },
    });

    const page = await context.newPage();

    // CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    console.log('ğŸ” CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œä¸­...');
    const loginResult = await loginToCrowdWorks(page, credentials);

    if (!loginResult.success || !loginResult.isLoggedIn) {
      throw new Error(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${loginResult.error}`);
    }

    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...');

    // æŒ‡å®šã‚«ãƒ†ã‚´ãƒªã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
    const categories = ['web_products', 'ec'];
    const results: { [category: string]: ScrapingResult } = {};

    for (const category of categories) {
      console.log(`\nğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹...`);

      // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ï¼ˆå‹ã‚¨ãƒ©ãƒ¼ã‚’ä¸€æ—¦ç„¡è¦–ï¼‰
      const categoryUrl = `https://crowdworks.jp/public/jobs/group/${category}`;
      console.log(`ğŸ“„ ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹: ${categoryUrl}`);

      await page.goto(categoryUrl, {
        waitUntil: 'domcontentloaded',
        timeout: 30000
      });

      console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã€Œ${category}ã€èª­ã¿è¾¼ã¿å®Œäº†`);

      // ç°¡æ˜“æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆå¾Œã§è©³ç´°å®Ÿè£…ï¼‰
      const jobData = await page.evaluate(() => {
        const projects = (globalThis as any).document.querySelectorAll('.search_result .project_row, .project-item, [class*="project"]');
        return {
          count: projects.length,
          titles: Array.from(projects).slice(0, 3).map((p: any) => p.querySelector('a')?.textContent?.trim() || 'ä¸æ˜')
        };
      });

      results[category] = {
        success: true,
        jobsFound: jobData.count,
        jobs: [], // å¾Œã§å®Ÿè£…
        executionTime: 1000
      };

      console.log(`ğŸ“Š ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ${jobData.count}ä»¶ã®æ¡ˆä»¶ç™ºè¦‹`);
      if (jobData.titles.length > 0) {
        console.log(`ğŸ“ ã‚µãƒ³ãƒ—ãƒ«ã‚¿ã‚¤ãƒˆãƒ«: ${jobData.titles.join(', ')}`);
      }

      // æ¬¡ã®ã‚«ãƒ†ã‚´ãƒªå‡¦ç†å‰ã«å°‘ã—å¾…æ©Ÿ
      await page.waitForTimeout(2000);
    }

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: true,
      results,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * æ¡ˆä»¶è©³ç´°æƒ…å ±ã‚’å–å¾—ã™ã‚‹
 */
async function scrapeCrowdWorksJobDetail(page: Page, jobUrl: string): Promise<CrowdWorksJobDetail | null> {
  try {
    console.log(`ğŸ“„ æ¡ˆä»¶è©³ç´°å–å¾—é–‹å§‹: ${jobUrl}`);

    // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã«ç§»å‹•
    await page.goto(jobUrl, { waitUntil: 'networkidle' });
    await page.waitForTimeout(2000);

    // æ¡ˆä»¶è©³ç´°æƒ…å ±ã‚’æŠ½å‡º
    const jobDetail = await page.evaluate((url: string) => {
      // URLã‹ã‚‰æ¡ˆä»¶IDã‚’æŠ½å‡º
      const jobIdMatch = url.match(/\/public\/jobs\/(\d+)/);
      const jobId = jobIdMatch ? jobIdMatch[1] : '';

      // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
      const titleElement = (globalThis as any).document.querySelector('h1');
      const fullTitle = titleElement?.textContent?.trim() || '';
      const title = fullTitle.replace(/\s+(ã‚¦ã‚§ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³|ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ|ãã®ä»–).*ã®ä»•äº‹ã®ä¾é ¼.*$/, '').trim();

      // ã‚«ãƒ†ã‚´ãƒªå–å¾—
      const categoryElement = (globalThis as any).document.querySelector('h1 a');
      const category = categoryElement?.textContent?.trim() || '';

      // ä»•äº‹ã®æ¦‚è¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æƒ…å ±æŠ½å‡º
      const overviewRows = (globalThis as any).document.querySelectorAll('table tr');
      let paymentType = '';
      let budget = '';
      let deliveryDate = '';
      let postDate = '';
      let applicationDeadline = '';
      let desiredImages: string[] = [];

      overviewRows.forEach((row: any) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const label = cells[0]?.textContent?.trim() || '';
          const value = cells[1]?.textContent?.trim() || '';

          if (label.includes('å›ºå®šå ±é…¬åˆ¶') || label.includes('æ™‚é–“å˜ä¾¡åˆ¶')) {
            paymentType = label;
            budget = value;
          } else if (label.includes('ç´å“å¸Œæœ›æ—¥')) {
            deliveryDate = value;
          } else if (label.includes('æ²è¼‰æ—¥')) {
            postDate = value;
          } else if (label.includes('å¿œå‹ŸæœŸé™')) {
            applicationDeadline = value;
          } else if (label.includes('å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸')) {
            // å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å„é …ç›®ã‚’æŠ½å‡º
            const imageElements = cells[1].querySelectorAll('*');
            imageElements.forEach((el: any) => {
              const text = el?.textContent?.trim();
              if (text && text.length > 0 && text.length < 10) {
                desiredImages.push(text);
              }
            });
          }
        }
      });

      // å¿œå‹ŸçŠ¶æ³ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æƒ…å ±æŠ½å‡º
      const statusRows = (globalThis as any).document.querySelectorAll('table tr');
      let applicantCount = 0;
      let contractCount = 0;
      let recruitmentCount = 0;
      let favoriteCount = 0;

      statusRows.forEach((row: any) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const label = cells[0]?.textContent?.trim() || '';
          const value = cells[1]?.textContent?.trim() || '';
          const numValue = parseInt(value.replace(/[^\d]/g, ''));

          if (label.includes('å¿œå‹Ÿã—ãŸäºº')) {
            applicantCount = numValue || 0;
          } else if (label.includes('å¥‘ç´„ã—ãŸäºº')) {
            contractCount = numValue || 0;
          } else if (label.includes('å‹Ÿé›†äººæ•°')) {
            recruitmentCount = numValue || 0;
          } else if (label.includes('æ°—ã«ãªã‚‹')) {
            favoriteCount = numValue || 0;
          }
        }
      });

      // è©³ç´°ãªä»•äº‹å†…å®¹
      const detailRows = (globalThis as any).document.querySelectorAll('table tr');
      let detailedDescription = '';
      detailRows.forEach((row: any) => {
        const cell = row.querySelector('td');
        if (cell) {
          const text = cell?.textContent?.trim() || '';
          if (text.length > 100) { // é•·ã„ãƒ†ã‚­ã‚¹ãƒˆãŒè©³ç´°èª¬æ˜ã®å¯èƒ½æ€§ãŒé«˜ã„
            detailedDescription = text;
          }
        }
      });

      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
      const clientNameElement = (globalThis as any).document.querySelector('a[href*="/public/employers/"]');
      const clientName = clientNameElement?.textContent?.trim() || 'åŒ¿å';
      const clientUrl = clientNameElement?.getAttribute('href') || '';

      // è©•ä¾¡æƒ…å ±
      let overallRating = '';
      let orderHistory = '';
      let completionRate = '';
      let thankCount = '';

      const definitionElements = (globalThis as any).document.querySelectorAll('dd, definition');
      definitionElements.forEach((def: any) => {
        const text = def?.textContent?.trim() || '';
        if (text.includes('.') && text.length < 5) {
          overallRating = text;
        } else if (text.includes('ä»¶') && text.length < 10) {
          if (!orderHistory) orderHistory = text;
        } else if (text.includes('%')) {
          completionRate = text;
        }
      });

      // ã‚ã‚ŠãŒã¨ã†ä»¶æ•°
      const thankElements = (globalThis as any).document.querySelectorAll('*');
      thankElements.forEach((el: any) => {
        const text = el?.textContent?.trim() || '';
        if (text.includes('ã‚ã‚ŠãŒã¨ã†') && text.includes('ä»¶')) {
          thankCount = text.match(/\d+/)?.[0] || '0';
        }
      });

      // æœ¬äººç¢ºèªãƒ»ç™ºæ³¨ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
      const pageText = (globalThis as any).document.body?.textContent || '';
      const identityVerified = !pageText.includes('æœ¬äººç¢ºèªæœªæå‡º');
      const orderRuleCheck = !pageText.includes('ç™ºæ³¨ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯æœªå›ç­”');

      // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª¬æ˜
      let clientDescription = '';
      const descriptionElements = (globalThis as any).document.querySelectorAll('p');
      descriptionElements.forEach((p: any) => {
        const text = p?.textContent?.trim() || '';
        if (text.includes('ä¸»ã«') && text.length > 10 && text.length < 200) {
          clientDescription = text;
        }
      });

      // æœ€è¿‘ã®å¿œå‹Ÿè€…æƒ…å ±
      const recentApplicants: Array<{ name: string; url: string; applicationDate: string }> = [];
      const applicantRows = (globalThis as any).document.querySelectorAll('tbody tr');
      applicantRows.forEach((row: any) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const nameElement = cells[0]?.querySelector('a');
          if (nameElement) {
            const name = nameElement?.textContent?.trim() || '';
            const applicantUrl = nameElement?.getAttribute('href') || '';
            const applicationDate = cells[1]?.textContent?.trim() || '';

            if (name && applicationDate.includes('/')) {
              recentApplicants.push({
                name,
                url: applicantUrl.startsWith('http') ? applicantUrl : `https://crowdworks.jp${applicantUrl}`,
                applicationDate
              });
            }
          }
        }
      });

      return {
        jobId: jobId || '',
        title,
        category,
        url,
        paymentType,
        budget,
        deliveryDate,
        postDate,
        applicationDeadline,
        desiredImages,
        applicantCount,
        contractCount,
        recruitmentCount,
        favoriteCount,
        detailedDescription,
        client: {
          name: clientName,
          url: clientUrl.startsWith('http') ? clientUrl : `https://crowdworks.jp${clientUrl}`,
          overallRating,
          orderHistory,
          completionRate,
          thankCount,
          identityVerified,
          orderRuleCheck,
          description: clientDescription
        },
        recentApplicants: recentApplicants.slice(0, 10), // æœ€æ–°10ä»¶
        scrapedAt: new Date().toISOString()
      };
    }, jobUrl);

    console.log(`âœ… æ¡ˆä»¶è©³ç´°å–å¾—å®Œäº†: ${jobDetail.title}`);
    return jobDetail;

  } catch (error) {
    console.error(`âŒ æ¡ˆä»¶è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ${jobUrl}`, error);
    return null;
  }
}

/**
 * æ¡ˆä»¶è©³ç´°ä»˜ãã§ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¡ˆä»¶ã‚’å–å¾—ã™ã‚‹
 */
export async function scrapeCrowdWorksJobsByCategoryWithDetails(params: {
  category: string;
  maxJobs: number;
  maxDetails?: number; // è©³ç´°å–å¾—ã™ã‚‹æ¡ˆä»¶ã®æœ€å¤§æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3ä»¶ï¼‰
}): Promise<{
  jobs: CrowdWorksJob[];
  jobDetails: CrowdWorksJobDetail[];
}> {
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ æ¡ˆä»¶è©³ç´°ä»˜ãå–å¾—é–‹å§‹...');

    // Chromiumèµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
        ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
        : '/usr/bin/chromium',
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1920, height: 1080 },
      locale: 'ja-JP',
      timezoneId: 'Asia/Tokyo',
    });

    const page = await context.newPage();

    // ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    console.log('ğŸ” CrowdWorksã«ãƒ­ã‚°ã‚¤ãƒ³ä¸­...');
    const credentials = await getCrowdWorksCredentials();
    await loginToCrowdWorks(page, credentials);

    // æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—
    console.log(`ğŸ“‹ æ¡ˆä»¶ä¸€è¦§å–å¾—ä¸­: ${params.category}`);
    const jobsResult = await scrapeCrowdWorksJobsByCategory(page, params.category, params.maxJobs);
    const jobs = jobsResult.jobs;

    // è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆæŒ‡å®šã•ã‚ŒãŸä»¶æ•°ã¾ã§ï¼‰
    const maxDetails = params.maxDetails || 3;
    const jobDetails: CrowdWorksJobDetail[] = [];

    console.log(`ğŸ“„ æ¡ˆä»¶è©³ç´°å–å¾—é–‹å§‹: ${Math.min(jobs.length, maxDetails)}ä»¶`);

    for (let i = 0; i < Math.min(jobs.length, maxDetails); i++) {
      const job = jobs[i];
      if (job && job.url) {
        console.log(`ğŸ“„ è©³ç´°å–å¾—ä¸­ ${i + 1}/${maxDetails}: ${job.title}`);
        const detail = await scrapeCrowdWorksJobDetail(page, job.url);
        if (detail) {
          jobDetails.push(detail);
        }

        // è©³ç´°å–å¾—é–“ã®å¾…æ©Ÿæ™‚é–“ï¼ˆã‚µãƒ¼ãƒãƒ¼è² è·è»½æ¸›ï¼‰
        await page.waitForTimeout(2000);
      }
    }

    console.log(`âœ… æ¡ˆä»¶è©³ç´°å–å¾—å®Œäº†: ${jobDetails.length}ä»¶`);

    await context.close();

    return {
      jobs,
      jobDetails
    };

  } catch (error) {
    console.error('âŒ æ¡ˆä»¶è©³ç´°ä»˜ãå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * Lambda ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */
export const lambdaHandler = async (
  event: ScheduledExecutionEvent,
  _context: Context
): Promise<ScheduledExecutionResponse> => {
  const startTime = Date.now();

  try {
    console.log('ğŸŒŸ === CrowdWorks Search Lambda Handler é–‹å§‹ ===');
    console.log('ğŸ“… å®Ÿè¡Œæ™‚é–“:', new Date().toISOString());
    console.log('ğŸ”§ å®Ÿè¡Œç’°å¢ƒ:', process.env['NODE_ENV'] || 'development');
    console.log('ğŸ“‹ ã‚¤ãƒ™ãƒ³ãƒˆ:', JSON.stringify(event, null, 2));

    // Phase 1: PlaywrightåŸºæœ¬å‹•ä½œç¢ºèª
    console.log('\nğŸ” === Phase 1: PlaywrightåŸºæœ¬å‹•ä½œç¢ºèª ===');
    const playwrightTest = await testPlaywrightBasic();

    if (!playwrightTest.success) {
      throw new Error(`PlaywrightåŸºæœ¬ãƒ†ã‚¹ãƒˆå¤±æ•—: ${playwrightTest.error}`);
    }

    // Phase 2: CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ
    console.log('\nğŸ” === Phase 2: CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ ===');
    const loginTest = await testCrowdWorksLogin();

    if (!loginTest.success || !loginTest.loginResult?.isLoggedIn) {
      console.error('âš ï¸ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå¤±æ•—:', loginTest.error);
      // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—æ™‚ã‚‚ã¨ã‚Šã‚ãˆãšç¶šè¡Œï¼ˆå¾Œç¶šå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
    }

    // Phase 3: CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
    console.log('\nğŸ“Š === Phase 3: CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ ===');
    const scrapingTest = await testCrowdWorksScraping();

    if (!scrapingTest.success) {
      console.error('âš ï¸ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—:', scrapingTest.error);
    }

    // Phase 4: CrowdWorksã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆNEWï¼‰
    console.log('\nğŸ¯ === Phase 4: CrowdWorksã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ ===');
    const categoryTest = await testCrowdWorksCategories();

    if (!categoryTest.success) {
      console.error('âš ï¸ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—:', categoryTest.error);
    } else if (categoryTest.results) {
      console.log('ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ:');
      Object.entries(categoryTest.results).forEach(([category, result]) => {
        console.log(`   ${category}: ${result.success ? 'âœ…' : 'âŒ'} (${result.jobsFound}ä»¶)`);
      });
    }

    const executionTime = Date.now() - startTime;

    // å®Ÿè¡Œçµæœã®ã¾ã¨ã‚
    const results = {
      phases: {
        playwright: playwrightTest,
        crowdworksLogin: loginTest,
        crowdworksScraping: scrapingTest,
        crowdworksCategories: categoryTest
      },
      executionTime,
      timestamp: new Date().toISOString()
    };

    console.log('\nğŸ‰ === Lambda Handler å®Ÿè¡Œå®Œäº† ===');
    console.log('ğŸ“Š å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼:');
    console.log(`  - Playwright: ${playwrightTest.success ? 'âœ…' : 'âŒ'}`);
    console.log(`  - ãƒ­ã‚°ã‚¤ãƒ³: ${loginTest.loginResult?.isLoggedIn ? 'âœ…' : 'âŒ'}`);
    console.log(`  - ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°: ${scrapingTest.success ? 'âœ…' : 'âŒ'}`);
    console.log(`  - ã‚«ãƒ†ã‚´ãƒªåˆ¥: ${categoryTest.success ? 'âœ…' : 'âŒ'}`);
    console.log(`â±ï¸ ç·å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);

    return {
      statusCode: 200,
      body: JSON.stringify(results, null, 2),
      executionTime,
      timestamp: new Date().toISOString(),
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);

    console.error('ğŸ’¥ === Lambda Handler ã‚¨ãƒ©ãƒ¼ ===');
    console.error('âŒ ã‚¨ãƒ©ãƒ¼å†…å®¹:', errorMessage);
    console.error('ğŸ“Š Stack trace:', error instanceof Error ? error.stack : 'No stack trace');
    console.error(`â±ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚é–“: ${executionTime}ms`);

    return {
      statusCode: 500,
      body: JSON.stringify({
        error: errorMessage,
        executionTime,
        timestamp: new Date().toISOString(),
      }, null, 2),
      executionTime,
      timestamp: new Date().toISOString(),
    };
  }
};

// API Gatewayç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
export const handler = lambdaHandler;
</file>

<file path="package.json">
{
    "name": "crowdworks-search",
    "version": "1.0.0",
    "description": "ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶è‡ªå‹•æ¤œç´¢ãƒ»è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ",
    "main": "dist/index.js",
    "scripts": {
        "build": "tsc",
        "build:watch": "tsc --watch",
        "clean": "rimraf dist",
        "lint": "eslint src/**/*.ts",
        "lint:fix": "eslint src/**/*.ts --fix",
        "format": "prettier --write src/**/*.ts",
        "format:check": "prettier --check src/**/*.ts",
        "type-check": "tsc --noEmit",
        "test": "jest",
        "test:watch": "jest --watch",
        "test:coverage": "jest --coverage",
        "test:integration": "jest --testPathPattern=integration",
        "test:e2e": "jest --testPathPattern=e2e",
        "test:playwright": "playwright test",
        "test:crowdworks:local": "ts-node -r dotenv/config src/test/crowdworks-scraping-test.ts",
        "test:login:local": "npm run test:crowdworks:local",
        "test:category:local": "cross-env TEST_TYPE=category ts-node -r dotenv/config src/test/crowdworks-scraping-test.ts",
        "cdk:synth": "cdk synth",
        "cdk:deploy": "cdk deploy",
        "cdk:deploy:container": "npm run build && cdk deploy --require-approval never --context useContainerImage=true",
        "cdk:destroy": "cdk destroy",
        "cdk:diff": "cdk diff",
        "dev": "ts-node src/index.ts",
        "start": "node dist/index.js",
        "prepare": "husky install",
        "docker:build": "docker build -t crowdworks-search .",
        "docker:build:lambda": "docker build -f Dockerfile.lambda -t crowdworks-search-lambda .",
        "docker:run": "docker run --rm -it crowdworks-search",
        "docker:run:lambda": "docker run --rm -p 9000:8080 crowdworks-search-lambda",
        "docker:test:lambda": "docker run --rm crowdworks-lambda && echo 'Lambda Container Test Completed'",
        "docker:dev": "docker-compose up --build",
        "docker:test": "docker-compose --profile test run --rm test",
        "lambda:test": "curl -XPOST 'http://localhost:9000/2015-03-31/functions/function/invocations' -d '{\"source\":\"test\",\"detail\":{}}'",
        "lambda:local": "npm run docker:build:lambda && npm run docker:run:lambda",
        "precommit": "lint-staged",
        "security:audit": "npm audit --audit-level=moderate"
    },
    "keywords": [
        "crowdworks",
        "automation",
        "scraping",
        "aws",
        "serverless",
        "typescript"
    ],
    "author": "Your Name",
    "license": "MIT",
    "private": true,
    "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
    },
    "dependencies": {
        "@aws-sdk/client-lambda": "^3.450.0",
        "@aws-sdk/client-s3": "^3.450.0",
        "@aws-sdk/client-sns": "^3.450.0",
        "@aws-sdk/client-ssm": "^3.540.0",
        "aws-cdk-lib": "^2.156.0",
        "aws-lambda": "^1.0.7",
        "aws-sdk": "^2.1691.0",
        "constructs": "^10.3.0",
        "dotenv": "^16.5.0",
        "openai": "^4.20.0",
        "playwright": "^1.48.2",
        "source-map-support": "^0.5.21",
        "typescript": "^5.6.3",
        "zod": "^3.22.0"
    },
    "devDependencies": {
        "@types/aws-lambda": "^8.10.145",
        "@types/jest": "^29.5.14",
        "@types/node": "^22.9.1",
        "@typescript-eslint/eslint-plugin": "^8.14.0",
        "@typescript-eslint/parser": "^8.14.0",
        "aws-cdk": "^2.170.0",
        "cross-env": "^7.0.3",
        "esbuild": "^0.24.0",
        "eslint": "^9.14.0",
        "eslint-config-prettier": "^9.1.0",
        "eslint-plugin-prettier": "^5.2.1",
        "husky": "^8.0.0",
        "jest": "^29.7.0",
        "lint-staged": "^15.0.0",
        "nock": "^13.3.0",
        "nodemon": "^3.1.7",
        "prettier": "^3.3.3",
        "ts-jest": "^29.2.5",
        "ts-node": "^10.9.2",
        "tsconfig-paths": "^4.2.0"
    },
    "husky": {
        "hooks": {
            "pre-commit": "lint-staged",
            "pre-push": "npm run type-check && npm run test"
        }
    },
    "lint-staged": {
        "src/**/*.{ts,tsx}": [
            "eslint --fix",
            "prettier --write",
            "git add"
        ]
    }
}
</file>

</files>
