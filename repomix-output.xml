This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.eslintrc.js
.github/workflows/ci.yml
.gitignore
.prettierrc
app.ts
docker-compose.yml
Dockerfile
Dockerfile.lambda
docs/README.md
env.example
jest.config.js
package.json
readme.md
scripts/analyze-details.ts
scripts/calculate-recommendation-score.ts
scripts/extract-high-hourly-jobs.ts
scripts/setup-github-oidc.sh
scripts/sort-by-hourly-rate.ts
src/index.ts
src/infrastructure/crowdworks-searcher-stack.ts
src/lambda/handler.ts
src/services/index.ts
src/types/index.ts
src/utils/index.ts
tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".prettierrc">
{
    "semi": true,
    "trailingComma": "es5",
    "singleQuote": true,
    "printWidth": 100,
    "tabWidth": 2,
    "useTabs": false,
    "bracketSpacing": true,
    "arrowParens": "avoid",
    "endOfLine": "lf",
    "quoteProps": "as-needed",
    "bracketSameLine": false,
    "embeddedLanguageFormatting": "auto"
}
</file>

<file path="docker-compose.yml">
version: '3.8'

services:
  # ãƒ¡ã‚¤ãƒ³é–‹ç™ºç’°å¢ƒ
  crowdworks-search:
    build:
      context: .
      dockerfile: Dockerfile
      target: development  # é–‹ç™ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ä½¿ç”¨
    container_name: crowdworks-search-dev
    volumes:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚¦ãƒ³ãƒˆï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é–‹ç™ºç”¨ï¼‰
      - .:/workspace
      - /workspace/node_modules  # node_modulesã¯é™¤å¤–
      - /workspace/dist          # distã¯é™¤å¤–
      # AWSèªè¨¼æƒ…å ±ã®ãƒã‚¦ãƒ³ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      - ~/.aws:/root/.aws:ro
    environment:
      # é–‹ç™ºç’°å¢ƒç”¨ã®ç’°å¢ƒå¤‰æ•°
      - NODE_ENV=development
      - AWS_REGION=ap-northeast-1
      - LOG_LEVEL=debug
      # Playwrightè¨­å®š
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
    ports:
      - "3000:3000"  # å°†æ¥çš„ãªAPI Gateway Localç”¨
      - "9229:9229"  # Node.js ãƒ‡ãƒãƒƒã‚°ãƒãƒ¼ãƒˆ
    working_dir: /workspace
    # é–‹ç™ºç”¨ã®ã‚³ãƒãƒ³ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    command: tail -f /dev/null  # ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•çŠ¶æ…‹ã§ç¶­æŒ
    stdin_open: true
    tty: true

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
  test:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: crowdworks-search-test
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/dist
    environment:
      - NODE_ENV=test
      - AWS_REGION=ap-northeast-1
    working_dir: /workspace
    command: npm run test:coverage
    profiles:
      - test  # docker-compose --profile test up ã§å®Ÿè¡Œ

  # AWS CDKå°‚ç”¨ã‚³ãƒ³ãƒ†ãƒŠ
  cdk:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    container_name: crowdworks-search-cdk
    volumes:
      - .:/workspace
      - /workspace/node_modules
      - /workspace/cdk.out
      - ~/.aws:/root/.aws:ro
    environment:
      - AWS_REGION=ap-northeast-1
      - CDK_DEFAULT_REGION=ap-northeast-1
    working_dir: /workspace
    command: tail -f /dev/null
    profiles:
      - cdk  # docker-compose --profile cdk up ã§å®Ÿè¡Œ

  # æœ¬ç•ªç’°å¢ƒãƒ†ã‚¹ãƒˆç”¨ï¼ˆLambdaç’°å¢ƒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  lambda-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: crowdworks-search-lambda
    environment:
      - AWS_LAMBDA_RUNTIME_API=localhost:9000
      - _HANDLER=dist/lambda/handler.lambdaHandler
    ports:
      - "9000:8080"  # Lambda Runtime Interface Emulator
    profiles:
      - lambda  # docker-compose --profile lambda up ã§å®Ÿè¡Œ

networks:
  default:
    name: crowdworks-search-network
</file>

<file path="Dockerfile.lambda">
# ================================================
# Lambda Containerç”¨Dockerfile
# Playwright + Chromiumç’°å¢ƒã®æœ€é©åŒ–ç‰ˆ
# ================================================

# AWS Lambda Node.jsåŸºç›¤ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM public.ecr.aws/lambda/nodejs:18

# ãƒ“ãƒ«ãƒ‰å¼•æ•°
ARG STAGE=development
ARG NODE_ENV=production

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV NODE_ENV=${NODE_ENV}
ENV STAGE=${STAGE}
ENV PLAYWRIGHT_BROWSERS_PATH=/usr/bin
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
WORKDIR ${LAMBDA_TASK_ROOT}

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆChromium + é–¢é€£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
RUN dnf update -y && \
    dnf install -y \
    chromium \
    nss \
    atk \
    at-spi2-atk \
    gtk3 \
    cups-libs \
    drm \
    libXt \
    libXext \
    libXdamage \
    libXrandr \
    libXcomposite \
    libXcursor \
    libXss \
    libXi \
    GConf2 \
    alsa-lib \
    && dnf clean all \
    && rm -rf /var/cache/dnf

# Chromiumã®å‹•ä½œç¢ºèªã¨ãƒã‚¤ãƒŠãƒªãƒ‘ã‚¹è¨­å®š
RUN ln -sf /usr/bin/chromium-browser /usr/bin/chromium \
    && chromium --version \
    && echo "Chromium installed successfully"

# Node.jsä¾å­˜é–¢ä¿‚ã®ã‚³ãƒ”ãƒ¼ã¨ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package*.json ./
RUN npm ci --omit=dev --ignore-scripts && \
    npm cache clean --force

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼
COPY dist/ ./dist/
COPY src/types/ ./src/types/

# ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š
RUN chmod +x dist/lambda/handler.js

# Playwrightè¨­å®šç¢ºèª
RUN node -e "console.log('Node.js version:', process.version)" && \
    node -e "const { chromium } = require('playwright'); console.log('Playwright loaded successfully')"

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ç¢ºèªï¼‰
RUN node -e "console.log('Lambda Container build completed successfully')"

# Lambdaé–¢æ•°ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
CMD ["dist/lambda/handler.lambdaHandler"]
</file>

<file path="docs/README.md">
# è¨­è¨ˆæ›¸ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶è‡ªå‹•æ¤œç´¢ãƒ»è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ã®è¨­è¨ˆæ›¸ã§ã™ã€‚

## ğŸ“š è¨­è¨ˆæ›¸ä¸€è¦§

### 1. [è¦ä»¶å®šç¾©æ›¸](./01_requirements.md)
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®çš„ã€æ©Ÿèƒ½è¦ä»¶ã€éæ©Ÿèƒ½è¦ä»¶ã‚’å®šç¾©

### 2. [ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸](./02_system_design.md)  
ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 3. [ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸](./03_data_design.md)
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

### 4. [APIè¨­è¨ˆæ›¸](./04_api_design.md)
å†…éƒ¨APIãƒ»å¤–éƒ¨APIé€£æºã®ä»•æ§˜å®šç¾©

### 5. [å®Ÿè£…è¨ˆç”»æ›¸](./05_implementation_plan.md)
é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã¨ã‚¿ã‚¹ã‚¯åˆ†è§£ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

## ğŸ”„ è¨­è¨ˆæ›¸ä½œæˆã®é€²ã‚æ–¹

1. **è¦ä»¶å®šç¾©æ›¸** ã‹ã‚‰é–‹å§‹
2. **ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸** ã§å…¨ä½“åƒã‚’æ•´ç†
3. **ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆæ›¸** ã§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’æ±ºå®š
4. **APIè¨­è¨ˆæ›¸** ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©
5. **å®Ÿè£…è¨ˆç”»æ›¸** ã§é–‹ç™ºã‚’è¨ˆç”»

## ğŸ“ æ›´æ–°å±¥æ­´

| æ—¥ä»˜ | æ›´æ–°è€… | æ›´æ–°å†…å®¹ |
|------|--------|----------|
|      |        |          |
</file>

<file path="scripts/analyze-details.ts">
require('dotenv').config();

import { readFileSync, writeFileSync } from 'fs';
import { OpenAI } from 'openai';
import * as path from 'path';

// å‹å®šç¾©
interface CrowdWorksJobDetail {
    jobId: string;
    title: string;
    detailedDescription: string;
    [key: string]: any;
}

interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    é›£æ˜“åº¦: string;
    gpt_summary: string;
}

// .envã‹ã‚‰APIã‚­ãƒ¼å–å¾—
const apiKey = process.env['OPENAI_API_KEY'];
if (!apiKey) {
    console.error('âŒ OPENAI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    process.exit(1);
}

const openai = new OpenAI({ apiKey });

// å¼•æ•°: å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«, å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
const [, , inputFile, outputFile] = process.argv;
if (!inputFile || !outputFile) {
    console.error('Usage: ts-node scripts/analyze-details.ts <input.json> <output.json>');
    process.exit(1);
}

const inputPath = path.resolve(inputFile);
const outputPath = path.resolve(outputFile);

const details: CrowdWorksJobDetail[] = JSON.parse(readFileSync(inputPath, 'utf8'));

// ä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡ã‚¯ãƒ©ã‚¹
class ConcurrencyLimiter {
    private runningCount = 0;
    private queue: (() => Promise<void>)[] = [];

    constructor(private maxConcurrency: number) { }

    async execute<T>(task: () => Promise<T>): Promise<T> {
        return new Promise<T>((resolve, reject) => {
            const wrappedTask = async () => {
                try {
                    this.runningCount++;
                    const result = await task();
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    this.runningCount--;
                    this.processQueue();
                }
            };

            if (this.runningCount < this.maxConcurrency) {
                wrappedTask();
            } else {
                this.queue.push(wrappedTask);
            }
        });
    }

    private processQueue() {
        if (this.queue.length > 0 && this.runningCount < this.maxConcurrency) {
            const nextTask = this.queue.shift();
            if (nextTask) {
                nextTask();
            }
        }
    }
}

const limiter = new ConcurrencyLimiter(5); // æœ€å¤§5ä»¶ä¸¦åˆ—

async function analyzeDetail(detail: CrowdWorksJobDetail): Promise<AnalysisResult> {
    const prompt = `ä»¥ä¸‹ã¯ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®æ¡ˆä»¶è©³ç´°ã§ã™ã€‚å†…å®¹ã‚’èª­ã‚“ã§ã€
1. ã“ã®ä»•äº‹ã«ã‹ã‹ã‚‹ãŠãŠã‚ˆãã®å·¥æ•°ï¼ˆä½•æ™‚é–“ãã‚‰ã„ã‹ï¼‰
2. æƒ³å®šã•ã‚Œã‚‹æ™‚çµ¦ï¼ˆæ—¥æœ¬å††ãƒ»å›ºå®šå€¤ã§1ã¤ã®æ•°å€¤ã®ã¿ï¼‰
3. æ¡ˆä»¶ã®é›£æ˜“åº¦ï¼ˆç°¡å˜/æ™®é€š/é›£ã—ã„ ã®ã„ãšã‚Œã‹ï¼‰
4. ãã®æ ¹æ‹ ã‚„æ³¨æ„ç‚¹
ã‚’æ—¥æœ¬èªã§ç°¡æ½”ã«ã¾ã¨ã‚ã¦ãã ã•ã„ã€‚

ã€é‡è¦ãªå·¥æ•°è¦‹ç©ã‚‚ã‚Šã®ãƒã‚¤ãƒ³ãƒˆã€‘
- è¨˜è¼‰ã•ã‚ŒãŸä½œæ¥­å†…å®¹ã ã‘ã§ãªãã€ä»¥ä¸‹ã®å‰ä½œæ¥­ãƒ»ä»˜å¸¯ä½œæ¥­ã‚‚å¿…ãšå«ã‚ã¦è¨ˆç®—ã—ã¦ãã ã•ã„ï¼š
  * è¦ä»¶å®šç¾©ãƒ»è¦ä»¶æ•´ç†ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã®èªè­˜åˆã‚ã›ï¼‰
  * åˆå›æ‰“ã¡åˆã‚ã›ãƒ»ãƒ’ã‚¢ãƒªãƒ³ã‚°ï¼ˆ1-3å›ç¨‹åº¦ï¼‰
  * ææ¡ˆæ›¸ãƒ»ä¼ç”»æ›¸ãƒ»ä»•æ§˜æ›¸ã®ä½œæˆ
  * ä½œæ¥­ä¸­ã®é€²æ—å ±å‘Šãƒ»ä¸­é–“ç¢ºèª
  * ä¿®æ­£ãƒ»èª¿æ•´ä½œæ¥­ï¼ˆé€šå¸¸2-3å›ã¯ç™ºç”Ÿï¼‰
  * ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ãƒ»å“è³ªãƒã‚§ãƒƒã‚¯
  * ç´å“ä½œæ¥­ãƒ»èª¬æ˜ãƒ»å¼•ãç¶™ã
  * ç´å“å¾Œã®è»½å¾®ãªã‚µãƒãƒ¼ãƒˆãƒ»è³ªå•å¯¾å¿œ

ã€é‡è¦ãªé›£æ˜“åº¦åˆ¤å®šã®ãƒã‚¤ãƒ³ãƒˆã€‘
- **ç°¡å˜**: åˆå¿ƒè€…ãƒ»æœªçµŒé¨“è€…ã§ã‚‚å¯¾å¿œå¯èƒ½ã€åŸºæœ¬çš„ãªã‚¹ã‚­ãƒ«ã§ååˆ†ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæ¥­ä¸­å¿ƒ
- **æ™®é€š**: ä¸€èˆ¬çš„ãªã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦ã€å¤šå°‘ã®å­¦ç¿’ã‚„èª¿æŸ»ãŒå¿…è¦ã€æ¨™æº–çš„ãªæ¥­å‹™
- **é›£ã—ã„**: é«˜åº¦ãªå°‚é–€çŸ¥è­˜ãƒ»æŠ€è¡“ãŒå¿…è¦ã€è±Šå¯ŒãªçµŒé¨“ãŒå‰æã€è¤‡é›‘ãªè¦ä»¶ã‚„æ–°æŠ€è¡“

ã€é‡è¦ãªæ³¨æ„ç‚¹ã€‘
- ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®æ¡ˆä»¶ã¯ç‰çŸ³æ··äº¤ã§ã€ã‚¿ã‚¤ãƒˆãƒ«ã§æŒ‡å®šã—ãŸä¾¡æ ¼ãŒæ¡ˆä»¶è©³ç´°ã§ã¯å˜˜ã ã¨æ›¸ã‹ã‚Œã¦ã„ãŸã‚Šã—ã¾ã™
- è©³ç´°èª¬æ˜ã‚’æ³¨æ„æ·±ãèª­ã¿ã€å®Ÿéš›ã®ä½œæ¥­å†…å®¹ã¨å ±é…¬ã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã¦ãã ã•ã„
- ã‚¿ã‚¤ãƒˆãƒ«ã®é‡‘é¡ã«æƒ‘ã‚ã•ã‚Œãšã€è©³ç´°ã«æ›¸ã‹ã‚ŒãŸå®Ÿéš›ã®æ¡ä»¶ã‹ã‚‰ç¢ºã‹ã‚‰ã—ã„æƒ³å®šæ™‚çµ¦ã‚’ç®—å‡ºã—ã¦ãã ã•ã„
- ã€Œã€‡ã€‡å††ã‚¹ã‚¿ãƒ¼ãƒˆã€ã€Œèƒ½åŠ›ã«å¿œã˜ã¦ã€ãªã©ã®æ›–æ˜§ãªè¡¨ç¾ã«ã‚‚æ³¨æ„ã—ã¦ãã ã•ã„
- åˆå›ã¯ä½ä¾¡æ ¼ã§ã€Œç¶™ç¶šã§å˜ä¾¡ã‚¢ãƒƒãƒ—ã€ã¨ã„ã†æ¡ˆä»¶ã¯ã€åˆå›ä¾¡æ ¼ã‚’åŸºæº–ã«è¨ˆç®—ã—ã¦ãã ã•ã„
- **æ™‚çµ¦ã¯å¿…ãš1ã¤ã®å…·ä½“çš„ãªæ•°å€¤ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š2500å††ï¼‰ã€‚ç¯„å›²ã‚„æ›–æ˜§ãªè¡¨ç¾ã¯ç¦æ­¢ã§ã™**
- **é›£æ˜“åº¦ã¯å¿…ãšã€Œç°¡å˜ã€ã€Œæ™®é€šã€ã€Œé›£ã—ã„ã€ã®ã„ãšã‚Œã‹1ã¤ã§å›ç­”ã—ã¦ãã ã•ã„**
- **å®Ÿéš›ã®ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ä½œæ¥­ã®ç¾å®Ÿã‚’åæ˜ ã—ãŸã€ååˆ†ãªå·¥æ•°ã‚’è¦‹ç©ã‚‚ã£ã¦ãã ã•ã„**

---
ã‚¿ã‚¤ãƒˆãƒ«: ${detail.title}

è©³ç´°èª¬æ˜: ${detail.detailedDescription}
---

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
å·¥æ•°: <ä¾‹: 8æ™‚é–“>
æ™‚çµ¦: <ä¾‹: 2500å††>
é›£æ˜“åº¦: <ä¾‹: æ™®é€š>
è¦ç´„: <æ ¹æ‹ ã‚„æ³¨æ„ç‚¹ã‚’1-2æ–‡ã§>`;

    return limiter.execute(async () => {
        const res = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'ã‚ãªãŸã¯æ—¥æœ¬ã®ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹å¸‚å ´ã®å°‚é–€å®¶ã§ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã®ç¾å®Ÿçš„ãªå·¥æ•°è¦‹ç©ã‚‚ã‚Šã¨æ™‚çµ¦æ¨å®šã®å°‚é–€å®¶ã§ã™ã€‚å®Ÿéš›ã®ãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚¹ä½œæ¥­ã§ã¯è¦ä»¶å®šç¾©ã‚„æ‰“ã¡åˆã‚ã›ã€ä¿®æ­£ä½œæ¥­ãªã©ã‚‚å¿…è¦ã§ã€è¨˜è¼‰ã•ã‚ŒãŸä½œæ¥­ä»¥å¤–ã«ã‚‚å¤šãã®ä»˜å¸¯ä½œæ¥­ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’ç†è§£ã—ã¦ã„ã¾ã™ã€‚' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 512,
            temperature: 0.2,
        });

        const text = res.choices[0]?.message?.content || '';
        // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ‘ãƒ¼ã‚¹
        const å·¥æ•° = text.match(/å·¥æ•°[:ï¼š]\s*(.+)/)?.[1]?.trim() || '';
        const æ™‚çµ¦ = text.match(/æ™‚çµ¦[:ï¼š]\s*(.+)/)?.[1]?.trim() || '';
        const é›£æ˜“åº¦ = text.match(/é›£æ˜“åº¦[:ï¼š]\s*(.+)/)?.[1]?.trim() || '';
        const è¦ç´„ = text.match(/è¦ç´„[:ï¼š]\s*([\s\S]*)/)?.[1]?.trim() || text;

        return {
            jobId: detail.jobId,
            title: detail.title,
            å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: å·¥æ•°,
            æƒ³å®šæ™‚çµ¦: æ™‚çµ¦,
            é›£æ˜“åº¦: é›£æ˜“åº¦,
            gpt_summary: è¦ç´„,
        };
    });
}

(async () => {
    console.log(`ğŸš€ ä¸¦åˆ—åˆ†æé–‹å§‹: ${details.length}ä»¶ï¼ˆæœ€å¤§5ä»¶ä¸¦åˆ—ï¼‰`);
    const results: AnalysisResult[] = [];
    let completed = 0;

    // å…¨ã¦ã®æ¡ˆä»¶ã‚’ä¸¦åˆ—ã§å‡¦ç†é–‹å§‹
    const promises = details.map(async (detail, index) => {
        try {
            const result = await analyzeDetail(detail);
            results.push(result);
            completed++;
            console.log(`âœ… [${completed}/${details.length}] ${detail.title.substring(0, 50)}...`);

            // å®šæœŸçš„ã«ä¸­é–“çµæœã‚’ä¿å­˜
            if (completed % 5 === 0 || completed === details.length) {
                // çµæœã‚’jobIdé †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¿å­˜
                const sortedResults = results.sort((a, b) => a.jobId.localeCompare(b.jobId));
                writeFileSync(outputPath, JSON.stringify(sortedResults, null, 2), 'utf8');
                console.log(`ğŸ’¾ ä¸­é–“ä¿å­˜: ${completed}ä»¶å®Œäº†`);
            }

            return { success: true, result, index };
        } catch (e) {
            console.error(`âŒ [${index + 1}/${details.length}] ${detail.title.substring(0, 50)}... - ã‚¨ãƒ©ãƒ¼:`, e);
            return { success: false, error: e, index };
        }
    });

    // å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿ
    const settledResults = await Promise.allSettled(promises);

    // æœ€çµ‚çµæœã®çµ±è¨ˆ
    const successful = settledResults.filter(r => r.status === 'fulfilled' && r.value.success).length;
    const failed = settledResults.length - successful;

    console.log(`\nğŸ¯ ä¸¦åˆ—åˆ†æå®Œäº†:`)
    console.log(`âœ… æˆåŠŸ: ${successful}ä»¶`);
    console.log(`âŒ å¤±æ•—: ${failed}ä»¶`);
    console.log(`ğŸ“ å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«: ${outputPath}`);

    // æœ€çµ‚ä¿å­˜ï¼ˆjobIdé †ã§ã‚½ãƒ¼ãƒˆï¼‰
    const finalResults = results.sort((a, b) => a.jobId.localeCompare(b.jobId));
    writeFileSync(outputPath, JSON.stringify(finalResults, null, 2), 'utf8');
    console.log(`ğŸ’¾ æœ€çµ‚ä¿å­˜å®Œäº†: ${finalResults.length}ä»¶`);
})();
</file>

<file path="scripts/setup-github-oidc.sh">
#!/bin/bash

# GitHub Actions OIDCç”¨ã®IAMãƒ­ãƒ¼ãƒ«ä½œæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨æ–¹æ³•: ./scripts/setup-github-oidc.sh <YOUR_GITHUB_USERNAME> <REPOSITORY_NAME>

set -e

# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
if [ $# -ne 2 ]; then
    echo "ä½¿ç”¨æ–¹æ³•: $0 <GITHUB_USERNAME> <REPOSITORY_NAME>"
    echo "ä¾‹: $0 myusername crowdworks-search"
    exit 1
fi

GITHUB_USERNAME=$1
REPOSITORY_NAME=$2
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
AWS_REGION=$(aws configure get region || echo "ap-northeast-1")

echo "ğŸš€ GitHub Actions OIDCèªè¨¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’é–‹å§‹ã—ã¾ã™..."
echo "GitHub: ${GITHUB_USERNAME}/${REPOSITORY_NAME}"
echo "AWS Account: ${AWS_ACCOUNT_ID}"
echo "AWS Region: ${AWS_REGION}"

# OIDC Identity Providerã®ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
echo "ğŸ“‹ OIDC Identity Providerã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
if ! aws iam get-open-id-connect-provider --open-id-connect-provider-arn "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com" 2>/dev/null; then
    echo "ğŸ“ OIDC Identity Providerã‚’ä½œæˆä¸­..."
    aws iam create-open-id-connect-provider \
        --url "https://token.actions.githubusercontent.com" \
        --thumbprint-list "6938fd4d98bab03faadb97b34396831e3780aea1" \
        --client-id-list "sts.amazonaws.com"
    echo "âœ… OIDC Identity Providerã‚’ä½œæˆã—ã¾ã—ãŸ"
else
    echo "âœ… OIDC Identity Providerã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"
fi

# Stagingç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ä½œæˆ
echo "ğŸ“ Stagingç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆä¸­..."
STAGING_ROLE_NAME="GitHubActions-CrowdWorksSearch-Staging"

# ä¿¡é ¼ãƒãƒªã‚·ãƒ¼
cat > /tmp/staging-trust-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": [
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:ref:refs/heads/develop",
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:environment:staging"
                    ]
                }
            }
        }
    ]
}
EOF

# Productionç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ä½œæˆ
echo "ğŸ“ Productionç’°å¢ƒç”¨IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆä¸­..."
PRODUCTION_ROLE_NAME="GitHubActions-CrowdWorksSearch-Production"

# ä¿¡é ¼ãƒãƒªã‚·ãƒ¼
cat > /tmp/production-trust-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::${AWS_ACCOUNT_ID}:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringEquals": {
                    "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
                },
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": [
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:ref:refs/heads/main",
                        "repo:${GITHUB_USERNAME}/${REPOSITORY_NAME}:environment:production"
                    ]
                }
            }
        }
    ]
}
EOF

# æ¨©é™ãƒãƒªã‚·ãƒ¼
cat > /tmp/deploy-policy.json << EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "cloudformation:*",
                "s3:*",
                "lambda:*",
                "iam:*",
                "logs:*",
                "events:*",
                "ecr:*",
                "ssm:GetParameter",
                "ssm:GetParameters",
                "sts:AssumeRole"
            ],
            "Resource": "*"
        }
    ]
}
EOF

# Stagingãƒ­ãƒ¼ãƒ«ä½œæˆ
if aws iam get-role --role-name "${STAGING_ROLE_NAME}" 2>/dev/null; then
    echo "âš ï¸  Stagingãƒ­ãƒ¼ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/N)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        aws iam delete-role --role-name "${STAGING_ROLE_NAME}" || true
    else
        echo "Stagingãƒ­ãƒ¼ãƒ«ã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
    fi
fi

if ! aws iam get-role --role-name "${STAGING_ROLE_NAME}" 2>/dev/null; then
    aws iam create-role \
        --role-name "${STAGING_ROLE_NAME}" \
        --assume-role-policy-document file:///tmp/staging-trust-policy.json \
        --description "GitHub Actions deployment role for staging environment"
    
    aws iam put-role-policy \
        --role-name "${STAGING_ROLE_NAME}" \
        --policy-name "DeploymentPolicy" \
        --policy-document file:///tmp/deploy-policy.json
    
    echo "âœ… Stagingãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

# Productionãƒ­ãƒ¼ãƒ«ä½œæˆ
if aws iam get-role --role-name "${PRODUCTION_ROLE_NAME}" 2>/dev/null; then
    echo "âš ï¸  Productionãƒ­ãƒ¼ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ (y/N)"
    read -r response
    if [[ "$response" =~ ^[Yy]$ ]]; then
        aws iam delete-role --role-name "${PRODUCTION_ROLE_NAME}" || true
    else
        echo "Productionãƒ­ãƒ¼ãƒ«ã®ä½œæˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
    fi
fi

if ! aws iam get-role --role-name "${PRODUCTION_ROLE_NAME}" 2>/dev/null; then
    aws iam create-role \
        --role-name "${PRODUCTION_ROLE_NAME}" \
        --assume-role-policy-document file:///tmp/production-trust-policy.json \
        --description "GitHub Actions deployment role for production environment"
    
    aws iam put-role-policy \
        --role-name "${PRODUCTION_ROLE_NAME}" \
        --policy-name "DeploymentPolicy" \
        --policy-document file:///tmp/deploy-policy.json
    
    echo "âœ… Productionãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
fi

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
rm -f /tmp/staging-trust-policy.json /tmp/production-trust-policy.json /tmp/deploy-policy.json

echo ""
echo "ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
echo ""
echo "æ¬¡ã®æ‰‹é †:"
echo "1. GitHubãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables > Actions ã§ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š"
echo ""
echo "   STAGING_AWS_ROLE_ARN=arn:aws:iam::${AWS_ACCOUNT_ID}:role/${STAGING_ROLE_NAME}"
echo "   PRODUCTION_AWS_ROLE_ARN=arn:aws:iam::${AWS_ACCOUNT_ID}:role/${PRODUCTION_ROLE_NAME}"
echo ""
echo "2. (ã‚ªãƒ—ã‚·ãƒ§ãƒ³) Slacké€šçŸ¥ç”¨ï¼š"
echo "   SLACK_WEBHOOK_URL=<your-slack-webhook-url>"
echo ""
echo "3. GitHubã§Environmentsã‚’è¨­å®šï¼š"
echo "   - Settings > Environments"
echo "   - 'staging' ç’°å¢ƒã‚’ä½œæˆ"
echo "   - 'production' ç’°å¢ƒã‚’ä½œæˆï¼ˆä¿è­·ãƒ«ãƒ¼ãƒ«è¨­å®šæ¨å¥¨ï¼‰"
echo ""
echo "ã“ã‚Œã§CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§AWSãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼"
</file>

<file path="scripts/sort-by-hourly-rate.ts">
require('dotenv').config();

import { readFileSync, writeFileSync } from 'fs';

// å‹å®šç¾©
interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    gpt_summary: string;
    category?: string; // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã‚’è¿½åŠ 
}

interface SortedResult extends AnalysisResult {
    hourly_rate_numeric: number; // æ•°å€¤åŒ–ã—ãŸæ™‚çµ¦
}

// æ™‚çµ¦æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function parseHourlyRate(hourlyRateString: string): number {
    if (!hourlyRateString || hourlyRateString.trim() === '' || hourlyRateString === '0å††') {
        return 0;
    }

    // ã€Œ3000å††ã€ã€Œ1,500å††ã€ã€Œ2500å††ã€ãªã©ã‹ã‚‰æ•°å€¤ã‚’æŠ½å‡º
    const match = hourlyRateString.match(/([0-9,]+)/);
    if (match && match[1]) {
        const numericString = match[1].replace(/,/g, ''); // ã‚«ãƒ³ãƒã‚’é™¤å»
        return parseInt(numericString, 10);
    }

    return 0;
}

// ã‚½ãƒ¼ãƒˆç¨®åˆ¥
type SortOrder = 'high' | 'low';

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
function sortAnalysisResults(order: SortOrder = 'high'): void {
    console.log(`ğŸ”„ æƒ³å®šæ™‚çµ¦ã«ã‚ˆã‚‹${order === 'high' ? 'é«˜é¡é †' : 'ä½é¡é †'}ã‚½ãƒ¼ãƒˆã‚’é–‹å§‹...`);

    const results: SortedResult[] = [];

    // ECã‚«ãƒ†ã‚´ãƒªã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        const ecData: AnalysisResult[] = JSON.parse(readFileSync('analyzed-ec.json', 'utf8'));
        ecData.forEach(item => {
            results.push({
                ...item,
                category: 'EC',
                hourly_rate_numeric: parseHourlyRate(item.æƒ³å®šæ™‚çµ¦)
            });
        });
        console.log(`âœ… ECã‚«ãƒ†ã‚´ãƒª: ${ecData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (e) {
        console.log(`âš ï¸ ECã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-ec.json`);
    }

    // Webè£½å“ã‚«ãƒ†ã‚´ãƒªã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        const webData: AnalysisResult[] = JSON.parse(readFileSync('analyzed-web_products.json', 'utf8'));
        webData.forEach(item => {
            results.push({
                ...item,
                category: 'Webè£½å“',
                hourly_rate_numeric: parseHourlyRate(item.æƒ³å®šæ™‚çµ¦)
            });
        });
        console.log(`âœ… Webè£½å“ã‚«ãƒ†ã‚´ãƒª: ${webData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (e) {
        console.log(`âš ï¸ Webè£½å“ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-web_products.json`);
    }

    if (results.length === 0) {
        console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ');
        return;
    }

    // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
    const sortedResults = results.sort((a, b) => {
        if (order === 'high') {
            return b.hourly_rate_numeric - a.hourly_rate_numeric; // é«˜é¡é †
        } else {
            return a.hourly_rate_numeric - b.hourly_rate_numeric; // ä½é¡é †
        }
    });

    console.log(`ğŸ” ã‚½ãƒ¼ãƒˆå®Œäº†: ${sortedResults.length}ä»¶`);

    // çµ±è¨ˆæƒ…å ±ã‚’å…ˆã«è¡¨ç¤º
    const validResults = sortedResults.filter(r => r.hourly_rate_numeric > 0);
    if (validResults.length > 0) {
        const maxRate = Math.max(...validResults.map(r => r.hourly_rate_numeric));
        const minRate = Math.min(...validResults.map(r => r.hourly_rate_numeric));
        const avgRate = Math.round(validResults.reduce((sum, r) => sum + r.hourly_rate_numeric, 0) / validResults.length);

        console.log(`\nğŸ“ˆ çµ±è¨ˆæƒ…å ±:`);
        console.log(`æœ€é«˜æ™‚çµ¦: ${maxRate.toLocaleString()}å††`);
        console.log(`æœ€ä½æ™‚çµ¦: ${minRate.toLocaleString()}å††`);
        console.log(`å¹³å‡æ™‚çµ¦: ${avgRate.toLocaleString()}å††`);
        console.log(`æœ‰åŠ¹æ¡ˆä»¶: ${validResults.length}ä»¶ / å…¨${sortedResults.length}ä»¶`);
    }

    // çµæœè¡¨ç¤ºï¼ˆä¸Šä½20ä»¶ï¼‰
    console.log(`\nğŸ“Š ${order === 'high' ? 'é«˜æ™‚çµ¦' : 'ä½æ™‚çµ¦'}ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20:\n`);

    // è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆ0å††æ¡ˆä»¶ã‚’é™¤å¤–ï¼‰
    const displayResults = order === 'low'
        ? sortedResults.filter(r => r.hourly_rate_numeric > 0)
        : sortedResults;

    console.log(`ğŸ“‹ è¡¨ç¤ºå¯¾è±¡: ${displayResults.length}ä»¶`);

    displayResults.slice(0, 20).forEach((item, index) => {
        const rank = index + 1;
        const hourlyRate = item.hourly_rate_numeric.toLocaleString() + 'å††';
        const category = item.category || 'N/A';
        const workHours = item.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š || 'N/A';
        const summary = (item.gpt_summary || '').substring(0, 50) + '...';

        console.log(`${rank}ä½: ${hourlyRate} (${category}) - å·¥æ•°: ${workHours}`);
        console.log(`   æ¦‚è¦: ${summary}\n`);
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    const outputFileName = `sorted-by-hourly-rate-${order}.json`;
    writeFileSync(outputFileName, JSON.stringify(sortedResults, null, 2), 'utf8');
    console.log(`\nğŸ’¾ çµæœã‚’ä¿å­˜: ${outputFileName} (${sortedResults.length}ä»¶)`);
}

// ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°å–å¾—
const [, , sortOrder] = process.argv;
const order: SortOrder = (sortOrder === 'low') ? 'low' : 'high';

// å®Ÿè¡Œ
sortAnalysisResults(order);
</file>

<file path="app.ts">
#!/usr/bin/env node
import 'source-map-support/register';
import * as cdk from 'aws-cdk-lib';
import { CrowdWorksSearcherStack } from './src/infrastructure/crowdworks-searcher-stack';

const app = new cdk.App();

// ç’°å¢ƒè¨­å®š
const account = process.env['CDK_DEFAULT_ACCOUNT'];
const region = process.env['CDK_DEFAULT_REGION'] || process.env['AWS_REGION'] || 'ap-northeast-1';
const stage = app.node.tryGetContext('stage') || process.env['STAGE'] || 'dev';

const env: cdk.Environment = account ? { account, region } : { region };

// ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥ã®ã‚¹ã‚¿ãƒƒã‚¯è¨­å®š
const getStackConfig = (stage: string) => {
    const baseConfig = {
        env,
        description: `CrowdWorks Auto Job Searcher System - ${stage.toUpperCase()}`,
        stage,
    };

    switch (stage) {
        case 'production':
            return {
                ...baseConfig,
                terminationProtection: true, // æœ¬ç•ªç’°å¢ƒã§ã¯å‰Šé™¤ä¿è­·ã‚’æœ‰åŠ¹
            };
        case 'staging':
            return {
                ...baseConfig,
                terminationProtection: false,
            };
        default: // dev, test, etc.
            return {
                ...baseConfig,
                terminationProtection: false,
            };
    }
};

// ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆ
const stackConfig = getStackConfig(stage);
new CrowdWorksSearcherStack(app, `CrowdWorksSearcherStack-${stage}`, stackConfig);

// ã‚¿ã‚°ã‚’å…¨ãƒªã‚½ãƒ¼ã‚¹ã«é©ç”¨
cdk.Tags.of(app).add('Application', 'CrowdWorksSearcher');
cdk.Tags.of(app).add('Stage', stage);
cdk.Tags.of(app).add('ManagedBy', 'CDK');

console.log(`ğŸš€ Deploying CrowdWorks Searcher to ${stage.toUpperCase()} environment`);
console.log(`   Region: ${region}`);
console.log(`   Account: ${account || 'default'}`);
</file>

<file path="env.example">
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ç’°å¢ƒå¤‰æ•°
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ .env ã«ã‚³ãƒ”ãƒ¼ã—ã¦å®Ÿéš›ã®å€¤ã‚’è¨­å®šã—ã¦ãã ã•ã„

# CrowdWorksèªè¨¼æƒ…å ±ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
CROWDWORKS_EMAIL=your-crowdworks-email@example.com
CROWDWORKS_PASSWORD=your-crowdworks-password

# AWSè¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
AWS_REGION=ap-northeast-1
AWS_PROFILE=default

# ãƒ‡ãƒãƒƒã‚°è¨­å®š
NODE_ENV=development
LOG_LEVEL=debug
DEBUG=1

# Playwrightè¨­å®šï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ï¼‰
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯é€šå¸¸ã¯ç©ºã¾ãŸã¯æœªè¨­å®šã§OKï¼ˆPlaywrightãŒè‡ªå‹•ã§è¦‹ã¤ã‘ã‚‹ï¼‰
# ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¹ã‚’ä½¿ã„ãŸã„å ´åˆã®ã¿è¨­å®š
PLAYWRIGHT_BROWSERS_PATH=
# ä¾‹ï¼šã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å ´æ‰€ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
# PLAYWRIGHT_BROWSERS_PATH=C:\Users\n\AppData\Local\ms-playwright

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„ï¼ˆ0 = ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ï¼‰
PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0
</file>

<file path="scripts/calculate-recommendation-score.ts">
require('dotenv').config();

import { readFileSync, writeFileSync } from 'fs';
import { OpenAI } from 'openai';

// å‹å®šç¾©
interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    é›£æ˜“åº¦: string;
    gpt_summary: string;
    category?: string;
}

interface ScoredJob extends AnalysisResult {
    hourly_rate_numeric: number;
    workload_hours: number;
    difficulty_score: number;
    skill_fit_score: number;
    recommendation_score: number;
    link: string;
    original_title?: string;
    proposal_greeting?: string;
    specification_questions?: string;
    skill_analysis?: string;
}

// .envã‹ã‚‰APIã‚­ãƒ¼å–å¾—
const apiKey = process.env['OPENAI_API_KEY'];
if (!apiKey) {
    console.error('âŒ OPENAI_API_KEYãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    process.exit(1);
}

const openai = new OpenAI({ apiKey });

// æ™‚çµ¦æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function parseHourlyRate(hourlyRateString: string): number {
    if (!hourlyRateString || hourlyRateString.trim() === '' || hourlyRateString === '0å††') {
        return 0;
    }

    const match = hourlyRateString.match(/([0-9,]+)/);
    if (match && match[1]) {
        const numericString = match[1].replace(/,/g, '');
        return parseInt(numericString, 10);
    }

    return 0;
}

// å·¥æ•°æ–‡å­—åˆ—ã‚’æ•°å€¤ï¼ˆæ™‚é–“ï¼‰ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function parseWorkloadHours(workloadString: string): number {
    if (!workloadString || workloadString.trim() === '') {
        return 40; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    }

    // ã€Œ120æ™‚é–“ã€ã€Œ2é€±é–“ã€ã€Œ1ãƒ¶æœˆã€ãªã©ã‚’è§£æ
    const hourMatch = workloadString.match(/([0-9,]+)\s*æ™‚é–“/);
    if (hourMatch && hourMatch[1]) {
        return parseInt(hourMatch[1].replace(/,/g, ''), 10);
    }

    const dayMatch = workloadString.match(/([0-9,]+)\s*æ—¥/);
    if (dayMatch && dayMatch[1]) {
        return parseInt(dayMatch[1].replace(/,/g, ''), 10) * 8; // 1æ—¥8æ™‚é–“æƒ³å®š
    }

    const weekMatch = workloadString.match(/([0-9,]+)\s*é€±é–“/);
    if (weekMatch && weekMatch[1]) {
        return parseInt(weekMatch[1].replace(/,/g, ''), 10) * 40; // 1é€±é–“40æ™‚é–“æƒ³å®š
    }

    const monthMatch = workloadString.match(/([0-9,]+)\s*ãƒ¶?æœˆ/);
    if (monthMatch && monthMatch[1]) {
        return parseInt(monthMatch[1].replace(/,/g, ''), 10) * 160; // 1ãƒ¶æœˆ160æ™‚é–“æƒ³å®š
    }

    return 40; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
}

// é›£æ˜“åº¦ã‚’ç‚¹æ•°ã«å¤‰æ›ã™ã‚‹é–¢æ•°ï¼ˆç°¡å˜ã»ã©é«˜å¾—ç‚¹ï¼‰
function parseDifficultyScore(difficultyString: string): number {
    const difficulty = difficultyString.trim().toLowerCase();

    if (difficulty.includes('ç°¡å˜') || difficulty.includes('ã‹ã‚“ãŸã‚“')) {
        return 10; // ç°¡å˜ = é«˜å¾—ç‚¹
    } else if (difficulty.includes('æ™®é€š') || difficulty.includes('ãµã¤ã†') || difficulty.includes('æ¨™æº–')) {
        return 6; // æ™®é€š = ä¸­å¾—ç‚¹
    } else if (difficulty.includes('é›£ã—ã„') || difficulty.includes('ã‚€ãšã‹ã—ã„') || difficulty.includes('å›°é›£')) {
        return 3; // é›£ã—ã„ = ä½å¾—ç‚¹
    }

    return 5; // ä¸æ˜ãªå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
}

// ===== è©•ä¾¡ä¿‚æ•°è¨­å®š =====
// ä¿‚æ•°ã‚’å¤‰æ›´ã™ã‚‹ã“ã¨ã§è©•ä¾¡ã®é‡è¦åº¦ã‚’èª¿æ•´ã§ãã¾ã™
const EVALUATION_COEFFICIENTS = {
    HOURLY: 2.0,          // æ™‚çµ¦é‡è¦–åº¦
    WORKLOAD: 1.0,        // å·¥æ•°ãƒãƒ©ãƒ³ã‚¹é‡è¦–åº¦
    SKILL_FIT: 2.5        // ã‚¹ã‚­ãƒ«é©æ€§é‡è¦–åº¦
    // é›£æ˜“åº¦ã¯è¡¨ç¤ºã®ã¿ã§ç‚¹æ•°è¨ˆç®—ã‹ã‚‰é™¤å¤–
};

// ãŠã™ã™ã‚ç‚¹æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆã‚¹ã‚­ãƒ«é©æ€§è€ƒæ…®ç‰ˆï¼‰
function calculateRecommendationScore(
    hourlyRate: number,
    workloadHours: number,
    skillFitScore: number
): number {
    // æ™‚çµ¦ã‚¹ã‚³ã‚¢ï¼ˆ0-10ç‚¹ï¼‰: æ™‚çµ¦ãŒé«˜ã„ã»ã©é«˜å¾—ç‚¹
    let hourlyScore = 0;
    if (hourlyRate >= 4000) hourlyScore = 10;
    else if (hourlyRate >= 3500) hourlyScore = 9;
    else if (hourlyRate >= 3000) hourlyScore = 8;
    else if (hourlyRate >= 2500) hourlyScore = 7;
    else if (hourlyRate >= 2000) hourlyScore = 6;
    else if (hourlyRate >= 1500) hourlyScore = 5;
    else if (hourlyRate >= 1000) hourlyScore = 4;
    else if (hourlyRate >= 500) hourlyScore = 3;
    else if (hourlyRate > 0) hourlyScore = 2;
    else hourlyScore = 0;

    // å·¥æ•°ã‚¹ã‚³ã‚¢ï¼ˆ0-10ç‚¹ï¼‰: é©åº¦ãªå·¥æ•°ï¼ˆ20-80æ™‚é–“ï¼‰ãŒé«˜å¾—ç‚¹
    let workloadScore = 0;
    if (workloadHours >= 20 && workloadHours <= 80) {
        workloadScore = 10; // æœ€é©ç¯„å›²
    } else if (workloadHours >= 10 && workloadHours <= 120) {
        workloadScore = 8; // è‰¯ã„ç¯„å›²
    } else if (workloadHours >= 5 && workloadHours <= 160) {
        workloadScore = 6; // è¨±å®¹ç¯„å›²
    } else if (workloadHours > 0 && workloadHours <= 200) {
        workloadScore = 4; // å¾®å¦™ãªç¯„å›²
    } else {
        workloadScore = 2; // æ¥µç«¯ãªå·¥æ•°
    }

    // ä¿‚æ•°ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆã‚¹ã‚­ãƒ«é©æ€§é‡è¦–ï¼‰
    const totalScore = (hourlyScore * EVALUATION_COEFFICIENTS.HOURLY) +
        (workloadScore * EVALUATION_COEFFICIENTS.WORKLOAD) +
        (skillFitScore * EVALUATION_COEFFICIENTS.SKILL_FIT);

    return Math.round(totalScore * 10) / 10; // å°æ•°ç‚¹1ä½ã¾ã§
}

// è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getOriginalJobData(jobId: string, detailsData: any[]): any {
    return detailsData.find(job => job.jobId === jobId);
}

// ä¸¦åˆ—å®Ÿè¡Œåˆ¶å¾¡ã‚¯ãƒ©ã‚¹
class ConcurrencyLimiter {
    private runningCount = 0;
    private queue: (() => Promise<void>)[] = [];

    constructor(private maxConcurrency: number) { }

    async execute<T>(task: () => Promise<T>): Promise<T> {
        return new Promise<T>((resolve, reject) => {
            const wrappedTask = async () => {
                try {
                    this.runningCount++;
                    const result = await task();
                    resolve(result);
                } catch (error) {
                    reject(error);
                } finally {
                    this.runningCount--;
                    this.processQueue();
                }
            };

            if (this.runningCount < this.maxConcurrency) {
                wrappedTask();
            } else {
                this.queue.push(wrappedTask);
            }
        });
    }

    private processQueue() {
        if (this.queue.length > 0 && this.runningCount < this.maxConcurrency) {
            const nextTask = this.queue.shift();
            if (nextTask) {
                nextTask();
            }
        }
    }
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆéåŒæœŸç‰ˆï¼‰
async function calculateRecommendationScores(): Promise<void> {
    console.log('ğŸ”„ ãŠã™ã™ã‚ç‚¹æ•°è¨ˆç®—ã‚’é–‹å§‹...');

    const scoredJobs: ScoredJob[] = [];

    // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã‚€ï¼ˆå…ƒã®ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ç”¨ï¼‰
    let ecDetailsData: any[] = [];
    let webDetailsData: any[] = [];

    // ECè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    try {
        ecDetailsData = JSON.parse(readFileSync('output/details-ec.json', 'utf8'));
        console.log(`ğŸ“‚ ECè©³ç´°ãƒ‡ãƒ¼ã‚¿: ${ecDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ ECè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
    }

    // Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    try {
        webDetailsData = JSON.parse(readFileSync('output/details-web_products.json', 'utf8'));
        console.log(`ğŸ“‚ Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${webDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
    }

    // ECã‚«ãƒ†ã‚´ãƒªã®åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        const ecData: AnalysisResult[] = JSON.parse(readFileSync('analyzed-ec.json', 'utf8'));
        ecData.forEach(item => {
            const hourlyRate = parseHourlyRate(item.æƒ³å®šæ™‚çµ¦);
            const workloadHours = parseWorkloadHours(item.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š);
            const difficultyScore = parseDifficultyScore(item.é›£æ˜“åº¦);
            const skillFitScore = 5; // ä»®ã®ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ï¼ˆå¾Œã§æ›´æ–°ï¼‰
            const recommendationScore = calculateRecommendationScore(hourlyRate, workloadHours, skillFitScore);

            const originalJob = getOriginalJobData(item.jobId, ecDetailsData);

            scoredJobs.push({
                ...item,
                category: 'EC',
                hourly_rate_numeric: hourlyRate,
                workload_hours: workloadHours,
                difficulty_score: difficultyScore,
                skill_fit_score: skillFitScore,
                recommendation_score: recommendationScore,
                link: `https://crowdworks.jp/public/jobs/${item.jobId}`,
                original_title: originalJob?.title || item.title
            });
        });
        console.log(`âœ… ECã‚«ãƒ†ã‚´ãƒª: ${ecData.length}ä»¶å‡¦ç†å®Œäº†`);
    } catch (e) {
        console.log('âš ï¸ ECã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-ec.json');
    }

    // Webè£½å“ã‚«ãƒ†ã‚´ãƒªã®åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        const webData: AnalysisResult[] = JSON.parse(readFileSync('analyzed-web_products.json', 'utf8'));
        webData.forEach(item => {
            const hourlyRate = parseHourlyRate(item.æƒ³å®šæ™‚çµ¦);
            const workloadHours = parseWorkloadHours(item.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š);
            const difficultyScore = parseDifficultyScore(item.é›£æ˜“åº¦);
            const skillFitScore = 5; // ä»®ã®ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ï¼ˆå¾Œã§æ›´æ–°ï¼‰
            const recommendationScore = calculateRecommendationScore(hourlyRate, workloadHours, skillFitScore);

            const originalJob = getOriginalJobData(item.jobId, webDetailsData);

            scoredJobs.push({
                ...item,
                category: 'Webè£½å“',
                hourly_rate_numeric: hourlyRate,
                workload_hours: workloadHours,
                difficulty_score: difficultyScore,
                skill_fit_score: skillFitScore,
                recommendation_score: recommendationScore,
                link: `https://crowdworks.jp/public/jobs/${item.jobId}`,
                original_title: originalJob?.title || item.title
            });
        });
        console.log(`âœ… Webè£½å“ã‚«ãƒ†ã‚´ãƒª: ${webData.length}ä»¶å‡¦ç†å®Œäº†`);
    } catch (e) {
        console.log('âš ï¸ Webè£½å“ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-web_products.json');
    }

    if (scoredJobs.length === 0) {
        console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ');
        return;
    }

    // å…¨æ¡ˆä»¶ã®ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡ã‚’å®Ÿè¡Œ
    console.log(`\nğŸ§  å…¨æ¡ˆä»¶ã®ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡ä¸­ï¼ˆæœ€å¤§5ä»¶ä¸¦åˆ—ï¼‰...`);

    const limiter = new ConcurrencyLimiter(5);
    let skillAnalysisCount = 0;

    const skillAnalysisPromises = scoredJobs.map(async (job, index) => {
        try {
            const allDetailsData = [...ecDetailsData, ...webDetailsData];
            const originalJob = getOriginalJobData(job.jobId, allDetailsData);

            const { score, analysis } = await limiter.execute(() =>
                analyzeSkillFit(job, originalJob)
            );

            job.skill_fit_score = score;
            job.skill_analysis = analysis;

            // ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ã§ãŠã™ã™ã‚ç‚¹æ•°ã‚’å†è¨ˆç®—
            job.recommendation_score = calculateRecommendationScore(
                job.hourly_rate_numeric,
                job.workload_hours,
                score
            );

            skillAnalysisCount++;
            console.log(`âœ… [${skillAnalysisCount}/${scoredJobs.length}] ${job.original_title?.substring(0, 40)}... ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡å®Œäº†`);

            return { success: true, index };
        } catch (error) {
            console.error(`âŒ [${index + 1}/${scoredJobs.length}] ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡ã‚¨ãƒ©ãƒ¼:`, error);
            return { success: false, index };
        }
    });

    await Promise.allSettled(skillAnalysisPromises);
    console.log(`ğŸ¯ ã‚¹ã‚­ãƒ«é©æ€§è©•ä¾¡å®Œäº†: ${skillAnalysisCount}/${scoredJobs.length}ä»¶æˆåŠŸ`);

    // ãŠã™ã™ã‚ç‚¹æ•°é †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜å¾—ç‚¹é †ï¼‰
    const sortedJobs = scoredJobs.sort((a, b) => b.recommendation_score - a.recommendation_score);

    // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
    const validJobs = sortedJobs.filter(j => j.hourly_rate_numeric > 0);
    if (validJobs.length > 0) {
        const maxScore = Math.max(...validJobs.map(j => j.recommendation_score));
        const minScore = Math.min(...validJobs.map(j => j.recommendation_score));
        const avgScore = Math.round((validJobs.reduce((sum, j) => sum + j.recommendation_score, 0) / validJobs.length) * 10) / 10;
        const avgSkillFit = Math.round((validJobs.reduce((sum, j) => sum + j.skill_fit_score, 0) / validJobs.length) * 10) / 10;

        console.log(`\nğŸ“ˆ çµ±è¨ˆæƒ…å ±:`);
        console.log(`æœ€é«˜ãŠã™ã™ã‚ç‚¹æ•°: ${maxScore}ç‚¹`);
        console.log(`æœ€ä½ãŠã™ã™ã‚ç‚¹æ•°: ${minScore}ç‚¹`);
        console.log(`å¹³å‡ãŠã™ã™ã‚ç‚¹æ•°: ${avgScore}ç‚¹`);
        console.log(`å¹³å‡ã‚¹ã‚­ãƒ«é©æ€§: ${avgSkillFit}ç‚¹`);
        console.log(`æœ‰åŠ¹æ¡ˆä»¶: ${validJobs.length}ä»¶ / å…¨${sortedJobs.length}ä»¶`);
    }

    // TOP10æ¡ˆä»¶ã«ææ¡ˆæ–‡ç”Ÿæˆã‚’è¿½åŠ 
    const top10Jobs = sortedJobs.slice(0, 10);
    console.log(`\nğŸ¤– TOP10æ¡ˆä»¶ã®ææ¡ˆæ–‡ç”Ÿæˆä¸­ï¼ˆæœ€å¤§3ä»¶ä¸¦åˆ—ï¼‰...`);

    const proposalLimiter = new ConcurrencyLimiter(3); // ææ¡ˆæ–‡ç”Ÿæˆã¯3ä»¶ä¸¦åˆ—
    let proposalCount = 0;

    const proposalPromises = top10Jobs.map(async (job, index) => {
        try {
            const allDetailsData = [...ecDetailsData, ...webDetailsData];
            const originalJob = getOriginalJobData(job.jobId, allDetailsData);

            const { greeting, questions } = await proposalLimiter.execute(() =>
                generateProposalContent(job, originalJob)
            );

            job.proposal_greeting = greeting;
            job.specification_questions = questions;

            proposalCount++;
            console.log(`âœ… [${proposalCount}/10] ${job.original_title?.substring(0, 40)}... ææ¡ˆæ–‡ç”Ÿæˆå®Œäº†`);

            return { success: true, index };
        } catch (error) {
            console.error(`âŒ [${index + 1}/10] ææ¡ˆæ–‡ç”Ÿæˆã‚¨ãƒ©ãƒ¼:`, error);
            return { success: false, index };
        }
    });

    await Promise.allSettled(proposalPromises);
    console.log(`ğŸ¯ ææ¡ˆæ–‡ç”Ÿæˆå®Œäº†: ${proposalCount}/10ä»¶æˆåŠŸ`);

    // çµæœè¡¨ç¤ºï¼ˆä¸Šä½20ä»¶ï¼‰
    console.log(`\nğŸ† Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘ãŠã™ã™ã‚æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP20:\n`);

    sortedJobs.slice(0, 20).forEach((job, index) => {
        const rank = index + 1;
        const score = job.recommendation_score;
        const hourlyRate = job.hourly_rate_numeric.toLocaleString() + 'å††';
        const category = job.category || 'N/A';
        const difficulty = job.é›£æ˜“åº¦ || 'N/A';
        const workload = job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š || 'N/A';
        const skillFit = job.skill_fit_score?.toFixed(1) || 'N/A';
        const summary = (job.gpt_summary || '').substring(0, 60) + '...';

        console.log(`${rank}ä½: ${score}ç‚¹ | ${hourlyRate} (${category}) | é›£æ˜“åº¦: ${difficulty} | ã‚¹ã‚­ãƒ«é©æ€§: ${skillFit}ç‚¹`);
        console.log(`   å·¥æ•°: ${workload}`);
        console.log(`   æ¦‚è¦: ${summary}`);

        if (job.skill_analysis) {
            console.log(`   ğŸ§  é©æ€§: ${job.skill_analysis.substring(0, 80)}...`);
        }

        // TOP10ãªã‚‰ææ¡ˆæ–‡ã‚‚è¡¨ç¤º
        if (rank <= 10 && job.proposal_greeting) {
            console.log(`   ğŸ’¬ ææ¡ˆæ–‡: ${job.proposal_greeting.substring(0, 60)}...`);
        }
        console.log('');
    });

    // çµæœã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    writeFileSync('output/jobs-with-recommendation-scores.json', JSON.stringify(sortedJobs, null, 2), 'utf8');
    console.log(`ğŸ’¾ çµæœã‚’ä¿å­˜: output/jobs-with-recommendation-scores.json (${sortedJobs.length}ä»¶)`);

    // Markdownãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    const markdown = generateRecommendationMarkdown(sortedJobs.slice(0, 30)); // TOP30
    writeFileSync('output/recommended-jobs-top30.md', markdown, 'utf8');
    console.log(`ğŸ“„ Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜: output/recommended-jobs-top30.md`);
}

// Markdownç”Ÿæˆé–¢æ•°
function generateRecommendationMarkdown(jobs: ScoredJob[]): string {
    const currentDate = new Date().toISOString().split('T')[0];

    let markdown = `# Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å‘ã‘ãŠã™ã™ã‚æ¡ˆä»¶ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP30\n\n`;
    markdown += `> ç”Ÿæˆæ—¥: ${currentDate}  \n`;
    markdown += `> è©•ä¾¡åŸºæº–: ä¿‚æ•°ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ™‚çµ¦Ã—${EVALUATION_COEFFICIENTS.HOURLY} + å·¥æ•°Ã—${EVALUATION_COEFFICIENTS.WORKLOAD} + ã‚¹ã‚­ãƒ«é©æ€§Ã—${EVALUATION_COEFFICIENTS.SKILL_FIT}ï¼‰  \n`;
    markdown += `> å¯¾è±¡è€…: é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚­ãƒ«ä½ã‚ï¼‰  \n`;
    markdown += `> æœ€é«˜å¾—ç‚¹: ${Math.max(...jobs.map(j => j.recommendation_score))}ç‚¹  \n`;
    markdown += `> å¯¾è±¡ä»¶æ•°: ${jobs.length}ä»¶\n`;
    markdown += `> ğŸ’¬ TOP10æ¡ˆä»¶ã«ã¯æˆ¦ç•¥çš„ææ¡ˆæ–‡ãƒ»è³ªå•ã‚’ç”Ÿæˆ\n\n`;

    markdown += `## ğŸ‘¨â€ğŸ’» å¯¾è±¡ã‚¹ã‚­ãƒ«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«\n\n`;
    markdown += `- **é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢**ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¸¡æ–¹ï¼‰\n`;
    markdown += `- **å¾—æ„åˆ†é‡**: ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒ»APIé€£æºãƒ»DBè¨­è¨ˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–\n`;
    markdown += `- **è‹¦æ‰‹åˆ†é‡**: ã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆCSSã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç¨‹åº¦ãªã‚‰å¯¾å¿œå¯èƒ½ï¼‰\n\n`;

    markdown += `## ğŸ“Š è©•ä¾¡åŸºæº–ã®è©³ç´°\n\n`;
    markdown += `### ğŸ’° æ™‚çµ¦ã‚¹ã‚³ã‚¢ï¼ˆä¿‚æ•°ï¼š${EVALUATION_COEFFICIENTS.HOURLY}ï¼‰\n`;
    markdown += `- 4000å††ä»¥ä¸Š: 10ç‚¹ â†’ ${10 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 3500å††ä»¥ä¸Š: 9ç‚¹ â†’ ${9 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 3000å††ä»¥ä¸Š: 8ç‚¹ â†’ ${8 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 2500å††ä»¥ä¸Š: 7ç‚¹ â†’ ${7 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n`;
    markdown += `- 2000å††ä»¥ä¸Š: 6ç‚¹ â†’ ${6 * EVALUATION_COEFFICIENTS.HOURLY}ç‚¹\n\n`;

    markdown += `### â° å·¥æ•°ã‚¹ã‚³ã‚¢ï¼ˆä¿‚æ•°ï¼š${EVALUATION_COEFFICIENTS.WORKLOAD}ï¼‰\n`;
    markdown += `- 20-80æ™‚é–“: 10ç‚¹ â†’ ${10 * EVALUATION_COEFFICIENTS.WORKLOAD}ç‚¹ï¼ˆæœ€é©ãªå·¥æ•°ï¼‰\n`;
    markdown += `- 10-120æ™‚é–“: 8ç‚¹ â†’ ${8 * EVALUATION_COEFFICIENTS.WORKLOAD}ç‚¹ï¼ˆè‰¯ã„ç¯„å›²ï¼‰\n`;
    markdown += `- 5-160æ™‚é–“: 6ç‚¹ â†’ ${6 * EVALUATION_COEFFICIENTS.WORKLOAD}ç‚¹ï¼ˆè¨±å®¹ç¯„å›²ï¼‰\n\n`;

    markdown += `### ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ï¼ˆä¿‚æ•°ï¼š${EVALUATION_COEFFICIENTS.SKILL_FIT}ï¼‰\n`;
    markdown += `- 10ç‚¹: æŠ€è¡“åŠ›ã‚’æœ€å¤§é™æ´»ã‹ã›ã‚‹æ¡ˆä»¶ï¼ˆã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã€APIé€£æºã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç­‰ï¼‰\n`;
    markdown += `- 8-9ç‚¹: æŠ€è¡“ã‚¹ã‚­ãƒ«ãŒé‡è¦ãªæ¡ˆä»¶ï¼ˆWordPressã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã€ECæ©Ÿèƒ½é–‹ç™ºç­‰ï¼‰\n`;
    markdown += `- 6-7ç‚¹: æŠ€è¡“ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãŒåŠã€…ï¼ˆæ—¢å­˜ã‚µã‚¤ãƒˆä¿®æ­£ã€ç°¡å˜ãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç­‰ï¼‰\n`;
    markdown += `- 4-5ç‚¹: ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ãŒå¤šã„ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é‡è¦–ç­‰ï¼‰\n`;
    markdown += `- 1-3ç‚¹: ç´”ç²‹ãªãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶ï¼ˆã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ¶ä½œã€UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ç­‰ï¼‰\n`;
    markdown += `- 0ç‚¹: å®Œå…¨ã«ã‚¹ã‚­ãƒ«å¤–ï¼ˆã‚¤ãƒ©ã‚¹ãƒˆåˆ¶ä½œã€å‹•ç”»ç·¨é›†ç­‰ï¼‰\n\n`;

    markdown += `## ğŸ”§ ä¿‚æ•°ã®æ„å‘³\n\n`;
    markdown += `- **æ™‚çµ¦ä¿‚æ•° ${EVALUATION_COEFFICIENTS.HOURLY}**: åç›Šæ€§é‡è¦–\n`;
    markdown += `- **å·¥æ•°ä¿‚æ•° ${EVALUATION_COEFFICIENTS.WORKLOAD}**: é©åº¦ãªä½œæ¥­é‡ã‚’ãƒãƒ©ãƒ³ã‚¹è©•ä¾¡\n`;
    markdown += `- **ã‚¹ã‚­ãƒ«é©æ€§ä¿‚æ•° ${EVALUATION_COEFFICIENTS.SKILL_FIT}**: ã‚¹ã‚­ãƒ«é©æ€§ã‚’æœ€é‡è¦–ï¼ˆæŠ€è¡“æ¡ˆä»¶ã‚’å„ªé‡ï¼‰\n`;
    markdown += `- **é›£æ˜“åº¦**: å‚è€ƒæƒ…å ±ã¨ã—ã¦è¡¨ç¤ºï¼ˆç‚¹æ•°è¨ˆç®—ã«ã¯å«ã‚ãªã„ï¼‰\n\n`;

    const maxScore = (10 * EVALUATION_COEFFICIENTS.HOURLY) + (10 * EVALUATION_COEFFICIENTS.WORKLOAD) + (10 * EVALUATION_COEFFICIENTS.SKILL_FIT);
    markdown += `**æœ€é«˜ç†è«–å€¤**: ${10 * EVALUATION_COEFFICIENTS.HOURLY} + ${10 * EVALUATION_COEFFICIENTS.WORKLOAD} + ${10 * EVALUATION_COEFFICIENTS.SKILL_FIT} = ${maxScore}ç‚¹\n\n`;

    markdown += `## ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°\n\n`;

    jobs.forEach((job, index) => {
        const rank = index + 1;
        markdown += `### ${rank}ä½: ${job.recommendation_score}ç‚¹ - [${job.original_title}](${job.link})\n\n`;
        markdown += `**ğŸ’° æƒ³å®šæ™‚çµ¦:** ${job.hourly_rate_numeric.toLocaleString()}å††  \n`;
        markdown += `**ğŸ¯ é›£æ˜“åº¦:** ${job.é›£æ˜“åº¦}  \n`;
        markdown += `**â° è¦‹ç©å·¥æ•°:** ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š}  \n`;
        markdown += `**ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§:** ${job.skill_fit_score?.toFixed(1)}ç‚¹/10ç‚¹  \n`;
        markdown += `**ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª:** ${job.category}  \n`;
        markdown += `**ğŸ”— æ¡ˆä»¶URL:** ${job.link}\n\n`;

        markdown += `**ğŸ“ åˆ†ææ¦‚è¦:**  \n`;
        markdown += `${job.gpt_summary}\n\n`;

        if (job.skill_analysis) {
            markdown += `**ğŸ§  ã‚¹ã‚­ãƒ«é©æ€§åˆ†æ:**  \n`;
            markdown += `${job.skill_analysis}\n\n`;
        }

        // TOP10ãªã‚‰ææ¡ˆæ–‡ã¨è³ªå•ã‚‚è¿½åŠ 
        if (rank <= 10 && job.proposal_greeting && job.specification_questions) {
            markdown += `**ğŸ’¬ æˆ¦ç•¥çš„ææ¡ˆæ–‡:**  \n`;
            markdown += `${job.proposal_greeting}\n\n`;

            markdown += `**â“ ä»•æ§˜ç¢ºèªè³ªå•:**  \n`;
            markdown += `${job.specification_questions}\n\n`;
        }

        markdown += `---\n\n`;
    });

    return markdown;
}

// GPTã§ææ¡ˆç”¨æŒ¨æ‹¶æ–‡ã¨ä»•æ§˜è³ªå•ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
async function generateProposalContent(job: AnalysisResult, originalJob: any): Promise<{ greeting: string; questions: string }> {
    const prompt = `ä»¥ä¸‹ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã«å¿œå‹Ÿã™ã‚‹éš›ã®æˆ¦ç•¥çš„ãªæŒ¨æ‹¶æ–‡ã¨ä»•æ§˜ç¢ºèªè³ªå•ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€æ¡ˆä»¶æƒ…å ±ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}
è©³ç´°èª¬æ˜: ${originalJob?.detailedDescription || 'è©³ç´°ä¸æ˜'}
æƒ³å®šæ™‚çµ¦: ${job.æƒ³å®šæ™‚çµ¦}
è¦‹ç©å·¥æ•°: ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š}
é›£æ˜“åº¦: ${job.é›£æ˜“åº¦}

ã€è¦æ±‚å†…å®¹ã€‘
1. **æŒ¨æ‹¶æ–‡**: ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§è¦ªã—ã¿ã‚„ã™ã„ã€ç°¡æ½”ãªè‡ªå·±ç´¹ä»‹ï¼ˆ2-3è¡Œï¼‰
2. **ä»•æ§˜ç¢ºèªè³ªå•**: æ¡ˆä»¶ã‚’ç¢ºå®Ÿã«æˆåŠŸã•ã›ã‚‹ãŸã‚ã®å…·ä½“çš„ãªè³ªå•ï¼ˆ3-5å€‹ï¼‰

ã€æŒ¨æ‹¶æ–‡ã®ãƒã‚¤ãƒ³ãƒˆã€‘
- çµŒé¨“ã¨å°‚é–€æ€§ã‚’ã‚¢ãƒ”ãƒ¼ãƒ«
- æ¡ˆä»¶ã¸ã®çœŸå‰£ãªå–ã‚Šçµ„ã¿å§¿å‹¢ã‚’ç¤ºã™
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èª²é¡Œè§£æ±ºã«ç„¦ç‚¹

ã€è³ªå•ã®ãƒã‚¤ãƒ³ãƒˆã€‘
- æ›–æ˜§ãªéƒ¨åˆ†ã®æ˜ç¢ºåŒ–
- æˆæœç‰©ã®å…·ä½“çš„ãªè¦æ±‚ä»•æ§˜
- ç´æœŸã‚„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•
- æƒ³å®šã•ã‚Œã‚‹èª²é¡Œã‚„ãƒªã‚¹ã‚¯ã®ç¢ºèª
- æˆåŠŸåŸºæº–ã®æ˜ç¢ºåŒ–

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
æŒ¨æ‹¶æ–‡:
<æŒ¨æ‹¶æ–‡ã‚’ã“ã“ã«>

è³ªå•:
1. <è³ªå•1>
2. <è³ªå•2>
3. <è³ªå•3>
4. <è³ªå•4>
5. <è³ªå•5>`;

    try {
        const res = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªãƒ•ãƒªãƒ¼ãƒ©ãƒ³ã‚µãƒ¼ã§ã€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã¸ã®åŠ¹æœçš„ãªææ¡ˆæ–‡ä½œæˆã®å°‚é–€å®¶ã§ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¿¡é ¼ã‚’å¾—ã¦ã€æ¡ˆä»¶ã‚’å—æ³¨ã™ã‚‹ãŸã‚ã®æˆ¦ç•¥çš„ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é•·ã‘ã¦ã„ã¾ã™ã€‚' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 800,
            temperature: 0.3,
        });

        const text = res.choices[0]?.message?.content || '';

        // æŒ¨æ‹¶æ–‡ã¨è³ªå•ã‚’åˆ†é›¢
        const greetingMatch = text.match(/æŒ¨æ‹¶æ–‡[:ï¼š]\s*([\s\S]*?)(?=è³ªå•[:ï¼š]|$)/);
        const questionsMatch = text.match(/è³ªå•[:ï¼š]\s*([\s\S]*)/);

        const greeting = greetingMatch?.[1]?.trim() || '';
        const questions = questionsMatch?.[1]?.trim() || '';

        return { greeting, questions };
    } catch (e) {
        console.error(`âŒ ææ¡ˆæ–‡ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${job.jobId}):`, e);
        return { greeting: '', questions: '' };
    }
}

// GPTã§ã‚¹ã‚­ãƒ«é©æ€§ã‚’è©•ä¾¡ã™ã‚‹é–¢æ•°
async function analyzeSkillFit(job: AnalysisResult, originalJob: any): Promise<{ score: number; analysis: string }> {
    const prompt = `ä»¥ä¸‹ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶ã‚’ã€é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®è¦–ç‚¹ã§è©•ä¾¡ã—ã¦ãã ã•ã„ã€‚

ã€ä¾é ¼è€…ã®ã‚¹ã‚­ãƒ«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã€‘
- é«˜ã‚¹ã‚­ãƒ«Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¸¡æ–¹ï¼‰
- ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãƒ»ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒ»APIé€£æºãŒå¾—æ„
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãªã©ã®æŠ€è¡“åŠ›é«˜ã„
- ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚­ãƒ«ã¯ä½ã„ï¼ˆã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ã¯è‹¦æ‰‹ï¼‰
- CSSã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç¨‹åº¦ãªã‚‰å¯¾å¿œå¯èƒ½

ã€æ¡ˆä»¶æƒ…å ±ã€‘
ã‚¿ã‚¤ãƒˆãƒ«: ${job.title}
è©³ç´°èª¬æ˜: ${originalJob?.detailedDescription || 'è©³ç´°ä¸æ˜'}
ã‚«ãƒ†ã‚´ãƒª: ${job.category}
é›£æ˜“åº¦: ${job.é›£æ˜“åº¦}

ã€è©•ä¾¡åŸºæº–ã€‘
ã‚¹ã‚­ãƒ«é©æ€§ã‚¹ã‚³ã‚¢ï¼ˆ0-10ç‚¹ï¼‰:
- 10ç‚¹: æŠ€è¡“åŠ›ã‚’æœ€å¤§é™æ´»ã‹ã›ã‚‹æ¡ˆä»¶ï¼ˆã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã€APIé€£æºã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç­‰ï¼‰
- 8-9ç‚¹: æŠ€è¡“ã‚¹ã‚­ãƒ«ãŒé‡è¦ãªæ¡ˆä»¶ï¼ˆWordPressã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã€ECæ©Ÿèƒ½é–‹ç™ºç­‰ï¼‰
- 6-7ç‚¹: æŠ€è¡“ã¨ãƒ‡ã‚¶ã‚¤ãƒ³ãŒåŠã€…ï¼ˆæ—¢å­˜ã‚µã‚¤ãƒˆä¿®æ­£ã€ç°¡å˜ãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ç­‰ï¼‰
- 4-5ç‚¹: ãƒ‡ã‚¶ã‚¤ãƒ³è¦ç´ ãŒå¤šã„ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä½œæˆã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é‡è¦–ç­‰ï¼‰
- 1-3ç‚¹: ç´”ç²‹ãªãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶ï¼ˆã‚°ãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ¶ä½œã€UI/UXãƒ‡ã‚¶ã‚¤ãƒ³ç­‰ï¼‰
- 0ç‚¹: å®Œå…¨ã«ã‚¹ã‚­ãƒ«å¤–ï¼ˆã‚¤ãƒ©ã‚¹ãƒˆåˆ¶ä½œã€å‹•ç”»ç·¨é›†ç­‰ï¼‰

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
ã‚¹ã‚³ã‚¢: <0-10ã®æ•°å€¤>
åˆ†æ: <ãªãœãã®ã‚¹ã‚³ã‚¢ãªã®ã‹ã€æŠ€è¡“çš„ãªè¦³ç‚¹ã§ã®è©•ä¾¡ç†ç”±ã‚’2-3è¡Œã§>`;

    try {
        const res = await openai.chat.completions.create({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'ã‚ãªãŸã¯æŠ€è¡“äººæã®ã‚¹ã‚­ãƒ«ãƒãƒƒãƒãƒ³ã‚°å°‚é–€å®¶ã§ã€Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æŠ€è¡“åŠ›ã¨æ¡ˆä»¶è¦ä»¶ã‚’æ­£ç¢ºã«è©•ä¾¡ã§ãã¾ã™ã€‚ãƒ‡ã‚¶ã‚¤ãƒ³ã‚¹ã‚­ãƒ«ã®æœ‰ç„¡ã‚’è€ƒæ…®ã—ãŸå®Ÿç”¨çš„ãªè©•ä¾¡ã‚’è¡Œã„ã¾ã™ã€‚' },
                { role: 'user', content: prompt }
            ],
            max_tokens: 300,
            temperature: 0.2,
        });

        const text = res.choices[0]?.message?.content || '';

        // ã‚¹ã‚³ã‚¢ã¨åˆ†æã‚’åˆ†é›¢
        const scoreMatch = text.match(/ã‚¹ã‚³ã‚¢[:ï¼š]\s*([0-9.]+)/);
        const analysisMatch = text.match(/åˆ†æ[:ï¼š]\s*([\s\S]*)/);

        const score = scoreMatch?.[1] ? parseFloat(scoreMatch[1]) : 5;
        const analysis = analysisMatch?.[1]?.trim() || '';

        return { score: Math.max(0, Math.min(10, score)), analysis };
    } catch (e) {
        console.error(`âŒ ã‚¹ã‚­ãƒ«é©æ€§åˆ†æã‚¨ãƒ©ãƒ¼ (${job.jobId}):`, e);
        return { score: 5, analysis: 'åˆ†æã‚¨ãƒ©ãƒ¼' };
    }
}

// å®Ÿè¡Œ
(async () => {
    await calculateRecommendationScores();
})();
</file>

<file path="scripts/extract-high-hourly-jobs.ts">
require('dotenv').config();

import { readFileSync, writeFileSync } from 'fs';

// å‹å®šç¾©
interface AnalysisResult {
    jobId: string;
    title: string;
    å·¥æ•°_è¦‹ç©ã‚‚ã‚Š: string;
    æƒ³å®šæ™‚çµ¦: string;
    gpt_summary: string;
    category?: string;
}

interface HighHourlyJob extends AnalysisResult {
    hourly_rate_numeric: number;
    link: string;
    original_title?: string;
}

// æ™‚çµ¦æ–‡å­—åˆ—ã‚’æ•°å€¤ã«å¤‰æ›ã™ã‚‹é–¢æ•°
function parseHourlyRate(hourlyRateString: string): number {
    if (!hourlyRateString || hourlyRateString.trim() === '' || hourlyRateString === '0å††') {
        return 0;
    }

    const match = hourlyRateString.match(/([0-9,]+)/);
    if (match && match[1]) {
        const numericString = match[1].replace(/,/g, '');
        return parseInt(numericString, 10);
    }

    return 0;
}

// è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getOriginalJobData(jobId: string, detailsData: any[]): any {
    return detailsData.find(job => job.jobId === jobId);
}

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
function extractHighHourlyJobs(): void {
    console.log('ğŸ”„ æ™‚çµ¦3000å††ä»¥ä¸Šã®æ¡ˆä»¶æŠ½å‡ºã‚’é–‹å§‹...');

    const highHourlyJobs: HighHourlyJob[] = [];
    const minHourlyRate = 3000;

    // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿è¾¼ã‚€ï¼ˆå…ƒã®ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ç”¨ï¼‰
    let ecDetailsData: any[] = [];
    let webDetailsData: any[] = [];

    // ECè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    try {
        ecDetailsData = JSON.parse(readFileSync('output/details-ec.json', 'utf8'));
        console.log(`ğŸ“‚ ECè©³ç´°ãƒ‡ãƒ¼ã‚¿: ${ecDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ ECè©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
    }

    // Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    try {
        webDetailsData = JSON.parse(readFileSync('output/details-web_products.json', 'utf8'));
        console.log(`ğŸ“‚ Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${webDetailsData.length}ä»¶èª­ã¿è¾¼ã¿`);
    } catch (error) {
        console.log(`âš ï¸ Webè£½å“è©³ç´°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—: ${error}`);
    }

    // ECã‚«ãƒ†ã‚´ãƒªã®åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        const ecData: AnalysisResult[] = JSON.parse(readFileSync('analyzed-ec.json', 'utf8'));
        ecData.forEach(item => {
            const hourlyRate = parseHourlyRate(item.æƒ³å®šæ™‚çµ¦);
            if (hourlyRate >= minHourlyRate) {
                const originalJob = getOriginalJobData(item.jobId, ecDetailsData);
                highHourlyJobs.push({
                    ...item,
                    category: 'EC',
                    hourly_rate_numeric: hourlyRate,
                    link: `https://crowdworks.jp/public/jobs/${item.jobId}`,
                    original_title: originalJob?.title || item.title
                });
            }
        });
        console.log(`âœ… ECã‚«ãƒ†ã‚´ãƒª: ${ecData.length}ä»¶ä¸­ ${ecData.filter(item => parseHourlyRate(item.æƒ³å®šæ™‚çµ¦) >= minHourlyRate).length}ä»¶ãŒå¯¾è±¡`);
    } catch (e) {
        console.log('âš ï¸ ECã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-ec.json');
    }

    // Webè£½å“ã‚«ãƒ†ã‚´ãƒªã®åˆ†æãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    try {
        const webData: AnalysisResult[] = JSON.parse(readFileSync('analyzed-web_products.json', 'utf8'));
        webData.forEach(item => {
            const hourlyRate = parseHourlyRate(item.æƒ³å®šæ™‚çµ¦);
            if (hourlyRate >= minHourlyRate) {
                const originalJob = getOriginalJobData(item.jobId, webDetailsData);
                highHourlyJobs.push({
                    ...item,
                    category: 'Webè£½å“',
                    hourly_rate_numeric: hourlyRate,
                    link: `https://crowdworks.jp/public/jobs/${item.jobId}`,
                    original_title: originalJob?.title || item.title
                });
            }
        });
        console.log(`âœ… Webè£½å“ã‚«ãƒ†ã‚´ãƒª: ${webData.length}ä»¶ä¸­ ${webData.filter(item => parseHourlyRate(item.æƒ³å®šæ™‚çµ¦) >= minHourlyRate).length}ä»¶ãŒå¯¾è±¡`);
    } catch (e) {
        console.log('âš ï¸ Webè£½å“ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: analyzed-web_products.json');
    }

    if (highHourlyJobs.length === 0) {
        console.error('âŒ å¯¾è±¡æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
    }

    // æ™‚çµ¦é †ã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜é¡é †ï¼‰
    const sortedJobs = highHourlyJobs.sort((a, b) => b.hourly_rate_numeric - a.hourly_rate_numeric);

    // Markdownãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
    const markdown = generateMarkdown(sortedJobs, minHourlyRate);
    const outputFileName = `output/high-hourly-jobs-3000+.md`;

    writeFileSync(outputFileName, markdown, 'utf8');
    console.log(`ğŸ’¾ Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜: ${outputFileName}`);
    console.log(`ğŸ“Š æŠ½å‡ºä»¶æ•°: ${sortedJobs.length}ä»¶`);
    console.log(`ğŸ’° æœ€é«˜æ™‚çµ¦: ${Math.max(...sortedJobs.map(j => j.hourly_rate_numeric)).toLocaleString()}å††`);
}

// Markdownç”Ÿæˆé–¢æ•°
function generateMarkdown(jobs: HighHourlyJob[], minRate: number): string {
    const currentDate = new Date().toISOString().split('T')[0];

    let markdown = `# é«˜æ™‚çµ¦æ¡ˆä»¶ä¸€è¦§ï¼ˆ${minRate}å††ä»¥ä¸Šï¼‰\n\n`;
    markdown += `> ç”Ÿæˆæ—¥: ${currentDate}  \n`;
    markdown += `> å¯¾è±¡: æ™‚çµ¦${minRate.toLocaleString()}å††ä»¥ä¸Šã®æ¡ˆä»¶  \n`;
    markdown += `> ç·ä»¶æ•°: ${jobs.length}ä»¶  \n`;
    markdown += `> æ³¨æ„: å·¥æ•°è¦‹ç©ã‚‚ã‚Šã«ã¯è¦ä»¶å®šç¾©ã€æ‰“ã¡åˆã‚ã›ã€ä¿®æ­£ä½œæ¥­ãªã©ã®å‰ä½œæ¥­ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™\n\n`;

    markdown += `## ğŸ“Š æ¦‚è¦\n\n`;
    markdown += `| çµ±è¨ˆé …ç›® | å€¤ |\n`;
    markdown += `|----------|----|\n`;
    markdown += `| æœ€é«˜æ™‚çµ¦ | ${Math.max(...jobs.map(j => j.hourly_rate_numeric)).toLocaleString()}å†† |\n`;
    markdown += `| æœ€ä½æ™‚çµ¦ | ${Math.min(...jobs.map(j => j.hourly_rate_numeric)).toLocaleString()}å†† |\n`;
    markdown += `| å¹³å‡æ™‚çµ¦ | ${Math.round(jobs.reduce((sum, j) => sum + j.hourly_rate_numeric, 0) / jobs.length).toLocaleString()}å†† |\n`;
    markdown += `| ECæ¡ˆä»¶æ•° | ${jobs.filter(j => j.category === 'EC').length}ä»¶ |\n`;
    markdown += `| Webè£½å“æ¡ˆä»¶æ•° | ${jobs.filter(j => j.category === 'Webè£½å“').length}ä»¶ |\n\n`;

    markdown += `## ğŸ’¼ æ¡ˆä»¶ä¸€è¦§\n\n`;

    jobs.forEach((job, index) => {
        markdown += `### ${index + 1}. [${job.original_title}](${job.link})\n\n`;
        markdown += `**ğŸ’° æƒ³å®šæ™‚çµ¦:** ${job.hourly_rate_numeric.toLocaleString()}å††  \n`;
        markdown += `**â° è¦‹ç©å·¥æ•°:** ${job.å·¥æ•°_è¦‹ç©ã‚‚ã‚Š}  \n`;
        markdown += `**ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª:** ${job.category}  \n`;
        markdown += `**ğŸ”— æ¡ˆä»¶URL:** ${job.link}\n\n`;
        markdown += `**ğŸ“ åˆ†ææ¦‚è¦:**  \n`;
        markdown += `${job.gpt_summary}\n\n`;
        markdown += `---\n\n`;
    });

    markdown += `## ğŸ“‹ æ³¨è¨˜\n\n`;
    markdown += `- æ™‚çµ¦ã¯ã€Œè¦ä»¶å®šç¾©ã€ã€Œæ‰“ã¡åˆã‚ã›ã€ã€Œä¿®æ­£ä½œæ¥­ã€ã€Œãƒ†ã‚¹ãƒˆã€ã€Œç´å“å¾Œã‚µãƒãƒ¼ãƒˆã€ãªã©ã®ä»˜å¸¯ä½œæ¥­ã‚‚å«ã‚ãŸç¾å®Ÿçš„ãªå·¥æ•°è¦‹ç©ã‚‚ã‚Šã«åŸºã¥ã„ã¦ã„ã¾ã™\n`;
    markdown += `- æ¡ˆä»¶ã®è©³ç´°ã¯å„ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã®ãƒšãƒ¼ã‚¸ã§ã”ç¢ºèªãã ã•ã„\n`;
    markdown += `- æ™‚çµ¦è¨ˆç®—ã¯GPT-4oã«ã‚ˆã‚‹åˆ†æçµæœã§ã‚ã‚Šã€å®Ÿéš›ã®ä½œæ¥­æ™‚é–“ã‚„å ±é…¬ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™\n`;
    markdown += `- æ¡ˆä»¶ã®å‹Ÿé›†çŠ¶æ³ã¯å¤‰å‹•ã™ã‚‹ãŸã‚ã€ãƒªãƒ³ã‚¯å…ˆã§æœ€æ–°æƒ…å ±ã‚’ã”ç¢ºèªãã ã•ã„\n`;

    return markdown;
}

// å®Ÿè¡Œ
extractHighHourlyJobs();
</file>

<file path="src/services/index.ts">
// Services module exports
// TODO: å®Ÿéš›ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè£…å¾Œã€ã“ã“ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

export {};
</file>

<file path="src/utils/index.ts">
// Utility functions exports
// TODO: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã‚’å®Ÿè£…å¾Œã€ã“ã“ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

export {};
</file>

<file path=".gitignore">
# Dependencies
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
yarn.lock

# Build outputs
dist/
build/
*.tsbuildinfo

# TypeScript
*.d.ts
*.d.ts.map
*.js.map

# AWS CDK
cdk.out/
cdk.context.json

# Environment variables
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
logs/
*.log

# Coverage
coverage/
.nyc_output/

# Jest
jest_0/

# Temporary files
tmp/
temp/

# Docker
.dockerignore

# Husky
.husky/_/

# Output files (scraped data, analysis results, reports)
output/
*.json
*.md
!README.md
!package.json
!tsconfig.json
</file>

<file path="jest.config.js">
module.exports = {
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒ
    preset: 'ts-jest',
    testEnvironment: 'node',

    // TypeScriptè¨­å®š
    transform: {
        '^.+\\.tsx?$': ['ts-jest', {
            tsconfig: './tsconfig.json'
        }]
    },

    // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®è¨­å®š
    moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json'],

    // ãƒ‘ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆtsconfig.jsonã¨åŒæœŸï¼‰
    moduleNameMapper: {
        '^@/(.*)$': '<rootDir>/src/$1',
        '^@/types/(.*)$': '<rootDir>/src/types/$1',
        '^@/services/(.*)$': '<rootDir>/src/services/$1',
        '^@/utils/(.*)$': '<rootDir>/src/utils/$1',
        '^@/infrastructure/(.*)$': '<rootDir>/src/infrastructure/$1'
    },

    // ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
    testMatch: [
        '<rootDir>/src/**/*.test.(ts|tsx)',
        '<rootDir>/src/**/*.spec.(ts|tsx)',
        '<rootDir>/test/**/*.test.(ts|tsx)',
        '<rootDir>/test/**/*.spec.(ts|tsx)'
    ],

    // ã‚«ãƒãƒ¬ãƒƒã‚¸è¨­å®š
    collectCoverage: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ç„¡åŠ¹ï¼ˆnpm run test:coverageã§æœ‰åŠ¹ï¼‰
    collectCoverageFrom: [
        'src/**/*.{ts,tsx}',
        '!src/**/*.d.ts',
        '!src/**/*.test.{ts,tsx}',
        '!src/**/*.spec.{ts,tsx}',
        '!src/test/**/*',
        '!src/types/**/*', // å‹å®šç¾©ã¯ã‚«ãƒãƒ¬ãƒƒã‚¸ã‹ã‚‰é™¤å¤–
    ],
    coverageDirectory: 'coverage',
    coverageReporters: ['text', 'lcov', 'html'],
    // TODO: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…å¾Œã«ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶ã‚’å¾©æ´»
    // coverageThreshold: {
    //     global: {
    //         branches: 20,   // 75% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         functions: 20,  // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         lines: 20,      // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //         statements: 20  // 80% â†’ 20% ã«ä¸€æ™‚çš„ã«ç·©å’Œ
    //     }
    // },

    // ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«
    setupFilesAfterEnv: ['<rootDir>/test/setup.ts'],

    // ãƒ¢ãƒƒã‚¯è¨­å®š
    clearMocks: true,
    resetMocks: true,
    restoreMocks: true,

    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    testTimeout: 30000, // 30ç§’ï¼ˆAWS SDKå‘¼ã³å‡ºã—ãªã©æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆã«å¯¾å¿œï¼‰

    // ä¸¦åˆ—å®Ÿè¡Œè¨­å®š
    maxWorkers: '50%', // CPUã‚³ã‚¢æ•°ã®50%ã§ä¸¦åˆ—å®Ÿè¡Œ

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºè¨­å®š
    verbose: true,
    errorOnDeprecated: true,

    // ä¸è¦ãªãƒ­ã‚°ã‚’æŠ‘åˆ¶
    silent: false,

    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰å¾Œã®ãƒ•ãƒƒã‚¯
    globalSetup: undefined,
    globalTeardown: undefined
};
</file>

<file path="src/index.ts">
/**
 * CrowdWorks Search System - Main Entry Point
 * Dockerç’°å¢ƒã§ã®é–‹ç™ºç”¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
 */

import { ExecutionLog } from '@/types';

// ç’°å¢ƒå¤‰æ•°ã®æ¤œè¨¼
function validateEnvironment(): void {
  const required = ['NODE_ENV', 'AWS_REGION'];
  const missing = required.filter(key => !process.env[key]);

  if (missing.length > 0) {
    throw new Error(`Missing required environment variables: ${missing.join(', ')}`);
  }
}

// ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œé–¢æ•°
async function main(): Promise<void> {
  try {
    validateEnvironment();

    const log: ExecutionLog = {
      executionId: Date.now().toString(),
      timestamp: new Date().toISOString(),
      status: 'success',
      duration: 0,
      jobsScraped: 0,
      newJobs: 0,
      aiEvaluated: 0,
      highScoreJobs: 0,
      costEstimate: 0,
    };

    console.log('ğŸš€ CrowdWorks Search System - Development Mode');
    console.log(`Environment: ${process.env['NODE_ENV']}`);
    console.log(`AWS Region: ${process.env['AWS_REGION']}`);
    console.log(`Execution ID: ${log.executionId}`);

    // TODO: å®Ÿéš›ã®å‡¦ç†ã‚’å®Ÿè£…
    console.log('âœ… Development setup completed');
  } catch (error) {
    console.error('âŒ Failed to start application:', error);
    process.exit(1);
  }
}

// é–‹ç™ºç’°å¢ƒã§ã®ã¿å®Ÿè¡Œ
if (require.main === module) {
  main().catch(error => {
    console.error('Fatal error:', error);
    process.exit(1);
  });
}

export { main };
</file>

<file path="src/infrastructure/crowdworks-searcher-stack.ts">
import * as cdk from 'aws-cdk-lib';
import * as lambda from 'aws-cdk-lib/aws-lambda';
import * as s3 from 'aws-cdk-lib/aws-s3';
import * as events from 'aws-cdk-lib/aws-events';
import * as targets from 'aws-cdk-lib/aws-events-targets';
import * as iam from 'aws-cdk-lib/aws-iam';
import * as logs from 'aws-cdk-lib/aws-logs';
import { Construct } from 'constructs';

export interface CrowdWorksSearcherStackProps extends cdk.StackProps {
  readonly stage?: string;
  readonly useContainerImage?: boolean; // Container Imageä½¿ç”¨ãƒ•ãƒ©ã‚°
}

export class CrowdWorksSearcherStack extends cdk.Stack {
  constructor(scope: Construct, id: string, props?: CrowdWorksSearcherStackProps) {
    super(scope, id, props);

    const stage = props?.stage || this.node.tryGetContext('stage') || 'dev';
    const isProd = stage === 'production';
    const useContainerImage = props?.useContainerImage ?? true; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§Containerä½¿ç”¨

    // ãƒªã‚½ãƒ¼ã‚¹åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹
    const resourcePrefix = `crowdworks-searcher-${stage}`;

    // S3ãƒã‚±ãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ç”¨ï¼‰
    const dataBucket = new s3.Bucket(this, 'CrowdWorksDataBucket', {
      bucketName: `${resourcePrefix}-data-${this.account}`,
      encryption: s3.BucketEncryption.S3_MANAGED,
      blockPublicAccess: s3.BlockPublicAccess.BLOCK_ALL,
      versioned: isProd, // æœ¬ç•ªç’°å¢ƒã®ã¿ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æœ‰åŠ¹
      lifecycleRules: [
        {
          id: 'DeleteOldData',
          enabled: true,
          expiration: isProd ? cdk.Duration.days(30) : cdk.Duration.days(7),
          // æœ¬ç•ªç’°å¢ƒã§ã¯å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚‚ç®¡ç†
          ...(isProd && {
            noncurrentVersionExpiration: cdk.Duration.days(7),
          }),
        },
      ],
      removalPolicy: isProd ? cdk.RemovalPolicy.RETAIN : cdk.RemovalPolicy.DESTROY,
      autoDeleteObjects: !isProd, // æœ¬ç•ªç’°å¢ƒã§ã¯æ‰‹å‹•å‰Šé™¤ãŒå¿…è¦
    });

    // CloudWatch Logs ã‚°ãƒ«ãƒ¼ãƒ—
    const logGroup = new logs.LogGroup(this, 'LambdaLogGroup', {
      logGroupName: `/aws/lambda/${resourcePrefix}-main`,
      retention: isProd ? logs.RetentionDays.ONE_MONTH : logs.RetentionDays.ONE_WEEK,
      removalPolicy: isProd ? cdk.RemovalPolicy.RETAIN : cdk.RemovalPolicy.DESTROY,
    });

    // Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«ï¼ˆContainer Imageç”¨æ¨©é™è¿½åŠ ï¼‰
    const lambdaRole = new iam.Role(this, 'LambdaExecutionRole', {
      roleName: `${resourcePrefix}-lambda-role`,
      assumedBy: new iam.ServicePrincipal('lambda.amazonaws.com'),
      managedPolicies: [
        iam.ManagedPolicy.fromAwsManagedPolicyName('service-role/AWSLambdaBasicExecutionRole'),
      ],
      inlinePolicies: {
        S3Access: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['s3:GetObject', 's3:PutObject', 's3:ListBucket', 's3:DeleteObject'],
              resources: [dataBucket.bucketArn, `${dataBucket.bucketArn}/*`],
            }),
          ],
        }),
        LogsAccess: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['logs:CreateLogStream', 'logs:PutLogEvents'],
              resources: [logGroup.logGroupArn],
            }),
          ],
        }),
        // Parameter Store (ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆç®¡ç†ç”¨)
        ParameterStoreAccess: new iam.PolicyDocument({
          statements: [
            new iam.PolicyStatement({
              effect: iam.Effect.ALLOW,
              actions: ['ssm:GetParameter', 'ssm:GetParameters'],
              resources: [`arn:aws:ssm:${this.region}:${this.account}:parameter/crowdworks-search/*`],
            }),
          ],
        }),
      },
    });

    // Lambdaé–¢æ•°ï¼ˆContainer Imageå¯¾å¿œï¼‰
    const mainFunction = useContainerImage
      ? new lambda.DockerImageFunction(this, 'CrowdWorksMainFunction', {
        functionName: `${resourcePrefix}-main`,
        code: lambda.DockerImageCode.fromImageAsset('./', {
          // Lambda Containerç”¨ã®Dockerfileã‚’æŒ‡å®š
          file: 'Dockerfile.lambda',
          // ãƒ“ãƒ«ãƒ‰å¼•æ•°ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’æ¸¡ã™
          buildArgs: {
            STAGE: stage,
            NODE_ENV: isProd ? 'production' : 'development',
          },
        }),
        timeout: cdk.Duration.minutes(15), // Playwrightç”¨ã«15åˆ†
        memorySize: isProd ? 3008 : 2048,  // Playwrightç”¨ãƒ¡ãƒ¢ãƒª
        role: lambdaRole,
        logGroup: logGroup,
        architecture: lambda.Architecture.X86_64, // Playwrightã¯x86_64ã®ã¿ã‚µãƒãƒ¼ãƒˆ
        environment: {
          NODE_ENV: stage,
          STAGE: stage,
          DATA_BUCKET_NAME: dataBucket.bucketName,
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
          // Playwrightç’°å¢ƒå¤‰æ•°
          PLAYWRIGHT_BROWSERS_PATH: '/usr/bin',
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1',
          LOG_LEVEL: isProd ? 'info' : 'debug',
        },
        // æœ¬ç•ªç’°å¢ƒã§ã¯äºˆç´„æ¸ˆã¿åŒæ™‚å®Ÿè¡Œæ•°ã‚’è¨­å®š
        ...(isProd && {
          reservedConcurrentExecutions: 5,
        }),
      })
      : new lambda.Function(this, 'CrowdWorksMainFunction', {
        functionName: `${resourcePrefix}-main`,
        runtime: lambda.Runtime.NODEJS_18_X,
        handler: 'lambda/handler.lambdaHandler',
        code: lambda.Code.fromAsset('./dist'),
        timeout: cdk.Duration.minutes(isProd ? 15 : 10),
        memorySize: isProd ? 1536 : 1024,
        role: lambdaRole,
        logGroup: logGroup,
        environment: {
          NODE_ENV: stage,
          STAGE: stage,
          DATA_BUCKET_NAME: dataBucket.bucketName,
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
        },
        // æœ¬ç•ªç’°å¢ƒã§ã¯äºˆç´„æ¸ˆã¿åŒæ™‚å®Ÿè¡Œæ•°ã‚’è¨­å®š
        ...(isProd && {
          reservedConcurrentExecutions: 5,
        }),
      });

    // EventBridgeï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ï¼‰
    const scheduleRule = new events.Rule(this, 'ScheduleRule', {
      ruleName: `${resourcePrefix}-schedule`,
      // æœ¬ç•ªç’°å¢ƒã§ã¯15åˆ†é–“éš”ã€ãã®ä»–ã¯30åˆ†é–“éš”
      schedule: events.Schedule.rate(isProd ? cdk.Duration.minutes(15) : cdk.Duration.minutes(30)),
      description: `CrowdWorksæ¡ˆä»¶æ¤œç´¢ã®å®šæœŸå®Ÿè¡Œ (${stage}ç’°å¢ƒ)`,
      enabled: stage !== 'test', // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã¯ç„¡åŠ¹
    });

    scheduleRule.addTarget(new targets.LambdaFunction(mainFunction));

    // ã‚¿ã‚°ä»˜ã‘
    cdk.Tags.of(this).add('Project', 'CrowdWorksSearcher');
    cdk.Tags.of(this).add('Stage', stage);
    cdk.Tags.of(this).add('Environment', isProd ? 'production' : 'development');

    // å‡ºåŠ›
    new cdk.CfnOutput(this, 'DataBucketName', {
      value: dataBucket.bucketName,
      description: 'S3ãƒ‡ãƒ¼ã‚¿ãƒã‚±ãƒƒãƒˆå',
      exportName: `${resourcePrefix}-data-bucket-name`,
    });

    new cdk.CfnOutput(this, 'LambdaFunctionName', {
      value: mainFunction.functionName,
      description: 'Lambdaé–¢æ•°å',
      exportName: `${resourcePrefix}-lambda-function-name`,
    });

    new cdk.CfnOutput(this, 'LambdaFunctionArn', {
      value: mainFunction.functionArn,
      description: 'Lambdaé–¢æ•°ARN',
      exportName: `${resourcePrefix}-lambda-function-arn`,
    });

    new cdk.CfnOutput(this, 'Stage', {
      value: stage,
      description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸',
      exportName: `${resourcePrefix}-stage`,
    });

    // å‡ºåŠ›ï¼ˆContainer Imageæƒ…å ±è¿½åŠ ï¼‰
    new cdk.CfnOutput(this, 'DeploymentMethod', {
      value: useContainerImage ? 'Container Image' : 'ZIP Package',
      description: 'Lambdaé–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹å¼',
      exportName: `${resourcePrefix}-deployment-method`,
    });
  }
}
</file>

<file path=".eslintrc.js">
module.exports = {
    parser: '@typescript-eslint/parser',
    parserOptions: {
        ecmaVersion: 2022,
        sourceType: 'module',
    },
    env: {
        node: true,
        es2022: true
    },
    plugins: [
        '@typescript-eslint'
    ],
    extends: [
        'eslint:recommended'
    ],
    rules: {
        // anyå‹ã‚’å³æ ¼ã«ç¦æ­¢
        '@typescript-eslint/no-explicit-any': 'error',
        '@typescript-eslint/no-unused-vars': ['error', {
            argsIgnorePattern: '^_',
            varsIgnorePattern: '^_'
        }],

        // General rules
        'no-console': 'off', // é–‹ç™ºä¸­ã¯è¨±å¯
        'no-debugger': 'error',
        'prefer-const': 'error',
        'no-var': 'error'
    },
    ignorePatterns: [
        'dist/',
        'node_modules/',
        'cdk.out/',
        '*.js',
        '*.d.ts'
    ]
};
</file>

<file path="Dockerfile">
# ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM node:18-alpine as base

# å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    chromium \
    && rm -rf /var/cache/apk/*

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# package.jsonã¨package-lock.jsonã‚’ã‚³ãƒ”ãƒ¼ï¼ˆä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ï¼‰
COPY package*.json ./

# === ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM base as dependencies

# å…¨ã¦ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm ci

# === ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as build

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# TypeScriptã®ãƒ“ãƒ«ãƒ‰
RUN npm run build

# ä¸è¦ãªdevDependenciesã‚’å‰Šé™¤
RUN npm prune --production

# === ãƒ†ã‚¹ãƒˆç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as test

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# TypeScriptã®ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
RUN npm run build

# Playwrightã®è¨­å®š
ENV PLAYWRIGHT_BROWSERS_PATH=/usr/bin/chromium-browser
ENV PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
CMD ["npm", "run", "test:coverage"]

# === é–‹ç™ºç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM dependencies as development

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# é–‹ç™ºç”¨ã®ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 3000 9229

# é–‹ç™ºç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰
CMD ["npm", "run", "dev"]

# === æœ¬ç•ªç”¨ã‚¹ãƒ†ãƒ¼ã‚¸ ===
FROM node:18-alpine as production

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
WORKDIR /app

# æœ¬ç•ªç”¨ã®æœ€å°é™ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apk add --no-cache dumb-init

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nextjs -u 1001

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã¨æœ¬ç•ªç”¨ä¾å­˜é–¢ä¿‚ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=build --chown=nextjs:nodejs /app/dist ./dist
COPY --from=build --chown=nextjs:nodejs /app/node_modules ./node_modules
COPY --from=build --chown=nextjs:nodejs /app/package.json ./package.json

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER nextjs

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¿½åŠ 
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD node --version || exit 1

# æœ¬ç•ªç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰
CMD ["dumb-init", "node", "dist/index.js"]
</file>

<file path="src/types/index.ts">
// æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹ï¼ˆè»½é‡ç‰ˆï¼‰
export interface JobData {
  id: string; // æ¡ˆä»¶IDï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯ï¼‰
  title: string; // æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«
  description: string; // æ¡ˆä»¶è©³ç´°ï¼ˆæœ€å¤§500æ–‡å­—ï¼‰
  url: string; // æ¡ˆä»¶URL
  budget: number; // äºˆç®—ï¼ˆå††ï¼‰
  deadline: Date; // ç´æœŸ
  workType: 'fixed' | 'hourly'; // å›ºå®šå ±é…¬ or æ™‚é–“å˜ä¾¡
  category: string; // ã‚«ãƒ†ã‚´ãƒª
  clientName: string; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå
  clientRating: number; // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè©•ä¾¡ï¼ˆ1-5ï¼‰
  clientReviews: number; // ãƒ¬ãƒ“ãƒ¥ãƒ¼æ•°
  skills: string[]; // å¿…è¦ã‚¹ã‚­ãƒ«ï¼ˆæœ€å¤§5å€‹ï¼‰
  experience: 'beginner' | 'intermediate' | 'expert'; // çµŒé¨“ãƒ¬ãƒ™ãƒ«
  scrapedAt: Date; // å–å¾—æ—¥æ™‚
  source: 'crowdworks'; // å–å¾—å…ƒï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰
}

// è©•ä¾¡çµæœå‹ï¼ˆè»½é‡ç‰ˆï¼‰
export interface JobEvaluation {
  jobId: string; // å¯¾è±¡æ¡ˆä»¶ID
  evaluatedAt: Date; // è©•ä¾¡æ—¥æ™‚
  score: number; // ãŠã™ã™ã‚åº¦ï¼ˆ1-10ï¼‰
  reason: string; // è©•ä¾¡ç†ç”±ï¼ˆæœ€å¤§50æ–‡å­—ï¼‰
  aiModel: 'gpt-3.5-turbo'; // ä½¿ç”¨AIãƒ¢ãƒ‡ãƒ«
  tokenUsed: number; // ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°
  costEstimate: number; // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  strengths: string[]; // å¼·ã¿ï¼ˆæœ€å¤§3å€‹ï¼‰
  concerns: string[]; // æ‡¸å¿µç‚¹ï¼ˆæœ€å¤§3å€‹ï¼‰
}

// å®Ÿè¡Œãƒ­ã‚°å‹
export interface ExecutionLog {
  executionId: string; // å®Ÿè¡ŒIDï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ï¼‰
  timestamp: string; // å®Ÿè¡Œé–‹å§‹æ™‚åˆ»ï¼ˆISOå½¢å¼ï¼‰
  status: 'success' | 'error' | 'partial'; // å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
  duration: number; // å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  jobsScraped: number; // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä»¶æ•°
  newJobs: number; // æ–°è¦æ¡ˆä»¶æ•°
  aiEvaluated: number; // AIè©•ä¾¡ä»¶æ•°
  highScoreJobs: number; // é«˜è©•ä¾¡æ¡ˆä»¶æ•°ï¼ˆé–¾å€¤ä»¥ä¸Šï¼‰
  costEstimate: number; // æ¨å®šã‚³ã‚¹ãƒˆï¼ˆUSDï¼‰
  error?: {
    type: string; // ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—
    message: string; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    stack?: string; // ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹
  };
}

// ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå‹
export interface SystemConfig {
  scraping: {
    maxJobsPerExecution: number;
    preFilterEnabled: boolean;
    minBudget: number;
    minClientRating: number;
    maxDescriptionLength: number;
  };
  ai: {
    enabled: boolean;
    model: 'gpt-3.5-turbo';
    maxJobsForEvaluation: number;
    monthlyBudgetLimit: number;
    maxTokensPerRequest: number;
    temperature: number;
  };
  notification: {
    enabled: boolean;
    scoreThreshold: number;
    errorNotificationEnabled: boolean;
    dailySummaryEnabled: boolean;
  };
  storage: {
    retentionDays: number;
    compressionEnabled: boolean;
    backupEnabled: boolean;
  };
  performance: {
    timeoutSeconds: number;
    retryCount: number;
    concurrentLimit: number;
  };
}

// æ¤œç´¢æ¡ä»¶å‹
export interface SearchCondition {
  id: string;
  name: string;
  enabled: boolean;
  keywords: string[];
  budgetMin: number;
  budgetMax: number;
  category: string;
  workType: 'fixed' | 'hourly' | 'both';
  clientRatingMin: number;
  experienceLevel: 'beginner' | 'intermediate' | 'expert' | 'any';
  excludeKeywords: string[];
  excludeClients: string[];
}

// æ¤œç´¢æ¡ä»¶è¨­å®šå‹
export interface SearchConditions {
  version: string;
  lastUpdated: Date;
  conditions: SearchCondition[];
}

// ãƒ­ã‚°ã‚¤ãƒ³èªè¨¼æƒ…å ±å‹
export interface LoginCredentials {
  email: string;
  password: string;
}

// Lambda ã‚¤ãƒ™ãƒ³ãƒˆå‹
export interface ScheduledExecutionEvent {
  source: string;
  'detail-type': string;
  detail: Record<string, any>;
  time?: string; // ISOå½¢å¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
}

// Lambda ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ï¼ˆæ–°å½¢å¼ï¼‰
export interface ScheduledExecutionResponse {
  statusCode: number; // HTTP ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚³ãƒ¼ãƒ‰
  body: string; // JSONæ–‡å­—åˆ—ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  executionTime: number; // å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  timestamp: string; // ISOå½¢å¼ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
}

// Playwrightå‹•ä½œç¢ºèªçµæœå‹
export interface PlaywrightTestResult {
  success: boolean;
  chromiumVersion?: string;
  title?: string;
  screenshot?: boolean;
  error?: string;
  executionTime: number;
}

// Lambdaå®Ÿè¡Œçµæœå‹ï¼ˆæ–°å½¢å¼ï¼‰
export interface LambdaExecutionResult {
  phases: {
    playwright: PlaywrightTestResult;
    crowdworksLogin: {
      success: boolean;
      loginResult?: CrowdWorksLoginResult;
      error?: string;
      executionTime: number;
    };
    crowdworksScraping: {
      success: boolean;
      scrapingResult?: any; // å®Ÿè£…æ™‚ã«è©³ç´°å‹ã‚’è¿½åŠ 
      error?: string;
      executionTime: number;
    };
  };
  executionTime: number;
  timestamp: string;
}

// Lambda ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
export interface LambdaErrorResponse {
  message: string;
  error: string;
  requestId: string;
  timestamp: string;
}

// æ—§å½¢å¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ï¼ˆå¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼‰
export interface LegacyScheduledExecutionResponse {
  status: 'success' | 'error' | 'partial';
  executionId: string;
  timestamp: string;
  results: {
    jobsScraped: number;
    newJobs: number;
    aiEvaluated: number;
    highScoreJobs: number;
    duration: number;
    costEstimate: number;
  };
  error?: {
    type: string;
    message: string;
  };
}

// ã‚¨ãƒ©ãƒ¼å‹
export enum ErrorType {
  AUTHENTICATION_ERROR = 'AUTH_ERROR',
  LAMBDA_TIMEOUT = 'LAMBDA_TIMEOUT',
  S3_ACCESS_ERROR = 'S3_ACCESS_ERROR',
  SCRAPING_ERROR = 'SCRAPING_ERROR',
  AI_API_ERROR = 'AI_API_ERROR',
  NETWORK_ERROR = 'NETWORK_ERROR',
}

export class AppError extends Error {
  constructor(
    public type: ErrorType,
    message: string,
    public retryable: boolean = false
  ) {
    super(message);
    this.name = 'AppError';
  }
}

// CrowdWorksèªè¨¼æƒ…å ±
export interface CrowdWorksCredentials {
  email: string;
  password: string;
}

// CrowdWorksãƒ­ã‚°ã‚¤ãƒ³çµæœ
export interface CrowdWorksLoginResult {
  success: boolean;
  isLoggedIn: boolean;
  error?: string;
  executionTime: number;
}

// ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹ã‚«ãƒ†ã‚´ãƒªå‹
export type CrowdWorksCategory =
  | 'ec'
  | 'web_products'
  | 'software_development'
  | 'development'
  | 'writing'
  | 'translation'
  | 'marketing'
  | 'system_development'
  | 'app_development'
  | 'data_entry'
  | 'others';

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå®šæ•°
export const DEFAULT_CONFIG = {
  MAX_JOBS_PER_CATEGORY: 50,
  MAX_DETAILS_PER_CATEGORY: 50,
  ALL_CATEGORIES: [
    'ec',
    'web_products',
    'software_development',
    'development',
    'writing',
    'translation',
    'marketing',
    'system_development',
    'app_development'
  ] as const satisfies readonly CrowdWorksCategory[]
} as const;
</file>

<file path="tsconfig.json">
{
    "compilerOptions": {
        "target": "ES2022",
        "module": "commonjs",
        "lib": [
            "ES2022"
        ],
        "types": [
            "node"
        ],
        "rootDir": "./src",
        "outDir": "./dist",
        "removeComments": true,
        "declaration": true,
        "declarationMap": true,
        "sourceMap": true,
        "strict": true,
        "noImplicitAny": true,
        "strictNullChecks": true,
        "strictFunctionTypes": true,
        "strictBindCallApply": true,
        "strictPropertyInitialization": true,
        "noImplicitReturns": true,
        "noFallthroughCasesInSwitch": true,
        "noUncheckedIndexedAccess": true,
        "noImplicitOverride": true,
        "exactOptionalPropertyTypes": true,
        "noPropertyAccessFromIndexSignature": true,
        "noUnusedLocals": true,
        "noUnusedParameters": true,
        "allowUnreachableCode": false,
        "allowUnusedLabels": false,
        "esModuleInterop": true,
        "allowSyntheticDefaultImports": true,
        "forceConsistentCasingInFileNames": true,
        "moduleResolution": "node",
        "resolveJsonModule": true,
        "isolatedModules": true,
        "skipLibCheck": true,
        "experimentalDecorators": true,
        "emitDecoratorMetadata": true,
        "baseUrl": "./",
        "paths": {
            "@/*": [
                "src/*"
            ],
            "@/types/*": [
                "src/types/*"
            ],
            "@/services/*": [
                "src/services/*"
            ],
            "@/utils/*": [
                "src/utils/*"
            ],
            "@/infrastructure/*": [
                "src/infrastructure/*"
            ]
        }
    },
    "include": [
        "src/**/*"
    ],
    "exclude": [
        "node_modules",
        "dist",
        "cdk.out",
        "test",
        "**/*.test.ts",
        "**/*.spec.ts",
        "*.js"
    ],
    "ts-node": {
        "require": [
            "tsconfig-paths/register"
        ],
        "compilerOptions": {
            "module": "commonjs"
        }
    }
}
</file>

<file path=".github/workflows/ci.yml">
name: CI/CD Pipeline

# GitHub Actionsã®æ¨©é™è¨­å®š
permissions:
  contents: read
  security-events: write
  id-token: write # OIDCèªè¨¼ç”¨

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  AWS_REGION: 'ap-northeast-1'

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæœ€é€Ÿå®Ÿè¡Œï¼‰
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint check
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: TypeScript type check
        run: npm run type-check

  # å˜ä½“ãƒ†ã‚¹ãƒˆ
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          token: ${{ secrets.CODECOV_TOKEN }}

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Verify build output
        run: |
          echo "=== Checking build output ==="
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist directory not found"
            exit 1
          fi
          
          # ãƒ¡ã‚¤ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          main_files=("dist/index.js" "dist/lambda/handler.js")
          for file in "${main_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found: $file"
            else
              echo "âš ï¸  Not found: $file"
            fi
          done
          
          echo "Contents of dist directory:"
          find dist -name "*.js" -type f | head -10
          echo "âœ… Build verification completed"

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # CDKæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
  cdk-synth:
    name: CDK Synth Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: CDK Synth (dry-run)
        run: npm run cdk:synth
        env:
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: typescript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  # Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-test
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t crowdworks-searcher:test .
          echo "âœ… Docker build completed successfully"

      - name: Test Docker container
        run: |
          docker run --rm crowdworks-searcher:test node --version
          echo "âœ… Docker container test passed"

  # Staging ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆdevelopãƒ–ãƒ©ãƒ³ãƒï¼‰
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, build-test, cdk-synth, docker-build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Staging)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.STAGING_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Staging

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to Staging with CDK
        run: |
          npm run cdk:deploy:staging
        env:
          STAGE: staging
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}

      - name: Post-deployment verification
        run: |
          echo "Verifying staging deployment..."
          # Lambdaé–¢æ•°ã®å­˜åœ¨ç¢ºèª
          aws lambda get-function --function-name crowdworks-searcher-staging-main
          echo "âœ… Staging deployment verified"

      - name: Slack notification (Staging)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Production ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒï¼‰
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [unit-tests, build-test, cdk-synth, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://production.example.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Production)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.PRODUCTION_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Production

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: dist/

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to Production with CDK
        run: |
          npm run cdk:deploy:production
        env:
          STAGE: production
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}

      - name: Post-deployment verification
        run: |
          echo "Verifying production deployment..."
          # Lambdaé–¢æ•°ã®å­˜åœ¨ç¢ºèª
          aws lambda get-function --function-name crowdworks-searcher-production-main
          # CloudWatch Logsç¢ºèª
          aws logs describe-log-groups --log-group-name-prefix "/aws/lambda/crowdworks-searcher-production"
          echo "âœ… Production deployment verified"

      - name: Create deployment tag
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git tag -a "v$(date +%Y%m%d_%H%M%S)" -m "Production deployment $(date)"
          git push origin --tags

      - name: Slack notification (Production)
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          fields: repo,message,commit,author,action,eventName,ref,workflow
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆworkflow_dispatchï¼‰
  deploy-manual:
    name: Manual Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ github.event.inputs.environment == 'production' && secrets.PRODUCTION_AWS_ROLE_ARN || secrets.STAGING_AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Manual

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy with CDK
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            npm run cdk:deploy:production
          else
            npm run cdk:deploy:staging
          fi
        env:
          STAGE: ${{ github.event.inputs.environment }}
          CDK_DEFAULT_REGION: ${{ env.AWS_REGION }}
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}

  # é€šçŸ¥ï¼ˆå¤±æ•—æ™‚ã®ã¿ï¼‰
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, build-test, cdk-synth, security-scan]
    if: failure()
    
    steps:
      - name: Notify failure
        run: |
          echo "âŒ CI/CD Pipeline failed"
          echo "Workflow: ${{ github.workflow }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          # TODO: Slack/Discordé€šçŸ¥ã‚’å®Ÿè£…
</file>

<file path="readme.md">
# CrowdWorks è‡ªå‹•åŒ–ã‚·ã‚¹ãƒ†ãƒ 

[![CI/CD Pipeline](https://github.com/masayuki-akinari/crowdworks-search/actions/workflows/ci.yml/badge.svg)](https://github.com/masayuki-akinari/crowdworks-search/actions/workflows/ci.yml)
[![TypeScript](https://img.shields.io/badge/TypeScript-5.6.3-blue.svg)](https://www.typescriptlang.org/)
[![AWS CDK](https://img.shields.io/badge/AWS%20CDK-2.170.0-orange.svg)](https://aws.amazon.com/cdk/)

## ğŸ“‹ æ¦‚è¦

CrowdWorksã®æ¡ˆä»¶æƒ…å ±ã‚’è‡ªå‹•åé›†ãƒ»AIè©•ä¾¡ã—ã€é«˜è©•ä¾¡æ¡ˆä»¶ã‚’ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã™ã‚‹ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### ğŸš€ ä¸»è¦æ©Ÿèƒ½
- **è‡ªå‹•ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°**: Playwright + Chromiumã«ã‚ˆã‚‹15åˆ†é–“éš”å®Ÿè¡Œ
- **AIè©•ä¾¡**: OpenAI GPT-4ã«ã‚ˆã‚‹æ¡ˆä»¶å“è³ªè©•ä¾¡
- **ã‚¹ãƒãƒ¼ãƒˆé€šçŸ¥**: é«˜è©•ä¾¡æ¡ˆä»¶ã®å³åº§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
- **ã‚³ã‚¹ãƒˆæœ€é©åŒ–**: æœˆé¡$5ä»¥ä¸‹ã§ã®é‹ç”¨

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TB
    A[EventBridge] -->|15åˆ†é–“éš”| B[Lambda Function]
    B -->|ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°| C[CrowdWorks]
    B -->|AIè©•ä¾¡| D[OpenAI API]
    B -->|ãƒ‡ãƒ¼ã‚¿ä¿å­˜| E[S3 Bucket]
    B -->|é«˜è©•ä¾¡é€šçŸ¥| F[SNS/SES]
    G[CloudWatch] -->|ç›£è¦–| B
```

**æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯:**
- **å®Ÿè¡Œç’°å¢ƒ**: AWS Lambda (ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸)
- **ãƒ–ãƒ©ã‚¦ã‚¶è‡ªå‹•åŒ–**: Playwright + Chromium
- **AIè©•ä¾¡**: OpenAI GPT-4 API
- **ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Amazon S3
- **é€šçŸ¥**: Amazon SNS/SES
- **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°**: Amazon EventBridge
- **ã‚¤ãƒ³ãƒ•ãƒ©**: AWS CDK (TypeScript)

## âš ï¸ **é‡è¦: Playwright Lambdaåˆ¶ç´„ã¨å¯¾å¿œ**

### æŠ€è¡“çš„èª²é¡Œ
- **Lambda ZIPåˆ¶é™**: 250MBï¼ˆPlaywright: ~300MBï¼‰
- **ãƒ–ãƒ©ã‚¦ã‚¶ãƒã‚¤ãƒŠãƒª**: Chromiumå˜ä½“ã§200MB+

### âœ… **æ¡ç”¨æ–¹é‡: Lambdaã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸**

**é¸æŠç†ç”±:**
- âœ… **å®¹é‡åˆ¶é™**: 10GBã¾ã§å¯¾å¿œï¼ˆZIP: 250MB â†’ Container: 10GBï¼‰
- âœ… **å®Œå…¨æ©Ÿèƒ½**: ãƒ•ãƒ«Playwright + Chromiumç’°å¢ƒ
- âœ… **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ZIPç‰ˆã¨åŒç­‰ã®èµ·å‹•æ™‚é–“
- âœ… **é–‹ç™ºåŠ¹ç‡**: æ—¢å­˜Dockerfileã‚’æ´»ç”¨å¯èƒ½
- âœ… **é‹ç”¨ã‚³ã‚¹ãƒˆ**: æœˆ$5-10ã§ã®å‹•ä½œç¢ºèªæ¸ˆã¿

```dockerfile
# ç¾åœ¨ã®Dockerfileæ§‹æˆ
FROM mcr.microsoft.com/playwright/python:v1.45.0-jammy
# â†’ Lambda Container Imageã¨ã—ã¦æ´»ç”¨
```

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. å‰ææ¡ä»¶
```bash
# å¿…è¦ãªãƒ„ãƒ¼ãƒ«
- Node.js 18+
- AWS CLI v2
- Docker Desktop
- AWS CDK CLI
```

### 2. ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/masayuki-akinari/crowdworks-search.git
cd crowdworks-search

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm install

# AWSèªè¨¼æƒ…å ±è¨­å®š
aws configure

# CDKåˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
npx cdk bootstrap
```

### 3. **ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ç‰ˆãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ¨å¥¨ï¼‰**
```bash
# ãƒ“ãƒ«ãƒ‰ & ãƒ‡ãƒ—ãƒ­ã‚¤
npm run cdk:deploy

# ã¾ãŸã¯æ‰‹å‹•ã§ã®æ®µéšå®Ÿè¡Œ
docker build -t crowdworks-searcher .
npx cdk deploy --context deployMethod=container
```

### 4. è¨­å®š
```bash
# AWS Parameter Storeã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆè¨­å®š
aws ssm put-parameter \
  --name "/crowdworks-search/openai-api-key" \
  --value "your-openai-api-key" \
  --type "SecureString"

aws ssm put-parameter \
  --name "/crowdworks-search/crowdworks-email" \
  --value "your-crowdworks-email" \
  --type "SecureString"
```

## ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜

### å®Ÿè¡Œã‚¹ãƒšãƒƒã‚¯
```yaml
Lambdaä»•æ§˜:
  ãƒ‡ãƒ—ãƒ­ã‚¤å½¢å¼: Container Image (ECR)
  ãƒ¡ãƒ¢ãƒª: 3,008 MB
  ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 15åˆ†
  ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: x86_64
  
Playwrightè¨­å®š:
  ãƒ–ãƒ©ã‚¦ã‚¶: Chromium (ãƒ•ãƒ«ç‰ˆ)
  ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹ãƒ¢ãƒ¼ãƒ‰: true
  å®Ÿè¡Œé–“éš”: 15åˆ†
```

### ã‚³ã‚¹ãƒˆæ§‹é€ ï¼ˆæœˆé¡ï¼‰
```yaml
Lambdaå®Ÿè¡Œ:
  1,000å›/æœˆ Ã— 10ç§’: $2-5
ECRã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: 
  1GB Docker Image: $0.10
CloudWatch:
  ãƒ­ã‚° & ç›£è¦–: $2-3
OpenAI API:
  GPT-4å‘¼ã³å‡ºã—: $1-2
åˆè¨ˆ: $5-10/æœˆ
```

## ğŸ”§ é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
```bash
# TypeScripté–‹ç™ºãƒ¢ãƒ¼ãƒ‰
npm run dev

# Dockerã§ã®ãƒ†ã‚¹ãƒˆ
npm run docker:build
npm run docker:run

# ãƒ­ãƒ¼ã‚«ãƒ«Playwrightå®Ÿè¡Œ
npx playwright install chromium
npm run test:e2e
```

### ãƒ­ã‚°ç¢ºèª
```bash
# CloudWatch Logsç¢ºèª
aws logs tail /aws/lambda/crowdworks-searcher-main --follow

# Lambdaå®Ÿè¡ŒçŠ¶æ³ç¢ºèª
aws lambda invoke \
  --function-name crowdworks-searcher-main \
  --payload '{}' \
  response.json
```

## ğŸ› ï¸ ä»£æ›¿ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: è»½é‡ç‰ˆ

**äºˆç®—æœ€å„ªå…ˆã®å ´åˆ:**
```typescript
// @sparticuz/chromiumä½¿ç”¨ï¼ˆè»½é‡ç‰ˆï¼‰
import { chromium } from 'playwright-core';
import chromium_binary from '@sparticuz/chromium';

const browser = await chromium.launch({
  args: [...chromium_binary.args, '--no-sandbox'],
  executablePath: await chromium_binary.executablePath()
});
```

**åˆ¶ç´„:**
- æ©Ÿèƒ½åˆ¶é™ã‚ã‚Šï¼ˆè»½é‡Chromiumï¼‰
- Lambda Layerå¿…è¦
- ãƒ‡ãƒãƒƒã‚°å›°é›£

## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### è¨­è¨ˆæ›¸
- [ğŸ“‹ å®Ÿè£…è¨ˆç”»æ›¸](./docs/05_implementation_plan.md)
- [ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ](./docs/01_architecture.md)
- [ğŸ”§ CI/CD ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](./docs/CI_CD_SETUP.md)

### é‹ç”¨ã‚¬ã‚¤ãƒ‰
- [ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰](./docs/02_deployment.md)
- [ğŸ“Š ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ](./docs/03_monitoring.md)
- [ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](./docs/04_security.md)

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰ã§ã¯ã€å‰ææ¡ä»¶ã®ç¢ºèªã‹ã‚‰ `cdk bootstrap`ã€`npm run cdk:deploy` ã®å®Ÿè¡Œã¾ã§ã‚’æ•´ç†ã—ã¦ã„ã¾ã™ã€‚ã•ã‚‰ã«ã€CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚‹è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚‚ç´¹ä»‹ã—ã¦ã„ã¾ã™ã€‚

## ğŸ¯ ç¾åœ¨ã®é–‹ç™ºçŠ¶æ³

### âœ… å®Œäº†æ¸ˆã¿
- [x] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
- [x] TypeScript + CDKåŸºç›¤
- [x] Dockerç’°å¢ƒæ•´å‚™
- [x] Playwright Lambdaå¯¾å¿œç­–ç­–å®š

### ğŸ”„ é€²è¡Œä¸­
- [ ] **ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå‹•ä½œç¢ºèª**ï¼ˆæœ€å„ªå…ˆï¼‰
- [ ] CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè£…
- [ ] OpenAI APIé€£æº

### ğŸ“‹ ä»Šå¾Œã®äºˆå®š
- [ ] S3ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ©Ÿèƒ½
- [ ] ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ã‚¨ãƒ©ãƒ¼ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆ

## ğŸš¨ æ—¢çŸ¥ã®åˆ¶ç´„ãƒ»æ³¨æ„äº‹é …

### Playwrightåˆ¶ç´„
- âŒ **Lambda ZIPç‰ˆ**: ç¢ºå®Ÿã«å®¹é‡åˆ¶é™è¶…é
- âœ… **Containerç‰ˆ**: å‹•ä½œç¢ºèªæ¸ˆã¿ã€æ¨å¥¨
- âš ï¸ **è»½é‡ç‰ˆ**: æ©Ÿèƒ½åˆ¶é™ã‚ã‚Šã€äºˆç®—é‡è¦–å‘ã‘

### CrowdWorksåˆ¶ç´„
- **åˆ©ç”¨è¦ç´„éµå®ˆ**: éåº¦ãªã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢
- **ãƒ¬ãƒ¼ãƒˆåˆ¶é™**: 15åˆ†é–“éš”ã§ã®ç©å¥ãªå®Ÿè¡Œ
- **ä»•æ§˜å¤‰æ›´ãƒªã‚¹ã‚¯**: ã‚µã‚¤ãƒˆå¤‰æ›´ã¸ã®å¯¾å¿œå¿…è¦

### ã‚³ã‚¹ãƒˆåˆ¶ç´„
- **æœˆé¡ç›®æ¨™**: $5ä»¥ä¸‹
- **å®Ÿæ¸¬å€¤**: ã‚³ãƒ³ãƒ†ãƒŠç‰ˆã§$5-10
- **ç›£è¦–**: AWS Cost Explorerè¨­å®šæ¸ˆã¿

## ğŸ¤ ã‚³ãƒ³ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

1. Fork the repository
2. Create feature branch (`git checkout -b feature/amazing-feature`)
3. Commit changes (`git commit -m 'Add amazing feature'`)
4. Push to branch (`git push origin feature/amazing-feature`)
5. Open Pull Request

### ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–
- TypeScript strict modeå¿…é ˆ
- anyå‹ä½¿ç”¨ç¦æ­¢
- 80%ä»¥ä¸Šã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- ESLint + Prettierãƒ«ãƒ¼ãƒ«éµå®ˆ

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License - è©³ç´°ã¯ [LICENSE](./LICENSE) ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

- **Issueå ±å‘Š**: [GitHub Issues](https://github.com/masayuki-akinari/crowdworks-search/issues)
- **è³ªå•ãƒ»ç›¸è«‡**: [GitHub Discussions](https://github.com/masayuki-akinari/crowdworks-search/discussions)

---

**âš¡ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: [å®Ÿè£…è¨ˆç”»æ›¸](./docs/05_implementation_plan.md) ã§è©³ç´°ãªé–‹ç™ºãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

npm run full-analysis:quick
ã¨ã‚Šã‚ãˆãšå®Ÿè¡Œç”¨ã‚³ãƒãƒ³ãƒ‰
</file>

<file path="package.json">
{
    "name": "crowdworks-search",
    "version": "1.0.0",
    "description": "ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚¯ã‚¹æ¡ˆä»¶è‡ªå‹•æ¤œç´¢ãƒ»è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ ",
    "main": "dist/index.js",
    "scripts": {
        "build": "tsc",
        "build:watch": "tsc --watch",
        "clean": "rimraf dist",
        "lint": "eslint src/**/*.ts",
        "lint:fix": "eslint src/**/*.ts --fix",
        "format": "prettier --write src/**/*.ts",
        "format:check": "prettier --check src/**/*.ts",
        "type-check": "tsc --noEmit",
        "test:category": "ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testCrowdWorksCategories().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "test:basic": "ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testPlaywrightBasic().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "test:debug": "ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.debugBrowserLifecycle().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "test:debug-category": "ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.debugCategoryScrapingTest().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "test:file-output": "ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.debugCategoryScrapingWithFileOutput({categories: ['ec', 'web_products'], maxJobsPerCategory: 5, saveToFile: true}).then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "test:full": "ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.loginAndScrapeCategories({categories: ['ec', 'web_products'], maxJobsPerCategory: 10, maxDetailsPerCategory: 3, saveToFile: true}).then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "test:no-login": "ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testCategoryScrapingWithoutLogin({categories: ['ec', 'web_products'], maxJobsPerCategory: 10, saveToFile: true}).then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "cdk:synth": "cdk synth",
        "cdk:deploy": "cdk deploy",
        "cdk:deploy:container": "npm run build && cdk deploy --require-approval never --context useContainerImage=true",
        "cdk:deploy:staging": "npm run build && cdk deploy --require-approval never --context stage=staging --context useContainerImage=true",
        "cdk:deploy:production": "npm run build && cdk deploy --require-approval never --context stage=production --context useContainerImage=true",
        "cdk:destroy": "cdk destroy",
        "cdk:diff": "cdk diff",
        "dev": "ts-node src/index.ts",
        "start": "node dist/index.js",
        "prepare": "husky install",
        "docker:build": "docker build -t crowdworks-search .",
        "docker:build:lambda": "docker build -f Dockerfile.lambda -t crowdworks-search-lambda .",
        "docker:run": "docker run --rm -it crowdworks-search",
        "docker:run:lambda": "docker run --rm -p 9000:8080 crowdworks-search-lambda",
        "docker:test:lambda": "docker run --rm crowdworks-lambda && echo 'Lambda Container Test Completed'",
        "docker:dev": "docker-compose up --build",
        "lambda:test": "curl -XPOST 'http://localhost:9000/2015-03-31/functions/function/invocations' -d '{\"source\":\"test\",\"detail\":{}}'",
        "lambda:local": "npm run docker:build:lambda && npm run docker:run:lambda",
        "precommit": "lint-staged",
        "security:audit": "npm audit --audit-level=moderate",
        "scrape:default": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.scrapeCrowdWorksJobsByCategoryWithDetails({category: 'ec', maxJobs: 50, maxDetails: 50}).then(r => console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå–å¾—å®Œäº†:', r.jobs.length, 'ä»¶ä¸€è¦§,', r.jobDetails.length, 'ä»¶è©³ç´°')))\"",
        "scrape:both-default": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(async m => { const ecResult = await m.scrapeCrowdWorksJobsByCategoryWithDetails({category: 'ec', maxJobs: 50, maxDetails: 50}); console.log('EC:', ecResult.jobs.length, 'ä»¶ä¸€è¦§,', ecResult.jobDetails.length, 'ä»¶è©³ç´°'); const webResult = await m.scrapeCrowdWorksJobsByCategoryWithDetails({category: 'web_products', maxJobs: 50, maxDetails: 50}); console.log('Web:', webResult.jobs.length, 'ä»¶ä¸€è¦§,', webResult.jobDetails.length, 'ä»¶è©³ç´°'); console.log('âœ… ä¸¡ã‚«ãƒ†ã‚´ãƒªå–å¾—å®Œäº† åˆè¨ˆ:', ecResult.jobs.length + webResult.jobs.length, 'ä»¶ä¸€è¦§,', ecResult.jobDetails.length + webResult.jobDetails.length, 'ä»¶è©³ç´°'); })\"",
        "analyze:ec": "npx ts-node scripts/analyze-details.ts details-ec.json analyzed-ec.json",
        "analyze:web": "npx ts-node scripts/analyze-details.ts details-web_products.json analyzed-web_products.json",
        "sort:high": "npx ts-node scripts/sort-by-hourly-rate.ts high",
        "sort:low": "npx ts-node scripts/sort-by-hourly-rate.ts low",
        "sort:default": "npx ts-node scripts/sort-by-hourly-rate.ts",
        "extract:high-hourly": "npx ts-node scripts/extract-high-hourly-jobs.ts",
        "recommend": "npx ts-node scripts/calculate-recommendation-score.ts",
        "handler:test-playwright": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testPlaywrightBasic().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:test-login": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testCrowdWorksLogin().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:test-scraping": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testCrowdWorksScraping().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:test-categories": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testCrowdWorksCategories().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:debug-browser": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.debugBrowserLifecycle().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:debug-category": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.debugCategoryScrapingTest().then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:scrape-ec": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.scrapeCrowdWorksJobsByCategoryWithDetails({category: 'ec', maxJobs: 50, maxDetails: 50}).then(r => console.log('âœ… ECå–å¾—å®Œäº†:', r.jobs.length, 'ä»¶ä¸€è¦§,', r.jobDetails.length, 'ä»¶è©³ç´°')))\"",
        "handler:scrape-web": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.scrapeCrowdWorksJobsByCategoryWithDetails({category: 'web_products', maxJobs: 50, maxDetails: 50}).then(r => console.log('âœ… Webè£½å“å–å¾—å®Œäº†:', r.jobs.length, 'ä»¶ä¸€è¦§,', r.jobDetails.length, 'ä»¶è©³ç´°')))\"",
        "handler:scrape-design": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.scrapeCrowdWorksJobsByCategoryWithDetails({category: 'design', maxJobs: 50, maxDetails: 50}).then(r => console.log('âœ… ãƒ‡ã‚¶ã‚¤ãƒ³å–å¾—å®Œäº†:', r.jobs.length, 'ä»¶ä¸€è¦§,', r.jobDetails.length, 'ä»¶è©³ç´°')))\"",
        "handler:scrape-all": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(async m => { const categories = ['ec', 'web_products', 'design', 'writing', 'translation', 'marketing', 'system_development', 'app_development']; let totalJobs = 0; let totalDetails = 0; for (const category of categories) { try { const result = await m.scrapeCrowdWorksJobsByCategoryWithDetails({category, maxJobs: 50, maxDetails: 50}); console.log(`âœ… ${category}: ${result.jobs.length}ä»¶ä¸€è¦§, ${result.jobDetails.length}ä»¶è©³ç´°`); totalJobs += result.jobs.length; totalDetails += result.jobDetails.length; } catch (e) { console.log(`âŒ ${category}: ã‚¨ãƒ©ãƒ¼`, e.message); } } console.log(`âœ… å…¨ã‚«ãƒ†ã‚´ãƒªå®Œäº† - åˆè¨ˆ: ${totalJobs}ä»¶ä¸€è¦§, ${totalDetails}ä»¶è©³ç´°`); })\"",
        "handler:login-and-scrape": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.loginAndScrapeCategories({categories: ['ec', 'web_products'], maxJobsPerCategory: 50, maxDetailsPerCategory: 50, saveToFile: true}).then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:no-login-scrape": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.testCategoryScrapingWithoutLogin({categories: ['ec', 'web_products'], maxJobsPerCategory: 50, saveToFile: true}).then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:file-output": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.debugCategoryScrapingWithFileOutput({categories: ['ec', 'web_products'], maxJobsPerCategory: 50, saveToFile: true}).then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler:lambda": "npx ts-node -r dotenv/config -e \"import('./src/lambda/handler').then(m => m.lambdaHandler({source: 'manual', 'detail-type': 'test', detail: {}}, {} as any).then(r => console.log(JSON.stringify(r, null, 2))))\"",
        "handler": "npx ts-node -r dotenv/config src/lambda/handler.ts",
        "h": "npm run handler",
        "handler:help": "npm run handler --",
        "full-analysis": "npm run handler full-analysis",
        "full-analysis:quick": "npm run handler full-analysis 20",
        "full-analysis:detailed": "npm run handler full-analysis 100"
    },
    "keywords": [
        "crowdworks",
        "automation",
        "scraping",
        "aws",
        "serverless",
        "typescript"
    ],
    "author": "Your Name",
    "license": "MIT",
    "private": true,
    "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
    },
    "dependencies": {
        "@aws-sdk/client-lambda": "^3.450.0",
        "@aws-sdk/client-s3": "^3.450.0",
        "@aws-sdk/client-sns": "^3.450.0",
        "@aws-sdk/client-ssm": "^3.540.0",
        "aws-cdk-lib": "^2.156.0",
        "aws-lambda": "^1.0.7",
        "aws-sdk": "^2.1691.0",
        "constructs": "^10.3.0",
        "dotenv": "^16.5.0",
        "openai": "^4.50.0",
        "playwright": "^1.48.2",
        "source-map-support": "^0.5.21",
        "typescript": "^5.6.3",
        "zod": "^3.22.0"
    },
    "devDependencies": {
        "@types/aws-lambda": "^8.10.145",
        "@types/jest": "^29.5.14",
        "@types/node": "^22.9.1",
        "@typescript-eslint/eslint-plugin": "^8.14.0",
        "@typescript-eslint/parser": "^8.14.0",
        "aws-cdk": "^2.170.0",
        "cross-env": "^7.0.3",
        "esbuild": "^0.24.0",
        "eslint": "^9.14.0",
        "eslint-config-prettier": "^9.1.0",
        "eslint-plugin-prettier": "^5.2.1",
        "husky": "^8.0.0",
        "jest": "^29.7.0",
        "lint-staged": "^15.0.0",
        "nock": "^13.3.0",
        "nodemon": "^3.1.7",
        "prettier": "^3.3.3",
        "ts-jest": "^29.2.5",
        "ts-node": "^10.9.2",
        "tsconfig-paths": "^4.2.0"
    },
    "husky": {
        "hooks": {
            "pre-commit": "lint-staged",
            "pre-push": "npm run type-check && npm run test"
        }
    },
    "lint-staged": {
        "src/**/*.{ts,tsx}": [
            "eslint --fix",
            "prettier --write",
            "git add"
        ]
    }
}
</file>

<file path="src/lambda/handler.ts">
/**
 * AWS Lambda Handler for CrowdWorks Search System
 * EventBridge ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œç”¨ã®ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 */

// ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã®ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
if (!process.env['AWS_LAMBDA_FUNCTION_NAME']) {
  // Lambdaç’°å¢ƒã§ã¯ãªã„å ´åˆã®ã¿dotenvã‚’ãƒ­ãƒ¼ãƒ‰
  try {
    require('dotenv').config();
    console.log('ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ: .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
  } catch (error) {
    console.log('âš ï¸ dotenvãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆLambdaç’°å¢ƒã§ã¯æ­£å¸¸ï¼‰');
  }
}

import { Context } from 'aws-lambda';
import { chromium, Browser, Page } from 'playwright';
import { SSMClient, GetParameterCommand } from '@aws-sdk/client-ssm';

// AWS SSM Client for Parameter Store
const ssmClient = new SSMClient({ region: process.env['AWS_REGION'] || 'ap-northeast-1' });

// Lambda Event Types
interface ScheduledExecutionEvent {
  source: string;
  'detail-type': string;
  detail: Record<string, any>;
  time?: string;
}

interface ScheduledExecutionResponse {
  statusCode: number;
  body: string;
  executionTime: number;
  timestamp: string;
}

// CrowdWorksèªè¨¼æƒ…å ±
interface CrowdWorksCredentials {
  email: string;
  password: string;
}

// ãƒ­ã‚°ã‚¤ãƒ³çµæœ
interface LoginResult {
  success: boolean;
  isLoggedIn: boolean;
  error?: string;
  executionTime: number;
}

// CrowdWorksæ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿å‹
interface CrowdWorksJob {
  id: string;
  title: string;
  description: string;
  url: string;
  budget: {
    type: 'fixed' | 'hourly' | 'unknown';
    amount: number;
    currency: string;
  };
  category: string;
  tags: string[];
  client: {
    name: string;
    rating: number;
    reviewCount: number;
  };
  postedAt: string;
  deadline?: string;
  applicants: number;
  scrapedAt: string; // ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ—¥æ™‚
}

// ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœå‹
interface ScrapingResult {
  success: boolean;
  jobsFound: number;
  jobs: CrowdWorksJob[];
  error?: string;
  executionTime: number;
}

// æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆãƒ¡ãƒ¢ãƒªå†…é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
const scrapedJobsCache = new Set<string>();

// æ¡ˆä»¶è©³ç´°æƒ…å ±ã®å‹å®šç¾©
interface CrowdWorksJobDetail {
  // åŸºæœ¬æƒ…å ±
  jobId: string;
  title: string;
  category: string;
  url: string;

  // ä»•äº‹ã®æ¦‚è¦
  paymentType: string;    // å›ºå®šå ±é…¬åˆ¶/æ™‚é–“å˜ä¾¡åˆ¶
  budget: string;         // äºˆç®—ç¯„å›²
  deliveryDate: string;   // ç´å“å¸Œæœ›æ—¥
  postDate: string;       // æ²è¼‰æ—¥
  applicationDeadline: string; // å¿œå‹ŸæœŸé™
  desiredImages: string[];  // å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆå˜è‰²ã€ã‚«ãƒ©ãƒ•ãƒ«ç­‰ï¼‰

  // å¿œå‹ŸçŠ¶æ³
  applicantCount: number;    // å¿œå‹Ÿã—ãŸäººæ•°
  contractCount: number;     // å¥‘ç´„ã—ãŸäººæ•°
  recruitmentCount: number;  // å‹Ÿé›†äººæ•°
  favoriteCount: number;     // æ°—ã«ãªã‚‹ï¼ãƒªã‚¹ãƒˆäººæ•°

  // è©³ç´°ãªä»•äº‹å†…å®¹
  detailedDescription: string; // è©³ç´°ãªä¾é ¼å†…å®¹

  // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±
  client: {
    name: string;
    url: string;
    overallRating: string;     // ç·åˆè©•ä¾¡
    orderHistory: string;      // å‹Ÿé›†å®Ÿç¸¾
    completionRate: string;    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ç‡
    thankCount: string;        // ã‚ã‚ŠãŒã¨ã†ä»¶æ•°
    identityVerified: boolean; // æœ¬äººç¢ºèª
    orderRuleCheck: boolean;   // ç™ºæ³¨ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯
    description: string;       // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èª¬æ˜
  };

  // å¿œå‹Ÿè€…æƒ…å ±ï¼ˆæœ€æ–°ã®æ•°ä»¶ï¼‰
  recentApplicants: Array<{
    name: string;
    url: string;
    applicationDate: string;
  }>;

  // å–å¾—æ—¥æ™‚
  scrapedAt: string;
}

/**
 * AWS Parameter Storeã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
 * ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã¯ç’°å¢ƒå¤‰æ•°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯¾å¿œ
 */
async function getCrowdWorksCredentials(): Promise<CrowdWorksCredentials> {
  try {
    console.log('ğŸ” CrowdWorksèªè¨¼æƒ…å ±ã‚’å–å¾—ä¸­...');

    // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ç’°å¢ƒå¤‰æ•°ã‚’å„ªå…ˆ
    const isLocal = !process.env['AWS_LAMBDA_FUNCTION_NAME'];

    if (isLocal) {
      console.log('ğŸ  ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’æ¤œå‡ºã€ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—...');

      const envEmail = process.env['CROWDWORKS_EMAIL'];
      const envPassword = process.env['CROWDWORKS_PASSWORD'];

      if (envEmail && envPassword) {
        console.log('âœ… ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—å®Œäº†');
        return { email: envEmail, password: envPassword };
      }

      console.log('âš ï¸ ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚Parameter Storeã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯...');
    }

    // Parameter Storeã‹ã‚‰å–å¾—ï¼ˆLambdaç’°å¢ƒã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    console.log('â˜ï¸ AWS Parameter Storeã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—ä¸­...');

    const [emailParam, passwordParam] = await Promise.all([
      ssmClient.send(new GetParameterCommand({
        Name: '/crowdworks-search/crowdworks/email',
        WithDecryption: true
      })),
      ssmClient.send(new GetParameterCommand({
        Name: '/crowdworks-search/crowdworks/password',
        WithDecryption: true
      }))
    ]);

    const email = emailParam.Parameter?.Value;
    const password = passwordParam.Parameter?.Value;

    if (!email || !password) {
      throw new Error('CrowdWorksèªè¨¼æƒ…å ±ãŒParameter Storeã§è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }

    console.log('âœ… Parameter Storeã‹ã‚‰èªè¨¼æƒ…å ±å–å¾—å®Œäº†');
    return { email, password };

  } catch (error) {
    console.error('âŒ èªè¨¼æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error);

    // ã‚¨ãƒ©ãƒ¼è©³ç´°æƒ…å ±ã‚’æä¾›
    if (error instanceof Error) {
      if (error.message.includes('ParameterNotFound')) {
        throw new Error('Parameter Storeã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½œæˆã—ã¦ãã ã•ã„:\n' +
          'aws ssm put-parameter --name "/crowdworks-search/crowdworks/email" --value "your-email" --type "SecureString"\n' +
          'aws ssm put-parameter --name "/crowdworks-search/crowdworks/password" --value "your-password" --type "SecureString"');
      }
      if (error.message.includes('AccessDenied')) {
        throw new Error('Parameter Storeã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ã€‚IAMãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      }
    }

    throw new Error(`èªè¨¼æƒ…å ±å–å¾—å¤±æ•—: ${error instanceof Error ? error.message : String(error)}`);
  }
}

/**
 * CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
 */
async function loginToCrowdWorks(page: Page, credentials: CrowdWorksCredentials): Promise<LoginResult> {
  const startTime = Date.now();

  try {
    console.log('ğŸšª CrowdWorksãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹...');

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    console.log('ğŸ“„ ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
    await page.goto('https://crowdworks.jp/login', {
      waitUntil: 'networkidle', // ã‚ˆã‚Šç¢ºå®Ÿãªèª­ã¿è¾¼ã¿å¾…æ©Ÿ
      timeout: 60000 // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’60ç§’ã«å»¶é•·
    });

    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    const title = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: ${title}`);

    // ãƒšãƒ¼ã‚¸ã®çŠ¶æ…‹ç¢ºèª
    console.log('ğŸ” ãƒšãƒ¼ã‚¸çŠ¶æ…‹ç¢ºèªä¸­...');
    const pageInfo = await page.evaluate(() => ({
      url: (globalThis as any).window.location.href,
      title: (globalThis as any).document.title,
      readyState: (globalThis as any).document.readyState
    }));
    console.log(`ğŸ“Š ãƒšãƒ¼ã‚¸çŠ¶æ…‹: ${JSON.stringify(pageInfo)}`);

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›æ¬„ã‚’å¾…æ©Ÿï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªå¾…æ©Ÿï¼‰
    console.log('â³ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›æ¬„ã‚’å¾…æ©Ÿä¸­...');
    await page.waitForFunction(
      () => (globalThis as any).document.querySelector('input[type="email"], [role="textbox"], textbox') !== null,
      { timeout: 30000 }
    );

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ­£ã—ã„æ–¹å¼ï¼‰
    console.log('ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ä¸­...');
    try {
      // MCPãƒ†ã‚¹ãƒˆã§ç¢ºèªæ¸ˆã¿ï¼šã“ã®æ–¹å¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
      await page.getByRole('textbox', { name: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹' }).fill(credentials.email);
      console.log('âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›å®Œäº†');
    } catch (error) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚ˆã‚Šå…·ä½“çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
      console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­...');
      await page.fill('input[type="email"], [placeholder*="ãƒ¡ãƒ¼ãƒ«"]', credentials.email);
      console.log('âœ… ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›å®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
    }

    // å°‘ã—å¾…æ©Ÿ
    await page.waitForTimeout(1000);

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ­£ã—ã„æ–¹å¼ï¼‰
    console.log('ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ä¸­...');
    try {
      // MCPãƒ†ã‚¹ãƒˆã§ç¢ºèªæ¸ˆã¿ï¼šã“ã®æ–¹å¼ãŒæ­£ã—ãå‹•ä½œã™ã‚‹
      await page.getByRole('textbox', { name: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰' }).fill(credentials.password);
      console.log('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å®Œäº†');
    } catch (error) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚ˆã‚Šå…·ä½“çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
      console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­...');
      await page.fill('input[type="password"], [placeholder*="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"]', credentials.password);
      console.log('âœ… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›å®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
    }

    // å°‘ã—å¾…æ©Ÿ
    await page.waitForTimeout(1000);

    // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸæ­£ã—ã„æ–¹å¼ï¼‰
    console.log('ğŸ–±ï¸ ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ä¸­...');
    try {
      // MCPãƒ†ã‚¹ãƒˆã§ç¢ºèªæ¸ˆã¿ï¼šbutton "ãƒ­ã‚°ã‚¤ãƒ³"
      await page.getByRole('button', { name: 'ãƒ­ã‚°ã‚¤ãƒ³' }).click();
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Œäº†');
    } catch (error) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚ˆã‚Šä¸€èˆ¬çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
      console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¸­...');
      await page.click('button:has-text("ãƒ­ã‚°ã‚¤ãƒ³"), input[value="ãƒ­ã‚°ã‚¤ãƒ³"]');
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å®Œäº†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†å®Œäº†ã‚’å¾…æ©Ÿï¼ˆã‚ˆã‚Šé•·ã‚ã®å¾…æ©Ÿï¼‰
    console.log('â³ ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†å®Œäº†å¾…æ©Ÿä¸­...');
    await page.waitForTimeout(5000); // 5ç§’å¾…æ©Ÿã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª

    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ/å¤±æ•—ã‚’ç¢ºèª
    console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³çµæœç¢ºèªä¸­...');
    const currentUrl = page.url();
    console.log(`ğŸ“‹ ç¾åœ¨ã®URL: ${currentUrl}`);

    // ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆMCPãƒ†ã‚¹ãƒˆã§ç¢ºèªã—ãŸã‚¨ãƒ©ãƒ¼è¦ç´ ï¼‰
    const loginStatus = await page.evaluate(() => {
      // æ¨™æº–çš„ãªCSSã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨ï¼ˆ:has-text()ã¯ç„¡åŠ¹ãªã®ã§å‰Šé™¤ï¼‰
      const errorGroups = (globalThis as any).document.querySelectorAll('[role="group"]');
      const allElements = (globalThis as any).document.querySelectorAll('*');

      let hasErrorGroup = false;
      let hasErrorMessage = false;
      let errorText = '';

      // ã‚¨ãƒ©ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ¢ã™
      for (const group of errorGroups) {
        if (group.textContent?.includes('å…¥åŠ›å†…å®¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™')) {
          hasErrorGroup = true;
          break;
        }
      }

      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¢ã™  
      for (const element of allElements) {
        if (element.textContent?.includes('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“')) {
          hasErrorMessage = true;
          errorText = element.textContent.trim();
          break;
        }
      }

      const generalError = (globalThis as any).document.querySelector('.error, .alert, .notice, [class*="error"]');

      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸã®åˆ¤å®šè¦ç´ 
      const userMenu = (globalThis as any).document.querySelector('a[href*="logout"], .user-menu, .header-user-menu, [href*="mypage"]');
      const dashboard = (globalThis as any).document.querySelector('.dashboard, [class*="dashboard"], .mypage');

      return {
        hasErrorGroup,
        hasErrorMessage,
        hasGeneralError: !!generalError,
        hasUserMenu: !!userMenu,
        hasDashboard: !!dashboard,
        currentPath: (globalThis as any).window.location.pathname,
        isLoginPage: (globalThis as any).window.location.pathname.includes('/login'),
        errorText: errorText || generalError?.textContent || ''
      };
    });

    const executionTime = Date.now() - startTime;

    // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸåˆ¤å®š
    const hasError = loginStatus.hasErrorGroup || loginStatus.hasErrorMessage || loginStatus.hasGeneralError;
    const hasSuccess = loginStatus.hasUserMenu || loginStatus.hasDashboard || !loginStatus.isLoginPage;
    const loginSuccess = !hasError && hasSuccess;

    console.log('ğŸ“Š ãƒ­ã‚°ã‚¤ãƒ³çµæœè©³ç´°:');
    console.log(`   ã‚¨ãƒ©ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—: ${loginStatus.hasErrorGroup ? 'âŒ' : 'âœ…'}`);
    console.log(`   ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ${loginStatus.hasErrorMessage ? 'âŒ' : 'âœ…'}`);
    console.log(`   ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼: ${loginStatus.hasUserMenu ? 'âœ…' : 'âŒ'}`);
    console.log(`   ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸: ${loginStatus.isLoginPage ? 'âŒ' : 'âœ…'}`);
    console.log(`   ç¾åœ¨ã®ãƒ‘ã‚¹: ${loginStatus.currentPath}`);

    if (loginSuccess) {
      console.log('âœ… CrowdWorksãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼');
      return {
        success: true,
        isLoggedIn: true,
        executionTime
      };
    } else {
      console.log('âŒ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—');
      const errorDetail = loginStatus.errorText || 'ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®çŠ¶æ…‹ç¢ºèªã§ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º';
      console.log(`ğŸ“‹ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${errorDetail}`);

      return {
        success: false,
        isLoggedIn: false,
        error: errorDetail,
        executionTime
      };
    }

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      isLoggedIn: false,
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * PlaywrightåŸºæœ¬å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ
 */
export async function testPlaywrightBasic(): Promise<{
  success: boolean;
  chromiumVersion?: string;
  title?: string;
  screenshot?: boolean;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ Playwright Chromiumèµ·å‹•ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // Chromiumèµ·å‹•ï¼ˆLambda Containeræœ€é©åŒ–è¨­å®šï¼‰
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      ...(process.env['AWS_LAMBDA_FUNCTION_NAME'] ? {
        executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
          ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
          : '/usr/bin/chromium'
      } : {}),
    });

    console.log('âœ… Chromiumèµ·å‹•æˆåŠŸ');

    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1280, height: 720 },
    });

    const page: Page = await context.newPage();
    console.log('ğŸ“„ ãƒšãƒ¼ã‚¸ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†');

    // åŸºæœ¬ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
    console.log('ğŸŒ Google ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    await page.goto('https://www.google.com', {
      waitUntil: 'networkidle',
      timeout: 30000
    });

    const title = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«å–å¾—: "${title}"`);

    // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆå–å¾—ï¼ˆLambdaç’°å¢ƒç¢ºèªç”¨ï¼‰
    try {
      await page.screenshot({
        path: '/tmp/test-screenshot.png',
        fullPage: false
      });
      console.log('ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜æˆåŠŸ: /tmp/test-screenshot.png');
    } catch (screenshotError) {
      console.warn('âš ï¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆä¿å­˜å¤±æ•—:', screenshotError);
    }

    // Chromiumãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±å–å¾—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå†…ã§å®Ÿè¡Œï¼‰
    const chromiumVersion = await page.evaluate(() => {
      // ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒå†…ãªã®ã§navigatorã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒåˆ©ç”¨å¯èƒ½
      return (globalThis as any).navigator.userAgent;
    });

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`âœ… PlaywrightåŸºæœ¬ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: true,
      chromiumVersion,
      title,
      screenshot: true,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ Playwright ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);
    console.error('Stack trace:', error instanceof Error ? error.stack : 'No stack trace');

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
 */
async function scrapeCrowdWorksJobs(page: Page, maxJobs: number = 10): Promise<ScrapingResult> {
  const startTime = Date.now();

  try {
    console.log('ğŸ” CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...');

    // CrowdWorkså…¬é–‹æ¡ˆä»¶ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    console.log('ğŸ“„ CrowdWorksæ¡ˆä»¶ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
    await page.goto('https://crowdworks.jp/public/jobs', {
      waitUntil: 'networkidle',
      timeout: 30000
    });

    console.log('âœ… CrowdWorksãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    const pageTitle = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: "${pageTitle}"`);

    // æ¡ˆä»¶ä¸€è¦§ã®è¦ç´ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    console.log('â³ æ¡ˆä»¶ä¸€è¦§èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
    await page.waitForSelector('.search_result', { timeout: 10000 });

    // æ¡ˆä»¶è¦ç´ ã‚’å–å¾—
    console.log('ğŸ“ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...');
    const jobs: CrowdWorksJob[] = await page.evaluate((params: { maxJobsLimit: number; categoryName: string; scrapedIds: string[] }) => {
      console.log('ğŸ” DOMè§£æé–‹å§‹...');

      // ç›´æ¥æ¡ˆä»¶ãƒªãƒ³ã‚¯ã‹ã‚‰æŠ½å‡ºï¼ˆãƒ‡ãƒãƒƒã‚°ã§æˆåŠŸã—ãŸæ–¹å¼ï¼‰
      const doc = (globalThis as any).document;
      const jobLinks = doc.querySelectorAll('a[href*="/public/jobs/"]');
      console.log(`ğŸ”— æ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°: ${jobLinks.length}`);

      if (jobLinks.length === 0) {
        console.log('âŒ æ¡ˆä»¶ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return [];
      }

      // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹ï¼ˆä¸€è¦§ãƒšãƒ¼ã‚¸ã‚„ä»–ã®ãƒªãƒ³ã‚¯ã‚’é™¤å¤–ï¼‰
      const validJobLinks: any[] = [];
      for (let i = 0; i < jobLinks.length; i++) {
        const link = jobLinks[i];
        const href = link.getAttribute('href') || '';

        // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        if (href.match(/\/public\/jobs\/\d+$/) && !href.includes('category') && !href.includes('group')) {
          validJobLinks.push(link);
        }
      }

      console.log(`âœ… æœ‰åŠ¹ãªæ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°: ${validJobLinks.length}`);

      // æœ€åˆã®æ•°ä»¶ã®ã¿ã‚’å®‰å…¨ã«æŠ½å‡º
      const safeLimit = Math.min(validJobLinks.length, params.maxJobsLimit);
      const jobs: any[] = [];

      for (let i = 0; i < safeLimit; i++) {
        try {
          const link = validJobLinks[i];
          const href = link.getAttribute('href') || '';
          const title = link.textContent?.trim() || '';
          const url = href.startsWith('http') ? href : `https://crowdworks.jp${href}`;

          // æ¡ˆä»¶IDã‚’URLã‹ã‚‰æŠ½å‡º
          const jobIdMatch = url.match(/\/public\/jobs\/(\d+)/);
          const jobId = jobIdMatch ? (jobIdMatch[1] ?? `unknown_${i}`) : `unknown_${i}`;

          if (title && url && jobId !== `unknown_${i}`) {
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (params.scrapedIds.includes(jobId)) {
              console.log(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: é‡è¤‡æ¡ˆä»¶ ${jobId}`);
              continue;
            }

            // è¦ªè¦ç´ ã‹ã‚‰è¿½åŠ æƒ…å ±ã‚’å–å¾—
            let parentElement = link.parentElement;
            let detailText = '';
            let budget = '';

            // æœ€å¤§5éšå±¤ã¾ã§è¦ªè¦ç´ ã‚’è¾¿ã‚‹
            for (let depth = 0; depth < 5 && parentElement; depth++) {
              const parentText = parentElement.textContent || '';
              if (parentText.includes('å††') && !budget) {
                // äºˆç®—æƒ…å ±ã‚’æŠ½å‡º
                const budgetMatch = parentText.match(/(\d{1,3}(?:,\d{3})*)\s*å††/);
                if (budgetMatch) {
                  budget = budgetMatch[0];
                }
              }

              if (parentText.length > detailText.length && parentText.length < 1000) {
                detailText = parentText;
              }

              parentElement = parentElement.parentElement;
            }

            // äºˆç®—ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
            let budgetType: 'fixed' | 'hourly' | 'unknown' = 'unknown';
            let budgetAmount = 0;

            if (detailText.includes('å›ºå®šå ±é…¬åˆ¶')) {
              budgetType = 'fixed';
            } else if (detailText.includes('æ™‚é–“å˜ä¾¡åˆ¶')) {
              budgetType = 'hourly';
            }

            if (budget) {
              const amountStr = budget.replace(/[^0-9]/g, '');
              budgetAmount = parseInt(amountStr) || 0;
            }

            // ã‚¿ã‚°/ã‚¹ã‚­ãƒ«ã®å–å¾—
            const tags: string[] = [];
            if (detailText) {
              const skillMatches = detailText.match(/([a-zA-Z]+|[ã‚¡-ãƒ¶ãƒ¼]+[\w]*)/g);
              if (skillMatches) {
                skillMatches.forEach(skill => {
                  if (skill.length > 2 && skill.length < 20) {
                    tags.push(skill);
                  }
                });
              }
            }

            // æŠ•ç¨¿æ—¥æ™‚ã®å–å¾—
            let postedAt = new Date().toISOString().split('T')[0];
            const dateMatch = detailText.match(/(\d{4}å¹´\d{2}æœˆ\d{2}æ—¥|\d{2}æœˆ\d{2}æ—¥)/);
            if (dateMatch) {
              postedAt = dateMatch[0];
            }

            // å¿œå‹Ÿè€…æ•°ã¨æœŸé™ã®å–å¾—
            let applicants = 0;
            let deadline = '';

            const contractMatch = detailText.match(/å¥‘ç´„æ•°[^\d]*(\d+)/);
            if (contractMatch) {
              applicants = parseInt(contractMatch[1] ?? '0') || 0;
            }

            const deadlineMatch = detailText.match(/ã‚ã¨(\d+)æ—¥|(\d+æœˆ\d+æ—¥)/);
            if (deadlineMatch) {
              deadline = deadlineMatch[0] ?? '';
            }

            jobs.push({
              id: jobId,
              title: title,
              description: detailText.substring(0, 500),
              url: url,
              budget: {
                type: budgetType,
                amount: budgetAmount,
                currency: 'JPY'
              },
              category: params.categoryName,
              tags: tags.slice(0, 10),
              client: {
                name: 'åŒ¿å',
                rating: 0,
                reviewCount: 0
              },
              postedAt: postedAt,
              deadline: deadline,
              applicants: applicants,
              scrapedAt: new Date().toISOString()
            });
            console.log(`âœ… æ¡ˆä»¶æŠ½å‡ºæˆåŠŸ: ${title} (${jobId}) - ${budget}`);
          }
        } catch (itemError) {
          console.log(`âŒ æ¡ˆä»¶ ${i} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, itemError);
          continue;
        }
      }

      console.log(`ğŸ“Š åˆè¨ˆ ${jobs.length} ä»¶ã®æ¡ˆä»¶ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`);
      return jobs;
    }, { maxJobsLimit: maxJobs, categoryName: 'all', scrapedIds: Array.from(scrapedJobsCache) });

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
    jobs.forEach((job: CrowdWorksJob) => scrapedJobsCache.add(job.id));

    const executionTime = Date.now() - startTime;

    console.log(`ğŸ‰ CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†:`);
    console.log(`   ğŸ“Š å–å¾—æ¡ˆä»¶æ•°: ${jobs.length}`);
    console.log(`   â±ï¸ å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);

    // ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
    if (jobs.length > 0) {
      console.log(`ğŸ“ ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶æƒ…å ±:`);
      const sample = jobs[0];
      if (sample) {
        console.log(`   ğŸ·ï¸ ã‚¿ã‚¤ãƒˆãƒ«: ${sample.title}`);
        console.log(`   ğŸ’° äºˆç®—: ${sample.budget.type} ${sample.budget.amount}å††`);
        console.log(`   ğŸ¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ${sample.client.name} (è©•ä¾¡: ${sample.client.rating}/5)`);
        console.log(`   ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª: ${sample.category}`);
        console.log(`   ğŸ”— URL: ${sample.url}`);
      }
    }

    return {
      success: true,
      jobsFound: jobs.length,
      jobs,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      jobsFound: 0,
      jobs: [],
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆPlaywrightçµ±åˆç‰ˆï¼‰
 */
export async function testCrowdWorksScraping(): Promise<{
  success: boolean;
  scrapingResult?: ScrapingResult;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // Chromiumèµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      ...(process.env['AWS_LAMBDA_FUNCTION_NAME'] ? {
        executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
          ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
          : '/usr/bin/chromium'
      } : {}),
    });

    console.log('âœ… Chromiumèµ·å‹•æˆåŠŸ');

    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1920, height: 1080 },
      // æ—¥æœ¬èªç’°å¢ƒè¨­å®š
      locale: 'ja-JP',
      timezoneId: 'Asia/Tokyo',
    });

    const page = await context.newPage();

    // CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
    const scrapingResult = await scrapeCrowdWorksJobs(page, 5); // ãƒ†ã‚¹ãƒˆç”¨ã«5ä»¶å–å¾—

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`âœ… CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: scrapingResult.success,
      scrapingResult,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ CrowdWorksæ¡ˆä»¶å–å¾—ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
 */
export async function testCrowdWorksLogin(): Promise<{
  success: boolean;
  loginResult?: LoginResult;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // èªè¨¼æƒ…å ±ã‚’å–å¾—
    const credentials = await getCrowdWorksCredentials();

    // Chromiumèµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      ...(process.env['AWS_LAMBDA_FUNCTION_NAME'] ? {
        executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
          ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
          : '/usr/bin/chromium'
      } : {}),
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1280, height: 720 },
    });

    const page = await context.newPage();

    // CrowdWorksãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    const loginResult = await loginToCrowdWorks(page, credentials);

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`âœ… CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: true,
      loginResult,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªåˆ¥CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
 */
async function scrapeCrowdWorksJobsByCategory(
  page: Page,
  category: string,
  maxJobs: number = 20
): Promise<ScrapingResult> {
  const startTime = Date.now();

  try {
    console.log(`ğŸ” ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã®æ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...`);

    // ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã®URLæ§‹ç¯‰
    const categoryUrl = `https://crowdworks.jp/public/jobs/group/${category}`;
    console.log(`ğŸ“„ ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹: ${categoryUrl}`);

    await page.goto(categoryUrl, {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });

    console.log('âœ… ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    const pageTitle = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: "${pageTitle}"`);

    // æ–°ç€é †ã‚½ãƒ¼ãƒˆã‚’è¨­å®š - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç›´æ¥æŒ‡å®š
    console.log('ğŸ”„ æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šä¸­...');
    try {
      const currentUrl = page.url();
      const newUrl = currentUrl.includes('?')
        ? `${currentUrl}&order=new`
        : `${currentUrl}?order=new`;

      await page.goto(newUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });
      console.log(`âœ… æ–°ç€é †URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹: ${newUrl}`);
    } catch (sortError) {
      console.log('âš ï¸ æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šå¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †åºã§ç¶šè¡Œ');
    }

    // æ¡ˆä»¶ä¸€è¦§ã®è¦ç´ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    console.log('â³ æ¡ˆä»¶ä¸€è¦§èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
    try {
      // å®Ÿéš›ã®DOMæ§‹é€ ã«åŸºã¥ã„ãŸå¾…æ©Ÿ
      await page.waitForSelector('main list listitem', { timeout: 10000 });
      console.log('âœ… æ¡ˆä»¶ä¸€è¦§è¦ç´ ã®èª­ã¿è¾¼ã¿ç¢ºèª');
    } catch (error) {
      console.log('âš ï¸ æ¨™æº–çš„ãªæ¡ˆä»¶ä¸€è¦§è¦ç´ å¾…æ©Ÿå¤±æ•—ã€ä»–ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è©¦è¡Œ');
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šä¸€èˆ¬çš„ãªãƒªã‚¹ãƒˆè¦ç´ ã‚’å¾…æ©Ÿ
      try {
        await page.waitForSelector('ul li, ol li', { timeout: 5000 });
        console.log('âœ… ä»£æ›¿æ¡ˆä»¶ä¸€è¦§è¦ç´ ã®èª­ã¿è¾¼ã¿ç¢ºèª');
      } catch (fallbackError) {
        console.log('âš ï¸ æ¡ˆä»¶ä¸€è¦§è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€DOMæ§‹é€ ã‚’ç›´æ¥è§£æã—ã¾ã™');
      }
    }

    // æ¡ˆä»¶è¦ç´ ã‚’å–å¾—
    console.log('ğŸ“ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...');
    const jobs: CrowdWorksJob[] = await page.evaluate((params: { maxJobsLimit: number; categoryName: string; scrapedIds: string[] }) => {
      console.log('ğŸ” DOMè§£æé–‹å§‹...');

      // ç›´æ¥æ¡ˆä»¶ãƒªãƒ³ã‚¯ã‹ã‚‰æŠ½å‡ºï¼ˆãƒ‡ãƒãƒƒã‚°ã§æˆåŠŸã—ãŸæ–¹å¼ï¼‰
      const doc = (globalThis as any).document;
      const jobLinks = doc.querySelectorAll('a[href*="/public/jobs/"]');
      console.log(`ğŸ”— æ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°: ${jobLinks.length}`);

      if (jobLinks.length === 0) {
        console.log('âŒ æ¡ˆä»¶ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return [];
      }

      // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹ï¼ˆä¸€è¦§ãƒšãƒ¼ã‚¸ã‚„ä»–ã®ãƒªãƒ³ã‚¯ã‚’é™¤å¤–ï¼‰
      const validJobLinks: any[] = [];
      for (let i = 0; i < jobLinks.length; i++) {
        const link = jobLinks[i];
        const href = link.getAttribute('href') || '';

        // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        if (href.match(/\/public\/jobs\/\d+$/) && !href.includes('category') && !href.includes('group')) {
          validJobLinks.push(link);
        }
      }

      console.log(`âœ… æœ‰åŠ¹ãªæ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°: ${validJobLinks.length}`);

      // æœ€åˆã®æ•°ä»¶ã®ã¿ã‚’å®‰å…¨ã«æŠ½å‡º
      const safeLimit = Math.min(validJobLinks.length, params.maxJobsLimit);
      const jobs: any[] = [];

      for (let i = 0; i < safeLimit; i++) {
        try {
          const link = validJobLinks[i];
          const href = link.getAttribute('href') || '';
          const title = link.textContent?.trim() || '';
          const url = href.startsWith('http') ? href : `https://crowdworks.jp${href}`;

          // æ¡ˆä»¶IDã‚’URLã‹ã‚‰æŠ½å‡º
          const jobIdMatch = url.match(/\/public\/jobs\/(\d+)/);
          const jobId = jobIdMatch ? (jobIdMatch[1] ?? `unknown_${i}`) : `unknown_${i}`;

          if (title && url && jobId !== `unknown_${i}`) {
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (params.scrapedIds.includes(jobId)) {
              console.log(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: é‡è¤‡æ¡ˆä»¶ ${jobId}`);
              continue;
            }

            // è¦ªè¦ç´ ã‹ã‚‰è¿½åŠ æƒ…å ±ã‚’å–å¾—
            let parentElement = link.parentElement;
            let detailText = '';
            let budget = '';

            // æœ€å¤§5éšå±¤ã¾ã§è¦ªè¦ç´ ã‚’è¾¿ã‚‹
            for (let depth = 0; depth < 5 && parentElement; depth++) {
              const parentText = parentElement.textContent || '';
              if (parentText.includes('å††') && !budget) {
                // äºˆç®—æƒ…å ±ã‚’æŠ½å‡º
                const budgetMatch = parentText.match(/(\d{1,3}(?:,\d{3})*)\s*å††/);
                if (budgetMatch) {
                  budget = budgetMatch[0];
                }
              }

              if (parentText.length > detailText.length && parentText.length < 1000) {
                detailText = parentText;
              }

              parentElement = parentElement.parentElement;
            }

            // äºˆç®—ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
            let budgetType: 'fixed' | 'hourly' | 'unknown' = 'unknown';
            let budgetAmount = 0;

            if (detailText.includes('å›ºå®šå ±é…¬åˆ¶')) {
              budgetType = 'fixed';
            } else if (detailText.includes('æ™‚é–“å˜ä¾¡åˆ¶')) {
              budgetType = 'hourly';
            }

            if (budget) {
              const amountStr = budget.replace(/[^0-9]/g, '');
              budgetAmount = parseInt(amountStr) || 0;
            }

            // ã‚¿ã‚°/ã‚¹ã‚­ãƒ«ã®å–å¾—
            const tags: string[] = [];
            if (detailText) {
              const skillMatches = detailText.match(/([a-zA-Z]+|[ã‚¡-ãƒ¶ãƒ¼]+[\w]*)/g);
              if (skillMatches) {
                skillMatches.forEach(skill => {
                  if (skill.length > 2 && skill.length < 20) {
                    tags.push(skill);
                  }
                });
              }
            }

            // æŠ•ç¨¿æ—¥æ™‚ã®å–å¾—
            let postedAt = new Date().toISOString().split('T')[0];
            const dateMatch = detailText.match(/(\d{4}å¹´\d{2}æœˆ\d{2}æ—¥|\d{2}æœˆ\d{2}æ—¥)/);
            if (dateMatch) {
              postedAt = dateMatch[0];
            }

            // å¿œå‹Ÿè€…æ•°ã¨æœŸé™ã®å–å¾—
            let applicants = 0;
            let deadline = '';

            const contractMatch = detailText.match(/å¥‘ç´„æ•°[^\d]*(\d+)/);
            if (contractMatch) {
              applicants = parseInt(contractMatch[1] ?? '0') || 0;
            }

            const deadlineMatch = detailText.match(/ã‚ã¨(\d+)æ—¥|(\d+æœˆ\d+æ—¥)/);
            if (deadlineMatch) {
              deadline = deadlineMatch[0] ?? '';
            }

            jobs.push({
              id: jobId,
              title: title,
              description: detailText.substring(0, 500),
              url: url,
              budget: {
                type: budgetType,
                amount: budgetAmount,
                currency: 'JPY'
              },
              category: params.categoryName,
              tags: tags.slice(0, 10),
              client: {
                name: 'åŒ¿å',
                rating: 0,
                reviewCount: 0
              },
              postedAt: postedAt,
              deadline: deadline,
              applicants: applicants,
              scrapedAt: new Date().toISOString()
            });
            console.log(`âœ… æ¡ˆä»¶æŠ½å‡ºæˆåŠŸ: ${title} (${jobId}) - ${budget}`);
          }
        } catch (itemError) {
          console.log(`âŒ æ¡ˆä»¶ ${i} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, itemError);
          continue;
        }
      }

      console.log(`ğŸ“Š åˆè¨ˆ ${jobs.length} ä»¶ã®æ¡ˆä»¶ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`);
      return jobs;
    }, { maxJobsLimit: maxJobs, categoryName: category, scrapedIds: Array.from(scrapedJobsCache) });

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
    jobs.forEach((job: CrowdWorksJob) => scrapedJobsCache.add(job.id));

    const executionTime = Date.now() - startTime;

    console.log(`ğŸ‰ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†:`);
    console.log(`   ğŸ“Š å–å¾—æ¡ˆä»¶æ•°: ${jobs.length}`);
    console.log(`   â±ï¸ å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);

    // ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
    if (jobs.length > 0) {
      console.log(`ğŸ“ ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶:`);
      const sample = jobs[0];
      if (sample) {
        console.log(`   ğŸ·ï¸ ã‚¿ã‚¤ãƒˆãƒ«: ${sample.title}`);
        console.log(`   ğŸ’° äºˆç®—: ${sample.budget.type} ${sample.budget.amount}å††`);
        console.log(`   ğŸ¢ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ${sample.client.name}`);
        console.log(`   ğŸ”— URL: ${sample.url}`);
      }
    }

    return {
      success: true,
      jobsFound: jobs.length,
      jobs,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:`, errorMessage);

    return {
      success: false,
      jobsFound: 0,
      jobs: [],
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * æŒ‡å®šã‚«ãƒ†ã‚´ãƒªã®CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
 */
export async function testCrowdWorksCategories(): Promise<{
  success: boolean;
  results?: { [category: string]: ScrapingResult };
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ CrowdWorksã‚«ãƒ†ã‚´ãƒªæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // Chromiumèµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ],
      ...(process.env['AWS_LAMBDA_FUNCTION_NAME'] ? {
        executablePath: process.env['PLAYWRIGHT_BROWSERS_PATH']
          ? `${process.env['PLAYWRIGHT_BROWSERS_PATH']}/chromium`
          : '/usr/bin/chromium'
      } : {}),
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
      viewport: { width: 1280, height: 720 },
    });

    const page = await context.newPage();

    console.log('âœ… ãƒ–ãƒ©ã‚¦ã‚¶æº–å‚™å®Œäº†ï¼ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...');

    // æŒ‡å®šã‚«ãƒ†ã‚´ãƒªã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼ˆECã¨Webåˆ¶ä½œã€é–‹ç™ºç³»ï¼‰
    const categories = ['ec', 'web_products', 'development', 'software_development'];
    const results: { [category: string]: ScrapingResult } = {};

    for (const category of categories) {
      console.log(`\nğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹...`);

      try {
        // å®Ÿè£…æ¸ˆã¿ã®ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–¢æ•°ã‚’ä½¿ç”¨
        const categoryResult = await scrapeCrowdWorksJobsByCategory(page, category, 20);
        results[category] = categoryResult;

        console.log(`ğŸ“Š ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å®Œäº†: ${categoryResult.success ? 'âœ…' : 'âŒ'} (${categoryResult.jobsFound}ä»¶)`);

        if (categoryResult.success && categoryResult.jobs.length > 0) {
          const sampleJob = categoryResult.jobs[0]!; // é•·ã•ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãªã®ã§å®‰å…¨
          console.log(`ğŸ“ ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶: ${sampleJob.title}`);
        }

        // æ¬¡ã®ã‚«ãƒ†ã‚´ãƒªå‡¦ç†å‰ã«å°‘ã—å¾…æ©Ÿ
        await page.waitForTimeout(2000);

      } catch (categoryError) {
        console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, categoryError);
        results[category] = {
          success: false,
          jobsFound: 0,
          jobs: [],
          error: categoryError instanceof Error ? categoryError.message : String(categoryError),
          executionTime: 0
        };
      }
    }

    await context.close();

    const executionTime = Date.now() - startTime;

    // çµæœã‚µãƒãƒªãƒ¼
    const totalJobs = Object.values(results).reduce((sum, result) => sum + result.jobsFound, 0);
    const successCount = Object.values(results).filter(result => result.success).length;

    console.log(`\nğŸ‰ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†:`);
    console.log(`   ğŸ“Š å‡¦ç†ã‚«ãƒ†ã‚´ãƒªæ•°: ${categories.length}`);
    console.log(`   âœ… æˆåŠŸã‚«ãƒ†ã‚´ãƒªæ•°: ${successCount}`);
    console.log(`   ğŸ“ ç·å–å¾—æ¡ˆä»¶æ•°: ${totalJobs}ä»¶`);
    console.log(`   â±ï¸ ç·å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);

    return {
      success: successCount > 0,
      results,
      executionTime,
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime,
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * æ¡ˆä»¶è©³ç´°æƒ…å ±ã‚’æŠ½å‡º
 */
export async function scrapeCrowdWorksJobDetail(page: Page, jobUrl: string): Promise<CrowdWorksJobDetail> {
  console.log(`ğŸ“„ æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹: ${jobUrl}`);

  await page.goto(jobUrl, {
    waitUntil: 'domcontentloaded',
    timeout: 60000
  });

  await page.waitForTimeout(2000);

  const detail = await page.evaluate(() => {
    const doc = (globalThis as any).document;

    // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—ï¼ˆh1ã‹ã‚‰æ­£ç¢ºã«æŠ½å‡ºï¼‰
    const titleElement = doc.querySelector('h1');
    const fullTitle = titleElement?.textContent?.trim() || '';
    // æ¡ˆä»¶ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ä¸è¦ãªéƒ¨åˆ†ã‚’å‰Šé™¤ï¼ˆã‚ˆã‚Šæ­£ç¢ºã«ï¼‰
    const title = fullTitle.replace(/\s+(ã‚¦ã‚§ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³|ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ|ãã®ä»–).*ã®ä»•äº‹ã®ä¾é ¼.*$/, '').trim();

    // æ¡ˆä»¶IDã‚’URLã‹ã‚‰æŠ½å‡º
    const jobId = (globalThis as any).window.location.pathname.match(/\/(\d+)$/)?.[1] || '';

    // ã‚«ãƒ†ã‚´ãƒªã‚’å–å¾—ï¼ˆãƒ‘ãƒ³ããšã‹ã‚‰ï¼‰
    const categoryElement = doc.querySelector('a[href*="/public/jobs/category/"]');
    const category = categoryElement?.textContent?.trim() || '';

    // ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã§ã®æƒ…å ±æŠ½å‡º
    const pageText = doc.body?.textContent || '';

    // æ”¯æ‰•ã„ãƒ»äºˆç®—æƒ…å ±ã‚’æŠ½å‡º
    let paymentType = '';
    let budget = '';

    const fixedPaymentMatch = pageText.match(/å›ºå®šå ±é…¬åˆ¶\s*([0-9,]+å††\s*ã€œ\s*[0-9,]+å††|[0-9,]+å††)/);
    if (fixedPaymentMatch) {
      paymentType = 'å›ºå®šå ±é…¬åˆ¶';
      budget = fixedPaymentMatch[1];
    } else {
      const hourlyPaymentMatch = pageText.match(/æ™‚é–“å˜ä¾¡åˆ¶\s*([0-9,]+å††\/æ™‚é–“\s*ã€œ\s*[0-9,]+å††\/æ™‚é–“|[0-9,]+å††\/æ™‚é–“)/);
      if (hourlyPaymentMatch) {
        paymentType = 'æ™‚é–“å˜ä¾¡åˆ¶';
        budget = hourlyPaymentMatch[1];
      }
    }

    // æ—¥ä»˜æƒ…å ±ã‚’æŠ½å‡º
    let postDate = '';
    let applicationDeadline = '';
    let deliveryDate = '';

    const postDateMatch = pageText.match(/æ²è¼‰æ—¥\s*(\d{4}å¹´\d{2}æœˆ\d{2}æ—¥)/);
    if (postDateMatch) {
      postDate = postDateMatch[1];
    }

    const deadlineMatch = pageText.match(/å¿œå‹ŸæœŸé™\s*(\d{4}å¹´\d{2}æœˆ\d{2}æ—¥)/);
    if (deadlineMatch) {
      applicationDeadline = deadlineMatch[1];
    }

    const deliveryMatch = pageText.match(/ç´å“å¸Œæœ›æ—¥\s*([^\s]+)/);
    if (deliveryMatch && deliveryMatch[1] !== '-') {
      deliveryDate = deliveryMatch[1];
    }

    // å¿œå‹ŸçŠ¶æ³æƒ…å ±ã‚’æŠ½å‡º
    let applicantCount = 0;
    let contractCount = 0;
    let recruitmentCount = 0;
    let favoriteCount = 0;

    const applicantMatch = pageText.match(/å¿œå‹Ÿã—ãŸäºº\s*(\d+)\s*äºº/);
    if (applicantMatch) applicantCount = parseInt(applicantMatch[1]);

    const contractMatch = pageText.match(/å¥‘ç´„ã—ãŸäºº\s*(\d+)\s*äºº/);
    if (contractMatch) contractCount = parseInt(contractMatch[1]);

    const recruitmentMatch = pageText.match(/å‹Ÿé›†äººæ•°\s*(\d+)\s*äºº/);
    if (recruitmentMatch) recruitmentCount = parseInt(recruitmentMatch[1]);

    const favoriteMatch = pageText.match(/æ°—ã«ãªã‚‹ï¼ãƒªã‚¹ãƒˆ\s*(\d+)\s*äºº/);
    if (favoriteMatch) favoriteCount = parseInt(favoriteMatch[1]);

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæƒ…å ±ã‚’æŠ½å‡º
    const clientLinkElement = doc.querySelector('a[href*="/public/employers/"]');
    let clientName = clientLinkElement?.textContent?.trim() || 'åŒ¿å';

    // anke7562ã®ã‚ˆã†ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã‚‚æŠ½å‡º
    if (clientName === 'åŒ¿å' || !clientName) {
      const clientNameMatch = pageText.match(/anke\d+|[a-zA-Z0-9_]+(?=\s*æœ¬äººç¢ºèª)/);
      if (clientNameMatch) {
        clientName = clientNameMatch[0];
      }
    }

    // è©•ä¾¡æƒ…å ±ã‚’æŠ½å‡º
    let overallRating = '';
    let orderHistory = '';
    let completionRate = '';

    const ratingMatch = pageText.match(/ç·åˆè©•ä¾¡\s*"?(\d+\.\d+)"?|"(\d+\.\d+)"/);
    if (ratingMatch) overallRating = ratingMatch[1] || ratingMatch[2];

    const historyMatch = pageText.match(/å‹Ÿé›†å®Ÿç¸¾\s*"?(\d+)"?\s*ä»¶|"(\d+)"\s*ä»¶/);
    if (historyMatch) orderHistory = (historyMatch[1] || historyMatch[2]) + 'ä»¶';

    const completionMatch = pageText.match(/ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†ç‡\s*"?(\d+)"?\s*%|"(\d+)"\s*%/);
    if (completionMatch) completionRate = (completionMatch[1] || completionMatch[2]) + '%';

    // æœ¬äººç¢ºèªçŠ¶æ…‹
    let identityVerified = false;
    if (pageText.includes('æœ¬äººç¢ºèªæ¸ˆã¿') || !pageText.includes('æœ¬äººç¢ºèªæœªæå‡º')) {
      identityVerified = true;
    }

    // è©³ç´°èª¬æ˜ã‚’å–å¾—ï¼ˆæœ€ã‚‚é•·ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ãƒ«ã‹ã‚‰ï¼‰
    let detailedDescription = '';
    const allCells = doc.querySelectorAll('td');
    let maxLength = 0;

    allCells.forEach((cell: any) => {
      const text = cell.textContent?.trim() || '';
      if (text.length > maxLength && text.length > 200 && text.includes('æ¦‚è¦')) {
        detailedDescription = text;
        maxLength = text.length;
      }
    });

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ¦‚è¦ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æœ€ã‚‚é•·ã„ã‚»ãƒ«ã‚’å–å¾—
    if (!detailedDescription) {
      maxLength = 0;
      allCells.forEach((cell: any) => {
        const text = cell.textContent?.trim() || '';
        if (text.length > maxLength && text.length > 100) {
          detailedDescription = text;
          maxLength = text.length;
        }
      });
    }

    // æœ€è¿‘ã®å¿œå‹Ÿè€…æƒ…å ±ã‚’å–å¾—
    const recentApplicants: Array<{
      name: string;
      applicationDate: string;
    }> = [];

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å¿œå‹Ÿè€…æƒ…å ±ã‚’å–å¾—
    const tables = doc.querySelectorAll('table');
    for (let i = tables.length - 1; i >= 0; i--) {
      const table = tables[i];
      const rows = table.querySelectorAll('tbody tr');

      rows.forEach((row: any) => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const nameCell = cells[0];
          const dateCell = cells[1];

          const nameLink = nameCell.querySelector('a');
          const name = nameLink?.textContent?.trim() || nameCell.textContent?.trim() || '';
          const applicationDate = dateCell.textContent?.trim() || '';

          // æœ‰åŠ¹ãªå¿œå‹Ÿè€…ãƒ‡ãƒ¼ã‚¿ã‹ãƒã‚§ãƒƒã‚¯
          if (name &&
            applicationDate &&
            applicationDate.includes('/') &&
            !name.includes('ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¯ãƒ¼ã‚«ãƒ¼') &&
            name.length < 50) {
            recentApplicants.push({
              name,
              applicationDate
            });
          }
        }
      });

      // å¿œå‹Ÿè€…ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’çµ‚äº†
      if (recentApplicants.length > 0) {
        break;
      }
    }

    return {
      jobId,
      title: title || fullTitle, // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      url: (globalThis as any).window.location.href,
      category,
      paymentType,
      budget,
      postDate,
      deliveryDate,
      applicationDeadline,
      desiredImages: [], // å¸Œæœ›ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ç¾åœ¨ã®æ§‹é€ ã§ã¯å–å¾—å›°é›£ãªãŸã‚ç©ºé…åˆ—
      applicantCount,
      contractCount,
      recruitmentCount,
      favoriteCount,
      client: {
        name: clientName,
        url: clientLinkElement?.getAttribute('href') ?
          `https://crowdworks.jp${clientLinkElement.getAttribute('href')}` : '',
        overallRating,
        orderHistory,
        completionRate,
        thankCount: '', // ã‚ã‚ŠãŒã¨ã†ä»¶æ•°ã¯ç¾åœ¨ã®æ§‹é€ ã§ã¯å–å¾—å›°é›£
        identityVerified,
        orderRuleCheck: false, // ç™ºæ³¨ãƒ«ãƒ¼ãƒ«ãƒã‚§ãƒƒã‚¯ã¯ç¾åœ¨ã®æ§‹é€ ã§ã¯å–å¾—å›°é›£
        description: '', // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèª¬æ˜ã¯ç¾åœ¨ã®æ§‹é€ ã§ã¯å–å¾—å›°é›£
      },
      detailedDescription,
      recentApplicants: recentApplicants.map(applicant => ({
        ...applicant,
        url: '' // å¿œå‹Ÿè€…URLã¯ç¾åœ¨ã®æ§‹é€ ã§ã¯å–å¾—å›°é›£
      })),
      scrapedAt: new Date().toISOString()
    };
  });

  console.log(`âœ… æ¡ˆä»¶è©³ç´°æƒ…å ±ã‚’å–å¾—: ${detail.title}`);
  return detail;
}

/**
 * æ¡ˆä»¶è©³ç´°ä»˜ãã§ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¡ˆä»¶ã‚’å–å¾—ã™ã‚‹
 */
export async function scrapeCrowdWorksJobsByCategoryWithDetails(params: {
  category: string;
  maxJobs: number;
  maxDetails?: number;
}): Promise<{
  jobs: CrowdWorksJob[];
  jobDetails: CrowdWorksJobDetail[];
}> {
  let browser: Browser | null = null;
  const detailsFile = `output/details-${params.category}.json`;
  let existingDetails: CrowdWorksJobDetail[] = [];
  let existingDetailIds = new Set<string>();

  // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
  try {
    const fileData = await readFileAsync(detailsFile);
    if (fileData) {
      existingDetails = JSON.parse(fileData);
      existingDetailIds = new Set(existingDetails.map((d) => d.jobId));
      console.log(`ğŸ“‚ æ—¢å­˜è©³ç´°ãƒ‡ãƒ¼ã‚¿: ${existingDetails.length}ä»¶`);
    }
  } catch (e) {
    console.log('âš ï¸ æ—¢å­˜è©³ç´°ãƒ•ã‚¡ã‚¤ãƒ«ãªã— or èª­ã¿è¾¼ã¿å¤±æ•—');
  }

  try {
    console.log(`ğŸ” ã‚«ãƒ†ã‚´ãƒªã€Œ${params.category}ã€ã®æ¡ˆä»¶ã¨è©³ç´°ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...`);
    browser = await chromium.launch({ headless: true, args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage'] });
    const context = await browser.newContext({ userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36' });
    const page = await context.newPage();
    const scrapingResult = await scrapeCrowdWorksJobsByCategory(page, params.category, params.maxJobs);
    if (!scrapingResult.success || scrapingResult.jobs.length === 0) {
      return { jobs: [], jobDetails: [] };
    }
    const jobs = scrapingResult.jobs;
    const maxDetailsCount = params.maxDetails ?? 3;
    // æœªå–å¾—IDã®ã¿æŠ½å‡º
    const detailTargets = jobs.filter(j => !existingDetailIds.has(j.id)).slice(0, maxDetailsCount);
    console.log(`ğŸ“‹ ${jobs.length}ä»¶ä¸­ã€æœªå–å¾—è©³ç´°: ${detailTargets.length}ä»¶`);
    const jobDetails: CrowdWorksJobDetail[] = [];
    for (let i = 0; i < detailTargets.length; i++) {
      const job = detailTargets[i]!;
      try {
        console.log(`ğŸ“„ æ¡ˆä»¶è©³ç´°å–å¾—ä¸­ (${i + 1}/${detailTargets.length}): ${job.title}`);
        const detail = await scrapeCrowdWorksJobDetail(page, job.url);
        jobDetails.push(detail);
        if (i < detailTargets.length - 1) {
          await page.waitForTimeout(2000);
        }
      } catch (error) {
        console.log(`âŒ æ¡ˆä»¶è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ${job.title}`, error);
        continue;
      }
    }
    // æ—¢å­˜+æ–°è¦ã§é‡è¤‡æ’é™¤ã—ã¦ä¿å­˜
    const mergedDetails = [...existingDetails, ...jobDetails].reduce((acc, cur) => {
      if (!acc.find(d => d.jobId === cur.jobId)) acc.push(cur);
      return acc;
    }, [] as CrowdWorksJobDetail[]);
    await writeFileAsync(detailsFile, JSON.stringify(mergedDetails, null, 2));
    console.log(`ğŸ’¾ è©³ç´°ãƒ‡ãƒ¼ã‚¿ä¿å­˜: ${detailsFile} (${mergedDetails.length}ä»¶)`);
    return { jobs, jobDetails: mergedDetails };
  } catch (error) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªè©³ç´°ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:`, errorMessage);
    return { jobs: [], jobDetails: [] };
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * Lambdaé–¢æ•°ã®ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
 * EventBridgeã‹ã‚‰ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã‚’å‡¦ç†
 */
export const lambdaHandler = async (
  event: ScheduledExecutionEvent,
  _context: Context
): Promise<ScheduledExecutionResponse> => {
  const startTime = Date.now();

  try {
    console.log('ğŸš€ CrowdWorksã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° Lambdaå®Ÿè¡Œé–‹å§‹');
    console.log('ğŸ“‹ ã‚¤ãƒ™ãƒ³ãƒˆ:', JSON.stringify(event, null, 2));

    // ãƒ¡ã‚¤ãƒ³å‡¦ç†: ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ
    const result = await testCrowdWorksCategories();

    const executionTime = Date.now() - startTime;

    if (result.success) {
      const summary = Object.entries(result.results || {}).map(([category, categoryResult]) =>
        `${category}: ${categoryResult.jobsFound}ä»¶`
      ).join(', ');

      const response: ScheduledExecutionResponse = {
        statusCode: 200,
        body: JSON.stringify({
          success: true,
          message: `CrowdWorksã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº† - ${summary}`,
          executionTime,
          timestamp: new Date().toISOString(),
          results: result.results
        }),
        executionTime,
        timestamp: new Date().toISOString()
      };

      console.log('âœ… Lambdaå®Ÿè¡Œå®Œäº†');
      console.log(`ğŸ“Š å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);
      return response;
    } else {
      const response: ScheduledExecutionResponse = {
        statusCode: 500,
        body: JSON.stringify({
          success: false,
          error: result.error || 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ',
          executionTime,
          timestamp: new Date().toISOString()
        }),
        executionTime,
        timestamp: new Date().toISOString()
      };

      console.error('âŒ Lambdaå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', result.error);
      return response;
    }

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);

    const response: ScheduledExecutionResponse = {
      statusCode: 500,
      body: JSON.stringify({
        success: false,
        error: errorMessage,
        executionTime,
        timestamp: new Date().toISOString()
      }),
      executionTime,
      timestamp: new Date().toISOString()
    };

    console.error('âŒ Lambdaå®Ÿè¡Œä¸­ã®äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼:', errorMessage);
    return response;
  }
};

// API Gatewayç”¨ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
export const handler = lambdaHandler;

/**
 * ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰æ¡ˆä»¶è©³ç´°ã‚’å–å¾—ãƒ»ä¿å­˜ã™ã‚‹å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
 */
export async function loginAndScrapeCategories(params: {
  categories: string[];  // 'ec', 'web_products'ãªã©
  maxJobsPerCategory: number;
  maxDetailsPerCategory: number;
  saveToFile?: boolean;
}): Promise<{
  success: boolean;
  loginResult?: LoginResult;
  categoryResults?: { [category: string]: ScrapingResult };
  detailResults?: { [category: string]: CrowdWorksJobDetail[] };
  savedFiles?: string[] | undefined;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ CrowdWorkså®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹...');
    console.log(`ğŸ“‹ å¯¾è±¡ã‚«ãƒ†ã‚´ãƒª: ${params.categories.join(', ')}`);
    console.log(`ğŸ“Š ã‚«ãƒ†ã‚´ãƒªæ¯æœ€å¤§æ¡ˆä»¶æ•°: ${params.maxJobsPerCategory}`);
    console.log(`ğŸ“„ ã‚«ãƒ†ã‚´ãƒªæ¯æœ€å¤§è©³ç´°æ•°: ${params.maxDetailsPerCategory}`);

    // 1. ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer',
        '--disable-background-timer-throttling',
        '--disable-backgrounding-occluded-windows',
        '--disable-renderer-backgrounding',
        '--disable-features=TranslateUI',
        '--disable-ipc-flooding-protection',
      ]
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
    });

    const page = await context.newPage();

    // 2. ãƒ­ã‚°ã‚¤ãƒ³å®Ÿè¡Œ
    console.log('ğŸ” CrowdWorksãƒ­ã‚°ã‚¤ãƒ³é–‹å§‹...');
    const credentials = await getCrowdWorksCredentials();
    const loginResult = await loginToCrowdWorks(page, credentials);

    if (!loginResult.success) {
      throw new Error(`ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${loginResult.error}`);
    }

    console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ');

    // 3. å„ã‚«ãƒ†ã‚´ãƒªã§æ¡ˆä»¶å–å¾—
    const categoryResults: { [category: string]: ScrapingResult } = {};
    const detailResults: { [category: string]: CrowdWorksJobDetail[] } = {};
    const savedFiles: string[] = [];

    for (const category of params.categories) {
      console.log(`\nğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹...`);

      try {
        // ã‚«ãƒ†ã‚´ãƒªã®æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—
        const categoryResult = await scrapeCrowdWorksJobsByCategory(
          page,
          category,
          params.maxJobsPerCategory
        );

        if (!categoryResult.success) {
          console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€æ¡ˆä»¶å–å¾—å¤±æ•—: ${categoryResult.error}`);
          continue;
        }

        categoryResults[category] = categoryResult;
        console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ${categoryResult.jobsFound}ä»¶ã®æ¡ˆä»¶ã‚’å–å¾—`);

        // è©³ç´°æƒ…å ±ã‚’å–å¾—ã™ã‚‹æ¡ˆä»¶ã‚’é¸æŠ
        const detailTargets = categoryResult.jobs.slice(0, params.maxDetailsPerCategory);
        const categoryDetails: CrowdWorksJobDetail[] = [];

        console.log(`ğŸ“„ è©³ç´°å–å¾—å¯¾è±¡: ${detailTargets.length}ä»¶`);

        // å„æ¡ˆä»¶ã®è©³ç´°ã‚’å–å¾—
        for (let i = 0; i < detailTargets.length; i++) {
          const job = detailTargets[i]!;
          try {
            console.log(`ğŸ“„ è©³ç´°å–å¾—ä¸­ (${i + 1}/${detailTargets.length}): ${job.title}`);
            const detail = await scrapeCrowdWorksJobDetail(page, job.url);
            categoryDetails.push(detail);

            // ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–“éš”ã‚’ç©ºã‘ã‚‹
            if (i < detailTargets.length - 1) {
              await page.waitForTimeout(2000);
            }
          } catch (error) {
            console.log(`âŒ æ¡ˆä»¶è©³ç´°å–å¾—ã‚¨ãƒ©ãƒ¼: ${job.title}`, error);
            continue;
          }
        }

        detailResults[category] = categoryDetails;
        console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€è©³ç´°å–å¾—å®Œäº†: ${categoryDetails.length}ä»¶`);

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (params.saveToFile) {
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

          // æ¡ˆä»¶ä¸€è¦§ä¿å­˜
          const jobsFileName = `/tmp/crowdworks-${category}-jobs-${timestamp}.json`;
          const jobsData = {
            category,
            scrapedAt: new Date().toISOString(),
            totalJobs: categoryResult.jobsFound,
            jobs: categoryResult.jobs
          };

          try {
            await writeFileAsync(jobsFileName, JSON.stringify(jobsData, null, 2));
            savedFiles.push(jobsFileName);
            console.log(`ğŸ’¾ æ¡ˆä»¶ä¸€è¦§ä¿å­˜: ${jobsFileName}`);
          } catch (saveError) {
            console.log(`âŒ æ¡ˆä»¶ä¸€è¦§ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError}`);
          }

          // è©³ç´°æƒ…å ±ä¿å­˜
          if (categoryDetails.length > 0) {
            const detailsFileName = `/tmp/crowdworks-${category}-details-${timestamp}.json`;
            const detailsData = {
              category,
              scrapedAt: new Date().toISOString(),
              totalDetails: categoryDetails.length,
              details: categoryDetails
            };

            try {
              await writeFileAsync(detailsFileName, JSON.stringify(detailsData, null, 2));
              savedFiles.push(detailsFileName);
              console.log(`ğŸ’¾ è©³ç´°æƒ…å ±ä¿å­˜: ${detailsFileName}`);
            } catch (saveError) {
              console.log(`âŒ è©³ç´°æƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError}`);
            }
          }
        }

      } catch (categoryError) {
        console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, categoryError);
        continue;
      }
    }

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`\nğŸ¯ å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº† (${executionTime}ms)`);
    console.log(`ğŸ“Š å‡¦ç†çµæœã‚µãƒãƒªãƒ¼:`);
    console.log(`  - å‡¦ç†ã‚«ãƒ†ã‚´ãƒªæ•°: ${Object.keys(categoryResults).length}/${params.categories.length}`);
    console.log(`  - ç·æ¡ˆä»¶æ•°: ${Object.values(categoryResults).reduce((sum, result) => sum + result.jobsFound, 0)}`);
    console.log(`  - ç·è©³ç´°æ•°: ${Object.values(detailResults).reduce((sum, details) => sum + details.length, 0)}`);
    console.log(`  - ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${savedFiles.length}`);

    return {
      success: true,
      loginResult,
      categoryResults,
      detailResults,
      savedFiles: savedFiles.length > 0 ? savedFiles : undefined,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
async function writeFileAsync(filePath: string, data: string): Promise<void> {
  return new Promise((resolve, reject) => {
    const fs = require('fs');
    fs.writeFile(filePath, data, (err: any) => {
      if (err) reject(err);
      else resolve();
    });
  });
}

/**
 * ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã§ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰æ¡ˆä»¶ã‚’å–å¾—ã™ã‚‹ãƒ†ã‚¹ãƒˆï¼ˆèªè¨¼å•é¡Œå›é¿ç‰ˆï¼‰
 */
export async function testCategoryScrapingWithoutLogin(params: {
  categories: string[];
  maxJobsPerCategory: number;
  saveToFile?: boolean;
}): Promise<{
  success: boolean;
  categoryResults?: { [category: string]: ScrapingResult };
  savedFiles?: string[];
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  let browser: Browser | null = null;

  try {
    console.log('ğŸš€ ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹...');
    console.log(`ğŸ“‹ å¯¾è±¡ã‚«ãƒ†ã‚´ãƒª: ${params.categories.join(', ')}`);
    console.log(`ğŸ“Š ã‚«ãƒ†ã‚´ãƒªæ¯æœ€å¤§æ¡ˆä»¶æ•°: ${params.maxJobsPerCategory}`);

    // 1. ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--single-process',
        '--no-zygote',
        '--disable-software-rasterizer'
      ]
    });

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
    });

    const page = await context.newPage();

    // 2. å„ã‚«ãƒ†ã‚´ãƒªã§æ¡ˆä»¶å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãªã—ï¼‰
    const categoryResults: { [category: string]: ScrapingResult } = {};
    const savedFiles: string[] = [];

    for (const category of params.categories) {
      console.log(`\nğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹...`);

      try {
        // ã‚«ãƒ†ã‚´ãƒªã®æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãªã—ï¼‰
        const categoryResult = await scrapeCrowdWorksJobsByCategory(
          page,
          category,
          params.maxJobsPerCategory
        );

        if (!categoryResult.success) {
          console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€æ¡ˆä»¶å–å¾—å¤±æ•—: ${categoryResult.error}`);
          continue;
        }

        categoryResults[category] = categoryResult;
        console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ${categoryResult.jobsFound}ä»¶ã®æ¡ˆä»¶ã‚’å–å¾—`);

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (params.saveToFile) {
          const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

          // æ¡ˆä»¶ä¸€è¦§ä¿å­˜
          const jobsFileName = `./crowdworks-${category}-jobs-${timestamp}.json`;
          const jobsData = {
            category,
            scrapedAt: new Date().toISOString(),
            totalJobs: categoryResult.jobsFound,
            jobs: categoryResult.jobs
          };

          try {
            await writeFileAsync(jobsFileName, JSON.stringify(jobsData, null, 2));
            savedFiles.push(jobsFileName);
            console.log(`ğŸ’¾ æ¡ˆä»¶ä¸€è¦§ä¿å­˜: ${jobsFileName}`);
          } catch (saveError) {
            console.log(`âŒ æ¡ˆä»¶ä¸€è¦§ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError}`);
          }
        }

      } catch (categoryError) {
        console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†ã‚¨ãƒ©ãƒ¼:`, categoryError);
        continue;
      }
    }

    await context.close();

    const executionTime = Date.now() - startTime;
    console.log(`\nğŸ¯ ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº† (${executionTime}ms)`);
    console.log(`ğŸ“Š å‡¦ç†çµæœã‚µãƒãƒªãƒ¼:`);
    console.log(`  - å‡¦ç†ã‚«ãƒ†ã‚´ãƒªæ•°: ${Object.keys(categoryResults).length}/${params.categories.length}`);
    console.log(`  - ç·æ¡ˆä»¶æ•°: ${Object.values(categoryResults).reduce((sum, result) => sum + result.jobsFound, 0)}`);
    console.log(`  - ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${savedFiles.length}`);

    return {
      success: true,
      categoryResults,
      ...(savedFiles.length > 0 ? { savedFiles } : {}),
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ãªã—ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å¤±æ•—:', errorMessage);

    return {
      success: false,
      error: errorMessage,
      executionTime
    };
  } finally {
    if (browser) {
      try {
        await browser.close();
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
      } catch (closeError) {
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã®åŸå› ã‚’èª¿æŸ»ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒãƒƒã‚°ç‰ˆãƒ†ã‚¹ãƒˆ
 */
export async function debugBrowserLifecycle(): Promise<{
  success: boolean;
  steps: string[];
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  const steps: string[] = [];
  let browser: Browser | null = null;

  try {
    steps.push('ğŸš€ ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹');
    console.log('ğŸš€ ãƒ–ãƒ©ã‚¦ã‚¶ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•å‰ã®çŠ¶æ…‹ç¢ºèª
    steps.push('ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª');
    console.log('ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªä¸­...');

    // ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
    steps.push('ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•é–‹å§‹');
    console.log('ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ä¸­...');

    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--disable-software-rasterizer'
      ]
    });

    steps.push('âœ… ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•å®Œäº†');
    console.log('âœ… ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•å®Œäº†');

    // ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
    browser.on('disconnected', () => {
      steps.push('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶äºˆæœŸã—ãªã„åˆ‡æ–­æ¤œå‡º');
      console.log('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ãŒäºˆæœŸã›ãšåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    });

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    steps.push('ğŸ“„ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆé–‹å§‹');
    console.log('ğŸ“„ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆä¸­...');

    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
    });

    steps.push('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆå®Œäº†');
    console.log('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆå®Œäº†');

    // ãƒšãƒ¼ã‚¸ä½œæˆ
    steps.push('ğŸ“‹ ãƒšãƒ¼ã‚¸ä½œæˆé–‹å§‹');
    console.log('ğŸ“‹ ãƒšãƒ¼ã‚¸ä½œæˆä¸­...');

    const page = await context.newPage();

    steps.push('âœ… ãƒšãƒ¼ã‚¸ä½œæˆå®Œäº†');
    console.log('âœ… ãƒšãƒ¼ã‚¸ä½œæˆå®Œäº†');

    // ãƒšãƒ¼ã‚¸çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
    page.on('close', () => {
      steps.push('âš ï¸ ãƒšãƒ¼ã‚¸äºˆæœŸã—ãªã„çµ‚äº†æ¤œå‡º');
      console.log('âš ï¸ ãƒšãƒ¼ã‚¸ãŒäºˆæœŸã›ãšçµ‚äº†ã•ã‚Œã¾ã—ãŸ');
    });

    // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
    steps.push('ğŸŒ Google ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹');
    console.log('ğŸŒ Google ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    await page.goto('https://www.google.com', {
      waitUntil: 'domcontentloaded',
      timeout: 10000
    });

    steps.push('âœ… Google ã‚¢ã‚¯ã‚»ã‚¹å®Œäº†');
    console.log('âœ… Google ã‚¢ã‚¯ã‚»ã‚¹å®Œäº†');

    // ã‚¿ã‚¤ãƒˆãƒ«å–å¾—
    steps.push('ğŸ“‹ ã‚¿ã‚¤ãƒˆãƒ«å–å¾—é–‹å§‹');
    const title = await page.title();
    steps.push(`âœ… ã‚¿ã‚¤ãƒˆãƒ«å–å¾—å®Œäº†: ${title}`);
    console.log(`âœ… ã‚¿ã‚¤ãƒˆãƒ«å–å¾—å®Œäº†: ${title}`);

    // å¾…æ©Ÿãƒ†ã‚¹ãƒˆ
    steps.push('â³ 2ç§’å¾…æ©Ÿãƒ†ã‚¹ãƒˆé–‹å§‹');
    console.log('â³ 2ç§’å¾…æ©Ÿãƒ†ã‚¹ãƒˆé–‹å§‹...');
    await page.waitForTimeout(2000);
    steps.push('âœ… 2ç§’å¾…æ©Ÿå®Œäº†');
    console.log('âœ… 2ç§’å¾…æ©Ÿå®Œäº†');

    // CrowdWorksãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
    steps.push('ğŸ¯ CrowdWorksãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹é–‹å§‹');
    console.log('ğŸ¯ CrowdWorksãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹é–‹å§‹...');

    await page.goto('https://crowdworks.jp', {
      waitUntil: 'domcontentloaded',
      timeout: 15000
    });

    steps.push('âœ… CrowdWorksãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹å®Œäº†');
    console.log('âœ… CrowdWorksãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹å®Œäº†');

    const cwTitle = await page.title();
    steps.push(`ğŸ“‹ CrowdWorksã‚¿ã‚¤ãƒˆãƒ«: ${cwTitle}`);
    console.log(`ğŸ“‹ CrowdWorksã‚¿ã‚¤ãƒˆãƒ«: ${cwTitle}`);

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    steps.push('ğŸ§¹ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†é–‹å§‹');
    console.log('ğŸ§¹ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†é–‹å§‹...');
    await context.close();
    steps.push('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†å®Œäº†');
    console.log('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†å®Œäº†');

    const executionTime = Date.now() - startTime;
    steps.push(`ğŸ‰ ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);
    console.log(`ğŸ‰ ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    return {
      success: true,
      steps,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    steps.push(`âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${errorMessage}`);
    console.error('âŒ ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      steps,
      error: errorMessage,
      executionTime
    };
  } finally {
    if (browser) {
      try {
        steps.push('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†é–‹å§‹');
        console.log('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†é–‹å§‹...');
        await browser.close();
        steps.push('âœ… ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†å®Œäº†');
        console.log('âœ… ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†å®Œäº†');
      } catch (closeError) {
        steps.push(`âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã‚¨ãƒ©ãƒ¼: ${closeError}`);
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªåˆ¥CrowdWorksæ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆï¼‰
 */
async function scrapeCrowdWorksJobsByCategoryDebug(
  page: Page,
  category: string,
  maxJobs: number = 20
): Promise<ScrapingResult> {
  const startTime = Date.now();

  try {
    console.log(`ğŸ” ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã®æ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...`);

    // ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã®äº‹å‰ç¢ºèª
    console.log('ğŸ“Š ãƒšãƒ¼ã‚¸çŠ¶æ…‹ç¢ºèªä¸­...');
    const isConnected = page.isClosed();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸çŠ¶æ…‹: ${isConnected ? 'é–‰ã˜ã¦ã„ã‚‹' : 'é–‹ã„ã¦ã„ã‚‹'}`);

    if (isConnected) {
      throw new Error('ãƒšãƒ¼ã‚¸ãŒæ—¢ã«é–‰ã˜ã‚‰ã‚Œã¦ã„ã¾ã™');
    }

    // ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã®URLæ§‹ç¯‰
    const categoryUrl = `https://crowdworks.jp/public/jobs/group/${category}`;
    console.log(`ğŸ“„ ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹: ${categoryUrl}`);

    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‰ã®ãƒšãƒ¼ã‚¸çŠ¶æ…‹ç¢ºèª
    console.log('ğŸŒ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å‰çŠ¶æ…‹ç¢ºèª...');
    console.log(`ğŸ“‹ ç¾åœ¨ã®URL: ${page.url()}`);

    await page.goto(categoryUrl, {
      waitUntil: 'domcontentloaded',
      timeout: 30000
    });

    console.log('âœ… ã‚«ãƒ†ã‚´ãƒªãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ç¢ºèª
    const pageTitle = await page.title();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«: "${pageTitle}"`);

    // æ–°ç€é †ã‚½ãƒ¼ãƒˆã‚’è¨­å®š - URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç›´æ¥æŒ‡å®š
    console.log('ğŸ”„ æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šä¸­...');
    try {
      const currentUrl = page.url();
      const newUrl = currentUrl.includes('?')
        ? `${currentUrl}&order=new`
        : `${currentUrl}?order=new`;

      await page.goto(newUrl, { waitUntil: 'domcontentloaded', timeout: 30000 });
      console.log(`âœ… æ–°ç€é †URLç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹: ${newUrl}`);
    } catch (sortError) {
      console.log('âš ï¸ æ–°ç€é †ã‚½ãƒ¼ãƒˆè¨­å®šå¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé †åºã§ç¶šè¡Œ');
    }

    // DOMæ§‹é€ ã‚’ç¢ºèª
    console.log('ğŸ” DOMæ§‹é€ ç¢ºèªä¸­...');
    const domInfo = await page.evaluate(() => {
      const doc = (globalThis as any).document;
      return {
        listCount: doc.querySelectorAll('list').length,
        listitemCount: doc.querySelectorAll('listitem').length,
        ulCount: doc.querySelectorAll('ul').length,
        liCount: doc.querySelectorAll('li').length,
        jobLinksCount: doc.querySelectorAll('a[href*="/public/jobs/"]').length,
        hasMainElement: !!doc.querySelector('main')
      };
    });
    console.log('ğŸ“Š DOMæ§‹é€ :', JSON.stringify(domInfo, null, 2));

    // æ¡ˆä»¶ä¸€è¦§ã®è¦ç´ ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    console.log('â³ æ¡ˆä»¶ä¸€è¦§èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...');
    try {
      // å®Ÿéš›ã®DOMæ§‹é€ ã«åŸºã¥ã„ãŸå¾…æ©Ÿ
      await page.waitForSelector('main list listitem', { timeout: 10000 });
      console.log('âœ… æ¡ˆä»¶ä¸€è¦§è¦ç´ ã®èª­ã¿è¾¼ã¿ç¢ºèª');
    } catch (error) {
      console.log('âš ï¸ æ¨™æº–çš„ãªæ¡ˆä»¶ä¸€è¦§è¦ç´ å¾…æ©Ÿå¤±æ•—ã€ä»–ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è©¦è¡Œ');
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šä¸€èˆ¬çš„ãªãƒªã‚¹ãƒˆè¦ç´ ã‚’å¾…æ©Ÿ
      try {
        await page.waitForSelector('ul li, ol li', { timeout: 5000 });
        console.log('âœ… ä»£æ›¿æ¡ˆä»¶ä¸€è¦§è¦ç´ ã®èª­ã¿è¾¼ã¿ç¢ºèª');
      } catch (fallbackError) {
        console.log('âš ï¸ æ¡ˆä»¶ä¸€è¦§è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€DOMæ§‹é€ ã‚’ç›´æ¥è§£æã—ã¾ã™');
      }
    }

    // ã‚ˆã‚Šå®‰å…¨ãªevaluateå®Ÿè¡Œ
    console.log('ğŸ“ æ¡ˆä»¶ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...');

    // ãƒšãƒ¼ã‚¸çŠ¶æ…‹ã®å†ç¢ºèª
    console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå‰ãƒšãƒ¼ã‚¸çŠ¶æ…‹ç¢ºèª...');
    const isStillConnected = page.isClosed();
    console.log(`ğŸ“‹ ãƒšãƒ¼ã‚¸çŠ¶æ…‹: ${isStillConnected ? 'é–‰ã˜ã¦ã„ã‚‹' : 'é–‹ã„ã¦ã„ã‚‹'}`);

    if (isStillConnected) {
      throw new Error('ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå‰ã«ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸ');
    }

    const jobs: CrowdWorksJob[] = await page.evaluate((params: { maxJobsLimit: number; categoryName: string; scrapedIds: string[] }) => {
      console.log('ğŸ” DOMè§£æé–‹å§‹...');

      // ç›´æ¥æ¡ˆä»¶ãƒªãƒ³ã‚¯ã‹ã‚‰æŠ½å‡ºï¼ˆãƒ‡ãƒãƒƒã‚°ã§æˆåŠŸã—ãŸæ–¹å¼ï¼‰
      const doc = (globalThis as any).document;
      const jobLinks = doc.querySelectorAll('a[href*="/public/jobs/"]');
      console.log(`ğŸ”— æ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°: ${jobLinks.length}`);

      if (jobLinks.length === 0) {
        console.log('âŒ æ¡ˆä»¶ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return [];
      }

      // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹ï¼ˆä¸€è¦§ãƒšãƒ¼ã‚¸ã‚„ä»–ã®ãƒªãƒ³ã‚¯ã‚’é™¤å¤–ï¼‰
      const validJobLinks: any[] = [];
      for (let i = 0; i < jobLinks.length; i++) {
        const link = jobLinks[i];
        const href = link.getAttribute('href') || '';

        // æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
        if (href.match(/\/public\/jobs\/\d+$/) && !href.includes('category') && !href.includes('group')) {
          validJobLinks.push(link);
        }
      }

      console.log(`âœ… æœ‰åŠ¹ãªæ¡ˆä»¶ãƒªãƒ³ã‚¯æ•°: ${validJobLinks.length}`);

      // æœ€åˆã®æ•°ä»¶ã®ã¿ã‚’å®‰å…¨ã«æŠ½å‡º
      const safeLimit = Math.min(validJobLinks.length, params.maxJobsLimit);
      const jobs: any[] = [];

      for (let i = 0; i < safeLimit; i++) {
        try {
          const link = validJobLinks[i];
          const href = link.getAttribute('href') || '';
          const title = link.textContent?.trim() || '';
          const url = href.startsWith('http') ? href : `https://crowdworks.jp${href}`;

          // æ¡ˆä»¶IDã‚’URLã‹ã‚‰æŠ½å‡º
          const jobIdMatch = url.match(/\/public\/jobs\/(\d+)/);
          const jobId = jobIdMatch ? (jobIdMatch[1] ?? `unknown_${i}`) : `unknown_${i}`;

          if (title && url && jobId !== `unknown_${i}`) {
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if (params.scrapedIds.includes(jobId)) {
              console.log(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: é‡è¤‡æ¡ˆä»¶ ${jobId}`);
              continue;
            }

            // è¦ªè¦ç´ ã‹ã‚‰è¿½åŠ æƒ…å ±ã‚’å–å¾—
            let parentElement = link.parentElement;
            let detailText = '';
            let budget = '';

            // æœ€å¤§5éšå±¤ã¾ã§è¦ªè¦ç´ ã‚’è¾¿ã‚‹
            for (let depth = 0; depth < 5 && parentElement; depth++) {
              const parentText = parentElement.textContent || '';
              if (parentText.includes('å††') && !budget) {
                // äºˆç®—æƒ…å ±ã‚’æŠ½å‡º
                const budgetMatch = parentText.match(/(\d{1,3}(?:,\d{3})*)\s*å††/);
                if (budgetMatch) {
                  budget = budgetMatch[0];
                }
              }

              if (parentText.length > detailText.length && parentText.length < 1000) {
                detailText = parentText;
              }

              parentElement = parentElement.parentElement;
            }

            // äºˆç®—ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
            let budgetType: 'fixed' | 'hourly' | 'unknown' = 'unknown';
            let budgetAmount = 0;

            if (detailText.includes('å›ºå®šå ±é…¬åˆ¶')) {
              budgetType = 'fixed';
            } else if (detailText.includes('æ™‚é–“å˜ä¾¡åˆ¶')) {
              budgetType = 'hourly';
            }

            if (budget) {
              const amountStr = budget.replace(/[^0-9]/g, '');
              budgetAmount = parseInt(amountStr) || 0;
            }

            // ã‚¿ã‚°/ã‚¹ã‚­ãƒ«ã®å–å¾—
            const tags: string[] = [];
            if (detailText) {
              const skillMatches = detailText.match(/([a-zA-Z]+|[ã‚¡-ãƒ¶ãƒ¼]+[\w]*)/g);
              if (skillMatches) {
                skillMatches.forEach(skill => {
                  if (skill.length > 2 && skill.length < 20) {
                    tags.push(skill);
                  }
                });
              }
            }

            // æŠ•ç¨¿æ—¥æ™‚ã®å–å¾—
            let postedAt = new Date().toISOString().split('T')[0];
            const dateMatch = detailText.match(/(\d{4}å¹´\d{2}æœˆ\d{2}æ—¥|\d{2}æœˆ\d{2}æ—¥)/);
            if (dateMatch) {
              postedAt = dateMatch[0];
            }

            // å¿œå‹Ÿè€…æ•°ã¨æœŸé™ã®å–å¾—
            let applicants = 0;
            let deadline = '';

            const contractMatch = detailText.match(/å¥‘ç´„æ•°[^\d]*(\d+)/);
            if (contractMatch) {
              applicants = parseInt(contractMatch[1] ?? '0') || 0;
            }

            const deadlineMatch = detailText.match(/ã‚ã¨(\d+)æ—¥|(\d+æœˆ\d+æ—¥)/);
            if (deadlineMatch) {
              deadline = deadlineMatch[0] ?? '';
            }

            jobs.push({
              id: jobId,
              title: title,
              description: detailText.substring(0, 500),
              url: url,
              budget: {
                type: budgetType,
                amount: budgetAmount,
                currency: 'JPY'
              },
              category: params.categoryName,
              tags: tags.slice(0, 10),
              client: {
                name: 'åŒ¿å',
                rating: 0,
                reviewCount: 0
              },
              postedAt: postedAt,
              deadline: deadline,
              applicants: applicants,
              scrapedAt: new Date().toISOString()
            });
            console.log(`âœ… æ¡ˆä»¶æŠ½å‡ºæˆåŠŸ: ${title} (${jobId}) - ${budget}`);
          }
        } catch (itemError) {
          console.log(`âŒ æ¡ˆä»¶ ${i} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`, itemError);
          continue;
        }
      }

      console.log(`ğŸ“Š åˆè¨ˆ ${jobs.length} ä»¶ã®æ¡ˆä»¶ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`);
      return jobs;
    }, { maxJobsLimit: maxJobs, categoryName: category, scrapedIds: [] });

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
    jobs.forEach((job: CrowdWorksJob) => scrapedJobsCache.add(job.id));

    const executionTime = Date.now() - startTime;

    console.log(`ğŸ‰ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†:`);
    console.log(`   ğŸ“Š å–å¾—æ¡ˆä»¶æ•°: ${jobs.length}`);
    console.log(`   â±ï¸ å®Ÿè¡Œæ™‚é–“: ${executionTime}ms`);

    // ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
    if (jobs.length > 0) {
      console.log(`ğŸ“ ã‚µãƒ³ãƒ—ãƒ«æ¡ˆä»¶:`);
      const sample = jobs[0];
      if (sample) {
        console.log(`   ğŸ·ï¸ ã‚¿ã‚¤ãƒˆãƒ«: ${sample.title}`);
        console.log(`   ğŸ”— URL: ${sample.url}`);
      }
    }

    return {
      success: true,
      jobsFound: jobs.length,
      jobs,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:`, errorMessage);

    return {
      success: false,
      jobsFound: 0,
      jobs: [],
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã®ãƒ‡ãƒãƒƒã‚°ç‰ˆãƒ†ã‚¹ãƒˆ
 */
export async function debugCategoryScrapingTest(): Promise<{
  success: boolean;
  steps: string[];
  categoryResults?: { [category: string]: ScrapingResult };
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  const steps: string[] = [];
  let browser: Browser | null = null;

  try {
    steps.push('ğŸš€ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹');
    console.log('ğŸš€ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆé–‹å§‹...');

    // ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
    steps.push('ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ä¸­');
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--disable-software-rasterizer'
      ]
    });

    steps.push('âœ… ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•å®Œäº†');

    // ãƒ–ãƒ©ã‚¦ã‚¶ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    browser.on('disconnected', () => {
      steps.push('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶äºˆæœŸã—ãªã„åˆ‡æ–­æ¤œå‡º');
      console.log('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ãŒäºˆæœŸã›ãšåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    });

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    steps.push('ğŸ“„ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆä¸­');
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
    });

    steps.push('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆå®Œäº†');

    // ãƒšãƒ¼ã‚¸ä½œæˆ
    steps.push('ğŸ“‹ ãƒšãƒ¼ã‚¸ä½œæˆä¸­');
    const page = await context.newPage();

    steps.push('âœ… ãƒšãƒ¼ã‚¸ä½œæˆå®Œäº†');

    // ãƒšãƒ¼ã‚¸ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    page.on('close', () => {
      steps.push('âš ï¸ ãƒšãƒ¼ã‚¸äºˆæœŸã—ãªã„çµ‚äº†æ¤œå‡º');
      console.log('âš ï¸ ãƒšãƒ¼ã‚¸ãŒäºˆæœŸã›ãšçµ‚äº†ã•ã‚Œã¾ã—ãŸ');
    });

    page.on('crash', () => {
      steps.push('âŒ ãƒšãƒ¼ã‚¸ã‚¯ãƒ©ãƒƒã‚·ãƒ¥æ¤œå‡º');
      console.log('âŒ ãƒšãƒ¼ã‚¸ãŒã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ');
    });

    // ã‚«ãƒ†ã‚´ãƒªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    const categories = ['ec', 'web_products', 'development', 'software_development'];
    const categoryResults: { [category: string]: ScrapingResult } = {};

    for (const category of categories) {
      steps.push(`ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹`);
      console.log(`\nğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹...`);

      try {
        // ãƒšãƒ¼ã‚¸çŠ¶æ…‹ç¢ºèª
        const isPageClosed = page.isClosed();
        if (isPageClosed) {
          steps.push(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ã¾ã™`);
          console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ãƒšãƒ¼ã‚¸ãŒæ—¢ã«é–‰ã˜ã‚‰ã‚Œã¦ã„ã¾ã™`);
          continue;
        }

        steps.push(`ğŸ“Š ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ãƒ‡ãƒãƒƒã‚°ç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œä¸­`);
        const categoryResult = await scrapeCrowdWorksJobsByCategoryDebug(page, category, 5);
        categoryResults[category] = categoryResult;

        if (categoryResult.success) {
          steps.push(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å®Œäº†: ${categoryResult.jobsFound}ä»¶`);
          console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å®Œäº†: ${categoryResult.jobsFound}ä»¶`);
        } else {
          steps.push(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å¤±æ•—: ${categoryResult.error}`);
          console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å¤±æ•—: ${categoryResult.error}`);
        }

        // ã‚«ãƒ†ã‚´ãƒªé–“ã®å¾…æ©Ÿ
        steps.push(`â³ ã‚«ãƒ†ã‚´ãƒªé–“å¾…æ©Ÿ (2ç§’)`);
        await page.waitForTimeout(2000);

      } catch (categoryError) {
        const errorMessage = categoryError instanceof Error ? categoryError.message : String(categoryError);
        steps.push(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
        console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¨ãƒ©ãƒ¼:`, errorMessage);

        categoryResults[category] = {
          success: false,
          jobsFound: 0,
          jobs: [],
          error: errorMessage,
          executionTime: 0
        };
      }
    }

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    steps.push('ğŸ§¹ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†ä¸­');
    await context.close();
    steps.push('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†å®Œäº†');

    const executionTime = Date.now() - startTime;
    steps.push(`ğŸ‰ ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    const successCount = Object.values(categoryResults).filter(result => result.success).length;
    console.log(`\nğŸ¯ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆå®Œäº†`);
    console.log(`ğŸ“Š æˆåŠŸã‚«ãƒ†ã‚´ãƒªæ•°: ${successCount}/${categories.length}`);

    return {
      success: successCount > 0,
      steps,
      categoryResults,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    steps.push(`âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
    console.error('âŒ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      steps,
      error: errorMessage,
      executionTime
    };
  } finally {
    if (browser) {
      try {
        steps.push('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ä¸­');
        await browser.close();
        steps.push('âœ… ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†å®Œäº†');
      } catch (closeError) {
        steps.push(`âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã‚¨ãƒ©ãƒ¼: ${closeError}`);
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

/**
 * ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ©Ÿèƒ½ä»˜ãã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆãƒ™ãƒ¼ã‚¹ï¼‰
 */
export async function debugCategoryScrapingWithFileOutput(params: {
  categories: string[];
  maxJobsPerCategory: number;
  saveToFile?: boolean;
}): Promise<{
  success: boolean;
  steps: string[];
  categoryResults?: { [category: string]: ScrapingResult };
  savedFiles?: string[];
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  const steps: string[] = [];
  const savedFiles: string[] = [];
  let browser: Browser | null = null;

  try {
    steps.push('ğŸš€ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ©Ÿèƒ½ä»˜ãã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹');
    console.log('ğŸš€ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ©Ÿèƒ½ä»˜ãã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹...');
    console.log(`ğŸ“‹ å¯¾è±¡ã‚«ãƒ†ã‚´ãƒª: ${params.categories.join(', ')}`);
    console.log(`ğŸ“Š ã‚«ãƒ†ã‚´ãƒªæ¯æœ€å¤§æ¡ˆä»¶æ•°: ${params.maxJobsPerCategory}`);
    console.log(`ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜: ${params.saveToFile ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}`);

    // ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•
    steps.push('ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•ä¸­');
    browser = await chromium.launch({
      headless: true,
      args: [
        '--no-sandbox',
        '--disable-setuid-sandbox',
        '--disable-dev-shm-usage',
        '--disable-gpu',
        '--disable-software-rasterizer'
      ]
    });

    steps.push('âœ… ãƒ–ãƒ©ã‚¦ã‚¶èµ·å‹•å®Œäº†');

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
    steps.push('ğŸ“„ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆä¸­');
    const context = await browser.newContext({
      userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36'
    });

    steps.push('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆå®Œäº†');

    // ãƒšãƒ¼ã‚¸ä½œæˆ
    steps.push('ğŸ“‹ ãƒšãƒ¼ã‚¸ä½œæˆä¸­');
    const page = await context.newPage();
    steps.push('âœ… ãƒšãƒ¼ã‚¸ä½œæˆå®Œäº†');

    // ã‚«ãƒ†ã‚´ãƒªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    const categoryResults: { [category: string]: ScrapingResult } = {};

    for (const category of params.categories) {
      steps.push(`ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹`);
      console.log(`\nğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å‡¦ç†é–‹å§‹...`);

      try {
        // ãƒšãƒ¼ã‚¸çŠ¶æ…‹ç¢ºèª
        const isPageClosed = page.isClosed();
        if (isPageClosed) {
          steps.push(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã¦ã„ã¾ã™`);
          console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ãƒšãƒ¼ã‚¸ãŒæ—¢ã«é–‰ã˜ã‚‰ã‚Œã¦ã„ã¾ã™`);
          continue;
        }

        steps.push(`ğŸ“Š ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€: ãƒ‡ãƒãƒƒã‚°ç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œä¸­`);
        const categoryResult = await scrapeCrowdWorksJobsByCategoryDebug(page, category, params.maxJobsPerCategory);
        categoryResults[category] = categoryResult;

        if (categoryResult.success) {
          steps.push(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å®Œäº†: ${categoryResult.jobsFound}ä»¶`);
          console.log(`âœ… ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å®Œäº†: ${categoryResult.jobsFound}ä»¶`);

          // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          if (params.saveToFile && categoryResult.jobs.length > 0) {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const fileName = `./crowdworks-${category}-jobs-${timestamp}.json`;

            const fileData = {
              category,
              scrapedAt: new Date().toISOString(),
              totalJobs: categoryResult.jobsFound,
              executionTime: categoryResult.executionTime,
              jobs: categoryResult.jobs
            };

            try {
              await writeFileAsync(fileName, JSON.stringify(fileData, null, 2));
              savedFiles.push(fileName);
              steps.push(`ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†: ${fileName}`);
              console.log(`ğŸ’¾ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å®Œäº†: ${fileName}`);
            } catch (saveError) {
              steps.push(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError}`);
              console.log(`âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${saveError}`);
            }
          }
        } else {
          steps.push(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å¤±æ•—: ${categoryResult.error}`);
          console.log(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€å¤±æ•—: ${categoryResult.error}`);
        }

        // ã‚«ãƒ†ã‚´ãƒªé–“ã®å¾…æ©Ÿ
        if (params.categories.indexOf(category) < params.categories.length - 1) {
          steps.push(`â³ ã‚«ãƒ†ã‚´ãƒªé–“å¾…æ©Ÿ (2ç§’)`);
          await page.waitForTimeout(2000);
        }

      } catch (categoryError) {
        const errorMessage = categoryError instanceof Error ? categoryError.message : String(categoryError);
        steps.push(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
        console.error(`âŒ ã‚«ãƒ†ã‚´ãƒªã€Œ${category}ã€ã‚¨ãƒ©ãƒ¼:`, errorMessage);

        categoryResults[category] = {
          success: false,
          jobsFound: 0,
          jobs: [],
          error: errorMessage,
          executionTime: 0
        };
      }
    }

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    steps.push('ğŸ§¹ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†ä¸­');
    await context.close();
    steps.push('âœ… ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçµ‚äº†å®Œäº†');

    const executionTime = Date.now() - startTime;
    steps.push(`ğŸ‰ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ©Ÿèƒ½ä»˜ããƒ†ã‚¹ãƒˆå®Œäº† (${executionTime}ms)`);

    const successCount = Object.values(categoryResults).filter(result => result.success).length;
    const totalJobs = Object.values(categoryResults).reduce((sum, result) => sum + result.jobsFound, 0);

    console.log(`\nğŸ¯ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ©Ÿèƒ½ä»˜ãã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†`);
    console.log(`ğŸ“Š æˆåŠŸã‚«ãƒ†ã‚´ãƒªæ•°: ${successCount}/${params.categories.length}`);
    console.log(`ğŸ“ ç·å–å¾—æ¡ˆä»¶æ•°: ${totalJobs}ä»¶`);
    console.log(`ğŸ’¾ ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${savedFiles.length}ä»¶`);

    if (savedFiles.length > 0) {
      console.log(`ğŸ“ ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:`);
      savedFiles.forEach(file => console.log(`   - ${file}`));
    }

    return {
      success: successCount > 0,
      steps,
      categoryResults,
      ...(savedFiles.length > 0 ? { savedFiles } : {}),
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    steps.push(`âŒ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
    console.error('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜æ©Ÿèƒ½ä»˜ããƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      steps,
      error: errorMessage,
      executionTime
    };
  } finally {
    if (browser) {
      try {
        steps.push('ğŸ”’ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ä¸­');
        await browser.close();
        steps.push('âœ… ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†å®Œäº†');
      } catch (closeError) {
        steps.push(`âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã‚¨ãƒ©ãƒ¼: ${closeError}`);
        console.warn('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†ã‚¨ãƒ©ãƒ¼:', closeError);
      }
    }
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
async function readFileAsync(filePath: string): Promise<string | null> {
  return new Promise((resolve) => {
    const fs = require('fs');
    fs.readFile(filePath, 'utf8', (err: any, data: string) => {
      if (err) resolve(null);
      else resolve(data);
    });
  });
}

/**
 * ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã«åŸºã¥ã„ã¦handleré–¢æ•°ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®CLIé–¢æ•°
 */
export async function runHandlerCLI(): Promise<void> {
  const args = process.argv.slice(2);

  if (args.length === 0) {
    console.log('ğŸ¯ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:');
    console.log('  test-playwright    - PlaywrightåŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ');
    console.log('  test-login         - CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ');
    console.log('  test-scraping      - æ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ');
    console.log('  test-categories    - ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¡ˆä»¶ãƒ†ã‚¹ãƒˆ');
    console.log('  debug-browser      - ãƒ–ãƒ©ã‚¦ã‚¶ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ‡ãƒãƒƒã‚°');
    console.log('  debug-category     - ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒãƒƒã‚°');
    console.log('  scrape-ec [ä»¶æ•°]   - ECæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  scrape-web [ä»¶æ•°]  - Webè£½å“æ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  scrape-design [ä»¶æ•°] - ãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  scrape-all [ä»¶æ•°]  - å…¨ã‚«ãƒ†ã‚´ãƒªæ¡ˆä»¶å–å¾— (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 50ä»¶)');
    console.log('  login-and-scrape   - ãƒ­ã‚°ã‚¤ãƒ³å¾Œæ¡ˆä»¶å–å¾—');
    console.log('  no-login-scrape    - ãƒ­ã‚°ã‚¤ãƒ³ãªã—æ¡ˆä»¶å–å¾—');
    console.log('  lambda-test        - Lambdaé–¢æ•°ãƒ†ã‚¹ãƒˆ');
    console.log('  full-analysis [ä»¶æ•°] - ğŸš€ å…¨å‡¦ç†çµ±åˆå®Ÿè¡Œ (ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°â†’AIåˆ†æâ†’ãƒ¬ãƒãƒ¼ãƒˆ)');
    console.log('');
    console.log('ä¾‹: npm run handler test-playwright');
    console.log('ä¾‹: npm run handler scrape-ec 30');
    console.log('ä¾‹: npm run handler full-analysis 20');
    return;
  }

  const command = args[0];
  const maxJobs = args[1] ? parseInt(args[1]) : 50;

  try {
    switch (command) {
      case 'test-playwright':
        console.log('ğŸš€ PlaywrightåŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
        const playwrightResult = await testPlaywrightBasic();
        console.log(JSON.stringify(playwrightResult, null, 2));
        break;

      case 'test-login':
        console.log('ğŸ” CrowdWorksãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
        const loginResult = await testCrowdWorksLogin();
        console.log(JSON.stringify(loginResult, null, 2));
        break;

      case 'test-scraping':
        console.log('ğŸ“Š æ¡ˆä»¶ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
        const scrapingResult = await testCrowdWorksScraping();
        console.log(JSON.stringify(scrapingResult, null, 2));
        break;

      case 'test-categories':
        console.log('ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¡ˆä»¶ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
        const categoriesResult = await testCrowdWorksCategories();
        console.log(JSON.stringify(categoriesResult, null, 2));
        break;

      case 'debug-browser':
        console.log('ğŸ” ãƒ–ãƒ©ã‚¦ã‚¶ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œä¸­...');
        const browserResult = await debugBrowserLifecycle();
        console.log(JSON.stringify(browserResult, null, 2));
        break;

      case 'debug-category':
        console.log('ğŸ› ï¸ ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒãƒƒã‚°å®Ÿè¡Œä¸­...');
        const debugResult = await debugCategoryScrapingTest();
        console.log(JSON.stringify(debugResult, null, 2));
        break;

      case 'scrape-ec':
        console.log(`ğŸ“ˆ ECæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const ecResult = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category: 'ec',
          maxJobs,
          maxDetails: maxJobs
        });
        console.log(`âœ… ECå–å¾—å®Œäº†: ${ecResult.jobs.length}ä»¶ä¸€è¦§, ${ecResult.jobDetails.length}ä»¶è©³ç´°`);
        break;

      case 'scrape-web':
        console.log(`ğŸŒ Webè£½å“æ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const webResult = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category: 'web_products',
          maxJobs,
          maxDetails: maxJobs
        });
        console.log(`âœ… Webè£½å“å–å¾—å®Œäº†: ${webResult.jobs.length}ä»¶ä¸€è¦§, ${webResult.jobDetails.length}ä»¶è©³ç´°`);
        break;

      case 'scrape-design':
        console.log(`ğŸ¨ ãƒ‡ã‚¶ã‚¤ãƒ³æ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (${maxJobs}ä»¶)...`);
        const designResult = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category: 'design',
          maxJobs,
          maxDetails: maxJobs
        });
        console.log(`âœ… ãƒ‡ã‚¶ã‚¤ãƒ³å–å¾—å®Œäº†: ${designResult.jobs.length}ä»¶ä¸€è¦§, ${designResult.jobDetails.length}ä»¶è©³ç´°`);
        break;

      case 'scrape-all':
        console.log(`ğŸ¯ å…¨ã‚«ãƒ†ã‚´ãƒªæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­ (å„${maxJobs}ä»¶)...`);
        const categories = ['ec', 'web_products', 'design', 'writing', 'translation', 'marketing', 'system_development', 'app_development'];
        let totalJobs = 0;
        let totalDetails = 0;

        for (const category of categories) {
          try {
            const result = await scrapeCrowdWorksJobsByCategoryWithDetails({
              category,
              maxJobs,
              maxDetails: maxJobs
            });
            console.log(`âœ… ${category}: ${result.jobs.length}ä»¶ä¸€è¦§, ${result.jobDetails.length}ä»¶è©³ç´°`);
            totalJobs += result.jobs.length;
            totalDetails += result.jobDetails.length;
          } catch (e) {
            console.log(`âŒ ${category}: ã‚¨ãƒ©ãƒ¼`, e instanceof Error ? e.message : String(e));
          }
        }
        console.log(`âœ… å…¨ã‚«ãƒ†ã‚´ãƒªå®Œäº† - åˆè¨ˆ: ${totalJobs}ä»¶ä¸€è¦§, ${totalDetails}ä»¶è©³ç´°`);
        break;

      case 'login-and-scrape':
        console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³å¾Œæ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­...');
        const loginScrapingResult = await loginAndScrapeCategories({
          categories: ['ec', 'web_products'],
          maxJobsPerCategory: maxJobs,
          maxDetailsPerCategory: maxJobs,
          saveToFile: true
        });
        console.log(JSON.stringify(loginScrapingResult, null, 2));
        break;

      case 'no-login-scrape':
        console.log('ğŸ“Š ãƒ­ã‚°ã‚¤ãƒ³ãªã—æ¡ˆä»¶å–å¾—å®Ÿè¡Œä¸­...');
        const noLoginResult = await testCategoryScrapingWithoutLogin({
          categories: ['ec', 'web_products'],
          maxJobsPerCategory: maxJobs,
          saveToFile: true
        });
        console.log(JSON.stringify(noLoginResult, null, 2));
        break;

      case 'lambda-test':
        console.log('âš¡ Lambdaé–¢æ•°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
        const lambdaResult = await lambdaHandler({
          source: 'manual',
          'detail-type': 'test',
          detail: {}
        }, {} as any);
        console.log(JSON.stringify(lambdaResult, null, 2));
        break;

      case 'full-analysis':
        console.log('ğŸš€ å…¨å‡¦ç†çµ±åˆå®Ÿè¡Œ (ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°â†’AIåˆ†æâ†’ãƒ¬ãƒãƒ¼ãƒˆ) å®Ÿè¡Œä¸­...');
        const fullAnalysisResult = await executeFullAnalysisWorkflow({
          maxJobsPerCategory: maxJobs,
          maxDetailsPerCategory: maxJobs
        });
        console.log(JSON.stringify(fullAnalysisResult, null, 2));
        break;

      default:
        console.log(`âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: ${command}`);
        console.log('åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã«ã¯å¼•æ•°ãªã—ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
        process.exit(1);
    }
  } catch (error) {
    console.error('âŒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error instanceof Error ? error.message : String(error));
    process.exit(1);
  }
}

// CLIå®Ÿè¡Œæ™‚ã®å‡¦ç†
if (require.main === module) {
  runHandlerCLI().catch(error => {
    console.error('âŒ CLIå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
    process.exit(1);
  });
}

/**
 * å…¨ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°â†’AIåˆ†æâ†’ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’çµ±åˆå®Ÿè¡Œ
 */
export async function executeFullAnalysisWorkflow(params?: {
  maxJobsPerCategory?: number;
  maxDetailsPerCategory?: number;
  saveIntermediateFiles?: boolean;
}): Promise<{
  success: boolean;
  summary: {
    totalCategories: number;
    successfulCategories: number;
    totalJobs: number;
    totalDetails: number;
    analysisResults?: {
      ec?: number;
      web_products?: number;
      [key: string]: number | undefined;
    };
    reportGenerated: boolean;
  };
  reportFile?: string;
  error?: string;
  executionTime: number;
}> {
  const startTime = Date.now();
  const maxJobs = params?.maxJobsPerCategory ?? 50;
  const maxDetails = params?.maxDetailsPerCategory ?? 50;

  try {
    console.log('ğŸš€ å…¨ã‚«ãƒ†ã‚´ãƒªçµ±åˆåˆ†æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼é–‹å§‹...');
    console.log(`ğŸ“Š è¨­å®š: å„ã‚«ãƒ†ã‚´ãƒª ${maxJobs}ä»¶å–å¾—, è©³ç´° ${maxDetails}ä»¶`);

    // ã‚¹ãƒ†ãƒƒãƒ—1: å…¨ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
    console.log('\nğŸ“‚ ã‚¹ãƒ†ãƒƒãƒ—1: å…¨ã‚«ãƒ†ã‚´ãƒªã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œä¸­...');
    const categories = ['ec', 'web_products', 'software_development', 'development'];
    let totalJobs = 0;
    let totalDetails = 0;
    let successfulCategories = 0;

    for (const category of categories) {
      try {
        console.log(`\nğŸ“ˆ ${category} ã‚«ãƒ†ã‚´ãƒªå‡¦ç†ä¸­...`);
        const result = await scrapeCrowdWorksJobsByCategoryWithDetails({
          category,
          maxJobs,
          maxDetails
        });

        if (result.jobs.length > 0) {
          console.log(`âœ… ${category}: ${result.jobs.length}ä»¶ä¸€è¦§, ${result.jobDetails.length}ä»¶è©³ç´°`);
          totalJobs += result.jobs.length;
          totalDetails += result.jobDetails.length;
          successfulCategories++;
        } else {
          console.log(`âš ï¸ ${category}: ãƒ‡ãƒ¼ã‚¿å–å¾—ãªã—`);
        }

        // ã‚«ãƒ†ã‚´ãƒªé–“ã§å°‘ã—å¾…æ©Ÿ
        if (categories.indexOf(category) < categories.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 2000));
        }
      } catch (e) {
        console.log(`âŒ ${category}: ã‚¨ãƒ©ãƒ¼ -`, e instanceof Error ? e.message : String(e));
      }
    }

    console.log(`\nğŸ“Š ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†: ${successfulCategories}/${categories.length}ã‚«ãƒ†ã‚´ãƒªæˆåŠŸ`);
    console.log(`ğŸ“ åˆè¨ˆ: ${totalJobs}ä»¶ä¸€è¦§, ${totalDetails}ä»¶è©³ç´°`);

    // ã‚¹ãƒ†ãƒƒãƒ—2: AIåˆ†æå®Ÿè¡Œ
    console.log('\nğŸ§  ã‚¹ãƒ†ãƒƒãƒ—2: AIåˆ†æå®Ÿè¡Œä¸­...');
    const analysisResults: { [key: string]: number } = {};

    for (const category of ['ec', 'web_products']) {
      try {
        console.log(`\nğŸ” ${category} ã‚«ãƒ†ã‚´ãƒª AIåˆ†æä¸­...`);

        // è©³ç´°ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        const detailsFile = `output/details-${category}.json`;
        const { exec } = require('child_process');
        const fs = require('fs');

        if (!fs.existsSync(detailsFile)) {
          console.log(`âš ï¸ ${category}: è©³ç´°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (${detailsFile})`);
          continue;
        }

        // AIåˆ†æå®Ÿè¡Œ
        await new Promise<void>((resolve, reject) => {
          const analysisCmd = `npx ts-node scripts/analyze-details.ts ${detailsFile} output/analyzed-${category}.json`;
          exec(analysisCmd, (error: any, _stdout: string, _stderr: string) => {
            if (error) {
              console.log(`âŒ ${category} AIåˆ†æã‚¨ãƒ©ãƒ¼:`, error.message);
              reject(error);
            } else {
              console.log(`âœ… ${category} AIåˆ†æå®Œäº†`);

              // åˆ†æçµæœã®ä»¶æ•°ã‚’å–å¾—
              try {
                const analyzedData = JSON.parse(fs.readFileSync(`output/analyzed-${category}.json`, 'utf8'));
                analysisResults[category] = analyzedData.length;
                console.log(`ğŸ“Š ${category}: ${analyzedData.length}ä»¶åˆ†æå®Œäº†`);
              } catch (parseError) {
                console.log(`âš ï¸ ${category}: åˆ†æçµæœãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼`);
              }

              resolve();
            }
          });
        });

      } catch (e) {
        console.log(`âŒ ${category} AIåˆ†æå¤±æ•—:`, e instanceof Error ? e.message : String(e));
      }

      // åˆ†æé–“ã§å¾…æ©Ÿï¼ˆAPIåˆ¶é™å¯¾å¿œï¼‰
      await new Promise(resolve => setTimeout(resolve, 3000));
    }

    // ã‚¹ãƒ†ãƒƒãƒ—3: ãŠã™ã™ã‚åº¦è¨ˆç®—
    console.log('\nâ­ ã‚¹ãƒ†ãƒƒãƒ—3: ãŠã™ã™ã‚åº¦è¨ˆç®—å®Ÿè¡Œä¸­...');
    try {
      await new Promise<void>((resolve, reject) => {
        const { exec } = require('child_process');
        const recommendCmd = 'npx ts-node scripts/calculate-recommendation-score.ts';
        exec(recommendCmd, (error: any, stdout: string, _stderr: string) => {
          if (error) {
            console.log('âŒ ãŠã™ã™ã‚åº¦è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error.message);
            reject(error);
          } else {
            console.log('âœ… ãŠã™ã™ã‚åº¦è¨ˆç®—å®Œäº†');
            console.log(stdout);
            resolve();
          }
        });
      });
    } catch (e) {
      console.log('âŒ ãŠã™ã™ã‚åº¦è¨ˆç®—å¤±æ•—:', e instanceof Error ? e.message : String(e));
    }

    // ã‚¹ãƒ†ãƒƒãƒ—4: é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡º
    console.log('\nğŸ’° ã‚¹ãƒ†ãƒƒãƒ—4: é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºä¸­...');
    try {
      await new Promise<void>((resolve, reject) => {
        const { exec } = require('child_process');
        const extractCmd = 'npx ts-node scripts/extract-high-hourly-jobs.ts';
        exec(extractCmd, (error: any, stdout: string, _stderr: string) => {
          if (error) {
            console.log('âŒ é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error.message);
            reject(error);
          } else {
            console.log('âœ… é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºå®Œäº†');
            console.log(stdout);
            resolve();
          }
        });
      });
    } catch (e) {
      console.log('âŒ é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºå¤±æ•—:', e instanceof Error ? e.message : String(e));
    }

    // ã‚¹ãƒ†ãƒƒãƒ—5: çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    console.log('\nğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—5: çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­...');
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const reportFile = `output/crowdworks-analysis-report-${timestamp}.md`;

    try {
      const reportContent = await generateComprehensiveReport({
        totalCategories: categories.length,
        successfulCategories,
        totalJobs,
        totalDetails,
        analysisResults,
        timestamp: new Date().toISOString()
      });

      const fs = require('fs');
      fs.writeFileSync(reportFile, reportContent, 'utf8');
      console.log(`âœ… çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: ${reportFile}`);

    } catch (e) {
      console.log('âŒ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå¤±æ•—:', e instanceof Error ? e.message : String(e));
    }

    const executionTime = Date.now() - startTime;

    console.log('\nğŸ‰ å…¨ã‚«ãƒ†ã‚´ãƒªçµ±åˆåˆ†æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Œäº†ï¼');
    console.log(`â±ï¸ ç·å®Ÿè¡Œæ™‚é–“: ${Math.round(executionTime / 1000)}ç§’`);
    console.log(`ğŸ“Š å‡¦ç†çµæœ:`);
    console.log(`  - æˆåŠŸã‚«ãƒ†ã‚´ãƒª: ${successfulCategories}/${categories.length}`);
    console.log(`  - ç·æ¡ˆä»¶æ•°: ${totalJobs}ä»¶`);
    console.log(`  - ç·è©³ç´°æ•°: ${totalDetails}ä»¶`);
    console.log(`  - AIåˆ†æ: ${Object.keys(analysisResults).length}ã‚«ãƒ†ã‚´ãƒª`);
    console.log(`  - ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«: ${reportFile}`);

    return {
      success: true,
      summary: {
        totalCategories: categories.length,
        successfulCategories,
        totalJobs,
        totalDetails,
        analysisResults,
        reportGenerated: true
      },
      reportFile,
      executionTime
    };

  } catch (error) {
    const executionTime = Date.now() - startTime;
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error('âŒ çµ±åˆåˆ†æãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ©ãƒ¼:', errorMessage);

    return {
      success: false,
      summary: {
        totalCategories: 0,
        successfulCategories: 0,
        totalJobs: 0,
        totalDetails: 0,
        reportGenerated: false
      },
      error: errorMessage,
      executionTime
    };
  }
}

/**
 * çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
 */
async function generateComprehensiveReport(data: {
  totalCategories: number;
  successfulCategories: number;
  totalJobs: number;
  totalDetails: number;
  analysisResults?: { [key: string]: number };
  timestamp: string;
}): Promise<string> {
  const date = new Date().toLocaleDateString('ja-JP');

  let report = `# CrowdWorksæ¡ˆä»¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

> ç”Ÿæˆæ—¥: ${date}  
> å®Ÿè¡Œæ™‚åˆ»: ${data.timestamp}  
> å¯¾è±¡: å…¨ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•åˆ†æ  

## ğŸ“Š å®Ÿè¡Œã‚µãƒãƒªãƒ¼

| é …ç›® | çµæœ |
|------|------|
| å¯¾è±¡ã‚«ãƒ†ã‚´ãƒªæ•° | ${data.totalCategories} |
| æˆåŠŸã‚«ãƒ†ã‚´ãƒªæ•° | ${data.successfulCategories} |
| ç·æ¡ˆä»¶å–å¾—æ•° | ${data.totalJobs} |
| ç·è©³ç´°å–å¾—æ•° | ${data.totalDetails} |
| AIåˆ†æå®Œäº† | ${data.analysisResults ? Object.keys(data.analysisResults).length : 0}ã‚«ãƒ†ã‚´ãƒª |

## ğŸ¯ ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ

`;

  if (data.analysisResults) {
    for (const [category, count] of Object.entries(data.analysisResults)) {
      const categoryName = category === 'ec' ? 'ECãƒ»ãƒãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—' :
        category === 'web_products' ? 'Webåˆ¶ä½œãƒ»Webãƒ‡ã‚¶ã‚¤ãƒ³' : category;
      report += `### ${categoryName}\n- AIåˆ†æå®Œäº†: ${count}ä»¶\n\n`;
    }
  }

  // é«˜æ™‚çµ¦æ¡ˆä»¶ãŒã‚ã‚Œã°è¿½åŠ 
  try {
    const fs = require('fs');
    if (fs.existsSync('output/high-hourly-jobs-3000+.md')) {
      const highHourlyContent = fs.readFileSync('output/high-hourly-jobs-3000+.md', 'utf8');
      report += `\n## ğŸ’° é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºçµæœ\n\n`;
      report += highHourlyContent.split('\n').slice(10).join('\n'); // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’ã‚¹ã‚­ãƒƒãƒ—
    }
  } catch (e) {
    report += `\n## ğŸ’° é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºçµæœ\n\né«˜æ™‚çµ¦æ¡ˆä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n`;
  }

  // ãŠã™ã™ã‚æ¡ˆä»¶ãŒã‚ã‚Œã°è¿½åŠ 
  try {
    const fs = require('fs');
    if (fs.existsSync('output/recommended-jobs-top30.md')) {
      const recommendedContent = fs.readFileSync('output/recommended-jobs-top30.md', 'utf8');
      report += `\n## â­ ãŠã™ã™ã‚æ¡ˆä»¶TOP30\n\n`;
      report += recommendedContent.split('\n').slice(5).join('\n'); // ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ã‚’ã‚¹ã‚­ãƒƒãƒ—
    }
  } catch (e) {
    report += `\n## â­ ãŠã™ã™ã‚æ¡ˆä»¶TOP30\n\nãŠã™ã™ã‚æ¡ˆä»¶ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n`;
  }

  report += `\n## ğŸ“ å®Ÿè¡Œãƒ­ã‚°

- ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œå®Œäº†
- AIåˆ†æå®Ÿè¡Œå®Œäº†  
- ãŠã™ã™ã‚åº¦è¨ˆç®—å®Œäº†
- é«˜æ™‚çµ¦æ¡ˆä»¶æŠ½å‡ºå®Œäº†
- çµ±åˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†

---

*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
`;

  return report;
}
</file>

</files>
